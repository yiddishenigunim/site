name: PR Preview

permissions:
  contents: write
  pull-requests: write

on:
  pull_request_target:
    types: [opened, synchronize, reopened, closed]

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # CHECKOUT PR CODE
      # =========================
      - name: Checkout PR
        if: github.event.action != 'closed'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # =========================
      # CREATE PREVIEW FOLDER
      # =========================
      - name: Create preview
        if: github.event.action != 'closed'
        run: |
          PREVIEW_DIR="pr-preview/pr-${{ github.event.number }}"
          mkdir -p "$PREVIEW_DIR"

          rsync -av \
            --exclude=.git \
            --exclude=.github \
            --exclude=pr-preview \
            ./ "$PREVIEW_DIR/"

      # =========================
      # COMMIT & PUSH TO MAIN
      # =========================
      - name: Commit preview
        if: github.event.action != 'closed'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add pr-preview
          git commit -m "PR preview #${{ github.event.number }}" || echo "No changes"

          git push origin HEAD:main

      # =========================
      # COMMENT PREVIEW LINK
      # =========================
      - name: Comment preview link
        if: github.event.action != 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request.number;
            const url = `https://yiddishenigunim.github.io/site/pr-preview/pr-${pr}/`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body: `üîç **PR Preview:**\n\nüëâ ${url}`
            });

      # =========================
      # CLEANUP ON CLOSE
      # =========================
      - name: Checkout main for cleanup
        if: github.event.action == 'closed'
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Remove preview on close
        if: github.event.action == 'closed'
        run: |
          rm -rf pr-preview/pr-${{ github.event.number }}

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add pr-preview
          git commit -m "Remove PR preview #${{ github.event.number }}" || echo "No changes"

          git push

<!DOCTYPE html>
<html lang="yi" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>אוצר הניגונים</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='80' font-size='80' text-anchor='middle'%3E♪%3C/text%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&family=David+Libre:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-deep: #4a1259;
            --primary: #7b1fa2;
            --primary-light: #ae52d4;
            --primary-pale: #f3e5f5;
            --accent-gold: #d4af37;
            --accent-warm: #ff6f61;
            --bg-cream: #faf8f5;
            --text-dark: #2c2c2c;
            --text-muted: #666;
            --text-secondary: #888;
            --card-shadow: 0 4px 24px rgba(74, 18, 89, 0.12);
            --card-hover-shadow: 0 12px 40px rgba(74, 18, 89, 0.2);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Category Colors */
            /* חצרות - Purple */
            --color-chatzer: #9c5bb5;
            --color-chatzer-light: #c48fd7;
            --color-chatzer-dark: #7b3f96;
            --color-chatzer-pale: #f3e5f5;
            
            /* מחברים - Magenta/Pink */
            --color-mechaber: #c435a8;
            --color-mechaber-light: #e066c7;
            --color-mechaber-dark: #9c1b82;
            --color-mechaber-pale: #fce4ec;
            
            /* ווערטער - Gray */
            --color-verter: #6b7280;
            --color-verter-light: #9ca3af;
            --color-verter-dark: #4b5563;
            --color-verter-pale: #f3f4f6;
            
            /* זמנים/מועדים - Orange */
            --color-zman: #e96a1b;
            --color-zman-light: #ff8c42;
            --color-zman-dark: #c54e00;
            --color-zman-pale: #fff3e0;
            
            /* קאלעקשאנס - Red */
            --color-collection: #c62828;
            --color-collection-light: #ef5350;
            --color-collection-dark: #8e0000;
            --color-collection-pale: #ffebee;
            
            /* ניגונים - Blue */
            --color-nigun: #4a7cc9;
            --color-nigun-light: #7aa3e0;
            --color-nigun-dark: #2d5aa0;
            --color-nigun-pale: #e3f2fd;
            
            /* מוזיק/ריטעם - Gold/Yellow */
            --color-music: #d4ac12;
            --color-music-light: #f0c040;
            --color-music-dark: #b8960c;
            --color-music-pale: #fff8e1;
            
            /* רעסורסן - Light Blue/Cyan */
            --color-resource: #5bc0de;
            --color-resource-light: #8cd4eb;
            --color-resource-dark: #31a5c7;
            --color-resource-pale: #e0f7fa;
            
            /* דאקומענטן - Teal/Cyan */
            --color-document: #00a0b0;
            --color-document-light: #4dd0e1;
            --color-document-dark: #007c8a;
            --color-document-pale: #e0f7fa;
            
            /* אלבומס - Teal */
            --color-album: #00838f;
            --color-album-light: #4fb3bf;
            --color-album-dark: #005662;
            --color-album-pale: #e0f7fa;
            
            /* ארכיוון - Teal (same as albums) */
            --color-archive: #00838f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', 'David Libre', sans-serif;
            background: var(--bg-cream);
            min-height: 100vh;
            direction: rtl;
            color: var(--text-dark);
            padding-bottom: 140px;
        }

        /* Header */
        .main-header {
            background: white;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #e0e0e0;
        }

        .header-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            text-decoration: none;
        }

        .logo-icon {
            width: 38px;
            height: 38px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            color: white;
        }

        .logo h1 {
            color: var(--text-dark);
            font-size: 1.35em;
            font-weight: 700;
            font-family: 'David Libre', serif;
            margin: 0;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .global-search {
            position: relative;
            margin-left: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .global-search input {
            width: 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            background: #f8f8f8;
            direction: rtl;
            font-family: inherit;
            transition: var(--transition-smooth);
        }

        .global-search input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            width: 280px;
        }

        .global-search-btn {
            width: 34px;
            height: 34px;
            border: none;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .global-search-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .stream-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 18px;
            background: linear-gradient(145deg, #1a3a5a, #0a2a4a);
            border: 1px solid rgba(212, 175, 55, 0.4);
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 600;
            color: #f5e6c8;
            transition: all 0.3s ease;
            margin-left: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .stream-btn:hover {
            transform: scale(1.05);
            border-color: #d4af37;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4), 0 0 15px rgba(212, 175, 55, 0.2);
            background: linear-gradient(145deg, #2a4a6a, #1a3a5a);
        }

        /* Navigation - Simple Box Buttons */
        .main-nav {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .nav-dropdown {
            position: relative;
        }

        .nav-dropdown-btn {
            padding: 8px 14px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-dark);
        }

        .nav-dropdown-btn:hover {
            border-color: #bbb;
            background: #f5f5f5;
        }

        .nav-dropdown-btn .nav-arrow {
            font-size: 0.6em;
            opacity: 0.5;
        }

        .nav-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 4px;
            min-width: 160px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .nav-dropdown-content::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 0;
            left: 0;
            height: 10px;
        }

        .nav-dropdown-content .dropdown-inner {
            padding: 4px 0;
        }

        .nav-dropdown:hover .nav-dropdown-content,
        .nav-dropdown-content:hover {
            display: block;
        }
        
        .nav-dropdown-content.hiding {
            display: none !important;
        }

        /* Dropdown item colors - small color box */
        .nav-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 0.85em;
            background: white;
        }

        .nav-dropdown-item:hover {
            background: #f5f5f5;
        }

        .nav-dropdown-item::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .nav-dropdown-item[data-dest="home"]::before {
            background: var(--primary);
        }
        .nav-dropdown-item[data-dest="songs"]::before {
            background: var(--color-nigun);
        }
        .nav-dropdown-item[data-dest="mechabrim"]::before {
            background: var(--color-mechaber);
        }
        .nav-dropdown-item[data-dest="chatzeros"]::before {
            background: var(--color-chatzer);
        }
        .nav-dropdown-item[data-dest="verter"]::before {
            background: var(--color-verter);
        }
        .nav-dropdown-item[data-dest="zmanim"]::before {
            background: var(--color-zman);
        }
        .nav-dropdown-item[data-dest="music"]::before {
            background: var(--color-music);
        }
        .nav-dropdown-item[data-dest="collections"]::before {
            background: var(--color-collection);
        }
        .nav-dropdown-item[data-dest="resources"]::before {
            background: var(--color-resource);
        }
        .nav-dropdown-item[data-dest="albums"]::before {
            background: var(--color-album);
        }
        .nav-dropdown-item[data-dest="documents"]::before {
            background: var(--color-document);
        }
        .nav-dropdown-item[data-dest="info"]::before {
            background: #999;
        }

        .nav-dropdown-divider {
            height: 1px;
            background: #eee;
            margin: 4px 0;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Home Page Styles */
        .home-page {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .home-hero {
            background: linear-gradient(135deg, var(--primary-deep) 0%, var(--primary) 50%, var(--primary-light) 100%);
            border-radius: 25px;
            padding: 50px 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(139, 69, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .home-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 15s infinite linear;
        }

        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .home-hero-content {
            position: relative;
            z-index: 1;
        }

        .home-logo {
            font-size: 4em;
            margin-bottom: 15px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .home-title {
            font-size: 2.8em;
            color: white;
            margin: 0 0 10px 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            font-family: 'David Libre', serif;
        }

        .home-subtitle {
            font-size: 1.2em;
            color: rgba(255,255,255,0.9);
            margin: 0;
        }

        .home-search-section {
            margin-bottom: 30px;
        }

        .home-search-box {
            display: flex;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .home-search-input {
            flex: 1;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid var(--primary-pale);
            border-radius: 15px;
            outline: none;
            font-family: inherit;
            direction: rtl;
            transition: var(--transition-smooth);
        }

        .home-search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(139, 69, 255, 0.1);
        }

        .home-search-btn {
            padding: 15px 30px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .home-search-btn:hover {
            background: var(--primary-deep);
            transform: translateY(-2px);
        }

        .home-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .home-stat-card {
            background: white;
            border-radius: 20px;
            padding: 25px 15px;
            text-align: center;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .home-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .home-stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .home-stat-number {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .home-stat-label {
            font-size: 0.95em;
            color: var(--text-muted);
        }

        .home-section-title {
            text-align: center;
            color: var(--primary-deep);
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .home-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .home-link-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 2px solid transparent;
        }

        .home-link-card:hover {
            border-color: var(--primary);
            transform: translateX(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        }

        .home-link-icon {
            font-size: 2.5em;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-pale);
            border-radius: 15px;
        }

        .home-link-text {
            flex: 1;
        }

        .home-link-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .home-link-desc {
            font-size: 0.9em;
            color: var(--text-muted);
        }

        /* Home Sections */
        .home-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: var(--card-shadow);
        }

        .home-section-title {
            color: var(--primary-deep);
            font-size: 1.4em;
            font-family: 'David Libre', serif;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale, #f3e5f5);
        }

        .home-section-content {
            color: var(--text-dark);
            line-height: 1.8;
        }

        .home-section-content p {
            margin: 0 0 15px 0;
        }

        .home-section-content p:last-child {
            margin-bottom: 0;
        }

        /* Instructions */
        .instructions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: var(--bg-light);
            border-radius: 10px;
        }

        .instruction-number {
            width: 30px;
            height: 30px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .instruction-text {
            flex: 1;
        }

        /* Stats detailed */
        .stats-detailed {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background: var(--bg-light);
            border-radius: 8px;
        }

        .stat-label-lg {
            color: var(--text-muted);
        }

        .stat-value-lg {
            font-weight: 700;
            color: var(--primary);
        }

        /* Credits */
        .credits-list {
            margin-top: 15px;
        }

        .credit-item {
            padding: 10px 15px;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .credit-item:last-child {
            margin-bottom: 0;
        }

        /* Thanks */
        .thanks-list {
            margin: 15px 0;
            padding-right: 20px;
        }

        .thanks-list li {
            margin-bottom: 8px;
        }

        .blessing {
            font-style: italic;
            text-align: center;
            color: var(--primary);
            margin-top: 20px;
            padding: 15px;
            background: var(--primary-pale, #f3e5f5);
            border-radius: 10px;
        }

        /* Terms */
        .terms-content ul {
            margin: 15px 0;
            padding-right: 20px;
        }

        .terms-content li {
            margin-bottom: 8px;
        }

        @media (max-width: 600px) {
            .home-hero {
                padding: 35px 20px;
            }
            
            .home-title {
                font-size: 2em;
            }
            
            .home-logo {
                font-size: 3em;
            }
            
            .home-search-box {
                flex-direction: column;
            }
            
            .home-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .home-links-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Page Title */
        .page-title {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .page-title-bar {
            padding: 25px 20px;
            font-size: 1.8em;
            font-weight: 700;
            font-family: 'David Libre', serif;
            background: var(--primary);
            color: white;
            text-align: center;
        }

        .page-title-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px 25px;
            background: white;
        }

        .page-title-icon {
            display: none;
        }

        .page-title .subtitle {
            color: var(--text-muted);
            font-size: 0.95em;
        }

        /* Category-themed page titles */
        .page-theme-chatzer .page-title-bar { background: var(--color-chatzer); }
        .page-theme-mechaber .page-title-bar { background: var(--color-mechaber); }
        .page-theme-verter .page-title-bar { background: var(--color-verter); }
        .page-theme-zman .page-title-bar { background: var(--color-zman); }
        .page-theme-collection .page-title-bar { background: var(--color-collection); }
        .page-theme-nigun .page-title-bar { background: var(--color-nigun); }
        .page-theme-resource .page-title-bar { background: var(--color-resource); }
        .page-theme-document .page-title-bar { background: var(--color-document); }
        .page-theme-album .page-title-bar { background: var(--color-album); }

        /* Resources Page */
        .category-group {
            margin-bottom: 30px;
        }

        .category-group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .resource-group-header {
            background: linear-gradient(135deg, var(--color-resource-pale) 0%, white 100%);
            border-right: 4px solid var(--color-resource);
        }

        .document-group-header {
            background: linear-gradient(135deg, var(--color-document-pale) 0%, white 100%);
            border-right: 4px solid var(--color-document);
        }

        .album-group-header {
            background: linear-gradient(135deg, var(--color-album-pale) 0%, white 100%);
            border-right: 4px solid var(--color-album);
        }

        .category-group-title {
            font-size: 1.2em;
            font-weight: 600;
            font-family: 'David Libre', serif;
        }

        .resource-group-header .category-group-title {
            color: var(--color-resource-dark);
        }

        .document-group-header .category-group-title {
            color: var(--color-document-dark);
        }

        .album-group-header .category-group-title {
            color: var(--color-album-dark);
        }

        .category-group-count {
            background: rgba(0,0,0,0.1);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        /* Clickable card elements */
        .clickable-header {
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .clickable-header:hover {
            filter: brightness(1.1);
        }

        .clickable-title {
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .clickable-title:hover {
            opacity: 0.7;
        }

        .clickable-cover {
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .clickable-cover:hover {
            opacity: 0.85;
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .resource-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: var(--transition-smooth);
            display: flex;
            flex-direction: column;
        }

        .resource-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .resource-card-header {
            background: linear-gradient(135deg, var(--color-resource) 0%, var(--color-resource-light) 100%);
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resource-icon {
            font-size: 2.5em;
        }

        .resource-sort-label {
            font-size: 0.9em;
            font-weight: 600;
            color: white;
            text-align: center;
        }

        .resource-card-body {
            padding: 15px;
            flex: 1;
        }

        .resource-title {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--color-resource-dark);
            margin-bottom: 8px;
        }

        .resource-type {
            display: inline-block;
            background: var(--color-resource-pale);
            color: var(--color-resource-dark);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-bottom: 8px;
        }

        .resource-chatzer {
            margin-bottom: 8px;
        }

        .resource-details, .resource-notes {
            font-size: 0.85em;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .resource-card-footer {
            padding: 15px;
            border-top: 1px solid var(--color-resource-pale);
        }

        .resource-link-btn, .resource-btn-placeholder {
            display: block;
            width: 100%;
            padding: 10px;
            background: var(--color-resource);
            color: white;
            border-radius: 10px;
            text-decoration: none;
            font-size: 0.95em;
            text-align: center;
            transition: var(--transition-smooth);
            box-sizing: border-box;
            min-height: 40px;
        }

        .resource-btn-placeholder {
            visibility: hidden;
        }

        .resource-phone-number {
            width: 100%;
            padding: 10px;
            background: var(--color-resource-pale);
            color: var(--color-resource-dark);
            border-radius: 10px;
            font-size: 0.95em;
            text-align: center;
            font-weight: 600;
            white-space: pre-line;
            line-height: 1.6;
        }

        .resource-link-btn:hover {
            background: var(--color-resource-dark);
        }

        /* Documents Page */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .document-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: var(--transition-smooth);
            display: flex;
            flex-direction: column;
        }

        .document-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .document-card-header {
            background: linear-gradient(135deg, var(--color-document) 0%, var(--color-document-light) 100%);
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .document-preview {
            position: relative;
            width: 100%;
            height: 200px;
            background: #f5f5f5;
            overflow: hidden;
        }

        .document-preview-frame {
            width: 100%;
            height: calc(100% + 60px);
            border: none;
            pointer-events: none;
            margin-top: -30px;
        }

        .document-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .document-preview-overlay:hover {
            background: rgba(0,0,0,0.3);
        }

        .preview-expand-icon {
            font-size: 2em;
            opacity: 0;
            transition: var(--transition-smooth);
        }

        .document-preview-overlay:hover .preview-expand-icon {
            opacity: 1;
        }

        .document-icon {
            font-size: 2.5em;
        }

        .document-sort-label {
            font-size: 0.9em;
            font-weight: 600;
            color: white;
            text-align: center;
        }

        .document-card-body {
            padding: 15px;
            flex: 1;
        }

        .document-title {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--color-document-dark);
            margin-bottom: 8px;
        }

        .document-type {
            display: inline-block;
            background: var(--color-document-pale);
            color: var(--color-document-dark);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-bottom: 5px;
            margin-left: 5px;
        }

        .document-serie {
            display: inline-block;
            background: var(--color-document-pale);
            color: var(--color-document-dark);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-bottom: 8px;
        }

        .document-chatzer {
            margin-bottom: 8px;
        }

        .document-details, .document-notes {
            font-size: 0.85em;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .document-card-footer {
            padding: 15px;
            border-top: 1px solid var(--color-document-pale);
        }

        .document-pdf-btn, .document-link-btn, .document-btn-placeholder {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            text-decoration: none;
            font-size: 0.95em;
            text-align: center;
            transition: var(--transition-smooth);
            cursor: pointer;
            border: none;
            font-family: inherit;
            box-sizing: border-box;
            min-height: 40px;
            display: block;
        }

        .document-btn-placeholder {
            visibility: hidden;
        }

        .document-pdf-btn {
            background: var(--color-document);
            color: white;
        }

        .document-pdf-btn:hover {
            background: var(--color-document-dark);
        }

        .document-link-btn {
            background: var(--color-document);
            color: white;
        }

        .document-link-btn:hover {
            background: var(--color-document-dark);
        }

        /* PDF Popup */
        .pdf-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-smooth);
        }

        .pdf-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .pdf-popup {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .pdf-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--color-document);
            color: white;
        }

        .pdf-popup-title {
            font-weight: 600;
            font-size: 1.1em;
        }

        .pdf-popup-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .pdf-popup-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .pdf-popup-body {
            flex: 1;
            overflow: hidden;
        }

        .pdf-popup-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .pdf-popup-footer {
            padding: 10px 20px;
            background: var(--bg-cream);
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .pdf-download-btn {
            padding: 10px 25px;
            background: var(--color-document);
            color: white;
            border: none;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.95em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .pdf-download-btn:hover {
            background: var(--color-document-dark);
        }

        /* Albums Page */
        .albums-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .album-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: var(--transition-smooth);
            display: flex;
            flex-direction: column;
        }

        .album-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .album-cover {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }

        .album-cover-placeholder {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--color-album-pale) 0%, var(--color-album-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: var(--color-album);
        }

        .album-card-header {
            background: linear-gradient(135deg, var(--color-album) 0%, var(--color-album-light) 100%);
            padding: 10px 15px;
            text-align: center;
        }

        .album-producer-label {
            font-size: 0.85em;
            font-weight: 600;
            color: white;
            line-height: 1.4;
        }

        .album-info {
            padding: 15px;
            flex: 1;
        }

        .album-title {
            font-weight: 600;
            font-size: 1.05em;
            color: var(--color-album-dark);
            margin-bottom: 5px;
        }

        .album-producer, .album-year {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .album-chatzer {
            margin: 5px 0;
        }

        .album-serie {
            display: inline-block;
            background: var(--color-album-pale);
            color: var(--color-album-dark);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-top: 3px;
        }

        .album-notes {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-top: 5px;
            font-style: italic;
        }

        .album-actions {
            padding: 0 15px 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .album-booklet-btn, .album-buy-btn, .album-btn-placeholder {
            width: 100%;
            padding: 10px 12px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.85em;
            text-align: center;
            transition: var(--transition-smooth);
            border: none;
            cursor: pointer;
            box-sizing: border-box;
            min-height: 38px;
            display: block;
        }

        .album-btn-placeholder {
            visibility: hidden;
        }

        .album-booklet-btn {
            background: var(--color-album);
            color: white;
            cursor: pointer;
        }

        .album-booklet-btn:hover {
            background: var(--color-album-dark);
        }

        .album-buy-btn {
            background: var(--color-album-pale);
            color: var(--color-album-dark);
            border: 1px solid var(--color-album-light);
        }

        .album-buy-btn:hover {
            background: var(--color-album-light);
        }

        /* Collections Grid - Playlist Style */
        .collections-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 800px;
            margin: 0 auto;
        }

        .collection-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: var(--transition-smooth);
        }

        .collection-card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .collection-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            cursor: pointer;
        }

        .collection-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--color-collection) 0%, var(--color-collection-light) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            flex-shrink: 0;
        }

        .collection-info {
            flex: 1;
            min-width: 0;
        }

        .collection-title {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .collection-meta {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .collection-zmanim {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 6px;
        }

        .collection-zman-tag {
            background: var(--color-zman-pale);
            color: var(--color-zman-dark);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .collection-zman-tag:hover {
            background: var(--color-zman);
            color: white;
        }

        .collection-zman-more {
            background: var(--bg-light);
            color: var(--text-muted);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        /* Music Page Styles */
        .music-ritem-groups {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .ritem-group {
            background: white;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .ritem-group-header {
            background: linear-gradient(135deg, var(--color-music) 0%, var(--color-music-dark) 100%);
            color: white;
            padding: 18px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ritem-group-header h3 {
            margin: 0;
            font-size: 1.25em;
            flex: 1;
        }

        .ritem-count {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .ritem-play-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 0.85em;
        }

        .ritem-play-btn:hover {
            background: rgba(255,255,255,0.35);
        }

        .ritem-scales {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .scale-group {
            background: var(--bg-light);
            border-radius: 15px;
            overflow: hidden;
        }

        .scale-group-header {
            background: var(--color-music-pale);
            padding: 12px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .scale-name {
            font-weight: 600;
            color: var(--color-music-dark);
        }

        .scale-song-count {
            background: var(--color-music);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .scale-songs {
            padding: 10px;
        }

        .music-song-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition-smooth);
            margin-bottom: 6px;
            background: white;
        }

        .music-song-item:hover {
            background: var(--color-nigun-pale);
            transform: translateX(-3px);
        }

        .music-song-item.no-audio {
            opacity: 0.6;
            border: 1px dashed var(--border-color);
        }

        .music-song-name {
            flex: 1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-song-meta {
            font-size: 0.8em;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .music-song-details {
            background: transparent;
            border: none;
            color: var(--color-music);
            cursor: pointer;
            padding: 5px;
            font-size: 1em;
            opacity: 0.5;
            transition: var(--transition-smooth);
        }

        .music-song-details:hover {
            opacity: 1;
        }

        .scale-more {
            text-align: center;
            padding: 10px;
            color: var(--color-music);
            cursor: pointer;
            font-size: 0.9em;
            transition: var(--transition-smooth);
        }

        .scale-more:hover {
            background: var(--color-music-pale);
            border-radius: 8px;
        }

        .collection-play-btn {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--color-collection) 0%, var(--color-collection-dark) 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: var(--transition-smooth);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .collection-play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        /* Category Cards Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .category-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        /* Category-themed card backgrounds */
        .page-theme-chatzer .category-card {
            background: var(--color-chatzer-pale);
            border-color: var(--color-chatzer-light);
        }
        .page-theme-chatzer .category-card:hover {
            border-color: var(--color-chatzer);
        }

        .page-theme-mechaber .category-card {
            background: var(--color-mechaber-pale);
            border-color: var(--color-mechaber-light);
        }
        .page-theme-mechaber .category-card:hover {
            border-color: var(--color-mechaber);
        }

        .page-theme-verter .category-card {
            background: var(--color-verter-pale);
            border-color: var(--color-verter-light);
        }
        .page-theme-verter .category-card:hover {
            border-color: var(--color-verter);
        }

        .page-theme-zman .category-card {
            background: var(--color-zman-pale);
            border-color: var(--color-zman-light);
        }
        .page-theme-zman .category-card:hover {
            border-color: var(--color-zman);
        }

        .page-theme-collection .category-card {
            background: var(--color-collection-pale);
            border-color: var(--color-collection-light);
        }
        .page-theme-collection .category-card:hover {
            border-color: var(--color-collection);
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }

        .category-card.expanded {
            grid-column: 1 / -1;
            border-color: var(--primary);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .card-image {
            width: 55px;
            height: 55px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid var(--primary-pale);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Round images for mechabrim cards */
        .page-theme-mechaber .card-image {
            border-radius: 50%;
        }

        .category-card.has-image .card-header {
            align-items: flex-start;
        }

        .card-header-text {
            flex: 1;
            min-width: 0;
        }

        .card-description {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.4;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .card-chatzer-tag {
            display: inline-block;
            background: var(--color-chatzer);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .card-chatzer-tag:hover {
            background: var(--color-chatzer-dark);
            transform: scale(1.05);
        }

        .card-chatzer-display {
            text-align: center;
            font-size: 1.3em;
            font-weight: 700;
            color: var(--color-chatzer-dark);
            padding: 12px 15px;
            margin-top: 5px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border-top: 1px solid var(--color-chatzer-light);
            background: var(--color-chatzer-pale);
            border-radius: 0 0 14px 14px;
            margin: 0 -20px -20px -20px;
        }

        .card-chatzer-display:hover {
            background: var(--color-chatzer-light);
            color: var(--color-chatzer-dark);
        }

        .card-zman-tag {
            display: inline-block;
            background: var(--color-zman-pale);
            color: var(--color-zman-dark);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 1px solid var(--color-zman-light);
        }

        .card-zman-tag:hover {
            background: var(--color-zman);
            color: white;
            transform: scale(1.05);
        }

        .card-stats {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .card-stat {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .card-years {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .card-stat-zman {
            font-size: 0.8em;
            color: var(--primary);
            font-weight: 600;
        }

        .section-header {
            color: var(--primary-deep);
            font-size: 1.3em;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .section-header:first-of-type {
            margin-top: 0;
        }

        .zman-section {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
        }

        .zman-section h3 {
            font-size: 1.2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        /* Collections section - red */
        .zman-section.section-collections h3 {
            color: var(--color-collection);
            border-bottom: 2px solid var(--color-collection-pale);
        }
        
        .zman-section.section-collections .zman-item-card {
            background: var(--color-collection-pale);
            border: 2px solid transparent;
        }
        
        .zman-section.section-collections .zman-item-card:hover {
            border-color: var(--color-collection);
        }

        /* Piyutim section - green */
        .zman-section.section-piyutim h3 {
            color: #2e8b2e;
            border-bottom: 2px solid #e8f5e9;
        }
        
        .zman-section.section-piyutim .zman-item-card {
            background: #e8f5e9;
            border: 2px solid transparent;
        }
        
        .zman-section.section-piyutim .zman-item-card:hover {
            border-color: #2e8b2e;
        }

        .zman-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .zman-item-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-cream);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 2px solid transparent;
        }

        .zman-item-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .zman-item-icon {
            font-size: 1.5em;
        }

        .zman-item-info {
            flex: 1;
            min-width: 0;
        }

        .zman-item-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .zman-item-count {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-top: 3px;
        }

        /* Search Results Page */
        .search-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .search-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bg-light);
        }

        .search-section-header h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .see-all-btn {
            background: none;
            border: none;
            color: var(--color-nigun);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
        }

        .see-all-btn:hover {
            text-decoration: underline;
        }

        .search-results-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-songs-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-songs-list .song-item {
            margin-bottom: 0;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-light);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .search-result-item.nigun-result {
            padding: 0;
            gap: 0;
        }

        .search-result-item .result-main {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            flex: 1;
            cursor: pointer;
        }

        .search-result-item .result-detail-btn {
            padding: 8px 15px;
            background: var(--color-nigun-pale);
            border: none;
            border-radius: 0 10px 10px 0;
            color: var(--color-nigun);
            font-family: inherit;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
            height: 100%;
        }

        .search-result-item .result-detail-btn:hover {
            background: var(--color-nigun);
            color: white;
        }

        .search-result-item:hover {
            background: var(--color-nigun-pale);
            transform: translateX(-5px);
        }

        .result-play {
            color: var(--color-nigun);
            font-size: 1.2em;
            opacity: 0;
            transition: var(--transition-smooth);
        }

        .search-result-item:hover .result-play {
            opacity: 1;
        }

        .result-icon {
            font-size: 1.3em;
            opacity: 0.7;
        }

        .result-info {
            flex: 1;
        }

        .result-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .result-meta {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .search-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .search-result-card {
            padding: 15px;
            background: var(--bg-light);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border-right: 4px solid transparent;
        }

        .search-result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .search-result-card .result-name {
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        .search-result-card .result-count {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .no-results-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-results-hint {
            font-size: 0.9em;
            margin-top: 10px;
        }

        .card-meta {
            font-size: 0.8em;
            color: var(--primary);
            margin-bottom: 8px;
            padding: 4px 10px;
            background: var(--primary-pale);
            border-radius: 8px;
            display: inline-block;
        }

        .card-icon {
            display: none;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-deep);
            flex: 1;
        }

        .card-count {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .card-expand-icon {
            font-size: 1.2em;
            color: var(--text-muted);
            transition: var(--transition-smooth);
        }

        .card-arrow {
            font-size: 1.2em;
            color: var(--text-muted);
            transition: var(--transition-smooth);
        }

        .category-card:hover .card-arrow {
            color: var(--primary);
            transform: translateX(-5px);
        }

        .category-card.expanded .card-expand-icon {
            transform: rotate(180deg);
            color: var(--primary);
        }

        /* Detail Page Styles */
        .detail-page {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Nigun Detail Page */
        .nigun-detail-page {
            max-width: 700px;
        }

        .nigun-detail-header {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 25px;
            color: white;
        }

        .nigun-detail-icon {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            flex-shrink: 0;
        }

        .nigun-detail-title-section {
            flex: 1;
        }

        .nigun-detail-title {
            font-size: 1.8em;
            margin: 0 0 12px 0;
            font-family: 'David Libre', serif;
        }

        .nigun-mechaber-tag {
            margin-bottom: 10px;
            text-align: center;
        }

        .nigun-chatzer-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .nigun-tag {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .nigun-tag.mechaber-tag {
            background: var(--color-mechaber);
            color: white;
        }

        .nigun-tag.mechaber-tag:hover {
            background: var(--color-mechaber-dark);
        }

        .nigun-tag.chatzer-tag {
            background: var(--color-chatzer);
            color: white;
        }

        .nigun-tag.chatzer-tag:hover {
            background: var(--color-chatzer-dark);
        }

        /* Standalone chatzer tag for use in cards */
        .chatzer-tag {
            display: inline-block;
            background: var(--color-chatzer);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .chatzer-tag:hover {
            background: var(--color-chatzer-dark);
        }

        /* Nigun sections */
        .nigun-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        /* Mechaber Section */
        .nigun-mechaber-section {
            background: white;
            border-radius: 15px;
            padding: 20px 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .nigun-mechaber-title {
            font-weight: 600;
            color: var(--color-mechaber-dark);
            margin-bottom: 15px;
            font-size: 1em;
            text-align: center;
        }

        .nigun-mechaber-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .nigun-mechaber-card {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            background: var(--bg-light);
            border-radius: 15px;
            padding: 20px 25px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 2px solid transparent;
        }

        .nigun-mechaber-card:hover {
            border-color: var(--color-mechaber);
            background: white;
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        .nigun-mechaber-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 3px solid var(--color-mechaber-pale);
        }

        .nigun-mechaber-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--color-mechaber-pale);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .nigun-mechaber-name {
            font-weight: 600;
            color: var(--text-dark);
            text-align: center;
            font-size: 0.95em;
        }

        /* Personality Section */
        .nigun-personality-section {
            background: white;
            border-radius: 15px;
            padding: 20px 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .nigun-personality-title {
            font-weight: 600;
            color: var(--color-mechaber-dark);
            margin-bottom: 15px;
            font-size: 1em;
            text-align: center;
        }

        .nigun-personality-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .nigun-personality-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--bg-light);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 2px solid transparent;
            min-width: 100px;
        }

        .nigun-personality-card:hover {
            border-color: var(--color-mechaber);
            background: white;
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        .nigun-personality-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid var(--color-mechaber-pale);
        }

        .nigun-personality-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--color-mechaber-pale);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .nigun-personality-name {
            font-weight: 500;
            color: var(--text-dark);
            text-align: center;
            font-size: 0.85em;
        }

        .nigun-details-card {
            background: white;
            border-radius: 15px;
            padding: 20px 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .nigun-detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--color-nigun-pale);
        }

        .nigun-detail-row:last-child {
            border-bottom: none;
        }

        .nigun-detail-label {
            font-weight: 600;
            color: var(--color-nigun-dark);
            min-width: 100px;
            flex-shrink: 0;
        }

        .nigun-detail-value {
            color: var(--text-dark);
            flex: 1;
        }

        .nigun-detail-value.nigun-tags-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .nigun-tag-inline {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .nigun-tag-inline.tag-scale {
            background: var(--color-nigun-pale);
            color: var(--color-nigun-dark);
            border: 1px solid var(--color-nigun-light);
            cursor: default;
        }

        .nigun-tag-inline.tag-ritem {
            background: var(--color-nigun-pale);
            color: var(--color-nigun-dark);
            border: 1px solid var(--color-nigun-light);
            cursor: default;
        }

        .nigun-tag-inline.tag-zman {
            background: var(--color-zman-pale);
            color: var(--color-zman-dark);
            border: 1px solid var(--color-zman-light);
        }

        .nigun-tag-inline.tag-zman:hover {
            background: var(--color-zman);
            color: white;
        }

        .nigun-tag-inline.tag-piyut {
            background: #e8f5e9;
            color: #1b5e20;
            border: 1px solid #81c784;
        }

        .nigun-tag-inline.tag-piyut:hover {
            background: #2e8b2e;
            color: white;
        }

        .nigun-tag-inline.tag-collection {
            background: var(--color-collection-pale);
            color: var(--color-collection-dark);
            border: 1px solid var(--color-collection-light);
        }

        .nigun-tag-inline.tag-collection:hover {
            background: var(--color-collection);
            color: white;
        }

        .nigun-tag-inline.tag-album {
            background: var(--color-album-pale);
            color: var(--color-album-dark);
            border: 1px solid var(--color-album-light);
        }

        .nigun-tag-inline.tag-album:hover {
            background: var(--color-album);
            color: white;
        }

        .nigun-tag-inline.tag-document {
            background: var(--color-document-pale);
            color: var(--color-document-dark);
            border: 1px solid var(--color-document-light);
        }

        .nigun-tag-inline.tag-document:hover {
            background: var(--color-document);
            color: white;
        }

        .nigun-tag-inline.tag-resource {
            background: var(--color-resource-pale);
            color: var(--color-resource-dark);
            border: 1px solid var(--color-resource-light);
        }

        .nigun-tag-inline.tag-resource:hover {
            background: var(--color-resource);
            color: white;
        }

        .nigun-tag-inline.tag-verter {
            background: var(--color-verter-pale);
            color: var(--color-verter-dark);
            border: 1px solid var(--color-verter-light);
        }

        .nigun-tag-inline.tag-verter:hover {
            background: var(--color-verter);
            color: white;
        }

        .nigun-section h3 {
            margin: 0 0 15px 0;
            color: var(--primary);
            font-size: 1.05em;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .nigun-section-content {
            color: var(--text-dark);
        }

        .nigun-siman {
            font-size: 1.1em;
            font-style: italic;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .nigun-verter {
            font-size: 1em;
        }

        .nigun-verter .field-link {
            font-size: 1.1em;
            color: var(--color-verter);
            border-bottom-color: var(--color-verter-light);
        }

        .nigun-verter .field-link:hover {
            color: var(--color-verter-dark);
        }

        .nigun-info-text {
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .nigun-music-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nigun-music-tag {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
            color: white;
        }

        .nigun-music-tag:hover {
            transform: scale(1.05);
            filter: brightness(0.9);
        }

        .nigun-music-tag.tag-scale,
        .nigun-music-tag.tag-ritem {
            background: var(--color-music);
        }

        .nigun-music-tag.tag-zman {
            background: var(--color-zman);
        }

        .nigun-music-tag.tag-maure {
            background: var(--color-zman-light);
        }

        .nigun-music-tag.tag-collection {
            background: var(--color-collection);
        }

        .nigun-notn-link {
            display: inline-block;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            text-decoration: none;
            transition: var(--transition-smooth);
        }

        .nigun-notn-link:hover {
            background: var(--primary-deep);
            transform: translateY(-2px);
        }

        /* Nigun recordings */
        .nigun-recordings-section {
            margin-bottom: 20px;
        }

        .nigun-recordings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .nigun-recording-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: var(--primary-pale);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .nigun-recording-item:hover {
            background: var(--primary-light);
            transform: translateX(-5px);
        }

        .nigun-recording-item.active {
            background: var(--primary);
        }

        .nigun-recording-item.active .nigun-recording-name,
        .nigun-recording-item.active .nigun-recording-filename {
            color: white;
        }

        .nigun-recording-item.active .nigun-recording-play-btn {
            background: white;
            color: var(--primary);
        }

        .nigun-recording-play-btn {
            width: 45px;
            height: 45px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            flex-shrink: 0;
            transition: var(--transition-smooth);
        }

        .nigun-recording-item:hover .nigun-recording-play-btn {
            transform: scale(1.1);
        }

        .nigun-recording-info {
            flex: 1;
        }

        .nigun-recording-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 1em;
            margin-bottom: 4px;
        }

        .nigun-recording-filename {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        /* Images section */
        .nigun-images-section {
            clear: both;
            margin-bottom: 20px;
        }
        
        .nigun-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .nigun-image-item {
            background: var(--bg-light);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 1px solid var(--border-color);
        }

        .nigun-image-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .nigun-image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .nigun-image-name {
            padding: 10px;
            font-size: 0.8em;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: white;
        }
        
        .nigun-image-details {
            padding: 5px 10px 10px;
            font-size: 0.75em;
            color: var(--text-secondary);
            background: white;
            border-top: 1px solid var(--border-color);
        }

        /* PDFs section */
        .nigun-pdfs-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nigun-pdf-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-light);
            border-radius: 10px;
            text-decoration: none;
            color: var(--text-dark);
            transition: var(--transition-smooth);
        }

        .nigun-pdf-item:hover {
            background: var(--color-document-pale);
        }

        .nigun-pdf-icon {
            font-size: 1.5em;
        }

        .nigun-pdf-name {
            flex: 1;
            font-size: 0.95em;
        }

        .nigun-pdf-action {
            background: var(--color-document);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        /* Image modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--primary-pale);
            border-radius: 25px;
            color: var(--primary);
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            margin-bottom: 25px;
            font-family: inherit;
        }

        .back-button:hover {
            background: var(--primary-pale);
            border-color: var(--primary);
        }

        .detail-header {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .detail-category-bar {
            padding: 8px 20px;
            font-size: 0.85em;
            font-weight: 600;
            background: var(--primary);
            color: white;
        }

        .detail-header-content {
            display: flex;
            flex-direction: row;
            gap: 20px;
            align-items: center;
            padding: 25px;
        }
        
        .detail-header-content.no-image {
            justify-content: center;
            text-align: center;
        }
        
        .detail-header-text {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detail-header-content.no-image .detail-header-text {
            align-items: center;
        }

        .detail-title {
            font-size: 1.8em;
            font-weight: 700;
            font-family: 'David Libre', serif;
            color: var(--primary-deep);
            margin: 0;
        }

        /* Category-themed detail pages */
        .detail-page.theme-chatzer .detail-category-bar {
            background: var(--color-chatzer);
        }
        .detail-page.theme-chatzer .detail-title { 
            color: var(--color-chatzer-dark);
        }

        .detail-page.theme-mechaber .detail-category-bar {
            background: var(--color-mechaber);
        }
        .detail-page.theme-mechaber .detail-title { 
            color: var(--color-mechaber-dark); 
        }

        .detail-page.theme-verter .detail-category-bar {
            background: var(--color-verter);
        }
        .detail-page.theme-verter .detail-title { 
            color: var(--color-verter-dark); 
        }

        .detail-page.theme-zman .detail-category-bar {
            background: var(--color-zman);
        }
        .detail-page.theme-zman .detail-title,
        .detail-page.theme-zman h1 { 
            color: var(--color-zman-dark); 
        }

        .detail-page.theme-piyut .detail-category-bar {
            background: #2e8b2e;
        }
        .detail-page.theme-piyut .detail-title,
        .detail-page.theme-piyut h1 { 
            color: #1b5e20; 
        }

        .detail-page.theme-collection .detail-category-bar {
            background: var(--color-collection);
        }
        .detail-page.theme-collection .detail-title { 
            color: var(--color-collection-dark); 
        }

        /* Detail page sections and actions */
        .detail-section {
            background: white;
            border-radius: 15px;
            padding: 20px 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .detail-section h3 {
            margin: 0 0 15px 0;
            color: var(--primary);
            font-size: 1.05em;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .detail-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .detail-action-btn {
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .detail-action-btn.album-booklet-btn,
        .detail-action-btn.album-buy-btn {
            background: var(--color-album);
            color: white;
        }

        .detail-action-btn.album-booklet-btn:hover,
        .detail-action-btn.album-buy-btn:hover {
            background: var(--color-album-dark);
        }

        .detail-action-btn.document-pdf-btn {
            background: var(--color-document);
            color: white;
        }

        .detail-action-btn.document-pdf-btn:hover {
            background: var(--color-document-dark);
        }

        .detail-action-btn.document-link-btn {
            background: var(--color-document-pale);
            color: var(--color-document-dark);
        }

        .detail-action-btn.resource-link-btn {
            background: var(--color-resource);
            color: white;
        }

        .detail-action-btn.resource-link-btn:hover {
            background: var(--color-resource-dark);
        }

        .detail-pdf-preview {
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .detail-songs-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detail-subtitle {
            font-size: 1.1em;
            color: var(--text-muted);
        }

        .detail-chatzer {
            margin-top: 10px;
        }

        .detail-year {
            font-size: 0.95em;
            color: var(--text-muted);
        }

        .resource-phone-display {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--color-resource-dark);
            background: var(--color-resource-pale);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            white-space: pre-line;
            line-height: 1.8;
        }

        .detail-image {
            width: 120px;
            height: 120px;
            border-radius: 15px;
            object-fit: cover;
            border: 4px solid var(--primary-pale);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            flex-shrink: 0;
        }

        /* Round images for mechabrim */
        .mechaber-detail .detail-image,
        .detail-page[data-type="mechabrim"] .detail-image {
            border-radius: 50%;
        }

        .detail-icon {
            display: none;
        }

        .detail-type-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .detail-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 12px;
            justify-content: center;
        }

        .detail-tag-badge {
            margin-bottom: 10px;
        }

        .mechaber-tag-name {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .detail-life-dates {
            margin-top: 8px;
            font-size: 1em;
            color: var(--text-secondary);
            font-style: italic;
        }

        .detail-chatzer-badge {
            display: inline-block;
            background: var(--color-chatzer);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            transition: var(--transition-smooth);
        }

        .detail-chatzer-badge:hover {
            background: var(--color-chatzer-dark);
            transform: scale(1.05);
        }

        .detail-zmanim-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .detail-zman-badge {
            background: var(--primary-pale);
            color: var(--primary-deep);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .detail-zman-badge:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .detail-subtitle {
            margin-top: 10px;
            font-size: 1em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .detail-makor-text {
            color: var(--primary);
            font-weight: 600;
        }

        .detail-mareh-text {
            color: var(--text-dark);
        }

        .detail-zman-text {
            color: var(--primary);
            font-weight: 600;
        }

        .detail-separator {
            color: var(--text-muted);
        }

        .detail-title {
            font-size: 2em;
            color: var(--primary-deep);
            font-family: 'David Libre', serif;
            margin-bottom: 0;
            line-height: 1.3;
        }

        .detail-description-section {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
        }

        .detail-description-section h3 {
            color: var(--primary);
            font-size: 1.2em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .detail-description-content {
            font-size: 1em;
            color: var(--text-dark);
            line-height: 1.8;
        }

        .detail-description-content h4 {
            color: var(--primary-deep);
            font-size: 1.1em;
            margin: 20px 0 10px 0;
        }

        .detail-description-content a {
            color: var(--primary);
            text-decoration: underline;
        }

        .detail-description-content strong {
            color: var(--primary-deep);
        }

        .detail-info-section {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
        }

        .detail-info-section h3 {
            color: var(--primary);
            font-size: 1.2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .detail-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-info-item {
            background: var(--bg-cream);
            padding: 12px 15px;
            border-radius: 10px;
            border-right: 3px solid var(--primary);
        }

        .detail-info-label {
            display: block;
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .detail-info-value {
            display: block;
            font-size: 1em;
            color: var(--text-dark);
            font-weight: 600;
        }

        .detail-songs-section {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
        }

        .detail-songs-section.detail-related-songs {
            margin-top: 25px;
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border: 1px solid var(--color-mechaber-pale);
        }

        .detail-songs-section.detail-related-songs h3 {
            color: var(--color-mechaber-dark);
        }

        .detail-mechabrim-section {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
        }

        .detail-mechabrim-section h3 {
            color: var(--primary);
            font-size: 1.2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .mechabrim-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }

        .mechaber-card {
            background: var(--bg-cream);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 2px solid transparent;
        }

        .mechaber-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .mechaber-card-image {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 3px solid var(--primary-pale);
        }

        .mechaber-card-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--primary-pale);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            margin: 0 auto 10px auto;
        }

        .mechaber-card-name {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--primary-deep);
            line-height: 1.3;
        }

        .detail-verter-section {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
        }

        .detail-verter-section h3 {
            color: var(--primary);
            font-size: 1.2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .verter-content {
            background: linear-gradient(135deg, var(--bg-cream) 0%, #fff 100%);
            padding: 25px;
            border-radius: 15px;
            border-right: 4px solid var(--accent-gold);
        }

        .verter-line {
            font-size: 1.1em;
            line-height: 1.8;
            color: var(--text-dark);
            font-family: 'David Libre', serif;
        }

        .verter-line.verter-empty {
            height: 15px;
        }

        .detail-songs-section h3 {
            color: var(--primary);
            font-size: 1.2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .detail-songs-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .detail-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .detail-image, .detail-icon {
                width: 120px;
                height: 120px;
            }

            .detail-title {
                font-size: 1.5em;
            }

            .detail-info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Expanded card info (hidden by default) */
        .card-expanded-info {
            display: none;
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-pale) 0%, #fff 100%);
            border-radius: 12px;
            border: 1px solid var(--primary-pale);
        }

        .category-card.expanded .card-expanded-info {
            display: block;
        }

        .card-image-large {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            object-fit: cover;
            float: right;
            margin-left: 15px;
            margin-bottom: 10px;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .card-full-description {
            font-size: 0.95em;
            color: var(--text-dark);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .card-info-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            clear: both;
        }

        .info-tag {
            background: white;
            color: var(--primary);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            border: 1px solid var(--primary-pale);
        }

        .card-songs-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .card-songs-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 1em;
        }

        /* Songs List inside Card */
        .card-songs {
            display: none;
            margin-top: 20px;
            border-top: 1px solid var(--primary-pale);
            padding-top: 15px;
        }

        .category-card.expanded .card-songs {
            display: block;
        }

        .songs-list {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .song-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition-smooth);
            margin-bottom: 8px;
            background: var(--color-nigun-pale);
            border: 1px solid transparent;
        }

        .song-item:hover {
            background: white;
            border-color: var(--color-nigun-light);
            transform: translateX(-5px);
        }

        .song-item.no-audio {
            background: var(--bg-light);
            opacity: 0.75;
            border: 1px dashed var(--border-color);
        }

        .song-item.no-audio:hover {
            opacity: 1;
            background: white;
            border-color: var(--text-muted);
        }

        .song-item.no-audio .song-number {
            background: var(--bg-light);
            color: var(--text-muted);
        }

        .song-item.no-audio .song-name {
            color: var(--text-muted);
        }

        .song-item.active {
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-nigun-light) 100%);
            color: white;
        }

        .song-item.active .song-meta {
            color: rgba(255,255,255,0.8);
        }

        .song-number {
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85em;
            color: var(--color-nigun);
            flex-shrink: 0;
        }

        .song-item.active .song-number {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .song-info {
            flex: 1;
            min-width: 0;
        }

        .song-name {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-meta {
            font-size: 0.85em;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-meta-link {
            color: var(--text-muted);
            text-decoration: none;
            transition: var(--transition-smooth);
        }

        .song-meta-link:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        .song-item.active .song-meta-link {
            color: rgba(255,255,255,0.8);
        }

        .song-item.active .song-meta-link:hover {
            color: white;
        }

        .song-play-btn {
            width: 35px;
            height: 35px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            opacity: 0;
            transition: var(--transition-smooth);
            flex-shrink: 0;
        }

        .song-details-btn {
            padding: 6px 12px;
            background: var(--color-nigun-pale);
            border: 1px solid var(--color-nigun-light);
            border-radius: 8px;
            color: var(--color-nigun-dark);
            font-size: 0.8em;
            cursor: pointer;
            transition: var(--transition-smooth);
            flex-shrink: 0;
            font-family: inherit;
        }

        .song-details-btn:hover {
            background: var(--color-nigun);
            color: white;
            border-color: var(--color-nigun);
        }

        .song-item.active .song-details-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border-color: rgba(255,255,255,0.3);
        }

        /* All Songs Page */
        .songs-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            max-width: 700px;
            margin: 0 auto;
        }

        .filters-container {
            max-width: 700px;
            margin: 0 auto 20px auto;
            background: var(--color-nigun-pale);
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            padding: 15px;
            border: 1px solid var(--color-nigun-light);
        }

        .all-songs-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .all-songs-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .sort-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary-pale);
            background: white;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: inherit;
        }

        .sort-btn:hover, .sort-btn.active {
            border-color: var(--primary);
            background: var(--primary-pale);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--color-nigun-light);
        }

        .page-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--color-nigun-light);
            background: white;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: inherit;
        }

        .page-btn:hover:not(:disabled) {
            border-color: var(--color-nigun);
            background: var(--color-nigun-pale);
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-info {
            padding: 8px 16px;
            background: var(--color-nigun-pale);
            border-radius: 10px;
            font-weight: 600;
            color: var(--color-nigun-dark);
        }

        /* Fixed Player */
        .player-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 30px;
            box-shadow: 0 -5px 30px rgba(74, 18, 89, 0.15);
            z-index: 200;
            direction: ltr;
        }

        .player-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .player-info {
            flex: 1;
            text-align: right;
            direction: rtl;
            min-width: 0;
        }

        .player-song-name {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--primary-deep);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-song-meta {
            font-size: 0.85em;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-meta-link {
            color: var(--text-muted);
            text-decoration: none;
            transition: var(--transition-smooth);
        }

        .player-meta-link:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        #playerCollection .player-meta-link {
            color: var(--primary);
            font-weight: 600;
        }

        #playerCollection .player-meta-link:hover {
            color: var(--primary-deep);
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .player-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 50%;
            transition: var(--transition-smooth);
        }

        .player-btn:hover {
            color: var(--primary);
            background: var(--primary-pale);
        }

        .player-btn.main {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            font-size: 1.4em;
            box-shadow: 0 4px 15px rgba(123, 31, 162, 0.3);
        }

        .player-btn.main:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(123, 31, 162, 0.4);
        }

        .player-progress {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: var(--primary-pale);
            border-radius: 10px;
            cursor: pointer;
            overflow: hidden;
        }

        .progress-bar-container:hover {
            height: 8px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent-gold) 100%);
            border-radius: 10px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: var(--text-muted);
        }

        .player-extra {
            flex: 1;
            text-align: left;
            direction: rtl;
        }

        .player-extra-line {
            font-size: 0.75em;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #playerCollection {
            font-weight: 600;
            color: var(--primary);
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-muted);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary-pale);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 300;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .modal-header h2 {
            font-size: 1.3em;
            font-family: 'David Libre', serif;
        }

        .modal-close {
            width: 35px;
            height: 35px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 50%;
            font-size: 1.3em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: calc(80vh - 80px);
        }

        /* Modal recordings section */
        .modal-recordings-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--primary-pale);
        }

        .modal-recordings-title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .modal-recordings-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-recording-item {
            background: var(--primary-pale);
            border-radius: 12px;
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
        }

        .modal-recording-item:hover {
            background: var(--primary-light);
            transform: translateX(-3px);
        }

        .modal-recording-item.active {
            background: var(--primary);
        }

        .modal-recording-item.active .modal-recording-name {
            color: white;
        }

        .modal-recording-item.active .modal-recording-play-btn {
            background: white;
            color: var(--primary);
        }

        .modal-recording-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .modal-recording-play-btn {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            flex-shrink: 0;
            transition: var(--transition-smooth);
        }

        .modal-recording-item:hover .modal-recording-play-btn {
            transform: scale(1.1);
        }

        .modal-recording-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95em;
        }

        .detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--primary-pale);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            width: 120px;
            font-weight: 700;
            color: var(--primary);
            flex-shrink: 0;
        }

        .detail-value {
            flex: 1;
            color: var(--text-dark);
        }

        .field-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            padding: 2px 8px;
            background: var(--primary-pale);
            border-radius: 12px;
            transition: var(--transition-smooth);
            display: inline-block;
            margin: 2px;
        }

        .field-link:hover {
            background: var(--primary);
            color: white;
            text-decoration: none;
        }

        /* Hover Tooltip Popup */
        .hover-tooltip {
            position: fixed;
            background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            border: none;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s, transform 0.2s;
            max-width: 280px;
            min-width: 200px;
            direction: rtl;
            overflow: hidden;
        }

        .hover-tooltip-type {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 15px;
            background: var(--primary);
            color: white;
        }

        /* Category-themed tooltips */
        .hover-tooltip.tooltip-chatzer .hover-tooltip-type {
            background: var(--color-chatzer);
        }
        .hover-tooltip.tooltip-chatzer .hover-tooltip-title {
            color: var(--color-chatzer-dark);
        }

        .hover-tooltip.tooltip-mechaber .hover-tooltip-type {
            background: var(--color-mechaber-dark);
        }
        .hover-tooltip.tooltip-mechaber .hover-tooltip-title {
            color: var(--color-mechaber-dark);
        }

        .hover-tooltip.tooltip-verter .hover-tooltip-type {
            background: var(--color-verter);
        }
        .hover-tooltip.tooltip-verter .hover-tooltip-title {
            color: var(--color-verter-dark);
        }

        .hover-tooltip.tooltip-zman .hover-tooltip-type {
            background: var(--color-zman);
        }
        .hover-tooltip.tooltip-zman .hover-tooltip-title {
            color: var(--color-zman-dark);
        }

        .hover-tooltip.tooltip-piyut .hover-tooltip-type {
            background: #2e8b2e;
        }
        .hover-tooltip.tooltip-piyut .hover-tooltip-title {
            color: #1b5e20;
        }

        .hover-tooltip.tooltip-collection .hover-tooltip-type {
            background: var(--color-collection);
        }
        .hover-tooltip.tooltip-collection .hover-tooltip-title {
            color: var(--color-collection-dark);
        }

        .hover-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        .hover-tooltip-header {
            display: flex;
            gap: 12px;
            padding: 15px;
            align-items: center;
        }

        .hover-tooltip-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .hover-tooltip-image.round {
            border-radius: 50%;
        }

        .hover-tooltip-image.large {
            width: 60px;
            height: 60px;
        }

        .hover-tooltip-title-area {
            flex: 1;
        }

        .hover-tooltip-title {
            font-size: 1.15em;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1.3;
        }

        .hover-tooltip-subtitle {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .hover-tooltip-stats {
            padding: 10px 15px;
            background: var(--bg-cream);
            border-top: 1px solid rgba(0,0,0,0.05);
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .hover-tooltip-hint {
            padding: 8px 15px;
            font-size: 0.75em;
            color: var(--text-muted);
            text-align: center;
            background: rgba(0,0,0,0.03);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .loading-songs-message {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .loading-songs-message .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary-pale);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                gap: 15px;
            }

            .global-search {
                max-width: 100%;
                margin: 0;
                order: 2;
            }

            .main-nav {
                order: 3;
            }

            .category-grid {
                grid-template-columns: 1fr;
            }

            .player-inner {
                flex-wrap: wrap;
            }

            .player-info {
                order: 1;
                width: 100%;
                text-align: center;
                margin-bottom: 10px;
            }

            .player-controls {
                order: 2;
            }

            .player-progress {
                order: 3;
                flex: 1;
            }

            .player-extra {
                display: none;
            }
        }

        /* Filters section for all songs page */
        .filters-container {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Songs page sidebar layout */
        .songs-page-layout {
            display: flex;
            flex-direction: row-reverse;
            gap: 25px;
            align-items: flex-start;
        }

        .songs-main-content {
            flex: 1;
            min-width: 0;
        }

        .songs-sidebar {
            width: 280px;
            flex-shrink: 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .sidebar-search-box {
            display: flex;
            position: relative;
            margin-bottom: 15px;
        }

        .sidebar-search-input {
            flex: 1;
            padding: 12px 15px;
            padding-left: 40px;
            border: 2px solid var(--color-nigun-pale);
            border-radius: 10px;
            font-size: 0.95em;
            font-family: inherit;
            direction: rtl;
            transition: var(--transition-smooth);
        }

        .sidebar-search-input:focus {
            outline: none;
            border-color: var(--color-nigun);
        }

        .sidebar-search-btn {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            opacity: 0.6;
            transition: var(--transition-smooth);
        }

        .sidebar-search-btn:hover {
            opacity: 1;
        }

        .sidebar-search-clear {
            position: absolute;
            left: 35px;
            top: 50%;
            transform: translateY(-50%);
            background: #999;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-search-clear:hover {
            background: #666;
        }

        .sidebar-audio-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: var(--color-nigun-pale);
            border-radius: 10px;
            margin-bottom: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition-smooth);
        }

        .sidebar-audio-toggle:hover {
            background: var(--color-nigun-light);
        }

        .sidebar-audio-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--color-nigun);
            cursor: pointer;
        }

        .sidebar-section {
            margin-bottom: 15px;
        }

        .sidebar-section-title {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--text-dark);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--color-nigun-pale);
        }

        .sidebar-collection-btn {
            width: 100%;
            padding: 12px 15px;
            background: white;
            border: 2px solid var(--color-nigun);
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95em;
            cursor: pointer;
            transition: var(--transition-smooth);
            color: var(--color-nigun);
        }

        .sidebar-collection-btn:hover,
        .sidebar-collection-btn.active {
            background: var(--color-nigun);
            color: white;
        }

        .sidebar-filter {
            margin-bottom: 12px;
        }

        .sidebar-filter-dropdown {
            position: relative;
        }

        .sidebar-filter-btn {
            width: 100%;
            padding: 10px 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            transition: var(--transition-smooth);
            position: relative;
            padding-right: 20px;
        }

        .sidebar-filter-btn::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 0 8px 8px 0;
        }

        /* Filter colors as right border */
        .sidebar-filter[data-filter="collection"] .sidebar-filter-btn::before { background: var(--color-collection); }
        .sidebar-filter[data-filter="chatzer"] .sidebar-filter-btn::before { background: var(--color-chatzer); }
        .sidebar-filter[data-filter="mechaber"] .sidebar-filter-btn::before { background: var(--color-mechaber); }
        .sidebar-filter[data-filter="verter"] .sidebar-filter-btn::before { background: var(--color-verter); }
        .sidebar-filter[data-filter="gezungen"] .sidebar-filter-btn::before { background: #2e8b2e; } /* גרין - פיוטים */
        .sidebar-filter[data-filter="ritem"] .sidebar-filter-btn::before { background: var(--color-music); }
        .sidebar-filter[data-filter="scale"] .sidebar-filter-btn::before { background: var(--color-nigun); }

        .sidebar-filter-btn .sidebar-filter-label {
            font-size: 0.95em;
            font-weight: 600;
            color: var(--text-dark);
        }

        .sidebar-filter-btn .sidebar-filter-value {
            flex: 1;
            text-align: left;
            color: var(--text-dark);
        }

        .sidebar-filter-btn:hover {
            border-color: var(--color-nigun);
        }

        .sidebar-filter-btn.active {
            border-color: var(--color-nigun);
            background: var(--color-nigun-pale);
        }

        .sidebar-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            left: 0;
            background: white;
            border: 2px solid var(--color-nigun);
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .sidebar-dropdown-content.show {
            display: block;
        }

        .dropdown-search-box {
            padding: 8px;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            background: white;
        }

        .dropdown-search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85em;
            font-family: inherit;
            direction: rtl;
        }

        .dropdown-search-input:focus {
            outline: none;
            border-color: var(--color-nigun);
        }

        .dropdown-options {
            max-height: 200px;
            overflow-y: auto;
        }

        .sidebar-filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 0.9em;
        }

        .sidebar-filter-option:hover {
            background: var(--color-nigun-pale);
        }

        .sidebar-filter-option input {
            accent-color: var(--color-nigun);
            width: 16px;
            height: 16px;
            cursor: pointer;
            flex-shrink: 0;
        }

        /* Mobile responsive */
        @media (max-width: 900px) {
            .songs-page-layout {
                flex-direction: column;
            }
            
            .songs-sidebar {
                width: 100%;
                position: static;
                max-height: none;
                margin-bottom: 20px;
            }
        }

        .search-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .songs-search-box {
            display: flex;
            flex: 1;
            position: relative;
        }

        .songs-search-input {
            flex: 1;
            padding: 10px 15px;
            padding-left: 40px;
            border: 2px solid #ddd;
            border-left: none;
            border-radius: 0 8px 8px 0;
            font-size: 0.95em;
            font-family: inherit;
            direction: rtl;
            transition: var(--transition-smooth);
        }

        .songs-search-input:focus {
            outline: none;
            border-color: var(--color-nigun);
        }

        .search-clear-btn {
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background: #999;
            color: white;
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-smooth);
        }

        .search-clear-btn:hover {
            background: #666;
        }

        .songs-search-btn {
            padding: 10px 20px;
            background: var(--color-nigun);
            color: white;
            border: 2px solid var(--color-nigun);
            border-radius: 8px 0 0 8px;
            font-family: inherit;
            font-size: 0.95em;
            cursor: pointer;
            transition: var(--transition-smooth);
            white-space: nowrap;
        }

        .songs-search-btn:hover {
            background: var(--color-nigun-dark);
            border-color: var(--color-nigun-dark);
        }

        .clear-filters-btn {
            padding: 10px 15px;
            border: 2px solid #e74c3c;
            background: white;
            color: #e74c3c;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: inherit;
            white-space: nowrap;
        }

        .clear-filters-btn:hover {
            background: #e74c3c;
            color: white;
        }

        .audio-only-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            transition: var(--transition-smooth);
        }

        .audio-only-checkbox:hover {
            border-color: var(--color-nigun);
        }

        .audio-only-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--color-nigun);
            cursor: pointer;
        }

        .filters-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-dropdown {
            position: relative;
        }

        .filter-btn {
            padding: 10px 15px;
            border: 2px solid var(--color-nigun-light);
            background: white;
            border-radius: 10px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-btn:hover, .filter-btn.active {
            border-color: var(--color-nigun);
            background: var(--color-nigun-pale);
        }

        .filter-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid var(--color-nigun);
            border-radius: 10px;
            margin-top: 5px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: var(--card-hover-shadow);
        }

        .filter-dropdown-content.show {
            display: block;
        }

        .filter-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-option:hover {
            background: var(--primary-pale);
        }

        .filter-option input {
            width: 18px;
            height: 18px;
        }

        .active-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--primary-pale);
        }

        .active-filters:empty {
            display: none;
        }

        .filter-tag {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-tag-close {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
        }

        .filter-tag-close:hover {
            opacity: 1;
        }

        /* Stats cards on home */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--card-shadow);
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
            font-family: 'David Libre', serif;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-muted);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-main">
            <div class="logo" onclick="navigateTo('home')">
                <div class="logo-icon">♪</div>
                <h1>אוצר הניגונים</h1>
            </div>
            
            <nav class="header-nav">
                <div class="main-nav">
                <!-- היים -->
                <div class="nav-dropdown">
                    <button class="nav-dropdown-btn nav-home" onclick="navigateTo('home')">
                        היים
                        <span class="nav-arrow">▼</span>
                    </button>
                    <div class="nav-dropdown-content">
                        <div class="dropdown-inner">
                            <div class="nav-dropdown-item" data-dest="home" onclick="event.stopPropagation(); navigateTo('home')">
                                <span>הויפט בלאט</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="info" onclick="event.stopPropagation(); scrollToSection('about')">
                                <span>אונזער ציל</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="info" onclick="event.stopPropagation(); scrollToSection('instructions')">
                                <span>אנווייזונגען</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="info" onclick="event.stopPropagation(); scrollToSection('stats')">
                                <span>סטאטיסטיקס</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="info" onclick="event.stopPropagation(); scrollToSection('credits')">
                                <span>קרעדיטס</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="info" onclick="event.stopPropagation(); scrollToSection('thanks')">
                                <span>התודה והברכה</span>
                            </div>
                            <div class="nav-dropdown-divider"></div>
                            <div class="nav-dropdown-item" data-dest="info" onclick="event.stopPropagation(); scrollToSection('terms')">
                                <span>Terms of Use</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ניגונים -->
                <div class="nav-dropdown">
                    <button class="nav-dropdown-btn nav-nigunim" onclick="navigateTo('songs')">
                        ניגונים
                        <span class="nav-arrow">▼</span>
                    </button>
                    <div class="nav-dropdown-content">
                        <div class="dropdown-inner">
                            <div class="nav-dropdown-item" data-dest="songs" onclick="event.stopPropagation(); navigateTo('songs')">
                                <span>אלע ניגונים</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="mechabrim" onclick="event.stopPropagation(); navigateTo('mechabrim')">
                                <span>מחברים</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="chatzeros" onclick="event.stopPropagation(); navigateTo('chatzeros')">
                                <span>חצרות</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- פאסיגע ניגונים -->
                <div class="nav-dropdown">
                    <button class="nav-dropdown-btn nav-pasig" onclick="navigateTo('zmanim')">
                        פאסיגע ניגונים
                        <span class="nav-arrow">▼</span>
                    </button>
                    <div class="nav-dropdown-content">
                        <div class="dropdown-inner">
                            <div class="nav-dropdown-item" data-dest="verter" onclick="event.stopPropagation(); navigateTo('verter')">
                                <span>ווערטער</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="zmanim" onclick="event.stopPropagation(); navigateTo('zmanim')">
                                <span>מועדים וזמנים</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="music" onclick="event.stopPropagation(); navigateTo('music')">
                                <span>ריטעם</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="collections" onclick="event.stopPropagation(); navigateTo('collections')">
                                <span>קאלעקשאנס</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- דאקומענטאציע -->
                <div class="nav-dropdown">
                    <button class="nav-dropdown-btn nav-docs" onclick="navigateTo('documents')">
                        דאקומענטאציע
                        <span class="nav-arrow">▼</span>
                    </button>
                    <div class="nav-dropdown-content">
                        <div class="dropdown-inner">
                            <div class="nav-dropdown-item" data-dest="resources" onclick="event.stopPropagation(); navigateTo('resources')">
                                <span>רעסורסן</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="albums" onclick="event.stopPropagation(); navigateTo('albums')">
                                <span>אלבומס</span>
                            </div>
                            <div class="nav-dropdown-item" data-dest="documents" onclick="event.stopPropagation(); navigateTo('documents')">
                                <span>דאקומענטן</span>
                            </div>
                        </div>
                    </div>
                </div>
                </nav>
                
                <div class="global-search">
                    <input type="text" id="globalSearch" placeholder="זוך..." onkeydown="if(event.key==='Enter') executeGlobalSearch()">
                    <button class="global-search-btn" onclick="executeGlobalSearch()">⌕</button>
                </div>
                <a href="https://stream.oitzerhanigunim.org/" target="_blank" class="stream-btn" title="סטרימינג">סטרימינג</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Content will be rendered by JavaScript -->
    </main>

    <!-- Player -->
    <div class="player-section">
        <div class="player-inner">
            <div class="player-info">
                <div class="player-song-name" id="playerSongName">קליק אויף א ניגון צו שפילן</div>
                <div class="player-song-meta" id="playerSongMeta"></div>
            </div>
            <div class="player-controls">
                <button class="player-btn" onclick="playPrevious()" title="פריערדיגע">⏮</button>
                <button class="player-btn main" id="playPauseBtn" onclick="togglePlayPause()">▶</button>
                <button class="player-btn" onclick="playNext()" title="קומענדיגע">⏭</button>
            </div>
            <div class="player-progress">
                <div class="progress-bar-container" onclick="seekTo(event)">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>
            <div class="player-extra">
                <div class="player-extra-line" id="playerCollection"></div>
                <div class="player-extra-line" id="playerGezungen"></div>
            </div>
        </div>
        <audio id="audioPlayer"></audio>
    </div>

    <!-- Hover Tooltip -->
    <div class="hover-tooltip" id="hoverTooltip">
        <div class="hover-tooltip-type" id="tooltipType">חצר</div>
        <div class="hover-tooltip-header">
            <img class="hover-tooltip-image" id="tooltipImage" src="" alt="" style="display: none;">
            <div class="hover-tooltip-title-area">
                <div class="hover-tooltip-title" id="tooltipTitle">טייטל</div>
                <div class="hover-tooltip-subtitle" id="tooltipSubtitle"></div>
            </div>
        </div>
        <div class="hover-tooltip-stats" id="tooltipStats"></div>
    </div>

    <!-- Song Details Modal -->
    <div class="modal" id="songModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">דעטאלן</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- PDF Popup -->
    <div class="pdf-popup-overlay" id="pdfPopup" onclick="closePdfPopup(event)">
        <div class="pdf-popup" onclick="event.stopPropagation()">
            <div class="pdf-popup-header">
                <div class="pdf-popup-title" id="pdfPopupTitle">דאקומענט</div>
                <button class="pdf-popup-close" onclick="closePdfPopup()">&times;</button>
            </div>
            <div class="pdf-popup-body">
                <iframe id="pdfPopupFrame" src=""></iframe>
            </div>
            <div class="pdf-popup-footer">
                <a id="pdfDownloadLink" href="" target="_blank" class="pdf-download-btn">
                    דאונלאוד PDF
                </a>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const WORKER_URL = 'https://api.oitzerhanigunim.org/api/';
        const DOC_ID = '6QcJRx7e13';
        const TABLE_ID = 'grid-YycmDjJ8pS'; // Songs table
        
        // Additional table IDs from Coda doc
        const MECHABRIM_TABLE_ID = 'grid-bCbfhDmi82'; // מחברים טעיבל
        const CHATZEROS_TABLE_ID = 'grid-4-KYWDJ5l9'; // חצרות טעיבל
        const VERTER_TABLE_ID = 'grid-tLcBzyh_tz'; // ווערטער טעיבל
        const PIYUTIM_TABLE_ID = 'grid-318i50N4cK'; // פיוטים טעיבל
        const ZMANIM_TABLE_ID = 'grid-K2rOGXJwjk'; // זמנים טעיבל
        const COLLECTIONS_TABLE_ID = 'grid-K7Mo-tilkg'; // קאלעקשנס טעיבל
        const RESOURCES_TABLE_ID = 'grid-8Gfz8rXNUV'; // רעסורסן טעיבל
        const DOCUMENTS_TABLE_ID = 'grid-3wKzDnkPg-'; // דאקומענטן טעיבל
        const ALBUMS_TABLE_ID = 'grid-bbTaa18Jhx'; // אלבומס טעיבל
        const STATS_TABLE_ID = 'table-CbrETqO5E9'; // סטאטיסטיקס טעיבל (View 3 of Table)

        // Stats table column IDs (all in row 1)
        const STATS_COLS = {
            niggunim: 'c-3wC2msD8Ll',
            mechabrim: 'c-5u6KHT3ZLF',
            verter: 'c-IadpFStSEK',
            chatzeros: 'c-i--tHnlwAu',
            zmanim: 'c-ZFj4le3Q0t',
            piyutim: 'c-0X_OHjkDDx',
            collections: 'c-Y9SNk0BOGV'
        };
        
        // Helper to escape strings for use in onclick attributes
        // Uses base64 encoding to safely handle ALL special characters including quotes
        function escapeAttr(str) {
            if (!str) return '';
            // Use base64 to avoid any issues with quotes or special chars
            return btoa(encodeURIComponent(String(str)));
        }
        
        // Helper to decode the escaped attribute
        function decodeAttr(encoded) {
            if (!encoded) return '';
            try {
                return decodeURIComponent(atob(encoded));
            } catch(e) {
                return encoded;
            }
        }

        // State
        let allSongs = [];
        let filteredSongs = [];
        let currentPage = 1;
        const songsPerPage = 25;
        let currentSongIndex = -1;
        let currentPlaylist = []; // Track which songs are in current playlist
        let currentPlaylistPosition = -1; // Position within playlist
        let currentRecordingIndex = 0; // Track which recording of current song is playing
        let isInRecordingsMode = false; // Are we navigating between recordings or songs?
        let currentPageView = 'home';
        let searchQuery = ''; // Search query for songs
        let audioOnlyFilter = true; // Show only songs with audio (default on)

        // Category data
        let categories = {
            chatzeros: {},
            mechabrim: {},
            verter: {},
            zmanim: {},
            collections: {}
        };
        
        // Extended info for all categories (from separate tables)
        let chatzerosInfo = {}; 
        let mechabrimInfo = {}; 
        let verterInfo = {}; 
        let zmaninInfo = {}; 
        let piyutimInfo = {};
        let collectionsInfo = {};
        let resourcesInfo = {};
        let documentsInfo = {};
        let albumsInfo = {};

        // Active filters for all-songs view
        let activeFilters = {
            chatzer: [],
            mechaber: [],
            verter: [],
            zman: [],
            collection: [],
            scale: [],
            ritem: [],
            gezungen: [],
            maure: []
        };

        // Audio player
        const audioPlayer = document.getElementById('audioPlayer');

        // Helper function to extract text from Coda value
        function extractText(value) {
            if (!value) return '';
            if (typeof value === 'string') return value.replace(/```/g, '').trim();
            if (Array.isArray(value)) return value.map(v => extractText(v)).filter(Boolean).join(', ');
            if (typeof value === 'object') {
                const text = value.name || value.display || value.value || '';
                return typeof text === 'string' ? text.replace(/```/g, '').trim() : text;
            }
            return '';
        }
        
        // Helper function to extract image URL from Coda value
        function extractImageUrl(value) {
            if (!value) return null;
            
            // Direct string URL
            if (typeof value === 'string' && value.startsWith('http')) {
                return value;
            }
            
            // Array format (Coda's typical image format)
            if (Array.isArray(value) && value.length > 0) {
                const first = value[0];
                // ImageObject format: { "@type": "ImageObject", "url": "..." }
                if (first && first['@type'] === 'ImageObject' && first.url) {
                    return first.url;
                }
                // Simple object with url
                if (first && first.url) {
                    return first.url;
                }
                // Direct string in array
                if (typeof first === 'string' && first.startsWith('http')) {
                    return first;
                }
            }
            
            // Direct object with url
            if (value && typeof value === 'object' && value.url) {
                return value.url;
            }
            
            return null;
        }
        
        // Helper function to extract URL from various Coda formats (WebPage, ImageObject, etc.)
        function extractUrl(value) {
            if (!value) return null;
            
            // Direct string URL
            if (typeof value === 'string') {
                // Check if it's markdown link format [text](url)
                const markdownMatch = value.match(/\[.*?\]\((https?:\/\/[^\)]+)\)/);
                if (markdownMatch) {
                    return markdownMatch[1];
                }
                if (value.startsWith('http')) {
                    return value;
                }
                return null;
            }
            
            // WebPage format: { "@type": "WebPage", "url": "..." }
            if (value && typeof value === 'object' && value['@type'] === 'WebPage' && value.url) {
                return value.url;
            }
            
            // ImageObject format (for PDFs stored as images)
            if (value && typeof value === 'object' && value['@type'] === 'ImageObject' && value.url) {
                return value.url;
            }
            
            // Array of ImageObjects or WebPages
            if (Array.isArray(value) && value.length > 0) {
                const first = value[0];
                if (first && (first['@type'] === 'ImageObject' || first['@type'] === 'WebPage') && first.url) {
                    return first.url;
                }
                if (first && first.url) {
                    return first.url;
                }
            }
            
            // Direct object with url
            if (value && typeof value === 'object' && value.url) {
                return value.url;
            }
            
            return null;
        }

        // Cache helpers
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
        
        function getCachedData(key) {
            try {
                const cached = localStorage.getItem(`oitzer_${key}`);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < CACHE_DURATION) {
                        console.log(`Using cached data for ${key}`);
                        return data;
                    }
                }
            } catch (e) {
                console.log('Cache read error:', e);
            }
            return null;
        }
        
        function setCachedData(key, data) {
            try {
                localStorage.setItem(`oitzer_${key}`, JSON.stringify({
                    data,
                    timestamp: Date.now()
                }));
            } catch (e) {
                console.log('Cache write error:', e);
            }
        }

        // Generic function to fetch table info with pagination
        async function fetchTableInfo(tableId, infoObject, tableName) {
            try {
                // Check cache first
                const cacheKey = `table_${tableName}`;
                const cachedData = getCachedData(cacheKey);
                if (cachedData) {
                    Object.assign(infoObject, cachedData);
                    console.log(`Loaded ${tableName} info from cache: ${Object.keys(cachedData).length} items`);
                    return;
                }
                
                // Get columns first
                const columnsResponse = await fetch(`${WORKER_URL}docs/${DOC_ID}/tables/${tableId}/columns`);
                const columnsData = await columnsResponse.json();
                console.log(`${tableName} columns:`, columnsData.items?.map(c => ({ id: c.id, name: c.name, type: c.format?.type })));
                
                // Build column map by name (lowercase) and identify special columns
                const columnNames = {};
                let imageColId = null;
                let nameColId = null;
                let detailsColId = null; // Specific column for דעטאלן
                
                if (columnsData.items) {
                    columnsData.items.forEach((col, idx) => {
                        columnNames[col.id] = col.name || '';
                        const nameLower = (col.name || '').toLowerCase();
                        
                        // Find image column by type or name
                        if (col.format?.type === 'image' || nameLower.includes('בילד') || nameLower.includes('image') || nameLower.includes('תמונה') || nameLower.includes('picture') || nameLower.includes('קאווער') || nameLower.includes('cover')) {
                            imageColId = col.id;
                        }
                        
                        // Find details column specifically
                        if (nameLower.includes('דעטאלן') || nameLower === 'details' || nameLower === 'description') {
                            detailsColId = col.id;
                        }
                        
                        // First column is usually the name
                        if (idx === 0) {
                            nameColId = col.id;
                        }
                    });
                }
                
                console.log(`${tableName} - Image column: ${imageColId}, Name column: ${nameColId}, Details column: ${detailsColId}`);
                
                // Fetch all rows with pagination
                let allRows = [];
                let pageToken = null;
                
                do {
                    const url = `${WORKER_URL}docs/${DOC_ID}/tables/${tableId}/rows?valueFormat=rich${pageToken ? '&pageToken=' + pageToken : ''}`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.log(`${tableName} table not accessible:`, response.status);
                        return;
                    }
                    const data = await response.json();
                    allRows = allRows.concat(data.items || []);
                    pageToken = data.nextPageToken;
                } while (pageToken);
                
                console.log(`${tableName} - Fetched ${allRows.length} total rows`);
                
                allRows.forEach(item => {
                    const values = item.values;
                    
                    // Get name from first column or name column (this is the tag name / short name)
                    const nameValue = nameColId ? values[nameColId] : values[Object.keys(values)[0]];
                    const tagName = extractText(nameValue);
                    
                    // Use item.name as the full/display name (computed by Coda)
                    const name = item.name || tagName;
                    
                    if (name) {
                        const info = { allData: {}, rowId: item.id };
                        
                        // Always store tag name from first column (will compare with built full name later)
                        if (tagName) {
                            info.tagName = tagName;
                        }
                        
                        // Extract image from identified image column
                        if (imageColId && values[imageColId]) {
                            const imgUrl = extractImageUrl(values[imageColId]);
                            if (imgUrl) {
                                info.image = imgUrl;
                                info.cover = imgUrl; // Also set as cover for albums
                            }
                        }
                        
                        // Extract details/description from identified details column FIRST (priority)
                        if (detailsColId && values[detailsColId]) {
                            const detailsText = extractText(values[detailsColId]);
                            if (detailsText) {
                                info.description = detailsText;
                                console.log(`Set description from details column for ${name}: ${detailsText.substring(0, 50)}...`);
                            }
                        }
                        
                        // Process all columns for other data
                        Object.keys(values).forEach(colId => {
                            if (colId === nameColId || colId === imageColId) return;
                            
                            const value = values[colId];
                            const colName = columnNames[colId] || '';
                            const colNameLower = colName.toLowerCase();
                            
                            // Skip lookup/relation columns (they have complex objects)
                            if (Array.isArray(value) && value.length > 0 && value[0]['@type'] === 'StructuredValue') {
                                // Extract just the name from related records
                                const relatedNames = value.map(v => v.name).filter(Boolean);
                                if (relatedNames.length > 0) {
                                    info.allData[colName] = relatedNames.join(', ');
                                    if (colNameLower.includes('חצר')) {
                                        info.chatzer = relatedNames.join(', ');
                                    }
                                    // Store piyutim list for zmanim
                                    if (colNameLower === 'פיוטים' || colNameLower.includes('פיוט')) {
                                        info.piyutim = relatedNames;
                                    }
                                    // Store collections list for zmanim
                                    if (colNameLower === 'קאלעקשנס' || colNameLower.includes('קאלעקשן')) {
                                        info.collections = relatedNames;
                                    }
                                    // Store zmanim list for collections
                                    if (colNameLower === 'זמנים' || colNameLower.includes('זמן')) {
                                        info.zmanim = relatedNames;
                                    }
                                    // Mechaber birth/death years (lookup fields)
                                    if (colNameLower === 'שנת לידה') {
                                        info.birthYear = relatedNames.join(', ');
                                    }
                                    if (colNameLower === 'שנת פטירה') {
                                        info.deathYear = relatedNames.join(', ');
                                    }
                                }
                                return;
                            }
                            
                            // Handle single StructuredValue (non-array lookup)
                            if (value && typeof value === 'object' && value['@type'] === 'StructuredValue') {
                                const relatedName = value.name;
                                if (relatedName) {
                                    info.allData[colName] = relatedName;
                                    if (colNameLower === 'שנת לידה') {
                                        info.birthYear = relatedName;
                                    }
                                    if (colNameLower === 'שנת פטירה') {
                                        info.deathYear = relatedName;
                                    }
                                    if (colNameLower.includes('חצר')) {
                                        info.chatzer = relatedName;
                                    }
                                }
                                return;
                            }
                            
                            // Handle WebPage format for links
                            if (value && typeof value === 'object' && value['@type'] === 'WebPage') {
                                const url = value.url;
                                if (url) {
                                    info.allData[colName] = url;
                                    if (colNameLower === 'לינק / נאמבער' || colNameLower === 'לינק' || colNameLower === 'link') {
                                        info.link = url;
                                    }
                                    if (colNameLower === 'צו באקומען ביי' || colNameLower.includes('באקומען')) {
                                        info.whereToBuy = url;
                                    }
                                }
                                return;
                            }
                            
                            // Handle ImageObject format (for PDFs/files)
                            const imgObjUrl = extractUrl(value);
                            if (imgObjUrl && (colNameLower === 'פייל' || colNameLower === 'file' || colNameLower === 'בוקלעט' || colNameLower === 'booklet')) {
                                info.allData[colName] = imgObjUrl;
                                if (colNameLower === 'פייל' || colNameLower === 'file') {
                                    info.file = imgObjUrl;
                                }
                                if (colNameLower === 'בוקלעט' || colNameLower === 'booklet') {
                                    info.booklet = imgObjUrl;
                                }
                                return;
                            }
                            
                            // Handle select/array fields (like מקור)
                            let textValue = '';
                            if (Array.isArray(value)) {
                                textValue = value.map(v => {
                                    if (typeof v === 'string') return v.replace(/```/g, '').trim();
                                    if (v && v.name) return v.name;
                                    return '';
                                }).filter(Boolean).join(', ');
                            } else {
                                textValue = extractText(value);
                            }
                            if (textValue) {
                                info.allData[colName] = textValue;
                                
                                // Identify specific fields by column name
                                // Only set description if not already set from details column
                                if (!info.description && (colNameLower.includes('דעטאלן') || colNameLower.includes('אינפארמאציע') || colNameLower.includes('באשרייבונג') || colNameLower.includes('description') || colNameLower.includes('info') || colNameLower.includes('details'))) {
                                    info.description = textValue;
                                    console.log(`Found description for ${name}: ${textValue.substring(0, 50)}...`);
                                }
                                if (colNameLower.includes('מקום') || colNameLower.includes('ארט') || colNameLower.includes('location')) {
                                    info.location = textValue;
                                }
                                // Check for ID column (e.g. "ניגון ID", "מחבר ID", "ID", "#")
                                if (colNameLower === 'id' || colNameLower.endsWith(' id') || colNameLower.includes(' id') || colNameLower === '#' || colName.includes('ID')) {
                                    // Remove # prefix if present
                                    info.customId = textValue.replace(/^#/, '').trim();
                                }
                                if (colNameLower.includes('מקור') && !colNameLower.includes('מראה')) {
                                    info.makor = textValue;
                                }
                                if (colNameLower.includes('מראה מקום')) {
                                    info.marehMakom = textValue;
                                }
                                if (colNameLower.includes('פולע טעקסט') || colNameLower.includes('טעקסט')) {
                                    info.fullText = textValue;
                                }
                                if (colNameLower === 'זמן' || colNameLower === 'zman') {
                                    info.zman = textValue;
                                }
                                if (colNameLower.includes('מייסד') || colNameLower.includes('founder')) {
                                    info.founder = textValue;
                                }
                                if (colNameLower.includes('יאר') || colNameLower.includes('year')) {
                                    info.year = textValue;
                                }
                                if (colNameLower.includes('געבורט') || colNameLower.includes('birth') || colNameLower.includes('geboren')) {
                                    info.birthYear = textValue;
                                }
                                if (colNameLower.includes('פטירה') || colNameLower.includes('נפטר') || colNameLower.includes('death')) {
                                    info.deathYear = textValue;
                                }
                                if (colNameLower.includes('רבי') || colNameLower.includes('rebbe')) {
                                    info.currentRebbe = textValue;
                                }
                                if (colNameLower.includes('באוואוסט') || colNameLower.includes('famous') || colNameLower.includes('known')) {
                                    info.famous = textValue;
                                }
                                // Mechaber specific fields
                                if (colNameLower === 'טעג נאמען' || colNameLower.includes('טעג')) {
                                    info.tagName = textValue;
                                }
                                if (colNameLower === 'טיטל' || colNameLower === 'title') {
                                    info.title = textValue;
                                }
                                if (colNameLower === 'ערשטע נאמען' || colNameLower.includes('first name')) {
                                    info.firstName = textValue;
                                }
                                if (colNameLower === 'לעצטע נאמען' || colNameLower.includes('last name')) {
                                    info.lastName = textValue;
                                }
                                if (colNameLower === 'סופיקס' || colNameLower === 'suffix') {
                                    info.suffix = textValue;
                                }
                                if (colNameLower === 'יום לידה') {
                                    info.birthDay = textValue;
                                }
                                if (colNameLower === 'חודש לידה') {
                                    info.birthMonth = textValue;
                                }
                                if (colNameLower === 'שנת לידה') {
                                    info.birthYear = textValue;
                                }
                                if (colNameLower === 'יום פטירה') {
                                    info.deathDay = textValue;
                                }
                                if (colNameLower === 'חודש פטירה') {
                                    info.deathMonth = textValue;
                                }
                                if (colNameLower === 'שנת פטירה') {
                                    info.deathYear = textValue;
                                }
                                // Resources specific fields
                                if (colNameLower === 'לינק / נאמבער' || colNameLower === 'לינק' || colNameLower === 'link') {
                                    info.link = textValue;
                                }
                                if (colNameLower === 'סארט' || colNameLower === 'sort' || colNameLower === 'type') {
                                    info.sort = textValue;
                                }
                                if (colNameLower === 'הערות' || colNameLower === 'notes') {
                                    info.notes = textValue;
                                }
                                // Documents specific fields  
                                if (colNameLower === 'פייל' || colNameLower === 'file') {
                                    info.file = textValue;
                                }
                                if (colNameLower === 'סעריע' || colNameLower === 'serie' || colNameLower === 'series') {
                                    info.serie = textValue;
                                }
                                if (colNameLower === 'נאמען' || colNameLower === 'name') {
                                    info.docName = textValue;
                                }
                                // Albums specific fields
                                if (colNameLower === 'פראדוצירער' || colNameLower === 'producer') {
                                    info.producer = textValue;
                                }
                                if (colNameLower === 'בוקלעט' || colNameLower === 'booklet') {
                                    info.booklet = textValue;
                                }
                                if (colNameLower === 'צו באקומען ביי' || colNameLower.includes('באקומען')) {
                                    info.whereToBuy = textValue;
                                }
                                if (colNameLower === 'קאווער' || colNameLower === 'cover') {
                                    info.cover = textValue;
                                }
                                if (colNameLower === 'שנת' || colNameLower === 'year' || colNameLower === 'יאר') {
                                    info.year = textValue;
                                }
                                if (colNameLower === 'אלבום' || colNameLower === 'album') {
                                    info.albumName = textValue;
                                }
                            }
                        });
                        
                        // Don't set a fallback description - only use actual details/description fields
                        
                        // Trim the name to avoid whitespace issues
                        const trimmedName = name.trim();
                        infoObject[trimmedName] = info;
                    }
                });
                
                console.log(`Loaded ${tableName} info:`, Object.keys(infoObject).length, 'items');
                
                // Cache the results
                setCachedData(cacheKey, { ...infoObject });
                
                // Log sample with image
                const sampleWithImage = Object.entries(infoObject).find(([k, v]) => v.image);
                if (sampleWithImage) {
                    console.log(`Sample ${tableName} with image:`, sampleWithImage[0], sampleWithImage[1]);
                }
                
                // Log sample with description
                const sampleWithDesc = Object.entries(infoObject).find(([k, v]) => v.description);
                if (sampleWithDesc) {
                    console.log(`Sample ${tableName} with description:`, sampleWithDesc[0], 'desc:', sampleWithDesc[1].description?.substring(0, 100));
                }
                
            } catch (error) {
                console.log(`Could not fetch ${tableName} info:`, error.message);
            }
        }

        // Fetch functions for each table
        async function fetchChatzerosInfo() {
            await fetchTableInfo(CHATZEROS_TABLE_ID, chatzerosInfo, 'Chatzeros');
        }

        async function fetchMechabrimInfo() {
            await fetchTableInfo(MECHABRIM_TABLE_ID, mechabrimInfo, 'Mechabrim');
        }
        
        async function fetchVerterInfo() {
            await fetchTableInfo(VERTER_TABLE_ID, verterInfo, 'Verter');
        }
        
        async function fetchZmanimInfo() {
            await fetchTableInfo(ZMANIM_TABLE_ID, zmaninInfo, 'Zmanim');
        }
        
        async function fetchPiyutimInfo() {
            await fetchTableInfo(PIYUTIM_TABLE_ID, piyutimInfo, 'Piyutim');
        }
        
        async function fetchCollectionsInfo() {
            await fetchTableInfo(COLLECTIONS_TABLE_ID, collectionsInfo, 'Collections');
        }
        
        async function fetchResourcesInfo() {
            await fetchTableInfo(RESOURCES_TABLE_ID, resourcesInfo, 'Resources');
        }
        
        async function fetchDocumentsInfo() {
            await fetchTableInfo(DOCUMENTS_TABLE_ID, documentsInfo, 'Documents');
        }
        
        async function fetchAlbumsInfo() {
            await fetchTableInfo(ALBUMS_TABLE_ID, albumsInfo, 'Albums');
        }

       // Fetch statistics from STATS table (only row 1)
        async function fetchStatistics() {
            try {
                // Add cache-busting timestamp to ensure fresh stats on every page load
                const url = `${WORKER_URL}docs/${DOC_ID}/tables/${STATS_TABLE_ID}/rows?valueFormat=simple&limit=1&_t=${Date.now()}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    const row = data.items[0];
                    const values = row.values;

                    // Extract statistics from the row (valueFormat=simple returns plain numbers)
                    cachedStats.niggunim = parseInt(values[STATS_COLS.niggunim]) || 0;
                    cachedStats.mechabrim = parseInt(values[STATS_COLS.mechabrim]) || 0;
                    cachedStats.verter = parseInt(values[STATS_COLS.verter]) || 0;
                    cachedStats.chatzeros = parseInt(values[STATS_COLS.chatzeros]) || 0;
                    cachedStats.zmanim = parseInt(values[STATS_COLS.zmanim]) || 0;
                    cachedStats.piyutim = parseInt(values[STATS_COLS.piyutim]) || 0;
                    cachedStats.collections = parseInt(values[STATS_COLS.collections]) || 0;
                }
            } catch (error) {
                console.log('Could not fetch statistics:', error.message);
                // If fetching fails, we'll fall back to calculated stats when needed
            }
        }


        // Fetch songs from API - OPTIMIZED with lazy loading
        async function fetchSongs() {
            try {
                // Render home page immediately (before data loads)
                if (!window.location.hash || window.location.hash === '#/home' || window.location.hash === '#/') {
                    updateURL();
                    renderCurrentPage();
                }
                
                // Fetch all the category info
                const infoPromises = [
                    fetchChatzerosInfo(),
                    fetchMechabrimInfo(),
                    fetchVerterInfo(),
                    fetchZmanimInfo(),
                    fetchPiyutimInfo(),
                    fetchCollectionsInfo(),
                    fetchResourcesInfo(),
                    fetchDocumentsInfo(),
                    fetchAlbumsInfo()
                ];
                
                // Wait for category info to load
                await Promise.all(infoPromises);
                console.log('Category info loaded:',
                    'Chatzeros:', Object.keys(chatzerosInfo).length,
                    'Mechabrim:', Object.keys(mechabrimInfo).length,
                    'Verter:', Object.keys(verterInfo).length,
                    'Zmanim:', Object.keys(zmaninInfo).length,
                    'Piyutim:', Object.keys(piyutimInfo).length,
                    'Collections:', Object.keys(collectionsInfo).length
                );
                
                // Navigate based on URL (if not home, now we have the data)
                if (window.location.hash && window.location.hash !== '#/home' && window.location.hash !== '#/') {
                    handleURLChange();
                } else {
                    // Re-render home with actual data
                    renderCurrentPage();
                }
                
                // Now fetch songs in background
                fetchSongsInBackground();

            } catch (error) {
                console.error('Error:', error);
                const spinner = document.getElementById('loadingSpinner');
                if (spinner) {
                    spinner.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">❌</div>
                            <p>גרייז: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        // Fetch songs in background with pagination
        async function fetchSongsInBackground() {
            try {
                // Check cache first
                const cachedSongs = getCachedData('songs');
                if (cachedSongs && cachedSongs.length > 0) {
                    console.log(`Using cached songs: ${cachedSongs.length} items`);
                    allSongs = cachedSongs;
                    applyFilters();
                    buildCategoryIndices();
                    updateNavCounts();
                    if (currentPageView === 'songs') {
                        renderCurrentPage();
                    }
                    return;
                }
                
                let allRows = [];
                let pageToken = null;
                
                do {
                    const url = `${WORKER_URL}docs/${DOC_ID}/tables/${TABLE_ID}/rows?valueFormat=rich${pageToken ? '&pageToken=' + pageToken : ''}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    allRows = allRows.concat(data.items || []);
                    pageToken = data.nextPageToken;
                    
                    // Process songs so far and update counts
                    processSongsData(allRows);
                    
                    console.log(`Loaded ${allRows.length} songs...`);
                } while (pageToken);
                
                console.log(`Finished loading ${allRows.length} total songs`);
                
                // Cache the processed songs
                setCachedData('songs', allSongs);
                
                // Final re-render if on songs page
                if (currentPageView === 'songs') {
                    renderCurrentPage();
                }
                
            } catch (error) {
                console.error('Error loading songs:', error);
            }
        }
        
        // Process songs data array
        function processSongsData(rows) {
            allSongs = rows.map((item, index) => {
                    const values = item.values;
                    
                    // Find customId from any column ending with "ID"
                    let customId = null;
                    for (const [colId, value] of Object.entries(values)) {
                        const textVal = extractText(value);
                        if (textVal && /^#?\d+$/.test(textVal.trim())) {
                            // This looks like an ID (e.g. "#781" or "781")
                            customId = textVal.replace(/^#/, '').trim();
                            break;
                        }
                    }
                    
                    // Helper to check file type
                    const isAudioFile = (filename) => {
                        if (!filename) return false;
                        const ext = filename.toLowerCase().split('.').pop();
                        return ['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac', 'wma'].includes(ext);
                    };
                    
                    const isImageFile = (filename) => {
                        if (!filename) return false;
                        const ext = filename.toLowerCase().split('.').pop();
                        return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(ext);
                    };
                    
                    const isPdfFile = (filename) => {
                        if (!filename) return false;
                        const ext = filename.toLowerCase().split('.').pop();
                        return ext === 'pdf';
                    };
                    
                    // Extract main audio from File column (c-XmTlDf3xfw)
                    let mainAudioUrl = null;
                    const fileAttachment = values['c-XmTlDf3xfw'];
                    if (Array.isArray(fileAttachment) && fileAttachment.length > 0 && fileAttachment[0].url) {
                        if (isAudioFile(fileAttachment[0].name)) {
                            mainAudioUrl = fileAttachment[0].url;
                        }
                    }
                    
                    // Extract additional recordings, images, and PDFs
                    const recordings = [];
                    const images = [];
                    const pdfs = [];
                    
                    // Process File attachment (c-XmTlDf3xfw) - main attachment
                    if (Array.isArray(fileAttachment) && fileAttachment.length > 0 && fileAttachment[0].url) {
                        const file = fileAttachment[0];
                        if (isAudioFile(file.name)) {
                            recordings.push({
                                url: file.url,
                                name: file.name || 'רעקארדינג',
                                details: ''
                            });
                        } else if (isImageFile(file.name)) {
                            images.push({ url: file.url, name: file.name, details: '' });
                        } else if (isPdfFile(file.name)) {
                            pdfs.push({ url: file.url, name: file.name, details: '' });
                        }
                    }
                    
                    // Process attachment 2 (c-oqB3imNNfk with c-_TOU9FXYYn details)
                    const attachment2 = values['c-oqB3imNNfk'];
                    if (Array.isArray(attachment2) && attachment2.length > 0 && attachment2[0].url) {
                        const file = attachment2[0];
                        const details2 = extractText(values['c-_TOU9FXYYn']) || '';
                        if (isAudioFile(file.name)) {
                            recordings.push({
                                url: file.url,
                                name: file.name || 'רעקארדינג 2',
                                details: details2
                            });
                        } else if (isImageFile(file.name)) {
                            images.push({ url: file.url, name: file.name, details: details2 });
                        } else if (isPdfFile(file.name)) {
                            pdfs.push({ url: file.url, name: file.name, details: details2 });
                        }
                    }
                    
                    // Process attachment 3 (c-oGF6C78GZl with c-dr-m1GnYty details)
                    const attachment3 = values['c-oGF6C78GZl'];
                    if (Array.isArray(attachment3) && attachment3.length > 0 && attachment3[0].url) {
                        const file = attachment3[0];
                        const details3 = extractText(values['c-dr-m1GnYty']) || '';
                        if (isAudioFile(file.name)) {
                            recordings.push({
                                url: file.url,
                                name: file.name || 'רעקארדינג 3',
                                details: details3
                            });
                        } else if (isImageFile(file.name)) {
                            images.push({ url: file.url, name: file.name, details: details3 });
                        } else if (isPdfFile(file.name)) {
                            pdfs.push({ url: file.url, name: file.name, details: details3 });
                        }
                    }
                    
                    // Process attachment 4 (c-pf9zW3wypK with c-pbtldr4CXD details)
                    const attachment4 = values['c-pf9zW3wypK'];
                    if (Array.isArray(attachment4) && attachment4.length > 0 && attachment4[0].url) {
                        const file = attachment4[0];
                        const details4 = extractText(values['c-pbtldr4CXD']) || '';
                        if (isAudioFile(file.name)) {
                            recordings.push({
                                url: file.url,
                                name: file.name || 'רעקארדינג 4',
                                details: details4
                            });
                        } else if (isImageFile(file.name)) {
                            images.push({ url: file.url, name: file.name, details: details4 });
                        } else if (isPdfFile(file.name)) {
                            pdfs.push({ url: file.url, name: file.name, details: details4 });
                        }
                    }
                    
                    // Process attachment 6 (c-_q44nnca44 with c-l9TdqiWUNg details)
                    const attachment6 = values['c-_q44nnca44'];
                    if (Array.isArray(attachment6) && attachment6.length > 0 && attachment6[0].url) {
                        const file = attachment6[0];
                        const details6 = extractText(values['c-l9TdqiWUNg']) || '';
                        if (isAudioFile(file.name)) {
                            recordings.push({
                                url: file.url,
                                name: file.name || 'רעקארדינג 6',
                                details: details6
                            });
                        } else if (isImageFile(file.name)) {
                            images.push({ url: file.url, name: file.name, details: details6 });
                        } else if (isPdfFile(file.name)) {
                            pdfs.push({ url: file.url, name: file.name, details: details6 });
                        }
                    }

                    // Find personality field (פערזענליכקייט) - column c-mxsPhpZeVM
                    const songName = extractText(values['c-6qqDF7NYmv']) || '';
                    
                    // Extract personality from the known column
                    const personalityNames = extractText(values['c-6E02UJxxZW']) || ''; // פערזענליכקייט
                    
                    // Also try the specific ID column if customId not found
                    if (!customId) {
                        const customIdVal = extractText(values['c-DhElYWayZ-']);
                        if (customIdVal) {
                            customId = customIdVal.replace(/^#/, '').trim();
                        }
                    }
                    
                    return {
                        rowId: item.id,
                        customId: customId,
                        name: songName || `ליד ${index + 1}`,
                        author: extractText(values['c-ujrTHeCJGo']),
                        category: extractText(values['c-u0H9G6FHoJ']), // חצר
                        verter: extractText(values['c-KAWfVfB4jq']),
                        mechaber: extractText(values['c-ujrTHeCJGo']),
                        personality: personalityNames, // פערזענליכקייט
                        scale: extractText(values['c-wQZrHPVWog']),
                        ritem: extractText(values['c-OmWEZXO7Ys']),
                        gezungen: extractText(values['c-kiHIam57Z0']),
                        collections: extractText(values['c-pCBFiGU8ex']),
                        zugeleigt: extractText(values['c-iOlvD8H0n3']),
                        pasigOif: extractText(values['c-mTtYp3FK9U']), // פאסיג אויף / זמנים
                        maure: extractText(values['c-J3q8mQIXBh']), // מאורע
                        info: extractText(values['c-oz8SrLoex3']),
                        siman: extractText(values['c-jSVbHezFAS']),
                        notn: extractText(values['c-hodtA6zYsy']),
                        documents: extractText(values['c-nF5sRFoMkJ']), // דאקומענטן
                        albums: extractText(values['c-j8dujLHcnT']), // אלבומס
                        resources: extractText(values['c-KBb2Bgi6nM']), // רעסורסן
                        audioUrl: mainAudioUrl,
                        recordings: recordings,
                        images: images,
                        pdfs: pdfs
                    };
                });

                allSongs.sort((a, b) => a.name.localeCompare(b.name, 'he'));
                
                // Apply initial filters (including audioOnlyFilter default)
                applyFilters();

                // Build category indices
                buildCategoryIndices();
                
                // Update nav counts
                updateNavCounts();
        }

        // Build category indices
        function buildCategoryIndices() {
            // Reset
            categories = {
                chatzeros: {},
                mechabrim: {},
                verter: {},
                zmanim: {},
                collections: {},
                gezungen: {},
                scale: {},
                ritem: {}
            };

            allSongs.forEach((song, idx) => {
                // חצרות
                if (song.category) {
                    song.category.split(',').forEach(c => {
                        const key = c.trim();
                        if (key) {
                            if (!categories.chatzeros[key]) categories.chatzeros[key] = [];
                            categories.chatzeros[key].push(idx);
                        }
                    });
                }

                // מחברים
                if (song.mechaber) {
                    song.mechaber.split(',').forEach(m => {
                        const key = m.trim();
                        if (key) {
                            if (!categories.mechabrim[key]) categories.mechabrim[key] = [];
                            categories.mechabrim[key].push(idx);
                        }
                    });
                }

                // ווערטער
                if (song.verter) {
                    song.verter.split(',').forEach(v => {
                        const key = v.trim();
                        if (key) {
                            if (!categories.verter[key]) categories.verter[key] = [];
                            categories.verter[key].push(idx);
                        }
                    });
                }

                // זמנים/פיוטים (from פאסיג אויף)
                if (song.pasigOif) {
                    song.pasigOif.split(',').forEach(z => {
                        const key = z.trim();
                        if (key) {
                            if (!categories.zmanim[key]) categories.zmanim[key] = [];
                            categories.zmanim[key].push(idx);
                        }
                    });
                }

                // קאלעקשאנס
                if (song.collections) {
                    song.collections.split(',').forEach(col => {
                        const key = col.trim();
                        if (key) {
                            if (!categories.collections[key]) categories.collections[key] = [];
                            categories.collections[key].push(idx);
                        }
                    });
                }

                // געזונגען אויף
                if (song.gezungen) {
                    song.gezungen.split(',').forEach(g => {
                        const key = g.trim();
                        if (key) {
                            if (!categories.gezungen[key]) categories.gezungen[key] = [];
                            categories.gezungen[key].push(idx);
                        }
                    });
                }

                // סקעיל
                if (song.scale) {
                    song.scale.split(',').forEach(s => {
                        const key = s.trim();
                        if (key) {
                            if (!categories.scale[key]) categories.scale[key] = [];
                            categories.scale[key].push(idx);
                        }
                    });
                }

                // ריטעם
                if (song.ritem) {
                    song.ritem.split(',').forEach(r => {
                        const key = r.trim();
                        if (key) {
                            if (!categories.ritem[key]) categories.ritem[key] = [];
                            categories.ritem[key].push(idx);
                        }
                    });
                }
            });
        }

        // Update navigation counts
        function updateNavCounts() {
            // Nav counts removed - function kept for compatibility
        }

        // Navigation
        function navigateTo(page) {
            hideAllDropdowns();
            currentPageView = page;
            currentPage = 1;
            currentDetailView = null; // Clear any detail view

            updateURL();
            renderCurrentPage();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Scroll to section on home page
        function scrollToSection(sectionId) {
            hideAllDropdowns();
            navigateTo('home');
            setTimeout(() => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 150);
        }

        // Open add modal (placeholder for future)
        function openAddModal() {
            hideAllDropdowns();
            alert('די אפציע צו צולייגן א ניגון קומט באלד!');
        }
        
        // Hide all dropdowns
        function hideAllDropdowns() {
            document.querySelectorAll('.nav-dropdown-content').forEach(d => {
                d.classList.add('hiding');
            });
            setTimeout(() => {
                document.querySelectorAll('.nav-dropdown-content').forEach(d => {
                    d.classList.remove('hiding');
                });
            }, 300);
        }
        
        // Close dropdowns when clicking on items
        document.addEventListener('click', function(e) {
            if (e.target.closest('.nav-dropdown-item')) {
                hideAllDropdowns();
            }
        });

        // Render current page
        function renderCurrentPage() {
            // Check if we're in a detail view
            if (currentDetailView) {
                renderDetailPage();
                return;
            }
            
            const content = document.getElementById('mainContent');
            
            switch(currentPageView) {
                case 'home':
                    renderHomePage(content);
                    break;
                case 'search':
                    renderSearchResultsPage(content);
                    break;
                case 'songs':
                    renderAllSongsPage(content);
                    break;
                case 'chatzeros':
                    renderCategoryPage(content, 'chatzeros', 'חצרות', '', 'אלע חסידישע חצרות און זייערע ניגונים');
                    break;
                case 'mechabrim':
                    renderCategoryPage(content, 'mechabrim', 'מחברים', '', 'די מחברים פון די ניגונים');
                    break;
                case 'verter':
                    renderCategoryPage(content, 'verter', 'ווערטער', '', 'ניגונים לויט די ווערטער');
                    break;
                case 'zmanim':
                    renderZmanimPage(content);
                    break;
                case 'music':
                    renderMusicPage(content);
                    break;
                case 'collections':
                    renderCollectionsPage(content);
                    break;
                case 'resources':
                    renderResourcesPage(content);
                    break;
                case 'documents':
                    renderDocumentsPage(content);
                    break;
                case 'albums':
                    renderAlbumsPage(content);
                    break;
            }
        }

        // Render home page
        function renderHomePage(container) {
            // Use ONLY the statistics from STATS table - never calculate from loaded data
            // The STATS table contains Coda formulas that calculate the current accurate counts
            // Show loading state (...) only if stats haven't loaded yet
            const totalSongs = cachedStats.niggunim > 0 ? cachedStats.niggunim : '<span class="stat-loading">...</span>';
            const totalChatzeros = cachedStats.chatzeros > 0 ? cachedStats.chatzeros : '<span class="stat-loading">...</span>';
            const totalMechabrim = cachedStats.mechabrim > 0 ? cachedStats.mechabrim : '<span class="stat-loading">...</span>';
            const totalVerter = cachedStats.verter > 0 ? cachedStats.verter : '<span class="stat-loading">...</span>';
            const totalZmanim = cachedStats.zmanim > 0 ? cachedStats.zmanim : '<span class="stat-loading">...</span>';
            const totalCollections = cachedStats.collections > 0 ? cachedStats.collections : '<span class="stat-loading">...</span>';
            const totalPiyutim = cachedStats.piyutim > 0 ? cachedStats.piyutim : '<span class="stat-loading">...</span>';
            
            
            container.innerHTML = `
                <div class="home-page">
                    <!-- Hero Banner -->
                    <div class="home-hero">
                        <div class="home-hero-content">
                            <div class="home-logo"></div>
                            <h1 class="home-title">אוצר הניגונים</h1>
                            <p class="home-subtitle">די גרעסטע זאמלונג פון חסידישע ניגונים</p>
                        </div>
                    </div>
                    
                    <!-- Search Box -->
                    <div class="home-search-section">
                        <div class="home-search-box">
                            <input type="text" 
                                   id="homeSearchInput" 
                                   class="home-search-input" 
                                   placeholder="זוך א ניגון, מחבר, חצר..."
                                   onkeyup="handleHomeSearch(event)">
                            <button class="home-search-btn" onclick="executeHomeSearch()">זוכן</button>
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div class="home-stats">
                        <div class="home-stat-card" onclick="navigateTo('songs')">
                            <div class="home-stat-icon"></div>
                            <div class="home-stat-number">${totalSongs}</div>
                            <div class="home-stat-label">ניגונים</div>
                        </div>
                        <div class="home-stat-card" onclick="navigateTo('chatzeros')">
                            <div class="home-stat-icon"></div>
                            <div class="home-stat-number">${totalChatzeros}</div>
                            <div class="home-stat-label">חצרות</div>
                        </div>
                        <div class="home-stat-card" onclick="navigateTo('mechabrim')">
                            <div class="home-stat-icon"></div>
                            <div class="home-stat-number">${totalMechabrim}</div>
                            <div class="home-stat-label">מחברים</div>
                        </div>
                        <div class="home-stat-card" onclick="navigateTo('verter')">
                            <div class="home-stat-icon"></div>
                            <div class="home-stat-number">${totalVerter}</div>
                            <div class="home-stat-label">ווערטער</div>
                        </div>
                        <div class="home-stat-card" onclick="navigateTo('zmanim')">
                            <div class="home-stat-icon"></div>
                            <div class="home-stat-number">${totalZmanim}</div>
                            <div class="home-stat-label">זמנים</div>
                        </div>
                        <div class="home-stat-card" onclick="navigateTo('collections')">
                            <div class="home-stat-icon"></div>
                            <div class="home-stat-number">${totalCollections}</div>
                            <div class="home-stat-label">קאלעקשאנס</div>
                        </div>
                    </div>
                    
                    <!-- Quick Links -->
                    <div class="home-quick-links">
                        <h2 class="home-section-title">בלעטער אין אוצר</h2>
                        <div class="home-links-grid">
                            <div class="home-link-card" onclick="navigateTo('songs')">
                                <div class="home-link-icon"></div>
                                <div class="home-link-text">
                                    <div class="home-link-title">אלע ניגונים</div>
                                    <div class="home-link-desc">בלעטער דורך אלע ${totalSongs} ניגונים</div>
                                </div>
                            </div>
                            <div class="home-link-card" onclick="navigateTo('chatzeros')">
                                <div class="home-link-icon"></div>
                                <div class="home-link-text">
                                    <div class="home-link-title">חצרות</div>
                                    <div class="home-link-desc">${totalChatzeros} חסידישע חצרות</div>
                                </div>
                            </div>
                            <div class="home-link-card" onclick="navigateTo('mechabrim')">
                                <div class="home-link-icon"></div>
                                <div class="home-link-text">
                                    <div class="home-link-title">מחברים</div>
                                    <div class="home-link-desc">${totalMechabrim} מחברי ניגונים</div>
                                </div>
                            </div>
                            <div class="home-link-card" onclick="navigateTo('verter')">
                                <div class="home-link-icon"></div>
                                <div class="home-link-text">
                                    <div class="home-link-title">ווערטער</div>
                                    <div class="home-link-desc">${totalVerter} ניגונים מיט ווערטער</div>
                                </div>
                            </div>
                            <div class="home-link-card" onclick="navigateTo('zmanim')">
                                <div class="home-link-icon"></div>
                                <div class="home-link-text">
                                    <div class="home-link-title">זמנים</div>
                                    <div class="home-link-desc">${totalZmanim} זמנים, ${totalPiyutim} פיוטים</div>
                                </div>
                            </div>
                            <div class="home-link-card" onclick="navigateTo('collections')">
                                <div class="home-link-icon"></div>
                                <div class="home-link-text">
                                    <div class="home-link-title">קאלעקשאנס</div>
                                    <div class="home-link-desc">${totalCollections} קאלעקשאנס</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- About Section -->
                    <div class="home-section" id="about">
                        <h2 class="home-section-title">אונזער ציל</h2>
                        <div class="home-section-content">
                            <p>אוצר הניגונים איז א פראיעקט וואס זאמלט און באוואַרנט חסידישע ניגונים פון אלע חצרות און דורות. אונזער ציל איז צו מאכן די ניגונים צוטריטלעך פאר אלעמען, און צו פאַרזיכערן אז די ניגונים זאלן ווייטער געזונגען ווערן לדור ודור.</p>
                            <p>מיר גלייבן אז א ניגון איז מער ווי נאר מוזיק - עס איז א וועג צו דערהויבנקייט, א בריק צווישן דעם גשמיות'דיגן און רוחניות'דיגן, און א ירושה פון אונזערע הייליגע אבות.</p>
                        </div>
                    </div>
                    
                    <!-- Instructions Section -->
                    <div class="home-section" id="instructions">
                        <h2 class="home-section-title">אנווייזונגען</h2>
                        <div class="home-section-content">
                            <div class="instructions-grid">
                                <div class="instruction-item">
                                    <div class="instruction-number">1</div>
                                    <div class="instruction-text">
                                        <strong>זוכן</strong> - נוץ די זוך באקס צו געפינען א ניגון לויט נאמען, מחבר, אדער חצר
                                    </div>
                                </div>
                                <div class="instruction-item">
                                    <div class="instruction-number">2</div>
                                    <div class="instruction-text">
                                        <strong>בלעטערן</strong> - גיי דורך די קאטעגאריעס: חצרות, מחברים, זמנים, קאלעקשאנס
                                    </div>
                                </div>
                                <div class="instruction-item">
                                    <div class="instruction-number">3</div>
                                    <div class="instruction-text">
                                        <strong>שפילן</strong> - קליק אויף א ניגון צו הערן, נוץ די פלעיער אונטן
                                    </div>
                                </div>
                                <div class="instruction-item">
                                    <div class="instruction-number">4</div>
                                    <div class="instruction-text">
                                        <strong>דעטאלן</strong> - קליק אויף "דעטאלן" צו זען מער אינפארמאציע וועגן דעם ניגון
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Section -->
                    <div class="home-section" id="stats">
                        <h2 class="home-section-title">סטאטיסטיקס</h2>
                        <div class="home-section-content">
                            <div class="stats-detailed">
                                <div class="stat-row">
                                    <span class="stat-label-lg">ניגונים אין דאטאבאנק:</span>
                                    <span class="stat-value-lg">${totalSongs}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label-lg">חצרות:</span>
                                    <span class="stat-value-lg">${totalChatzeros}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label-lg">מחברים:</span>
                                    <span class="stat-value-lg">${totalMechabrim}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label-lg">ניגונים מיט ווערטער:</span>
                                    <span class="stat-value-lg">${totalVerter}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label-lg">זמנים און מועדים:</span>
                                    <span class="stat-value-lg">${totalZmanim}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label-lg">קאלעקשאנס:</span>
                                    <span class="stat-value-lg">${totalCollections}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label-lg">אלבומס:</span>
                                    <span class="stat-value-lg">${Object.keys(albumsInfo).length}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label-lg">דאקומענטן:</span>
                                    <span class="stat-value-lg">${Object.keys(documentsInfo).length}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Credits Section -->
                    <div class="home-section" id="credits">
                        <h2 class="home-section-title">קרעדיטס</h2>
                        <div class="home-section-content">
                            <p>דער פראיעקט איז געבויט געווארן דורך פרייוויליגע וואס האבן א ליבשאפט צו חסידישע ניגונים.</p>
                            <div class="credits-list">
                                <div class="credit-item">
                                    <strong>דאטאבאנק:</strong> געזאמלט און ארגאניזירט מיט גרויס מי
                                </div>
                                <div class="credit-item">
                                    <strong>טעכנאלאגיע:</strong> געבויט מיט מאדערנע וועב טעכנאלאגיעס
                                </div>
                                <div class="credit-item">
                                    <strong>אוידיא:</strong> רעקארדירונגען פון פארשידענע מקורות
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Thanks Section -->
                    <div class="home-section" id="thanks">
                        <h2 class="home-section-title">התודה והברכה</h2>
                        <div class="home-section-content">
                            <p>א גרויסן יישר כח צו אלע וואס האבן ביישטייערט צו דעם פראיעקט:</p>
                            <ul class="thanks-list">
                                <li>די וואס האבן געטיילט ניגונים און רעקארדירונגען</li>
                                <li>די וואס האבן געהאלפן מיט אינפארמאציע וועגן די ניגונים</li>
                                <li>די וואס האבן געגעבן פידבעק און פארשלאגן</li>
                                <li>אלע וואס נוצן און פארשפרייטן דעם אוצר</li>
                            </ul>
                            <p class="blessing">יהי רצון שנזכה להמשיך לשמוע ולשיר ניגונים עד ביאת גואל צדק במהרה בימינו אמן.</p>
                        </div>
                    </div>
                    
                    <!-- Terms Section -->
                    <div class="home-section" id="terms">
                        <h2 class="home-section-title">Terms of Use</h2>
                        <div class="home-section-content terms-content">
                            <p>די ניגונים און רעקארדירונגען אויף דער וועבזייטל זענען געמאכט צוטריטלעך פאר פערזענלעכע און בילדונגס צוועקן.</p>
                            <ul>
                                <li>מען טאר נישט נוצן די רעקארדירונגען פאר קאמערציעלע צוועקן אן ערלויבעניש</li>
                                <li>מען זאל רעספעקטירן די רעכט פון די מחברים און פארפירער</li>
                                <li>ביי פארשפרייטן זאל מען דערמאנען דעם מקור</li>
                            </ul>
                            <p>פאר פראגעס אדער באמערקונגען, קען מען זיך ווענדן דורך די קאנטאקט אינפארמאציע.</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Handle home search
        function handleHomeSearch(event) {
            if (event.key === 'Enter') {
                executeHomeSearch();
            }
        }
        
        function executeHomeSearch() {
            const query = document.getElementById('homeSearchInput').value.trim();
            if (query) {
                searchQuery = query;
                filterSongs();
                navigateTo('songs');
                // Set the search input in songs page
                setTimeout(() => {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.value = query;
                    }
                }, 100);
            }
        }

        // Render all songs page
        function renderAllSongsPage(container) {
            // Show loading if songs not yet loaded
            if (allSongs.length === 0) {
                container.innerHTML = `
                    <div class="page-theme-nigun">
                        <div class="page-title">
                            <div class="page-title-bar">ניגונים</div>
                            <div class="page-title-content">
                                <div class="subtitle">לאדינג ניגונים...</div>
                            </div>
                        </div>
                        <div class="loading-songs-message">
                            <div class="loading-spinner"></div>
                            <p>ניגונים ווערן געלאדן אין באקגראונד...</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const totalPages = Math.ceil(filteredSongs.length / songsPerPage);
            const startIdx = (currentPage - 1) * songsPerPage;
            const endIdx = Math.min(startIdx + songsPerPage, filteredSongs.length);
            const pageSongs = filteredSongs.slice(startIdx, endIdx);

            container.innerHTML = `
                <div class="page-theme-nigun">
                    <div class="page-title">
                        <div class="page-title-bar">ניגונים</div>
                        <div class="page-title-content">
                            <div class="subtitle">${filteredSongs.length} ניגונים</div>
                        </div>
                    </div>

                    <div class="songs-page-layout">
                        <div class="songs-main-content">
                            <div class="songs-card">
                                <div class="all-songs-grid">
                                    ${(() => {
                                        const playlistIndices = filteredSongs.map(song => allSongs.indexOf(song));
                                        return pageSongs.map((song, idx) => {
                                            const globalIdx = allSongs.indexOf(song);
                                            return renderSongItem(song, globalIdx, startIdx + idx + 1, playlistIndices);
                                        }).join('');
                                    })()}
                                </div>

                                <div class="pagination">
                                    <button class="page-btn" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>«</button>
                                    <button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹</button>
                                    <span class="page-info">בלאט ${currentPage} פון ${totalPages}</span>
                                    <button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>›</button>
                                    <button class="page-btn" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>»</button>
                                </div>
                            </div>
                        </div>

                        <div class="songs-sidebar">
                            <div class="sidebar-search-box">
                                <input type="text" 
                                       id="songsSearchInput" 
                                       class="sidebar-search-input" 
                                       placeholder="זוכט א ניגון..."
                                       value="${searchQuery || ''}"
                                       onkeypress="if(event.key==='Enter')handleSongsSearch(this.value)">
                                ${searchQuery ? '<button class="sidebar-search-clear" onclick="clearSearch()">×</button>' : ''}
                                <button class="sidebar-search-btn" onclick="handleSongsSearch(document.getElementById('songsSearchInput').value)">🔍</button>
                            </div>

                            <label class="sidebar-audio-toggle">
                                <input type="checkbox" ${audioOnlyFilter ? 'checked' : ''} onchange="toggleAudioOnly()">
                                <span>נאר ניגונים מיט אודיאו 🎵</span>
                            </label>

                            <div class="sidebar-section">
                                <div class="sidebar-section-title">פילטערס</div>
                            </div>

                            ${renderSidebarFilter('collection', 'קאלעקשאנס:', categories.collections)}
                            ${renderSidebarFilter('chatzer', 'חצר:', categories.chatzeros)}
                            ${renderSidebarFilter('mechaber', 'מחבר:', categories.mechabrim)}
                            ${renderSidebarFilter('verter', 'ווערטער:', categories.verter)}
                            ${renderSidebarFilter('gezungen', 'געזינגען אויף:', categories.gezungen)}
                            ${renderSidebarFilter('ritem', 'ריטעם:', categories.ritem)}
                            ${renderSidebarFilter('scale', 'סקעיל:', categories.scale)}

                            <div class="active-filters" id="activeFilterTags"></div>
                        </div>
                    </div>
                </div>
            `;

            renderActiveFilterTags();
        }

        // Render sidebar filter dropdown
        function renderSidebarFilter(key, label, data) {
            if (!data) data = {};
            const options = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));
            const selectedCount = activeFilters[key]?.length || 0;
            const selectedValue = selectedCount > 0 ? `(${selectedCount})` : '(אלע)';
            
            return `
                <div class="sidebar-filter" data-filter="${key}">
                    <div class="sidebar-filter-dropdown">
                        <button class="sidebar-filter-btn ${selectedCount > 0 ? 'active' : ''}" onclick="toggleSidebarDropdown('${key}')">
                            <span class="sidebar-filter-label">${label}</span>
                            <span class="sidebar-filter-value">${selectedValue}</span>
                            <span class="dropdown-arrow">▼</span>
                        </button>
                        <div class="sidebar-dropdown-content" id="sidebar-dropdown-${key}">
                            <div class="dropdown-search-box">
                                <input type="text" 
                                       class="dropdown-search-input" 
                                       placeholder="זוך..."
                                       onclick="event.stopPropagation()"
                                       oninput="filterDropdownOptions('${key}', this.value)">
                            </div>
                            <div class="dropdown-options" id="dropdown-options-${key}">
                                ${options.map(opt => {
                                    const escapedOpt = opt.replace(/'/g, "\\'");
                                    return `
                                    <label class="sidebar-filter-option" data-value="${opt.toLowerCase()}" onclick="event.stopPropagation()">
                                        <input type="checkbox" 
                                            value="${opt.replace(/"/g, '&quot;')}" 
                                            ${activeFilters[key]?.includes(opt) ? 'checked' : ''}
                                            onchange="handleFilterChange('${key}', '${escapedOpt}', this.checked)">
                                        ${opt}
                                    </label>
                                `}).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Filter dropdown options based on search
        function filterDropdownOptions(key, searchTerm) {
            const container = document.getElementById('dropdown-options-' + key);
            const options = container.querySelectorAll('.sidebar-filter-option[data-value]');
            const term = searchTerm.toLowerCase();
            
            options.forEach(option => {
                const value = option.getAttribute('data-value');
                if (value.includes(term)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        // Toggle sidebar dropdown
        function toggleSidebarDropdown(key) {
            const dropdown = document.getElementById('sidebar-dropdown-' + key);
            const allDropdowns = document.querySelectorAll('.sidebar-dropdown-content');
            const wasOpen = dropdown.classList.contains('show');
            
            allDropdowns.forEach(d => {
                d.classList.remove('show');
            });
            
            if (!wasOpen) {
                dropdown.classList.add('show');
            }
        }

        // Clear specific filter type
        function clearFilterType(key) {
            activeFilters[key] = [];
            
            // Uncheck all checkboxes in this dropdown
            const dropdown = document.getElementById('dropdown-options-' + key);
            if (dropdown) {
                dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
            }
            
            applyFilters();
            renderActiveFilterTags();
        }

        // Render filter dropdown
        function renderFilterDropdown(key, label, data) {
            const options = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));
            const selectedCount = activeFilters[key]?.length || 0;
            
            return `
                <div class="filter-dropdown">
                    <button class="filter-btn ${selectedCount > 0 ? 'active' : ''}" onclick="toggleFilterDropdown('${key}')">
                        ${label}
                        <span>${selectedCount > 0 ? `(${selectedCount})` : '▼'}</span>
                    </button>
                    <div class="filter-dropdown-content" id="dropdown-${key}">
                        ${options.map(opt => `
                            <label class="filter-option">
                                <input type="checkbox" 
                                    value="${opt}" 
                                    ${activeFilters[key]?.includes(opt) ? 'checked' : ''}
                                    onchange="handleFilterChange('${key}', '${opt}', this.checked)">
                                ${opt} (${data[opt].length})
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Toggle filter dropdown
        function toggleFilterDropdown(key) {
            const dropdown = document.getElementById(`dropdown-${key}`);
            const allDropdowns = document.querySelectorAll('.filter-dropdown-content');
            
            allDropdowns.forEach(d => {
                if (d.id !== `dropdown-${key}`) d.classList.remove('show');
            });
            
            dropdown.classList.toggle('show');
        }

        // Handle filter change
        function handleFilterChange(key, value, checked) {
            if (checked) {
                if (!activeFilters[key].includes(value)) {
                    activeFilters[key].push(value);
                }
            } else {
                activeFilters[key] = activeFilters[key].filter(v => v !== value);
            }
            
            applyFilters();
        }

        // Apply filters
        function applyFilters() {
            filteredSongs = allSongs.filter(song => {
                // Check audio only filter
                if (audioOnlyFilter && !song.audioUrl) return false;
                
                // Check search query
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    const searchableText = [
                        song.name,
                        song.mechaber,
                        song.category,
                        song.verter,
                        song.collections,
                        song.pasigOif,
                        song.info,
                        song.siman
                    ].filter(Boolean).join(' ').toLowerCase();
                    if (!searchableText.includes(query)) return false;
                }
                // Check chatzer
                if (activeFilters.chatzer.length > 0) {
                    if (!activeFilters.chatzer.some(f => song.category?.includes(f))) return false;
                }
                // Check mechaber
                if (activeFilters.mechaber.length > 0) {
                    if (!activeFilters.mechaber.some(f => song.mechaber?.includes(f))) return false;
                }
                // Check collection
                if (activeFilters.collection.length > 0) {
                    if (!activeFilters.collection.some(f => song.collections?.includes(f))) return false;
                }
                // Check zman
                if (activeFilters.zman.length > 0) {
                    if (!activeFilters.zman.some(f => song.pasigOif?.includes(f))) return false;
                }
                // Check scale
                if (activeFilters.scale.length > 0) {
                    if (!activeFilters.scale.some(f => song.scale?.includes(f))) return false;
                }
                // Check ritem
                if (activeFilters.ritem.length > 0) {
                    if (!activeFilters.ritem.some(f => song.ritem?.includes(f))) return false;
                }
                // Check gezungen
                if (activeFilters.gezungen.length > 0) {
                    if (!activeFilters.gezungen.some(f => song.gezungen?.includes(f))) return false;
                }
                // Check maure
                if (activeFilters.maure.length > 0) {
                    if (!activeFilters.maure.some(f => song.maure?.includes(f))) return false;
                }
                return true;
            });

            currentPage = 1;
            
            // If we're on songs page, just update the list, not the whole page
            if (currentPageView === 'songs') {
                updateSongsList();
                updateSongsCount();
                renderActiveFilterTags();
                updateSidebarFilterValues();
            } else {
                renderCurrentPage();
            }
        }

        // Update just the songs list without re-rendering sidebar
        function updateSongsList() {
            const container = document.querySelector('.all-songs-grid');
            if (!container) return;
            
            const totalPages = Math.ceil(filteredSongs.length / songsPerPage);
            const startIdx = (currentPage - 1) * songsPerPage;
            const endIdx = Math.min(startIdx + songsPerPage, filteredSongs.length);
            const pageSongs = filteredSongs.slice(startIdx, endIdx);
            
            const playlistIndices = filteredSongs.map(song => allSongs.indexOf(song));
            container.innerHTML = pageSongs.map((song, idx) => {
                const globalIdx = allSongs.indexOf(song);
                return renderSongItem(song, globalIdx, startIdx + idx + 1, playlistIndices);
            }).join('');
            
            // Update pagination
            const paginationContainer = document.querySelector('.pagination');
            if (paginationContainer) {
                paginationContainer.innerHTML = `
                    <button class="page-btn" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>«</button>
                    <button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹</button>
                    <span class="page-info">בלאט ${currentPage} פון ${totalPages}</span>
                    <button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>›</button>
                    <button class="page-btn" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>»</button>
                `;
            }
        }

        // Update songs count display
        function updateSongsCount() {
            const subtitle = document.querySelector('.page-title-content .subtitle');
            if (subtitle) {
                subtitle.textContent = filteredSongs.length + ' ניגונים';
            }
        }

        // Update sidebar filter button values without re-rendering
        function updateSidebarFilterValues() {
            const filterKeys = ['collection', 'chatzer', 'mechaber', 'verter', 'gezungen', 'ritem', 'scale'];
            filterKeys.forEach(key => {
                const btn = document.querySelector(`#sidebar-dropdown-${key}`)?.previousElementSibling;
                if (btn) {
                    const selectedCount = activeFilters[key]?.length || 0;
                    const selectedValue = selectedCount > 0 ? `(${selectedCount})` : '(אלע)';
                    const valueSpan = btn.querySelector('.sidebar-filter-value');
                    if (valueSpan) {
                        valueSpan.textContent = selectedValue;
                    }
                    if (selectedCount > 0) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
        }

        // Render active filter tags
        function renderActiveFilterTags() {
            const container = document.getElementById('activeFilterTags');
            if (!container) return;

            let html = '';
            let hasFilters = false;
            const labels = { chatzer: 'חצר', mechaber: 'מחבר', collection: 'קאלעקשן', verter: 'ווערטער', zman: 'זמן', scale: 'סקעיל', ritem: 'ריטעם', gezungen: 'געזונגען אויף', maure: 'מאורע' };

            for (let [key, values] of Object.entries(activeFilters)) {
                if (!Array.isArray(values)) {
                    // Handle single value (from navigateToWithFilter)
                    if (values) {
                        hasFilters = true;
                        const escapedValues = values.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        html += `
                            <div class="filter-tag">
                                ${labels[key]}: ${values}
                                <span class="filter-tag-close" onclick="removeFilter('${key}', '${escapedValues}')">&times;</span>
                            </div>
                        `;
                    }
                } else {
                    values.forEach(value => {
                        hasFilters = true;
                        const escapedValue = value.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        html += `
                            <div class="filter-tag">
                                ${labels[key]}: ${value}
                                <span class="filter-tag-close" onclick="removeFilter('${key}', '${escapedValue}')">&times;</span>
                            </div>
                        `;
                    });
                }
            }

            // Add clear all button if there are filters
            if (hasFilters) {
                html += `<button class="clear-filters-btn" onclick="clearAllFilters()">🗑️ נעם אראפ אלעס</button>`;
            }

            container.innerHTML = html;
        }

        // Remove filter
        function removeFilter(key, value) {
            activeFilters[key] = activeFilters[key].filter(v => v !== value);
            applyFilters();
            renderActiveFilterTags();
        }

        // Clear all filters
        function clearAllFilters() {
            activeFilters = {
                chatzer: [],
                mechaber: [],
                verter: [],
                zman: [],
                collection: [],
                scale: [],
                ritem: [],
                gezungen: [],
                maure: []
            };
            searchQuery = '';
            
            // Uncheck all filter checkboxes
            document.querySelectorAll('.sidebar-dropdown-content input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // Check all "אלע" radio buttons
            document.querySelectorAll('.sidebar-dropdown-content input[type="radio"]').forEach(rb => {
                rb.checked = true;
            });
            
            applyFilters();
            renderActiveFilterTags();
        }
        
        // Check if any filters are active
        function hasAnyFilters() {
            if (searchQuery) return true;
            return Object.values(activeFilters).some(arr => arr.length > 0);
        }
        
        // Handle songs page search
        function handleSongsSearch(value) {
            searchQuery = value.trim();
            currentPage = 1;
            applyFilters();
        }
        
        // Clear search only
        function clearSearch() {
            searchQuery = '';
            currentPage = 1;
            applyFilters();
        }
        
        // Toggle audio only filter
        function toggleAudioOnly() {
            audioOnlyFilter = !audioOnlyFilter;
            currentPage = 1;
            applyFilters();
        }

        // Current detail view
        let currentDetailView = null; // { type: 'mechaber', name: 'xxx' }

        // URL Routing
        function updateURL() {
            let hash = '';
            
            if (currentDetailView) {
                // Detail page URL: #/mechabrim/123
                // Prefer customId (simple number), then rowId, then name
                const id = currentDetailView.customId || currentDetailView.id || currentDetailView.name;
                hash = `#/${currentDetailView.type}/${encodeURIComponent(id)}`;
            } else if (currentPageView === 'search' && searchQuery) {
                // Search page URL: #/search/קדיש
                hash = `#/search/${encodeURIComponent(searchQuery)}`;
            } else {
                // Category page URL: #/mechabrim or #/home
                hash = `#/${currentPageView}`;
            }
            
            // Update URL without triggering hashchange
            if (window.location.hash !== hash) {
                history.pushState(null, '', hash);
            }
        }

        // Helper function to find item by ID or name
        function findItemByIdOrName(type, idOrName) {
            // Get the appropriate info object
            let infoObj = {};
            switch(type) {
                case 'chatzeros': infoObj = chatzerosInfo; break;
                case 'mechabrim': infoObj = mechabrimInfo; break;
                case 'verter': infoObj = verterInfo; break;
                case 'zmanim': 
                case 'zman': infoObj = Object.assign({}, zmaninInfo, piyutimInfo); break;
                case 'collections': infoObj = collectionsInfo; break;
                case 'albums': infoObj = albumsInfo; break;
                case 'documents': infoObj = documentsInfo; break;
                case 'resources': infoObj = resourcesInfo; break;
                case 'nigun':
                    // For nigunim, search in allSongs
                    const song = allSongs.find(s => s.customId === idOrName || s.rowId === idOrName || s.name === idOrName);
                    return song ? { name: song.name, id: song.rowId, customId: song.customId } : null;
            }
            
            // First try to find by customId (simple number)
            for (const [name, info] of Object.entries(infoObj)) {
                if (info.customId === idOrName) {
                    return { name, id: info.rowId, customId: info.customId };
                }
            }
            
            // Then try to find by rowId
            for (const [name, info] of Object.entries(infoObj)) {
                if (info.rowId === idOrName) {
                    return { name, id: info.rowId, customId: info.customId };
                }
            }
            
            // Fallback to finding by name (for backwards compatibility)
            if (infoObj[idOrName]) {
                return { name: idOrName, id: infoObj[idOrName].rowId, customId: infoObj[idOrName].customId };
            }
            
            return null;
        }

        // Parse URL and navigate
        function handleURLChange() {
            const hash = window.location.hash || '#/home';
            console.log('handleURLChange called with hash:', hash);
            const parts = hash.substring(2).split('/'); // Remove #/ and split
            
            const page = parts[0] || 'home';
            const idOrName = parts[1] ? decodeURIComponent(parts[1]) : null;
            console.log('Parsed URL - page:', page, 'idOrName:', idOrName);
            
            // Valid pages
            const validPages = ['home', 'songs', 'chatzeros', 'mechabrim', 'verter', 'zmanim', 'collections', 'albums', 'documents', 'resources', 'zman', 'nigun', 'search'];
            
            if (validPages.includes(page)) {
                if (page === 'search' && idOrName) {
                    // Search results page
                    searchQuery = idOrName;
                    currentPageView = 'search';
                    currentDetailView = null;
                    
                    // Update search input
                    const searchInput = document.getElementById('globalSearch');
                    if (searchInput) searchInput.value = idOrName;
                    
                    renderCurrentPage();
                } else if (idOrName) {
                    // Find item by ID or name
                    const item = findItemByIdOrName(page, idOrName);
                    console.log('Found item:', item);
                    const itemName = item?.name || idOrName;
                    const itemId = item?.id || idOrName;
                    
                    // Navigate to detail page
                    if (page === 'zman') {
                        // Zman detail page (shows piyutim and collections for a zman)
                        currentPageView = 'zmanim';
                        currentDetailView = { type: 'zman', name: itemName, id: itemId };
                    } else if (page === 'nigun') {
                        // Nigun detail page
                        currentPageView = 'songs';
                        currentDetailView = { type: 'nigun', name: itemName, id: itemId };
                    } else {
                        currentPageView = page;
                        currentDetailView = { type: page, name: itemName, id: itemId };
                    }
                    
                    // Update nav buttons
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        const btnPage = btn.dataset.page;
                        const activePage = page === 'zman' ? 'zmanim' : (page === 'nigun' ? 'songs' : page);
                        btn.classList.toggle('active', btnPage === activePage);
                    });
                    
                    renderDetailPage();
                } else {
                    // Navigate to category page
                    currentDetailView = null;
                    currentPageView = page;
                    currentPage = 1;
                    
                    // Update nav buttons
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.page === page);
                    });
                    
                    renderCurrentPage();
                }
            }
        }

        // Listen to browser back/forward
        window.addEventListener('popstate', handleURLChange);

        // Navigate to detail page
        function navigateToDetail(categoryKey, name, id = null) {
            const decodedName = decodeAttr(name);
            // If no ID provided, try to get it from info object
            if (!id) {
                let infoObj = {};
                switch(categoryKey) {
                    case 'chatzeros': infoObj = chatzerosInfo; break;
                    case 'mechabrim': infoObj = mechabrimInfo; break;
                    case 'verter': infoObj = verterInfo; break;
                    case 'zmanim': infoObj = Object.assign({}, zmaninInfo, piyutimInfo); break;
                    case 'collections': infoObj = collectionsInfo; break;
                    case 'albums': infoObj = albumsInfo; break;
                    case 'documents': infoObj = documentsInfo; break;
                    case 'resources': infoObj = resourcesInfo; break;
                }
                id = infoObj[decodedName]?.rowId;
            }
            currentDetailView = { type: categoryKey, name: decodedName, id: id };
            updateURL();
            renderDetailPage();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Go back from detail page
        function goBackFromDetail() {
            const page = currentDetailView?.type || 'home';
            currentDetailView = null;
            
            // Map category key to page name
            const pageMap = {
                'chatzeros': 'chatzeros',
                'mechabrim': 'mechabrim', 
                'verter': 'verter',
                'zmanim': 'zmanim',
                'collections': 'collections',
                'albums': 'albums',
                'documents': 'documents',
                'resources': 'resources'
            };
            
            navigateTo(pageMap[page] || 'home');
        }

        // Render detail page for a specific item
        function renderDetailPage() {
            const { type, name } = currentDetailView;
            const container = document.getElementById('mainContent');
            
            // Handle zman detail page separately
            if (type === 'zman') {
                renderZmanDetailPage(container, name);
                return;
            }
            
            // Handle nigun detail page separately
            if (type === 'nigun') {
                renderNigunDetailPage(container, name);
                return;
            }
            
            // Handle album detail page separately
            if (type === 'albums') {
                renderAlbumDetailPage(container, name);
                return;
            }
            
            // Handle document detail page separately
            if (type === 'documents') {
                renderDocumentDetailPage(container, name);
                return;
            }
            
            // Handle resource detail page separately
            if (type === 'resources') {
                renderResourceDetailPage(container, name);
                return;
            }
            
            // Get info and songs for this item
            let infoObj = {};
            let icon = '';
            let typeName = '';
            
            switch(type) {
                case 'chatzeros': 
                    infoObj = chatzerosInfo; 
                    icon = '';
                    typeName = 'חצר';
                    break;
                case 'mechabrim': 
                    infoObj = mechabrimInfo; 
                    icon = '';
                    typeName = 'מחבר';
                    break;
                case 'verter': 
                    infoObj = verterInfo; 
                    icon = '';
                    typeName = 'ווערטער';
                    break;
                case 'zmanim': 
                    infoObj = Object.assign({}, zmaninInfo, piyutimInfo); 
                    icon = '';
                    // Check if this is a piyut or a zman
                    if (piyutimInfo[name]) {
                        typeName = 'פיוט';
                    } else {
                        typeName = 'זמן';
                    }
                    break;
                case 'collections': 
                    infoObj = collectionsInfo; 
                    icon = '';
                    typeName = 'קאלעקשאן';
                    break;
                case 'albums': 
                    infoObj = albumsInfo; 
                    icon = '';
                    typeName = 'אלבום';
                    break;
                case 'documents': 
                    infoObj = documentsInfo; 
                    icon = '';
                    typeName = 'דאקומענט';
                    break;
                case 'resources': 
                    infoObj = resourcesInfo; 
                    icon = '';
                    typeName = 'רעסורס';
                    break;
            }
            
            const info = infoObj[name] || {};
            const songIndices = categories[type]?.[name] || [];
            const songs = songIndices.map(idx => allSongs[idx]).filter(Boolean);
            
            // Only show chatzer tags for mechabrim
            const chatzeros = (type === 'mechabrim' && info.chatzer) 
                ? info.chatzer.split(',').map(c => c.trim()).filter(Boolean) 
                : [];
            
            // For mechabrim, build tag name badge, full name, and life dates
            let mechaberTagName = '';
            let mechaberFullName = name; // default to the item name
            let mechaberLifeDates = '';
            
            if (type === 'mechabrim') {
                // Build full name from parts: טיטל + ערשטע נאמען + לעצטע נאמען + סופיקס
                const nameParts = [info.title, info.firstName, info.lastName, info.suffix].filter(Boolean);
                if (nameParts.length > 0) {
                    mechaberFullName = nameParts.join(' ');
                }
                
                // Tag name is from טעג נאמען column - show only if different from built full name
                if (info.tagName && info.tagName !== mechaberFullName) {
                    mechaberTagName = info.tagName;
                }
                
                // Build life dates string (like: י' אייר ה'תרל"ד - ד' אב ה'תש"ד)
                const birthParts = [info.birthDay, info.birthMonth, info.birthYear].filter(Boolean);
                const deathParts = [info.deathDay, info.deathMonth, info.deathYear].filter(Boolean);
                const birthStr = birthParts.length > 0 ? birthParts.join(' ') : '';
                const deathStr = deathParts.length > 0 ? deathParts.join(' ') : '';
                
                if (birthStr || deathStr) {
                    if (birthStr && deathStr) {
                        mechaberLifeDates = `${birthStr} - ${deathStr}`;
                    } else if (birthStr) {
                        mechaberLifeDates = `נולד: ${birthStr}`;
                    } else if (deathStr) {
                        mechaberLifeDates = `נפטר: ${deathStr}`;
                    }
                }
            }
            
            // For chatzeros, find all mechabrim that belong to this chatzer
            let mechabrimFromChatzer = [];
            if (type === 'chatzeros') {
                mechabrimFromChatzer = Object.entries(mechabrimInfo)
                    .filter(([mechName, mechInfo]) => {
                        if (!mechInfo.chatzer) return false;
                        const mechChatzeros = mechInfo.chatzer.split(',').map(c => c.trim());
                        return mechChatzeros.includes(name);
                    })
                    .map(([mechName, mechInfo]) => ({
                        name: mechName,
                        image: mechInfo.image,
                        description: mechInfo.description
                    }));
            }
            
            // For verter, get the lyrics text
            let verterText = '';
            if (type === 'verter') {
                // Use fullText field first, then description
                if (info.fullText) {
                    verterText = info.fullText;
                } else if (info.description) {
                    verterText = info.description;
                }
            }
            
            // For verter, get makor and mareh makom
            const verterMakor = (type === 'verter' && info.makor) ? info.makor : '';
            const verterMarehMakom = (type === 'verter' && info.marehMakom) ? info.marehMakom : '';
            
            // For piyutim (in zmanim category), get zman
            const piyutZman = (type === 'zmanim' && piyutimInfo[name]?.zman) ? piyutimInfo[name].zman : '';

            // Map type to theme class - check if piyut
            const isPiyut = type === 'zmanim' && piyutimInfo[name];
            const themeMap = {
                'chatzeros': 'theme-chatzer',
                'mechabrim': 'theme-mechaber',
                'verter': 'theme-verter',
                'zmanim': isPiyut ? 'theme-piyut' : 'theme-zman',
                'collections': 'theme-collection'
            };
            const themeClass = themeMap[type] || '';

            container.innerHTML = `
                <div class="detail-page ${themeClass}" data-type="${type}">
                    <button class="back-button" onclick="goBackFromDetail()">
                        → צוריק
                    </button>
                    
                    <div class="detail-header">
                        <div class="detail-category-bar">${typeName}</div>
                        <div class="detail-header-content ${info.image ? '' : 'no-image'}">
                            ${info.image ? `
                                <img class="detail-image" src="${info.image}" alt="${name}">
                            ` : ''}
                            <div class="detail-header-text">
                                <h1 class="detail-title">${type === 'mechabrim' ? mechaberFullName : name}</h1>
                                ${mechaberLifeDates ? `
                                    <div class="detail-life-dates">
                                        ${mechaberLifeDates}
                                    </div>
                                ` : ''}
                                ${chatzeros.length > 0 ? `
                                    <div class="detail-badges">
                                        ${chatzeros.map(chatzer => `
                                            <span class="detail-chatzer-badge" 
                                                  onclick="navigateToWithFilter('chatzeros', 'chatzer', '${escapeAttr(chatzer)}')" 
                                                  onmouseenter="showTooltip(event, '${escapeAttr(chatzer)}', 'chatzer')"
                                                  onmouseleave="hideTooltip()"
                                                  style="cursor:pointer;">${chatzer}</span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                ${(verterMakor || verterMarehMakom) ? `
                                    <div class="detail-subtitle">
                                        ${verterMakor ? `<span class="detail-makor-text">${verterMakor}</span>` : ''}
                                        ${(verterMakor && verterMarehMakom) ? '<span class="detail-separator">•</span>' : ''}
                                        ${verterMarehMakom ? `<span class="detail-mareh-text">${verterMarehMakom}</span>` : ''}
                                    </div>
                                ` : ''}
                                ${piyutZman ? `
                                    <div class="detail-subtitle">
                                        <span class="detail-zman-text">${piyutZman}</span>
                                    </div>
                                ` : ''}
                                ${(type === 'collections' && info.zmanim && info.zmanim.length > 0) ? `
                                    <div class="detail-zmanim-badges">
                                        ${info.zmanim.map(zman => `
                                            <span class="detail-zman-badge" 
                                                  onclick="navigateToZmanDetail('${escapeAttr(zman)}')"
                                                  style="cursor:pointer;">${zman}</span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${info.description ? `
                        <div class="detail-description-section">
                            <h3>דעטאלן</h3>
                            <div class="detail-description-content">${formatDescription(info.description)}</div>
                        </div>
                    ` : ''}
                    
                    ${mechabrimFromChatzer.length > 0 ? `
                        <div class="detail-mechabrim-section">
                            <h3>${mechabrimFromChatzer.length} מחברים</h3>
                            <div class="mechabrim-grid">
                                ${mechabrimFromChatzer.map(mech => `
                                    <div class="mechaber-card" onclick="navigateToDetail('mechabrim', '${escapeAttr(mech.name)}')">
                                        ${mech.image ? `
                                            <img class="mechaber-card-image" src="${mech.image}" alt="${mech.name}">
                                        ` : `
                                            <div class="mechaber-card-icon"></div>
                                        `}
                                        <div class="mechaber-card-name">${mech.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${(type === 'verter' && verterText) ? `
                        <div class="detail-verter-section">
                            <h3>ווערטער</h3>
                            <div class="verter-content">${formatVerter(verterText)}</div>
                        </div>
                    ` : ''}
                    
                    <div class="detail-songs-section">
                        <h3>${songs.length} ניגונים ${type === 'mechabrim' ? 'וואס ער האט מחבר געווען' : ''}</h3>
                        <div class="detail-songs-list">
                            ${(() => {
                                const playlistIndices = songs.map(song => allSongs.indexOf(song));
                                return songs.map((song, i) => {
                                    const globalIdx = allSongs.indexOf(song);
                                    return renderSongItem(song, globalIdx, i + 1, playlistIndices);
                                }).join('');
                            })()}
                        </div>
                    </div>
                    
                    ${(() => {
                        // For mechabrim, show songs where they have a שייכות (personality)
                        if (type === 'mechabrim') {
                            const relatedSongs = allSongs.filter(song => {
                                if (!song.personality) return false;
                                const personalities = song.personality.split(',').map(p => p.trim());
                                return personalities.includes(name);
                            });
                            
                            if (relatedSongs.length > 0) {
                                const playlistIndices = relatedSongs.map(song => allSongs.indexOf(song));
                                return `
                                    <div class="detail-songs-section detail-related-songs">
                                        <h3>${relatedSongs.length} ניגונים וואס ער האט א שייכות</h3>
                                        <div class="detail-songs-list">
                                            ${relatedSongs.map((song, i) => {
                                                const globalIdx = allSongs.indexOf(song);
                                                return renderSongItem(song, globalIdx, i + 1, playlistIndices);
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                        }
                        return '';
                    })()}
                </div>
            `;
        }
        
        // Format description text (handle markdown-like formatting)
        function formatDescription(text) {
            if (!text) return '';
            
            // Convert markdown links [text](url) to HTML
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Convert **bold** to <strong>
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Convert ## headers to <h4>
            text = text.replace(/^## (.+)$/gm, '<h4>$1</h4>');
            
            // Convert newlines to <br> for proper display
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }
        
        // Format verter (lyrics) text with proper line breaks and styling
        function formatVerter(text) {
            if (!text) return '';
            
            // Clean up the text
            text = text.replace(/```/g, '').trim();
            
            // Split into lines and wrap each in a span for styling
            const lines = text.split('\n');
            
            return lines.map(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return '<div class="verter-line verter-empty"></div>';
                return `<div class="verter-line">${trimmedLine}</div>`;
            }).join('');
        }

        // Render zmanim page with zmanim as main items
        function renderZmanimPage(container) {
            const data = categories.zmanim;
            
            // Build zmanim order
            const zmanOrder = ['שבת', 'מוצאי שבת', 'ראש חודש', 'ימים נוראים', 'סוכות', 'שמחת תורה', 
                              'שמחת בית השואבה', 'חנוכה', 'פורים', 'פסח', 'שבועות', 'בין המצרים', 
                              'ל"ג בעומר', 'שלש רגלים', 'חתונה', 'שבע ברכות', 'ברית מילה', 
                              'בר מצוה', 'קבלת פנים - חופה', 'הכנסת ספר תורה', 'סיום', 
                              'שבת שירה', 'שבת שקלים', 'יארצייט'];
            
            // Add any zmanim not in the predefined order
            Object.keys(zmaninInfo).forEach(z => {
                if (!zmanOrder.includes(z)) {
                    zmanOrder.push(z);
                }
            });
            
            // Filter to only zmanim that exist
            const activeZmanim = zmanOrder.filter(z => zmaninInfo[z]);
            
            // Count totals
            const totalZmanim = activeZmanim.length;
            
            // Build HTML
            let html = `
                <div class="page-theme-zman">
                    <div class="page-title">
                        <div class="page-title-bar">זמנים</div>
                        <div class="page-title-content">
                            <div class="subtitle">ניגונים פאסיג פאר ספעציעלע צייטן • ${totalZmanim} זמנים</div>
                        </div>
                    </div>
                    
                    <div class="category-grid">
            `;
            
            // Show each zman as a card
            activeZmanim.forEach(zmanName => {
                const zmanData = zmaninInfo[zmanName];
                if (!zmanData) return;
                
                const piyutimCount = zmanData.piyutim?.length || 0;
                const collectionsCount = zmanData.collections?.length || 0;
                
                html += `
                    <div class="category-card" onclick="navigateToZmanDetail('${escapeAttr(zmanName)}')">
                        <div class="card-header">
                            <div class="card-icon"></div>
                            <div class="card-header-text">
                                <div class="card-title">${zmanName}</div>
                                <div class="card-stats">
                                    ${piyutimCount > 0 ? `<span class="card-stat">${piyutimCount} פיוטים</span>` : ''}
                                    ${collectionsCount > 0 ? `<span class="card-stat">${collectionsCount} קאלעקשאנס</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
            
            container.innerHTML = html;
        }
        
        // Navigate to zman detail page
        function navigateToZmanDetail(encodedName) {
            const name = decodeAttr(encodedName);
            const infoObj = Object.assign({}, zmaninInfo, piyutimInfo);
            const id = infoObj[name]?.rowId;
            currentDetailView = { type: 'zman', name: name, id: id };
            updateURL();
            renderCurrentPage();
        }
        
        // Render nigun detail page
        function renderNigunDetailPage(container, nigunName) {
            // Find the song by name, rowId, or customId
            let songIdx = allSongs.findIndex(s => s.name === nigunName);
            if (songIdx === -1) {
                // Try finding by rowId
                songIdx = allSongs.findIndex(s => s.rowId === nigunName);
            }
            if (songIdx === -1) {
                // Try finding by customId
                songIdx = allSongs.findIndex(s => s.customId === nigunName);
            }
            const song = allSongs[songIdx];
            
            if (!song) {
                container.innerHTML = '<p>ניגון נישט געפונען</p>';
                return;
            }
            
            // Parse chatzeros
            const chatzeros = song.category ? song.category.split(',').map(c => c.trim()).filter(Boolean) : [];
            
            // Get mechaber info for image
            const mechaberName = song.mechaber ? song.mechaber.split(',')[0].trim() : null;
            const mechaberInfo = mechaberName ? mechabrimInfo[mechaberName] : null;
            
            // Build music details tags (scale, ritem, pasigOif, maure, collections)
            const musicTags = [];
            if (song.scale) musicTags.push({ value: song.scale, type: 'scale', icon: '' });
            if (song.ritem) musicTags.push({ value: song.ritem, type: 'ritem', icon: '' });
            if (song.pasigOif) musicTags.push({ value: song.pasigOif, type: 'zman', icon: '' });
            if (song.maure) musicTags.push({ value: song.maure, type: 'maure', icon: '' });
            if (song.collections) musicTags.push({ value: song.collections, type: 'collection', icon: '' });
            
            container.innerHTML = `
                <div class="detail-page nigun-detail-page">
                    <button class="back-button" onclick="navigateTo('songs')">
                        → ניגונים בלאט
                    </button>
                    
                    <div class="detail-header">
                        <div class="detail-category-bar" style="background: var(--color-nigun);">ניגון</div>
                        <div class="detail-header-content no-image">
                            <div class="detail-header-text">
                                <h1 class="detail-title" style="color: var(--color-nigun-dark);">${song.name}</h1>
                                ${chatzeros.length > 0 ? `
                                    <div class="nigun-chatzer-tags">
                                        ${chatzeros.map(chatzer => `
                                            <span class="nigun-tag chatzer-tag" onclick="navigateToDetail('chatzeros', '${escapeAttr(chatzer)}')">
                                                ${chatzer}
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${song.mechaber ? `
                        <div class="nigun-mechaber-section">
                            <div class="nigun-mechaber-title">מחבר הניגון</div>
                            <div class="nigun-mechaber-grid">
                                <div class="nigun-mechaber-card" onclick="navigateToDetail('mechabrim', '${escapeAttr(mechaberName || '')}')">
                                    ${mechaberInfo && mechaberInfo.image ? `
                                        <img class="nigun-mechaber-image" src="${mechaberInfo.image}" alt="${mechaberName || ''}">
                                    ` : `
                                        <div class="nigun-mechaber-placeholder">👤</div>
                                    `}
                                    <div class="nigun-mechaber-name">${song.mechaber}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${song.personality ? `
                        <div class="nigun-personality-section">
                            <div class="nigun-personality-title">פערזענליכקייטן וואס האבן א שייכות מיט דעם ניגון</div>
                            <div class="nigun-personality-grid">
                                ${song.personality.split(',').map(p => p.trim()).filter(Boolean).map(personName => {
                                    const personInfo = mechabrimInfo[personName] || {};
                                    return `
                                        <div class="nigun-personality-card" onclick="navigateToDetail('mechabrim', '${escapeAttr(personName)}')">
                                            ${personInfo.image ? `
                                                <img class="nigun-personality-image" src="${personInfo.image}" alt="${personName}">
                                            ` : `
                                                <div class="nigun-personality-placeholder">👤</div>
                                            `}
                                            <div class="nigun-personality-name">${personName}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="nigun-details-card">
                        ${song.siman ? `
                            <div class="nigun-detail-row">
                                <span class="nigun-detail-label">סימן:</span>
                                <span class="nigun-detail-value">${song.siman}</span>
                            </div>
                        ` : ''}
                        ${song.verter ? `
                            <div class="nigun-detail-row">
                                <span class="nigun-detail-label">ווערטער:</span>
                                <span class="nigun-detail-value nigun-tags-row">
                                    ${song.verter.split(',').map(v => v.trim()).filter(Boolean).map(v => `
                                        <span class="nigun-tag-inline tag-verter"
                                              onclick="navigateToDetail('verter', '${escapeAttr(v)}')"
                                              onmouseenter="showTooltip(event, '${escapeAttr(v)}', 'verter')"
                                              onmouseleave="hideTooltip()">${v}</span>
                                    `).join('')}
                                </span>
                            </div>
                        ` : ''}
                        ${song.scale ? `
                            <div class="nigun-detail-row">
                                <span class="nigun-detail-label">סקעיל:</span>
                                <span class="nigun-detail-value">
                                    <span class="nigun-tag-inline tag-scale">${song.scale}</span>
                                </span>
                            </div>
                        ` : ''}
                        ${song.ritem ? `
                            <div class="nigun-detail-row">
                                <span class="nigun-detail-label">ריטעם:</span>
                                <span class="nigun-detail-value">
                                    <span class="nigun-tag-inline tag-ritem">${song.ritem}</span>
                                </span>
                            </div>
                        ` : ''}
                        ${song.maure ? `
                            <div class="nigun-detail-row">
                                <span class="nigun-detail-label">ווערט געזונגען בחצה"ק אויף: </span>
                                <span class="nigun-detail-value nigun-tags-row">
                                    ${song.maure.split(',').map(m => m.trim()).filter(Boolean).map(m => `
                                        <span class="nigun-tag-inline tag-piyut"
                                              onclick="navigateToWithFilter('songs', 'zman', '${escapeAttr(m)}')"
                                              onmouseenter="showTooltip(event, '${escapeAttr(m)}', 'zman')"
                                              onmouseleave="hideTooltip()">${m}</span>
                                    `).join('')}
                                </span>
                            </div>
                        ` : ''}
                        ${song.pasigOif ? `
                            <div class="nigun-detail-row">
                                <span class="nigun-detail-label">איז פאסיג צו זינגען אויף: </span>
                                <span class="nigun-detail-value nigun-tags-row">
                                    ${song.pasigOif.split(',').map(p => p.trim()).filter(Boolean).map(p => `
                                        <span class="nigun-tag-inline tag-piyut" 
                                              onclick="navigateToWithFilter('songs', 'zman', '${escapeAttr(p)}')"
                                              onmouseenter="showTooltip(event, '${escapeAttr(p)}', 'zman')"
                                              onmouseleave="hideTooltip()">${p}</span>
                                    `).join('')}
                                </span>
                            </div>
                        ` : ''}
                        ${song.collections ? `
                            <div class="nigun-detail-row">
                                <span class="nigun-detail-label">קאלעקשאן:</span>
                                <span class="nigun-detail-value nigun-tags-row">
                                    ${song.collections.split(',').map(col => col.trim()).filter(Boolean).map(col => `
                                        <span class="nigun-tag-inline tag-collection"
                                              onclick="navigateToDetail('collections', '${escapeAttr(col)}')"
                                              onmouseenter="showTooltip(event, '${escapeAttr(col)}', 'collection')"
                                              onmouseleave="hideTooltip()">${col}</span>
                                    `).join('')}
                                </span>
                            </div>
                        ` : ''}
                        ${song.albums ? `
                            <div class="nigun-detail-row">
                                <span class="nigun-detail-label">אלבומס:</span>
                                <span class="nigun-detail-value nigun-tags-row">
                                    ${song.albums.split(',').map(a => a.trim()).filter(Boolean).map(a => `
                                        <span class="nigun-tag-inline tag-album"
                                              onclick="navigateToDetail('albums', '${escapeAttr(a)}')"
                                              style="cursor:pointer;">${a}</span>
                                    `).join('')}
                                </span>
                            </div>
                        ` : ''}
                        ${song.documents ? `
                            <div class="nigun-detail-row">
                                <span class="nigun-detail-label">דאקומענטן:</span>
                                <span class="nigun-detail-value nigun-tags-row">
                                    ${song.documents.split(',').map(d => d.trim()).filter(Boolean).map(d => `
                                        <span class="nigun-tag-inline tag-document"
                                              onclick="navigateToDetail('documents', '${escapeAttr(d)}')"
                                              style="cursor:pointer;">${d}</span>
                                    `).join('')}
                                </span>
                            </div>
                        ` : ''}
                        ${song.resources ? `
                            <div class="nigun-detail-row">
                                <span class="nigun-detail-label">רעסורסן:</span>
                                <span class="nigun-detail-value nigun-tags-row">
                                    ${song.resources.split(',').map(r => r.trim()).filter(Boolean).map(r => `
                                        <span class="nigun-tag-inline tag-resource"
                                              onclick="navigateToDetail('resources', '${escapeAttr(r)}')"
                                              style="cursor:pointer;">${r}</span>
                                    `).join('')}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${song.info ? `
                        <div class="nigun-section">
                            <h3>אינפארמאציע</h3>
                            <div class="nigun-section-content">
                                <div class="nigun-info-text">${song.info}</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${song.notn ? `
                        <div class="nigun-section">
                            <h3>נאטן</h3>
                            <div class="nigun-section-content">
                                <a href="${song.notn}" target="_blank" class="nigun-notn-link">📄 קוק נאטן</a>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${song.recordings && song.recordings.length > 0 ? `
                        <div class="nigun-section nigun-recordings-section">
                            <h3>רעקארדינגס (${song.recordings.length})</h3>
                            <div class="nigun-recordings-list">
                                ${song.recordings.map((rec, i) => `
                                    <div class="nigun-recording-item ${i === 0 ? 'active' : ''}" onclick="playNigunRecording(${songIdx}, ${i}, this)" data-recording-idx="${i}">
                                        <div class="nigun-recording-play-btn">▶</div>
                                        <div class="nigun-recording-info">
                                            <div class="nigun-recording-name">${rec.details || 'רעקארדינג ' + (i + 1)}</div>
                                            <div class="nigun-recording-filename">${rec.name}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${song.images && song.images.length > 0 ? `
                        <div class="nigun-section nigun-images-section">
                            <h3>בילדער (${song.images.length})</h3>
                            <div class="nigun-images-grid">
                                ${song.images.map((img, i) => `
                                    <div class="nigun-image-item" onclick="openImageModal('${img.url}')">
                                        <img src="${img.url}" alt="${img.name}" loading="lazy">
                                        <div class="nigun-image-name">${img.name}</div>
                                        ${img.details ? `<div class="nigun-image-details">${img.details}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${song.pdfs && song.pdfs.length > 0 ? `
                        <div class="nigun-section nigun-pdfs-section">
                            <h3>PDF דאקומענטן (${song.pdfs.length})</h3>
                            <div class="nigun-pdfs-list">
                                ${song.pdfs.map((pdf, i) => `
                                    <a href="${pdf.url}" target="_blank" class="nigun-pdf-item">
                                        <div class="nigun-pdf-icon">📄</div>
                                        <div class="nigun-pdf-name">${pdf.name}</div>
                                        <div class="nigun-pdf-action">עפן</div>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Play recording from nigun detail page
        function playNigunRecording(songIdx, recordingIdx, element) {
            const song = allSongs[songIdx];
            if (!song || !song.recordings || !song.recordings[recordingIdx]) return;
            
            const recording = song.recordings[recordingIdx];
            
            // Update current song and recording index
            currentSongIndex = songIdx;
            currentRecordingIndex = recordingIdx;
            
            // Enable recordings mode if song has multiple recordings
            isInRecordingsMode = song.recordings.length > 1;
            
            // Play the specific recording URL
            audioPlayer.src = recording.url;
            audioPlayer.play();
            
            // Update player UI with song info
            updatePlayerUI(song);
            updateActiveSongInList();
            
            // Update active state in UI
            document.querySelectorAll('.nigun-recording-item').forEach((item, i) => {
                item.classList.toggle('active', i === recordingIdx);
            });
        }
        
        // Render zman detail page
        function renderZmanDetailPage(container, zmanName) {
            const zmanData = zmaninInfo[zmanName];
            if (!zmanData) {
                container.innerHTML = '<p>זמן נישט געפונען</p>';
                return;
            }
            
            const piyutim = zmanData.piyutim || [];
            const collections = zmanData.collections || [];
            
            let html = `
                <div class="detail-page theme-zman">
                    <button class="back-button" onclick="navigateTo('zmanim')">
                        → זמנים בלאט
                    </button>
                    
                    <div class="detail-header">
                        <div class="detail-category-bar">זמן</div>
                        <div class="detail-header-content">
                            <div class="detail-header-text">
                                <div class="detail-title">${zmanName}</div>
                                <div class="detail-subtitle">
                                    ${collections.length > 0 ? `<span>${collections.length} קאלעקשאנס</span>` : ''}
                                    ${piyutim.length > 0 && collections.length > 0 ? '<span class="detail-separator">•</span>' : ''}
                                    ${piyutim.length > 0 ? `<span>${piyutim.length} פיוטים</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
            `;
            
            // Collections section first
            if (collections.length > 0) {
                html += `
                    <div class="zman-section section-collections">
                        <h3>קאלעקשאנס</h3>
                        <div class="zman-items-grid">
                            ${collections.sort((a, b) => a.localeCompare(b, 'he')).map(colName => {
                                const songCount = categories.collections[colName]?.length || 0;
                                return `
                                    <div class="zman-item-card" onclick="navigateToDetail('collections', '${escapeAttr(colName)}')">
                                        <div class="zman-item-icon"></div>
                                        <div class="zman-item-info">
                                            <div class="zman-item-name">${colName}</div>
                                            ${songCount > 0 ? `<div class="zman-item-count">${songCount} ניגונים</div>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Piyutim section
            if (piyutim.length > 0) {
                html += `
                    <div class="zman-section section-piyutim">
                        <h3>פיוטים</h3>
                        <div class="zman-items-grid">
                            ${piyutim.sort((a, b) => a.localeCompare(b, 'he')).map(piyutName => {
                                const songCount = categories.zmanim[piyutName]?.length || 0;
                                return `
                                    <div class="zman-item-card" onclick="navigateToDetail('zmanim', '${escapeAttr(piyutName)}')">
                                        <div class="zman-item-icon"></div>
                                        <div class="zman-item-info">
                                            <div class="zman-item-name">${piyutName}</div>
                                            ${songCount > 0 ? `<div class="zman-item-count">${songCount} ניגונים</div>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
            
            container.innerHTML = html;
        }

        // Render collections page with zmanim tags
        function renderCollectionsPage(container) {
            const data = categories.collections;
            const sortedKeys = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));
            
            container.innerHTML = `
                <div class="page-theme-collection">
                    <div class="page-title">
                        <div class="page-title-bar">קאלעקשאנס</div>
                        <div class="page-title-content">
                            <div class="subtitle">פלעיליסטס צום שפילן • ${sortedKeys.length} קאלעקשאנס</div>
                        </div>
                    </div>

                    <div class="collections-grid">
                        ${sortedKeys.map(key => {
                            const info = collectionsInfo[key] || {};
                            const songCount = data[key].length;
                            const zmanim = info.zmanim || [];
                            const songIndices = data[key] || [];
                            const playlistIndices = songIndices.map(idx => idx);
                            
                            return `
                            <div class="collection-card">
                                <div class="collection-card-header" onclick="navigateToDetail('collections', '${escapeAttr(key)}')">
                                    <div class="collection-icon">♫</div>
                                    <div class="collection-info">
                                        <div class="collection-title">${key}</div>
                                        <div class="collection-meta">${songCount} ניגונים</div>
                                        ${zmanim.length > 0 ? `
                                            <div class="collection-zmanim" onclick="event.stopPropagation();">
                                                ${zmanim.slice(0, 3).map(zman => `<span class="collection-zman-tag" 
                                                    onclick="event.stopPropagation(); navigateToZmanDetail('${escapeAttr(zman)}')"
                                                    onmouseenter="showTooltip(event, '${escapeAttr(zman)}', 'zman')"
                                                    onmouseleave="hideTooltip()">${zman}</span>`).join('')}
                                                ${zmanim.length > 3 ? `<span class="collection-zman-more">+${zmanim.length - 3}</span>` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <button class="collection-play-btn" onclick="event.stopPropagation(); playCollectionFromStart('${escapeAttr(key)}')">
                                        ▶
                                    </button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }

        // Render music page (scale & rhythm)
        function renderMusicPage(container) {
            const scaleData = categories.scale;
            const ritemData = categories.ritem;
            const sortedScales = Object.keys(scaleData).sort((a, b) => scaleData[b].length - scaleData[a].length);
            const sortedRitems = Object.keys(ritemData).sort((a, b) => ritemData[b].length - ritemData[a].length);
            
            // Build structure: for each ritem, group songs by scale
            const ritemGroups = {};
            sortedRitems.forEach(ritem => {
                ritemGroups[ritem] = {};
                const songIndices = ritemData[ritem] || [];
                songIndices.forEach(idx => {
                    const song = allSongs[idx];
                    if (song) {
                        const scale = song.scale || 'אנדערע';
                        if (!ritemGroups[ritem][scale]) {
                            ritemGroups[ritem][scale] = [];
                        }
                        ritemGroups[ritem][scale].push(idx);
                    }
                });
            });
            
            container.innerHTML = `
                <div class="page-theme-music">
                    <div class="page-title">
                        <div class="page-title-bar" style="background: var(--color-music);">מוזיק</div>
                        <div class="page-title-content">
                            <div class="subtitle">ניגונים לויט ריטעם און סקעיל</div>
                        </div>
                    </div>

                    <!-- Rhythm Groups -->
                    <div class="music-ritem-groups" id="musicRitemGroups">
                        ${sortedRitems.map(ritem => {
                            const scalesInRitem = Object.keys(ritemGroups[ritem]).sort((a, b) => 
                                (ritemGroups[ritem][b]?.length || 0) - (ritemGroups[ritem][a]?.length || 0)
                            );
                            const totalInRitem = ritemData[ritem].length;
                            
                            return `
                                <div class="ritem-group" data-ritem="${escapeAttr(ritem)}">
                                    <div class="ritem-group-header">
                                        <h3>${ritem}</h3>
                                        <span class="ritem-count">${totalInRitem} ניגונים</span>
                                        <button class="ritem-play-btn" onclick="event.stopPropagation(); playMusicCategory('ritem', '${escapeAttr(ritem)}')">▶ שפיל אלע</button>
                                    </div>
                                    <div class="ritem-scales">
                                        ${scalesInRitem.map(scale => {
                                            const songsInScale = ritemGroups[ritem][scale] || [];
                                            return `
                                                <div class="scale-group" data-scale="${escapeAttr(scale)}">
                                                    <div class="scale-group-header">
                                                        <span class="scale-name">${scale}</span>
                                                        <span class="scale-song-count">${songsInScale.length}</span>
                                                    </div>
                                                    <div class="scale-songs">
                                                        ${songsInScale.slice(0, 10).map((songIdx, i) => {
                                                            const song = allSongs[songIdx];
                                                            const hasAudio = song.audioUrl && song.audioUrl.startsWith('http');
                                                            return `
                                                                <div class="music-song-item ${!hasAudio ? 'no-audio' : ''}" 
                                                                     onclick="${hasAudio ? `playSong(${songIdx})` : `showSongDetails(${songIdx})`}">
                                                                    <span class="music-song-name">${song.name}</span>
                                                                    ${song.mechaber ? `<span class="music-song-meta">${song.mechaber}</span>` : ''}
                                                                    <button class="music-song-details" onclick="event.stopPropagation(); showSongDetails(${songIdx});">◉</button>
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                        ${songsInScale.length > 10 ? `
                                                            <div class="scale-more" onclick="showAllScaleSongs('${escapeAttr(ritem)}', '${escapeAttr(scale)}')">
                                                                + נאך ${songsInScale.length - 10} ניגונים...
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        // Show all songs for a scale in a ritem
        function showAllScaleSongs(ritem, scale) {
            // Navigate to songs page with both filters
            activeFilters.ritem = [decodeAttr(ritem)];
            activeFilters.scale = [decodeAttr(scale)];
            applyFilters();
            navigateTo('songs');
        }

        // Render category page
        function renderCategoryPage(container, categoryKey, title, icon, subtitle) {
            const data = categories[categoryKey];
            const sortedKeys = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));
            
            // Get the right info object and theme class for this category
            let infoObj = {};
            let themeClass = '';
            switch(categoryKey) {
                case 'chatzeros': infoObj = chatzerosInfo; themeClass = 'page-theme-chatzer'; break;
                case 'mechabrim': infoObj = mechabrimInfo; themeClass = 'page-theme-mechaber'; break;
                case 'verter': infoObj = verterInfo; themeClass = 'page-theme-verter'; break;
                case 'zmanim': infoObj = Object.assign({}, zmaninInfo, piyutimInfo); themeClass = 'page-theme-zman'; break;
                case 'collections': infoObj = collectionsInfo; themeClass = 'page-theme-collection'; break;
            }

            container.innerHTML = `
                <div class="${themeClass}">
                    <div class="page-title">
                        <div class="page-title-bar">${title}</div>
                        <div class="page-title-content">
                            <div class="subtitle">${subtitle} • ${sortedKeys.length} קאטעגאריעס</div>
                        </div>
                    </div>

                    <div class="category-grid" id="categoryGrid">
                        ${sortedKeys.map(key => {
                            const info = infoObj[key] || {};
                            const hasImage = !!info.image;
                            const songCount = data[key].length;
                            
                            // Only show chatzer tags for mechabrim
                            const chatzeros = (categoryKey === 'mechabrim' && info.chatzer) 
                                ? info.chatzer.split(',').map(c => c.trim()).filter(Boolean) 
                                : [];
                            
                            // Count mechabrim for chatzeros
                            let mechabrimCount = 0;
                            if (categoryKey === 'chatzeros') {
                                mechabrimCount = Object.entries(mechabrimInfo)
                                    .filter(([mechName, mechInfo]) => {
                                        if (!mechInfo.chatzer) return false;
                                        const mechChatzeros = mechInfo.chatzer.split(',').map(c => c.trim());
                                        return mechChatzeros.includes(key);
                                    }).length;
                            }
                            
                            return `
                            <div class="category-card ${hasImage ? 'has-image' : ''}" onclick="navigateToDetail('${categoryKey}', '${escapeAttr(key)}')">
                                <div class="card-header">
                                    ${hasImage ? `
                                        <img class="card-image" src="${info.image}" alt="${key}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="card-icon" style="display:none;">${icon}</div>
                                    ` : `
                                        <div class="card-icon">${icon}</div>
                                    `}
                                    <div class="card-header-text">
                                        ${(() => {
                                            if (categoryKey === 'mechabrim') {
                                                // Build full name like tooltip does
                                                const nameParts = [info.title, info.firstName, info.lastName, info.suffix].filter(Boolean);
                                                const fullName = nameParts.length > 0 ? nameParts.join(' ') : key;
                                                
                                                // Build full dates
                                                const birthParts = [info.birthDay, info.birthMonth, info.birthYear].filter(Boolean);
                                                const deathParts = [info.deathDay, info.deathMonth, info.deathYear].filter(Boolean);
                                                const birthDate = birthParts.join(' ');
                                                const deathDate = deathParts.join(' ');
                                                const dateStr = (birthDate || deathDate) ? `${birthDate || '?'} - ${deathDate || ''}` : '';
                                                
                                                return `
                                                    <div class="card-title">${fullName}</div>
                                                    ${dateStr ? `<div class="card-years">${dateStr}</div>` : ''}
                                                `;
                                            } else {
                                                return `<div class="card-title">${key}</div>`;
                                            }
                                        })()}
                                        ${chatzeros.length > 0 ? `
                                            <div class="card-tags" onclick="event.stopPropagation();">
                                                ${chatzeros.map(chatzer => `
                                                    <span class="card-chatzer-tag" 
                                                          onclick="event.stopPropagation(); navigateToWithFilter('chatzeros', 'chatzer', '${escapeAttr(chatzer)}')"
                                                          onmouseenter="showTooltip(event, '${escapeAttr(chatzer)}', 'chatzer')"
                                                          onmouseleave="hideTooltip()">${chatzer}</span>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                        <div class="card-stats">
                                            ${categoryKey === 'chatzeros' && mechabrimCount > 0 ? `<span class="card-stat">${mechabrimCount} מחברים</span>` : ''}
                                            <span class="card-stat">${songCount} ניגונים</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }

        // Render resources page
        function renderResourcesPage(container) {
            const allKeys = Object.keys(resourcesInfo);
            
            // Group by sort type
            const groups = {};
            allKeys.forEach(key => {
                const info = resourcesInfo[key] || {};
                const sortType = (info.sort || info.allData?.['סארט'] || 'אנדערע').replace(/\`\`\`/g, '').trim();
                if (!groups[sortType]) groups[sortType] = [];
                groups[sortType].push({ key, info });
            });
            
            // Sort groups and items within groups
            const sortedGroupNames = Object.keys(groups).sort((a, b) => {
                if (a === 'אנדערע') return 1;
                if (b === 'אנדערע') return -1;
                return a.localeCompare(b, 'he');
            });
            
            let html = `
                <div class="page-theme-resource">
                    <div class="page-title">
                        <div class="page-title-bar">רעסורסן</div>
                        <div class="page-title-content">
                            <div class="subtitle">לינקס און רעסורסן • ${allKeys.length} רעסורסן</div>
                        </div>
                    </div>
            `;
            
            sortedGroupNames.forEach(groupName => {
                const items = groups[groupName].sort((a, b) => a.key.localeCompare(b.key, 'he'));
                
                html += `
                    <div class="category-group">
                        <div class="category-group-header resource-group-header">
                            <span class="category-group-title">${groupName}</span>
                            <span class="category-group-count">${items.length}</span>
                        </div>
                        <div class="resources-grid">
                `;
                
                items.forEach(({ key, info }) => {
                    // Extract link from various formats
                    let linkUrl = info.link;
                    if (!linkUrl && info.allData) {
                        const linkData = info.allData['לינק / נאמבער'] || info.allData['לינק'];
                        if (linkData) {
                            const urlMatch = linkData.match(/https?:\/\/[^\s\)]+/);
                            if (urlMatch) linkUrl = urlMatch[0];
                        }
                    }
                    const hasLink = linkUrl && linkUrl.startsWith('http');
                    const linkText = info.allData?.['לינק / נאמבער'] || '';
                    const isPhone = linkText && !linkText.includes('http') && linkText.match(/\d{3}/);
                    const phoneNumber = isPhone ? linkText.replace(/\`\`\`/g, '').trim() : '';
                    
                    html += `
                        <div class="resource-card">
                            <div class="resource-card-header clickable-header" onclick="navigateToDetail('resources', '${escapeAttr(key)}')">
                                <div class="resource-sort-label">${groupName}</div>
                            </div>
                            <div class="resource-card-body">
                                <div class="resource-title clickable-title" onclick="navigateToDetail('resources', '${escapeAttr(key)}')">${key}</div>
                                ${info.chatzer ? `<div class="resource-chatzer"><span class="chatzer-tag" onmouseenter="showTooltip(event, '${escapeAttr(info.chatzer)}', 'chatzer')" onmouseleave="hideTooltip()" onclick="navigateToDetail('chatzeros', '${escapeAttr(info.chatzer)}')">${info.chatzer}</span></div>` : ''}
                                ${info.description ? `<div class="resource-details">${info.description}</div>` : ''}
                                ${info.notes ? `<div class="resource-notes">${info.notes}</div>` : ''}
                            </div>
                            <div class="resource-card-footer">
                                ${hasLink ? `
                                    <a href="${linkUrl}" target="_blank" class="resource-link-btn">
                                        עפן לינק
                                    </a>
                                ` : isPhone ? `
                                    <div class="resource-phone-number">${phoneNumber}</div>
                                ` : '<div class="resource-btn-placeholder"></div>'}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }

        // Render documents page
        function renderDocumentsPage(container) {
            const allKeys = Object.keys(documentsInfo);
            
            // Group by sort type
            const groups = {};
            allKeys.forEach(key => {
                const info = documentsInfo[key] || {};
                const sortType = (info.allData?.['סארט'] || info.sort || 'אנדערע').replace(/\`\`\`/g, '').trim();
                if (!groups[sortType]) groups[sortType] = [];
                groups[sortType].push({ key, info });
            });
            
            // Sort groups
            const sortedGroupNames = Object.keys(groups).sort((a, b) => {
                if (a === 'אנדערע') return 1;
                if (b === 'אנדערע') return -1;
                return a.localeCompare(b, 'he');
            });
            
            let html = `
                <div class="page-theme-document">
                    <div class="page-title">
                        <div class="page-title-bar">דאקומענטן</div>
                        <div class="page-title-content">
                            <div class="subtitle">דאקומענטן און PDFs • ${allKeys.length} דאקומענטן</div>
                        </div>
                    </div>
            `;
            
            sortedGroupNames.forEach(groupName => {
                const items = groups[groupName].sort((a, b) => a.key.localeCompare(b.key, 'he'));
                
                html += `
                    <div class="category-group">
                        <div class="category-group-header document-group-header">
                            <span class="category-group-title">${groupName}</span>
                            <span class="category-group-count">${items.length}</span>
                        </div>
                        <div class="documents-grid">
                `;
                
                items.forEach(({ key, info }) => {
                    const hasFile = info.file && info.file.startsWith('http');
                    const hasLink = info.link && info.link.startsWith('http');
                    const previewUrl = hasFile ? `https://docs.google.com/viewer?url=${encodeURIComponent(info.file)}&embedded=true` : '';
                    
                    html += `
                        <div class="document-card">
                            <div class="document-card-header clickable-header" onclick="navigateToDetail('documents', '${escapeAttr(key)}')">
                                <div class="document-sort-label">${groupName}</div>
                            </div>
                            ${hasFile ? `
                                <div class="document-preview">
                                    <iframe class="document-preview-frame" data-src="${previewUrl}" loading="lazy"></iframe>
                                    <div class="document-preview-overlay" onclick="openPdfPopup('${encodeURIComponent(info.file)}', '${encodeURIComponent(key)}')">
                                        <span class="preview-expand-icon">🔍</span>
                                    </div>
                                </div>
                            ` : ''}
                            <div class="document-card-body">
                                <div class="document-title clickable-title" onclick="navigateToDetail('documents', '${escapeAttr(key)}')">${key}</div>
                                ${info.serie ? `<div class="document-serie">${info.serie.replace(/\`\`\`/g, '')}</div>` : ''}
                                ${info.chatzer ? `<div class="document-chatzer"><span class="chatzer-tag" onmouseenter="showTooltip(event, '${escapeAttr(info.chatzer)}', 'chatzer')" onmouseleave="hideTooltip()" onclick="navigateToDetail('chatzeros', '${escapeAttr(info.chatzer)}')">${info.chatzer}</span></div>` : ''}
                                ${info.description ? `<div class="document-details">${info.description.replace(/\`\`\`/g, '').replace(/!\[.*?\]\(.*?\)/g, '')}</div>` : ''}
                                ${info.notes ? `<div class="document-notes">${info.notes}</div>` : ''}
                            </div>
                            <div class="document-card-footer">
                                ${hasLink ? `
                                    <a href="${info.link}" target="_blank" class="document-link-btn">
                                        לינק
                                    </a>
                                ` : '<div class="document-btn-placeholder"></div>'}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
            
            // Lazy load PDF previews when they become visible
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const iframe = entry.target;
                        if (iframe.dataset.src && !iframe.src) {
                            iframe.src = iframe.dataset.src;
                        }
                        observer.unobserve(iframe);
                    }
                });
            }, { rootMargin: '100px' });
            
            document.querySelectorAll('.document-preview-frame').forEach(iframe => {
                observer.observe(iframe);
            });
        }

        // Render albums page
        function renderAlbumsPage(container) {
            const allKeys = Object.keys(albumsInfo);
            
            // Group by producer
            const groups = {};
            allKeys.forEach(key => {
                const info = albumsInfo[key] || {};
                const producer = (info.producer || 'אנדערע').replace(/\`\`\`/g, '').trim();
                if (!groups[producer]) groups[producer] = [];
                groups[producer].push({ key, info });
            });
            
            // Sort groups
            const sortedGroupNames = Object.keys(groups).sort((a, b) => {
                if (a === 'אנדערע') return 1;
                if (b === 'אנדערע') return -1;
                return a.localeCompare(b, 'he');
            });
            
            let html = `
                <div class="page-theme-album">
                    <div class="page-title">
                        <div class="page-title-bar">אלבומס</div>
                        <div class="page-title-content">
                            <div class="subtitle">מוזיק אלבומס • ${allKeys.length} אלבומס</div>
                        </div>
                    </div>
            `;
            
            sortedGroupNames.forEach(groupName => {
                const items = groups[groupName].sort((a, b) => a.key.localeCompare(b.key, 'he'));
                
                html += `
                    <div class="category-group">
                        <div class="category-group-header album-group-header">
                            <span class="category-group-title">${groupName}</span>
                            <span class="category-group-count">${items.length}</span>
                        </div>
                        <div class="albums-grid">
                `;
                
                items.forEach(({ key, info }) => {
                    const hasImage = info.cover || info.image;
                    const coverUrl = info.cover || info.image;
                    const hasBooklet = info.booklet && info.booklet.startsWith('http');
                    const hasBuyLink = info.whereToBuy && info.whereToBuy.startsWith('http');
                    const serie = info.serie?.replace(/\`\`\`/g, '') || '';
                    const notes = info.notes?.replace(/\`\`\`/g, '') || '';
                    
                    html += `
                        <div class="album-card ${hasImage ? 'has-cover' : ''}">
                            <div class="album-card-header clickable-header" onclick="navigateToDetail('albums', '${escapeAttr(key)}')">
                                <div class="album-producer-label">${groupName}</div>
                            </div>
                            ${hasImage ? `
                                <img class="album-cover clickable-cover" src="${coverUrl}" alt="${key}" onclick="navigateToDetail('albums', '${escapeAttr(key)}')" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="album-cover-placeholder clickable-cover" style="display:none;" onclick="navigateToDetail('albums', '${escapeAttr(key)}')">♪</div>
                            ` : `
                                <div class="album-cover-placeholder clickable-cover" onclick="navigateToDetail('albums', '${escapeAttr(key)}')">♪</div>
                            `}
                            <div class="album-info">
                                <div class="album-title clickable-title" onclick="navigateToDetail('albums', '${escapeAttr(key)}')">${key}</div>
                                ${info.chatzer ? `<div class="album-chatzer"><span class="chatzer-tag" onmouseenter="showTooltip(event, '${escapeAttr(info.chatzer)}', 'chatzer')" onmouseleave="hideTooltip()" onclick="navigateToDetail('chatzeros', '${escapeAttr(info.chatzer)}')">${info.chatzer}</span></div>` : ''}
                                ${serie ? `<div class="album-serie">${serie}</div>` : ''}
                                ${info.year ? `<div class="album-year">שנת ${info.year}</div>` : ''}
                                ${notes ? `<div class="album-notes">${notes}</div>` : ''}
                            </div>
                            <div class="album-actions">
                                ${hasBooklet ? `
                                    <button class="album-booklet-btn" onclick="openPdfPopup('${encodeURIComponent(info.booklet)}', '${encodeURIComponent(key + ' - בוקלעט')}')">
                                        בוקלעט
                                    </button>
                                ` : '<div class="album-btn-placeholder"></div>'}
                                ${hasBuyLink ? `
                                    <a href="${info.whereToBuy}" target="_blank" class="album-buy-btn">
                                        צו באקומען
                                    </a>
                                ` : '<div class="album-btn-placeholder"></div>'}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }

        // Render album detail page
        function renderAlbumDetailPage(container, albumName) {
            const trimmedName = albumName.trim();
            const info = albumsInfo[trimmedName] || albumsInfo[albumName] || {};
            const hasImage = info.cover || info.image;
            const coverUrl = info.cover || info.image;
            const hasBooklet = info.booklet && info.booklet.startsWith('http');
            const hasBuyLink = info.whereToBuy && info.whereToBuy.startsWith('http');
            const producer = info.producer?.replace(/\`\`\`/g, '') || '';
            
            // Find nigunim that reference this album
            const relatedNigunim = allSongs.filter(song => 
                song.albums && song.albums.split(',').map(a => a.trim()).includes(albumName)
            );
            
            container.innerHTML = `
                <div class="detail-page page-theme-album">
                    <button class="back-button" onclick="navigateTo('albums')">
                        → אלבומס בלאט
                    </button>
                    
                    <div class="detail-header">
                        <div class="detail-category-bar" style="background: var(--color-album);">אלבום</div>
                        <div class="detail-header-content ${hasImage ? '' : 'no-image'}">
                            ${hasImage ? `<img class="detail-image" src="${coverUrl}" alt="${albumName}">` : ''}
                            <div class="detail-header-text">
                                <h1 class="detail-title" style="color: var(--color-album-dark);">${albumName}</h1>
                                ${producer ? `<div class="detail-subtitle">${producer}</div>` : ''}
                                ${info.chatzer ? `<div class="detail-chatzer"><span class="chatzer-tag" onclick="navigateToDetail('chatzeros', '${escapeAttr(info.chatzer)}')">${info.chatzer}</span></div>` : ''}
                                ${info.year ? `<div class="detail-year">שנת ${info.year}</div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${info.description || info.notes ? `
                        <div class="detail-section">
                            <h3>אינפארמאציע</h3>
                            <p>${info.description || info.notes || ''}</p>
                        </div>
                    ` : ''}
                    
                    ${(hasBooklet || hasBuyLink) ? `
                        <div class="detail-actions">
                            ${hasBooklet ? `
                                <button class="detail-action-btn album-booklet-btn" onclick="openPdfPopup('${encodeURIComponent(info.booklet)}', '${encodeURIComponent(albumName + ' - בוקלעט')}')">
                                    📄 בוקלעט
                                </button>
                            ` : ''}
                            ${hasBuyLink ? `
                                <a href="${info.whereToBuy}" target="_blank" class="detail-action-btn album-buy-btn">
                                    🛒 צו באקומען
                                </a>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Render document detail page
        function renderDocumentDetailPage(container, docName) {
            // Trim the name to handle leading/trailing spaces
            const trimmedName = docName.trim();
            const info = documentsInfo[trimmedName] || documentsInfo[docName] || {};
            
            console.log('Document detail for:', docName, '| trimmed:', trimmedName);
            console.log('info:', info);
            console.log('info.file:', info.file);
            console.log('info.allData:', info.allData);
            
            // Try to get file URL from multiple sources
            let fileUrl = info.file;
            if (!fileUrl && info.allData) {
                fileUrl = extractUrl(info.allData['פייל']) || extractUrl(info.allData['file']);
                console.log('Extracted fileUrl from allData:', fileUrl);
            }
            
            // Try to get link URL from multiple sources
            let linkUrl = info.link;
            if (!linkUrl && info.allData) {
                linkUrl = extractUrl(info.allData['לינק']) || extractUrl(info.allData['link']);
            }
            
            console.log('Final fileUrl:', fileUrl);
            console.log('Final linkUrl:', linkUrl);
            
            const hasFile = fileUrl && fileUrl.startsWith('http');
            const hasLink = linkUrl && linkUrl.startsWith('http');
            const sortType = (info.allData?.['סארט'] || info.sort || '').replace(/\`\`\`/g, '');
            
            // Find nigunim that reference this document
            const relatedNigunim = allSongs.filter(song => 
                song.documents && song.documents.split(',').map(d => d.trim()).includes(docName)
            );
            
            container.innerHTML = `
                <div class="detail-page page-theme-document">
                    <button class="back-button" onclick="navigateTo('documents')">
                        → דאקומענטן בלאט
                    </button>
                    
                    <div class="detail-header">
                        <div class="detail-category-bar" style="background: var(--color-document);">דאקומענט</div>
                        <div class="detail-header-content no-image">
                            <div class="detail-header-text">
                                <h1 class="detail-title" style="color: var(--color-document-dark);">${docName}</h1>
                                ${sortType ? `<div class="detail-type-badge" style="background: var(--color-document-pale); color: var(--color-document-dark);">${sortType}</div>` : ''}
                                ${info.serie ? `<div class="detail-subtitle">${info.serie.replace(/\`\`\`/g, '')}</div>` : ''}
                                ${info.chatzer ? `<div class="detail-chatzer"><span class="chatzer-tag" onclick="navigateToDetail('chatzeros', '${escapeAttr(info.chatzer)}')">${info.chatzer}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${hasFile ? `
                        <div class="detail-pdf-preview">
                            <iframe src="https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true" style="width:100%; height:500px; border:none; border-radius:10px;"></iframe>
                        </div>
                    ` : ''}
                    
                    ${info.description ? `
                        <div class="detail-section">
                            <h3>אינפארמאציע</h3>
                            <p>${info.description.replace(/\`\`\`/g, '').replace(/!\[.*?\]\(.*?\)/g, '')}</p>
                        </div>
                    ` : ''}
                    
                    ${(hasFile || hasLink) ? `
                        <div class="detail-actions">
                            ${hasFile ? `
                                <button class="detail-action-btn document-pdf-btn" onclick="openPdfPopup('${encodeURIComponent(fileUrl)}', '${encodeURIComponent(docName)}')">
                                    📄 עפן PDF
                                </button>
                            ` : ''}
                            ${hasLink ? `
                                <a href="${linkUrl}" target="_blank" class="detail-action-btn document-link-btn">
                                    🔗 לינק
                                </a>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${relatedNigunim.length > 0 ? `
                        <div class="detail-section">
                            <h3>פארבונדענע ניגונים (${relatedNigunim.length})</h3>
                            <div class="songs-card">
                                <div class="all-songs-grid">
                                    ${(() => {
                                        const playlistIndices = relatedNigunim.map(song => allSongs.indexOf(song));
                                        return relatedNigunim.map((song, idx) => {
                                            const globalIdx = allSongs.indexOf(song);
                                            return renderSongItem(song, globalIdx, idx + 1, playlistIndices);
                                        }).join('');
                                    })()}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Render resource detail page
        function renderResourceDetailPage(container, resourceName) {
            const trimmedName = resourceName.trim();
            const info = resourcesInfo[trimmedName] || resourcesInfo[resourceName] || {};
            let linkUrl = info.link;
            if (!linkUrl && info.allData) {
                const linkData = info.allData['לינק / נאמבער'] || info.allData['לינק'];
                if (linkData) {
                    const urlMatch = linkData.match(/https?:\/\/[^\s\)]+/);
                    if (urlMatch) linkUrl = urlMatch[0];
                }
            }
            const hasLink = linkUrl && linkUrl.startsWith('http');
            const linkText = info.allData?.['לינק / נאמבער'] || '';
            const isPhone = linkText && !linkText.includes('http') && linkText.match(/\d{3}/);
            const sortType = (info.sort || info.allData?.['סארט'] || '').replace(/\`\`\`/g, '');
            
            // Find nigunim that reference this resource
            const relatedNigunim = allSongs.filter(song => 
                song.resources && song.resources.split(',').map(r => r.trim()).includes(resourceName)
            );
            
            container.innerHTML = `
                <div class="detail-page page-theme-resource">
                    <button class="back-button" onclick="navigateTo('resources')">
                        → רעסורסן בלאט
                    </button>
                    
                    <div class="detail-header">
                        <div class="detail-category-bar" style="background: var(--color-resource);">רעסורס</div>
                        <div class="detail-header-content no-image">
                            <div class="detail-header-text">
                                <h1 class="detail-title" style="color: var(--color-resource-dark);">${resourceName}</h1>
                                ${sortType ? `<div class="detail-type-badge" style="background: var(--color-resource-pale); color: var(--color-resource-dark);">${sortType}</div>` : ''}
                                ${info.chatzer ? `<div class="detail-chatzer"><span class="chatzer-tag" onclick="navigateToDetail('chatzeros', '${escapeAttr(info.chatzer)}')">${info.chatzer}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${info.description ? `
                        <div class="detail-section">
                            <h3>אינפארמאציע</h3>
                            <p>${info.description}</p>
                        </div>
                    ` : ''}
                    
                    ${isPhone ? `
                        <div class="detail-section">
                            <h3>טעלעפאן נומער</h3>
                            <div class="resource-phone-display">${linkText.replace(/\`\`\`/g, '')}</div>
                        </div>
                    ` : ''}
                    
                    ${hasLink ? `
                        <div class="detail-actions">
                            <a href="${linkUrl}" target="_blank" class="detail-action-btn resource-link-btn">
                                🔗 עפן לינק
                            </a>
                        </div>
                    ` : ''}
                    
                    ${relatedNigunim.length > 0 ? `
                        <div class="detail-section">
                            <h3>פארבונדענע ניגונים (${relatedNigunim.length})</h3>
                            <div class="songs-card">
                                <div class="all-songs-grid">
                                    ${(() => {
                                        const playlistIndices = relatedNigunim.map(song => allSongs.indexOf(song));
                                        return relatedNigunim.map((song, idx) => {
                                            const globalIdx = allSongs.indexOf(song);
                                            return renderSongItem(song, globalIdx, idx + 1, playlistIndices);
                                        }).join('');
                                    })()}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Toggle category card - no longer needed but keep for compatibility
        function toggleCategoryCard(encodedKey, categoryKey) {
            navigateToDetail(categoryKey, encodedKey);
        }

        // Hover tooltip functionality
        const hoverTooltip = document.getElementById('hoverTooltip');
        let tooltipTimeout = null;

        function showTooltip(event, value, fieldType) {
            clearTimeout(tooltipTimeout);
            
            // Decode the value if it was encoded
            const decodedValue = decodeAttr(value);
            
            const tooltip = hoverTooltip;
            const typeEl = document.getElementById('tooltipType');
            const titleEl = document.getElementById('tooltipTitle');
            const imageEl = document.getElementById('tooltipImage');
            const subtitleEl = document.getElementById('tooltipSubtitle');
            const statsEl = document.getElementById('tooltipStats');
            
            // Remove all theme classes first
            tooltip.classList.remove('tooltip-chatzer', 'tooltip-mechaber', 'tooltip-verter', 'tooltip-zman', 'tooltip-piyut', 'tooltip-collection');
            
            // Get info based on field type
            let categoryKey = '';
            let typeName = '';
            let extraInfo = null;
            let themeClass = '';
            
            switch(fieldType) {
                case 'mechaber':
                    categoryKey = 'mechabrim';
                    typeName = 'מחבר';
                    extraInfo = mechabrimInfo[decodedValue];
                    themeClass = 'tooltip-mechaber';
                    break;
                case 'chatzer':
                    categoryKey = 'chatzeros';
                    typeName = 'חצר';
                    extraInfo = chatzerosInfo[decodedValue];
                    themeClass = 'tooltip-chatzer';
                    break;
                case 'verter':
                    categoryKey = 'verter';
                    typeName = 'ווערטער';
                    extraInfo = verterInfo[decodedValue];
                    themeClass = 'tooltip-verter';
                    break;
                case 'zman':
                    categoryKey = 'zmanim';
                    // Check if it's a piyut or zman
                    if (piyutimInfo[decodedValue]) {
                        typeName = 'פיוט';
                        extraInfo = piyutimInfo[decodedValue];
                        themeClass = 'tooltip-piyut';
                    } else {
                        typeName = 'זמן';
                        extraInfo = zmaninInfo[decodedValue];
                        themeClass = 'tooltip-zman';
                    }
                    break;
                case 'piyut':
                    categoryKey = 'zmanim';
                    typeName = 'פיוט';
                    extraInfo = piyutimInfo[decodedValue];
                    themeClass = 'tooltip-piyut';
                    break;
                case 'collection':
                    categoryKey = 'collections';
                    typeName = 'קאלעקשאן';
                    extraInfo = collectionsInfo[decodedValue];
                    themeClass = 'tooltip-collection';
                    break;
            }
            
            // Add theme class
            if (themeClass) {
                tooltip.classList.add(themeClass);
            }
            
            // Set type label
            typeEl.textContent = typeName;
            
            // For mechaber, build full name
            let displayName = decodedValue;
            if (fieldType === 'mechaber' && extraInfo) {
                const nameParts = [extraInfo.title, extraInfo.firstName, extraInfo.lastName, extraInfo.suffix].filter(Boolean);
                if (nameParts.length > 0) {
                    displayName = nameParts.join(' ');
                }
            }
            titleEl.textContent = displayName;
            
            // Handle image
            if (extraInfo && extraInfo.image) {
                imageEl.src = extraInfo.image;
                imageEl.style.display = 'block';
                // Make mechaber images round
                if (fieldType === 'mechaber') {
                    imageEl.classList.add('round');
                } else {
                    imageEl.classList.remove('round');
                }
            } else {
                imageEl.style.display = 'none';
                imageEl.classList.remove('round');
            }
            
            // Handle subtitle (dates for mechabrim)
            let subtitle = '';
            if (extraInfo && fieldType === 'mechaber') {
                const birthParts = [extraInfo.birthDay, extraInfo.birthMonth, extraInfo.birthYear].filter(Boolean);
                const deathParts = [extraInfo.deathDay, extraInfo.deathMonth, extraInfo.deathYear].filter(Boolean);
                const birthStr = birthParts.join(' ');
                const deathStr = deathParts.join(' ');
                
                if (birthStr && deathStr) {
                    subtitle = `${birthStr} - ${deathStr}`;
                } else if (birthStr) {
                    subtitle = `נולד: ${birthStr}`;
                } else if (deathStr) {
                    subtitle = `נפטר: ${deathStr}`;
                }
            }
            subtitleEl.textContent = subtitle;
            subtitleEl.style.display = subtitle ? 'block' : 'none';
            
            // Build stats
            const songIndices = categories[categoryKey]?.[decodedValue] || [];
            const songCount = songIndices.length;
            
            let statsHtml = `${songCount} ניגונים`;
            
            // For chatzeros, count mechabrim
            if (fieldType === 'chatzer') {
                const mechabrimCount = Object.entries(mechabrimInfo)
                    .filter(([mechName, mechInfo]) => {
                        if (!mechInfo.chatzer) return false;
                        const mechChatzeros = mechInfo.chatzer.split(',').map(c => c.trim());
                        return mechChatzeros.includes(decodedValue);
                    }).length;
                if (mechabrimCount > 0) {
                    statsHtml = `${mechabrimCount} מחברים · ${statsHtml}`;
                }
            }
            
            statsEl.textContent = statsHtml;
            
            // Position tooltip near mouse
            const x = event.clientX;
            const y = event.clientY;
            
            tooltip.style.left = `${Math.min(x + 15, window.innerWidth - 300)}px`;
            tooltip.style.top = `${Math.min(y + 15, window.innerHeight - 200)}px`;
            
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            tooltipTimeout = setTimeout(() => {
                hoverTooltip.classList.remove('show');
            }, 100);
        }

        // Create meta links for song items (handles multiple comma-separated values)
        function createMetaLinks(value, page, filterKey) {
            if (!value) return '';
            const values = value.split(',').map(v => v.trim()).filter(Boolean);
            return values.map(v => 
                `<a href="#" class="song-meta-link" 
                    onclick="navigateToWithFilter('${page}', '${filterKey}', '${escapeAttr(v)}'); event.stopPropagation();"
                    onmouseenter="showTooltip(event, '${escapeAttr(v)}', '${filterKey}')"
                    onmouseleave="hideTooltip()">${v}</a>`
            ).join(', ');
        }

        // Render song item
        function renderSongItem(song, globalIdx, displayNum, playlistIndices = null) {
            const isActive = globalIdx === currentSongIndex;
            const hasAudio = song.audioUrl && song.audioUrl.startsWith('http');
            
            // Create meta with links
            let metaParts = [];
            if (song.mechaber) {
                metaParts.push(createMetaLinks(song.mechaber, 'mechabrim', 'mechaber'));
            }
            if (song.category) {
                metaParts.push(createMetaLinks(song.category, 'chatzeros', 'chatzer'));
            }
            
            // If no audio, clicking shows details instead of playing
            const clickAction = hasAudio 
                ? (playlistIndices 
                    ? `playSongFromList(${globalIdx}, [${playlistIndices.join(',')}])`
                    : `playSong(${globalIdx})`)
                : `showSongDetails(${globalIdx})`;
            
            return `
                <div class="song-item ${isActive ? 'active' : ''} ${!hasAudio ? 'no-audio' : ''}" data-song-idx="${globalIdx}" onclick="${clickAction}">
                    <div class="song-number">${displayNum}</div>
                    <div class="song-info">
                        <div class="song-name">${song.name}</div>
                        <div class="song-meta">${metaParts.join(' • ')}</div>
                    </div>
                    <button class="song-details-btn" onclick="event.stopPropagation(); showSongDetails(${globalIdx});">דעטאלן</button>
                </div>
            `;
        }

        // Go to page
        function goToPage(page) {
            const totalPages = Math.ceil(filteredSongs.length / songsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderCurrentPage();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Play song (sets playlist if not already set)
        function playSong(idx, playlist = null) {
            if (idx < 0 || idx >= allSongs.length) return;
            
            // Reset recordings mode when playing from song list
            isInRecordingsMode = false;
            currentRecordingIndex = 0;
            
            // If a playlist is provided, use it
            if (playlist && Array.isArray(playlist)) {
                currentPlaylist = playlist;
                currentPlaylistPosition = currentPlaylist.indexOf(idx);
            } else if (currentPlaylist.length === 0 || !currentPlaylist.includes(idx)) {
                // If no playlist set or song not in current playlist, use filteredSongs
                currentPlaylist = filteredSongs.map(s => allSongs.indexOf(s));
                currentPlaylistPosition = currentPlaylist.indexOf(idx);
            } else {
                // Song is in current playlist, just update position
                currentPlaylistPosition = currentPlaylist.indexOf(idx);
            }
            
            currentSongIndex = idx;
            const song = allSongs[idx];
            
            audioPlayer.src = song.audioUrl;
            audioPlayer.play();
            
            updatePlayerUI(song);
            updateActiveSongInList();
        }
        
        // Play song from a specific playlist (detail pages)
        function playSongFromList(idx, playlistIndices) {
            currentPlaylist = playlistIndices;
            currentPlaylistPosition = playlistIndices.indexOf(idx);
            playSong(idx, playlistIndices);
        }

        // Play a collection from the start
        function playCollectionFromStart(collectionName) {
            const decodedName = decodeAttr(collectionName);
            const trimmedName = decodedName.trim();
            console.log('Playing collection:', trimmedName);
            console.log('Available collections:', Object.keys(categories.collections));
            
            const songIndices = categories.collections[trimmedName] || categories.collections[decodedName] || [];
            console.log('Song indices:', songIndices);
            
            if (songIndices.length === 0) {
                console.log('No songs found for collection');
                return;
            }
            
            // Filter to only songs with audio
            const playableSongs = songIndices.filter(idx => {
                const song = allSongs[idx];
                return song && song.audioUrl && song.audioUrl.startsWith('http');
            });
            
            console.log('Playable songs:', playableSongs);
            
            if (playableSongs.length === 0) {
                console.log('No playable songs');
                return;
            }
            
            // Set playlist and play first song
            currentPlaylist = playableSongs;
            currentPlaylistPosition = 0;
            playSong(playableSongs[0], playableSongs);
        }

        // Play a music category (scale or ritem)
        function playMusicCategory(categoryType, categoryName) {
            const decodedName = decodeAttr(categoryName);
            const trimmedName = decodedName.trim();
            
            const categoryData = categoryType === 'scale' ? categories.scale : categories.ritem;
            const songIndices = categoryData[trimmedName] || categoryData[decodedName] || [];
            
            if (songIndices.length === 0) return;
            
            // Filter to only songs with audio
            const playableSongs = songIndices.filter(idx => {
                const song = allSongs[idx];
                return song && song.audioUrl && song.audioUrl.startsWith('http');
            });
            
            if (playableSongs.length === 0) return;
            
            // Set playlist and play first song
            currentPlaylist = playableSongs;
            currentPlaylistPosition = 0;
            playSong(playableSongs[0], playableSongs);
        }

        // Play a specific recording from a song
        function playRecording(songIdx, recordingIdx) {
            const song = allSongs[songIdx];
            if (!song || !song.recordings || !song.recordings[recordingIdx]) return;
            
            const recording = song.recordings[recordingIdx];
            
            // Update current song index
            currentSongIndex = songIdx;
            
            // Play the specific recording URL
            audioPlayer.src = recording.url;
            audioPlayer.play();
            
            // Update player UI with song info
            updatePlayerUI(song);
            updateActiveSongInList();
            
            // Update active state in modal
            document.querySelectorAll('.modal-recording-item').forEach((item, i) => {
                item.classList.toggle('active', i === recordingIdx);
            });
        }

        // Create player meta links (handles multiple comma-separated values)
        function createPlayerMetaLinks(value, page, filterKey) {
            if (!value) return '';
            const values = value.split(',').map(v => v.trim()).filter(Boolean);
            return values.map(v => 
                `<a href="#" class="player-meta-link" 
                    onclick="navigateToWithFilter('${page}', '${filterKey}', '${escapeAttr(v)}'); event.preventDefault();"
                    onmouseenter="showTooltip(event, '${escapeAttr(v)}', '${filterKey}')"
                    onmouseleave="hideTooltip()">${v}</a>`
            ).join(', ');
        }

        // Update player UI
        function updatePlayerUI(song) {
            document.getElementById('playerSongName').textContent = song.name;
            
            // Create meta with links
            let metaParts = [];
            if (song.mechaber) {
                metaParts.push(createPlayerMetaLinks(song.mechaber, 'mechabrim', 'mechaber'));
            }
            if (song.category) {
                metaParts.push(createPlayerMetaLinks(song.category, 'chatzeros', 'chatzer'));
            }
            document.getElementById('playerSongMeta').innerHTML = metaParts.join(' • ');
            
            // Collection link
            if (song.collections) {
                document.getElementById('playerCollection').innerHTML = createPlayerMetaLinks(song.collections, 'collections', 'collection');
            } else {
                document.getElementById('playerCollection').textContent = '';
            }
            
            document.getElementById('playerGezungen').textContent = song.gezungen ? `געזונגען: ${song.gezungen}` : '';
            document.getElementById('playPauseBtn').textContent = '⏸';
        }

        // Update active song highlight
        function updateActiveSongInList() {
            document.querySelectorAll('.song-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and mark the currently playing song
            if (currentSongIndex >= 0) {
                const activeItem = document.querySelector(`.song-item[data-song-idx="${currentSongIndex}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }

        // Toggle play/pause
        function togglePlayPause() {
            if (audioPlayer.paused) {
                audioPlayer.play();
                document.getElementById('playPauseBtn').textContent = '⏸';
            } else {
                audioPlayer.pause();
                document.getElementById('playPauseBtn').textContent = '▶';
            }
        }

        // Play previous
        function playPrevious() {
            // If in recordings mode, go to previous recording
            if (isInRecordingsMode && currentSongIndex >= 0) {
                const song = allSongs[currentSongIndex];
                if (song && song.recordings && currentRecordingIndex > 0) {
                    playNigunRecording(currentSongIndex, currentRecordingIndex - 1, null);
                    return;
                }
            }
            
            // Otherwise, go to previous song in playlist (skip songs without audio)
            if (currentPlaylist.length > 0) {
                let newPosition = currentPlaylistPosition - 1;
                while (newPosition >= 0) {
                    const songIdx = currentPlaylist[newPosition];
                    const song = allSongs[songIdx];
                    if (song && song.audioUrl && song.audioUrl.startsWith('http')) {
                        currentPlaylistPosition = newPosition;
                        isInRecordingsMode = false;
                        currentRecordingIndex = 0;
                        playSong(songIdx, currentPlaylist);
                        return;
                    }
                    newPosition--;
                }
            }
        }

        // Play next
        function playNext() {
            // If in recordings mode, go to next recording
            if (isInRecordingsMode && currentSongIndex >= 0) {
                const song = allSongs[currentSongIndex];
                if (song && song.recordings && currentRecordingIndex < song.recordings.length - 1) {
                    playNigunRecording(currentSongIndex, currentRecordingIndex + 1, null);
                    return;
                }
            }
            
            // Otherwise, go to next song in playlist (skip songs without audio)
            if (currentPlaylist.length > 0) {
                let newPosition = currentPlaylistPosition + 1;
                while (newPosition < currentPlaylist.length) {
                    const songIdx = currentPlaylist[newPosition];
                    const song = allSongs[songIdx];
                    if (song && song.audioUrl && song.audioUrl.startsWith('http')) {
                        currentPlaylistPosition = newPosition;
                        isInRecordingsMode = false;
                        currentRecordingIndex = 0;
                        playSong(songIdx, currentPlaylist);
                        return;
                    }
                    newPosition++;
                }
            }
        }

        // Seek to position
        function seekTo(event) {
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        }

        // Format time
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Audio event listeners
        audioPlayer.addEventListener('timeupdate', () => {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            document.getElementById('duration').textContent = formatTime(audioPlayer.duration);
        });

        audioPlayer.addEventListener('ended', () => {
            playNext();
        });

        audioPlayer.addEventListener('pause', () => {
            document.getElementById('playPauseBtn').textContent = '▶';
        });

        audioPlayer.addEventListener('play', () => {
            document.getElementById('playPauseBtn').textContent = '⏸';
        });

        // Create clickable link for a field value
        function createFieldLink(value, fieldType) {
            if (!value) return '';
            
            // Split by comma for multiple values
            const values = value.split(',').map(v => v.trim()).filter(Boolean);
            
            return values.map(v => {
                let page = '';
                let filterKey = '';
                
                switch(fieldType) {
                    case 'mechaber':
                        page = 'mechabrim';
                        filterKey = 'mechaber';
                        break;
                    case 'chatzer':
                        page = 'chatzeros';
                        filterKey = 'chatzer';
                        break;
                    case 'verter':
                        page = 'verter';
                        filterKey = 'verter';
                        break;
                    case 'zman':
                        page = 'zmanim';
                        filterKey = 'zman';
                        break;
                    case 'collection':
                        page = 'collections';
                        filterKey = 'collection';
                        break;
                    case 'scale':
                        page = 'songs';
                        filterKey = 'scale';
                        break;
                    case 'ritem':
                        page = 'songs';
                        filterKey = 'ritem';
                        break;
                    case 'gezungen':
                        page = 'songs';
                        filterKey = 'gezungen';
                        break;
                    case 'maure':
                        page = 'songs';
                        filterKey = 'maure';
                        break;
                    default:
                        return v; // No link for other fields
                }
                
                return `<a href="#" class="field-link" 
                    onclick="navigateToWithFilter('${page}', '${filterKey}', '${escapeAttr(v)}'); closeModal(); event.preventDefault();"
                    onmouseenter="showTooltip(event, '${escapeAttr(v)}', '${filterKey}')"
                    onmouseleave="hideTooltip()">${v}</a>`;
            }).join(' ');
        }

        // Navigate to page with filter applied (opens detail page)
        function navigateToWithFilter(page, filterKey, value) {
            // Decode the value if it was encoded
            const decodedValue = decodeAttr(value);
            
            // Handle scale, rhythm, gezungen, maure - filter songs page
            if (filterKey === 'scale' || filterKey === 'ritem' || filterKey === 'gezungen' || filterKey === 'maure') {
                // Reset all filters first
                activeFilters = {
                    chatzer: [],
                    mechaber: [],
                    verter: [],
                    zman: [],
                    collection: [],
                    scale: [],
                    ritem: [],
                    gezungen: [],
                    maure: []
                };
                
                // Set the specific filter
                activeFilters[filterKey] = [decodedValue];
                
                // Filter songs
                applyFilters();
                
                currentDetailView = null;
                currentPageView = 'songs';
                
                // Update nav buttons
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.page === 'songs');
                });
                
                updateURL();
                renderCurrentPage();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }
            
            // Map page to category key
            const categoryMap = {
                'chatzeros': 'chatzeros',
                'mechabrim': 'mechabrim',
                'verter': 'verter',
                'zmanim': 'zmanim',
                'collections': 'collections'
            };
            
            const categoryKey = categoryMap[page];
            if (categoryKey) {
                // Navigate to detail page for this item
                navigateToDetail(categoryKey, encodeURIComponent(decodedValue));
            }
        }

        // Show song details
        function showSongDetails(idx) {
            const song = allSongs[idx];
            if (!song) return;
            
            // Navigate to nigun detail page
            currentDetailView = { type: 'nigun', name: song.name, id: song.rowId, customId: song.customId };
            currentPageView = 'songs';
            updateURL();
            renderDetailPage();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Wrapper to show details without playing
        function showDetailsOnly(event, idx) {
            event.stopPropagation();
            event.preventDefault();
            showSongDetails(idx);
        }

        // Close modal
        function closeModal() {
            document.getElementById('songModal').classList.remove('show');
        }

        // Close modal on outside click
        document.getElementById('songModal').addEventListener('click', (e) => {
            if (e.target.id === 'songModal') closeModal();
        });

        // PDF Popup functions
        function openPdfPopup(encodedUrl, encodedTitle) {
            const url = decodeURIComponent(encodedUrl);
            const title = decodeURIComponent(encodedTitle);
            
            // Use Google Docs viewer to display PDF inline
            const viewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;
            
            document.getElementById('pdfPopupTitle').textContent = title;
            document.getElementById('pdfPopupFrame').src = viewerUrl;
            document.getElementById('pdfDownloadLink').href = url;
            document.getElementById('pdfPopup').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closePdfPopup(event) {
            if (event && event.target !== document.getElementById('pdfPopup')) return;
            document.getElementById('pdfPopup').classList.remove('show');
            document.getElementById('pdfPopupFrame').src = '';
            document.body.style.overflow = '';
        }

        // Close PDF popup on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePdfPopup();
            }
        });

        // Global search
        function handleGlobalSearch(term) {
            // Don't search on every keystroke - wait for Enter
        }

        function executeGlobalSearch() {
            const input = document.getElementById('globalSearch');
            const term = input?.value?.trim();
            
            if (!term) return;

            searchQuery = term;
            currentPage = 1;
            currentPageView = 'search';
            currentDetailView = null;
            updateURL();
            renderCurrentPage();
        }

        // Render search results page
        function renderSearchResultsPage(container) {
            const term = searchQuery.toLowerCase();
            
            // Helper function to search in an info object
            function searchInInfo(info, term) {
                if (!info) return false;
                // Search in all properties
                for (const key of Object.keys(info)) {
                    const val = info[key];
                    if (typeof val === 'string' && val.toLowerCase().includes(term)) return true;
                    if (Array.isArray(val) && val.some(v => typeof v === 'string' && v.toLowerCase().includes(term))) return true;
                }
                // Search in allData
                if (info.allData) {
                    for (const key of Object.keys(info.allData)) {
                        const val = info.allData[key];
                        if (typeof val === 'string' && val.toLowerCase().includes(term)) return true;
                    }
                }
                return false;
            }
            
            // Search in songs
            const matchingSongs = allSongs.filter(song => {
                if (audioOnlyFilter && !song.audioUrl) return false;
                const searchableText = [
                    song.name,
                    song.mechaber,
                    song.category,
                    song.verter,
                    song.collections,
                    song.pasigOif,
                    song.info,
                    song.siman
                ].filter(Boolean).join(' ').toLowerCase();
                return searchableText.includes(term);
            });

            // Search in chatzeros (name and all info)
            const matchingChatzeros = Object.keys(categories.chatzeros || {}).filter(name => {
                if (name.toLowerCase().includes(term)) return true;
                return searchInInfo(chatzerosInfo?.[name], term);
            });

            // Search in mechabrim (name and all info)
            const matchingMechabrim = Object.keys(categories.mechabrim || {}).filter(name => {
                if (name.toLowerCase().includes(term)) return true;
                return searchInInfo(mechabrimInfo?.[name], term);
            });

            // Search in collections (name and all info)
            const matchingCollections = Object.keys(categories.collections || {}).filter(name => {
                if (name.toLowerCase().includes(term)) return true;
                return searchInInfo(collectionsInfo?.[name], term);
            });

            // Search in verter (name and all info)
            const matchingVerter = Object.keys(categories.verter || {}).filter(name => {
                if (name.toLowerCase().includes(term)) return true;
                return searchInInfo(verterInfo?.[name], term);
            });

            // Search in zmanim (name and all info)
            const matchingZmanim = Object.keys(zmaninInfo || {}).filter(name => {
                if (name.toLowerCase().includes(term)) return true;
                return searchInInfo(zmaninInfo?.[name], term);
            });

            // Search in albums (name and all info)
            const matchingAlbums = Object.keys(albumsInfo || {}).filter(name => {
                if (name.toLowerCase().includes(term)) return true;
                return searchInInfo(albumsInfo?.[name], term);
            });

            // Search in scale
            const matchingScale = Object.keys(categories.scale || {}).filter(name => 
                name.toLowerCase().includes(term)
            );

            // Search in ritem
            const matchingRitem = Object.keys(categories.ritem || {}).filter(name => 
                name.toLowerCase().includes(term)
            );

            // Search in gezungen
            const matchingGezungen = Object.keys(categories.gezungen || {}).filter(name => 
                name.toLowerCase().includes(term)
            );

            const totalResults = matchingSongs.length + matchingChatzeros.length + 
                                 matchingMechabrim.length + matchingCollections.length + 
                                 matchingVerter.length + matchingZmanim.length + matchingAlbums.length +
                                 matchingScale.length + matchingRitem.length + matchingGezungen.length;

            let html = `
                <div class="page-theme-nigun">
                    <div class="page-title">
                        <div class="page-title-bar">רעזולטאטן פאר "${searchQuery}"</div>
                        <div class="page-title-content">
                            <div class="subtitle">${totalResults} רעזולטאטן געפונען</div>
                        </div>
                    </div>
            `;

            // Nigunim section - use song-item style
            if (matchingSongs.length > 0) {
                const displaySongs = matchingSongs.slice(0, 10);
                html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-nigun);">🎵 ניגונים (${matchingSongs.length})</h3>
                            ${matchingSongs.length > 10 ? `<button class="see-all-btn" onclick="navigateTo('songs');">זע אלע →</button>` : ''}
                        </div>
                        <div class="search-songs-list">
                            ${displaySongs.map((song, idx) => {
                                const globalIdx = allSongs.indexOf(song);
                                const hasAudio = !!song.audioUrl;
                                const escapedName = escapeAttr(song.name);
                                const metaParts = [song.mechaber, song.category].filter(Boolean);
                                return `
                                    <div class="song-item ${!hasAudio ? 'no-audio' : ''}" onclick="${hasAudio ? `playSong(${globalIdx})` : `showSongDetails(${globalIdx})`}">
                                        <div class="song-number">${idx + 1}</div>
                                        <div class="song-info">
                                            <div class="song-name">${song.name}</div>
                                            <div class="song-meta">${metaParts.join(' • ')}</div>
                                        </div>
                                        <button class="song-details-btn" onclick="event.stopPropagation(); showSongDetails(${globalIdx});">דעטאלן</button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // Albums section
            if (matchingAlbums.length > 0) {
                html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-album);">💿 אלבומס (${matchingAlbums.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingAlbums.map(name => {
                                const albumData = albumsInfo[name];
                                return `
                                <div class="search-result-card" onclick="navigateToDetail('albums', '${escapeAttr(name)}')" style="border-right-color: var(--color-album);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${albumData?.songs?.length || 0} ניגונים</div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
            }

            // Chatzeros section
            if (matchingChatzeros.length > 0) {
                html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-chatzer);">🏛️ חצרות (${matchingChatzeros.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingChatzeros.map(name => `
                                <div class="search-result-card" onclick="navigateToDetail('chatzeros', '${escapeAttr(name)}')" style="border-right-color: var(--color-chatzer);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.chatzeros[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Mechabrim section
            if (matchingMechabrim.length > 0) {
                html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-mechaber);">👤 מחברים (${matchingMechabrim.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingMechabrim.map(name => `
                                <div class="search-result-card" onclick="navigateToDetail('mechabrim', '${escapeAttr(name)}')" style="border-right-color: var(--color-mechaber);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.mechabrim[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Collections section
            if (matchingCollections.length > 0) {
                html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-collection);">📁 קאלעקשאנס (${matchingCollections.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingCollections.map(name => `
                                <div class="search-result-card" onclick="navigateToDetail('collections', '${escapeAttr(name)}')" style="border-right-color: var(--color-collection);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.collections[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Verter section
            if (matchingVerter.length > 0) {
                html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-verter);">📝 ווערטער (${matchingVerter.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingVerter.map(name => `
                                <div class="search-result-card" onclick="navigateToDetail('verter', '${escapeAttr(name)}')" style="border-right-color: var(--color-verter);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.verter[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Zmanim section
            if (matchingZmanim.length > 0) {
                html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-zman);">📅 זמנים (${matchingZmanim.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingZmanim.map(name => `
                                <div class="search-result-card" onclick="navigateToZmanDetail('${escapeAttr(name)}')" style="border-right-color: var(--color-zman);">
                                    <div class="result-name">${name}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Gezungen section
            if (matchingGezungen.length > 0) {
                html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: #2e8b2e;">🎤 געזונגען אויף (${matchingGezungen.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingGezungen.map(name => `
                                <div class="search-result-card" onclick="navigateToWithFilter('songs', 'gezungen', '${escapeAttr(name)}')" style="border-right-color: #2e8b2e;">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.gezungen[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Ritem section
            if (matchingRitem.length > 0) {
                html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-music);">🥁 ריטעם (${matchingRitem.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingRitem.map(name => `
                                <div class="search-result-card" onclick="navigateToWithFilter('songs', 'ritem', '${escapeAttr(name)}')" style="border-right-color: var(--color-music);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.ritem[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Scale section
            if (matchingScale.length > 0) {
                html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-nigun);">🎼 סקעיל (${matchingScale.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingScale.map(name => `
                                <div class="search-result-card" onclick="navigateToWithFilter('songs', 'scale', '${escapeAttr(name)}')" style="border-right-color: var(--color-nigun);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.scale[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (totalResults === 0) {
                html += `
                    <div class="no-results">
                        <div class="no-results-icon">🔍</div>
                        <p>קיין רעזולטאטן נישט געפונען פאר "${searchQuery}"</p>
                        <p class="no-results-hint">פרובירט א אנדער זוך</p>
                    </div>
                `;
            }

            html += `</div>`;
            container.innerHTML = html;
        }

        // Close dropdowns on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-dropdown-content').forEach(d => d.classList.remove('show'));
            }
            
            // Close sidebar dropdowns only when clicking outside
            if (!e.target.closest('.sidebar-filter-dropdown')) {
                document.querySelectorAll('.sidebar-dropdown-content').forEach(d => d.classList.remove('show'));
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            if (e.code === 'Space') {
                e.preventDefault();
                togglePlayPause();
            } else if (e.code === 'ArrowRight') {
                playPrevious();
            } else if (e.code === 'ArrowLeft') {
                playNext();
            }
        });
        
        // Image modal functions
        function openImageModal(imageUrl) {
            let modal = document.getElementById('imageModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'imageModal';
                modal.className = 'image-modal';
                modal.innerHTML = `
                    <button class="image-modal-close" onclick="closeImageModal()">×</button>
                    <img src="" id="imageModalImg">
                `;
                modal.onclick = function(e) {
                    if (e.target === modal) closeImageModal();
                };
                document.body.appendChild(modal);
            }
            document.getElementById('imageModalImg').src = imageUrl;
            modal.classList.add('active');
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) modal.classList.remove('active');
        }

        // Register Service Worker for caching
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then((registration) => {
                    console.log('Service Worker registered:', registration.scope);
                })
                .catch((error) => {
                    console.log('Service Worker registration failed:', error);
                });
        }

        // Initialize
        fetchSongs();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="yi" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>אוצר הניגונים</title>
    <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='80' font-size='80' text-anchor='middle'%3E♪%3C/text%3E%3C/svg%3E">
    <link
        href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&family=Rubik:wght@300;400;500;600;700&family=David+Libre:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-deep: #4a1259;
            --primary: #7b1fa2;
            --primary-light: #ae52d4;
            --primary-pale: #f3e5f5;
            --accent-gold: #d4af37;
            --accent-warm: #ff6f61;
            --bg-cream: #faf8f5;
            --text-dark: #2c2c2c;
            --text-muted: #666;
            --text-secondary: #888;
            --card-shadow: 0 4px 24px rgba(74, 18, 89, 0.12);
            --card-hover-shadow: 0 12px 40px rgba(74, 18, 89, 0.2);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            /* Category Colors */
            /* חצרות - Purple */
            --color-chatzer: #9c5bb5;
            --color-chatzer-light: #c48fd7;
            --color-chatzer-dark: #7b3f96;
            --color-chatzer-pale: #f3e5f5;

            /* מחברים - Magenta/Pink */
            --color-mechaber: #c435a8;
            --color-mechaber-light: #e066c7;
            --color-mechaber-dark: #9c1b82;
            --color-mechaber-pale: #fce4ec;

            /* ווערטער - Gray */
            --color-verter: #6b7280;
            --color-verter-light: #9ca3af;
            --color-verter-dark: #4b5563;
            --color-verter-pale: #f3f4f6;

            /* זמנים/מועדים - Orange */
            --color-zman: #e96a1b;
            --color-zman-light: #ff8c42;
            --color-zman-dark: #c54e00;
            --color-zman-pale: #fff3e0;

            /* קאלעקשאנס - Red */
            --color-collection: #c62828;
            --color-collection-light: #ef5350;
            --color-collection-dark: #8e0000;
            --color-collection-pale: #ffebee;

            /* פיוטים - Green */
            --color-piyut: #2e8b2e;
            --color-piyut-light: #81c784;
            --color-piyut-dark: #1b5e20;
            --color-piyut-pale: #e8f5e9;

            /* ניגונים - Blue */
            --color-nigun: #4a7cc9;
            --color-nigun-light: #7aa3e0;
            --color-nigun-dark: #2d5aa0;
            --color-nigun-pale: #e3f2fd;

            /* מוזיק/ריטעם - Gold/Yellow */
            --color-music: #d4ac12;
            --color-music-light: #f0c040;
            --color-music-dark: #b8960c;
            --color-music-pale: #fff8e1;

            /* רעסורסן - Light Blue/Cyan */
            --color-resource: #5bc0de;
            --color-resource-light: #8cd4eb;
            --color-resource-dark: #31a5c7;
            --color-resource-pale: #e0f7fa;

            /* דאקומענטן - Teal/Cyan */
            --color-document: #00a0b0;
            --color-document-light: #4dd0e1;
            --color-document-dark: #007c8a;
            --color-document-pale: #e0f7fa;

            /* אלבומס - Teal */
            --color-album: #00838f;
            --color-album-light: #4fb3bf;
            --color-album-dark: #005662;
            --color-album-pale: #e0f7fa;

            /* ארכיוון - Teal (same as albums) */
            --color-archive: #00838f;

            /* גרעידיענט טהעמע - Home/General - combining ניגונים, מחברים, חצרות */
            --gradient-main: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-chatzer) 50%, var(--color-mechaber) 100%);
            --gradient-main-reverse: linear-gradient(135deg, var(--color-mechaber) 0%, var(--color-chatzer) 50%, var(--color-nigun) 100%);
            --gradient-main-vertical: linear-gradient(180deg, var(--color-nigun) 0%, var(--color-chatzer) 50%, var(--color-mechaber) 100%);
            --gradient-main-soft: linear-gradient(135deg, var(--color-nigun-light) 0%, var(--color-chatzer-light) 50%, var(--color-mechaber-light) 100%);
            --gradient-main-pale: linear-gradient(135deg, var(--color-nigun-pale) 0%, var(--color-chatzer-pale) 50%, var(--color-mechaber-pale) 100%);
            --gradient-main-dark: linear-gradient(135deg, var(--color-nigun-dark) 0%, var(--color-chatzer-dark) 50%, var(--color-mechaber-dark) 100%);
            /* Combined pale color for home page background */
            --color-home-pale: color-mix(in srgb, var(--color-nigun-pale) 33%, color-mix(in srgb, var(--color-chatzer-pale) 50%, var(--color-mechaber-pale)));
        }

        /* Full page background color */
        html {
            background: #f8fafc;
        }

        /* Global rule: Remove underlines from all links and buttons */
        a,
        button,
        .nigun-tag,
        .chatzer-tag,
        .nigun-tag-inline,
        .nigun-modal-mechaber-name,
        .nigun-modal-mechaber-profile,
        .nigun-mechaber-card,
        .nigun-mechaber-name {
            text-decoration: none !important;
        }

        a:hover,
        button:hover {
            text-decoration: none !important;
        }

        /* Loading wave bar animation */
        .loading-wave-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .loading-wave-bar.active {
            opacity: 1;
        }

        .loading-wave-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.5) 25%,
                    white 50%,
                    rgba(255, 255, 255, 0.5) 75%,
                    transparent 100%);
            animation: loadingWave 1.5s infinite ease-in-out;
        }

        @keyframes loadingWave {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .page-title-content {
            position: relative;
        }

        /* Musical notes loader animation */
        /* --- LOADER TINY CSS --- */
        .loader-tiny {
            position: relative;
            width: 40px;
            height: 20px;
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
            overflow: visible;
        }

        .loader-tiny .note {
            position: absolute;
            bottom: 0;
            color: var(--color-nigun);
            font-size: 11px;
            opacity: 0;
            will-change: transform, opacity;
        }

        /* Note 1 */
        .loader-tiny .note.n1 {
            left: 15%;
            animation: floatTinyLeft 2.8s infinite ease-out;
        }

        /* Note 2 */
        .loader-tiny .note.n2 {
            left: 50%;
            animation: floatTinyRight 3.2s infinite ease-out;
            animation-delay: 1s;
        }

        /* Note 3 */
        .loader-tiny .note.n3 {
            left: 85%;
            animation: floatTinyCenter 2.5s infinite ease-out;
            animation-delay: 2s;
        }

        @keyframes floatTinyLeft {
            0% {
                transform: translate(5px, 2px) rotate(-5deg) scale(0.8);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 0.8;
            }

            100% {
                transform: translate(-10px, -20px) rotate(-10deg) scale(1.0);
                opacity: 0;
            }
        }

        @keyframes floatTinyRight {
            0% {
                transform: translate(-5px, 2px) rotate(5deg) scale(0.8);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 0.8;
            }

            100% {
                transform: translate(10px, -20px) rotate(10deg) scale(1.0);
                opacity: 0;
            }
        }

        @keyframes floatTinyCenter {
            0% {
                transform: translate(0, 2px) rotate(0deg) scale(0.8);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 0.8;
            }

            100% {
                transform: translate(2px, -20px) rotate(5deg) scale(1.0);
                opacity: 0;
            }
        }

        /* --- LOADER MEDIUM CSS --- */
        .loader-medium {
            position: relative;
            width: 100px;
            height: 50px;
            display: inline-block;
        }

        .loader-medium .note {
            position: absolute;
            bottom: 0;
            color: var(--color-nigun);
            font-size: 30px;
            opacity: 0;
            will-change: transform, opacity;
        }

        .loader-medium .note.n1 {
            left: 15%;
            animation: floatMediumLeft 2.8s infinite ease-out;
        }

        .loader-medium .note.n2 {
            left: 50%;
            animation: floatMediumRight 3.2s infinite ease-out;
            animation-delay: 1s;
        }

        .loader-medium .note.n3 {
            left: 85%;
            animation: floatMediumCenter 2.5s infinite ease-out;
            animation-delay: 2s;
        }

        @keyframes floatMediumLeft {
            0% {
                transform: translate(10px, 5px) rotate(-5deg) scale(0.8);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 0.8;
            }

            100% {
                transform: translate(-25px, -50px) rotate(-15deg) scale(1.1);
                opacity: 0;
            }
        }

        @keyframes floatMediumRight {
            0% {
                transform: translate(-10px, 5px) rotate(5deg) scale(0.8);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 0.8;
            }

            100% {
                transform: translate(25px, -50px) rotate(15deg) scale(1.1);
                opacity: 0;
            }
        }

        @keyframes floatMediumCenter {
            0% {
                transform: translate(0, 5px) rotate(0deg) scale(0.8);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 0.8;
            }

            100% {
                transform: translate(5px, -50px) rotate(5deg) scale(1.1);
                opacity: 0;
            }
        }

        /* Wave bars are now all white - no category-specific colors needed */

        .subtitle {
            transition: opacity 0.3s ease-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: 'Heebo', 'David Libre', sans-serif;
            background: transparent;
            min-height: 100vh;
            direction: rtl;
            color: var(--text-dark);
            padding-bottom: 140px;
            overflow-x: hidden;
        }

        /* Header */
        .main-header {
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(248, 250, 252, 0.85) 100%);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .header-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            text-decoration: none;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: var(--gradient-main);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 12px rgba(74, 124, 201, 0.3);
        }

        .logo-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .logo-text span {
            font-weight: 700;
            font-family: 'Heebo', sans-serif;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text .logo-word-1 {
            font-size: 0.95em;
        }

        .logo-text .logo-word-2 {
            font-size: 1.1em;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .global-search-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: var(--gradient-main);
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 15px;
        }

        .global-search-btn:hover {
            background: var(--gradient-main-dark);
            transform: scale(1.1);
        }

        /* Search Modal */
        .search-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
            padding-bottom: 150px;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .search-modal-overlay.active {
            display: flex;
        }

        .search-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .search-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
        }

        .search-modal-header h3 {
            margin: 0;
            font-size: 1.2em;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .search-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            font-size: 1.4em;
            cursor: pointer;
            color: #666;
            transition: var(--transition-smooth);
        }

        .search-modal-close:hover {
            background: #e0e0e0;
            color: #333;
        }

        .search-modal-body {
            padding: 24px;
            display: flex;
            gap: 12px;
        }

        .search-modal-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1em;
            font-family: inherit;
            direction: rtl;
            transition: var(--transition-smooth);
        }

        .search-modal-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-pale);
        }

        .search-modal-btn {
            padding: 14px 28px;
            background: var(--gradient-main);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .search-modal-btn:hover {
            background: var(--gradient-main-dark);
            transform: translateY(-2px);
        }

        /* Nigun Modal Overlay */
        .nigun-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.65);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(6px);
            padding: 20px 20px 120px 20px;
        }

        .nigun-modal-overlay.active {
            display: flex;
        }

        .nigun-modal {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 850px;
            max-height: 80vh;
            margin-bottom: 100px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 0 3px rgba(74, 124, 201, 0.3), 0 25px 80px rgba(74, 124, 201, 0.35);
            animation: nigunModalIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .nigun-modal-overlay.closing .nigun-modal {
            animation: nigunModalOut 0.25s ease-out forwards;
        }

        @keyframes nigunModalIn {
            from {
                opacity: 0;
                transform: scale(0.85) translateY(30px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes nigunModalOut {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }

            to {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
        }

        .nigun-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, var(--color-nigun-pale) 0%, white 100%);
            flex-shrink: 0;
        }

        .nigun-modal-header h2 {
            margin: 0;
            font-size: 1.3em;
            color: var(--color-nigun-dark);
            font-weight: 700;
        }

        /* nigun-modal-close styles defined below in hero section */

        .nigun-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Custom scrollbar - hidden by default, visible on scroll */
        .nigun-modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .nigun-modal-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .nigun-modal-body::-webkit-scrollbar-thumb {
            background: rgba(100, 100, 100, 0.3);
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .nigun-modal-body::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 100, 100, 0.5);
        }

        .nigun-modal-body::-webkit-scrollbar-button {
            display: none;
        }

        /* Scrollbar fade effect */
        .nigun-modal-body {
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
            transition: scrollbar-color 0.3s ease;
        }

        .nigun-modal-body.is-scrolling {
            scrollbar-color: rgba(100, 100, 100, 0.4) transparent;
        }

        .nigun-modal-body.is-scrolling::-webkit-scrollbar-thumb {
            background: rgba(100, 100, 100, 0.4);
        }

        .nigun-modal-body .detail-page {
            padding: 0;
        }

        .nigun-modal-body .back-button {
            display: none;
        }

        .nigun-modal-body .detail-header {
            display: none;
        }

        .nigun-modal-body .detail-category-bar {
            display: none;
        }

        /* New Nigun Modal Hero Header */
        .nigun-modal-hero {
            position: relative;
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%);
            padding: 45px 25px 40px 25px;
            text-align: center;
            margin: -20px -20px 25px -20px;
            border-radius: 0 0 20px 20px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nigun-modal-hero-title {
            font-size: 2em;
            font-weight: 700;
            color: white;
            margin: 0;
            padding: 0 160px;
            font-family: 'Heebo', sans-serif;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            line-height: 1.3;
            text-align: center;
            max-width: 100%;
            word-wrap: break-word;
        }

        /* Close button - simple X at top right */
        .nigun-modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5em;
            color: #666;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 20;
        }

        .nigun-modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        /* Play All button - on right side of header, vertically centered */
        .play-all-btn {
            position: absolute;
            top: 50%;
            right: 50px;
            transform: translateY(-50%);
            width: 42px;
            height: 42px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 1.3em;
            color: var(--color-nigun);
            cursor: pointer;
            padding: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            z-index: 20;
            transition: all 0.2s ease;
        }

        .play-all-btn:hover {
            background: #f0f0f0;
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
        }

        .play-all-btn.playing {
            background: var(--color-nigun);
            color: white;
        }

        .play-all-btn.playing:hover {
            background: var(--color-nigun-dark);
        }

        .play-all-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        /* Category-specific play-all colors */
        .theme-mechaber .play-all-btn {
            color: var(--color-mechaber);
        }

        .theme-mechaber .play-all-btn.playing {
            background: var(--color-mechaber);
            color: white;
        }

        .theme-mechaber .play-all-btn.playing:hover {
            background: var(--color-mechaber-dark);
        }

        .theme-chatzer .play-all-btn {
            color: var(--color-chatzer);
        }

        .theme-chatzer .play-all-btn.playing {
            background: var(--color-chatzer);
            color: white;
        }

        .theme-chatzer .play-all-btn.playing:hover {
            background: var(--color-chatzer-dark);
        }

        .theme-verter .play-all-btn {
            color: var(--color-verter);
        }

        .theme-verter .play-all-btn.playing {
            background: var(--color-verter);
            color: white;
        }

        .theme-verter .play-all-btn.playing:hover {
            background: var(--color-verter-dark);
        }

        .theme-piyut .play-all-btn {
            color: var(--color-piyut);
        }

        .theme-piyut .play-all-btn.playing {
            background: var(--color-piyut);
            color: white;
        }

        .theme-piyut .play-all-btn.playing:hover {
            background: var(--color-piyut-dark);
        }

        .theme-collection .play-all-btn {
            color: var(--color-collection);
        }

        .theme-collection .play-all-btn.playing {
            background: var(--color-collection);
            color: white;
        }

        .theme-collection .play-all-btn.playing:hover {
            background: var(--color-collection-dark);
        }

        /* Tags bar - below hero, centered */
        .nigun-modal-hero-bottom {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 4px 20px;
            margin-top: -10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        /* Personalities tags */
        .nigun-modal-hero-personalities {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }

        .personality-tag {
            background: var(--color-mechaber);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(196, 53, 168, 0.3);
        }

        .personality-tag:hover {
            background: var(--color-mechaber-dark);
            transform: scale(1.05);
        }

        /* Chatzer tags */
        .nigun-modal-hero-chatzeros {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }

        .nigun-modal-hero-chatzeros .chatzer-tag {
            background: var(--color-chatzer);
            color: white;
            border: none;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(156, 91, 181, 0.3);
        }

        .nigun-modal-hero-chatzeros .chatzer-tag:hover {
            background: var(--color-chatzer-dark);
            transform: scale(1.05);
        }

        /* Ball divider between chatzer and maure */
        .nigun-modal-divider {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-nigun);
        }

        /* Maure (gezungen oif) tags */
        .nigun-modal-hero-maure {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }

        .maure-tag {
            background: var(--color-piyut);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);
        }

        .maure-tag:hover {
            background: var(--color-piyut-dark);
            transform: scale(1.05);
        }

        /* Album tags */
        .nigun-modal-hero-albums {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }

        .album-tag {
            background: var(--color-album);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(233, 30, 99, 0.3);
        }

        .album-tag:hover {
            background: var(--color-album-dark);
            transform: scale(1.05);
        }

        /* Document tags */
        .nigun-modal-hero-documents {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }

        .document-tag {
            background: var(--color-document);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(121, 85, 72, 0.3);
        }

        .document-tag:hover {
            background: var(--color-document-dark);
            transform: scale(1.05);
        }

        /* Resources tags */
        .nigun-modal-hero-resources {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }

        .resource-tag {
            background: #1976D2;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
        }

        .resource-tag:hover {
            background: #1565C0;
            transform: scale(1.05);
        }

        /* Credits - small and subtle at bottom */
        .nigun-credits {
            text-align: center;
            font-size: 0.7em;
            color: var(--text-secondary);
            opacity: 0.6;
            margin-top: 20px;
            padding: 12px 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            font-style: italic;
        }

        /* Mechaber profile - one unified box */
        .nigun-modal-mechaber-profile {
            position: absolute;
            top: 0;
            left: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 15;
            text-decoration: none;
            background: var(--color-mechaber);
            padding: 28px 10px 5px 10px;
            border-radius: 0 0 10px 10px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            transform-origin: top center;
            margin-bottom: -15px;
            max-height: 115px;
            min-width: 85px;
            max-width: 110px;
            overflow: hidden;
        }

        .nigun-modal-mechaber-profile:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 15px rgba(156, 91, 181, 0.3);
        }

        /* When no mechaber, center the title fully */
        .nigun-modal-hero.no-mechaber .nigun-modal-hero-title {
            padding: 0 25px;
        }

        .nigun-modal-mechaber-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            border: 2px solid white;
            overflow: hidden;
            flex-shrink: 0;
            margin: 0 -5px 5px -5px;
        }

        .nigun-modal-mechaber-avatar:hover {
            /* No separate hover - whole stripe scales */
        }

        .nigun-modal-mechaber-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .nigun-modal-mechaber-avatar .placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--color-mechaber-pale) 0%, var(--color-mechaber-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2em;
            color: var(--color-mechaber);
        }

        .nigun-modal-mechaber-avatar .placeholder .mechaber-icon {
            width: 20px;
            height: 30px;
            background-color: var(--color-mechaber);
            -webkit-mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
            mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
        }

        .nigun-modal-mechaber-name {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 9px;
            font-weight: 600;
            color: white;
            padding: 2px 4px;
            cursor: pointer;
            transition: opacity 0.2s ease;
            text-decoration: none;
            text-align: center;
            width: max-content;
            max-width: 100px;
        }

        .nigun-modal-mechaber-name .mechaber-formal {
            display: none;
        }

        .nigun-modal-mechaber-name .mechaber-known {
            font-size: 10px !important;
            text-wrap: balance;
            line-height: 1.15;
        }

        .nigun-modal-mechaber-name:hover {
            opacity: 0.85;
        }

        @media (max-width: 500px) {
            .nigun-modal-hero {
                padding: 30px 15px 30px 15px;
                margin-bottom: 50px;
            }

            .nigun-modal-hero-title {
                font-size: 1.4em;
            }

            .nigun-modal-hero-chatzeros {
                right: 15px;
                bottom: -12px;
            }

            .nigun-modal-mechaber-profile {
                left: 5px;
                bottom: -45px;
            }

            .nigun-modal-mechaber-avatar {
                width: 55px;
                height: 55px;
            }

            .nigun-modal-mechaber-name {
                font-size: 0.7em;
                padding: 4px 10px;
            }
        }

        @media (max-width: 600px) {
            .nigun-modal {
                max-height: 90vh;
                border-radius: 16px;
            }

            .nigun-modal-body {
                padding: 15px;
            }
        }

        /* Generic Detail Modal Overlay - matches nigun modal */
        .detail-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(6px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 20px 20px 120px 20px;
            overflow-y: auto;
        }

        .detail-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .detail-modal-content {
            background: white;
            border-radius: 20px;
            max-width: 850px;
            width: 100%;
            height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            transform: scale(0.9) translateY(30px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 3px solid var(--color-mechaber);
            padding-bottom: 150px;
        }

        .detail-modal-overlay.active .detail-modal-content {
            transform: scale(1) translateY(0);
        }

        /* Expand to full page animation */
        @keyframes expandToFullPage {
            0% {
                transform: scale(1) translateY(0);
                border-radius: 20px;
            }

            100% {
                transform: scale(1.3);
                border-radius: 0;
                opacity: 0;
            }
        }

        .detail-modal-content.expanding {
            animation: expandToFullPage 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .detail-modal-overlay.expanding {
            animation: fadeOut 0.4s ease forwards;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* Theme-specific border colors */
        .detail-modal-content.theme-mechaber {
            border-color: var(--color-mechaber);
        }

        .detail-modal-content.theme-chatzer {
            border-color: var(--color-chatzer);
        }

        .detail-modal-content.theme-verter {
            border-color: var(--color-verter);
        }

        .detail-modal-content.theme-zman {
            border-color: var(--color-zman);
        }

        .detail-modal-content.theme-piyut {
            border-color: var(--color-piyut);
        }

        .detail-modal-content.theme-collection {
            border-color: var(--color-collection);
        }

        .detail-modal-content.theme-album {
            border-color: var(--color-album);
        }

        .detail-modal-content.theme-document {
            border-color: var(--color-document);
        }

        .detail-modal-content.theme-resource {
            border-color: var(--color-resource);
        }

        /* Minimal scrollbar for detail modal - matches nigun modal */
        .detail-modal-content::-webkit-scrollbar {
            width: 8px;
            margin-right: -10px;
        }

        .detail-modal-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .detail-modal-content::-webkit-scrollbar-thumb {
            background: var(--color-mechaber);
            border-radius: 10px;
        }

        .detail-modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--color-mechaber-dark);
        }

        .detail-modal-content::-webkit-scrollbar-button {
            display: none;
        }

        /* Firefox scrollbar */
        .detail-modal-content {
            scrollbar-width: thin;
            scrollbar-color: var(--color-mechaber) transparent;
        }

        /* Theme-specific scrollbar colors */
        .detail-modal-content.theme-chatzer {
            scrollbar-color: var(--color-chatzer) transparent;
        }

        .detail-modal-content.theme-chatzer::-webkit-scrollbar-thumb {
            background: var(--color-chatzer);
        }

        .detail-modal-content.theme-chatzer::-webkit-scrollbar-thumb:hover {
            background: var(--color-chatzer-dark);
        }

        .detail-modal-content.theme-verter {
            scrollbar-color: var(--color-verter) transparent;
        }

        .detail-modal-content.theme-verter::-webkit-scrollbar-thumb {
            background: var(--color-verter);
        }

        .detail-modal-content.theme-verter::-webkit-scrollbar-thumb:hover {
            background: var(--color-verter-dark);
        }

        .detail-modal-content.theme-zman {
            scrollbar-color: var(--color-zman) transparent;
        }

        .detail-modal-content.theme-zman::-webkit-scrollbar-thumb {
            background: var(--color-zman);
        }

        .detail-modal-content.theme-zman::-webkit-scrollbar-thumb:hover {
            background: var(--color-zman-dark);
        }

        /* Close button - matches nigun modal */
        .detail-modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5em;
            color: #666;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 20;
            transition: all 0.25s ease;
        }

        .detail-modal-close:hover {
            background: var(--primary-pale);
            color: var(--primary);
            transform: scale(1.15);
        }

        /* Expand button - opposite side of close button */
        .detail-modal-expand {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 1.2em;
            color: #666;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 20;
            transition: all 0.25s ease;
        }

        .detail-modal-expand:hover {
            background: var(--primary-pale);
            color: var(--primary);
            transform: scale(1.15);
        }

        /* Theme-specific button hover colors */
        .theme-mechaber .detail-modal-close:hover,
        .theme-mechaber .detail-modal-expand:hover {
            background: var(--color-mechaber-pale);
            color: var(--color-mechaber-dark);
        }

        .theme-chatzer .detail-modal-close:hover,
        .theme-chatzer .detail-modal-expand:hover {
            background: var(--color-chatzer-pale);
            color: var(--color-chatzer-dark);
        }

        .theme-verter .detail-modal-close:hover,
        .theme-verter .detail-modal-expand:hover {
            background: var(--color-verter-pale);
            color: var(--color-verter);
        }

        .theme-zman .detail-modal-close:hover,
        .theme-zman .detail-modal-expand:hover {
            background: var(--color-zman-pale);
            color: var(--color-zman-dark);
        }

        .theme-collection .detail-modal-close:hover,
        .theme-collection .detail-modal-expand:hover {
            background: var(--color-collection-pale);
            color: var(--color-collection-dark);
        }

        .theme-album .detail-modal-close:hover,
        .theme-album .detail-modal-expand:hover {
            background: var(--color-album-pale);
            color: var(--color-album-dark);
        }

        .theme-document .detail-modal-close:hover,
        .theme-document .detail-modal-expand:hover {
            background: var(--color-document-pale);
            color: var(--color-document-dark);
        }

        .theme-resource .detail-modal-close:hover,
        .theme-resource .detail-modal-expand:hover {
            background: var(--color-resource-pale);
            color: var(--color-resource-dark);
        }

        /* Generic Modal Hero Header - matches nigun modal hero */
        .modal-hero-wrapper {
            position: relative;
            margin-bottom: 40px;
        }

        .modal-hero {
            position: relative;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-deep) 100%);
            padding: 30px 25px;
            text-align: center;
            margin: 0 60px 0 60px;
            border-radius: 0 0 20px 20px;
            min-height: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .modal-hero-left {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .modal-hero-border-badges {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .modal-hero-border-badges .modal-hero-badges {
            margin-top: 0;
        }

        .modal-hero-title {
            font-size: 2em;
            font-weight: 700;
            color: white;
            margin: 0;
            font-family: 'Heebo', sans-serif;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            line-height: 1.3;
            text-align: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        /* Mechaber-specific: add equal padding on both sides for image clearance */
        .theme-mechaber .modal-hero-title {
            padding: 0 100px;
            max-width: 100%;
        }

        .modal-hero-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .modal-hero-subtitle {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.85);
            text-align: center;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        }

        .modal-hero-dates {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
            margin-top: 2px;
            text-align: center;
        }

        .modal-hero-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            justify-content: center;
        }

        /* Meta section under hero (dates + badges) */
        .modal-meta-section {
            background: var(--bg-light);
            padding: 15px 25px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-meta-dates {
            font-size: 0.95em;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 10px;
        }

        .modal-meta-section .modal-hero-badges {
            justify-content: center;
        }

        /* Profile avatar in modal hero */
        .modal-hero-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
            border: 4px solid white;
            overflow: hidden;
            flex-shrink: 0;
        }

        .modal-hero-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-hero-avatar .placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--color-mechaber-pale) 0%, var(--color-mechaber-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-hero-avatar .placeholder .mechaber-icon {
            width: 28px;
            height: 41px;
            background-color: var(--color-mechaber);
            -webkit-mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
            mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
        }

        /* Theme-specific hero colors */
        .modal-hero.theme-mechaber {
            background: linear-gradient(135deg, var(--color-mechaber) 0%, var(--color-mechaber-dark) 100%);
        }

        .modal-hero.theme-chatzer {
            background: linear-gradient(135deg, var(--color-chatzer) 0%, var(--color-chatzer-dark) 100%);
        }

        .modal-hero.theme-verter {
            background: linear-gradient(135deg, var(--color-verter) 0%, var(--color-verter-dark) 100%);
        }

        .modal-hero.theme-zman {
            background: linear-gradient(135deg, var(--color-zman) 0%, var(--color-zman-dark) 100%);
        }

        .modal-hero.theme-piyut {
            background: linear-gradient(135deg, var(--color-piyut) 0%, var(--color-piyut-dark) 100%);
        }

        .modal-hero.theme-collection {
            background: linear-gradient(135deg, var(--color-collection) 0%, var(--color-collection-dark) 100%);
        }

        .modal-hero.theme-album {
            background: linear-gradient(135deg, var(--color-album) 0%, var(--color-album-dark) 100%);
        }

        .modal-hero.theme-document {
            background: linear-gradient(135deg, var(--color-document) 0%, var(--color-document-dark) 100%);
        }

        .modal-hero.theme-resource {
            background: linear-gradient(135deg, var(--color-resource) 0%, var(--color-resource-dark) 100%);
        }

        @media (max-width: 500px) {
            .modal-hero {
                padding: 30px 15px 30px 15px;
            }

            .modal-hero-title {
                font-size: 1.4em;
            }
        }

        .modal-body-content {
            padding: 20px;
            background: white;
        }

        .modal-body-content .detail-page {
            padding: 0 !important;
        }

        /* Hide back button in modal context */
        .detail-modal-body .back-button,
        #detailModalBody .back-button {
            display: none !important;
        }

        .detail-modal-body,
        #detailModalBody {
            padding: 0;
            overflow-x: hidden;
        }

        /* Reset detail-page viewport-based calculations inside modal */
        .detail-modal-body .detail-page,
        #detailModalBody .detail-page {
            margin-left: 0 !important;
            margin-right: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            max-width: 100% !important;
            width: 100% !important;
            background: none !important;
        }

        /* Ensure all content respects container width */
        .detail-modal-body *,
        #detailModalBody * {
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        /* Fix image sizing in modal */
        .detail-modal-body .detail-image,
        #detailModalBody .detail-image {
            max-width: 150px !important;
            height: auto !important;
        }

        /* Style detail-description-section in modal like nigun-additions-box */
        .detail-modal-body .detail-description-section,
        #detailModalBody .detail-description-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
            padding: 20px 20px 15px 20px;
            background: var(--color-mechaber-pale);
            border-radius: 12px;
            margin: 25px auto 20px auto;
            max-width: 600px;
            position: relative;
            border: 1.5px solid var(--color-mechaber-dark);
            box-shadow: none;
        }

        #detailModalBody .detail-description-section h3 {
            font-size: 0;
            color: transparent;
            width: 32px;
            height: 32px;
            padding: 0;
            background: var(--color-mechaber);
            border-radius: 50%;
            margin: -36px 0 10px 0;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: none;
        }

        #detailModalBody .detail-description-section h3::before {
            content: "i";
            font-size: 1.1rem;
            font-weight: bold;
            font-style: italic;
            color: white;
        }

        #detailModalBody .detail-description-section .detail-description-content {
            font-size: 0.9em;
            color: var(--text-dark);
            line-height: 1.6;
            text-align: right;
        }

        #detailModalBody .detail-description-section .description-fade-overlay {
            background: linear-gradient(to bottom, transparent, var(--color-mechaber-pale));
        }

        @media (max-width: 600px) {
            .detail-modal-content {
                height: 90vh;
                border-radius: 16px;
            }
        }

        .global-search-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--gradient-main);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(156, 91, 181, 0.4);
            margin-left: 12px;
            position: relative;
            overflow: hidden;
        }

        .global-search-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: translateX(-100%) rotate(45deg);
            transition: transform 0.4s ease;
        }

        .global-search-btn:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 8px 25px rgba(156, 91, 181, 0.6);
        }

        .global-search-btn:hover::before {
            transform: translateX(100%) rotate(45deg);
        }

        .global-search-btn svg {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .global-search-btn:hover svg {
            transform: scale(1.15) rotate(15deg);
        }

        .search-btn-text {
            max-width: 0;
            opacity: 0;
            overflow: hidden;
            white-space: nowrap;
            transition: all 0.4s ease;
            font-weight: 700;
            font-size: 0.95em;
            margin-right: 0;
        }

        .global-search-btn:hover {
            width: 95px;
            /* Expand to show text */
            border-radius: 30px;
            /* Pill shape */
            gap: 6px;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(156, 91, 181, 0.6);
        }

        .global-search-btn:hover .search-btn-text {
            max-width: 50px;
            opacity: 1;
            margin-right: 4px;
        }

        /* Compact header buttons - gradient only */
        .stream-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--gradient-main);
            border: none;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.85em;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(156, 91, 181, 0.3);
            white-space: nowrap;
        }

        .stream-btn::before {
            content: '';
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: pulse-white 2s infinite;
        }

        @keyframes pulse-white {

            0%,
            100% {
                opacity: 0.6;
                transform: scale(0.9);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        .stream-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 91, 181, 0.5);
        }

        /* New swapped button styles */
        .search-pill-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--gradient-main);
            border: none;
            border-radius: 20px;
            font-family: inherit;
            font-size: 0.85em;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(156, 91, 181, 0.3);
            white-space: nowrap;
        }

        .search-pill-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 91, 181, 0.5);
        }

        /* Search button with icon + text */
        .search-btn-new {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--gradient-main);
            border: none;
            border-radius: 20px;
            font-family: inherit;
            font-size: 0.85em;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(156, 91, 181, 0.3);
            white-space: nowrap;
        }

        .search-icon-new {
            width: 16px;
            height: 16px;
            fill: white;
        }

        .search-btn-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 91, 181, 0.5);
        }

        /* Streaming ball button - expands on hover */
        .stream-ball-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            padding: 0 10px;
            background: transparent;
            border: 2px solid #9c5bb5;
            border-radius: 16px;
            text-decoration: none;
            color: #9c5bb5;
            transition: all 0.3s ease;
            overflow: hidden;
            cursor: pointer;
        }

        .stream-dot {
            width: 6px;
            height: 6px;
            background: var(--gradient-main);
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
            flex-shrink: 0;
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 0.5;
                transform: scale(0.9);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        .stream-text-new {
            max-width: 0;
            overflow: hidden;
            white-space: nowrap;
            font-size: 0.8em;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stream-ball-btn:hover {
            padding: 6px 12px;
            gap: 5px;
            background: rgba(156, 91, 181, 0.05);
        }

        .stream-ball-btn:hover .stream-text-new {
            max-width: 80px;
            opacity: 1;
            margin-left: 4px;
        }

        .global-search-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--gradient-main);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(156, 91, 181, 0.3);
            position: relative;
            overflow: hidden;
        }

        .global-search-btn:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 6px 20px rgba(156, 91, 181, 0.5);
        }

        .search-btn-text {
            display: none;
            /* Hide text for compact design */
        }

        /* Navigation - Clean Layout, Individual Button Colors */
        .main-nav {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            perspective: 800px;
        }

        .main-nav>* {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Tablecloth slide effect - corrected for divider at position 5 */
        /* Nav order: 1=Nigunim, 2=Mechabrim, 3=Verter, 4=Zmanim, 5=Divider, 6=Docs */

        /* When hovering Nigunim (1) - others slide right */
        .main-nav>*:nth-child(1):hover~* {
            transform: translateX(8px);
        }

        /* When hovering Mechabrim (2) */
        .main-nav:has(*:nth-child(2):hover)>*:nth-child(1) {
            transform: translateX(-6px);
        }

        .main-nav>*:nth-child(2):hover~* {
            transform: translateX(6px);
        }

        /* When hovering Verter (3) */
        .main-nav:has(*:nth-child(3):hover)>*:nth-child(1),
        .main-nav:has(*:nth-child(3):hover)>*:nth-child(2) {
            transform: translateX(-5px);
        }

        .main-nav>*:nth-child(3):hover~* {
            transform: translateX(5px);
        }

        /* When hovering Zmanim (4) */
        .main-nav:has(*:nth-child(4):hover)>*:nth-child(1),
        .main-nav:has(*:nth-child(4):hover)>*:nth-child(2),
        .main-nav:has(*:nth-child(4):hover)>*:nth-child(3) {
            transform: translateX(-4px);
        }

        .main-nav>*:nth-child(4):hover~* {
            transform: translateX(4px);
        }

        /* When hovering Docs (6) - all others slide left toward it */
        .main-nav:has(*:nth-child(6):hover)>*:nth-child(1),
        .main-nav:has(*:nth-child(6):hover)>*:nth-child(2),
        .main-nav:has(*:nth-child(6):hover)>*:nth-child(3),
        .main-nav:has(*:nth-child(6):hover)>*:nth-child(4),
        .main-nav:has(*:nth-child(6):hover)>*:nth-child(5) {
            transform: translateX(-8px);
        }

        .nav-btn {
            padding: 12px 28px;
            background: var(--color-nigun);
            border: none;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-family: inherit;
            color: white;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(74, 124, 201, 0.35);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        /* Animated glow ring */
        .nav-btn::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 35px;
            background: var(--color-nigun);
            z-index: -1;
            opacity: 0.5;
            filter: blur(8px);
            transition: all 0.4s ease;
        }

        /* Inner shine effect */
        /* Inner shine effect - RTL direction, hover only */
        .nav-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: none;
        }

        .nav-btn:hover::after {
            left: -100%;
            transition: left 0.5s ease;
        }

        .nav-btn:hover {
            transform: translateY(3px) scale(1.08);
            box-shadow: 0 8px 25px rgba(74, 124, 201, 0.5);
        }

        .nav-btn:hover::before {
            opacity: 0.8;
            filter: blur(12px);
        }

        .nav-dropdown {
            position: relative;
        }

        /* Base dropdown button style */
        .nav-dropdown-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 25px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            z-index: 2;
        }

        .nav-dropdown-btn .nav-arrow {
            font-size: 1.1em;
            opacity: 0.6;
            transition: transform 0.3s ease;
        }

        .nav-dropdown:hover .nav-dropdown-btn .nav-arrow {
            transform: rotate(180deg);
        }

        /* Each button with its own category color border */
        .nav-dropdown-btn.nav-mechaber {
            background: white;
            color: var(--color-mechaber);
            border: 2px solid var(--color-mechaber);
            box-shadow: 0 2px 8px rgba(196, 53, 168, 0.2);
        }

        .nav-dropdown-btn.nav-mechaber:hover,
        .nav-dropdown:hover .nav-dropdown-btn.nav-mechaber {
            background: var(--color-mechaber-pale);
            transform: translateY(3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(196, 53, 168, 0.4);
        }

        .nav-dropdown-btn.nav-verter {
            background: white;
            color: var(--color-verter);
            border: 2px solid var(--color-verter);
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
        }

        .nav-dropdown-btn.nav-verter:hover,
        .nav-dropdown:hover .nav-dropdown-btn.nav-verter {
            background: var(--color-verter-pale);
            transform: translateY(3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4);
        }

        .nav-dropdown-btn.nav-zman {
            background: white;
            color: var(--color-zman);
            border: 2px solid var(--color-zman);
            box-shadow: 0 2px 8px rgba(233, 106, 27, 0.2);
        }

        .nav-dropdown-btn.nav-zman:hover,
        .nav-dropdown:hover .nav-dropdown-btn.nav-zman {
            background: var(--color-zman-pale);
            transform: translateY(3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(233, 106, 27, 0.4);
        }

        .nav-dropdown-btn.nav-docs {
            background: white;
            color: var(--color-document);
            border: 2px solid var(--color-document);
            box-shadow: 0 2px 8px rgba(0, 160, 176, 0.2);
            border-radius: 10px;
            padding: 6px 12px;
            gap: 3px;
            font-size: 0.82em;
        }

        .nav-dropdown-btn.nav-docs:hover,
        .nav-dropdown:hover .nav-dropdown-btn.nav-docs {
            background: var(--color-document-pale);
            transform: translateY(3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 160, 176, 0.4);
        }

        .nav-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: auto;
            left: 50%;
            transform: translateX(-50%);
            background: transparent;
            min-width: 160px;
            z-index: 100;
            overflow: visible;
            padding-top: 12px;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Bridge between button and dropdown to prevent losing hover */
        .nav-dropdown-content::before {
            content: '';
            position: absolute;
            top: 0;
            right: -20px;
            left: -20px;
            height: 15px;
            pointer-events: none;
        }

        .nav-dropdown-content .dropdown-inner {
            background: transparent;
            border-radius: 16px;
            padding: 6px 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Keep dropdown open when hovering anywhere in the dropdown area */
        .nav-dropdown:hover .nav-dropdown-content {
            display: block;
        }

        /* Parent button stays in hover state when dropdown is open */
        /* Individual button hover styles handle the transform */

        .nav-dropdown-content.hiding {
            display: none !important;
        }

        /* Beautiful dropdown items - each as separate white card */
        .nav-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin: 0;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9em;
            font-weight: 500;
            background: white;
            text-decoration: none;
            color: var(--text-dark);
            border-radius: 14px;
            position: relative;
            overflow: hidden;
            opacity: 0;
            animation: itemDropIn 0.35s ease-out forwards;
            border: none;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.12), 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        /* Staggered animation delays - items come in one by one */
        .nav-dropdown-item:nth-child(1) {
            animation-delay: 0s;
        }

        .nav-dropdown-item:nth-child(2) {
            animation-delay: 0.08s;
        }

        .nav-dropdown-item:nth-child(3) {
            animation-delay: 0.16s;
        }

        .nav-dropdown-item:nth-child(4) {
            animation-delay: 0.24s;
        }

        .nav-dropdown-item:nth-child(5) {
            animation-delay: 0.32s;
        }

        .nav-dropdown-item:nth-child(6) {
            animation-delay: 0.4s;
        }

        @keyframes itemDropIn {
            from {
                opacity: 0;
                transform: translateY(-15px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .nav-dropdown-item:hover {
            transform: translateX(-4px) scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Color indicator dot */
        .nav-dropdown-item::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            transition: all 0.25s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* Stars need bigger size */
        .nav-dropdown-item[data-dest="resources"]::before,
        .nav-dropdown-item[data-dest="albums"]::before,
        .nav-dropdown-item[data-dest="documents"]::before,
        .nav-dropdown-item[data-dest="info"]::before {
            width: 14px;
            height: 14px;
        }

        .nav-dropdown-item:hover::before {
            transform: scale(1.3);
        }

        .nav-dropdown-item[data-dest="home"]::before {
            background: var(--color-nigun);
        }

        .nav-dropdown-item[data-dest="nigunim"]::before {
            background: var(--color-nigun);
        }

        .nav-dropdown-item[data-dest="mechabrim"]::before {
            background: var(--color-mechaber);
        }

        .nav-dropdown-item[data-dest="chatzeros"]::before {
            background: var(--color-chatzer);
        }

        .nav-dropdown-item[data-dest="verter"]::before {
            background: var(--color-verter);
            border-radius: 2px;
            /* Square shape */
        }

        .nav-dropdown-item[data-dest="zmanim"]::before {
            background: var(--color-zman);
            border-radius: 0;
            clip-path: polygon(0 50%, 100% 0, 100% 100%);
            /* Play triangle - RTL direction */
        }

        .nav-dropdown-item[data-dest="music"]::before {
            background: var(--color-music);
            border-radius: 2px;
            /* Square shape like verter */
        }

        .nav-dropdown-item[data-dest="collections"]::before {
            background: var(--color-collection);
            border-radius: 0;
            clip-path: polygon(0 50%, 100% 0, 100% 100%);
            /* Play triangle - RTL direction */
        }

        .nav-dropdown-item[data-dest="piyutim"]::before {
            background: var(--color-piyut);
            border-radius: 0;
            clip-path: polygon(0 50%, 100% 0, 100% 100%);
            /* Play triangle - RTL direction */
        }

        .nav-dropdown-item[data-dest="resources"]::before {
            background: var(--color-resource);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            /* Star */
            border-radius: 0;
        }

        .nav-dropdown-item[data-dest="albums"]::before {
            background: var(--color-album);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            /* Star */
            border-radius: 0;
        }

        .nav-dropdown-item[data-dest="documents"]::before {
            background: var(--color-document);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            /* Star */
            border-radius: 0;
        }

        .nav-dropdown-item[data-dest="info"]::before {
            background: #999;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            /* Star */
            border-radius: 0;
        }

        /* Navigation items text colors on hover */
        .nav-dropdown-item[data-dest="nigunim"]:hover {
            color: var(--color-nigun-dark);
            background: var(--color-nigun-pale);
        }

        .nav-dropdown-item[data-dest="mechabrim"]:hover {
            color: var(--color-mechaber-dark);
            background: var(--color-mechaber-pale);
        }

        .nav-dropdown-item[data-dest="chatzeros"]:hover {
            color: var(--color-chatzer-dark);
            background: var(--color-chatzer-pale);
        }

        .nav-dropdown-item[data-dest="verter"]:hover {
            color: var(--color-verter-dark);
            background: var(--color-verter-pale);
        }

        .nav-dropdown-item[data-dest="zmanim"]:hover {
            color: var(--color-zman-dark);
            background: var(--color-zman-pale);
        }

        .nav-dropdown-item[data-dest="music"]:hover {
            color: var(--color-music-dark);
            background: var(--color-music-pale);
        }

        .nav-dropdown-item[data-dest="collections"]:hover {
            color: var(--color-collection-dark);
            background: var(--color-collection-pale);
        }

        .nav-dropdown-item[data-dest="piyutim"]:hover {
            color: var(--color-piyut-dark);
            background: var(--color-piyut-pale);
        }

        .nav-dropdown-item[data-dest="resources"]:hover {
            color: var(--color-resource-dark);
            background: var(--color-resource-pale);
        }

        .nav-dropdown-item[data-dest="albums"]:hover {
            color: var(--color-album-dark);
            background: var(--color-album-pale);
        }

        .nav-dropdown-item[data-dest="documents"]:hover {
            color: var(--color-document-dark);
            background: var(--color-document-pale);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: #eee;
            margin: 4px 0;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Home Page Styles */
        .home-page {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .home-hero {
            background: var(--gradient-main);
            border-radius: 25px;
            padding: 50px 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(74, 124, 201, 0.25), 0 10px 40px rgba(156, 91, 181, 0.2), 0 10px 40px rgba(196, 53, 168, 0.15);
            position: relative;
            overflow: hidden;
        }

        .home-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            /* animation: shimmer 15s infinite linear; removed for new animation */
        }

        /* Hero Musical Background Animation - Relaxing Floating Notes */
        /* Hero Musical Background Animation - Relaxing Floating Notes + Wandering */
        .hero-musical-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 1;
            perspective: 1000px;
        }

        /* Wrapper handles the main flight path (center to outward) */
        .note-wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-style: preserve-3d;
            animation: flight linear infinite;
        }

        /* Inner note handles rotation and random wandering */
        .musical-note {
            display: block;
            color: rgba(255, 255, 255, 0.6);
            /* font-size set inline */
            transform-style: preserve-3d;
        }

        .musical-note.wander-1 {
            animation: wander1 ease-in-out infinite alternate;
        }

        .musical-note.wander-2 {
            animation: wander2 ease-in-out infinite alternate;
        }

        .musical-note.wander-3 {
            animation: wander3 ease-in-out infinite alternate;
        }

        @keyframes flight {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) scale(2.5);
                opacity: 0;
            }
        }

        @keyframes wander1 {
            0% {
                transform: translate3d(0, 0, 0) rotateZ(var(--rot)) rotateX(0deg) rotateY(0deg);
            }

            33% {
                transform: translate3d(250px, -400px, 150px) rotateZ(calc(var(--rot) + 120deg)) rotateX(40deg) rotateY(30deg);
            }

            66% {
                transform: translate3d(-150px, 300px, -200px) rotateZ(calc(var(--rot) + 240deg)) rotateX(-30deg) rotateY(-40deg);
            }

            100% {
                transform: translate3d(0, 0, 0) rotateZ(calc(var(--rot) + 360deg)) rotateX(0deg) rotateY(0deg);
            }
        }

        @keyframes wander2 {
            0% {
                transform: translate3d(0, 0, 0) rotateZ(var(--rot)) rotateX(0deg) rotateY(0deg);
            }

            50% {
                transform: translate3d(-400px, 0, 300px) rotateZ(calc(var(--rot) - 180deg)) rotateX(-45deg) rotateY(45deg);
            }

            100% {
                transform: translate3d(400px, -200px, -400px) rotateZ(calc(var(--rot) - 360deg)) rotateX(0deg) rotateY(0deg);
            }
        }

        @keyframes wander3 {
            0% {
                transform: translate3d(0, 0, 0) rotateZ(var(--rot)) rotateX(0deg) rotateY(0deg);
            }

            25% {
                transform: translate3d(300px, 300px, 300px) rotateZ(calc(var(--rot) + 90deg)) rotateX(50deg) rotateY(-30deg);
            }

            75% {
                transform: translate3d(-300px, -300px, -300px) rotateZ(calc(var(--rot) + 270deg)) rotateX(-50deg) rotateY(30deg);
            }

            100% {
                transform: translate3d(0, 0, 0) rotateZ(calc(var(--rot) + 360deg)) rotateX(0deg) rotateY(0deg);
            }
        }

        /* Fade in up animation for cards */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                margin-top: 40px;
            }

            to {
                opacity: 1;
                margin-top: 0;
            }
        }

        /* Animate cards on load */
        .animate-on-load {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
        }

        /* Staggered card animation */
        @keyframes cardFadeIn {
            from {
                opacity: 0;
                margin-top: 30px;
            }

            to {
                opacity: 1;
                margin-top: 0;
            }
        }

        /* Staggered Fade Up Animation using Transform for better performance */
        @keyframes fadeInUpTransform {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.97);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .stagger-fade-up {
            opacity: 0;
            animation: fadeInUpTransform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) both;
            will-change: transform, opacity;
        }

        /* Initial state for elements we want to animate */
        .home-stat-hero,
        .home-stat-card,
        .home-link-card,
        .home-section {
            /* We will add the class via JS, but good to know these are the targets */
        }

        /* Smooth insertion animation - new items pop in */
        @keyframes itemPopIn {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(-10px);
                max-height: 0;
                margin-bottom: 0;
                padding-top: 0;
                padding-bottom: 0;
            }

            40% {
                max-height: 100px;
                margin-bottom: 8px;
                padding-top: 12px;
                padding-bottom: 12px;
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
                max-height: 100px;
                margin-bottom: 8px;
            }
        }

        .item-pop-in {
            animation: itemPopIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* Category card specific pop-in - no max-height constraint */
        @keyframes cardPopIn {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .card-pop-in {
            animation: cardPopIn 0.3s ease-out forwards;
        }

        .card-stagger {
            animation: cardPopIn 0.35s ease-out forwards;
        }

        /* Make song items and category cards animate their position smoothly */
        .all-songs-grid .song-item,
        .category-grid .category-card {
            transition: transform 0.3s ease-out, margin 0.3s ease-out;
        }

        /* When items need to make room for new ones */
        .item-shift-down {
            animation: shiftDown 0.3s ease-out forwards;
        }

        @keyframes shiftDown {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(0);
            }
        }

        /* Page transition animation (LTR - left to right) */
        /* Forward navigation: enter from left */
        @keyframes pageSlideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Forward navigation: exit to right */
        @keyframes pageSlideOutToRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(50px);
            }
        }

        /* Backward navigation: enter from right */
        @keyframes pageSlideInFromRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Backward navigation: exit to left */
        @keyframes pageSlideOutToLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(-50px);
            }
        }

        /* Home page specific animation (enter from bottom - dramatic) */
        @keyframes pageSlideInUp {
            from {
                opacity: 0;
                transform: translateY(80px) scale(0.97);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Home page exit (all to right) */
        @keyframes homePageExitRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(50px);
            }
        }

        /* Content page transitions - forward */
        .page-enter {
            animation: pageSlideInFromLeft 0.35s ease-out forwards;
        }

        .page-exit {
            animation: pageSlideOutToRight 0.2s ease-in forwards;
        }

        /* Content page transitions - backward */
        .page-enter-back {
            animation: pageSlideInFromRight 0.35s ease-out forwards;
        }

        .page-exit-back {
            animation: pageSlideOutToLeft 0.2s ease-in forwards;
        }

        /* Home page transitions */
        .page-enter-up {
            animation: pageSlideInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .page-exit-home {
            animation: homePageExitRight 0.2s ease-in forwards;
        }

        /* Info page fade animation - no directional movement */
        @keyframes infoPageFadeIn {
            from {
                opacity: 0;
                transform: scale(0.98);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes infoPageFadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }

            to {
                opacity: 0;
                transform: scale(0.98);
            }
        }

        .page-enter-info {
            animation: infoPageFadeIn 0.3s ease-out forwards;
        }

        .page-exit-info {
            animation: infoPageFadeOut 0.15s ease-in forwards;
        }

        /* Count-up number animation */
        @keyframes numberPop {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }

            60% {
                transform: scale(1.1);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .number-animate {
            animation: numberPop 0.4s ease-out forwards;
        }

        .home-hero-content {
            position: relative;
            z-index: 2;
        }

        .home-logo {
            font-size: 4em;
            margin-bottom: 15px;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .home-title {
            font-size: 5.5em;
            color: white;
            margin: 0 0 10px 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            font-family: 'Heebo', sans-serif;
            font-weight: 700;
        }

        .home-subtitle {
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }

        .home-search-section {
            margin-bottom: 30px;
        }

        .home-search-box {
            display: flex;
            gap: 10px;
        }

        .home-search-input {
            flex: 1;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid var(--primary-pale);
            border-radius: 15px;
            outline: none;
            font-family: inherit;
            direction: rtl;
            transition: var(--transition-smooth);
        }

        .home-search-input:focus {
            border-color: var(--color-chatzer);
            box-shadow: 0 0 0 4px rgba(156, 91, 181, 0.15);
        }

        .home-search-btn {
            padding: 15px 30px;
            background: var(--gradient-main);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .home-search-btn:hover {
            background: var(--gradient-main-dark);
            transform: translateY(-2px);
        }

        /* Stats Grid - 2 Stack Layout */
        .home-stats-grid {
            display: flex;
            gap: 20px;
            margin-bottom: 60px;
        }

        /* Hero ניגונים Card - Left Side, Full Height */
        .home-stat-hero {
            flex: 0 0 35%;
            background: linear-gradient(145deg, var(--color-nigun-pale) 0%, white 100%);
            border: 2px solid var(--color-nigun-pale);
            border-radius: 22px;
            padding: 40px 30px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-decoration: none;
            color: inherit;
        }

        .home-stat-hero:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
            border-color: var(--color-nigun);
        }

        .home-stat-hero .home-stat-number {
            font-size: 4.5em;
            font-weight: 700;
            color: var(--color-nigun-dark);
            font-family: 'Heebo', sans-serif;
        }

        .home-stat-hero .home-stat-label {
            font-size: 1.8em;
            color: var(--color-nigun);
            font-weight: 600;
            margin-top: 10px;
        }

        .home-stat-hero .home-stat-subtitle {
            font-size: 1em;
            color: var(--color-nigun);
            opacity: 0.8;
            margin-top: 0px;
        }

        /* Right Side - 2 Stacked Rows */
        .home-stats-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .home-stats-row {
            display: flex;
            gap: 20px;
            flex: 1;
        }

        /* Individual Stat Cards */
        .home-stat-card {
            flex: 1;
            background: white;
            border-radius: 18px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transform: translateY(0);
            text-decoration: none;
            color: inherit;
        }

        .home-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
        }

        .home-stat-number {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
            font-family: 'Heebo', sans-serif;
        }

        .home-stat-label {
            font-size: 1.05em;
            font-weight: 500;
        }

        /* Beautiful Category Colors */
        .home-stat-card.stat-chatzer {
            background: linear-gradient(145deg, var(--color-chatzer-pale) 0%, white 100%);
            border-color: var(--color-chatzer-pale);
        }

        .home-stat-card.stat-chatzer .home-stat-number {
            color: var(--color-chatzer-dark);
        }

        .home-stat-card.stat-chatzer .home-stat-label {
            color: var(--color-chatzer);
        }

        .home-stat-card.stat-chatzer:hover {
            border-color: var(--color-chatzer);
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
        }

        .home-stat-card.stat-mechaber {
            background: linear-gradient(145deg, var(--color-mechaber-pale) 0%, white 100%);
            border-color: var(--color-mechaber-pale);
        }

        .home-stat-card.stat-mechaber .home-stat-number {
            color: var(--color-mechaber-dark);
        }

        .home-stat-card.stat-mechaber .home-stat-label {
            color: var(--color-mechaber);
        }

        .home-stat-card.stat-mechaber:hover {
            border-color: var(--color-mechaber);
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
        }

        .home-stat-card.stat-verter {
            background: linear-gradient(145deg, var(--color-verter-pale) 0%, white 100%);
            border-color: var(--color-verter-pale);
        }

        .home-stat-card.stat-verter .home-stat-number {
            color: var(--color-verter-dark);
        }

        .home-stat-card.stat-verter .home-stat-label {
            color: var(--color-verter);
        }

        .home-stat-card.stat-verter:hover {
            border-color: var(--color-verter);
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
        }

        .home-stat-card.stat-zman {
            background: linear-gradient(145deg, var(--color-zman-pale) 0%, white 100%);
            border-color: var(--color-zman-pale);
        }

        .home-stat-card.stat-zman .home-stat-number {
            color: var(--color-zman-dark);
        }

        .home-stat-card.stat-zman .home-stat-label {
            color: var(--color-zman);
        }

        .home-stat-card.stat-zman:hover {
            border-color: var(--color-zman);
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
        }

        .home-stat-card.stat-collection {
            background: linear-gradient(145deg, var(--color-collection-pale) 0%, white 100%);
            border-color: var(--color-collection-pale);
        }

        .home-stat-card.stat-collection .home-stat-number {
            color: var(--color-collection-dark);
        }

        .home-stat-card.stat-collection .home-stat-label {
            color: var(--color-collection);
        }

        .home-stat-card.stat-collection:hover {
            border-color: var(--color-collection);
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
        }

        /* Statistics Link */
        .home-stats-link {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: -40px;
            margin-bottom: 50px;
            cursor: pointer;
            transition: var(--transition-smooth);
            width: 100%;
            gap: 15px;
            text-decoration: none;
            color: inherit;
        }

        .home-stats-link-line {
            flex: 1;
            height: 2px;
            background: var(--primary);
            border-radius: 2px;
            position: relative;
            transition: all 0.3s ease;
        }

        /* Right line (appears on LEFT in RTL) - has arrow pointing left (outward) */
        .home-stats-link-line::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            border-right: 8px solid var(--primary);
            transition: all 0.3s ease;
        }

        /* Left line (appears on RIGHT in RTL) - solid like the other line */
        .home-stats-link-line.left {
            background: var(--primary);
        }

        .home-stats-link-line.left::after {
            display: none;
        }

        .home-stats-link-text {
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.1em;
            font-weight: 600;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            padding: 8px 20px;
            position: relative;
            transition: var(--transition-smooth);
        }

        .home-stats-link:hover {
            transform: scale(1.03);
        }



        .home-stats-link:hover .home-stats-link-line {
            background: var(--color-mechaber);
        }

        .home-stats-link:hover .home-stats-link-line::after {
            border-right-color: var(--color-mechaber);
        }

        .home-stats-link:hover .home-stats-link-line.left {
            background: var(--color-mechaber);
        }


        .home-section-title {
            text-align: center;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .home-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .home-link-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 2px solid transparent;
        }

        .home-link-card:hover {
            border-color: var(--primary);
            transform: translateX(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        }

        /* Category-colored link cards on home page */
        .home-link-card.link-nigun .home-link-title {
            color: var(--color-nigun-dark);
        }

        .home-link-card.link-nigun:hover {
            border-color: var(--color-nigun);
            background: var(--color-nigun-pale);
        }

        .home-link-card.link-chatzer .home-link-title {
            color: var(--color-chatzer-dark);
        }

        .home-link-card.link-chatzer:hover {
            border-color: var(--color-chatzer);
            background: var(--color-chatzer-pale);
        }

        .home-link-card.link-mechaber .home-link-title {
            color: var(--color-mechaber-dark);
        }

        .home-link-card.link-mechaber:hover {
            border-color: var(--color-mechaber);
            background: var(--color-mechaber-pale);
        }

        .home-link-card.link-verter .home-link-title {
            color: var(--color-verter-dark);
        }

        .home-link-card.link-verter:hover {
            border-color: var(--color-verter);
            background: var(--color-verter-pale);
        }

        .home-link-card.link-zman .home-link-title {
            color: var(--color-zman-dark);
        }

        .home-link-card.link-zman:hover {
            border-color: var(--color-zman);
            background: var(--color-zman-pale);
        }

        .home-link-card.link-collection .home-link-title {
            color: var(--color-collection-dark);
        }

        .home-link-card.link-collection:hover {
            border-color: var(--color-collection);
            background: var(--color-collection-pale);
        }

        .home-link-card.link-resource .home-link-title {
            color: var(--color-resource-dark);
        }

        .home-link-card.link-resource:hover {
            border-color: var(--color-resource);
            background: var(--color-resource-pale);
        }

        .home-link-card.link-document .home-link-title {
            color: var(--color-document-dark);
        }

        .home-link-card.link-document:hover {
            border-color: var(--color-document);
            background: var(--color-document-pale);
        }

        .home-link-card.link-album .home-link-title {
            color: var(--color-album-dark);
        }

        .home-link-card.link-album:hover {
            border-color: var(--color-album);
            background: var(--color-album-pale);
        }

        .home-link-icon {
            font-size: 2.5em;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-pale);
            border-radius: 15px;
        }

        .home-link-text {
            flex: 1;
        }

        .home-link-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .home-link-desc {
            font-size: 0.9em;
            color: var(--text-muted);
        }

        /* Home Sections */
        .home-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: var(--card-shadow);
        }

        .home-section-title {
            color: var(--primary-deep);
            font-size: 1.4em;
            font-family: 'Heebo', sans-serif;
            font-weight: 600;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale, #f3e5f5);
        }

        .home-section-content {
            color: var(--text-dark);
            line-height: 1.8;
        }

        .home-section-content p {
            margin: 0 0 15px 0;
        }

        .home-section-content p:last-child {
            margin-bottom: 0;
        }

        /* Instructions */
        .instructions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: var(--bg-light);
            border-radius: 10px;
        }

        .instruction-number {
            width: 30px;
            height: 30px;
            background: var(--gradient-main);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .instruction-text {
            flex: 1;
        }

        /* Stats detailed */
        .stats-detailed {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background: var(--bg-light);
            border-radius: 8px;
        }

        .stat-label-lg {
            color: var(--text-muted);
        }

        .stat-value-lg {
            font-weight: 700;
            color: var(--primary);
        }

        /* Credits */
        .credits-list {
            margin-top: 15px;
        }

        .credit-item {
            padding: 10px 15px;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .credit-item:last-child {
            margin-bottom: 0;
        }

        /* Thanks */
        .thanks-list {
            margin: 15px 0;
            padding-right: 20px;
        }

        .thanks-list li {
            margin-bottom: 8px;
        }

        .blessing {
            font-style: italic;
            text-align: center;
            color: var(--primary);
            margin-top: 20px;
            padding: 15px;
            background: var(--primary-pale, #f3e5f5);
            border-radius: 10px;
        }

        /* Terms */
        .terms-content ul {
            margin: 15px 0;
            padding-right: 20px;
        }

        .terms-content li {
            margin-bottom: 8px;
        }

        @media (max-width: 600px) {
            .home-hero {
                padding: 35px 20px;
            }

            .home-title {
                font-size: 2em;
            }

            .home-logo {
                font-size: 3em;
            }

            .home-search-box {
                flex-direction: column;
            }

            .home-stats-grid {
                flex-direction: column;
            }

            .home-stat-hero {
                flex: none;
                padding: 35px 20px;
            }

            .home-stat-hero .home-stat-number {
                font-size: 3.5em;
            }

            .home-stat-hero .home-stat-label {
                font-size: 1.5em;
            }

            .home-stats-row {
                flex-wrap: wrap;
                gap: 12px;
            }

            .home-stat-card {
                flex: 1 1 45%;
                min-width: 120px;
                padding: 18px 12px;
            }

            .home-stat-number {
                font-size: 1.7em;
            }

            .home-links-grid {
                grid-template-columns: 1fr;
            }

            .home-about-links {
                grid-template-columns: repeat(2, 1fr);
            }

            .home-about-link {
                padding: 14px 10px;
                font-size: 0.85em;
                border-bottom: 1px solid var(--color-chatzer-pale);
            }

            .home-about-link:nth-child(2n+1) {
                border-left: none;
            }
        }

        @media (max-width: 500px) {
            .home-stat-card {
                flex: 1 1 100%;
            }

            .home-about-links {
                grid-template-columns: 1fr;
            }

            .home-about-link {
                border-left: none !important;
            }
        }

        /* Page Title - now the colored box itself */
        .page-title {
            background: var(--color-nigun);
            /* Default, overridden by page themes */
            border-radius: 0 0 30px 30px;
            /* Square top, rounded bottom */
            box-shadow: var(--card-shadow);
            margin-bottom: 0;
            overflow: visible;
            position: relative;
            z-index: 99;
            text-align: center;
            padding: 20px 25px 15px 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Smooth transitions for compact mode */
            transition: padding 0.4s ease, box-shadow 0.4s ease, border-radius 0.4s ease;
        }

        /* Fixed mode - JavaScript controlled */
        .page-title.is-fixed {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            z-index: 99;
            border-radius: 0 0 20px 20px;
            /* Compact mode - smaller when fixed */
            padding: 8px 25px 10px 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            /* Smooth transition for top when main-header hides/shows */
            transition: top 0.4s ease, padding 0.4s ease, box-shadow 0.4s ease, border-radius 0.4s ease;
        }

        /* When main header is hidden, page-title moves to top */
        .page-title.is-fixed.main-hidden {
            top: 0 !important;
            border-radius: 0 0 20px 20px;
        }

        /* Compact title text when fixed */
        .page-title.is-fixed .page-title-bar {
            font-size: 2.5em;
            margin-top: 0;
        }

        /* Hide subtitle when fixed - using opacity/max-height for smooth animation */
        .page-title.is-fixed .subtitle {
            opacity: 0;
            max-height: 0;
        }

        /* Wave bar at bottom of colored box */
        .page-title>.loading-wave-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        /* Title name - now below number, BIGGER */
        .page-title-bar {
            font-size: 4em;
            font-weight: 700;
            font-family: 'Heebo', sans-serif;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            line-height: 1.2;
            order: 2;
            /* Show second */
            margin-top: 10px;
            transition: font-size 0.4s ease, margin-top 0.4s ease;
        }

        /* Hide the white content area */
        .page-title-content {
            display: none;
        }

        .page-title-icon {
            display: none;
        }

        /* Number - now on top, SMALLER */
        .page-title .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2em;
            font-weight: 500;
            text-align: center;
            display: block;
            width: 100%;
            order: 1;
            /* Show first */
            transition: opacity 0.3s ease, max-height 0.4s ease;
            max-height: 50px;
            opacity: 1;
            overflow: hidden;
        }

        /* Filters container inside page-title */
        .page-title-filters {
            display: none;
        }

        /* Sub-header bar for settings/filters */
        .page-settings-bar {
            position: relative;
            /* Changed from sticky - JS manages fixed */
            z-index: 98;
            background: var(--color-nigun-pale);
            padding: 10px 40px;
            display: flex;
            justify-content: center;
            margin: 0 auto 25px auto;
            border-radius: 0 0 25px 25px;
            /* Shadow going down + inset shadow from top (from main header) */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 8px 12px -8px rgba(74, 124, 201, 0.3);
            /* Border on sides and bottom in nigun color */
            border: 2px solid var(--color-nigun-light);
            border-top: none;
            width: 90%;
            max-width: calc(100% - 40px);
            /* Transition for filter panel expand/collapse animation + merge animation */
            transition: padding-bottom 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                top 0.4s ease,
                transform 0.4s ease,
                margin-top 0.4s ease,
                border-radius 0.4s ease;
        }

        /* Note: settings-bar stays in normal flow, only page-title becomes fixed */

        /* ========== Scroll-Aware Sticky Headers ========== */
        /* When main header is hidden, page-title moves to top */
        .page-title.main-hidden {
            top: 0 !important;
            /* Takes over top position when main header hides */
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        /* Settings-bar styling when merged with page-title */
        .page-settings-bar.merged {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .page-title.sub-merged {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        /* ========== Category-Themed Settings Bars ========== */
        /* Mechaber theme */
        .page-theme-mechaber .page-settings-bar {
            background: var(--color-mechaber-pale);
            border-color: var(--color-mechaber-light);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 8px 12px -8px rgba(196, 53, 168, 0.3);
        }

        .page-theme-mechaber .page-settings-bar .slider-option svg,
        .page-theme-mechaber .page-settings-bar .slider-control:hover .slider-option svg,
        .page-theme-mechaber .page-settings-bar .slider-control:hover .slider-option.active svg {
            fill: var(--color-mechaber);
        }

        .page-theme-mechaber .page-settings-bar .slider-option .slider-option-label {
            color: var(--color-mechaber-dark);
        }

        .page-theme-mechaber .page-settings-bar .search-trigger-btn {
            border-color: var(--color-mechaber);
            color: var(--color-mechaber-dark);
        }

        .page-theme-mechaber .page-settings-bar .search-trigger-btn:hover,
        .page-theme-mechaber .page-settings-bar .search-trigger-btn.has-active {
            background: var(--color-mechaber);
            border-color: var(--color-mechaber);
        }

        .page-theme-mechaber .page-settings-bar .expandable-search-input-wrapper {
            background: var(--color-mechaber);
        }

        .page-theme-mechaber .page-settings-bar .search-trigger-btn .search-text-display {
            color: var(--color-mechaber);
        }

        .page-theme-mechaber .page-settings-bar .search-trigger-btn .clear-search-x {
            color: var(--color-mechaber);
        }

        /* Chatzer theme */
        .page-theme-chatzer .page-settings-bar {
            background: var(--color-chatzer-pale);
            border-color: var(--color-chatzer-light);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 8px 12px -8px rgba(156, 91, 181, 0.3);
        }

        .page-theme-chatzer .page-settings-bar .slider-option svg,
        .page-theme-chatzer .page-settings-bar .slider-control:hover .slider-option svg,
        .page-theme-chatzer .page-settings-bar .slider-control:hover .slider-option.active svg {
            fill: var(--color-chatzer);
        }

        .page-theme-chatzer .page-settings-bar .slider-option .slider-option-label {
            color: var(--color-chatzer-dark);
        }

        .page-theme-chatzer .page-settings-bar .search-trigger-btn {
            border-color: var(--color-chatzer);
            color: var(--color-chatzer-dark);
        }

        .page-theme-chatzer .page-settings-bar .search-trigger-btn:hover,
        .page-theme-chatzer .page-settings-bar .search-trigger-btn.has-active {
            background: var(--color-chatzer);
            border-color: var(--color-chatzer);
        }

        .page-theme-chatzer .page-settings-bar .expandable-search-input-wrapper {
            background: var(--color-chatzer);
        }

        .page-theme-chatzer .page-settings-bar .search-trigger-btn .search-text-display {
            color: var(--color-chatzer);
        }

        .page-theme-chatzer .page-settings-bar .search-trigger-btn .clear-search-x {
            color: var(--color-chatzer);
        }

        /* Verter theme */
        .page-theme-verter .page-settings-bar {
            background: var(--color-verter-pale);
            border-color: var(--color-verter-light);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 8px 12px -8px rgba(107, 114, 128, 0.3);
        }

        .page-theme-verter .page-settings-bar .search-trigger-btn {
            border-color: var(--color-verter);
            color: var(--color-verter-dark);
        }

        .page-theme-verter .page-settings-bar .search-trigger-btn:hover,
        .page-theme-verter .page-settings-bar .search-trigger-btn.has-active {
            background: var(--color-verter);
            border-color: var(--color-verter);
        }

        .page-theme-verter .page-settings-bar .expandable-search-input-wrapper {
            background: var(--color-verter);
        }

        .page-theme-verter .page-settings-bar .search-trigger-btn .search-text-display {
            color: var(--color-verter);
        }

        .page-theme-verter .page-settings-bar .slider-option svg,
        .page-theme-verter .page-settings-bar .slider-control:hover .slider-option svg,
        .page-theme-verter .page-settings-bar .slider-control:hover .slider-option.active svg {
            fill: var(--color-verter);
        }

        .page-theme-verter .page-settings-bar .slider-option .slider-option-label {
            color: var(--color-verter-dark);
        }

        .page-theme-verter .page-settings-bar .search-trigger-btn .clear-search-x {
            color: var(--color-verter);
        }

        /* Zman theme */
        .page-theme-zman .page-settings-bar {
            background: var(--color-zman-pale);
            border-color: var(--color-zman-light);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 8px 12px -8px rgba(233, 106, 27, 0.3);
        }

        .page-theme-zman .page-settings-bar .search-trigger-btn {
            border-color: var(--color-zman);
            color: var(--color-zman-dark);
        }

        .page-theme-zman .page-settings-bar .search-trigger-btn:hover,
        .page-theme-zman .page-settings-bar .search-trigger-btn.has-active {
            background: var(--color-zman);
            border-color: var(--color-zman);
        }

        .page-theme-zman .page-settings-bar .expandable-search-input-wrapper {
            background: var(--color-zman);
        }

        .page-theme-zman .page-settings-bar .search-trigger-btn .search-text-display {
            color: var(--color-zman);
        }

        .page-theme-zman .page-settings-bar .search-trigger-btn .clear-search-x {
            color: var(--color-zman);
        }

        /* Collection theme */
        .page-theme-collection .page-settings-bar {
            background: var(--color-collection-pale);
            border-color: var(--color-collection-light);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 8px 12px -8px rgba(198, 40, 40, 0.3);
        }

        .page-theme-collection .page-settings-bar .search-trigger-btn {
            border-color: var(--color-collection);
            color: var(--color-collection-dark);
        }

        .page-theme-collection .page-settings-bar .search-trigger-btn:hover,
        .page-theme-collection .page-settings-bar .search-trigger-btn.has-active {
            background: var(--color-collection);
            border-color: var(--color-collection);
        }

        .page-theme-collection .page-settings-bar .expandable-search-input-wrapper {
            background: var(--color-collection);
        }

        .page-theme-collection .page-settings-bar .search-trigger-btn .search-text-display {
            color: var(--color-collection);
        }

        .page-theme-collection .page-settings-bar .search-trigger-btn .clear-search-x {
            color: var(--color-collection);
        }

        /* Piyut theme */
        .page-theme-piyut .page-settings-bar {
            background: var(--color-piyut-pale);
            border-color: var(--color-piyut-light);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 8px 12px -8px rgba(46, 139, 46, 0.3);
        }

        .page-theme-piyut .page-settings-bar .search-trigger-btn {
            border-color: var(--color-piyut);
            color: var(--color-piyut-dark);
        }

        .page-theme-piyut .page-settings-bar .search-trigger-btn:hover,
        .page-theme-piyut .page-settings-bar .search-trigger-btn.has-active {
            background: var(--color-piyut);
            border-color: var(--color-piyut);
        }

        .page-theme-piyut .page-settings-bar .expandable-search-input-wrapper {
            background: var(--color-piyut);
        }

        .page-theme-piyut .page-settings-bar .search-trigger-btn .search-text-display {
            color: var(--color-piyut);
        }

        .page-theme-piyut .page-settings-bar .search-trigger-btn .clear-search-x {
            color: var(--color-piyut);
        }

        /* Grid layout variants for different button counts */
        .page-settings-bar .detail-filters-group.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .page-settings-bar .detail-filters-group.cols-1 {
            grid-template-columns: 1fr;
            max-width: 300px;
        }

        .page-settings-bar .detail-filters-group {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;

            padding: 0;
            width: 100%;
        }

        /* Filter Mega-Menu - button stays in normal flow, static so expanded positions to settings bar */
        .filter-mega-menu {
            position: static;
            height: 48px;
            display: flex;
            align-items: center;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            overflow: visible;
            z-index: 50;
        }

        .filter-mega-trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0 16px;
            height: 100%;
            width: 100%;
            cursor: pointer;
            white-space: nowrap;
            color: var(--color-nigun-dark);
            font-weight: 600;
            font-size: 0.9em;
            border-radius: inherit;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .filter-mega-trigger .filter-btn-icon {
            width: 18px;
            height: 18px;
            stroke: var(--color-nigun);
            transition: stroke 0.2s ease;
        }

        /* Filter badge container - both count and X stack here */
        .filter-mega-trigger .filter-count,
        .filter-mega-trigger .filter-clear-btn {
            position: absolute;
            left: 8px;
            background: white;
            color: var(--color-nigun);
            font-size: 0.75em;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 16px;
            text-align: center;
            transition: opacity 0.2s ease;
        }

        /* Count visible by default */
        .filter-mega-trigger .filter-count {
            opacity: 1;
        }

        /* Clear button hidden by default */
        .filter-mega-trigger .filter-clear-btn {
            opacity: 0;
            cursor: pointer;
            pointer-events: none;
        }

        /* On hover: fade count out, fade X in */
        .filter-mega-menu:hover .filter-mega-trigger.has-active .filter-count {
            opacity: 0;
        }

        .filter-mega-menu:hover .filter-mega-trigger.has-active .filter-clear-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .filter-mega-label {
            transition: opacity 0.2s ease, color 0.2s ease;
        }

        /* Hover state - subtle effect */
        .filter-mega-trigger:hover {
            background: rgba(74, 124, 201, 0.15);
        }

        /* Active filter state - blue background */
        .filter-mega-trigger.has-active {
            background: var(--color-nigun);
            color: white;
        }

        .filter-mega-trigger.has-active .filter-btn-icon {
            stroke: white;
        }

        .filter-mega-trigger.has-active .filter-count {
            background: white;
            color: var(--color-nigun);
        }

        /* Keep menu rounded when filter is active */
        .filter-mega-menu:has(.filter-mega-trigger.has-active) {
            background: transparent;
        }

        .filter-mega-trigger.has-active {
            border-radius: 12px;
        }

        /* Expanded filter panel - ABSOLUTE for Phase 1 overlay, sub-header grows for Phase 2 */
        .filter-mega-expanded {
            position: absolute;
            top: 10px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(74, 124, 201, 0.25);
            overflow: hidden;
            z-index: 200;

            /* Collapsed state - clips from top */
            visibility: hidden;
            clip-path: inset(0 0 100% 0 round 12px);
            /* Single combined transition - no delays */
            transition: clip-path 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                visibility 0s 0.35s;
        }

        /* The inner content - grid of columns */
        .filter-mega-expanded-inner {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            width: 100%;
            /* Headers visible immediately - no opacity animation */
        }

        /* Options animate with panel - no separate phase */
        .filter-mega-options {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            /* Fade in/out with panel */
            transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.25s ease;
        }

        .filter-mega-menu.expanded {
            z-index: 199;
            /* Below the expanded panel */
        }

        .filter-mega-menu.expanded .filter-mega-label {
            opacity: 0;
        }

        /* Expanded state - single phase animation */
        .filter-mega-expanded.expanded {
            visibility: visible;
            clip-path: inset(0 0 0 0 round 12px);
            /* Single combined transition - no delays */
            transition: clip-path 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                visibility 0s;
        }

        /* Headers stay visible during entire animation - no opacity change needed */

        /* Sub-header grows to make space for expanded panels */
        .page-settings-bar.filter-expanded {
            padding-bottom: 220px;
            /* Make room for expanded options */
            transition: padding-bottom 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-settings-bar.quality-expanded {
            padding-bottom: 50px;
            /* Make room for quality options row */
            transition: padding-bottom 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Options visible when expanded - no delay */
        .filter-mega-expanded.expanded.show-options .filter-mega-options {
            max-height: 200px;
            opacity: 1;
            overflow-y: auto;
        }

        /* Themed scrollbars for each category */
        .filter-mega-options::-webkit-scrollbar {
            width: 6px;
        }

        .filter-mega-options::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .filter-mega-column[data-category="collection"] .filter-mega-options::-webkit-scrollbar-thumb {
            background: var(--color-collection);
            border-radius: 3px;
        }

        .filter-mega-column[data-category="chatzer"] .filter-mega-options::-webkit-scrollbar-thumb {
            background: var(--color-chatzer);
            border-radius: 3px;
        }

        .filter-mega-column[data-category="mechaber"] .filter-mega-options::-webkit-scrollbar-thumb {
            background: var(--color-mechaber);
            border-radius: 3px;
        }

        .filter-mega-column[data-category="verter"] .filter-mega-options::-webkit-scrollbar-thumb {
            background: var(--color-verter);
            border-radius: 3px;
        }

        .filter-mega-column[data-category="gezungen"] .filter-mega-options::-webkit-scrollbar-thumb {
            background: var(--color-piyut);
            border-radius: 3px;
        }

        .filter-mega-column[data-category="ritem"] .filter-mega-options::-webkit-scrollbar-thumb {
            background: var(--color-music);
            border-radius: 3px;
        }

        .filter-mega-column[data-category="skeyl"] .filter-mega-options::-webkit-scrollbar-thumb {
            background: var(--color-music);
            border-radius: 3px;
        }

        /* Each filter column */
        .filter-mega-column {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* Category header - colored based on category */
        .filter-mega-header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 6px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 36px;
            max-height: 36px;
            overflow: hidden;
        }

        .filter-mega-header:hover {
            filter: brightness(0.95);
            transform: scale(1.02);
        }

        /* Search input in category header */
        .filter-mega-search {
            display: none;
            width: 100%;
            padding: 4px 8px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 0.8em;
            text-align: center;
            outline: none;
        }

        .filter-mega-header.searching .filter-mega-search {
            display: block;
        }

        .filter-mega-header.searching .filter-mega-header-text {
            display: none;
        }

        /* Search icon indicator */
        .filter-mega-search-icon {
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75em;
            opacity: 0.7;
            color: currentColor;
            font-style: normal;
        }

        /* Selected filter tags in header */
        .filter-mega-header-tags {
            display: flex;
            flex-wrap: nowrap;
            gap: 4px;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            max-width: 100%;
        }

        .filter-header-tag {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.3);
            color: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        }

        .filter-header-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .filter-header-tag .tag-x {
            font-size: 0.9em;
            opacity: 0.6;
            font-weight: 700;
            margin-right: 2px;
        }

        .filter-header-tag:hover .tag-x {
            opacity: 1;
        }

        .filter-mega-header.searching .filter-mega-header-tags {
            display: none;
        }

        /* Legacy filter mini tags - kept for compatibility */
        .filter-mini-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
            justify-content: center;
        }

        .filter-mini-tag {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.9);
            color: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .filter-mini-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .filter-mini-tag .tag-x {
            font-size: 0.9em;
            opacity: 0.7;
            font-weight: 700;
        }

        .filter-mini-tag:hover .tag-x {
            opacity: 1;
        }

        /* Tags inside main filter button when closed */
        .filter-button-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-right: 8px;
        }

        .filter-button-tag {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.25);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .filter-button-tag:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .filter-button-tag .tag-x {
            font-size: 0.85em;
            opacity: 0.7;
        }

        /* Category-specific header colors */
        .filter-mega-column[data-category="collection"] .filter-mega-header {
            background: var(--color-collection-pale);
            color: var(--color-collection-dark);
        }

        .filter-mega-column[data-category="collection"] .filter-mega-header.has-active {
            background: var(--color-collection);
            color: white;
        }

        .filter-mega-column[data-category="chatzer"] .filter-mega-header {
            background: var(--color-chatzer-pale);
            color: var(--color-chatzer-dark);
        }

        .filter-mega-column[data-category="chatzer"] .filter-mega-header.has-active {
            background: var(--color-chatzer);
            color: white;
        }

        .filter-mega-column[data-category="mechaber"] .filter-mega-header {
            background: var(--color-mechaber-pale);
            color: var(--color-mechaber-dark);
        }

        .filter-mega-column[data-category="mechaber"] .filter-mega-header.has-active {
            background: var(--color-mechaber);
            color: white;
        }

        .filter-mega-column[data-category="verter"] .filter-mega-header {
            background: var(--color-verter-pale);
            color: var(--color-verter-dark);
        }

        .filter-mega-column[data-category="verter"] .filter-mega-header.has-active {
            background: var(--color-verter);
            color: white;
        }

        .filter-mega-column[data-category="gezungen"] .filter-mega-header {
            background: var(--color-piyut-pale);
            color: var(--color-piyut-dark);
        }

        .filter-mega-column[data-category="gezungen"] .filter-mega-header.has-active {
            background: var(--color-piyut);
            color: white;
        }

        .filter-mega-column[data-category="ritem"] .filter-mega-header {
            background: var(--color-music-pale);
            color: var(--color-music-dark);
        }

        .filter-mega-column[data-category="ritem"] .filter-mega-header.has-active {
            background: var(--color-music);
            color: white;
        }

        .filter-mega-column[data-category="scale"] .filter-mega-header {
            background: var(--color-music-pale);
            color: var(--color-music-dark);
        }

        .filter-mega-column[data-category="scale"] .filter-mega-header.has-active {
            background: var(--color-music);
            color: white;
        }

        .filter-mega-header .mega-cat-count {
            background: white;
            color: inherit;
            font-size: 0.75em;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 8px;
        }

        /* Options container */
        .filter-mega-options {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* Each option row - white bg, light theme text */
        .filter-mega-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            background: white;
            transition: all 0.15s ease;
        }

        /* Unavailable filter options (cascading filters) */
        .filter-mega-option.unavailable {
            opacity: 0.35;
            pointer-events: none;
            order: 999;
        }

        .filter-mega-option input[type="checkbox"] {
            width: 14px;
            height: 14px;
            margin: 0;
            cursor: pointer;
        }

        /* Category-specific checkbox colors */
        .filter-mega-column[data-category="collection"] .filter-mega-option input[type="checkbox"] {
            accent-color: var(--color-collection);
        }

        .filter-mega-column[data-category="chatzer"] .filter-mega-option input[type="checkbox"] {
            accent-color: var(--color-chatzer);
        }

        .filter-mega-column[data-category="mechaber"] .filter-mega-option input[type="checkbox"] {
            accent-color: var(--color-mechaber);
        }

        .filter-mega-column[data-category="verter"] .filter-mega-option input[type="checkbox"] {
            accent-color: var(--color-verter);
            /* Green for verter */
        }

        .filter-mega-column[data-category="gezungen"] .filter-mega-option input[type="checkbox"] {
            accent-color: var(--color-piyut);
        }

        .filter-mega-column[data-category="ritem"] .filter-mega-option input[type="checkbox"] {
            accent-color: var(--color-music);
            /* Music theme yellow */
        }

        .filter-mega-column[data-category="scale"] .filter-mega-option input[type="checkbox"] {
            accent-color: var(--color-music);
            /* Music theme yellow */
        }

        /* Category-specific option colors */
        .filter-mega-column[data-category="collection"] .filter-mega-option {
            color: var(--color-collection-light);
        }

        .filter-mega-column[data-category="collection"] .filter-mega-option:hover {
            background: var(--color-collection-pale);
            color: var(--color-collection-dark);
        }

        .filter-mega-column[data-category="collection"] .filter-mega-option.selected {
            background: var(--color-collection-pale);
            color: var(--color-collection);
        }

        .filter-mega-column[data-category="chatzer"] .filter-mega-option {
            color: var(--color-chatzer-light);
        }

        .filter-mega-column[data-category="chatzer"] .filter-mega-option:hover {
            background: var(--color-chatzer-pale);
            color: var(--color-chatzer-dark);
        }

        .filter-mega-column[data-category="chatzer"] .filter-mega-option.selected {
            background: var(--color-chatzer-pale);
            color: var(--color-chatzer);
        }

        .filter-mega-column[data-category="mechaber"] .filter-mega-option {
            color: var(--color-mechaber-light);
        }

        .filter-mega-column[data-category="mechaber"] .filter-mega-option:hover {
            background: var(--color-mechaber-pale);
            color: var(--color-mechaber-dark);
        }

        .filter-mega-column[data-category="mechaber"] .filter-mega-option.selected {
            background: var(--color-mechaber-pale);
            color: var(--color-mechaber);
        }

        .filter-mega-column[data-category="verter"] .filter-mega-option {
            color: var(--color-verter-light);
        }

        .filter-mega-column[data-category="verter"] .filter-mega-option:hover {
            background: var(--color-verter-pale);
            color: var(--color-verter-dark);
        }

        .filter-mega-column[data-category="verter"] .filter-mega-option.selected {
            background: var(--color-verter-pale);
            color: var(--color-verter);
        }

        .filter-mega-column[data-category="gezungen"] .filter-mega-option {
            color: var(--color-piyut-light);
        }

        .filter-mega-column[data-category="gezungen"] .filter-mega-option:hover {
            background: var(--color-piyut-pale);
            color: var(--color-piyut-dark);
        }

        .filter-mega-column[data-category="gezungen"] .filter-mega-option.selected {
            background: var(--color-piyut-pale);
            color: var(--color-piyut);
        }

        .filter-mega-column[data-category="ritem"] .filter-mega-option {
            color: var(--color-music-light);
        }

        .filter-mega-column[data-category="ritem"] .filter-mega-option:hover {
            background: var(--color-music-pale);
            color: var(--color-music-dark);
        }

        .filter-mega-column[data-category="ritem"] .filter-mega-option.selected {
            background: var(--color-music-pale);
            color: var(--color-music);
        }

        .filter-mega-column[data-category="scale"] .filter-mega-option {
            color: var(--color-music-light);
        }

        .filter-mega-column[data-category="scale"] .filter-mega-option:hover {
            background: var(--color-music-pale);
            color: var(--color-music-dark);
        }

        .filter-mega-column[data-category="scale"] .filter-mega-option.selected {
            background: var(--color-music-pale);
            color: var(--color-music);
        }

        /* "More..." link */
        .filter-mega-more {
            padding: 4px 8px;
            font-size: 0.75em;
            color: var(--text-muted);
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .filter-mega-more:hover {
            background: var(--color-nigun-pale);
            color: var(--color-nigun-dark);
        }

        /* Quality Mega-Menu - same animation as Filter Mega-Menu */
        .quality-mega-menu {
            position: static;
            height: 48px;
            display: flex;
            align-items: center;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            overflow: visible;
            z-index: 50;
        }

        .quality-mega-trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0 16px;
            height: 100%;
            width: 100%;
            cursor: pointer;
            white-space: nowrap;
            color: var(--color-nigun-dark);
            font-weight: 600;
            font-size: 0.9em;
            border-radius: inherit;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .quality-mega-trigger .audio-icon {
            width: 18px;
            height: 18px;
            stroke: var(--color-nigun);
            transition: stroke 0.2s ease;
        }

        .quality-mega-trigger .quality-mega-label {
            color: var(--color-nigun-dark);
            font-weight: 600;
            transition: color 0.2s ease;
        }

        /* Quality stars badge - matches filter count */
        .quality-mega-trigger .quality-stars-badge {
            position: absolute;
            left: 8px;
            background: white;
            color: var(--color-nigun);
            font-size: 0.6em;
            font-weight: 700;
            padding: 3px 5px 2px;
            border-radius: 8px;
            letter-spacing: -1px;
            line-height: 1.1;
            text-align: center;
            transition: opacity 0.2s ease;
            opacity: 1;
        }

        /* Hover state - subtle effect */
        .quality-mega-trigger:hover {
            background: rgba(74, 124, 201, 0.15);
        }

        /* Active quality state */
        .quality-mega-trigger.has-active {
            background: var(--color-nigun);
            color: white;
        }

        .quality-mega-trigger.has-active .audio-icon {
            stroke: white;
        }

        .quality-mega-trigger.has-active .quality-mega-label {
            color: white;
        }

        .quality-mega-menu:has(.quality-mega-trigger.has-active) {
            background: transparent;
        }

        /* Quality clear button - matches filter clear btn */
        .quality-clear-btn {
            position: absolute;
            left: 8px;
            background: white;
            color: var(--color-nigun);
            font-size: 0.75em;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 16px;
            text-align: center;
            cursor: pointer;
            transition: opacity 0.2s ease;
            opacity: 0;
            pointer-events: none;
        }

        /* On hover: fade stars out, fade X in */
        .quality-mega-menu:hover .quality-mega-trigger.has-active .quality-stars-badge {
            opacity: 0;
        }

        .quality-mega-menu:hover .quality-mega-trigger.has-active .quality-clear-btn {
            opacity: 1;
            pointer-events: auto;
        }

        /* Expanded quality panel */
        .quality-mega-expanded {
            position: absolute;
            top: 10px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(74, 124, 201, 0.25);
            overflow: hidden;
            z-index: 200;

            /* Collapsed state - starts from quality button position + collapsed vertically (clips from bottom) */
            visibility: hidden;
            clip-path: inset(0 95% 100% 5% round 12px);
            /* When closing: collapse clip-path with delay */
            transition: clip-path 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.1s,
                visibility 0s 0.5s;
        }

        /* Quality options row */
        .quality-mega-expanded-inner {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            width: 100%;
        }

        /* Each quality option */
        .quality-mega-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 10px 8px;
            border-radius: 10px;
            cursor: pointer;
            background: var(--color-nigun-pale);
            color: var(--color-nigun-dark);
            transition: all 0.2s ease;
            text-align: center;
        }

        .quality-mega-option:hover {
            background: rgba(74, 124, 201, 0.15);
            transform: scale(1.03);
        }

        .quality-mega-option.active {
            background: var(--color-nigun);
            color: white;
        }

        .quality-mega-option .quality-option-stars {
            font-size: 1.1em;
            letter-spacing: 1px;
        }

        .quality-mega-option .quality-option-label {
            font-size: 0.7em;
            font-weight: 500;
            opacity: 0.9;
        }

        .quality-mega-menu.expanded {
            z-index: 199;
        }

        .quality-mega-menu.expanded .quality-mega-trigger {
            opacity: 0;
        }

        /* When expanded: fully visible */
        .quality-mega-expanded.expanded {
            visibility: visible;
            clip-path: inset(0 0 0 0 round 12px);
            transition: clip-path 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                visibility 0s;
        }

        /* Filter Category Overlay Modal */
        .filter-category-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .filter-category-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .filter-category-modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .filter-category-overlay.active .filter-category-modal {
            transform: translateY(0);
        }

        .filter-category-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-nigun-pale);
        }

        .filter-category-modal-header h3 {
            margin: 0;
            color: var(--color-nigun-dark);
            font-size: 1.1em;
        }

        .filter-category-modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--color-nigun);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .filter-category-modal-close:hover {
            background: var(--color-nigun-pale);
        }

        .filter-category-modal-body {
            padding: 12px;
            overflow-y: auto;
            max-height: 50vh;
        }

        .filter-category-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-category-option:hover {
            background: var(--color-nigun-pale);
        }

        .filter-category-option.selected {
            background: var(--color-nigun);
            color: white;
        }

        .filter-category-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--color-nigun);
        }

        .filter-category-option span {
            font-size: 0.95em;
        }

        /* Slider Control Component */
        .slider-control {
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            cursor: pointer;
            height: 48px;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .slider-control:hover {
            background: transparent;
            box-shadow: none;
        }

        /* Track container */
        .slider-options-track {
            display: flex;
            align-items: stretch;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 3px;
            gap: 2px;
        }

        /* Sliding WHITE indicator - visible always, creates the white button effect */
        .slider-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: top 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                right 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                width 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                border-radius 0.3s ease,
                box-shadow 0.3s ease;
            z-index: 1;
            pointer-events: none;
            opacity: 1;
        }

        /* Hover: indicator shrinks to selected position */
        .slider-control:hover .slider-indicator {
            top: 3px;
            bottom: 3px;
            width: calc(33.333% - 4px);
            border-radius: 9px;
        }

        .slider-control:hover .slider-indicator[data-position="0"] {
            right: 3px;
        }

        .slider-control:hover .slider-indicator[data-position="1"] {
            right: calc(33.333% + 1px);
        }

        .slider-control:hover .slider-indicator[data-position="2"] {
            right: calc(66.666% - 1px);
        }

        /* 2-option slider modifier */
        /* Active option takes full width (default behavior inherited) */
        /* Non-active options hidden by default (inherited from base rules) */

        /* On hover: both options visible with 50% width each */
        .slider-control.slider-2-options:hover .slider-option {
            flex: 1;
        }

        .slider-control.slider-2-options:hover .slider-indicator {
            width: calc(50% - 4px);
        }

        .slider-control.slider-2-options:hover .slider-indicator[data-position="0"] {
            right: 3px;
        }

        .slider-control.slider-2-options:hover .slider-indicator[data-position="1"] {
            right: calc(50% + 1px);
        }

        /* Each option slot */
        .slider-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border-radius: 9px;
            cursor: pointer;
            position: relative;
            z-index: 2;
            transition: flex 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                background 0.3s ease,
                box-shadow 0.3s ease;
            background: transparent;
            overflow: hidden;
            flex: 0;
            min-width: 0;
            padding: 0 4px;
        }

        /* Default: icon is blue */
        .slider-option svg {
            width: 16px;
            height: 16px;
            fill: var(--color-nigun);
            transition: fill 0.3s ease;
            flex-shrink: 0;
            order: -1;
        }

        /* Active option takes full width by default */
        .slider-option.active {
            flex: 1;
            background: transparent;
            transition: flex 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Non-active options: hidden by default */
        .slider-option:not(.active) {
            flex: 0;
            padding: 0;
        }

        /* Default: label is blue */
        .slider-option .slider-option-label {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--color-nigun-dark);
            white-space: nowrap;
            overflow: hidden;
            /* Fade-in on collapse: delay the opacity slightly so width expands first */
            transition: max-width 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.3s ease-in-out 0.1s,
                color 0.2s ease,
                transform 0.3s ease-out 0.05s;
            transform: translateX(0);
        }

        .slider-option.active .slider-option-label {
            max-width: 150px;
            opacity: 1;
            transform: translateX(0);
        }

        .slider-option:not(.active) .slider-option-label {
            max-width: 0;
            opacity: 0;
            transform: translateX(-5px);
        }

        /* On hover - all options become equal width */
        .slider-control:hover .slider-option {
            flex: 1;
            padding: 0 6px;
        }

        /* On hover - hide all labels with fade (instant, no delay) */
        .slider-control:hover .slider-option .slider-option-label {
            max-width: 0;
            opacity: 0;
            transform: translateX(-5px);
            /* Override delay for quick fade-out on hover */
            transition: max-width 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.15s ease-out,
                color 0.2s ease,
                transform 0.2s ease-out;
        }

        /* On hover - active icon stays blue (no change) */
        .slider-control:hover .slider-option.active svg {
            fill: var(--color-nigun);
        }

        /* Non-active options on hover: transparent to blend with control bg */
        .slider-control:hover .slider-option:not(.active) {
            background: transparent;
        }

        .slider-control:hover .slider-option:not(.active):hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .page-settings-bar .detail-filter-dropdown {
            /* width: 130px; REMOVED fixed width */
            flex: 1;
            /* Match slider flex behavior */
        }

        .page-settings-bar .filter-panel-dropdown {
            /* width: 130px; REMOVED fixed width */
            flex: 1;
            /* Match slider flex behavior */
        }

        .page-settings-bar .detail-filter-current {
            background: white;
            color: var(--color-nigun-dark);
            padding: 0 16px;
            /* Adjusted padding for height */
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            height: 48px;
            /* Match slider height */
            display: flex;
            /* Centering content */
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.15s ease;
        }

        .page-settings-bar .detail-filter-current:hover,
        .page-settings-bar .detail-filter-dropdown:hover .detail-filter-current {
            background: var(--color-nigun);
            color: white;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .page-settings-bar .filter-panel-btn {
            background: white;
            color: var(--color-nigun-dark);
            border: none;
            padding: 0 16px;
            /* Adjusted padding for height */
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            height: 48px;
            /* Match slider height */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.15s ease;
        }

        .page-settings-bar .filter-panel-btn:hover,
        .page-settings-bar .filter-panel-dropdown:hover .filter-panel-btn {
            background: var(--color-nigun);
            color: white;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* Search button - base style */
        .page-settings-bar .search-trigger-btn {
            background: transparent;
            color: var(--color-nigun-dark);
            border: 2px solid var(--color-nigun);
            padding: 0 35px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .page-settings-bar .search-trigger-btn:hover {
            background: var(--color-nigun);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* When search is active - show the search text */
        .page-settings-bar .search-trigger-btn.has-active {
            background: var(--color-nigun);
            color: white;
            border: 2px solid var(--color-nigun);
            min-width: 140px;
            position: relative;
            font-size: 1em;
        }

        /* Default state: icon and label visible */
        .page-settings-bar .search-trigger-btn .search-icon,
        .page-settings-bar .search-trigger-btn .search-label {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        /* Active state: icon and label fade out */
        .page-settings-bar .search-trigger-btn.has-active .search-icon,
        .page-settings-bar .search-trigger-btn.has-active .search-label {
            opacity: 0;
            visibility: hidden;
            position: absolute;
            pointer-events: none;
        }

        /* Text display - hidden by default */
        .page-settings-bar .search-trigger-btn .search-text-display {
            position: absolute;
            opacity: 0;
            visibility: hidden;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            background: white;
            color: var(--color-nigun);
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 600;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
        }

        /* Active state: text display fades in */
        .page-settings-bar .search-trigger-btn.has-active .search-text-display {
            opacity: 1;
            visibility: visible;
            position: static;
            pointer-events: auto;
        }

        /* Preparing for fade - set up text display but keep it invisible */
        .page-settings-bar .search-trigger-btn.fade-preparing .search-text-display {
            position: static;
            opacity: 0;
            visibility: visible;
        }

        .page-settings-bar .search-trigger-btn.fade-preparing .search-icon,
        .page-settings-bar .search-trigger-btn.fade-preparing .search-label {
            opacity: 0;
            visibility: hidden;
        }

        .page-settings-bar .search-trigger-btn .clear-search-x {
            display: none;
            position: absolute;
            left: 8px;
            background: white;
            color: var(--color-nigun);
            font-size: 0.75em;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 16px;
            text-align: center;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .page-settings-bar .search-trigger-btn.has-active .clear-search-x {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            pointer-events: auto;
        }

        /* Expandable search container */
        .page-settings-bar .expandable-search {
            /* position: relative; REMOVED to allow child absolute positioning relative to bar */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        /* When search is expanded, fade out the trigger button */
        .page-settings-bar .expandable-search.expanded .search-trigger-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        /* When collapsing, fade in the trigger button */
        .page-settings-bar .expandable-search:not(.expanded) .search-trigger-btn {
            opacity: 1;
            transition: opacity 0.3s ease 0.2s;
        }

        /* The full-width input container */
        .page-settings-bar .expandable-search-input-wrapper {
            position: absolute;
            top: 10px;
            left: 20px;
            right: 20px;
            bottom: 10px;
            background: var(--color-nigun);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 40px;

            /* Animation state: Closed */
            visibility: hidden;
            clip-path: inset(0 42% 0 42% round 12px);
            /* Start from center (approx button width) */
            /* Transition for closing: animate clip first, then hide visibility */
            transition: clip-path 0.4s cubic-bezier(0.4, 0, 0.2, 1), visibility 0s 0.4s;

            z-index: 1000;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .page-settings-bar .expandable-search.expanded .expandable-search-input-wrapper {
            /* Animation state: Open */
            visibility: visible;
            clip-path: inset(0 0 0 0 round 12px);
            /* Transition for opening: show visibility immediately, then animate clip */
            transition: clip-path 0.4s cubic-bezier(0.4, 0, 0.2, 1), visibility 0s;
        }

        .page-settings-bar .expandable-search-input {
            width: 100%;
            max-width: 800px;
            background: transparent;
            color: white;
            border: none;
            font-size: 1.5em;
            font-weight: 600;
            text-align: center;
            outline: none;
        }

        .page-settings-bar .expandable-search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.8);
            pointer-events: none;
        }

        .page-settings-bar .expandable-search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .page-settings-bar .search-close-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .page-settings-bar .search-close-btn:hover {
            opacity: 1;
        }

        .page-settings-bar .detail-filter-options,
        .page-settings-bar .filter-panel-content {
            z-index: 1000;
        }

        .page-title-filters .detail-filter-dropdown {
            width: 120px;
        }

        .page-title-filters .filter-panel-dropdown {
            width: 120px;
        }

        .page-title-filters #searchPanelDropdown {
            width: 150px;
        }

        .page-title-filters .detail-filter-current {
            background: var(--color-nigun-pale);
            color: var(--color-nigun-dark);
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            justify-content: center;
            text-align: center;
            transition: all 0.15s ease;
        }

        .page-title-filters .detail-filter-current:hover {
            background: var(--color-nigun);
            color: white;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .page-title-filters .filter-panel-btn {
            background: var(--color-nigun-pale);
            color: var(--color-nigun-dark);
            border: none;
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.15s ease;
        }

        .page-title-filters .filter-panel-btn:hover {
            background: var(--color-nigun);
            color: white;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .page-title-filters .detail-filter-options,
        .page-title-filters .filter-panel-content {
            z-index: 1000;
        }

        /* Make tiny loader white inside page-title */
        .page-title .loader-tiny .note {
            color: white;
        }

        /* Page-specific background colors for page-title */
        .page-theme-verter .page-title {
            background: var(--color-verter);
        }

        .page-theme-zman .page-title {
            background: var(--color-zman);
        }

        .page-theme-chatzer .page-title {
            background: var(--color-chatzer);
        }

        .page-theme-nigun .page-title {
            background: var(--color-nigun);
        }

        .page-theme-collection .page-title {
            background: var(--color-collection);
        }

        .page-theme-album .page-title {
            background: var(--color-album);
        }

        .page-theme-document .page-title {
            background: var(--color-document);
        }

        .page-theme-resource .page-title {
            background: var(--color-resource);
        }

        .page-theme-music .page-title {
            background: var(--color-music);
        }

        .page-theme-mechaber .page-title {
            background: var(--color-mechaber);
        }

        .page-theme-piyut .page-title {
            background: var(--color-piyut);
        }

        /* Loading Animation for Subtitle */
        .page-title .subtitle.loading {
            position: relative;
            color: transparent !important;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            min-width: 100px;
            vertical-align: middle;
        }

        .page-title .subtitle.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.5) 50%,
                    rgba(255, 255, 255, 0) 100%);
            animation: loadingShimmer 1.5s infinite;
            transform: translateX(-100%);
        }

        @keyframes loadingShimmer {
            100% {
                transform: translateX(100%);
            }
        }

        /* Category-themed page title bars - now transparent (using parent background) */

        /* Full-width page theme backgrounds */
        .page-theme-chatzer,
        .page-theme-mechaber,
        .page-theme-verter,
        .page-theme-zman,
        .page-theme-collection,
        .page-theme-piyut,
        .page-theme-nigun,
        .page-theme-resource,
        .page-theme-document,
        .page-theme-album,
        .page-theme-music {
            position: relative;
            margin-left: calc(-50vw + 50%);
            margin-right: calc(-50vw + 50%);
            padding-left: calc(50vw - 50%);
            padding-right: calc(50vw - 50%);
            min-height: calc(100vh - 180px);
        }

        .page-theme-chatzer {
            background: linear-gradient(180deg, var(--color-chatzer-pale) 0%, color-mix(in srgb, var(--color-chatzer-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .page-theme-mechaber {
            --theme-bg: var(--color-mechaber-pale);
            background: linear-gradient(180deg, var(--color-mechaber-pale) 0%, color-mix(in srgb, var(--color-mechaber-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .page-theme-verter {
            background: linear-gradient(180deg, var(--color-verter-pale) 0%, color-mix(in srgb, var(--color-verter-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .page-theme-zman {
            background: linear-gradient(180deg, var(--color-zman-pale) 0%, color-mix(in srgb, var(--color-zman-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .page-theme-collection {
            background: linear-gradient(180deg, var(--color-collection-pale) 0%, color-mix(in srgb, var(--color-collection-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .page-theme-piyut {
            background: linear-gradient(180deg, var(--color-piyut-pale) 0%, color-mix(in srgb, var(--color-piyut-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .page-theme-nigun {
            background: linear-gradient(180deg, var(--color-nigun-pale) 0%, color-mix(in srgb, var(--color-nigun-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
            position: relative;
            /* overflow: hidden removed to allow sticky header */
        }

        /* Floating musical notes container for nigunim page */
        .songs-floating-notes {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 50;
            overflow: visible;
        }

        .songs-floating-notes .note-wrapper {
            position: absolute;
            left: 50%;
            top: 50%;
            animation: songsNoteFlight linear infinite;
        }

        .songs-floating-notes .musical-note {
            color: rgba(74, 124, 201, 0.2);
            text-shadow: 0 0 20px rgba(74, 124, 201, 0.1);
            font-size: inherit;
            display: block;
        }

        /* Wandering animations for notes - reuse hero section's smooth wander animations */
        .songs-floating-notes .musical-note.wander-1 {
            animation: wander1 ease-in-out infinite alternate;
        }

        .songs-floating-notes .musical-note.wander-2 {
            animation: wander2 ease-in-out infinite alternate;
        }

        .songs-floating-notes .musical-note.wander-3 {
            animation: wander3 ease-in-out infinite alternate;
        }

        @keyframes songsNoteFlight {
            0% {
                transform: translate(-50%, -50%) scale(0.3);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }

            85% {
                opacity: 0.5;
            }

            100% {
                transform: translate(var(--end-x), var(--end-y)) scale(1.2);
                opacity: 0;
            }
        }

        /* Ensure content is above the notes but below header */
        .page-theme-nigun .page-title {
            z-index: 100;
        }

        .songs-page-layout {
            position: relative;
            z-index: 50;
        }

        .page-theme-resource {
            background: linear-gradient(180deg, var(--color-resource-pale) 0%, color-mix(in srgb, var(--color-resource-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .page-theme-document {
            background: linear-gradient(180deg, var(--color-document-pale) 0%, color-mix(in srgb, var(--color-document-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .page-theme-album {
            background: linear-gradient(180deg, var(--color-album-pale) 0%, color-mix(in srgb, var(--color-album-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .page-theme-music {
            background: linear-gradient(180deg, var(--color-music-pale) 0%, color-mix(in srgb, var(--color-music-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        /* Center content within full-width themed pages */
        .page-theme-chatzer>*,
        .page-theme-mechaber>*,
        .page-theme-verter>*,
        .page-theme-zman>*,
        .page-theme-collection>*,
        .page-theme-nigun>*,
        .page-theme-resource>*,
        .page-theme-document>*,
        .page-theme-album>*,
        .page-theme-music>* {
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Resources Page */
        .category-group {
            margin-bottom: 30px;
        }

        .category-group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .resource-group-header {
            background: linear-gradient(135deg, var(--color-resource-pale) 0%, white 100%);
            border-right: 4px solid var(--color-resource);
        }

        .document-group-header {
            background: linear-gradient(135deg, var(--color-document-pale) 0%, white 100%);
            border-right: 4px solid var(--color-document);
        }

        .album-group-header {
            background: linear-gradient(135deg, var(--color-album-pale) 0%, white 100%);
            border-right: 4px solid var(--color-album);
        }

        .category-group-title {
            font-size: 1.2em;
            font-weight: 600;
            font-family: 'Heebo', sans-serif;
        }

        .resource-group-header .category-group-title {
            color: var(--color-resource-dark);
        }

        .document-group-header .category-group-title {
            color: var(--color-document-dark);
        }

        .album-group-header .category-group-title {
            color: var(--color-album-dark);
        }

        .category-group-count {
            background: rgba(0, 0, 0, 0.1);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        /* Clickable card elements */
        .clickable-header {
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .clickable-header:hover {
            filter: brightness(1.1);
        }

        .clickable-title {
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .clickable-title:hover {
            opacity: 0.7;
        }

        .clickable-cover {
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .clickable-cover:hover {
            opacity: 0.85;
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .resource-card {
            background: white;
            border-radius: 16px;
            /* overflow: hidden; Removed */
            box-shadow: var(--card-shadow);
            transition: var(--transition-smooth);
            display: flex;
            flex-direction: column;
            position: relative;
            /* For pseudo-element */
        }

        .resource-card> :first-child {
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
        }

        .resource-card> :last-child {
            border-bottom-left-radius: inherit;
            border-bottom-right-radius: inherit;
        }

        /* Hover effect for Resource Card */
        .resource-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            border: 2px solid var(--color-resource);
            opacity: 0;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(121, 85, 72, 0.15);
        }

        .resource-card:hover::after {
            opacity: 1;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .resource-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .resource-card-header {
            background: linear-gradient(135deg, var(--color-resource) 0%, var(--color-resource-light) 100%);
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resource-icon {
            font-size: 2.5em;
        }

        .resource-sort-label {
            font-size: 0.9em;
            font-weight: 600;
            color: white;
            text-align: center;
        }

        .resource-card-body {
            padding: 15px;
            flex: 1;
        }

        .resource-title {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--color-resource-dark);
            margin-bottom: 8px;
        }

        .resource-type {
            display: inline-block;
            background: var(--color-resource-pale);
            color: var(--color-resource-dark);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-bottom: 8px;
        }

        .resource-chatzer {
            margin-bottom: 8px;
        }

        .resource-details,
        .resource-notes {
            font-size: 0.85em;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .resource-card-footer {
            padding: 15px;
            border-top: 1px solid var(--color-resource-pale);
        }

        .resource-link-btn,
        .resource-btn-placeholder {
            display: block;
            width: 100%;
            padding: 10px;
            background: var(--color-resource);
            color: white;
            border-radius: 10px;
            text-decoration: none;
            font-size: 0.95em;
            text-align: center;
            transition: var(--transition-smooth);
            box-sizing: border-box;
            min-height: 40px;
        }

        .resource-btn-placeholder {
            visibility: hidden;
        }

        .resource-phone-number {
            width: 100%;
            padding: 10px;
            background: var(--color-resource-pale);
            color: var(--color-resource-dark);
            border-radius: 10px;
            font-size: 0.95em;
            text-align: center;
            font-weight: 600;
            white-space: pre-line;
            line-height: 1.6;
        }

        .resource-link-btn:hover {
            background: var(--color-resource-dark);
        }

        /* Documents Page */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .document-card {
            background: white;
            border-radius: 16px;
            /* overflow: hidden; Removed */
            box-shadow: var(--card-shadow);
            transition: var(--transition-smooth);
            display: flex;
            flex-direction: column;
            position: relative;
            /* For pseudo-element */
        }

        .document-card> :first-child {
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
        }

        .document-card> :last-child {
            border-bottom-left-radius: inherit;
            border-bottom-right-radius: inherit;
        }

        /* Hover effect for Document Card */
        .document-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            border: 2px solid var(--color-document);
            opacity: 0;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(96, 125, 139, 0.15);
        }

        .document-card:hover::after {
            opacity: 1;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .document-card> :first-child {
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
        }

        .document-card> :last-child {
            border-bottom-left-radius: inherit;
            border-bottom-right-radius: inherit;
        }

        /* Hover effect for Document Card */
        .document-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            border: 2px solid var(--color-document);
            opacity: 0;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(96, 125, 139, 0.15);
        }

        .document-card:hover::after {
            opacity: 1;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .document-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .document-card-header {
            background: linear-gradient(135deg, var(--color-document) 0%, var(--color-document-light) 100%);
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .document-preview {
            position: relative;
            width: 100%;
            height: 200px;
            background: #f5f5f5;
            overflow: hidden;
        }

        .document-preview-frame {
            width: 100%;
            height: calc(100% + 60px);
            border: none;
            pointer-events: none;
            margin-top: -30px;
        }

        .document-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .document-preview-overlay:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .preview-expand-icon {
            font-size: 2em;
            opacity: 0;
            transition: var(--transition-smooth);
        }

        .document-preview-overlay:hover .preview-expand-icon {
            opacity: 1;
        }

        .document-icon {
            font-size: 2.5em;
        }

        .document-sort-label {
            font-size: 0.9em;
            font-weight: 600;
            color: white;
            text-align: center;
        }

        .document-card-body {
            padding: 15px;
            flex: 1;
        }

        .document-title {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--color-document-dark);
            margin-bottom: 8px;
        }

        .document-type {
            display: inline-block;
            background: var(--color-document-pale);
            color: var(--color-document-dark);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-bottom: 5px;
            margin-left: 5px;
        }

        .document-serie {
            display: inline-block;
            background: var(--color-document-pale);
            color: var(--color-document-dark);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-bottom: 8px;
        }

        .document-chatzer {
            margin-bottom: 8px;
        }

        .document-details,
        .document-notes {
            font-size: 0.85em;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .document-card-footer {
            padding: 15px;
            border-top: 1px solid var(--color-document-pale);
        }

        .document-pdf-btn,
        .document-link-btn,
        .document-btn-placeholder {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            text-decoration: none;
            font-size: 0.95em;
            text-align: center;
            transition: var(--transition-smooth);
            cursor: pointer;
            border: none;
            font-family: inherit;
            box-sizing: border-box;
            min-height: 40px;
            display: block;
        }

        .document-btn-placeholder {
            visibility: hidden;
        }

        .document-pdf-btn {
            background: var(--color-document);
            color: white;
        }

        .document-pdf-btn:hover {
            background: var(--color-document-dark);
        }

        .document-link-btn {
            background: var(--color-document);
            color: white;
        }

        .document-link-btn:hover {
            background: var(--color-document-dark);
        }

        /* PDF Popup */
        .pdf-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-smooth);
            padding-bottom: 150px;
        }

        .pdf-popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .pdf-popup {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .pdf-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--color-document);
            color: white;
        }

        .pdf-popup-title {
            font-weight: 600;
            font-size: 1.1em;
        }

        .pdf-popup-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .pdf-popup-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .pdf-popup-body {
            flex: 1;
            overflow: hidden;
        }

        .pdf-popup-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .pdf-popup-footer {
            padding: 10px 20px;
            background: #f8fafc;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .pdf-download-btn {
            padding: 10px 25px;
            background: var(--color-document);
            color: white;
            border: none;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.95em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .pdf-download-btn:hover {
            background: var(--color-document-dark);
        }

        /* Albums Page */
        .albums-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .album-card {
            background: white;
            border-radius: 16px;
            /* overflow: hidden; Removed */
            box-shadow: var(--card-shadow);
            transition: var(--transition-smooth);
            display: flex;
            flex-direction: column;
            position: relative;
            /* For pseudo-element */
        }

        .album-card> :first-child {
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
        }

        .album-card> :last-child {
            border-bottom-left-radius: inherit;
            border-bottom-right-radius: inherit;
        }

        /* Hover effect for Album Card */
        .album-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            border: 2px solid var(--color-album);
            opacity: 0;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(233, 30, 99, 0.15);
        }

        .album-card:hover::after {
            opacity: 1;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .album-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .album-cover {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }

        .album-cover-placeholder {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--color-album-pale) 0%, var(--color-album-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: var(--color-album);
        }

        .album-card-header {
            background: linear-gradient(135deg, var(--color-album) 0%, var(--color-album-light) 100%);
            padding: 10px 15px;
            text-align: center;
        }

        .album-producer-label {
            font-size: 0.85em;
            font-weight: 600;
            color: white;
            line-height: 1.4;
        }

        .album-info {
            padding: 15px;
            flex: 1;
        }

        .album-title {
            font-weight: 600;
            font-size: 1.05em;
            color: var(--color-album-dark);
            margin-bottom: 5px;
        }

        .album-producer,
        .album-year {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .album-chatzer {
            margin: 5px 0;
        }

        .album-serie {
            display: inline-block;
            background: var(--color-album-pale);
            color: var(--color-album-dark);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-top: 3px;
        }

        .album-notes {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-top: 5px;
            font-style: italic;
        }

        .album-actions {
            padding: 0 15px 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .album-booklet-btn,
        .album-buy-btn,
        .album-btn-placeholder {
            width: 100%;
            padding: 10px 12px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.85em;
            text-align: center;
            transition: var(--transition-smooth);
            border: none;
            cursor: pointer;
            box-sizing: border-box;
            min-height: 38px;
            display: block;
        }

        .album-btn-placeholder {
            visibility: hidden;
        }

        .album-booklet-btn {
            background: var(--color-album);
            color: white;
            cursor: pointer;
        }

        .album-booklet-btn:hover {
            background: var(--color-album-dark);
        }

        .album-buy-btn {
            background: var(--color-album-pale);
            color: var(--color-album-dark);
            border: 1px solid var(--color-album-light);
        }

        .album-buy-btn:hover {
            background: var(--color-album-light);
        }

        /* Collections Grid - Playlist Style */
        .collections-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 800px;
            margin: 0 auto;
        }

        .collection-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            /* overflow: hidden; Removed */
            transition: var(--transition-smooth);
            position: relative;
            /* For pseudo-element */
        }

        .collection-card> :first-child {
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
        }

        .collection-card> :last-child {
            border-bottom-left-radius: inherit;
            border-bottom-right-radius: inherit;
        }

        /* Hover effect for Collection Card */
        .collection-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 12px;
            border: 2px solid var(--color-collection);
            opacity: 0;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.15);
        }

        .collection-card:hover::after {
            opacity: 1;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .collection-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .collection-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            cursor: pointer;
        }

        .collection-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--color-collection) 0%, var(--color-collection-light) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            flex-shrink: 0;
        }

        .collection-info {
            flex: 1;
            min-width: 0;
        }

        .collection-title {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .collection-meta {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .collection-zmanim {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 6px;
        }

        .collection-zman-tag {
            background: var(--color-zman);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .collection-zman-tag:hover {
            background: var(--color-zman-dark);
            transform: scale(1.05);
        }

        .collection-zman-more {
            background: var(--bg-light);
            color: var(--text-muted);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        /* Music Page Styles */
        .music-ritem-groups {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .ritem-group {
            background: white;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            /* overflow: hidden; Removed */
        }

        .ritem-group> :first-child {
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
        }

        .ritem-group> :last-child {
            border-bottom-left-radius: inherit;
            border-bottom-right-radius: inherit;
        }

        .ritem-group-header {
            background: linear-gradient(135deg, var(--color-music) 0%, var(--color-music-dark) 100%);
            color: white;
            padding: 18px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ritem-group-header h3 {
            margin: 0;
            font-size: 1.25em;
            flex: 1;
        }

        .ritem-count {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .ritem-play-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 0.85em;
        }

        .ritem-play-btn:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        .ritem-scales {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .scale-group {
            background: var(--bg-light);
            border-radius: 15px;
            /* overflow: hidden; Removed */
        }

        .scale-group> :first-child {
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
        }

        .scale-group> :last-child {
            border-bottom-left-radius: inherit;
            border-bottom-right-radius: inherit;
        }

        .scale-group-header {
            background: var(--color-music-pale);
            padding: 12px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .scale-name {
            font-weight: 600;
            color: var(--color-music-dark);
        }

        .scale-song-count {
            background: var(--color-music);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .scale-songs {
            padding: 10px;
        }

        .music-song-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition-smooth);
            margin-bottom: 6px;
            background: white;
        }

        .music-song-item:hover {
            background: var(--color-nigun-pale);
            transform: translateX(-3px);
        }

        .music-song-item.no-audio {
            opacity: 0.6;
            border: 1px dashed var(--border-color);
        }

        .music-song-name {
            flex: 1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-song-meta {
            font-size: 0.8em;
            color: var(--color-mechaber-dark);
            white-space: nowrap;
        }

        .music-song-details {
            background: transparent;
            border: none;
            color: var(--color-music);
            cursor: pointer;
            padding: 5px;
            font-size: 1em;
            opacity: 0.5;
            transition: var(--transition-smooth);
        }

        .music-song-details:hover {
            opacity: 1;
        }

        .scale-more {
            text-align: center;
            padding: 10px;
            color: var(--color-music);
            cursor: pointer;
            font-size: 0.9em;
            transition: var(--transition-smooth);
        }

        .scale-more:hover {
            background: var(--color-music-pale);
            border-radius: 8px;
        }

        .collection-play-btn {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--color-collection) 0%, var(--color-collection-dark) 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: var(--transition-smooth);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .collection-play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        /* Category Cards Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .category-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            transition: var(--transition-smooth);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            border: 2px solid transparent;
            /* Removed overflow: hidden to allow hover glow */
            position: relative;
            text-decoration: none;
            color: inherit;
        }

        .category-card> :first-child {
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
        }

        .category-card> :last-child {
            border-bottom-left-radius: inherit;
            border-bottom-right-radius: inherit;
        }

        /* Category-themed card backgrounds and unified hover effect */
        .category-card {
            position: relative;
        }

        /* Unified Hover Effect for Category Cards */
        .category-card::after {
            content: '';
            position: absolute;
            border-radius: 16px;
            border: 2px solid transparent;
            /* Color set by theme */
            opacity: 0;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        }

        .category-card:hover::after {
            opacity: 1;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Compact list view for mechabrim - flow/wrap layout */
        .mechaber-list-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 4px;
            justify-content: flex-start;
            grid-column: 1 / -1;
            /* Span full width of grid */
            width: 100%;
        }

        .mechaber-pill {
            display: inline-flex;
            align-items: center;
            background: var(--color-mechaber);
            border-radius: 50px;
            padding: 6px 16px 6px 6px;
            text-decoration: none;
            color: white;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            flex-grow: 1;
            justify-content: center;
        }

        .mechaber-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            filter: brightness(1.1);
        }

        .mechaber-pill-image {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            margin-left: 10px;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0.3);
        }

        .mechaber-pill-image img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center top;
        }

        .mechaber-pill-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.3);
        }

        .mechaber-pill-placeholder .mechaber-icon {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.8);
            -webkit-mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
            mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
        }

        .mechaber-pill-name {
            color: white;
            font-weight: 600;
        }

        /* Compact list view for chatzeros - flow/wrap layout */
        .chatzer-list-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 4px;
            justify-content: flex-start;
            grid-column: 1 / -1;
            width: 100%;
        }

        .chatzer-pill {
            display: inline-flex;
            align-items: center;
            background: var(--color-chatzer);
            border-radius: 50px;
            padding: 10px 20px;
            text-decoration: none;
            color: white;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            flex-grow: 1;
            justify-content: center;
        }

        .chatzer-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            filter: brightness(1.1);
        }

        .chatzer-pill-name {
            color: white;
            font-weight: 600;
        }

        /* Compact list view for verter - flow/wrap layout */
        .verter-list-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 4px;
            justify-content: flex-start;
            grid-column: 1 / -1;
            width: 100%;
        }

        .verter-pill {
            display: inline-flex;
            align-items: center;
            background: var(--color-verter);
            border-radius: 50px;
            padding: 10px 20px;
            text-decoration: none;
            color: white;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            flex-grow: 1;
            justify-content: center;
        }

        .verter-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .verter-pill-name {
            color: white;
            font-weight: 600;
        }

        /* Mechaber cards styled separately below */

        .page-theme-mechaber .category-card::after {
            border-color: var(--color-mechaber);
            box-shadow: 0 0 15px rgba(239, 83, 80, 0.15);
        }

        .page-theme-collection .category-card {
            background: var(--color-collection-pale);
            border-color: var(--color-collection-light);
        }

        .page-theme-collection .category-card::after {
            border-color: var(--color-collection);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.15);
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }

        .category-card.expanded {
            grid-column: 1 / -1;
            /* border-color: var(--primary);  - Handled by inner content or theme */
        }

        .category-card.expanded::after {
            opacity: 1;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-color: var(--primary);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .card-image {
            width: 55px;
            height: 55px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid var(--primary-pale);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Mechaber card images styled in redesign section below */

        .category-card.has-image .card-header {
            align-items: flex-start;
        }

        .card-header-text {
            flex: 1;
            min-width: 0;
        }

        .card-description {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.4;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .card-chatzer-tag {
            display: inline-block;
            background: var(--color-chatzer);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .card-chatzer-tag:hover {
            background: var(--color-chatzer-dark);
            transform: scale(1.05);
        }

        .card-chatzer-display {
            text-align: center;
            font-size: 1.3em;
            font-weight: 700;
            color: var(--color-chatzer-dark);
            padding: 12px 15px;
            margin-top: 5px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border-top: 1px solid var(--color-chatzer-light);
            background: var(--color-chatzer-pale);
            border-radius: 0 0 14px 14px;
            margin: 0 -20px -20px -20px;
        }

        .card-chatzer-display:hover {
            background: var(--color-chatzer-light);
            color: var(--color-chatzer-dark);
        }

        .card-zman-tag {
            display: inline-block;
            background: var(--color-zman);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .card-zman-tag:hover {
            background: var(--color-zman-dark);
            transform: scale(1.05);
        }

        .card-stats {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        /* Center card-stats on all pages except mechabrim */
        .page-theme-verter .card-stats,
        .page-theme-piyut .card-stats,
        .page-theme-nigun .card-stats,
        .page-theme-zman .card-stats,
        .page-theme-chatzer .card-stats,
        .page-theme-collection .card-stats,
        .page-theme-album .card-stats,
        .page-theme-document .card-stats,
        .page-theme-resource .card-stats,
        .page-theme-music .card-stats {
            justify-content: center;
            text-align: center;
            width: 100%;
        }

        .card-stat {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .card-years {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .card-stat-zman {
            font-size: 0.8em;
            color: var(--primary);
            font-weight: 600;
        }

        .section-header {
            color: var(--primary-deep);
            font-size: 1.3em;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .section-header:first-of-type {
            margin-top: 0;
        }

        .zman-section {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
        }

        .zman-section h3 {
            font-size: 1.2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        /* Collections section - red */
        .zman-section.section-collections h3 {
            color: var(--color-collection);
            border-bottom: 2px solid var(--color-collection-pale);
        }

        /* Collections section header */
        .zman-section.section-collections h3 {
            color: var(--color-collection);
            border-bottom: 2px solid var(--color-collection-pale);
        }

        /* Piyutim section header */
        .zman-section.section-piyutim h3 {
            color: var(--color-piyut);
            border-bottom: 2px solid var(--color-piyut-pale);
        }

        .zman-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        /* ====== ZMAN-ITEM-CARD REDESIGN ====== */
        .zman-item-card {
            display: flex;
            flex-direction: column;
            padding: 0;
            background: white;
            border-radius: 14px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: none;
            position: relative;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            color: inherit;
        }

        .zman-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .zman-item-card .zman-item-header {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }

        .zman-item-card .zman-item-name {
            font-weight: 600;
            font-size: 1.1em;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
            text-align: center;
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
        }

        .zman-item-card .zman-item-stats {
            background: white;
            padding: 8px 12px;
            text-align: center;
            border-top: 2px solid;
        }

        .zman-item-card .zman-item-count {
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 0;
        }

        /* Collections cards - red gradient */
        .zman-section.section-collections .zman-item-card .zman-item-header {
            background: linear-gradient(135deg, var(--color-collection) 0%, var(--color-collection-dark) 100%);
        }

        .zman-section.section-collections .zman-item-card .zman-item-stats {
            border-color: var(--color-collection-light);
        }

        .zman-section.section-collections .zman-item-card .zman-item-count {
            color: var(--color-collection-dark);
        }

        .zman-section.section-collections .zman-item-card:hover {
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.25);
        }

        /* Piyutim cards - green gradient */
        .zman-section.section-piyutim .zman-item-card .zman-item-header {
            background: linear-gradient(135deg, var(--color-piyut) 0%, var(--color-piyut-dark) 100%);
        }

        .zman-section.section-piyutim .zman-item-card .zman-item-stats {
            border-color: var(--color-piyut-light);
        }

        .zman-section.section-piyutim .zman-item-card .zman-item-count {
            color: var(--color-piyut-dark);
        }

        .zman-section.section-piyutim .zman-item-card:hover {
            box-shadow: 0 6px 20px rgba(46, 139, 46, 0.25);
        }

        /* Albums section header */
        .zman-section.section-albums h3 {
            color: var(--color-album);
            border-bottom: 2px solid var(--color-album-pale);
        }

        /* Albums cards - teal gradient */
        .zman-section.section-albums .zman-item-card .zman-item-header {
            background: linear-gradient(135deg, var(--color-album) 0%, var(--color-album-dark) 100%);
        }

        .zman-section.section-albums .zman-item-card:hover {
            box-shadow: 0 6px 20px rgba(0, 131, 143, 0.25);
        }

        /* Documents section header */
        .zman-section.section-documents h3 {
            color: var(--color-document);
            border-bottom: 2px solid var(--color-document-pale);
        }

        /* Documents cards - cyan gradient */
        .zman-section.section-documents .zman-item-card .zman-item-header {
            background: linear-gradient(135deg, var(--color-document) 0%, var(--color-document-dark) 100%);
        }

        .zman-section.section-documents .zman-item-card:hover {
            box-shadow: 0 6px 20px rgba(0, 160, 176, 0.25);
        }

        /* Mobile styles for zman-item-card */
        @media (max-width: 480px) {
            .zman-items-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
            }

            .zman-item-card .zman-item-header {
                padding: 10px 12px;
                min-height: 45px;
            }

            .zman-item-card .zman-item-name {
                font-size: 0.95em;
            }
        }

        /* Search Results Page */
        .search-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .search-results-searchbar {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .search-results-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            direction: rtl;
            transition: var(--transition-smooth);
        }

        .search-results-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-pale);
        }

        .search-results-btn {
            padding: 12px 24px;
            background: var(--gradient-main);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            white-space: nowrap;
        }

        .search-results-btn:hover {
            background: var(--gradient-main-dark);
        }

        .search-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bg-light);
        }

        .search-section-header h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .see-all-btn {
            background: none;
            border: none;
            color: var(--color-nigun);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
        }

        .see-all-btn:hover {
            text-decoration: underline;
        }

        .search-results-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-songs-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-songs-list .song-item {
            margin-bottom: 0;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-light);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .search-result-item.nigun-result {
            padding: 0;
            gap: 0;
        }

        .search-result-item .result-main {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            flex: 1;
            cursor: pointer;
        }

        .search-result-item .result-detail-btn {
            padding: 8px 15px;
            background: var(--color-nigun-pale);
            border: none;
            border-radius: 0 10px 10px 0;
            color: var(--color-nigun);
            font-family: inherit;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
            height: 100%;
        }

        .search-result-item .result-detail-btn:hover {
            background: var(--color-nigun);
            color: white;
        }

        .search-result-item:hover {
            background: var(--color-nigun-pale);
            transform: translateX(-5px);
        }

        .result-play {
            color: var(--color-nigun);
            font-size: 1.2em;
            opacity: 0;
            transition: var(--transition-smooth);
        }

        .search-result-item:hover .result-play {
            opacity: 1;
        }

        .result-icon {
            font-size: 1.3em;
            opacity: 0.7;
        }

        .result-info {
            flex: 1;
        }

        .result-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .result-meta {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .search-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .search-result-card {
            padding: 15px;
            background: var(--bg-light);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border-right: 4px solid transparent;
        }

        .search-result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .search-result-card .result-name {
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        .search-result-card .result-count {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        /* Search result card category colors */
        .search-result-card.result-chatzer .result-name {
            color: var(--color-chatzer-dark);
        }

        .search-result-card.result-chatzer:hover {
            background: var(--color-chatzer-pale);
        }

        .search-result-card.result-mechaber .result-name {
            color: var(--color-mechaber-dark);
        }

        .search-result-card.result-mechaber:hover {
            background: var(--color-mechaber-pale);
        }

        .search-result-card.result-nigun .result-name {
            color: var(--color-nigun-dark);
        }

        .search-result-card.result-nigun:hover {
            background: var(--color-nigun-pale);
        }

        .search-result-card.result-verter .result-name {
            color: var(--color-verter-dark);
        }

        .search-result-card.result-verter:hover {
            background: var(--color-verter-pale);
        }

        .search-result-card.result-zman .result-name {
            color: var(--color-zman-dark);
        }

        .search-result-card.result-zman:hover {
            background: var(--color-zman-pale);
        }

        .search-result-card.result-collection .result-name {
            color: var(--color-collection-dark);
        }

        .search-result-card.result-collection:hover {
            background: var(--color-collection-pale);
        }

        .search-result-card.result-resource .result-name {
            color: var(--color-resource-dark);
        }

        .search-result-card.result-resource:hover {
            background: var(--color-resource-pale);
        }

        .search-result-card.result-document .result-name {
            color: var(--color-document-dark);
        }

        .search-result-card.result-document:hover {
            background: var(--color-document-pale);
        }

        .search-result-card.result-album .result-name {
            color: var(--color-album-dark);
        }

        .search-result-card.result-album:hover {
            background: var(--color-album-pale);
        }

        .search-result-card.result-music .result-name {
            color: var(--color-music-dark);
        }

        .search-result-card.result-music:hover {
            background: var(--color-music-pale);
        }

        /* Universal Hover Effect for Search Result Cards */
        .search-result-card {
            position: relative;
        }

        .search-result-card::after {
            content: '';
            position: absolute;
            border-radius: 10px;
            border: 2px solid transparent;
            /* Set by category class */
            opacity: 0;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .search-result-card:hover::after {
            opacity: 1;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Assign border colors based on result type */
        .search-result-card.result-chatzer::after {
            border-color: var(--color-chatzer);
            box-shadow: 0 0 10px rgba(156, 91, 181, 0.15);
        }

        .search-result-card.result-mechaber::after {
            border-color: var(--color-mechaber);
            box-shadow: 0 0 10px rgba(239, 83, 80, 0.15);
        }

        .search-result-card.result-nigun::after {
            border-color: var(--color-nigun);
            box-shadow: 0 0 10px rgba(74, 124, 201, 0.15);
        }

        .search-result-card.result-verter::after {
            border-color: var(--color-verter);
            box-shadow: 0 0 10px rgba(255, 167, 38, 0.15);
        }

        .search-result-card.result-zman::after {
            border-color: var(--color-zman);
            box-shadow: 0 0 10px rgba(66, 165, 245, 0.15);
        }

        .search-result-card.result-collection::after {
            border-color: var(--color-collection);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.15);
        }

        .search-result-card.result-resource::after {
            border-color: var(--color-resource);
            box-shadow: 0 0 10px rgba(121, 85, 72, 0.15);
        }

        .search-result-card.result-document::after {
            border-color: var(--color-document);
            box-shadow: 0 0 10px rgba(96, 125, 139, 0.15);
        }

        .search-result-card.result-album::after {
            border-color: var(--color-album);
            box-shadow: 0 0 10px rgba(233, 30, 99, 0.15);
        }

        .search-result-card.result-music::after {
            border-color: var(--color-music);
            box-shadow: 0 0 10px rgba(67, 74, 84, 0.15);
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .no-results-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-results-hint {
            font-size: 0.9em;
            margin-top: 10px;
        }

        .card-meta {
            font-size: 0.8em;
            color: var(--primary);
            margin-bottom: 8px;
            padding: 4px 10px;
            background: var(--primary-pale);
            border-radius: 8px;
            display: inline-block;
        }

        .card-icon {
            display: none;
        }

        /* Show card icon for mechabrim as circular placeholder */
        .page-theme-mechaber .card-icon {
            display: flex;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--color-mechaber-pale);
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .page-theme-mechaber .card-icon .mechaber-icon {
            width: 111px;
            height: 165px;
            background-color: var(--color-mechaber);
            -webkit-mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
            mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
        }

        /* Hide icon when image loads successfully (inline style override) */
        .page-theme-mechaber .card-icon[style*="display:none"],
        .page-theme-mechaber .card-icon[style*="display: none"] {
            display: none !important;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-deep);
            flex: 1;
            text-align: center;
        }

        /* Category-specific dark colors for card titles (collection, album, document, resource only) */
        .page-theme-collection .card-title {
            color: var(--color-collection-dark, #4a148c);
        }

        .page-theme-album .card-title {
            color: var(--color-album-dark, #b8860b);
        }

        .page-theme-document .card-title {
            color: var(--color-document-dark, #00695c);
        }

        .page-theme-resource .card-title {
            color: var(--color-resource-dark, #c62828);
        }

        /* Mechaber formal name (טיטל + ערשטע נאמען + לעצטע נאמען - smaller, lighter) */
        .card-mechaber-formal {
            display: block;
            font-size: 0.75em;
            font-weight: 400;
            color: var(--color-mechaber);
            margin-bottom: 3px;
        }

        /* Mechaber known name (גערופן + פלאץ + סופיקס - bigger, darker) */
        .card-mechaber-known {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--color-mechaber-dark);
        }

        /* ====== NEW MECHABER CARD REDESIGN ====== */
        .page-theme-mechaber .category-grid {
            grid-auto-rows: minmax(130px, auto);
            align-items: stretch;
        }

        .page-theme-mechaber .category-card {
            padding: 0;
            background: white;
            border: none;
            box-shadow: 0 4px 20px rgba(156, 91, 181, 0.15);
            display: flex;
            flex-direction: column;
            border-radius: 16px;
            overflow: hidden;
            min-height: 130px;
        }

        .page-theme-mechaber .category-card .card-header {
            margin: 0;
            gap: 0;
            flex-direction: row-reverse;
            align-items: stretch;
            flex: 1;
        }

        /* Mechaber banner section (magenta/pink) */
        .page-theme-mechaber .category-card .card-header-text {
            flex: 1;
            background: linear-gradient(135deg, var(--color-mechaber) 0%, var(--color-mechaber-dark) 100%);
            padding: 12px 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 150px;
            max-height: 150px;
            overflow: hidden;
        }

        .page-theme-mechaber .category-card .card-mechaber-formal {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.8em;
            margin-bottom: 4px;
        }

        .page-theme-mechaber .category-card .card-mechaber-known {
            color: white;
            font-size: 1.1em;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
        }

        .page-theme-mechaber .category-card .card-years {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.75em;
            margin-top: 5px;
        }

        /* Chatzer tags (purple) attached to banner */
        .page-theme-mechaber .category-card .card-tags {
            margin-top: 8px;
            gap: 5px;
        }

        .page-theme-mechaber .category-card .card-chatzer-tag {
            background: var(--color-chatzer);
            color: white;
            font-size: 0.7em;
            padding: 2px 8px;
            border-radius: 10px;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .page-theme-mechaber .category-card .card-chatzer-tag:hover {
            background: var(--color-chatzer-dark);
            transform: none;
        }

        /* Image section */
        .page-theme-mechaber .category-card .card-image {
            width: 110px;
            height: 150px;
            max-height: 150px;
            border-radius: 0;
            border: none;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: none;
        }

        .page-theme-mechaber .category-card .card-icon {
            width: 110px;
            height: 150px;
            border-radius: 0;
            background: var(--color-mechaber-pale);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2em;
            flex-shrink: 0;
        }

        /* Stats at bottom - white background */
        .page-theme-mechaber .category-card .card-stats {
            background: white;
            margin: 0;
            padding: 10px 15px;
            justify-content: center;
            gap: 15px;
            border-top: 2px solid var(--color-mechaber-light);
            flex-wrap: wrap;
            min-height: 40px;
            flex-shrink: 0;
        }

        .page-theme-mechaber .category-card .card-stat {
            color: var(--color-mechaber-dark);
            font-weight: 600;
            font-size: 0.85em;
        }

        .page-theme-mechaber .category-card .card-stat-icon {
            margin-left: 3px;
        }

        /* Hover effect adjustments */
        .page-theme-mechaber .category-card::after {
            border-color: var(--color-mechaber);
            box-shadow: 0 0 20px rgba(196, 53, 168, 0.3);
            border-radius: 16px;
        }

        .page-theme-mechaber .category-card:hover {
            box-shadow: 0 8px 30px rgba(196, 53, 168, 0.25);
        }

        /* Mobile styles for mechaber cards */
        @media (max-width: 480px) {
            .page-theme-mechaber .category-card .card-image {
                width: 75px;
                min-height: 80px;
            }

            .page-theme-mechaber .category-card .card-icon {
                width: 75px;
                min-height: 80px;
                font-size: 1.6em;
            }

            .page-theme-mechaber .category-card .card-header-text {
                padding: 10px 12px;
                min-height: 80px;
            }

            .page-theme-mechaber .category-card .card-mechaber-known {
                font-size: 0.95em;
            }

            .page-theme-mechaber .category-card .card-mechaber-formal {
                font-size: 0.7em;
            }
        }

        /* ====== CHATZER CARD REDESIGN ====== */
        .page-theme-chatzer .category-grid {
            grid-auto-rows: minmax(100px, auto);
            align-items: stretch;
        }

        .page-theme-chatzer .category-card {
            padding: 0;
            background: white;
            border: none;
            box-shadow: 0 4px 20px rgba(156, 91, 181, 0.15);
            display: flex;
            flex-direction: column;
            border-radius: 16px;
            overflow: hidden;
            min-height: 100px;
        }

        .page-theme-chatzer .category-card .card-header {
            margin: 0;
            gap: 0;
            flex-direction: column;
            align-items: stretch;
            flex: 1;
        }

        /* Chatzer banner section (purple gradient) */
        .page-theme-chatzer .category-card .card-header-text {
            flex: 1;
            background: linear-gradient(135deg, var(--color-chatzer) 0%, var(--color-chatzer-dark) 100%);
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 70px;
        }

        .page-theme-chatzer .category-card .card-title {
            color: white;
            font-size: 1.4em;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        /* Stats at bottom - white background */
        .page-theme-chatzer .category-card .card-stats {
            background: white;
            margin: 0;
            padding: 10px 15px;
            justify-content: center;
            gap: 15px;
            border-top: 2px solid var(--color-chatzer-light);
            flex-wrap: wrap;
            min-height: 40px;
            flex-shrink: 0;
        }

        .page-theme-chatzer .category-card .card-stat {
            color: var(--color-chatzer-dark);
            font-weight: 600;
            font-size: 0.85em;
        }

        /* Hover effect adjustments */
        .page-theme-chatzer .category-card:hover {
            box-shadow: 0 8px 30px rgba(156, 91, 181, 0.25);
        }

        /* ====== VERTER CARD REDESIGN ====== */
        .page-theme-verter .category-grid {
            grid-auto-rows: minmax(100px, auto);
            align-items: stretch;
        }

        .page-theme-verter .category-card {
            padding: 0;
            background: white;
            border: none;
            box-shadow: 0 4px 20px rgba(255, 167, 38, 0.15);
            display: flex;
            flex-direction: column;
            border-radius: 16px;
            overflow: hidden;
            min-height: 100px;
        }

        .page-theme-verter .category-card .card-header {
            margin: 0;
            gap: 0;
            flex-direction: column;
            align-items: stretch;
            flex: 1;
        }

        /* Verter banner section (orange gradient) */
        .page-theme-verter .category-card .card-header-text {
            flex: 1;
            background: linear-gradient(135deg, var(--color-verter) 0%, var(--color-verter-dark) 100%);
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 70px;
        }

        .page-theme-verter .category-card .card-title {
            color: white;
            font-size: 1.4em;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        /* Stats at bottom - white background */
        .page-theme-verter .category-card .card-stats {
            background: white;
            margin: 0;
            padding: 10px 15px;
            justify-content: center;
            gap: 15px;
            border-top: 2px solid var(--color-verter-light);
            flex-wrap: wrap;
            min-height: 40px;
            flex-shrink: 0;
        }

        .page-theme-verter .category-card .card-stat {
            color: var(--color-verter-dark);
            font-weight: 600;
            font-size: 0.85em;
        }

        /* Hover effect adjustments */
        .page-theme-verter .category-card:hover {
            box-shadow: 0 8px 30px rgba(255, 167, 38, 0.25);
        }

        /* ====== ZMAN CARD REDESIGN ====== */
        .page-theme-zman .category-grid {
            grid-auto-rows: minmax(100px, auto);
            align-items: stretch;
        }

        .page-theme-zman .category-card {
            padding: 0;
            background: white;
            border: none;
            box-shadow: 0 4px 20px rgba(66, 165, 245, 0.15);
            display: flex;
            flex-direction: column;
            border-radius: 16px;
            overflow: hidden;
            min-height: 100px;
        }

        .page-theme-zman .category-card .card-header {
            margin: 0;
            gap: 0;
            flex-direction: column;
            align-items: stretch;
            flex: 1;
        }

        /* Zman banner section (blue gradient) */
        .page-theme-zman .category-card .card-header-text {
            flex: 1;
            background: linear-gradient(135deg, var(--color-zman) 0%, var(--color-zman-dark) 100%);
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 70px;
        }

        .page-theme-zman .category-card .card-title {
            color: white;
            font-size: 1.4em;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        /* Stats at bottom - white background */
        .page-theme-zman .category-card .card-stats {
            background: white;
            margin: 0;
            padding: 10px 15px;
            justify-content: center;
            gap: 15px;
            border-top: 2px solid var(--color-zman-light);
            flex-wrap: wrap;
            min-height: 40px;
            flex-shrink: 0;
        }

        .page-theme-zman .category-card .card-stat {
            color: var(--color-zman-dark);
            font-weight: 600;
            font-size: 0.85em;
        }

        /* Hover effect adjustments */
        .page-theme-zman .category-card:hover {
            box-shadow: 0 8px 30px rgba(66, 165, 245, 0.25);
        }

        /* Hover ::after effects for chatzer, verter, zman */
        .page-theme-chatzer .category-card::after {
            border-color: var(--color-chatzer);
            box-shadow: 0 0 20px rgba(156, 91, 181, 0.3);
            border-radius: 16px;
        }

        .page-theme-verter .category-card::after {
            border-color: var(--color-verter);
            box-shadow: 0 0 20px rgba(255, 167, 38, 0.3);
            border-radius: 16px;
        }

        .page-theme-zman .category-card::after {
            border-color: var(--color-zman);
            box-shadow: 0 0 20px rgba(66, 165, 245, 0.3);
            border-radius: 16px;
        }

        /* ====== PIYUT CARD REDESIGN ====== */
        .page-theme-piyut .category-grid {
            grid-auto-rows: minmax(100px, auto);
            align-items: stretch;
        }

        .page-theme-piyut .category-card {
            padding: 0;
            background: white;
            border: none;
            box-shadow: 0 4px 20px rgba(46, 139, 46, 0.15);
            display: flex;
            flex-direction: column;
            border-radius: 16px;
            overflow: hidden;
            min-height: 100px;
        }

        .page-theme-piyut .category-card .card-header {
            margin: 0;
            gap: 0;
            flex-direction: column;
            align-items: stretch;
            flex: 1;
        }

        /* Piyut banner section (green gradient) */
        .page-theme-piyut .category-card .card-header-text {
            flex: 1;
            background: linear-gradient(135deg, var(--color-piyut) 0%, var(--color-piyut-dark) 100%);
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 70px;
        }

        .page-theme-piyut .category-card .card-title {
            color: white;
            font-size: 1.4em;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        /* Zman tags inside piyut cards - keep original zman color */
        .page-theme-piyut .category-card .card-tags {
            margin-top: 8px;
            gap: 5px;
            justify-content: center;
        }

        .page-theme-piyut .category-card .card-zman-tag {
            background: var(--color-zman);
            color: white;
            font-size: 0.75em;
            padding: 3px 10px;
            border-radius: 10px;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .page-theme-piyut .category-card .card-zman-tag:hover {
            background: var(--color-zman-dark);
            transform: scale(1.05);
        }

        /* Stats at bottom - white background */
        .page-theme-piyut .category-card .card-stats {
            background: white;
            margin: 0;
            padding: 10px 15px;
            justify-content: center;
            gap: 15px;
            border-top: 2px solid var(--color-piyut-light);
            flex-wrap: wrap;
            min-height: 40px;
            flex-shrink: 0;
        }

        .page-theme-piyut .category-card .card-stat {
            color: var(--color-piyut-dark);
            font-weight: 600;
            font-size: 0.85em;
        }

        /* Hover effect adjustments */
        .page-theme-piyut .category-card::after {
            border-color: var(--color-piyut);
            box-shadow: 0 0 20px rgba(46, 139, 46, 0.3);
            border-radius: 16px;
        }

        .page-theme-piyut .category-card:hover {
            box-shadow: 0 8px 30px rgba(46, 139, 46, 0.25);
        }

        /* Mobile styles for chatzer, verter, zman, piyut cards */
        @media (max-width: 480px) {

            .page-theme-chatzer .category-card .card-header-text,
            .page-theme-verter .category-card .card-header-text,
            .page-theme-zman .category-card .card-header-text,
            .page-theme-piyut .category-card .card-header-text {
                padding: 12px 15px;
                min-height: 60px;
            }

            .page-theme-chatzer .category-card .card-title,
            .page-theme-verter .category-card .card-title,
            .page-theme-zman .category-card .card-title,
            .page-theme-piyut .category-card .card-title {
                font-size: 1.2em;
            }
        }

        .card-count {
            background: var(--gradient-main);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .card-expand-icon {
            font-size: 1.2em;
            color: var(--text-muted);
            transition: var(--transition-smooth);
        }

        .card-arrow {
            font-size: 1.2em;
            color: var(--text-muted);
            transition: var(--transition-smooth);
        }

        .category-card:hover .card-arrow {
            color: var(--primary);
            transform: translateX(-5px);
        }

        .category-card.expanded .card-expand-icon {
            transform: rotate(180deg);
            color: var(--primary);
        }

        /* Detail Page Styles */
        .detail-page {
            margin: 0 auto;
        }

        /* Detail pages with page-theme classes need full-width override */
        .detail-page.page-theme-album,
        .detail-page.page-theme-document,
        .detail-page.page-theme-resource {
            max-width: none;
        }

        .detail-page.page-theme-album>*,
        .detail-page.page-theme-document>*,
        .detail-page.page-theme-resource>* {
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Nigun Detail Page */
        .nigun-detail-page {
            max-width: none;
            position: relative;
            margin-left: calc(-50vw + 50%);
            margin-right: calc(-50vw + 50%);
            padding-left: calc(50vw - 50%);
            padding-right: calc(50vw - 50%);
            /* Match nigunim main page gradient background */
            background: linear-gradient(180deg, var(--color-nigun-pale) 0%, color-mix(in srgb, var(--color-nigun-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
            min-height: 100vh;
        }

        .nigun-detail-page>* {
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            z-index: 10;
        }

        /* Floating notes container for nigun detail page - full viewport */
        .nigun-detail-notes {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: visible;
        }

        .nigun-detail-notes .note-wrapper {
            position: absolute;
            animation: songsNoteFlight linear infinite;
        }

        .nigun-detail-notes .musical-note {
            color: rgba(74, 124, 201, 0.15);
            text-shadow: 0 0 20px rgba(74, 124, 201, 0.1);
            font-size: inherit;
            display: block;
        }

        .nigun-detail-notes .musical-note.wander-1 {
            animation: wander1 ease-in-out infinite alternate;
        }

        .nigun-detail-notes .musical-note.wander-2 {
            animation: wander2 ease-in-out infinite alternate;
        }

        .nigun-detail-notes .musical-note.wander-3 {
            animation: wander3 ease-in-out infinite alternate;
        }

        .nigun-detail-header {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 25px;
            color: white;
        }

        .nigun-detail-icon {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            flex-shrink: 0;
        }

        .nigun-detail-title-section {
            flex: 1;
        }

        .nigun-detail-title {
            font-size: 1.8em;
            margin: 0 0 12px 0;
            font-family: 'Heebo', sans-serif;
            font-weight: 600;
        }

        .nigun-mechaber-tag {
            margin-bottom: 10px;
            text-align: center;
        }

        .nigun-chatzer-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .nigun-tag {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-decoration: none;
        }

        .nigun-tag.mechaber-tag {
            background: var(--color-mechaber);
            color: white;
        }

        .nigun-tag.mechaber-tag:hover {
            background: var(--color-mechaber-dark);
        }

        .nigun-tag.chatzer-tag {
            background: var(--color-chatzer);
            color: white;
        }

        .nigun-tag.chatzer-tag:hover {
            background: var(--color-chatzer-dark);
        }

        /* Standalone chatzer tag for use in cards */
        .chatzer-tag {
            display: inline-block;
            background: var(--color-chatzer);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .chatzer-tag:hover {
            background: var(--color-chatzer-dark);
            transform: scale(1.05);
            position: relative;
            z-index: 100;
        }

        /* Standalone mechaber tag for use in cards */
        .mechaber-tag {
            display: inline-block;
            background: var(--color-mechaber);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .mechaber-tag:hover {
            background: var(--color-mechaber-dark);
            transform: scale(1.05);
            position: relative;
            z-index: 100;
        }

        /* Standalone verter tag for use in cards */
        .verter-tag {
            display: inline-block;
            background: var(--color-verter);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .verter-tag:hover {
            background: var(--color-verter-dark);
            transform: scale(1.05);
        }

        /* Standalone zman tag for use in cards */
        .zman-tag {
            display: inline-block;
            background: var(--color-zman);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .zman-tag:hover {
            background: var(--color-zman-dark);
            transform: scale(1.05);
        }

        /* Standalone collection tag for use in cards */
        .collection-tag {
            display: inline-block;
            background: var(--color-collection);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .collection-tag:hover {
            background: var(--color-collection-dark);
            transform: scale(1.05);
        }

        /* Standalone nigun tag for use in cards */
        .nigun-tag-pill {
            display: inline-block;
            background: var(--color-nigun);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .nigun-tag-pill:hover {
            background: var(--color-nigun-dark);
            transform: scale(1.05);
        }

        /* Standalone album tag for use in cards */
        .album-tag {
            display: inline-block;
            background: var(--color-album);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .album-tag:hover {
            background: var(--color-album-dark);
            transform: scale(1.05);
        }

        /* Standalone document tag for use in cards */
        .document-tag {
            display: inline-block;
            background: var(--color-document);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .document-tag:hover {
            background: var(--color-document-dark);
            transform: scale(1.05);
        }

        /* Standalone resource tag for use in cards */
        .resource-tag {
            display: inline-block;
            background: var(--color-resource);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .resource-tag:hover {
            background: var(--color-resource-dark);
            transform: scale(1.05);
        }

        /* Theme inheritance for SONG ITEMS inside detail pages/modals */
        /* Make song item play buttons, borders, backgrounds, and text use the parent theme color */

        /* Mechaber theme */
        .theme-mechaber .song-item .song-play-btn-new {
            background: var(--color-mechaber) !important;
        }

        .theme-mechaber .song-item .song-play-btn-new:hover {
            background: var(--color-mechaber-dark) !important;
        }

        .theme-mechaber .song-item {
            border-color: var(--color-mechaber) !important;
            background: var(--color-mechaber-pale) !important;
        }

        .theme-mechaber .song-item:hover {
            border-color: var(--color-mechaber-dark) !important;
        }

        .theme-mechaber .song-item .song-name {
            color: var(--color-mechaber-dark) !important;
        }

        .theme-mechaber .song-item .song-number {
            color: var(--color-mechaber) !important;
        }

        /* Chatzer theme */
        .theme-chatzer .song-item .song-play-btn-new {
            background: var(--color-chatzer) !important;
        }

        .theme-chatzer .song-item .song-play-btn-new:hover {
            background: var(--color-chatzer-dark) !important;
        }

        .theme-chatzer .song-item {
            border-color: var(--color-chatzer) !important;
            background: var(--color-chatzer-pale) !important;
        }

        .theme-chatzer .song-item:hover {
            border-color: var(--color-chatzer-dark) !important;
        }

        .theme-chatzer .song-item .song-name {
            color: var(--color-chatzer-dark) !important;
        }

        .theme-chatzer .song-item .song-number {
            color: var(--color-chatzer) !important;
        }

        /* Verter theme */
        .theme-verter .song-item .song-play-btn-new {
            background: var(--color-verter) !important;
        }

        .theme-verter .song-item .song-play-btn-new:hover {
            background: var(--color-verter-dark) !important;
        }

        .theme-verter .song-item {
            border-color: var(--color-verter) !important;
            background: var(--color-verter-pale) !important;
        }

        .theme-verter .song-item:hover {
            border-color: var(--color-verter-dark) !important;
        }

        .theme-verter .song-item .song-name {
            color: var(--color-verter-dark) !important;
        }

        .theme-verter .song-item .song-number {
            color: var(--color-verter) !important;
        }

        /* Zman theme */
        .theme-zman .song-item .song-play-btn-new {
            background: var(--color-zman) !important;
        }

        .theme-zman .song-item .song-play-btn-new:hover {
            background: var(--color-zman-dark) !important;
        }

        .theme-zman .song-item {
            border-color: var(--color-zman) !important;
            background: var(--color-zman-pale) !important;
        }

        .theme-zman .song-item:hover {
            border-color: var(--color-zman-dark) !important;
        }

        .theme-zman .song-item .song-name {
            color: var(--color-zman-dark) !important;
        }

        .theme-zman .song-item .song-number {
            color: var(--color-zman) !important;
        }

        /* Piyut theme */
        .theme-piyut .song-item .song-play-btn-new {
            background: var(--color-piyut) !important;
        }

        .theme-piyut .song-item .song-play-btn-new:hover {
            background: var(--color-piyut-dark) !important;
        }

        .theme-piyut .song-item {
            border-color: var(--color-piyut) !important;
            background: var(--color-piyut-pale) !important;
        }

        .theme-piyut .song-item:hover {
            border-color: var(--color-piyut-dark) !important;
        }

        .theme-piyut .song-item .song-name {
            color: var(--color-piyut-dark) !important;
        }

        .theme-piyut .song-item .song-number {
            color: var(--color-piyut) !important;
        }

        /* Collection theme */
        .theme-collection .song-item .song-play-btn-new {
            background: var(--color-collection) !important;
        }

        .theme-collection .song-item .song-play-btn-new:hover {
            background: var(--color-collection-dark) !important;
        }

        .theme-collection .song-item {
            border-color: var(--color-collection) !important;
            background: var(--color-collection-pale) !important;
        }

        .theme-collection .song-item:hover {
            border-color: var(--color-collection-dark) !important;
        }

        .theme-collection .song-item .song-name {
            color: var(--color-collection-dark) !important;
        }

        .theme-collection .song-item .song-number {
            color: var(--color-collection) !important;
        }

        /* Album theme */
        .theme-album .song-item .song-play-btn-new {
            background: var(--color-album) !important;
        }

        .theme-album .song-item .song-play-btn-new:hover {
            background: var(--color-album-dark) !important;
        }

        .theme-album .song-item {
            border-color: var(--color-album) !important;
            background: var(--color-album-pale) !important;
        }

        .theme-album .song-item:hover {
            border-color: var(--color-album-dark) !important;
        }

        .theme-album .song-item .song-name {
            color: var(--color-album-dark) !important;
        }

        .theme-album .song-item .song-number {
            color: var(--color-album) !important;
        }

        /* Document theme */
        .theme-document .song-item .song-play-btn-new {
            background: var(--color-document) !important;
        }

        .theme-document .song-item .song-play-btn-new:hover {
            background: var(--color-document-dark) !important;
        }

        .theme-document .song-item {
            border-color: var(--color-document) !important;
            background: var(--color-document-pale) !important;
        }

        .theme-document .song-item:hover {
            border-color: var(--color-document-dark) !important;
        }

        .theme-document .song-item .song-name {
            color: var(--color-document-dark) !important;
        }

        .theme-document .song-item .song-number {
            color: var(--color-document) !important;
        }

        /* Resource theme */
        .theme-resource .song-item .song-play-btn-new {
            background: var(--color-resource) !important;
        }

        .theme-resource .song-item .song-play-btn-new:hover {
            background: var(--color-resource-dark) !important;
        }

        .theme-resource .song-item {
            border-color: var(--color-resource) !important;
            background: var(--color-resource-pale) !important;
        }

        .theme-resource .song-item:hover {
            border-color: var(--color-resource-dark) !important;
        }

        .theme-resource .song-item .song-name {
            color: var(--color-resource-dark) !important;
        }

        .theme-resource .song-item .song-number {
            color: var(--color-resource) !important;
        }

        /* Active song state - use theme color for playing songs */
        .theme-mechaber .song-item.active::before {
            background: var(--color-mechaber) !important;
        }

        .theme-mechaber .song-item.active {
            box-shadow: 0 4px 15px rgba(196, 53, 168, 0.4) !important;
        }

        .theme-mechaber .song-item.active .song-name,
        .theme-mechaber .song-item.active .song-number {
            color: white !important;
        }

        .theme-chatzer .song-item.active::before {
            background: var(--color-chatzer) !important;
        }

        .theme-chatzer .song-item.active {
            box-shadow: 0 4px 15px rgba(156, 91, 181, 0.4) !important;
        }

        .theme-chatzer .song-item.active .song-name,
        .theme-chatzer .song-item.active .song-number {
            color: white !important;
        }

        .theme-verter .song-item.active::before {
            background: var(--color-verter) !important;
        }

        .theme-verter .song-item.active {
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4) !important;
        }

        .theme-verter .song-item.active .song-name,
        .theme-verter .song-item.active .song-number {
            color: white !important;
        }

        .theme-zman .song-item.active::before {
            background: var(--color-zman) !important;
        }

        .theme-zman .song-item.active {
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4) !important;
        }

        .theme-zman .song-item.active .song-name,
        .theme-zman .song-item.active .song-number {
            color: white !important;
        }

        .theme-piyut .song-item.active::before {
            background: var(--color-piyut) !important;
        }

        .theme-piyut .song-item.active {
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4) !important;
        }

        .theme-piyut .song-item.active .song-name,
        .theme-piyut .song-item.active .song-number {
            color: white !important;
        }

        .theme-collection .song-item.active::before {
            background: var(--color-collection) !important;
        }

        .theme-collection .song-item.active {
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4) !important;
        }

        .theme-collection .song-item.active .song-name,
        .theme-collection .song-item.active .song-number {
            color: white !important;
        }

        .theme-album .song-item.active::before {
            background: var(--color-album) !important;
        }

        .theme-album .song-item.active {
            box-shadow: 0 4px 15px rgba(139, 195, 74, 0.4) !important;
        }

        .theme-album .song-item.active .song-name,
        .theme-album .song-item.active .song-number {
            color: white !important;
        }

        .theme-document .song-item.active::before {
            background: var(--color-document) !important;
        }

        .theme-document .song-item.active {
            box-shadow: 0 4px 15px rgba(121, 85, 72, 0.4) !important;
        }

        .theme-document .song-item.active .song-name,
        .theme-document .song-item.active .song-number {
            color: white !important;
        }

        .theme-resource .song-item.active::before {
            background: var(--color-resource) !important;
        }

        .theme-resource .song-item.active {
            box-shadow: 0 4px 15px rgba(255, 183, 77, 0.4) !important;
        }

        .theme-resource .song-item.active .song-name,
        .theme-resource .song-item.active .song-number {
            color: white !important;
        }

        /* Hover border effect - override the ::after pseudo-element border color */
        .theme-mechaber .song-item::after {
            border-color: var(--color-mechaber) !important;
            box-shadow: 0 0 15px rgba(196, 53, 168, 0.2) !important;
        }

        .theme-chatzer .song-item::after {
            border-color: var(--color-chatzer) !important;
            box-shadow: 0 0 15px rgba(156, 91, 181, 0.2) !important;
        }

        .theme-verter .song-item::after {
            border-color: var(--color-verter) !important;
            box-shadow: 0 0 15px rgba(107, 114, 128, 0.2) !important;
        }

        .theme-zman .song-item::after {
            border-color: var(--color-zman) !important;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.2) !important;
        }

        .theme-piyut .song-item::after {
            border-color: var(--color-piyut) !important;
            box-shadow: 0 0 15px rgba(233, 30, 99, 0.2) !important;
        }

        .theme-collection .song-item::after {
            border-color: var(--color-collection) !important;
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.2) !important;
        }

        .theme-album .song-item::after {
            border-color: var(--color-album) !important;
            box-shadow: 0 0 15px rgba(139, 195, 74, 0.2) !important;
        }

        .theme-document .song-item::after {
            border-color: var(--color-document) !important;
            box-shadow: 0 0 15px rgba(121, 85, 72, 0.2) !important;
        }

        .theme-resource .song-item::after {
            border-color: var(--color-resource) !important;
            box-shadow: 0 0 15px rgba(255, 183, 77, 0.2) !important;
        }

        /* Theme overrides for song-item-recording in mechaber theme */
        .theme-mechaber .song-item-recording {
            background: var(--color-mechaber-pale) !important;
        }

        .theme-mechaber .song-item-recording::after {
            border-color: var(--color-mechaber) !important;
            box-shadow: 0 0 15px rgba(196, 53, 168, 0.2) !important;
        }

        .theme-mechaber .song-item-recording:hover {
            box-shadow: 0 6px 20px rgba(196, 53, 168, 0.35) !important;
        }

        .theme-mechaber .song-item-recording:not(.active-recording):hover {
            background: var(--color-mechaber-pale) !important;
        }

        .theme-mechaber .song-item-rec-num {
            background: var(--color-mechaber-pale) !important;
            color: var(--color-mechaber-dark) !important;
        }

        .theme-mechaber .song-item-recording.active-recording {
            background: linear-gradient(135deg, var(--color-mechaber) 0%, var(--color-mechaber-dark) 100%) !important;
        }

        .theme-mechaber .song-item-recording.active-recording::before {
            background: var(--color-mechaber) !important;
        }

        .theme-mechaber .song-item-recording.active-recording::after {
            border-color: var(--color-mechaber) !important;
        }

        .theme-mechaber .song-item-recording.active-recording .song-item-rec-num {
            background: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }


        /* Mechaber theme: song-item-header uses mechaber gradient */
        .theme-mechaber .song-item-expanded .song-item-header,
        .theme-mechaber .song-item-full .song-item-header {
            background: linear-gradient(135deg, var(--color-mechaber-dark) 0%, var(--color-mechaber) 100%) !important;
        }

        /* Mechaber theme: song-item-header text should be white */
        .theme-mechaber .song-item-expanded .song-item-header .song-name,
        .theme-mechaber .song-item-full .song-item-header .song-name {
            color: white !important;
        }

        .theme-mechaber .song-item-expanded .song-item-header .song-meta,
        .theme-mechaber .song-item-full .song-item-header .song-meta,
        .theme-mechaber .song-item-expanded .song-item-header .song-meta span,
        .theme-mechaber .song-item-full .song-item-header .song-meta span,
        .theme-mechaber .song-item-expanded .song-item-header .song-meta-tag,
        .theme-mechaber .song-item-full .song-item-header .song-meta-tag {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        .theme-mechaber .song-item-expanded .song-item-header .song-number,
        .theme-mechaber .song-item-full .song-item-header .song-number {
            background: rgba(255, 255, 255, 0.25) !important;
            color: white !important;
        }

        .theme-mechaber .song-item-expanded .song-item-header .song-play-btn-new,
        .theme-mechaber .song-item-full .song-item-header .song-play-btn-new {
            background: rgba(255, 255, 255, 0.25) !important;
            color: white !important;
        }

        .theme-mechaber .song-item-expanded .song-item-header .song-play-btn-new:hover,
        .theme-mechaber .song-item-full .song-item-header .song-play-btn-new:hover {
            background: white !important;
            color: var(--color-mechaber-dark) !important;
        }

        .theme-mechaber .song-item-expanded .song-item-header .song-wave-animation .wave-bar,
        .theme-mechaber .song-item-full .song-item-header .song-wave-animation .wave-bar {
            background: white !important;
        }

        /* Theme overrides for nested cards (mechaber cards inside other detail pages) */
        .theme-chatzer .nigun-mechaber-card {
            background: var(--color-chatzer) !important;
        }

        .theme-chatzer .nigun-mechaber-card:hover {
            box-shadow: 0 4px 15px rgba(156, 91, 181, 0.4) !important;
        }

        .theme-chatzer .mechaber-card::after,
        .theme-chatzer .nigun-mechaber-card::after {
            border-color: var(--color-chatzer-light) !important;
            box-shadow: 0 0 15px rgba(156, 91, 181, 0.25) !important;
        }

        .theme-chatzer .nigun-mechaber-placeholder {
            background: linear-gradient(135deg, var(--color-chatzer-pale) 0%, var(--color-chatzer-light) 100%) !important;
        }

        .theme-chatzer .nigun-mechaber-placeholder .mechaber-icon {
            background-color: var(--color-chatzer) !important;
        }

        .theme-verter .nigun-mechaber-card {
            background: var(--color-verter) !important;
        }

        .theme-verter .nigun-mechaber-card:hover {
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4) !important;
        }

        .theme-verter .mechaber-card::after,
        .theme-verter .nigun-mechaber-card::after {
            border-color: var(--color-verter-light) !important;
            box-shadow: 0 0 15px rgba(107, 114, 128, 0.25) !important;
        }

        .theme-verter .nigun-mechaber-placeholder {
            background: linear-gradient(135deg, var(--color-verter-pale) 0%, var(--color-verter-light) 100%) !important;
        }

        .theme-verter .nigun-mechaber-placeholder .mechaber-icon {
            background-color: var(--color-verter) !important;
        }

        .theme-zman .nigun-mechaber-card {
            background: var(--color-zman) !important;
        }

        .theme-zman .nigun-mechaber-card:hover {
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4) !important;
        }

        .theme-zman .mechaber-card::after,
        .theme-zman .nigun-mechaber-card::after {
            border-color: var(--color-zman-light) !important;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.25) !important;
        }

        .theme-zman .nigun-mechaber-placeholder {
            background: linear-gradient(135deg, var(--color-zman-pale) 0%, var(--color-zman-light) 100%) !important;
        }

        .theme-zman .nigun-mechaber-placeholder .mechaber-icon {
            background-color: var(--color-zman) !important;
        }

        .theme-piyut .nigun-mechaber-card {
            background: var(--color-piyut) !important;
        }

        .theme-piyut .nigun-mechaber-card:hover {
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4) !important;
        }

        .theme-piyut .mechaber-card::after,
        .theme-piyut .nigun-mechaber-card::after {
            border-color: var(--color-piyut-light) !important;
            box-shadow: 0 0 15px rgba(233, 30, 99, 0.25) !important;
        }

        .theme-piyut .nigun-mechaber-placeholder {
            background: linear-gradient(135deg, var(--color-piyut-pale) 0%, var(--color-piyut-light) 100%) !important;
        }

        .theme-piyut .nigun-mechaber-placeholder .mechaber-icon {
            background-color: var(--color-piyut) !important;
        }

        .theme-collection .nigun-mechaber-card {
            background: var(--color-collection) !important;
        }

        .theme-collection .nigun-mechaber-card:hover {
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4) !important;
        }

        .theme-collection .mechaber-card::after,
        .theme-collection .nigun-mechaber-card::after {
            border-color: var(--color-collection-light) !important;
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.25) !important;
        }

        .theme-collection .nigun-mechaber-placeholder {
            background: linear-gradient(135deg, var(--color-collection-pale) 0%, var(--color-collection-light) 100%) !important;
        }

        .theme-collection .nigun-mechaber-placeholder .mechaber-icon {
            background-color: var(--color-collection) !important;
        }

        .theme-album .nigun-mechaber-card {
            background: var(--color-album) !important;
        }

        .theme-album .nigun-mechaber-card:hover {
            box-shadow: 0 4px 15px rgba(139, 195, 74, 0.4) !important;
        }

        .theme-album .mechaber-card::after,
        .theme-album .nigun-mechaber-card::after {
            border-color: var(--color-album-light) !important;
            box-shadow: 0 0 15px rgba(139, 195, 74, 0.25) !important;
        }

        .theme-album .nigun-mechaber-placeholder {
            background: linear-gradient(135deg, var(--color-album-pale) 0%, var(--color-album-light) 100%) !important;
        }

        .theme-album .nigun-mechaber-placeholder .mechaber-icon {
            background-color: var(--color-album) !important;
        }

        .theme-document .nigun-mechaber-card {
            background: var(--color-document) !important;
        }

        .theme-document .nigun-mechaber-card:hover {
            box-shadow: 0 4px 15px rgba(121, 85, 72, 0.4) !important;
        }

        .theme-document .mechaber-card::after,
        .theme-document .nigun-mechaber-card::after {
            border-color: var(--color-document-light) !important;
            box-shadow: 0 0 15px rgba(121, 85, 72, 0.25) !important;
        }

        .theme-document .nigun-mechaber-placeholder {
            background: linear-gradient(135deg, var(--color-document-pale) 0%, var(--color-document-light) 100%) !important;
        }

        .theme-document .nigun-mechaber-placeholder .mechaber-icon {
            background-color: var(--color-document) !important;
        }

        .theme-resource .nigun-mechaber-card {
            background: var(--color-resource) !important;
        }

        .theme-resource .nigun-mechaber-card:hover {
            box-shadow: 0 4px 15px rgba(255, 183, 77, 0.4) !important;
        }

        .theme-resource .mechaber-card::after,
        .theme-resource .nigun-mechaber-card::after {
            border-color: var(--color-resource-light) !important;
            box-shadow: 0 0 15px rgba(255, 183, 77, 0.25) !important;
        }

        .theme-resource .nigun-mechaber-placeholder {
            background: linear-gradient(135deg, var(--color-resource-pale) 0%, var(--color-resource-light) 100%) !important;
        }

        .theme-resource .nigun-mechaber-placeholder .mechaber-icon {
            background-color: var(--color-resource) !important;
        }


        /* Tags container for displaying multiple tags */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        /* Category-specific text colors - for use anywhere on the site */
        .text-chatzer {
            color: var(--color-chatzer-dark);
        }

        .text-chatzer:hover {
            color: var(--color-chatzer);
        }

        .text-mechaber {
            color: var(--color-mechaber-dark);
        }

        .text-mechaber:hover {
            color: var(--color-mechaber);
        }

        .text-nigun {
            color: var(--color-nigun-dark);
        }

        .text-nigun:hover {
            color: var(--color-nigun);
        }

        .text-verter {
            color: var(--color-verter-dark);
        }

        .text-verter:hover {
            color: var(--color-verter);
        }

        .text-zman {
            color: var(--color-zman-dark);
        }

        .text-zman:hover {
            color: var(--color-zman);
        }

        .text-collection {
            color: var(--color-collection-dark);
        }

        .text-collection:hover {
            color: var(--color-collection);
        }

        .text-resource {
            color: var(--color-resource-dark);
        }

        .text-resource:hover {
            color: var(--color-resource);
        }

        .text-document {
            color: var(--color-document-dark);
        }

        .text-document:hover {
            color: var(--color-document);
        }

        .text-album {
            color: var(--color-album-dark);
        }

        .text-album:hover {
            color: var(--color-album);
        }

        .text-music {
            color: var(--color-music-dark);
        }

        .text-music:hover {
            color: var(--color-music);
        }

        /* Category text links with underlines */
        .link-chatzer {
            color: var(--color-chatzer-dark);
            text-decoration: underline;
            text-decoration-color: var(--color-chatzer-light);
            cursor: pointer;
        }

        .link-chatzer:hover {
            color: var(--color-chatzer);
            text-decoration-color: var(--color-chatzer);
        }

        .link-mechaber {
            color: var(--color-mechaber-dark);
            text-decoration: underline;
            text-decoration-color: var(--color-mechaber-light);
            cursor: pointer;
        }

        .link-mechaber:hover {
            color: var(--color-mechaber);
            text-decoration-color: var(--color-mechaber);
        }

        .link-nigun {
            color: var(--color-nigun-dark);
            text-decoration: underline;
            text-decoration-color: var(--color-nigun-light);
            cursor: pointer;
        }

        .link-nigun:hover {
            color: var(--color-nigun);
            text-decoration-color: var(--color-nigun);
        }

        .link-verter {
            color: var(--color-verter-dark);
            text-decoration: underline;
            text-decoration-color: var(--color-verter-light);
            cursor: pointer;
        }

        .link-verter:hover {
            color: var(--color-verter);
            text-decoration-color: var(--color-verter);
        }

        .link-zman {
            color: var(--color-zman-dark);
            text-decoration: underline;
            text-decoration-color: var(--color-zman-light);
            cursor: pointer;
        }

        .link-zman:hover {
            color: var(--color-zman);
            text-decoration-color: var(--color-zman);
        }

        .link-collection {
            color: var(--color-collection-dark);
            text-decoration: underline;
            text-decoration-color: var(--color-collection-light);
            cursor: pointer;
        }

        .link-collection:hover {
            color: var(--color-collection);
            text-decoration-color: var(--color-collection);
        }

        .link-resource {
            color: var(--color-resource-dark);
            text-decoration: underline;
            text-decoration-color: var(--color-resource-light);
            cursor: pointer;
        }

        .link-resource:hover {
            color: var(--color-resource);
            text-decoration-color: var(--color-resource);
        }

        .link-document {
            color: var(--color-document-dark);
            text-decoration: underline;
            text-decoration-color: var(--color-document-light);
            cursor: pointer;
        }

        .link-document:hover {
            color: var(--color-document);
            text-decoration-color: var(--color-document);
        }

        .link-album {
            color: var(--color-album-dark);
            text-decoration: underline;
            text-decoration-color: var(--color-album-light);
            cursor: pointer;
        }

        .link-album:hover {
            color: var(--color-album);
            text-decoration-color: var(--color-album);
        }

        /* Nigun sections */
        .nigun-section {
            background: transparent;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        /* Mechaber Section */
        .nigun-mechaber-section {
            background: white;
            border-radius: 15px;
            padding: 20px 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .nigun-mechaber-title {
            font-weight: 600;
            color: var(--color-mechaber-dark);
            margin-bottom: 15px;
            font-size: 1em;
            text-align: center;
        }

        .nigun-mechaber-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .nigun-mechaber-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--color-mechaber);
            border-radius: 12px;
            padding: 15px 8px 10px 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: none;
            position: relative;
            width: 110px;
            text-decoration: none;
        }

        /* Hover effect for Mechaber Card */
        .nigun-mechaber-card::after {
            content: '';
            position: absolute;
            border-radius: 12px;
            border: 2px solid var(--color-mechaber-light);
            opacity: 0;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            transition: opacity 0.2s ease;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(156, 91, 181, 0.25);
        }

        .nigun-mechaber-card:hover::after {
            opacity: 1;
        }

        .nigun-mechaber-card:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 15px rgba(156, 91, 181, 0.3);
        }

        .nigun-mechaber-image {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .nigun-mechaber-placeholder {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-mechaber-pale) 0%, var(--color-mechaber-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .nigun-mechaber-placeholder .mechaber-icon {
            width: 28px;
            height: 41px;
            background-color: var(--color-mechaber);
            -webkit-mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
            mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
        }

        .nigun-mechaber-placeholder .album-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid var(--color-album);
            position: relative;
        }

        .nigun-mechaber-placeholder .album-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--color-album);
        }

        .nigun-mechaber-placeholder .document-icon {
            width: 28px;
            height: 36px;
            border: 3px solid var(--color-document);
            border-radius: 3px;
            position: relative;
        }

        .nigun-mechaber-placeholder .document-icon::after {
            content: '';
            position: absolute;
            top: -3px;
            right: -3px;
            width: 12px;
            height: 12px;
            background: white;
            border-bottom: 3px solid var(--color-document);
            border-left: 3px solid var(--color-document);
            border-radius: 0 0 0 3px;
        }

        .nigun-mechaber-name {
            font-weight: 600;
            color: white;
            text-align: center;
            font-size: 0.85em;
            line-height: 1.2;
            text-wrap: balance;
        }

        /* Personality Section */
        .nigun-personality-section {
            background: white;
            border-radius: 15px;
            padding: 20px 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .nigun-personality-title {
            font-weight: 600;
            color: var(--color-mechaber-dark);
            margin-bottom: 15px;
            font-size: 1em;
            text-align: center;
        }

        .nigun-personality-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .nigun-personality-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--bg-light);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 2px solid transparent;
            min-width: 100px;
        }

        .nigun-personality-card:hover {
            /* border-color handled by ::after */
            background: white;
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        /* Add hover effect for personality card */
        .nigun-personality-card {
            position: relative;
        }

        .nigun-personality-card::after {
            content: '';
            position: absolute;
            border-radius: 12px;
            border: 2px solid var(--color-mechaber);
            opacity: 0;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-shadow: 0 0 15px rgba(239, 83, 80, 0.15);
        }

        .nigun-personality-card:hover::after {
            opacity: 1;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .nigun-personality-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid var(--color-mechaber-pale);
        }

        .nigun-personality-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--color-mechaber-pale);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .nigun-personality-name {
            font-weight: 500;
            color: var(--text-dark);
            text-align: center;
            font-size: 0.85em;
        }

        .nigun-details-card {
            display: none;
            /* Hide old card layout */
        }

        /* New Compact Details Grid */
        .nigun-details-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 30px 25px;
            margin-bottom: 30px;
            margin-top: 25px;
            justify-content: center;
            padding-top: 15px;
        }

        /* Row grouping for specific items */
        .nigun-details-row {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            justify-content: center;
            width: 100%;
        }

        .nigun-detail-box {
            flex: 0 0 auto;
            min-width: 90px;
            max-width: 160px;
            min-height: 60px;
            position: relative;
            border-radius: 12px;
            padding: 8px 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            text-align: center;
            background: var(--color-nigun-pale);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .nigun-detail-box[data-action] {
            cursor: pointer;
        }

        .nigun-detail-box[data-action]:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Siman box - styled like info-box - GRAY THEME */
        .nigun-detail-siman-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
            padding: 15px 20px;
            background: #f5f5f5;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 600px;
            border: 1.5px solid #d0d0d0;
        }

        .nigun-detail-siman-label {
            color: #666666;
            font-size: 1em;
            font-weight: bold;
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e0e0e0;
            border-radius: 50%;
            font-style: normal;
            margin-top: -29px;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .nigun-detail-siman-text {
            font-size: 0.85em;
            color: #555555;
            line-height: 1.6;
        }

        /* Category-specific backgrounds */
        .nigun-detail-box.box-verter {
            background: var(--color-verter-pale);
        }

        .nigun-detail-box.box-scale {
            background: var(--color-music-pale);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .nigun-detail-box.box-scale:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nigun-detail-box.box-ritem {
            background: var(--color-music-pale);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .nigun-detail-box.box-ritem:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nigun-detail-box.box-maure {
            background: var(--color-piyut-pale);
        }

        .nigun-detail-box.box-pasig {
            background: var(--color-piyut-pale);
        }

        .nigun-detail-box.box-collections {
            background: var(--color-collection-pale);
        }

        .nigun-detail-box.box-albums {
            background: var(--color-album-pale);
        }

        .nigun-detail-box.box-documents {
            background: var(--color-nigun-pale);
        }

        .nigun-detail-box.box-resources {
            background: var(--color-nigun-pale);
        }

        .nigun-detail-box-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--color-nigun-dark);
            color: white;
            padding: 4px 8px;
            font-size: 0.7em;
            font-weight: 700;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            border-radius: 12px 12px 0 0;
        }

        /* Category-specific header backgrounds */
        .nigun-detail-box.box-verter .nigun-detail-box-header {
            background: var(--color-verter-dark);
        }

        .nigun-detail-box.box-scale .nigun-detail-box-header {
            background: var(--color-music-dark);
        }

        .nigun-detail-box.box-ritem .nigun-detail-box-header {
            background: var(--color-music-dark);
        }

        .nigun-detail-box.box-maure .nigun-detail-box-header {
            background: var(--color-piyut-dark);
        }

        .nigun-detail-box.box-pasig .nigun-detail-box-header {
            background: var(--color-piyut-dark);
        }

        .nigun-detail-box.box-collections .nigun-detail-box-header {
            background: var(--color-collection-dark);
        }

        .nigun-detail-box.box-albums .nigun-detail-box-header {
            background: var(--color-album-dark);
        }

        .nigun-detail-box.box-documents .nigun-detail-box-header {
            background: var(--color-nigun-dark);
        }

        .nigun-detail-box.box-resources .nigun-detail-box-header {
            background: var(--color-nigun-dark);
        }

        .nigun-detail-box-content {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
            justify-content: center;
            padding: 24px 8px 8px 8px;
            font-size: 0.92em;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.5;
            width: 100%;
            word-break: break-word;
        }

        .nigun-detail-box-content .nigun-tag-inline {
            margin: 0;
            font-size: 0.85em;
        }

        .nigun-detail-box-text {
            font-size: 0.85em;
            color: var(--text-dark);
            line-height: 1.4;
            word-break: break-word;
        }

        @media (max-width: 500px) {
            .nigun-details-grid {
                gap: 12px 8px;
            }

            .nigun-detail-box {
                flex: 0 0 auto;
                min-width: 85px;
                max-width: 140px;
                padding: 6px 8px;
            }

            .nigun-detail-siman-bar {
                padding: 10px 12px;
                font-size: 0.9em;
            }
        }

        .nigun-detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--color-nigun-pale);
        }

        .nigun-detail-row:last-child {
            border-bottom: none;
        }

        .nigun-detail-label {
            font-weight: 600;
            color: var(--color-nigun-dark);
            min-width: 100px;
            flex-shrink: 0;
        }

        .nigun-detail-value {
            color: var(--text-dark);
            flex: 1;
        }

        .nigun-detail-value.nigun-tags-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .nigun-tag-inline {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .nigun-tag-inline.tag-scale {
            background: var(--color-music);
            color: white;
            cursor: pointer;
        }

        .nigun-tag-inline.tag-scale:hover {
            background: var(--color-music-dark, #b8960c);
            transform: scale(1.05);
        }

        .nigun-tag-inline.tag-ritem {
            background: var(--color-music);
            color: white;
            cursor: pointer;
        }

        .nigun-tag-inline.tag-ritem:hover {
            background: var(--color-music-dark, #b8960c);
            transform: scale(1.05);
        }

        .nigun-tag-inline.tag-zman {
            background: var(--color-zman);
            color: white;
        }

        .nigun-tag-inline.tag-zman:hover {
            background: var(--color-zman-dark);
            transform: scale(1.05);
        }

        .nigun-tag-inline.tag-piyut {
            background: #2e8b2e;
            color: white;
        }

        .nigun-tag-inline.tag-piyut:hover {
            background: #1b5e20;
            transform: scale(1.05);
        }

        .nigun-tag-inline.tag-collection {
            background: var(--color-collection);
            color: white;
        }

        .nigun-tag-inline.tag-collection:hover {
            background: var(--color-collection-dark);
            transform: scale(1.05);
        }

        .nigun-tag-inline.tag-album {
            background: var(--color-album);
            color: white;
        }

        .nigun-tag-inline.tag-album:hover {
            background: var(--color-album-dark);
            transform: scale(1.05);
        }

        .nigun-tag-inline.tag-document {
            background: var(--color-document);
            color: white;
        }

        .nigun-tag-inline.tag-document:hover {
            background: var(--color-document-dark);
            transform: scale(1.05);
        }

        .nigun-tag-inline.tag-resource {
            background: var(--color-resource);
            color: white;
        }

        .nigun-tag-inline.tag-resource:hover {
            background: var(--color-resource-dark);
            transform: scale(1.05);
        }

        .nigun-tag-inline.tag-verter {
            background: var(--color-verter);
            color: white;
        }

        .nigun-tag-inline.tag-verter:hover {
            background: var(--color-verter-dark);
            transform: scale(1.05);
        }

        .nigun-section h3 {
            margin: 0 0 15px 0;
            color: var(--primary);
            font-size: 1.05em;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .nigun-section-content {
            color: var(--text-dark);
        }

        /* Subtle info box with icon - centered */
        .nigun-info-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
            padding: 15px 20px;
            background: var(--color-nigun-pale);
            border-radius: 12px;
            margin: 20px auto;
            max-width: 600px;
            border: 1.5px solid var(--color-nigun-dark);
        }

        .nigun-info-icon {
            color: var(--color-nigun);
            font-size: 1em;
            font-weight: bold;
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-nigun-light);
            border-radius: 50%;
            font-style: normal;
            margin-top: -29px;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .nigun-info-box .nigun-info-text {
            font-size: 0.85em;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Additions box - similar to info but different color */
        .nigun-additions-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
            padding: 20px 20px 15px 20px;
            background: var(--color-piyut-pale);
            border-radius: 12px;
            margin: 25px auto 20px auto;
            max-width: 600px;
            position: relative;
            border: 1.5px solid var(--color-nigun-dark);
        }

        .nigun-additions-icon {
            color: var(--color-piyut);
            font-size: 1.1em;
            font-weight: bold;
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-piyut-light);
            border-radius: 50%;
            font-style: normal;
            margin-top: -34px;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .nigun-additions-box .nigun-additions-text {
            font-size: 0.85em;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .nigun-additions-content {
            width: 100%;
            text-align: right;
        }

        .nigun-siman {
            font-size: 1.1em;
            font-style: italic;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .nigun-verter {
            font-size: 1em;
        }

        .nigun-verter .field-link {
            font-size: 1.1em;
            color: var(--color-verter);
            border-bottom-color: var(--color-verter-light);
        }

        .nigun-verter .field-link:hover {
            color: var(--color-verter-dark);
        }

        .nigun-info-text {
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .nigun-music-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nigun-music-tag {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
            color: white;
        }

        .nigun-music-tag:hover {
            transform: scale(1.05);
            filter: brightness(0.9);
        }

        .nigun-music-tag.tag-scale,
        .nigun-music-tag.tag-ritem {
            background: var(--color-music);
        }

        .nigun-music-tag.tag-zman {
            background: var(--color-zman);
        }

        .nigun-music-tag.tag-maure {
            background: var(--color-zman-light);
        }

        .nigun-music-tag.tag-collection {
            background: var(--color-collection);
        }

        .nigun-notn-link {
            display: inline-block;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            text-decoration: none;
            transition: var(--transition-smooth);
        }

        .nigun-notn-link:hover {
            background: var(--primary-deep);
            transform: translateY(-2px);
        }

        /* Nigun recordings - Song card style */
        .nigun-recordings-section {
            margin-bottom: 20px;
        }

        .nigun-recordings-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nigun-recording-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            background: var(--color-nigun-pale);
            border: 1px solid transparent;
            box-shadow: 0 0 0 rgba(74, 124, 201, 0);
            transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, padding 0.3s ease;
        }

        .nigun-recording-item:hover {
            background: #4a7cc9;
            border-color: #4a7cc9;
            color: white;
            box-shadow: 0 4px 15px rgba(74, 124, 201, 0.4);
            padding: 14px 16px;
        }

        .nigun-recording-item:hover .nigun-recording-name {
            color: white !important;
        }

        .nigun-recording-item:hover .nigun-recording-meta {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        .nigun-recording-item:hover .nigun-recording-meta .song-meta-tag {
            opacity: 0.9;
        }

        .nigun-recording-item:hover .nigun-recording-number {
            background: rgba(255, 255, 255, 0.25) !important;
            color: white !important;
        }

        .nigun-recording-item.active {
            background: #4a7cc9 !important;
            color: white !important;
            border-color: #4a7cc9 !important;
        }

        .nigun-recording-item.active:hover {
            background: #3d6bb5 !important;
        }

        .nigun-recording-item.active .nigun-recording-name {
            color: white !important;
        }

        .nigun-recording-item.active .nigun-recording-meta {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        .nigun-recording-item.active .nigun-recording-meta .song-meta-tag {
            opacity: 0.9;
        }

        .nigun-recording-item.active .nigun-recording-number {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nigun-recording-number {
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85em;
            color: var(--color-nigun);
            flex-shrink: 0;
        }

        .nigun-recording-info {
            flex: 1;
            min-width: 0;
        }

        .nigun-recording-name {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--color-nigun-dark);
        }

        .nigun-recording-name.default-name {
            color: var(--color-nigun-light);
        }

        .nigun-recording-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
            font-size: 0.85em;
        }

        /* Override tag styles within recording meta to be smaller */
        .nigun-recording-meta .song-meta-tag {
            padding: 2px 8px !important;
            font-size: 0.75em !important;
            border-radius: 10px !important;
        }

        .nigun-recording-play-btn {
            width: 38px;
            height: 38px;
            background: var(--color-nigun);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            flex-shrink: 0;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(74, 124, 201, 0.3);
            transition: var(--transition-smooth);
        }

        .nigun-recording-play-btn:hover {
            background: var(--color-nigun-dark);
            transform: scale(1.1);
        }

        .nigun-recording-item.active .nigun-recording-play-btn {
            background: white;
            color: var(--color-nigun);
        }

        /* Wave animation for playing recording */
        .nigun-recording-wave {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 20px;
            margin-left: 8px;
        }

        .nigun-recording-wave .wave-bar {
            width: 3px;
            background: white;
            border-radius: 3px;
            animation: waveStream 0.8s ease-in-out infinite;
        }

        .nigun-recording-wave .wave-bar:nth-child(1) {
            height: 6px;
            animation-delay: 0s;
        }

        .nigun-recording-wave .wave-bar:nth-child(2) {
            height: 12px;
            animation-delay: 0.1s;
        }

        .nigun-recording-wave .wave-bar:nth-child(3) {
            height: 8px;
            animation-delay: 0.2s;
        }

        .nigun-recording-wave .wave-bar:nth-child(4) {
            height: 14px;
            animation-delay: 0.15s;
        }

        .nigun-recording-item.paused .nigun-recording-wave .wave-bar {
            animation-play-state: paused;
        }

        /* Star rating for player - INTERACTIVE */
        .player-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            padding-right: 15px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .player-rating-star {
            font-size: 1.2em;
            color: white;
            transition: transform 0.15s ease, opacity 0.2s ease, text-shadow 0.2s ease;
            cursor: pointer;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .player-rating-star:hover {
            transform: scale(1.25);
        }

        /* All 5 stars container */
        .player-rating-stars {
            display: flex;
            gap: 3px;
        }

        /* Each star - white on gradient background */
        .player-rating-stars .player-rating-star {
            color: white;
            -webkit-text-fill-color: white;
            text-shadow: 0 2px 10px rgba(255, 255, 255, 0.4);
            transition: all 0.25s ease;
        }

        /* Position each star's gradient slice - not needed for white stars but kept for compatibility */
        .player-rating-stars .player-rating-star:nth-child(1) {
            background-position: 0% 0;
        }

        .player-rating-stars .player-rating-star:nth-child(2) {
            background-position: 25% 0;
        }

        .player-rating-stars .player-rating-star:nth-child(3) {
            background-position: 50% 0;
        }

        .player-rating-stars .player-rating-star:nth-child(4) {
            background-position: 75% 0;
        }

        .player-rating-stars .player-rating-star:nth-child(5) {
            background-position: 100% 0;
        }

        /* Empty stars are translucent white */
        .player-rating-stars .player-rating-star.empty {
            -webkit-text-fill-color: rgba(255, 255, 255, 0.35);
            color: rgba(255, 255, 255, 0.35);
            text-shadow: none;
        }



        /* Theme-specific star colors */
        .theme-mechaber .player-rating-stars .player-rating-star {
            background: linear-gradient(90deg, var(--color-mechaber) 0%, var(--color-mechaber-dark) 100%);
            background-size: 500% 100%;
            -webkit-background-clip: text;
            background-clip: text;
        }

        .theme-chatzer .player-rating-stars .player-rating-star {
            background: linear-gradient(90deg, var(--color-chatzer) 0%, var(--color-chatzer-dark) 100%);
            background-size: 500% 100%;
            -webkit-background-clip: text;
            background-clip: text;
        }

        .theme-nigun .player-rating-stars .player-rating-star {
            background: linear-gradient(90deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%);
            background-size: 500% 100%;
            -webkit-background-clip: text;
            background-clip: text;
        }

        .theme-verter .player-rating-stars .player-rating-star {
            background: linear-gradient(90deg, var(--color-verter) 0%, var(--color-verter-dark) 100%);
            background-size: 500% 100%;
            -webkit-background-clip: text;
            background-clip: text;
        }

        .theme-zman .player-rating-stars .player-rating-star {
            background: linear-gradient(90deg, var(--color-zman) 0%, var(--color-zman-dark) 100%);
            background-size: 500% 100%;
            -webkit-background-clip: text;
            background-clip: text;
        }

        /* Saving state */
        .player-rating.saving {
            pointer-events: none;
            opacity: 0.6;
        }

        .player-rating.saving .player-rating-stars {
            animation: ratingPulse 1s ease-in-out infinite;
        }

        @keyframes ratingPulse {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }

        /* Rating container for stars + description */
        .player-rating-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
        }

        /* Rating description text under stars */
        .player-rating-description {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 600;
            white-space: nowrap;
            line-height: 1.2;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .player-rating:hover .player-rating-description {
            opacity: 1;
        }

        /* ======== RATING INVITE SYSTEM ======== */

        /* Stars glow when inviting to rate — smooth calling wave */
        .player-rating.rating-invite .player-rating-stars .player-rating-star {
            animation: starInviteGlow 5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        .player-rating.rating-invite .player-rating-stars .player-rating-star:nth-child(1) {
            animation-delay: 0s;
        }

        .player-rating.rating-invite .player-rating-stars .player-rating-star:nth-child(2) {
            animation-delay: 0.12s;
        }

        .player-rating.rating-invite .player-rating-stars .player-rating-star:nth-child(3) {
            animation-delay: 0.24s;
        }

        .player-rating.rating-invite .player-rating-stars .player-rating-star:nth-child(4) {
            animation-delay: 0.36s;
        }

        .player-rating.rating-invite .player-rating-stars .player-rating-star:nth-child(5) {
            animation-delay: 0.48s;
        }

        @keyframes starInviteGlow {

            0%,
            24%,
            100% {
                transform: scale(1) translateY(0);
                -webkit-text-fill-color: inherit;
                text-shadow: none;
                filter: none;
            }

            6% {
                transform: scale(1.15) translateY(-1px);
                -webkit-text-fill-color: rgba(255, 255, 255, 0.85);
                text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
                filter: none;
            }

            12% {
                transform: scale(1.35) translateY(-3px);
                -webkit-text-fill-color: white;
                text-shadow: 0 0 14px rgba(255, 255, 255, 0.9), 0 0 28px rgba(255, 255, 255, 0.4), 0 2px 8px rgba(255, 255, 255, 0.3);
                filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.5));
            }

            18% {
                transform: scale(1.15) translateY(-1px);
                -webkit-text-fill-color: rgba(255, 255, 255, 0.85);
                text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
                filter: none;
            }
        }

        /* Disable hover effects during invite mode */
        .player-rating.rating-invite .player-rating-stars .player-rating-star.hover-preview,
        .player-rating.rating-invite .player-rating-stars:hover .player-rating-star.hover-preview {
            -webkit-text-fill-color: inherit !important;
            color: inherit !important;
            text-shadow: inherit !important;
        }

        .player-rating.rating-invite .player-rating-stars:hover .player-rating-star:not(.hover-preview) {
            -webkit-text-fill-color: inherit !important;
            color: inherit !important;
            text-shadow: inherit !important;
        }

        .player-rating.rating-invite:hover .player-rating-stars {
            filter: none !important;
        }

        /* Rating popup card */
        .rating-popup {
            position: fixed;
            background: white;
            border-radius: 14px;
            padding: 14px 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35), 0 0 0 1px rgba(0, 0, 0, 0.05);
            z-index: 999999;
            min-width: 240px;
            max-width: 300px;
            animation: popupSlideIn 0.25s ease-out;
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes popupSlideOut {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            to {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
        }

        .rating-popup-header {
            font-size: 0.8em;
            font-weight: 700;
            color: var(--text-dark);
            text-align: center;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .rating-popup-options {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .rating-popup-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border: 1.5px solid #e8e8e8;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: white;
        }

        .rating-popup-option:hover {
            border-color: var(--color-nigun);
            background: linear-gradient(135deg, rgba(74, 124, 201, 0.06) 0%, rgba(150, 95, 160, 0.06) 100%);
            transform: translateX(-2px);
        }

        .rating-popup-option:active {
            transform: scale(0.97);
        }

        .rating-popup-option-stars {
            display: flex;
            gap: 1px;
            font-size: 0.9em;
            direction: ltr;
        }

        .rating-popup-option-stars .star {
            background: linear-gradient(90deg, #e91e6c 0%, #9b4cba 35%, #6a5acd 65%, #4a7cc9 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .rating-popup-option-stars .star.empty {
            background: none;
            -webkit-text-fill-color: #ddd;
            color: #ddd;
        }

        .rating-popup-option-text {
            flex: 1;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.78em;
        }

        /* Backdrop for popup */
        .rating-popup-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 999998;
        }

        /* Thank You Notification */
        .thank-you-notification {
            position: fixed;
            bottom: 90px;
            right: 30px;
            transform: translateY(40px);
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            z-index: 15000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border: 2px solid var(--color-nigun);
        }

        .thank-you-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .thank-you-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .thank-you-icon {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-chatzer) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            flex-shrink: 0;
        }

        .thank-you-text {
            font-size: 1em;
            font-weight: 700;
            color: var(--text-dark);
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .thank-you-notification {
                bottom: 80px;
                right: 10px;
                padding: 10px 16px;
            }

            .thank-you-content {
                gap: 8px;
            }

            .thank-you-icon {
                width: 26px;
                height: 26px;
                font-size: 1em;
            }

            .thank-you-text {
                font-size: 0.9em;
            }
        }

        /* Images section */
        .nigun-images-section {
            clear: both;
            margin-bottom: 20px;
        }

        .nigun-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .nigun-image-item {
            background: var(--bg-light);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 1px solid var(--border-color);
        }

        .nigun-image-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .nigun-image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .nigun-image-name {
            padding: 10px;
            font-size: 0.8em;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: white;
        }

        .nigun-image-details {
            padding: 5px 10px 10px;
            font-size: 0.75em;
            color: var(--text-secondary);
            background: white;
            border-top: 1px solid var(--border-color);
        }

        /* PDFs section */
        .nigun-pdfs-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nigun-pdf-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-light);
            border-radius: 10px;
            text-decoration: none;
            color: var(--text-dark);
            transition: var(--transition-smooth);
        }

        .nigun-pdf-item:hover {
            background: var(--color-document-pale);
        }

        .nigun-pdf-icon {
            font-size: 1.5em;
        }

        .nigun-pdf-name {
            flex: 1;
            font-size: 0.95em;
        }

        .nigun-pdf-action {
            background: var(--color-document);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        /* Other Media section (6th attachment) */
        .nigun-other-media-section {
            margin-bottom: 20px;
        }

        .nigun-other-media-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .nigun-other-media-text {
            line-height: 1.7;
            white-space: pre-wrap;
            color: var(--text-dark);
            background: var(--bg-light);
            padding: 15px;
            border-radius: 10px;
        }

        .nigun-other-media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Video items */
        .nigun-video-item {
            background: var(--bg-light);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .nigun-video-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .nigun-video-item video {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .nigun-video-play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .nigun-video-item:hover .nigun-video-play-overlay {
            opacity: 0;
        }

        .nigun-video-play-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: var(--primary);
        }

        .nigun-video-name {
            padding: 10px;
            font-size: 0.8em;
            color: var(--text-muted);
            background: white;
            text-align: center;
        }

        /* PDF preview box */
        .nigun-pdf-preview {
            background: var(--bg-light);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .nigun-pdf-preview:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .nigun-pdf-preview-box {
            height: 120px;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--color-document);
        }

        .nigun-pdf-preview-icon {
            font-size: 3em;
            margin-bottom: 5px;
        }

        .nigun-pdf-preview-label {
            font-size: 0.8em;
            font-weight: 600;
        }

        .nigun-pdf-preview-name {
            padding: 10px;
            font-size: 0.8em;
            color: var(--text-muted);
            background: white;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* File download items */
        .nigun-files-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nigun-file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: var(--bg-light);
            border-radius: 10px;
            text-decoration: none;
            color: var(--text-dark);
            transition: var(--transition-smooth);
            border: 1px solid var(--border-color);
        }

        .nigun-file-item:hover {
            background: var(--primary-pale);
            border-color: var(--primary-light);
        }

        .nigun-file-icon {
            font-size: 1.3em;
        }

        .nigun-file-name {
            flex: 1;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nigun-file-download {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        /* Video modal/fullscreen */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px 20px 150px 20px;
        }

        .video-modal.active {
            display: flex;
        }

        .video-modal video {
            max-width: 90%;
            max-height: 90%;
        }

        .video-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Image modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px 20px 150px 20px;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--primary-pale);
            border-radius: 25px;
            color: var(--primary);
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: inherit;
            /* Position at top-right corner, overlapping the header */
            position: absolute;
            top: 30px;
            right: 30px;
            z-index: 10;
            margin-bottom: 0;
        }

        .back-button:hover {
            background: var(--primary-pale);
            border-color: var(--primary);
        }

        /* Theme-specific back button styles */
        .theme-mechaber .back-button {
            color: var(--color-mechaber);
            border-color: var(--color-mechaber-pale);
        }

        .theme-mechaber .back-button:hover {
            background: var(--color-mechaber-pale);
            border-color: var(--color-mechaber);
        }

        .theme-nigun .back-button {
            color: var(--color-nigun);
            border-color: var(--color-nigun-pale);
        }

        .theme-nigun .back-button:hover {
            background: var(--color-nigun-pale);
            border-color: var(--color-nigun);
        }

        .theme-chatzer .back-button {
            color: var(--color-chatzer);
            border-color: var(--color-chatzer-pale);
        }

        .theme-chatzer .back-button:hover {
            background: var(--color-chatzer-pale);
            border-color: var(--color-chatzer);
        }

        .theme-verter .back-button {
            color: var(--color-verter);
            border-color: var(--color-verter-pale);
        }

        .theme-verter .back-button:hover {
            background: var(--color-verter-pale);
            border-color: var(--color-verter);
        }

        .theme-zman .back-button {
            color: var(--color-zman);
            border-color: var(--color-zman-pale);
        }

        .theme-zman .back-button:hover {
            background: var(--color-zman-pale);
            border-color: var(--color-zman);
        }

        .theme-piyut .back-button {
            color: var(--color-piyut);
            border-color: var(--color-piyut-pale);
        }

        .theme-piyut .back-button:hover {
            background: var(--color-piyut-pale);
            border-color: var(--color-piyut);
        }

        .theme-collection .back-button {
            color: var(--color-collection);
            border-color: var(--color-collection-pale);
        }

        .theme-collection .back-button:hover {
            background: var(--color-collection-pale);
            border-color: var(--color-collection);
        }

        .theme-album .back-button {
            color: var(--color-album);
            border-color: var(--color-album-pale);
        }

        .theme-album .back-button:hover {
            background: var(--color-album-pale);
            border-color: var(--color-album);
        }

        .theme-document .back-button {
            color: var(--color-document);
            border-color: var(--color-document-pale);
        }

        .theme-document .back-button:hover {
            background: var(--color-document-pale);
            border-color: var(--color-document);
        }

        .theme-resource .back-button {
            color: var(--color-resource);
            border-color: var(--color-resource-pale);
        }

        .theme-resource .back-button:hover {
            background: var(--color-resource-pale);
            border-color: var(--color-resource);
        }

        .theme-nigun .back-button {
            color: var(--color-nigun);
            border-color: var(--color-nigun-pale);
        }

        .theme-nigun .back-button:hover {
            background: var(--color-nigun-pale);
            border-color: var(--color-nigun);
        }

        .detail-header {
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            z-index: 100;
            margin-bottom: 40px;
            background: white;
            /* Ensure it has a background when sticky */
        }

        .detail-page {
            position: relative;
        }

        .detail-category-bar {
            display: none;
            /* Hide category bar on full page */
        }

        .detail-header-content {
            position: relative;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-deep) 100%);
            padding: 30px 25px;
            text-align: center;
            border-radius: 0 0 20px 20px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-header-content.no-image {
            justify-content: center;
            text-align: center;
        }

        /* Left container for profile image and dates - like modal hero left */
        .detail-header-left {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        /* Profile image for full page */
        .detail-header-left .detail-image,
        .detail-header-left .detail-image-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
            border: 4px solid white;
            overflow: hidden;
            object-fit: cover;
        }

        /* Life dates under image */
        .detail-header-left .detail-life-dates {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            white-space: nowrap;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .detail-header-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
            width: 100%;
        }

        .detail-header-content.no-image .detail-header-text {
            align-items: center;
        }

        /* Mechaber-specific: add padding for image clearance on full page */
        .detail-page.theme-mechaber .detail-header-text {
            padding: 0 100px;
            align-items: center;
            text-align: center;
        }

        .detail-title {
            font-size: 2em;
            font-weight: 700;
            font-family: 'Heebo', sans-serif;
            color: white;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            line-height: 1.3;
        }

        /* Category-themed detail pages */
        .detail-page.theme-chatzer .detail-category-bar {
            background: var(--color-chatzer);
        }

        .detail-page.theme-chatzer .detail-header-content {
            background: linear-gradient(135deg, var(--color-chatzer) 0%, var(--color-chatzer-dark) 100%);
        }

        .detail-page.theme-mechaber .detail-category-bar {
            background: var(--color-mechaber);
        }

        .detail-page.theme-mechaber .detail-header-content {
            background: linear-gradient(135deg, var(--color-mechaber) 0%, var(--color-mechaber-dark) 100%);
        }

        /* Mechaber formal name on profile (small, lighter) */
        .mechaber-formal {
            display: block;
            font-size: 0.55em;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 6px;
        }

        /* Mechaber known name on profile (big, darker) */
        .mechaber-known {
            display: block;
            font-size: 1em;
            font-weight: 700;
            color: white;
        }

        .detail-page.theme-verter .detail-category-bar {
            background: var(--color-verter);
        }

        .detail-page.theme-verter .detail-header-content {
            background: linear-gradient(135deg, var(--color-verter) 0%, var(--color-verter-dark) 100%);
        }

        .detail-page.theme-zman .detail-category-bar {
            background: var(--color-zman);
        }

        .detail-page.theme-zman .detail-header-content {
            background: linear-gradient(135deg, var(--color-zman) 0%, var(--color-zman-dark) 100%);
        }

        .detail-page.theme-piyut .detail-category-bar {
            background: #2e8b2e;
        }

        .detail-page.theme-piyut .detail-header-content {
            background: linear-gradient(135deg, #2e8b2e 0%, #1b5e20 100%);
        }

        .detail-page.theme-collection .detail-category-bar {
            background: var(--color-collection);
        }

        .detail-page.theme-collection .detail-header-content {
            background: linear-gradient(135deg, var(--color-collection) 0%, var(--color-collection-dark) 100%);
        }

        /* Full-width detail page theme backgrounds */
        .detail-page.theme-chatzer,
        .detail-page.theme-mechaber,
        .detail-page.theme-verter,
        .detail-page.theme-zman,
        .detail-page.theme-piyut,
        .detail-page.theme-collection {
            position: relative;
            margin-left: calc(-50vw + 50%);
            margin-right: calc(-50vw + 50%);
            padding-left: calc(50vw - 50%);
            padding-right: calc(50vw - 50%);
            min-height: calc(100vh - 180px);
        }

        .detail-page.theme-chatzer {
            background: linear-gradient(180deg, var(--color-chatzer-pale) 0%, color-mix(in srgb, var(--color-chatzer-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .detail-page.theme-mechaber {
            --theme-bg: var(--color-mechaber-pale);
            background: linear-gradient(180deg, var(--color-mechaber-pale) 0%, color-mix(in srgb, var(--color-mechaber-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .detail-page.theme-verter {
            background: linear-gradient(180deg, var(--color-verter-pale) 0%, color-mix(in srgb, var(--color-verter-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .detail-page.theme-zman {
            background: linear-gradient(180deg, var(--color-zman-pale) 0%, color-mix(in srgb, var(--color-zman-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .detail-page.theme-piyut {
            background: linear-gradient(180deg, #e8f5e9 0%, color-mix(in srgb, #e8f5e9 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        .detail-page.theme-collection {
            background: linear-gradient(180deg, var(--color-collection-pale) 0%, color-mix(in srgb, var(--color-collection-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
        }

        /* Center content within full-width themed detail pages */
        .detail-page.theme-chatzer>*,
        .detail-page.theme-mechaber>*,
        .detail-page.theme-verter>*,
        .detail-page.theme-zman>*,
        .detail-page.theme-piyut>*,
        .detail-page.theme-collection>* {
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Detail page sections and actions */
        .detail-section {
            background: white;
            border-radius: 15px;
            padding: 20px 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .detail-section h3 {
            margin: 0 0 15px 0;
            color: var(--primary);
            font-size: 1.05em;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .detail-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .detail-action-btn {
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .detail-action-btn.album-booklet-btn,
        .detail-action-btn.album-buy-btn {
            background: var(--color-album);
            color: white;
        }

        .detail-action-btn.album-booklet-btn:hover,
        .detail-action-btn.album-buy-btn:hover {
            background: var(--color-album-dark);
        }

        .detail-action-btn.document-pdf-btn {
            background: var(--color-document);
            color: white;
        }

        .detail-action-btn.document-pdf-btn:hover {
            background: var(--color-document-dark);
        }

        .detail-action-btn.document-link-btn {
            background: var(--color-document-pale);
            color: var(--color-document-dark);
        }

        .detail-action-btn.resource-link-btn {
            background: var(--color-resource);
            color: white;
        }

        .detail-action-btn.resource-link-btn:hover {
            background: var(--color-resource-dark);
        }

        .detail-pdf-preview {
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .detail-songs-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 6px;
            /* Allow shadow to be visible */
            margin: -6px;
            /* Compensate for padding */
        }

        .detail-subtitle {
            font-size: 1.1em;
            color: var(--text-muted);
        }

        .detail-chatzer {
            margin-top: 10px;
        }

        .detail-year {
            font-size: 0.95em;
            color: var(--text-muted);
        }

        .resource-phone-display {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--color-resource-dark);
            background: var(--color-resource-pale);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            white-space: pre-line;
            line-height: 1.8;
        }

        .detail-image {
            width: 120px;
            height: 120px;
            border-radius: 15px;
            object-fit: cover;
            border: 4px solid var(--primary-pale);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            flex-shrink: 0;
        }

        /* Round images for mechabrim */
        .mechaber-detail .detail-image,
        .detail-page[data-type="mechabrim"] .detail-image {
            border-radius: 50%;
        }

        /* Placeholder for mechabrim without images */
        .detail-image-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--color-mechaber-pale);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid var(--color-mechaber-pale);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            flex-shrink: 0;
        }

        .detail-image-placeholder .mechaber-icon {
            width: 75px;
            height: 100px;
            background-color: var(--color-mechaber);
            -webkit-mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
            mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
        }

        .detail-icon {
            display: none;
        }

        .detail-type-badge {
            display: inline-block;
            background: var(--gradient-main);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .detail-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 12px;
            justify-content: center;
        }

        .detail-tag-badge {
            margin-bottom: 10px;
        }

        .mechaber-tag-name {
            display: inline-block;
            background: linear-gradient(135deg, var(--color-mechaber) 0%, var(--color-mechaber-light) 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .detail-life-dates {
            margin-top: 8px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
        }

        .detail-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
        }

        .detail-chatzer-badge {
            display: inline-block;
            background: var(--color-chatzer);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            transition: var(--transition-smooth);
        }

        .detail-chatzer-badge:hover {
            background: var(--color-chatzer-dark);
            transform: scale(1.05);
        }

        .detail-zmanim-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .detail-zman-badge {
            background: var(--color-zman);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .detail-zman-badge:hover {
            background: var(--color-zman-dark);
            transform: scale(1.05);
        }

        .detail-subtitle {
            margin-top: 10px;
            font-size: 1em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .detail-makor-text {
            display: inline-block;
            background: white;
            color: #666;
            font-weight: 600;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .detail-mareh-text {
            color: var(--text-dark);
        }

        .detail-zman-text {
            color: var(--primary);
            font-weight: 600;
        }

        .detail-separator {
            color: var(--text-muted);
        }

        .detail-title {
            font-size: 2em;
            color: white;
            font-family: 'Heebo', sans-serif;
            font-weight: 600;
            margin-bottom: 0;
            line-height: 1.3;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .detail-description-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
            padding: 20px 25px 15px 25px;
            background: var(--color-nigun-pale);
            border-radius: 12px;
            margin-bottom: 25px;
            max-width: 700px;
            position: relative;
            border: 1.5px solid var(--color-nigun);
            box-shadow: none;
        }

        .detail-description-section h3 {
            font-size: 0;
            color: transparent;
            width: 36px;
            height: 36px;
            padding: 0;
            background: var(--color-nigun);
            border-radius: 50%;
            margin: -38px 0 10px 0;
            border: 3px solid var(--color-nigun-pale);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: none;
        }

        .detail-description-section h3::before {
            content: "i";
            font-size: 1.2rem;
            font-weight: bold;
            font-style: italic;
            color: white;
        }

        /* Theme-specific description section */
        .theme-mechaber .detail-description-section {
            background: var(--color-mechaber-pale);
            border-color: var(--color-mechaber);
        }

        .theme-mechaber .detail-description-section h3 {
            background: var(--color-mechaber);
            border-color: var(--color-mechaber-pale);
        }

        .theme-mechaber .detail-description-section .description-fade-overlay {
            background: linear-gradient(to bottom, transparent, var(--color-mechaber-pale));
        }

        .theme-chatzer .detail-description-section {
            background: var(--color-chatzer-pale);
            border-color: var(--color-chatzer);
        }

        .theme-chatzer .detail-description-section h3 {
            background: var(--color-chatzer);
            border-color: var(--color-chatzer-pale);
        }

        .theme-chatzer .detail-description-section .description-fade-overlay {
            background: linear-gradient(to bottom, transparent, var(--color-chatzer-pale));
        }

        .theme-verter .detail-description-section {
            background: var(--color-verter-pale);
            border-color: var(--color-verter);
        }

        .theme-verter .detail-description-section h3 {
            background: var(--color-verter);
            border-color: var(--color-verter-pale);
        }

        .theme-verter .detail-description-section .description-fade-overlay {
            background: linear-gradient(to bottom, transparent, var(--color-verter-pale));
        }

        .theme-zman .detail-description-section {
            background: var(--color-zman-pale);
            border-color: var(--color-zman);
        }

        .theme-zman .detail-description-section h3 {
            background: var(--color-zman);
            border-color: var(--color-zman-pale);
        }

        .theme-zman .detail-description-section .description-fade-overlay {
            background: linear-gradient(to bottom, transparent, var(--color-zman-pale));
        }

        .theme-nigun .detail-description-section {
            background: var(--color-nigun-pale);
            border-color: var(--color-nigun);
        }

        .theme-nigun .detail-description-section h3 {
            background: var(--color-nigun);
            border-color: var(--color-nigun-pale);
        }

        .theme-nigun .detail-description-section .description-fade-overlay {
            background: linear-gradient(to bottom, transparent, var(--color-nigun-pale));
        }


        .detail-description-content {
            font-size: 1em;
            color: var(--text-dark);
            line-height: 1.8;
        }

        .detail-description-content h4 {
            color: var(--primary-deep);
            font-size: 1.1em;
            margin: 20px 0 10px 0;
        }

        .detail-description-content a {
            color: var(--primary);
            text-decoration: underline;
        }

        .detail-description-content strong {
            color: var(--primary-deep);
        }

        .detail-info-section {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
        }

        .detail-info-section h3 {
            color: var(--primary);
            font-size: 1.2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .detail-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-info-item {
            background: #f8fafc;
            padding: 12px 15px;
            border-radius: 10px;
            border-right: 3px solid var(--primary);
        }

        .detail-info-label {
            display: block;
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .detail-info-value {
            display: block;
            font-size: 1em;
            color: var(--text-dark);
            font-weight: 600;
        }

        /* Collapsible Description Section */
        .collapsible-section {
            position: relative;
        }

        .detail-description-wrapper {
            position: relative;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }

        .detail-description-wrapper.collapsed {
            max-height: 120px;
        }

        .detail-description-wrapper.expanded {
            max-height: 2000px;
        }

        .description-fade-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to bottom, transparent, var(--theme-bg, #fce4ec));
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .detail-description-wrapper.expanded .description-fade-overlay {
            opacity: 0;
        }

        .description-expand-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 4px;
            margin-top: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .description-expand-btn:hover {
            background: rgba(var(--primary-rgb), 0.05);
            border-radius: 8px;
        }

        .expand-arrow {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-right: 3px solid currentColor;
            border-bottom: 3px solid currentColor;
            transform: rotate(45deg);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            margin-bottom: 5px;
        }

        .description-expand-btn.expanded .expand-arrow {
            transform: rotate(-135deg);
            margin-bottom: -5px;
        }

        .detail-songs-section {
            background: transparent;
            padding: 25px;
            border-radius: 20px;
        }

        /* Collapsible songs list */
        .detail-songs-section.collapsible-songs {
            position: relative;
        }

        .songs-section-container {
            position: relative;
        }

        .songs-list-wrapper {
            position: relative;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            /* Padding to prevent hover effects from being clipped */
            padding: 12px 12px 0 12px;
            margin: -12px -12px 0 -12px;
        }

        .songs-list-wrapper.collapsed {
            max-height: 350px;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-mask-image: linear-gradient(to bottom, black 0%, black 60%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 0%, black 60%, transparent 100%);
        }

        .songs-list-wrapper.expanded {
            max-height: 10000px;
            transition: max-height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .songs-fade-overlay {
            display: none;
            /* Now using mask-image on wrapper instead */
        }

        /* All themes fade to white since that's the page background */
        .theme-mechaber .songs-fade-overlay,
        .theme-chatzer .songs-fade-overlay,
        .theme-nigun .songs-fade-overlay {
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 1) 40%, #fff 100%);
        }


        .songs-list-wrapper.expanded .songs-fade-overlay {
            opacity: 0;
            pointer-events: none;
        }

        .songs-expand-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--color-nigun);
            font-size: 2rem;
            transition: all 0.3s ease;
            margin-top: -60px;
            position: relative;
            z-index: 10;
        }

        .songs-expand-btn:hover {
            color: var(--color-nigun-dark);
            transform: scale(1.1);
        }

        .songs-expand-btn .expand-arrow {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-right: 3px solid currentColor;
            border-bottom: 3px solid currentColor;
            transform: rotate(45deg);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            margin-bottom: 6px;
        }

        .songs-expand-btn.expanded .expand-arrow {
            transform: rotate(-135deg);
            margin-bottom: -6px;
        }

        /* Theme-specific expand buttons */
        .theme-mechaber .songs-expand-btn {
            color: var(--color-mechaber);
        }

        .theme-mechaber .songs-expand-btn:hover {
            color: var(--color-mechaber-dark);
        }

        .theme-chatzer .songs-expand-btn {
            color: var(--color-chatzer);
        }

        .theme-chatzer .songs-expand-btn:hover {
            color: var(--color-chatzer-dark);
        }

        .theme-verter .songs-expand-btn {
            color: var(--color-verter);
        }

        .theme-verter .songs-expand-btn:hover {
            color: var(--color-verter-dark);
        }

        .theme-zman .songs-expand-btn {
            color: var(--color-zman);
        }

        .theme-zman .songs-expand-btn:hover {
            color: var(--color-zman-dark);
        }


        .detail-songs-section.detail-related-songs {
            margin-top: 25px;
            background: transparent;
        }

        .detail-songs-section.detail-related-recordings {
            margin-top: 25px;
        }

        .detail-songs-section.detail-related-songs h3,
        .detail-songs-section.detail-related-recordings h3 {
            color: var(--color-mechaber-dark);
        }

        .detail-mechabrim-section {
            background: transparent;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
        }

        .detail-mechabrim-section h3 {
            color: var(--primary);
            font-size: 1.2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .detail-mechabrim-box {
            background: transparent;
            border-radius: 16px;
            padding: 20px;
        }

        .detail-mechabrim-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            gap: 20px;
            padding: 10px 0;
            color: var(--color-chatzer-dark);
            font-size: 1.4em;
            font-weight: 700;
            white-space: nowrap;
        }

        .detail-mechabrim-header::before {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, var(--color-chatzer), transparent);
        }

        .detail-mechabrim-header::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--color-chatzer));
        }

        .mechabrim-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }

        .mechaber-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 2px solid transparent;
            position: relative;
            /* For pseudo-element */
        }

        /* Hover effect for Profile Mechaber Card */
        .mechaber-card::after {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border-radius: 12px;
            border: 2px solid var(--color-mechaber);
            /* Or primary if generic */
            opacity: 0;
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        /* Note: Mechabrim section uses primary usually, but let's check context. 
           It seems to be in a general list. I'll use primary for safety if not set, or mechaber color if strictly mechaber.
           Line 5420 used border-color: var(--primary). I'll stick to primary or allow theme override. */

        .mechaber-card::after {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(123, 31, 162, 0.15);
        }

        .mechaber-card:hover::after {
            opacity: 1;
            transform: scale(1);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .mechaber-card:hover {
            /* border-color handled by ::after */
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .mechaber-card-image {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 3px solid var(--primary-pale);
        }

        .mechaber-card-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--primary-pale);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            margin: 0 auto 10px auto;
        }

        .mechaber-card-name {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--primary-deep);
            line-height: 1.3;
        }

        .detail-verter-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
            padding: 20px 20px 15px 20px;
            background: var(--color-verter-pale);
            border-radius: 12px;
            margin: 20px auto 25px auto;
            max-width: 600px;
            border: 1.5px solid var(--color-verter-dark);
            position: relative;
        }

        .detail-verter-section h3 {
            display: none;
            /* Hide the old header - we use icon instead */
        }

        /* Text icon floating on top of verter box */
        .verter-box-icon {
            color: var(--color-verter);
            font-size: 1em;
            font-weight: bold;
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-verter-light, #e8f5e9);
            border-radius: 50%;
            font-style: normal;
            margin-top: -29px;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .verter-box-icon svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .verter-content {
            font-size: 0.95em;
            color: var(--color-verter-dark);
            line-height: 1.7;
            text-align: right;
            width: 100%;
            font-family: 'Heebo', sans-serif;
        }

        .verter-line {
            font-size: 1.05em;
            line-height: 1.8;
            color: var(--color-verter-dark);
            font-family: 'Heebo', sans-serif;
        }

        .verter-line.verter-empty {
            height: 12px;
        }

        /* Collapsible verter wrapper */
        .verter-wrapper {
            position: relative;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }

        .verter-wrapper.collapsed {
            max-height: 100px;
        }

        .verter-wrapper.expanded {
            max-height: 2000px;
        }

        .verter-fade-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to bottom, transparent, var(--color-verter-pale));
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .verter-wrapper.expanded .verter-fade-overlay {
            opacity: 0;
        }

        .verter-expand-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 4px;
            margin-top: 5px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--color-verter-dark);
            font-size: 0.9rem;
            transition: all 0.3s ease;
            font-family: 'Heebo', sans-serif;
        }

        .verter-expand-btn:hover {
            background: rgba(0, 100, 0, 0.05);
            border-radius: 8px;
        }

        .verter-expand-btn .expand-arrow {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-right: 3px solid currentColor;
            border-bottom: 3px solid currentColor;
            transform: rotate(45deg);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            margin-bottom: 5px;
        }

        .verter-expand-btn.expanded .expand-arrow {
            transform: rotate(-135deg);
            margin-bottom: -5px;
        }

        .detail-songs-section h3 {
            color: var(--primary);
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: 25px;
            padding-bottom: 0;
            border-bottom: none;
        }

        /* Background colors for different section types - now transparent */
        .detail-songs-section {
            background: transparent;
        }

        /* Mechaber modal: first songs list - now transparent */
        .theme-mechaber .detail-songs-section:not(.detail-related-songs):not(.detail-related-recordings) {
            background: transparent;
        }

        .detail-songs-section.detail-related-songs {
            background: transparent;
        }

        .detail-songs-section.detail-related-recordings {
            background: transparent;
        }

        /* Detail Section Header with Filters - Modern centered text with lines */
        .detail-section-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            gap: 20px;
            padding: 10px 0;
        }

        .detail-section-header::before {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, var(--color-nigun), transparent);
        }

        .detail-section-header::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--color-nigun));
        }

        .detail-section-header h3 {
            margin: 0;
            color: var(--color-nigun-dark);
            font-size: 1.4em;
            font-weight: 700;
            white-space: nowrap;
            padding: 0 10px;
        }

        /* Theme-specific section headers */
        .theme-mechaber .detail-section-header::before {
            background: linear-gradient(90deg, var(--color-mechaber), transparent);
        }

        .theme-mechaber .detail-section-header::after {
            background: linear-gradient(90deg, transparent, var(--color-mechaber));
        }

        .theme-mechaber .detail-section-header h3 {
            color: var(--color-mechaber-dark);
        }

        .theme-chatzer .detail-section-header::before {
            background: linear-gradient(90deg, var(--color-chatzer), transparent);
        }

        .theme-chatzer .detail-section-header::after {
            background: linear-gradient(90deg, transparent, var(--color-chatzer));
        }

        .theme-chatzer .detail-section-header h3 {
            color: var(--color-chatzer-dark);
        }

        .theme-verter .detail-section-header::before {
            background: linear-gradient(90deg, var(--color-verter), transparent);
        }

        .theme-verter .detail-section-header::after {
            background: linear-gradient(90deg, transparent, var(--color-verter));
        }

        .theme-verter .detail-section-header h3 {
            color: var(--color-verter-dark);
        }

        .theme-zman .detail-section-header::before {
            background: linear-gradient(90deg, var(--color-zman), transparent);
        }

        .theme-zman .detail-section-header::after {
            background: linear-gradient(90deg, transparent, var(--color-zman));
        }

        .theme-zman .detail-section-header h3 {
            color: var(--color-zman-dark);
        }

        .theme-piyut .detail-section-header::before {
            background: linear-gradient(90deg, var(--color-piyut), transparent);
        }

        .theme-piyut .detail-section-header::after {
            background: linear-gradient(90deg, transparent, var(--color-piyut));
        }

        .theme-piyut .detail-section-header h3 {
            color: var(--color-piyut-dark);
        }

        .theme-collection .detail-section-header::before {
            background: linear-gradient(90deg, var(--color-collection), transparent);
        }

        .theme-collection .detail-section-header::after {
            background: linear-gradient(90deg, transparent, var(--color-collection));
        }

        .theme-collection .detail-section-header h3 {
            color: var(--color-collection-dark);
        }

        .theme-album .detail-section-header::before {
            background: linear-gradient(90deg, var(--color-album), transparent);
        }

        .theme-album .detail-section-header::after {
            background: linear-gradient(90deg, transparent, var(--color-album));
        }

        .theme-album .detail-section-header h3 {
            color: var(--color-album-dark);
        }

        .theme-document .detail-section-header::before {
            background: linear-gradient(90deg, var(--color-document), transparent);
        }

        .theme-document .detail-section-header::after {
            background: linear-gradient(90deg, transparent, var(--color-document));
        }

        .theme-document .detail-section-header h3 {
            color: var(--color-document-dark);
        }

        .theme-resource .detail-section-header::before {
            background: linear-gradient(90deg, var(--color-resource), transparent);
        }

        .theme-resource .detail-section-header::after {
            background: linear-gradient(90deg, transparent, var(--color-resource));
        }

        .theme-resource .detail-section-header h3 {
            color: var(--color-resource-dark);
        }

        .theme-nigun .detail-section-header::before {
            background: linear-gradient(90deg, var(--color-nigun), transparent);
        }

        .theme-nigun .detail-section-header::after {
            background: linear-gradient(90deg, transparent, var(--color-nigun));
        }

        .theme-nigun .detail-section-header h3 {
            color: var(--color-nigun-dark);
        }

        /* Filters Group Container */
        .detail-filters-group {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        /* Individual Filter Dropdown */
        .detail-filter-dropdown {
            position: relative;
        }

        .detail-filter-current {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 10px;
            background: var(--color-nigun-pale);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 0.8em;
            font-weight: 500;
            color: var(--color-nigun-dark);
            white-space: nowrap;
            min-width: 90px;
            justify-content: center;
        }

        .detail-filter-current:hover {
            background: var(--color-nigun);
            color: white;
        }

        .detail-filter-current .filter-icon {
            font-size: 1em;
            line-height: 1;
        }

        .detail-filter-current .filter-label {
            font-size: 0.95em;
        }

        .detail-filter-options {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 6px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 4px;
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .detail-filter-dropdown:hover .detail-filter-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .detail-filter-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: var(--transition-smooth);
            font-size: 0.85em;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .detail-filter-option:hover {
            background: var(--color-nigun-pale);
            color: var(--color-nigun-dark);
        }

        .detail-filter-option.active {
            background: var(--color-nigun);
            color: white;
            font-weight: 600;
        }

        /* Quality Filter Spread Layout */
        .quality-filter-spread {
            justify-content: space-between;
            min-width: 120px;
            gap: 12px;
        }

        .filter-label-left {
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }

        .audio-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
        }

        .filter-stars-right {
            font-size: 1em;
            color: var(--color-nigun);
            font-weight: normal;
            letter-spacing: 1px;
        }

        .detail-filter-current.quality-filter-spread:hover .filter-stars-right {
            color: white;
        }

        /* Filter Panel Button and Dropdown */
        .filter-panel-dropdown {
            position: relative;
        }

        .filter-panel-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--color-nigun-pale);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 0.8em;
            font-weight: 500;
            color: var(--color-nigun-dark);
            white-space: nowrap;
            border: none;
            font-family: inherit;
            min-width: 90px;
            justify-content: center;
        }

        .filter-panel-btn:hover {
            background: var(--color-nigun);
            color: white;
        }

        .filter-panel-btn.has-active {
            background: var(--color-nigun);
            color: white;
        }

        .filter-panel-btn .filter-btn-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .filter-panel-btn:hover .filter-btn-icon,
        .filter-panel-btn.has-active .filter-btn-icon {
            stroke: white;
        }

        .filter-panel-btn .filter-icon {
            font-size: 1.1em;
        }

        .filter-panel-btn .filter-count {
            background: white;
            color: var(--color-nigun);
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 2px;
        }

        .filter-panel-content {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(74, 124, 201, 0.25);
            padding: 16px;
            min-width: 320px;
            max-width: 400px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 200;
            max-height: 70vh;
            overflow-y: auto;
        }

        .filter-panel-content.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* Open filter panel on hover like other dropdowns */
        .filter-panel-dropdown:hover .filter-panel-content {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .search-panel-content {
            min-width: 280px;
            max-width: 320px;
            padding: 12px;
        }

        .search-panel-content .filter-panel-search {
            margin-bottom: 0;
        }

        .search-panel-content .filter-panel-active-tags {
            margin-top: 10px;
            padding-top: 10px;
        }

        .filter-panel-search {
            display: flex;
            position: relative;
            margin-bottom: 12px;
        }

        .filter-panel-search-input {
            flex: 1;
            padding: 10px 14px;
            padding-left: 40px;
            border: 2px solid var(--color-nigun-pale);
            border-radius: 10px;
            font-size: 0.9em;
            font-family: inherit;
            direction: rtl;
            transition: var(--transition-smooth);
        }

        .filter-panel-search-input:focus {
            outline: none;
            border-color: var(--color-nigun);
        }

        .filter-panel-search-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            opacity: 0.6;
            transition: var(--transition-smooth);
        }

        .filter-panel-search-btn:hover {
            opacity: 1;
        }

        .filter-panel-search-clear {
            position: absolute;
            left: 38px;
            top: 50%;
            transform: translateY(-50%);
            background: #999;
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 12px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-panel-search-clear:hover {
            background: #666;
        }

        .filter-panel-section-title {
            font-size: 0.75em;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-panel-filters {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-panel-item {
            position: relative;
        }

        .filter-panel-item-btn {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: #f8fafc;
            border: 1px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            font-size: 0.9em;
        }

        .filter-panel-item-btn:hover {
            background: var(--color-nigun-pale);
            border-color: var(--color-nigun-light);
        }

        .filter-panel-item-btn.active {
            background: var(--color-nigun-pale);
            border-color: var(--color-nigun);
        }

        .filter-panel-item-label {
            font-weight: 500;
            color: var(--text-dark);
        }

        .filter-panel-item-value {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .filter-panel-item-value.has-selection {
            color: var(--color-nigun);
            font-weight: 600;
        }

        .filter-panel-item-options {
            display: none;
            margin-top: 6px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
            max-height: 180px;
            overflow-y: auto;
        }

        .filter-panel-item.open .filter-panel-item-options {
            display: block;
        }

        .filter-panel-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
            border-radius: 6px;
        }

        .filter-panel-option:hover {
            background: var(--color-nigun-pale);
        }

        .filter-panel-option input {
            accent-color: var(--color-nigun);
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .filter-panel-active-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .filter-panel-tag {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--color-nigun-pale);
            border-radius: 20px;
            font-size: 0.8em;
            color: var(--color-nigun-dark);
        }

        .filter-panel-tag-remove {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            line-height: 1;
            color: var(--color-nigun);
            padding: 0;
            margin-right: -2px;
        }

        .filter-panel-tag-remove:hover {
            color: var(--color-nigun-dark);
        }

        /* Filter colors for panel items */
        .filter-panel-item[data-filter="collection"] .filter-panel-item-btn::before {
            background: var(--color-collection);
        }

        .filter-panel-item[data-filter="chatzer"] .filter-panel-item-btn::before {
            background: var(--color-chatzer);
        }

        .filter-panel-item[data-filter="mechaber"] .filter-panel-item-btn::before {
            background: var(--color-mechaber);
        }

        .filter-panel-item[data-filter="verter"] .filter-panel-item-btn::before {
            background: var(--color-verter);
        }

        .filter-panel-item[data-filter="gezungen"] .filter-panel-item-btn::before {
            background: #2e8b2e;
        }

        .filter-panel-item[data-filter="ritem"] .filter-panel-item-btn::before {
            background: var(--color-music);
        }

        .filter-panel-item[data-filter="scale"] .filter-panel-item-btn::before {
            background: var(--color-nigun);
        }

        .filter-panel-item .filter-panel-item-btn::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 0 10px 10px 0;
        }

        /* Responsive adjustments for filters */
        @media (max-width: 768px) {
            .detail-section-header {
                flex-direction: column;
                gap: 12px;
            }

            .detail-filters-group {
                width: 100%;
                justify-content: flex-start;
            }
        }

        .detail-songs-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .detail-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .detail-image,
            .detail-icon {
                width: 120px;
                height: 120px;
            }

            .detail-title {
                font-size: 1.5em;
            }

            .detail-info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Expanded card info (hidden by default) */
        .card-expanded-info {
            display: none;
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-pale) 0%, #fff 100%);
            border-radius: 12px;
            border: 1px solid var(--primary-pale);
        }

        .category-card.expanded .card-expanded-info {
            display: block;
        }

        .card-image-large {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            object-fit: cover;
            float: right;
            margin-left: 15px;
            margin-bottom: 10px;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .card-full-description {
            font-size: 0.95em;
            color: var(--text-dark);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .card-info-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            clear: both;
        }

        .info-tag {
            background: white;
            color: var(--primary);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            border: 1px solid var(--primary-pale);
        }

        .card-songs-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-pale);
        }

        .card-songs-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 1em;
        }

        /* Songs List inside Card */
        .card-songs {
            display: none;
            margin-top: 20px;
            border-top: 1px solid var(--primary-pale);
            padding-top: 15px;
        }

        .category-card.expanded .card-songs {
            display: block;
        }

        .songs-list {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
            /* Padding to prevent hover effects from being clipped */
            padding: 10px;
            margin: -10px;
        }

        .song-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            background: var(--color-nigun-pale);
            border: none;
            box-shadow: 0 2px 8px rgba(74, 124, 201, 0.1);
            transition: all 0.4s ease;
            position: relative;
            overflow: visible;
        }

        /* Border effect using pseudo-element - fade from outside to inside */
        .song-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 10px;
            border: 2px solid var(--color-nigun);
            opacity: 0;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            /* Leave transition: fade out, then reset scale invisibly */
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(74, 124, 201, 0.1);
            z-index: 10;
        }

        .song-item:hover::after {
            opacity: 1;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Enter transition: animate scale and opacity immediately */
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .song-item .song-name,
        .song-item .song-number {
            transition: color 0.3s ease, background 0.3s ease;
        }

        .song-item:hover {
            box-shadow: 0 6px 20px rgba(74, 124, 201, 0.35);
        }

        .song-item.no-audio {
            background: var(--color-nigun-pale);
            opacity: 0.7;
        }

        .song-item.no-audio:hover {
            opacity: 1;
            box-shadow: 0 6px 20px rgba(74, 124, 201, 0.35);
        }

        /* Active song item in minimal mode - dark blue background with fade */
        .song-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-nigun);
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
            z-index: 0;
        }

        .song-item.active::before {
            opacity: 1;
        }

        .song-item.active {
            box-shadow: 0 4px 15px rgba(74, 124, 201, 0.4);
        }

        /* Ensure content is above the overlay */
        .song-item>* {
            position: relative;
            z-index: 1;
        }

        .song-item.active .song-name {
            color: white;
        }

        .song-item.active .song-meta {
            color: rgba(255, 255, 255, 0.9);
        }

        .song-item.active::after {
            opacity: 0 !important;
        }

        .song-number {
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85em;
            color: var(--color-nigun);
            flex-shrink: 0;
        }

        .song-item.active .song-number {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .song-info {
            flex: 1;
            min-width: 0;
        }

        .song-name {
            font-weight: 600;
            font-size: 1.15em;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--color-nigun-dark);
            transition: color 0.4s ease;
        }

        .song-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
            transition: color 0.4s ease;
        }

        .song-meta-link {
            color: var(--text-muted);
            text-decoration: none;
            transition: var(--transition-smooth);
        }

        .song-meta-link:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        .song-item.active .song-meta-link {
            color: rgba(255, 255, 255, 0.8);
        }

        .song-item.active .song-meta-link:hover {
            color: white;
        }

        /* Song meta tags - smaller pill buttons for song list */
        .song-meta-tag {
            padding: 2px 8px !important;
            font-size: 0.75em !important;
            border-radius: 10px !important;
        }

        .song-play-btn {
            width: 35px;
            height: 35px;
            background: var(--gradient-main);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            opacity: 0;
            transition: var(--transition-smooth);
            flex-shrink: 0;
        }

        .song-details-btn {
            padding: 6px 12px;
            background: var(--color-nigun-pale);
            border: 1px solid var(--color-nigun-light);
            border-radius: 8px;
            color: var(--color-nigun-dark);
            font-size: 0.8em;
            cursor: pointer;
            transition: var(--transition-smooth);
            flex-shrink: 0;
            font-family: inherit;
        }

        .song-details-btn:hover {
            background: var(--color-nigun);
            color: white;
            border-color: var(--color-nigun);
        }

        .song-item.active .song-details-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* New Play Button Styling */
        .song-play-btn-new {
            width: 38px;
            height: 38px;
            background: var(--color-nigun);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: visible;
            box-shadow: 0 2px 8px rgba(74, 124, 201, 0.3);
        }

        /* Larger clickable area around play button */
        .song-play-btn-new::before {
            content: '';
            position: absolute;
            top: -18px;
            left: -18px;
            right: -18px;
            bottom: -18px;
            border-radius: 50%;
            cursor: pointer;
        }

        .song-play-btn-new:hover {
            background: var(--color-nigun-dark);
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(74, 124, 201, 0.5);
        }

        .song-play-btn-new .play-icon,
        .song-play-btn-new .pause-icon {
            position: absolute;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .song-play-btn-new .play-icon {
            opacity: 1;
            transform: scale(1);
        }

        .song-play-btn-new .pause-icon {
            opacity: 0;
            transform: scale(0.5);
        }

        .song-play-btn-new.playing .play-icon {
            opacity: 0;
            transform: scale(0.5);
        }

        .song-play-btn-new.playing .pause-icon {
            opacity: 1;
            transform: scale(1);
        }

        /* Play buttons in active song items - NO change, keep normal blue */
        /* (Only the active-recording's button gets white styling) */

        /* Recording play button - smaller version */
        .rec-play-btn {
            width: 32px !important;
            height: 32px !important;
            flex-shrink: 0;
        }

        .rec-play-btn svg {
            width: 12px !important;
            height: 12px !important;
        }

        /* ===== ACTIVE NIGUN & RECORDING COLOR SCHEME =====
         * Color hierarchy (darkest to lightest):
         * 1. Active nigun header: var(--color-nigun-dark) #2d5aa0
         * 2. Active nigun body: var(--color-nigun) #4a7cc9  
         * 3. Recordings container: var(--color-nigun-light) with transparency
         * 4. Active recording: White with blue glow
         */

        /* === ACTIVE RECORDING - Dark blue with white text and fade === */
        .song-item-recording::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-nigun);
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
            z-index: 0;
        }

        .song-item-recording.active-recording::before {
            opacity: 1;
        }

        .song-item-recording.active-recording {
            box-shadow: 0 4px 15px rgba(74, 124, 201, 0.4);
        }

        /* Ensure content is above the overlay */
        .song-item-recording>* {
            position: relative;
            z-index: 1;
        }

        /* Active recording hover - just shadow, no border animation */
        .song-item-recording.active-recording::after {
            display: none;
        }

        .song-item-recording.active-recording:hover {
            box-shadow: 0 6px 20px rgba(74, 124, 201, 0.5);
        }

        .song-item-recording.active-recording .song-item-rec-num {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .song-item-recording.active-recording .song-item-rec-name {
            color: white;
            font-weight: 600;
        }

        .song-item-recording.active-recording .song-item-rec-tags .nigun-tag-inline {
            background: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        .song-item-recording.active-recording .rec-rating-display {
            color: rgba(255, 255, 255, 0.9);
        }

        .song-item-recording.active-recording .rec-play-btn {
            background: rgba(255, 255, 255, 0.25) !important;
            color: white !important;
        }

        .song-item-recording.active-recording .rec-play-btn:hover {
            background: white !important;
            color: var(--color-nigun-dark) !important;
        }

        /* Active song items - NO visual change except for active recording blue style */
        /* (Removed white background overrides - card stays normal when playing) */

        /* Low quality indicator button */
        .song-btn-low-quality {
            background: var(--color-nigun-pale) !important;
            color: var(--color-nigun) !important;
            cursor: default !important;
            opacity: 0.7;
        }

        .song-btn-low-quality:hover {
            background: var(--color-nigun-pale) !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .low-quality-icon {
            font-size: 18px;
            line-height: 1;
            color: var(--color-nigun);
        }

        /* Wave Animation for Playing Song */
        /* Hidden by default, shown only for active song */
        .song-wave-animation {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            height: 16px;
            margin-left: 8px;
            flex-shrink: 0;
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: opacity 0.3s ease, width 0.3s ease, margin 0.3s ease;
        }

        /* Show wave only when song-item is active */
        .song-item.active .song-wave-animation {
            opacity: 1;
            width: 20px;
        }

        .wave-bar {
            width: 3px;
            background: white;
            border-radius: 2px;
            height: 10px;
            transform-origin: center;
            transition: transform 0.3s ease-out;
        }

        /* Default state (loading/paused) - all bars at minimum height */
        .song-item.active .wave-bar {
            transform: scaleY(0.4);
        }

        /* Animated state - bars wave when playing (not paused) */
        .song-item.active:not(.paused) .wave-bar {
            animation: waveStream 0.8s ease-in-out infinite;
        }

        .song-item.active:not(.paused) .wave-bar:nth-child(1) {
            animation-delay: 0s;
        }

        .song-item.active:not(.paused) .wave-bar:nth-child(2) {
            animation-delay: 0.2s;
        }

        .song-item.active:not(.paused) .wave-bar:nth-child(3) {
            animation-delay: 0.1s;
        }

        .song-item.active:not(.paused) .wave-bar:nth-child(4) {
            animation-delay: 0.3s;
        }

        @keyframes waveStream {

            0%,
            100% {
                transform: scaleY(0.5);
            }

            50% {
                transform: scaleY(1.5);
            }
        }

        /* Fade to minimum keyframes */
        @keyframes fadeToMin {
            to {
                transform: scaleY(0.4);
            }
        }

        /* Paused state - smoothly fade to minimum height */
        .song-item.active.paused .wave-bar {
            animation: fadeToMin 0.3s ease-out forwards;
        }

        /* Player wave animation (bottom player) */
        .player-wave-animation {
            display: none;
            align-items: center;
            gap: 2px;
            height: 16px;
            margin-right: 12px;
        }

        /* Show player wave when audio is loaded */
        body.has-audio .player-wave-animation {
            display: inline-flex;
        }

        /* Player wave bars inherit from .wave-bar base styles */
        /* Default: minimum height */
        .player-wave-animation .wave-bar {
            transform: scaleY(0.4);
        }

        /* Playing state - animate */
        body.playing .player-wave-animation .wave-bar {
            animation: waveStream 0.8s ease-in-out infinite;
        }

        body.playing .player-wave-animation .wave-bar:nth-child(1) {
            animation-delay: 0s;
        }

        body.playing .player-wave-animation .wave-bar:nth-child(2) {
            animation-delay: 0.2s;
        }

        body.playing .player-wave-animation .wave-bar:nth-child(3) {
            animation-delay: 0.1s;
        }

        body.playing .player-wave-animation .wave-bar:nth-child(4) {
            animation-delay: 0.3s;
        }

        /* Paused state for player - fade to minimum */
        body.has-audio:not(.playing) .player-wave-animation .wave-bar {
            animation: fadeToMin 0.3s ease-out forwards;
        }

        /* Player Show Button wave animation */
        #playerShowBtn .song-wave-animation {
            display: none;
        }

        /* Show wave in show button when audio loaded */
        body.has-audio #playerShowBtn .song-wave-animation {
            display: inline-flex;
        }

        /* Playing state for show button */
        body.playing #playerShowBtn .song-wave-animation .wave-bar {
            animation: waveStream 0.8s ease-in-out infinite;
        }

        body.playing #playerShowBtn .song-wave-animation .wave-bar:nth-child(1) {
            animation-delay: 0s;
        }

        body.playing #playerShowBtn .song-wave-animation .wave-bar:nth-child(2) {
            animation-delay: 0.2s;
        }

        body.playing #playerShowBtn .song-wave-animation .wave-bar:nth-child(3) {
            animation-delay: 0.1s;
        }

        body.playing #playerShowBtn .song-wave-animation .wave-bar:nth-child(4) {
            animation-delay: 0.3s;
        }

        /* Paused state for show button */
        body.has-audio:not(.playing) #playerShowBtn .song-wave-animation .wave-bar {
            animation: fadeToMin 0.3s ease-out forwards;
        }

        /* Expanded song item (recordings mode) */
        .song-item-expanded,
        .song-item-full {
            flex-direction: column;
            align-items: stretch;
            padding: 0;
            gap: 0;
            overflow: visible;
            height: 100%;
        }

        /* Hover effect for full mode - on the whole card */
        .song-item-full:hover {
            box-shadow: 0 8px 25px rgba(74, 124, 201, 0.4);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .song-item-full {
            transition: all 0.3s ease;
            border-radius: 12px;
        }

        /* Blue border hover effect for full mode */
        .song-item-full::after {
            border-radius: 12px;
            z-index: 100;
        }

        .song-item-full:hover::after {
            border-radius: 12px;
            z-index: 100;
        }

        /* === HEADER - Dark blue with white text === */
        .song-item-expanded .song-item-header,
        .song-item-full .song-item-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: linear-gradient(135deg, var(--color-nigun-dark) 0%, var(--color-nigun) 100%);
            border-radius: 12px 12px 0 0;
        }

        .song-item-expanded .song-item-header .song-name,
        .song-item-full .song-item-header .song-name {
            color: white;
        }

        .song-item-expanded .song-item-header .song-meta,
        .song-item-full .song-item-header .song-meta {
            color: rgba(255, 255, 255, 0.9);
        }

        .song-item-expanded .song-item-header .song-number,
        .song-item-full .song-item-header .song-number {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .song-item-expanded .song-item-header .song-play-btn-new,
        .song-item-full .song-item-header .song-play-btn-new {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .song-item-expanded .song-item-header .song-play-btn-new:hover,
        .song-item-full .song-item-header .song-play-btn-new:hover {
            background: white;
            color: var(--color-nigun-dark);
        }

        /* Wave animation white for dark headers */
        .song-item-expanded .song-item-header .song-wave-animation .wave-bar,
        .song-item-full .song-item-header .song-wave-animation .wave-bar {
            background: white;
        }

        .song-item-expanded .song-item-header .song-play-btn-new:hover,
        .song-item-full .song-item-header .song-play-btn-new:hover {
            background: var(--color-nigun);
            color: white;
        }

        /* Wave animation white for active recordings */
        .song-item-recording.active-recording .song-wave-animation .wave-bar {
            background: white !important;
        }



        .song-full-body {
            background: white;
            padding: 8px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            overflow: visible;
            position: relative;
        }

        /* Full mode header - single row RTL layout */
        .song-full-header {
            position: relative;
            display: flex;
            align-items: center;
            min-height: 60px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 12px 20px;
            overflow: visible;
            z-index: 10;
            gap: 8px 20px;
        }

        /* Left section - holds mechaber and wave together */
        .song-full-left-section {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            transition: all 0.3s ease;
            position: absolute;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Title on the right (RTL) */
        .song-full-title-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            max-width: 35%;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Tags in center - use flex */
        .song-full-tags-center {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 6px 4px;
            max-width: 50%;
            pointer-events: auto;
        }

        /* Tag group - keeps same type tags together on wrap */
        .song-full-tag-group {
            display: inline-flex;
            flex-wrap: nowrap;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        /* White dot divider between tag groups */
        .song-full-tag-divider {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
            margin: 0 4px;
        }

        /* Inline mechaber for full mode - small horizontal pill */
        .song-full-mechaber-inline {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 2px 2px 2px 14px;
            background: var(--color-mechaber);
            border-radius: 20px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
            flex-shrink: 0;
            margin-left: 0;
        }

        .song-full-mechaber-inline:hover {
            transform: scale(1.03);
            box-shadow: 0 3px 10px rgba(156, 91, 181, 0.3);
        }

        .song-full-mechaber-inline .mechaber-avatar-small {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            overflow: hidden;
            flex-shrink: 0;
        }

        .song-full-mechaber-inline .mechaber-avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .song-full-mechaber-inline .mechaber-avatar-small .placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--color-mechaber-pale) 0%, var(--color-mechaber-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .song-full-mechaber-inline .mechaber-avatar-small .mechaber-icon {
            width: 12px;
            height: 18px;
            background-color: var(--color-mechaber);
            -webkit-mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
            mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
        }

        .song-full-mechaber-inline .mechaber-name-small {
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Mechaber profile in full mode - like modal (for legacy/fallback) */
        .song-full-mechaber-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--color-mechaber-pale);
            border-radius: 25px;
            text-decoration: none;
            color: var(--color-mechaber-dark);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .song-full-mechaber-profile:hover {
            background: var(--color-mechaber-light);
            color: white;
            transform: scale(1.02);
        }

        .song-full-mechaber-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--color-mechaber-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .song-full-mechaber-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .song-full-mechaber-avatar .placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-mechaber-pale);
        }

        .song-full-mechaber-avatar .placeholder .mechaber-icon {
            width: 18px;
            height: 18px;
            background: var(--color-mechaber);
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E") center/contain no-repeat;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E") center/contain no-repeat;
        }

        .song-full-mechaber-name {
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .song-full-mechaber-name .mechaber-formal {
            font-size: 0.75em;
            opacity: 0.8;
            font-weight: 500;
        }

        .song-full-mechaber-name .mechaber-known {
            font-weight: 700;
        }

        /* Chatzeros tags in full mode */
        .song-full-chatzeros {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .song-full-chatzeros .chatzer-tag {
            padding: 6px 14px;
            background: var(--color-chatzer-pale);
            color: var(--color-chatzer-dark);
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .song-full-chatzeros .chatzer-tag:hover {
            background: var(--color-chatzer);
            color: white;
        }

        /* Simple tags row for full mode */
        .song-full-tags-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
            background: white;
            justify-content: center;
        }

        /* Details grid inside full mode - smaller version */
        .song-full-body .nigun-details-grid {
            margin: 8px 0;
            gap: 12px 10px;
        }

        .song-full-body .nigun-detail-box {
            min-width: 70px;
            max-width: 120px;
            min-height: 50px;
            padding: 6px 10px;
        }

        .song-full-body .nigun-detail-box-header {
            font-size: 0.65em;
            padding: 3px 6px;
        }

        .song-full-body .nigun-detail-box-content {
            padding-top: 20px;
            font-size: 0.85em;
        }

        .song-full-body .nigun-detail-siman-bar {
            margin: 8px auto;
            padding: 10px 16px;
            max-width: 100%;
        }

        /* Song full hero - extends nigun-modal-hero */
        .song-full-hero {
            position: relative;
            border-radius: 12px 12px 0 0;
        }

        .song-full-hero .nigun-modal-hero-title {
            font-size: 1.3em;
            margin-bottom: 8px;
        }

        .song-full-number {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85em;
        }

        /* Adjust hero-bottom for song-full */
        .song-item-full-card .nigun-modal-hero-bottom {
            background: white;
            padding: 12px 16px;
        }

        .song-item-recordings {
            border-top: none;
            padding: 12px 20px 16px;
            background: white;
            border-radius: 0 0 12px 12px;
            flex-grow: 1;
        }

        /* Individual recordings - light blue background with border animation */
        .song-item-recording {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            margin: 6px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.4s ease;
            background: var(--color-nigun-pale);
            position: relative;
        }

        /* Border effect using pseudo-element - same as song-item */
        .song-item-recording::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 12px;
            border: 2px solid var(--color-nigun);
            background: transparent;
            opacity: 0;
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 12px rgba(74, 124, 201, 0.15);
        }

        .song-item-recording:hover::after {
            opacity: 1;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .song-item-recording:hover {
            box-shadow: 0 4px 15px rgba(74, 124, 201, 0.3);
        }

        /* Recording items in modal get same style as regular song-items */
        .nigun-recordings-list .song-item-recording {
            background: var(--color-nigun-pale);
            box-shadow: 0 2px 8px rgba(74, 124, 201, 0.1);
            margin: 6px auto;
            border-radius: 10px;
            padding: 12px 14px;
            max-width: 550px;
            transition: box-shadow 0.3s ease;
            position: relative;
        }

        /* Border effect using pseudo-element - fade from outside to inside */
        .nigun-recordings-list .song-item-recording::after {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border-radius: 10px;
            border: 2px solid var(--color-nigun);
            background: transparent;
            opacity: 0;
            transition: opacity 0.2s ease, top 0s 0.2s, bottom 0s 0.2s, left 0s 0.2s, right 0s 0.2s;
            pointer-events: none;
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(74, 124, 201, 0.1);
        }

        .song-item-recording:not(.active-recording):hover {
            background: var(--color-nigun-pale);
        }

        .nigun-recordings-list .song-item-recording:hover {
            box-shadow: 0 6px 20px rgba(74, 124, 201, 0.35);
        }

        .nigun-recordings-list .song-item-recording:hover::after {
            opacity: 1;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .song-item-rec-num {
            width: 24px;
            height: 24px;
            background: var(--color-nigun-pale);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 600;
            color: var(--color-nigun-dark);
            flex-shrink: 0;
        }

        .song-item-rec-name {
            flex: 1;
            font-size: 0.9em;
            color: var(--text-dark);
        }

        .song-item-rec-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .song-item-rec-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .song-item-rec-tags .nigun-tag-inline {
            font-size: 0.7em;
            padding: 2px 6px;
        }

        /* Album tag color */
        .tag-album {
            background: var(--color-album-pale, #e8f5e9) !important;
            color: var(--color-album-dark, #2e7d32) !important;
            border-color: var(--color-album-light, #81c784) !important;
        }

        /* Gezungen (sung by) tag color */
        .tag-gezungen {
            background: #fff8e1 !important;
            color: #f57c00 !important;
            border-color: #ffcc80 !important;
        }

        /* Rating display for recordings */
        .rec-rating-display {
            color: var(--color-nigun);
            font-size: 0.7em;
            letter-spacing: -1px;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .theme-mechaber .rec-rating-display {
            color: var(--color-mechaber);
        }

        .theme-chatzer .rec-rating-display {
            color: var(--color-chatzer);
        }

        .theme-nigun .rec-rating-display {
            color: var(--color-nigun);
        }

        .theme-verter .rec-rating-display {
            color: var(--color-verter);
        }

        .theme-zman .rec-rating-display {
            color: var(--color-zman);
        }

        .song-item-rec-play {
            width: 28px;
            height: 28px;
            background: var(--color-nigun);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.75em;
            cursor: pointer;
            transition: var(--transition-smooth);
            flex-shrink: 0;
        }

        .song-item-rec-play:hover {
            background: var(--color-nigun-dark);
            transform: scale(1.1);
        }

        /* Low quality recording indicator */
        .song-item-rec-low-quality {
            background: var(--color-nigun-pale) !important;
            color: var(--color-nigun) !important;
            cursor: default !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .song-item-rec-low-quality:hover {
            background: var(--color-nigun-pale) !important;
            transform: none !important;
        }

        .low-quality-rec:not(.active-recording) {
            opacity: 0.65;
            background: white !important;
        }

        .low-quality-rec:not(.active-recording):hover {
            opacity: 1;
            background: white !important;
        }

        /* Active low-quality recordings keep their blue style */
        .low-quality-rec.active-recording {
            opacity: 1;
        }

        /* === EXTRA INFO SECTION (Full mode) - Light blue === */
        .song-full-details {
            border-top: none;
            padding: 14px 20px;
            background: var(--color-nigun-pale);
        }

        .song-full-label {
            font-weight: 600;
            color: var(--color-nigun-dark);
            white-space: nowrap;
            min-width: 80px;
        }

        .song-full-value {
            color: var(--text-dark);
        }

        .song-full-info .song-full-value {
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* === RECORDINGS SECTION - White background === */
        .song-full-recordings {
            border-top: none;
            padding: 12px 20px 16px;
            background: white;
            border-radius: 0 0 12px 12px;
        }

        .song-full-rec-title {
            font-weight: 600;
            font-size: 0.85em;
            color: var(--color-nigun-dark);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rec-collapse-toggle {
            color: var(--color-nigun);
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }

        .rec-collapse-toggle:hover {
            color: var(--color-nigun-dark);
            transform: scale(1.2);
        }

        /* Active song items - recordings inside keep normal color */
        /* (Only the active-recording row gets blue styling) */

        /* Tags container for full mode */
        .song-full-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            flex: 1;
        }

        .song-full-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            font-size: 0.85em;
        }

        /* Tag styles for scale and ritem */
        .tag-scale {
            background: var(--color-music-pale, #e3f2fd) !important;
            color: var(--color-music-dark, #1565c0) !important;
            border-color: var(--color-music-light, #90caf9) !important;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .tag-scale:hover {
            background: var(--color-music-light, #90caf9) !important;
            transform: scale(1.05);
        }

        .tag-ritem {
            background: var(--color-music-pale, #fff8e1) !important;
            color: var(--color-music-dark, #b8960c) !important;
            border-color: var(--color-music-light, #ffe082) !important;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .tag-ritem:hover {
            background: var(--color-music-light, #ffe082) !important;
            color: var(--color-music-dark, #b8960c) !important;
            transform: scale(1.05);
        }

        .tag-siman {
            background: #f0f0f0 !important;
            color: #666666 !important;
            border-color: #d0d0d0 !important;
        }

        /* Date styling */
        .song-full-date {
            font-size: 0.9em;
            color: var(--text-muted);
            background: var(--bg-muted, #f5f5f5);
            padding: 4px 10px;
            border-radius: 8px;
        }

        /* Active state - tags and date keep normal colors */
        /* (No visual change when playing) */


        .songs-card {
            background: transparent;
            border-radius: 16px;
            padding: 0;
            box-shadow: none;
        }

        .filters-container {
            max-width: 700px;
            margin: 0 auto 20px auto;
            background: var(--color-nigun-pale);
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            padding: 15px;
            border: 1px solid var(--color-nigun-light);
        }

        .all-songs-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: minmax(0, 1fr);
            /* Default: full mode - 1 per row */
        }

        /* Minimal mode - 3 per row */
        .view-mode-minimal .all-songs-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
        }

        /* Recordings mode - 2 per row */
        .view-mode-recordings .all-songs-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 14px;
            align-items: stretch;
        }

        /* Full mode - 1 per row (default) */
        .view-mode-full .all-songs-grid {
            grid-template-columns: minmax(0, 1fr);
            gap: 16px;
        }

        /* Responsive adjustments */
        @media (max-width: 900px) {
            .view-mode-minimal .all-songs-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .view-mode-recordings .all-songs-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        @media (max-width: 600px) {

            .view-mode-minimal .all-songs-grid,
            .view-mode-recordings .all-songs-grid,
            .view-mode-full .all-songs-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        /* Song item adjustments for minimal mode - compact horizontal layout */
        .view-mode-minimal .song-item {
            flex-direction: row;
            align-items: center;
            padding: 10px 12px;
            gap: 10px;
            overflow: visible;
            /* Keep visible for hover border animation */
            position: relative;
            box-shadow: inset 0 0 0 1px rgba(74, 124, 201, 0.3), 0 2px 6px rgba(74, 124, 201, 0.15);
        }

        .view-mode-minimal .song-item .song-info {
            position: relative;
        }

        .view-mode-minimal .song-item .song-number {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            font-size: 0.75em;
        }

        .view-mode-minimal .song-item .song-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
            overflow: visible;
        }

        .view-mode-minimal .song-item .song-name {
            font-size: 0.95em;
            white-space: normal;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
            max-height: 2.6em;
        }

        .view-mode-minimal .song-item .song-meta {
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0.8;
            width: 100%;
        }

        .view-mode-minimal .song-item .song-play-btn-new {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
        }

        .view-mode-minimal .song-item .song-wave-animation {
            position: absolute;
            left: 45px;
            top: 50%;
            transform: translateY(-50%);
        }

        .view-mode-minimal .song-item .song-play-btn-new .play-icon svg,
        .view-mode-minimal .song-item .song-play-btn-new .pause-icon svg {
            width: 12px;
            height: 12px;
        }

        /* Song meta separator styling */
        .song-meta-separator {
            color: var(--color-nigun-dark);
        }

        /* Theme overrides for separator color */
        .theme-mechaber .song-meta-separator {
            color: var(--color-mechaber-dark);
        }

        .theme-chatzer .song-meta-separator {
            color: var(--color-chatzer-dark);
        }

        .theme-verter .song-meta-separator {
            color: var(--color-verter-dark);
        }

        .theme-zman .song-meta-separator {
            color: var(--color-zman-dark);
        }

        .theme-collection .song-meta-separator {
            color: var(--color-collection-dark);
        }

        /* Separator hidden by default, shown via JS when tags are on same row */
        .view-mode-minimal .song-item .song-meta-separator {
            display: none;
        }

        .view-mode-minimal .song-item .song-meta-separator.same-row {
            display: inline;
        }

        .all-songs-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .sort-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary-pale);
            background: white;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: inherit;
        }

        .sort-btn:hover,
        .sort-btn.active {
            border-color: var(--primary);
            background: var(--primary-pale);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--color-nigun-light);
        }

        .page-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--color-nigun-light);
            background: white;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: inherit;
        }

        .page-btn:hover:not(:disabled) {
            border-color: var(--color-nigun);
            background: var(--color-nigun-pale);
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-info {
            padding: 8px 16px;
            background: var(--color-nigun-pale);
            border-radius: 10px;
            font-weight: 600;
            color: var(--color-nigun-dark);
        }

        /* Fixed Player */
        .player-section {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(150%);
            width: calc(100% - 80px);
            max-width: 1200px;
            background: linear-gradient(270deg, #4a7cc9 0%, #6a5acd 35%, #9b4cba 65%, #e91e6c 100%);
            padding: 12px 25px;
            box-shadow: 0 8px 40px rgba(74, 18, 89, 0.35), 0 -4px 20px rgba(74, 18, 89, 0.15);
            z-index: 10500;
            direction: ltr;
            opacity: 0;
            border-radius: 20px;
            /* Smooth transitions for morph effect - minimal easing */
            transition:
                transform 0.4s ease-out,
                opacity 0.3s ease,
                width 0.4s ease-out,
                max-width 0.4s ease-out,
                padding 0.4s ease-out,
                border-radius 0.4s ease-out,
                left 0.4s ease-out,
                right 0.4s ease-out;
        }

        .player-section.player-visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ========================================
           MINIMIZED PLAYER - SIMPLE CLEAN LAYOUT
            ======================================== */

        /* Base minimized pill */
        .player-section.player-visible.player-minimized {
            --minimized-progress: 0%;
            /* Position on right side of screen */
            left: auto !important;
            right: 30px;
            transform: translateX(0) translateY(0);
            width: 200px;
            min-height: 44px;
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 1;
            cursor: pointer;
            background: var(--color-nigun, #4a7cc9);
            box-shadow: 0 6px 24px rgba(74, 124, 201, 0.5);
            overflow: hidden;
            position: fixed;
            bottom: 20px;
            transition: transform 0.4s ease, opacity 0.3s ease, box-shadow 0.3s ease, right 0.4s ease, left 0.4s ease, width 0.4s ease !important;
        }

        /* Hide ALL player-inner in minimized state */
        .player-section.player-visible.player-minimized .player-inner {
            display: none !important;
        }

        /* Hide ::before in minimized state - using real element instead */
        .player-section.player-visible.player-minimized::before {
            display: none !important;
        }

        /* Song name element for minimized player */
        .minimized-song-name {
            display: none;
            position: absolute;
            left: 40px;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9em;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            color: white;
            line-height: 1.2;
            direction: rtl;
        }

        /* Show only in minimized state */
        .player-section.player-visible.player-minimized .minimized-song-name {
            display: block;
        }

        /* Minimized marquee styling */
        .minimized-song-name.marquee span {
            display: inline-block;
            white-space: nowrap;
            animation: marqueeScroll var(--marquee-duration, 8s) linear infinite;
            animation-play-state: paused;
        }

        .minimized-song-name.marquee.running span {
            animation-play-state: running;
        }

        /* Progress bar background track via ::after */
        .player-section.player-visible.player-minimized::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right,
                    rgba(255, 255, 255, 0.9) 0%,
                    rgba(255, 255, 255, 0.9) var(--minimized-progress),
                    rgba(255, 255, 255, 0.25) var(--minimized-progress),
                    rgba(255, 255, 255, 0.25) 100%);
            border-radius: 0 0 20px 20px;
            pointer-events: none;
        }

        /* Hover effect - keep same position, just lift slightly */
        .player-section.player-visible.player-minimized:hover {
            transform: translateX(0) translateY(-4px) scale(1.02);
            box-shadow: 0 10px 32px rgba(74, 124, 201, 0.6);
        }

        /* Single pulse that goes out twice, then pauses */
        @keyframes double-pulse-out {
            0% {
                box-shadow:
                    0 6px 24px rgba(74, 124, 201, 0.5),
                    0 0 0 0 rgba(74, 124, 201, 0.4);
            }

            20% {
                box-shadow:
                    0 6px 24px rgba(74, 124, 201, 0.5),
                    0 0 0 18px rgba(74, 124, 201, 0);
            }

            21% {
                box-shadow:
                    0 6px 24px rgba(74, 124, 201, 0.5),
                    0 0 0 0 rgba(74, 124, 201, 0);
            }

            30% {
                box-shadow:
                    0 6px 24px rgba(74, 124, 201, 0.5),
                    0 0 0 0 rgba(74, 124, 201, 0.4);
            }

            50% {
                box-shadow:
                    0 6px 24px rgba(74, 124, 201, 0.5),
                    0 0 0 18px rgba(74, 124, 201, 0);
            }

            51%,
            100% {
                box-shadow:
                    0 6px 24px rgba(74, 124, 201, 0.5),
                    0 0 0 0 rgba(74, 124, 201, 0);
            }
        }

        /* Apply pulse animation when playing */
        .player-section.player-visible.player-minimized.playing {
            animation: double-pulse-out 3s ease-out infinite;
        }

        /* Song name stays the same */
        .player-section.player-visible.player-minimized::before {
            z-index: 1;
        }

        /* Minimized player play/pause button */
        .minimized-play-btn {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.25);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
            padding: 0;
        }

        /* Show button only in minimized state */
        .player-section.player-visible.player-minimized .minimized-play-btn {
            display: flex;
        }

        .minimized-play-btn:hover {
            transform: translateY(-50%) scale(1.15);
            background: rgba(255, 255, 255, 0.4);
        }

        .minimized-play-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Icons stacked with fade transitions */
        .minimized-play-btn .mini-play-icon,
        .minimized-play-btn .mini-pause-icon {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.25s ease;
        }

        /* Play icon visible by default */
        .minimized-play-btn .mini-play-icon {
            opacity: 1;
        }

        .minimized-play-btn .mini-pause-icon {
            opacity: 0;
        }

        /* Playing state - fade to pause */
        .player-section.playing .minimized-play-btn .mini-play-icon {
            opacity: 0;
        }

        .player-section.playing .minimized-play-btn .mini-pause-icon {
            opacity: 1;
        }

        /* Adjust song name in minimized state to not overlap with button */
        .player-section.player-visible.player-minimized::before {
            padding-left: 30px;
        }

        .player-hide-btn {
            position: absolute;
            top: 8px;
            left: 20px;
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            color: white;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-smooth);
        }

        .player-hide-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.1);
        }

        .player-show-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            transform: translateY(100px);
            opacity: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 24px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(123, 31, 162, 0.4);
            z-index: 10499;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
            pointer-events: none;
        }

        .player-show-btn.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .player-show-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(123, 31, 162, 0.5);
        }

        /* Reset margin for wave animation inside button */
        .player-show-btn .song-wave-animation {
            margin-right: 0;
            margin-left: 0;
            height: 18px;
            /* Match previous icon height */
        }

        .player-inner {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            direction: ltr;
            position: static;
            height: 65px;
        }

        .player-right-area {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            direction: rtl;
            order: 99;
            margin-left: auto;
            flex: 1;
            max-width: calc(50% - 270px);
            /* Stop at player progress bar with padding */
            overflow: hidden;
            padding-left: 20px;
        }

        .player-song-info-wrapper {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: center;
            gap: 4px;
            overflow: hidden;
            width: 100%;
        }

        .player-bottom-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            direction: rtl;
            width: 100%;
        }

        /* Info Carousel - Centered with flex */
        .player-info-carousel {
            position: relative;
            flex: 1;
            max-width: 350px;
            min-width: 0;
            height: 22px;
            text-align: center;
        }

        .carousel-item {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            opacity: 0;
            visibility: hidden;
            transform: translateX(-20px);
            transition: opacity 0.4s ease, transform 0.4s ease, visibility 0s 0.4s;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 1;
        }

        .carousel-item.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
            transition: opacity 0.4s ease, transform 0.4s ease, visibility 0s 0s;
            z-index: 2;
        }

        .carousel-item.exiting {
            opacity: 0;
            visibility: hidden;
            transform: translateX(20px);
            z-index: 1;
        }

        .player-recording-name,
        .player-personality-tag,
        .player-album-tag {
            display: inline-block;
        }

        .player-personality-tag,
        .player-album-tag {
            padding: 2px 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: clamp(0.55em, 1.5vw, 0.8em);
        }

        /* Rating Stars - Left Side */
        .player-rating {
            display: flex;
            align-items: center;
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
            overflow: visible;
        }

        .player-rating-stars {
            display: flex;
            flex-direction: row-reverse;
            gap: 4px;
            color: white;
        }

        .player-rating-star {
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.15s ease, text-shadow 0.2s ease;
            color: white;
        }

        .player-rating-star.empty {
            color: rgba(255, 255, 255, 0.3);
            text-shadow: none;
        }

        .player-rating-star:hover {
            transform: scale(1.4);
            text-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
        }

        .player-rating-star.hover-preview {
            color: white;
            -webkit-text-fill-color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(255, 255, 255, 0.3);
            transform: scale(1.15);
        }

        .player-rating.saving .player-rating-star {
            pointer-events: none;
            animation: pulse-star 0.4s ease infinite;
        }

        /* Saving animation - subtle pulse */
        @keyframes pulse-star {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        /* Stars stay stable on success - no animation on them */
        .player-rating.rated-success .player-rating-star {
            /* Just ensure they show correct state */
        }

        /* Container for flying stars */
        .player-rating {
            position: relative;
        }

        /* Flying star particle (created by JS) */
        .flying-star {
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 0 6px rgba(251, 191, 36, 0.9), 0 0 12px rgba(251, 191, 36, 0.5);
            pointer-events: none;
            z-index: 100;
            animation: fly-star var(--fly-duration, 0.8s) ease-out forwards;
            --fly-x: 0px;
            --fly-y: 0px;
        }

        @keyframes fly-star {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.3);
            }

            20% {
                opacity: 1;
                transform: translate(calc(-50% + var(--fly-x) * 0.3), calc(-50% + var(--fly-y) * 0.3)) scale(1.1);
            }

            100% {
                opacity: 0;
                transform: translate(calc(-50% + var(--fly-x)), calc(-50% + var(--fly-y))) scale(0.4);
            }
        }

        .player-rating-stars .star-icon {
            width: 20px;
            height: 20px;
        }

        .player-rating:hover .star-icon {
            filter: brightness(1.2);
        }

        .player-rec-tag-personality {
            background: var(--color-mechaber);
            color: white;
            box-shadow: 0 2px 6px rgba(196, 53, 168, 0.35);
            cursor: pointer;
            text-decoration: none;
        }

        .player-rec-tag-personality:hover {
            background: var(--color-mechaber-dark);
            transform: scale(1.05);
        }

        .player-rec-tag-album {
            background: var(--color-album);
            color: white;
            box-shadow: 0 2px 6px rgba(0, 131, 143, 0.35);
            cursor: pointer;
            text-decoration: none;
        }

        .player-rec-tag-album:hover {
            background: var(--color-album-dark);
            transform: scale(1.05);
        }

        .player-right-song-name {
            font-weight: 700;
            font-size: 1.8em;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            cursor: pointer;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            max-width: 300px;
            direction: rtl;
            align-self: center;
            position: relative;
        }

        .player-right-song-name:hover {
            opacity: 0.85;
        }

        /* Marquee: wrapper keeps overflow:hidden, inner span animates */
        .player-right-song-name.marquee {
            overflow: hidden;
            text-align: right;
        }

        .player-right-song-name.marquee span {
            display: inline-block;
            white-space: nowrap;
            /* Animation paused initially until offset is calculated */
            animation: marqueeScroll var(--marquee-duration, 10s) linear infinite;
            animation-play-state: paused;
            will-change: transform;
        }

        .player-right-song-name.marquee.running span {
            animation-play-state: running;
        }

        @keyframes marqueeScroll {

            0% {
                transform: translateX(var(--marquee-start, 0px));
            }

            90%,
            100% {
                /* Positive = scroll RIGHT, Copy2 enters from left (correct for RTL) */
                transform: translateX(calc(var(--marquee-start, 0px) + var(--marquee-width, 200px)));
            }
        }

        .player-hide-btn-inner {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-smooth);
        }

        .player-hide-btn-inner:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        .player-mechaber-row {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .player-mechaber-row:has(.player-mechaber-profile[style*="display: none"]) {
            display: none;
        }

        .player-info {
            position: absolute;
            left: 2.5%;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            direction: rtl;
            min-width: 0;
            width: calc(50% - 250px);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .player-song-name {
            font-weight: 700;
            font-size: 1.5em;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all 0.2s ease;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
            max-width: 260px;
        }

        .player-song-name:hover {
            opacity: 0.85;
            text-decoration: underline;
        }

        .player-song-meta {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.85);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Compact mechaber badge - modern style */
        .player-info-box {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .player-info-box:hover {
            background: rgba(255, 255, 255, 0.22);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .player-mechaber-profile {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            text-decoration: none;
            flex-shrink: 0;
        }

        .player-mechaber-profile:hover {
            opacity: 0.85;
        }

        .player-mechaber-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            border: 2px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            flex-shrink: 0;
        }

        .player-mechaber-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-mechaber-avatar .placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--color-mechaber-pale) 0%, var(--color-mechaber-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-mechaber-avatar .placeholder .mechaber-icon {
            width: 14px;
            height: 20px;
            background-color: var(--color-mechaber);
            -webkit-mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
            mask: url('assets/mechaber-placeholder.svg') center/contain no-repeat;
        }

        .player-mechaber-name {
            font-size: 0.75em;
            font-weight: 600;
            color: white;
            max-width: 260px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
        }

        .player-info-content {
            display: none;
        }

        /* Player tags section */
        .player-tags {
            display: none;
        }

        .player-tags-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            align-items: center;
            justify-content: center;
            direction: rtl;
            width: 100%;
            overflow: hidden;
        }

        .player-tags-row:empty {
            display: none;
        }

        .player-tag-divider {
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            margin: 0 2px;
            opacity: 0.8;
        }

        .player-tag-overflow {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.68em;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.25);
            color: white;
            flex-shrink: 0;
        }

        .player-tag {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.68em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            white-space: nowrap;
        }

        .player-tag-chatzer {
            background: var(--color-chatzer-pale);
            color: var(--color-chatzer);
        }

        .player-tag-chatzer:hover {
            background: var(--color-chatzer-light);
            transform: scale(1.05);
        }

        .player-tag-personality {
            background: var(--color-mechaber-pale);
            color: var(--color-mechaber);
        }

        .player-tag-personality:hover {
            background: var(--color-mechaber-light);
            transform: scale(1.05);
        }

        .player-tag-collection {
            background: var(--color-collection-pale);
            color: var(--color-collection);
        }

        .player-tag-collection:hover {
            background: var(--color-collection-light);
            transform: scale(1.05);
        }

        .player-tag-zman {
            background: var(--color-zman-pale);
            color: var(--color-zman);
        }

        .player-tag-zman:hover {
            background: var(--color-zman-light);
            transform: scale(1.05);
        }

        .player-tag-gezungen {
            background: var(--color-piyut-pale);
            color: var(--color-piyut);
        }

        .player-tag-gezungen:hover {
            background: var(--color-piyut-light);
            transform: scale(1.05);
        }

        .player-tag-verter {
            background: var(--color-verter-pale);
            color: var(--color-verter);
        }

        .player-tag-verter:hover {
            background: var(--color-verter-light);
            transform: scale(1.05);
        }

        .player-tag-pasig {
            background: var(--color-piyut-pale);
            color: var(--color-piyut);
        }

        .player-tag-pasig:hover {
            background: var(--color-piyut-light);
            transform: scale(1.05);
        }

        .player-tag-rhythm {
            background: var(--color-music-pale);
            color: var(--color-music);
        }

        .player-tag-rhythm:hover {
            background: var(--color-music-light);
            transform: scale(1.05);
        }

        .player-tag-scale {
            background: var(--color-music-pale);
            color: var(--color-music);
        }

        .player-tag-scale:hover {
            background: var(--color-music-light);
            transform: scale(1.05);
        }

        /* When no mechaber, reduce left padding */
        .player-info-box.no-mechaber {
            padding-left: 12px;
        }

        /* Hide old meta when using new box */
        .player-info-box .player-song-meta {
            display: none;
        }

        .player-meta-link {
            color: var(--text-muted);
            text-decoration: none;
            transition: var(--transition-smooth);
        }

        .player-meta-link:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        /* Entity-specific player meta links */
        .player-meta-link-mechaber {
            color: var(--color-mechaber-dark);
            text-decoration: none;
            transition: var(--transition-smooth);
        }

        .player-meta-link-mechaber:hover {
            color: var(--color-mechaber);
            text-decoration: underline;
        }

        .player-meta-link-chatzer {
            color: var(--color-chatzer-dark);
            text-decoration: none;
            transition: var(--transition-smooth);
        }

        .player-meta-link-chatzer:hover {
            color: var(--color-chatzer);
            text-decoration: underline;
        }

        .player-controls {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 8px;
            flex-shrink: 0;
            position: absolute;
            left: 50%;
            top: 0;
            transform: translate(-50%, -33%);
            z-index: 30;
            /* Ensure buttons are clickable above progress bar */
        }

        .player-btn {
            width: 38px;
            height: 38px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 50%;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .player-btn svg {
            display: block;
        }

        .player-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.1);
        }

        .player-btn.main {
            width: 70px;
            height: 70px;
            background: transparent;
            color: var(--color-nigun);
            font-size: 1.6em;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            border: none;
            z-index: 10;
        }

        .player-btn-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: white;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25), 0 0 30px rgba(255, 255, 255, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.5);
            z-index: 1;
            transition: var(--transition-smooth);
        }

        .player-btn.main:hover .player-btn-bg {
            transform: scale(1.08);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.35), 0 0 40px rgba(255, 255, 255, 0.4);
        }



        .player-btn.main svg {
            width: 42px;
            height: 42px;
            fill: var(--color-chatzer);
        }

        /* Shockwave/Pulse Effect for Main Play Button */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0.6;
            }

            100% {
                transform: scale(1.6);
                /* Expand nicely */
                opacity: 0;
            }
        }

        .player-btn.main::before,
        .player-btn.main::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-chatzer);
            /* Use main theme color */
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            pointer-events: none;
            transform: scale(1.4);
            transition: all 0.6s ease-out;
        }

        .player-btn.main.playing::before {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        .player-btn.main.playing::after {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            animation-delay: 0.6s;
            /* Staggered delay for ripple effect */
        }

        /* Animated play/pause icons in player */
        .player-play-icon,
        .player-pause-icon {
            position: absolute;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .player-play-icon svg,
        .player-pause-icon svg {
            display: block;
        }

        .player-play-icon {
            opacity: 1;
            transform: scale(1);
        }

        .player-pause-icon {
            opacity: 0;
            transform: scale(0.5);
        }

        .player-btn.main.playing .player-play-icon {
            opacity: 0;
            transform: scale(0.5);
        }

        .player-btn.main.playing .player-pause-icon {
            opacity: 1;
            transform: scale(1);
        }

        .player-progress {
            position: absolute;
            left: 50%;
            top: auto;
            /* Remove top positioning */
            bottom: 2px;
            /* Position lower, moved down closer to edge */
            transform: translateX(-50%);
            display: flex;
            flex-direction: column-reverse;
            /* Put time display below bar */
            gap: 4px;
            width: 450px;
            max-width: 70%;
            padding: 0;
            /* Remove padding to lower it fully */
            cursor: pointer;
            z-index: 20;
            /* Ensure it's above other elements */
        }

        /* Larger invisible container for hit testing */
        .progress-bar-container {
            width: 100%;
            height: 40px;
            /* Even larger hit area for better usability */
            background: transparent;
            /* Invisible hit area */
            border-radius: 12px;
            cursor: pointer;
            position: relative;
            margin-bottom: 0px;
            /* No margin, time display close to bar */
            /* Flex layout to center the visible inner bar */
            display: flex;
            align-items: center;
        }

        /* The actual visual progress bar - thinner by default */
        .progress-bar-visual-bg {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.25);
            /* Visible track background moved here */
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            transform: scaleY(0.7);
            /* Start thin */
            transition: transform 0.2s ease;
        }

        /* Container hover expands the visual bar */
        .player-progress:hover .progress-bar-visual-bg,
        .progress-bar-container:hover .progress-bar-visual-bg {
            transform: scaleY(1.3);
            /* Grow thicker on hover */
        }

        /* The fill element */
        .progress-bar {
            height: 100%;
            background: white;
            border-radius: 10px;
            width: 0%;
            transition: width 0.15s ease-out;
            /* Smooth movement for seeking and natural playback */
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            position: relative;
            will-change: width;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 1.1em;
            color: rgba(255, 255, 255, 0.95);
            font-weight: 600;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-muted);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary-pale);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 300;
            align-items: center;
            justify-content: center;
            padding: 20px 20px 150px 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: var(--gradient-main);
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .modal-header h2 {
            font-size: 1.3em;
            font-family: 'Heebo', sans-serif;
            font-weight: 600;
        }

        .modal-close {
            width: 35px;
            height: 35px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            font-size: 1.3em;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: calc(80vh - 80px);
        }

        /* Modal recordings section */
        .modal-recordings-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--primary-pale);
        }

        .modal-recordings-title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .modal-recordings-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-recording-item {
            background: var(--primary-pale);
            border-radius: 12px;
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            position: relative;
        }

        /* ::before overlay for fade transition */
        .modal-recording-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-nigun);
            border-radius: 12px;
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
            z-index: 0;
        }

        .modal-recording-item.active::before {
            opacity: 1;
        }

        /* Ensure content is above overlay */
        .modal-recording-item>* {
            position: relative;
            z-index: 1;
        }

        .modal-recording-item:hover {
            background: var(--primary-light);
            transform: translateX(-3px);
        }

        .modal-recording-item.active {
            box-shadow: 0 4px 15px rgba(74, 124, 201, 0.4);
        }

        .modal-recording-item.active .modal-recording-name {
            color: white;
        }

        .modal-recording-item.active .modal-recording-play-btn {
            background: white;
            color: var(--primary);
        }

        .modal-recording-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .modal-recording-play-btn {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            flex-shrink: 0;
            transition: var(--transition-smooth);
        }

        .modal-recording-item:hover .modal-recording-play-btn {
            transform: scale(1.1);
        }

        .modal-recording-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95em;
        }

        /* Nigun Modal Overlay - Lightbox style */
        .nigun-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 20px 20px 120px 20px;
            overflow-y: auto;
        }

        .nigun-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .nigun-modal-content {
            /* Match nigunim main page gradient background */
            background: linear-gradient(180deg, var(--color-nigun-pale) 0%, color-mix(in srgb, var(--color-nigun-pale) 30%, #f8fafc) 300px, #f8fafc 100%);
            border-radius: 20px;
            max-width: 850px;
            width: 100%;
            height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            transform: scale(0.9) translateY(30px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            border: 3px solid var(--color-nigun);
            padding-bottom: 150px;
        }

        /* Minimal scrollbar for nigun modal - just the thumb, no track */
        .nigun-modal-content::-webkit-scrollbar {
            width: 8px;
            margin-right: -10px;
        }

        .nigun-modal-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .nigun-modal-content::-webkit-scrollbar-thumb {
            background: var(--color-nigun);
            border-radius: 10px;
        }

        .nigun-modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--color-nigun-dark);
        }

        /* Hide scrollbar arrows */
        .nigun-modal-content::-webkit-scrollbar-button {
            display: none;
        }

        /* Firefox scrollbar */
        .nigun-modal-content {
            scrollbar-width: thin;
            scrollbar-color: var(--color-nigun) transparent;
        }

        .nigun-modal-overlay.active .nigun-modal-content {
            transform: scale(1) translateY(0);
        }

        /* Nigun modal close button */
        .nigun-modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 1.8em;
            color: #666;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 20;
            transition: all 0.25s ease;
        }

        .nigun-modal-close:hover {
            background: var(--color-nigun-pale);
            color: var(--color-nigun-dark);
            transform: scale(1.15);
        }

        /* Nigun modal expand button */
        .nigun-modal-expand {
            position: absolute;
            top: 56px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 1.2em;
            color: #666;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 20;
            transition: all 0.25s ease;
        }

        .nigun-modal-expand:hover {
            background: var(--color-nigun-pale);
            color: var(--color-nigun-dark);
            transform: scale(1.15);
        }

        /* Nigun modal report button - octagon shape */
        .nigun-modal-report {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            font-size: 1.4em;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: all 0.25s ease;
            /* Octagon shape (stop sign) */
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
        }

        .nigun-modal-report:hover {
            background: #fff3e0;
            color: #e65100;
            transform: scale(1.15);
        }

        /* Nigun modal add-info button - boxy shape with plus icon */
        .nigun-modal-addinfo {
            position: absolute;
            top: 56px;
            left: 12px;
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            font-size: 1.5em;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: all 0.25s ease;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .nigun-modal-addinfo:hover {
            background: #e8f5e9;
            color: #2e7d32;
            transform: scale(1.15);
        }

        /* Full page report button - matching back button style exactly */
        .nigun-fullpage-report {
            top: 30px !important;
            left: auto !important;
            right: 145px !important;
            width: auto !important;
            height: auto !important;
            min-width: 46px;
            padding: 10px 14px !important;
            background: white;
            border: 2px solid var(--color-nigun-pale) !important;
            border-radius: 25px;
            box-shadow: none;
            font-size: 1.2em !important;
            font-weight: bold;
            color: #e65100;
            clip-path: none;
        }

        .nigun-fullpage-report:hover {
            background: #fff3e0;
            border-color: #e65100 !important;
            color: #c62828;
            transform: none;
            box-shadow: none;
        }

        /* Full page add-info button - next to report button */
        .nigun-fullpage-addinfo {
            top: 30px !important;
            left: auto !important;
            right: 215px !important;
            width: auto !important;
            height: auto !important;
            min-width: 46px;
            padding: 10px 14px !important;
            background: white;
            border: 2px solid var(--color-nigun-pale) !important;
            border-radius: 25px;
            box-shadow: none;
            font-size: 1.2em !important;
            font-weight: bold;
            color: #2e7d32;
        }

        .nigun-fullpage-addinfo:hover {
            background: #e8f5e9;
            border-color: #2e7d32 !important;
            color: #1b5e20;
            transform: none;
            box-shadow: none;
        }

        /* Shadow for octagon report button - placed on parent to avoid clip-path */
        .nigun-modal-content::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 12px;
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.12);
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
            filter: blur(4px);
            z-index: 19;
            pointer-events: none;
            transform: translate(0, 2px);
        }

        /* Floating notes container for nigun modal */
        .nigun-modal-notes {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
            border-radius: 20px;
        }

        .nigun-modal-notes .note-wrapper {
            position: absolute;
            left: 50%;
            top: 50%;
            animation: songsNoteFlight linear infinite;
        }

        .nigun-modal-notes .musical-note {
            color: rgba(74, 124, 201, 0.12);
            text-shadow: 0 0 15px rgba(74, 124, 201, 0.08);
            font-size: inherit;
            display: block;
        }

        .nigun-modal-notes .musical-note.wander-1 {
            animation: wander1 ease-in-out infinite alternate;
        }

        .nigun-modal-notes .musical-note.wander-2 {
            animation: wander2 ease-in-out infinite alternate;
        }

        .nigun-modal-notes .musical-note.wander-3 {
            animation: wander3 ease-in-out infinite alternate;
        }

        /* Hide back button inside modal since we have our own close */
        .nigun-modal-content .back-button {
            display: none;
        }

        /* Remove page-level padding inside modal */
        .nigun-modal-content .detail-page {
            padding-top: 10px;
        }

        /* Fix overflow in modal - just hide horizontal scroll */
        #nigunModalBody {
            overflow-x: hidden;
        }

        /* Mobile responsiveness for nigun modal */
        @media (max-width: 768px) {
            .nigun-modal-overlay {
                padding: 10px;
            }

            .nigun-modal-content {
                max-height: 95vh;
                border-radius: 15px;
            }
        }

        /* Report Modal Styles */
        .report-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .report-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .report-modal-content {
            background: linear-gradient(180deg, var(--color-nigun-pale) 0%, white 100%);
            border-radius: 24px;
            max-width: 480px;
            width: 90%;
            padding: 0;
            position: relative;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--color-nigun);
            overflow: hidden;
        }

        .report-modal-overlay.active .report-modal-content {
            transform: scale(1) translateY(0);
        }

        .report-modal-header {
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%);
            color: white;
            padding: 24px 28px;
            text-align: center;
            position: relative;
        }

        .report-modal-header h3 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .report-modal-header h3::before {
            content: '⚠';
            font-size: 1.2em;
        }

        .report-modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            font-size: 1.3em;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .report-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .report-modal-song-name {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 12px;
            display: inline-block;
            font-size: 0.95em;
            font-weight: 500;
        }

        .report-modal-body {
            padding: 28px;
        }

        .report-form-group {
            margin-bottom: 20px;
        }

        .report-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-nigun-dark);
            font-size: 0.95em;
        }

        .report-form-group select,
        .report-form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--color-nigun-pale);
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
            background: white;
            color: var(--color-nigun-dark);
            transition: all 0.25s ease;
            direction: rtl;
        }

        .report-form-group select:focus,
        .report-form-group textarea:focus {
            outline: none;
            border-color: var(--color-nigun);
            box-shadow: 0 0 0 4px rgba(74, 124, 201, 0.2), 0 4px 12px rgba(74, 124, 201, 0.15);
        }

        .report-form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234a7cc9' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 20px;
            padding-left: 44px;
            font-weight: 500;
        }

        .report-form-group select:hover {
            border-color: var(--color-nigun);
        }

        .report-form-group select option {
            background: white;
            color: var(--color-nigun-dark);
            padding: 12px;
        }

        .report-form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .report-form-group textarea::placeholder {
            color: var(--color-nigun);
            opacity: 0.6;
        }

        .report-submit-btn {
            width: auto;
            padding: 12px 32px;
            margin: 0 auto;
            display: block;
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 15px rgba(74, 124, 201, 0.3);
        }

        .report-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 124, 201, 0.4);
        }

        .report-submit-btn:active {
            transform: translateY(0);
        }

        @media (max-width: 480px) {
            .report-modal-content {
                width: 95%;
                border-radius: 20px;
            }

            .report-modal-header {
                padding: 20px;
            }

            .report-modal-body {
                padding: 20px;
            }
        }

        /* Report Success State */
        .report-modal-content.success .report-modal-body {
            display: none;
        }

        .report-success-message {
            display: none;
            padding: 40px 28px;
            text-align: center;
            color: var(--color-nigun-dark);
        }

        .report-modal-content.success .report-success-message {
            display: block;
            animation: fadeInUp 0.4s ease;
        }

        .report-success-message .success-icon {
            font-size: 3em;
            margin-bottom: 16px;
            display: block;
        }

        .report-success-message h4 {
            font-size: 1.4em;
            margin: 0 0 12px 0;
            color: var(--color-nigun);
        }

        .report-success-message p {
            font-size: 1em;
            line-height: 1.6;
            margin: 0;
            color: #666;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .report-modal-overlay.fade-out .report-modal-content {
            transform: scale(0.9) translateY(20px);
            opacity: 0;
        }

        .report-modal-overlay.fade-out {
            opacity: 0;
        }

        /* ============================================
           Add Info Modal Styles (Nigun Theme)
           ============================================ */
        .addinfo-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 20px;
        }

        .addinfo-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .addinfo-modal-content {
            background: linear-gradient(180deg, var(--color-nigun-pale) 0%, white 100%);
            border-radius: 24px;
            max-width: 700px;
            width: 95%;
            height: 85vh;
            padding: 0;
            position: relative;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--color-nigun);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .addinfo-modal-overlay.active .addinfo-modal-content {
            transform: scale(1) translateY(0);
        }

        .addinfo-modal-header {
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%);
            color: white;
            padding: 24px 28px 28px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
            border-radius: 0 0 32px 32px;
            box-shadow: 0 8px 24px rgba(74, 124, 201, 0.25);
        }

        .addinfo-modal-header h3 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .addinfo-modal-header h3::before {
            content: '+';
            font-size: 1.2em;
            background: rgba(255, 255, 255, 0.2);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .addinfo-modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            font-size: 1.3em;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .addinfo-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .addinfo-modal-song-name {
            font-size: 1.6em;
            font-weight: 700;
            margin-top: 8px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            letter-spacing: 0.5px;
        }

        /* Add Nigun Name Input - styled like song name header */
        .addnigun-name-header-wrapper {
            text-align: center;
            margin-top: 8px;
        }

        .addnigun-name-input {
            width: 100%;
            font-size: 1.6em;
            font-weight: 700;
            text-align: center;
            letter-spacing: 0.5px;
            background: transparent;
            border: none;
            border-bottom: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 8px 0;
            outline: none;
            transition: border-color 0.3s ease;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .addnigun-name-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }

        .addnigun-name-input:focus {
            border-bottom-color: white;
        }

        .addnigun-name-error {
            color: #ffcccc;
            font-size: 0.85em;
            margin-top: 8px;
            display: none;
            text-align: center;
            background: rgba(255, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
        }

        .addnigun-name-error.visible {
            display: block;
        }

        /* Toggle slider for switching between Report and Add Info */
        .addinfo-modal-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            padding: 4px;
            margin-top: 0;
            gap: 0;
            position: relative;
            max-width: 520px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Sliding indicator for toggle */
        .addinfo-modal-toggle::before {
            content: '';
            position: absolute;
            top: 4px;
            bottom: 4px;
            width: calc(33.333% - 4px);
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            left: 4px;
        }

        .addinfo-modal-toggle.report-active::before {
            left: 4px;
        }

        .addinfo-modal-toggle.addinfo-active::before {
            left: calc(33.333% + 2px);
        }

        .addinfo-modal-toggle.addnigun-active::before {
            left: calc(66.666% - 2px);
        }

        .addinfo-modal-toggle-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .addinfo-modal-toggle-btn.active {
            color: var(--color-nigun-dark);
        }

        .addinfo-modal-toggle-btn:hover:not(.active) {
            color: white;
        }

        /* Content panels with slide animation */
        .addinfo-panel {
            display: none;
            opacity: 0;
            transform: translateX(30px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            min-height: 50vh;
        }

        .addinfo-panel.active {
            display: flex;
            flex-direction: column;
            height: 100%;
            opacity: 1;
            transform: translateX(0);
        }

        .addinfo-panel.slide-in-right {
            animation: slideIn 0.3s ease forwards;
        }

        .addinfo-panel.slide-in-left {
            animation: slideInFromLeft 0.3s ease forwards;
        }

        .addinfo-panel.slide-out-left {
            animation: slideOutLeft 0.3s ease forwards;
        }

        .addinfo-panel.slide-out-right {
            animation: slideOutRight 0.3s ease forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(-30px);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(30px);
            }
        }

        /* Report panel fills space with large textarea */
        #reportPanel .addinfo-section {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        #reportPanel .addinfo-row:last-child {
            flex: 1;
            display: flex;
        }

        #reportPanel .addinfo-row:last-child .addinfo-field {
            display: flex;
            flex: 1;
        }

        #reportPanel textarea {
            flex: 1;
            min-height: 180px;
            resize: none;
        }

        .addinfo-modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
            height: 55vh;
        }

        /* Minimal scrollbar for add-info modal */
        .addinfo-modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .addinfo-modal-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .addinfo-modal-body::-webkit-scrollbar-thumb {
            background: var(--color-nigun);
            border-radius: 10px;
        }

        .addinfo-modal-body::-webkit-scrollbar-thumb:hover {
            background: var(--color-nigun-dark);
        }

        /* Section styles - no section titles, just clean dividers */
        .addinfo-section {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-nigun-pale);
        }

        .addinfo-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .addinfo-section-title {
            display: flex;
            direction: rtl;
            align-items: center;
            gap: 12px;
            font-size: 0.85em;
            font-weight: 500;
            color: var(--color-nigun);
            margin-bottom: 14px;
            margin-top: 8px;
            letter-spacing: 0.3px;
        }

        .addinfo-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to left, var(--color-nigun), var(--color-nigun-light), transparent);
        }

        .addinfo-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .addinfo-row:last-child {
            margin-bottom: 0;
        }

        .addinfo-field {
            flex: 1;
            min-width: 0;
        }

        .addinfo-field.full-width {
            flex: 1 1 100%;
        }

        .addinfo-field label {
            display: none;
            /* Hide labels - using placeholders instead */
        }

        .addinfo-field input[type="text"],
        .addinfo-field textarea,
        .addinfo-field select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--color-nigun-pale);
            border-radius: 12px;
            font-size: 0.95em;
            font-family: inherit;
            background: white;
            color: var(--color-nigun-dark);
            transition: all 0.25s ease;
            direction: rtl;
        }

        .addinfo-field input[type="text"]:focus,
        .addinfo-field textarea:focus,
        .addinfo-field select:focus {
            outline: none;
            border-color: var(--color-nigun);
            box-shadow: 0 0 0 4px rgba(74, 124, 201, 0.2), 0 4px 12px rgba(74, 124, 201, 0.15);
        }

        .addinfo-field input[type="text"]::placeholder,
        .addinfo-field textarea::placeholder {
            color: var(--color-nigun);
            opacity: 0.6;
        }

        .addinfo-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .addinfo-field select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234a7cc9' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 18px;
            padding-left: 40px;
        }

        /* File upload styling */
        .addinfo-file-upload {
            border: 2px dashed var(--color-nigun-pale);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            background: rgba(74, 124, 201, 0.05);
        }

        .addinfo-file-upload:hover {
            border-color: var(--color-nigun);
            background: rgba(74, 124, 201, 0.1);
        }

        .addinfo-file-upload input[type="file"] {
            display: none;
        }

        .addinfo-file-upload-icon {
            font-size: 2em;
            color: var(--color-nigun);
            margin-bottom: 8px;
        }

        .addinfo-file-upload-text {
            color: var(--color-nigun-dark);
            font-weight: 500;
            font-size: 0.9em;
        }

        .addinfo-file-upload-hint {
            color: var(--color-nigun);
            opacity: 0.7;
            font-size: 0.8em;
            margin-top: 4px;
        }

        /* Link paste alternative */
        .addinfo-file-link-divider {
            text-align: center;
            color: var(--color-nigun);
            opacity: 0.6;
            font-size: 0.8em;
            margin: 10px 0 6px;
        }

        .addinfo-file-link-input {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid var(--color-nigun-pale);
            border-radius: 10px;
            font-size: 0.85em;
            background: rgba(74, 124, 201, 0.03);
            color: var(--text-primary);
            direction: ltr;
            text-align: left;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .addinfo-file-link-input:focus {
            outline: none;
            border-color: var(--color-nigun);
        }

        .addinfo-file-link-input.link-valid {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.05);
        }

        .addinfo-file-link-input.link-invalid {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.05);
        }

        /* File selected state */
        .addinfo-file-upload.file-selected {
            border-color: #4CAF50;
            border-style: solid;
            background: rgba(76, 175, 80, 0.1);
        }

        .addinfo-file-upload.file-selected .addinfo-file-upload-icon {
            color: #4CAF50;
        }

        .addinfo-file-upload.file-selected .addinfo-file-upload-icon::after {
            content: ' ✓';
        }

        .addinfo-file-upload.file-selected .addinfo-file-upload-text {
            color: #2E7D32;
        }

        .addinfo-file-upload.file-selected .addinfo-file-upload-hint {
            color: #4CAF50;
            opacity: 1;
        }

        /* Submit button loading state */
        .addinfo-submit-btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .addinfo-submit-btn .btn-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Checkbox styling */
        .addinfo-checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: rgba(74, 124, 201, 0.08);
            border-radius: 10px;
            cursor: pointer;
        }

        .addinfo-checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--color-nigun);
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .addinfo-checkbox-wrapper label {
            margin: 0;
            font-size: 0.85em;
            line-height: 1.4;
            cursor: pointer;
            color: var(--color-nigun-dark);
            display: block !important;
            /* Keep checkbox label visible */
        }

        /* Submit button */
        .addinfo-submit-btn {
            width: auto;
            padding: 14px 40px;
            margin: 20px auto 0;
            display: block;
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 15px rgba(74, 124, 201, 0.3);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .addinfo-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 124, 201, 0.4);
        }

        .addinfo-submit-btn:active {
            transform: translateY(0);
        }

        /* Success state */
        .addinfo-modal-content.success .addinfo-modal-body {
            display: none;
        }

        .addinfo-success-message {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 55vh;
            padding: 40px 28px;
            text-align: center;
            color: var(--color-nigun-dark);
        }

        .addinfo-modal-content.success .addinfo-success-message {
            display: flex;
            animation: fadeInUp 0.4s ease;
        }

        .addinfo-success-message .success-icon {
            font-size: 3em;
            margin-bottom: 16px;
            display: block;
            color: var(--color-nigun);
        }

        .addinfo-success-message h4 {
            font-size: 1.4em;
            margin: 0 0 12px 0;
            color: var(--color-nigun);
        }

        .addinfo-success-message p {
            font-size: 1em;
            line-height: 1.6;
            margin: 0;
            color: #666;
        }

        /* Fade out animation */
        .addinfo-modal-overlay.fade-out .addinfo-modal-content {
            transform: scale(0.9) translateY(20px);
            opacity: 0;
        }

        .addinfo-modal-overlay.fade-out {
            opacity: 0;
        }

        /* Mobile responsiveness */
        @media (max-width: 600px) {
            .addinfo-modal-content {
                width: 98%;
                max-height: 90vh;
                border-radius: 20px;
            }

            .addinfo-modal-header {
                padding: 16px 20px;
            }

            .addinfo-modal-body {
                padding: 16px;
            }

            .addinfo-row {
                flex-direction: column;
                gap: 10px;
            }

            .addinfo-field {
                flex: 1 1 100%;
            }
        }

        /* Autocomplete dropdown styling */
        .addinfo-autocomplete-wrapper {
            position: relative;
            width: 100%;
        }

        .addinfo-autocomplete-input {
            width: 100%;
            padding: 14px 16px;
            padding-left: 40px;
            /* Space for dropdown arrow */
            border: 2px solid var(--color-nigun-pale);
            border-radius: 12px;
            font-size: 0.95em;
            font-family: inherit;
            background: white;
            color: var(--color-nigun-dark);
            transition: all 0.25s ease;
            direction: rtl;
            cursor: text;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%234a7cc9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 16px;
        }

        .addinfo-autocomplete-input:focus {
            outline: none;
            border-color: var(--color-nigun);
            box-shadow: 0 0 0 4px rgba(74, 124, 201, 0.2), 0 4px 12px rgba(74, 124, 201, 0.15);
        }

        .addinfo-autocomplete-input::placeholder {
            color: var(--color-nigun);
            opacity: 0.6;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .addinfo-autocomplete-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .addinfo-autocomplete-dropdown::-webkit-scrollbar-track {
            background: transparent;
        }

        .addinfo-autocomplete-dropdown::-webkit-scrollbar-thumb {
            background: var(--color-nigun-pale);
            border-radius: 6px;
        }

        .addinfo-autocomplete-item {
            display: inline-block;
            margin: 4px;
            padding: 6px 14px;
            background: var(--color-nigun);
            color: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
            font-weight: 500;
            direction: rtl;
            box-shadow: 0 2px 8px rgba(107, 137, 147, 0.3);
        }

        /* Category-specific colors for items */
        .addinfo-autocomplete-item.source-mechabrim {
            background: var(--color-mechaber);
            box-shadow: 0 2px 8px rgba(196, 53, 168, 0.3);
        }

        .addinfo-autocomplete-item.source-chatzeros {
            background: var(--color-chatzer);
            box-shadow: 0 2px 8px rgba(156, 91, 181, 0.3);
        }

        .addinfo-autocomplete-item.source-verter {
            background: var(--color-verter);
            box-shadow: 0 2px 8px rgba(233, 30, 99, 0.3);
        }

        .addinfo-autocomplete-item.source-piyutim {
            background: #00897b;
            box-shadow: 0 2px 8px rgba(0, 137, 123, 0.3);
        }

        .addinfo-autocomplete-item.source-scales {
            background: #5c6bc0;
            box-shadow: 0 2px 8px rgba(92, 107, 192, 0.3);
        }

        .addinfo-autocomplete-item.source-rhythms {
            background: #ef6c00;
            box-shadow: 0 2px 8px rgba(239, 108, 0, 0.3);
        }

        .addinfo-autocomplete-item.source-collections {
            background: #8e24aa;
            box-shadow: 0 2px 8px rgba(142, 36, 170, 0.3);
        }

        .addinfo-autocomplete-item.source-documents {
            background: #546e7a;
            box-shadow: 0 2px 8px rgba(84, 110, 122, 0.3);
        }

        .addinfo-autocomplete-item.source-albums {
            background: #43a047;
            box-shadow: 0 2px 8px rgba(67, 160, 71, 0.3);
        }

        .addinfo-autocomplete-item.source-nigunim {
            background: var(--color-nigun);
            box-shadow: 0 2px 8px rgba(74, 124, 201, 0.3);
        }

        .addinfo-autocomplete-item:hover,
        .addinfo-autocomplete-item.highlighted {
            transform: scale(1.05);
            filter: brightness(0.9);
        }

        .addinfo-autocomplete-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--color-nigun-pale);
            border-radius: 16px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 10000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: none;
            padding: 8px;
            text-align: right;
        }

        .addinfo-autocomplete-dropdown.active {
            display: block;
            animation: dropdownFadeIn 0.2s ease;
        }

        .addinfo-autocomplete-empty {
            padding: 16px;
            text-align: center;
            color: #888;
            font-size: 0.9em;
            direction: rtl;
        }

        .addinfo-autocomplete-loading {
            padding: 16px;
            text-align: center;
            color: var(--color-nigun);
        }

        /* Selected tags - positioned inside the wrapper */
        .addinfo-selected-tags {
            display: contents;
            /* Tags flow naturally with input */
        }

        /* Wrapper acts as flex container for input + tags */
        .addinfo-autocomplete-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 2px solid var(--color-nigun-pale);
            border-radius: 12px;
            align-items: center;
            justify-content: flex-start;
            direction: rtl;
            min-height: 48px;
        }

        .addinfo-autocomplete-wrapper:focus-within {
            border-color: var(--color-nigun);
            box-shadow: 0 0 0 3px rgba(107, 137, 147, 0.1);
        }

        .addinfo-autocomplete-input {
            flex: 1;
            min-width: 100px;
            border: none !important;
            padding: 4px 0 !important;
            background: transparent !important;
            box-shadow: none !important;
            outline: none !important;
            order: 999;
            /* Input goes last, so tags appear first (right side in RTL) */
        }

        .addinfo-autocomplete-input:focus {
            border: none !important;
            box-shadow: none !important;
        }

        /* For single-select: hide input when has selection, allow clicking to reselect */
        .addinfo-autocomplete-wrapper[data-multi="false"].has-selection .addinfo-autocomplete-input {
            position: absolute;
            opacity: 0;
            width: 0;
            min-width: 0;
            flex: 0;
            pointer-events: none;
        }

        /* Hide tags container when no selections for single-select */
        .addinfo-autocomplete-wrapper[data-multi="false"]:not(.has-selection) .addinfo-selected-tags {
            display: none;
        }

        .addinfo-selected-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%);
            border-radius: 20px;
            font-size: 0.9em;
            color: white;
            direction: rtl;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        /* Category-specific colors for selected tags */
        .addinfo-selected-tag.source-mechabrim {
            background: linear-gradient(135deg, var(--color-mechaber) 0%, var(--color-mechaber-dark) 100%);
        }

        .addinfo-selected-tag.source-chatzeros {
            background: linear-gradient(135deg, var(--color-chatzer) 0%, var(--color-chatzer-dark) 100%);
        }

        .addinfo-selected-tag.source-verter {
            background: linear-gradient(135deg, var(--color-verter) 0%, var(--color-verter-dark) 100%);
        }

        .addinfo-selected-tag.source-piyutim {
            background: linear-gradient(135deg, #00897b 0%, #00695c 100%);
        }

        .addinfo-selected-tag.source-scales {
            background: linear-gradient(135deg, #5c6bc0 0%, #3949ab 100%);
        }

        .addinfo-selected-tag.source-rhythms {
            background: linear-gradient(135deg, #ef6c00 0%, #e65100 100%);
        }

        .addinfo-selected-tag.source-collections {
            background: linear-gradient(135deg, #8e24aa 0%, #6a1b9a 100%);
        }

        .addinfo-selected-tag.source-documents {
            background: linear-gradient(135deg, #546e7a 0%, #37474f 100%);
        }

        .addinfo-selected-tag.source-albums {
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
        }

        /* Single-select input styling when has value - looks like a tag */
        .addinfo-autocomplete-input.has-value {
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%) !important;
            color: white !important;
            font-weight: 500;
            border-color: transparent !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .addinfo-autocomplete-input.has-value::placeholder {
            color: transparent !important;
        }

        /* Category-specific colors for single-select inputs */
        .addinfo-autocomplete-input.has-value.source-mechabrim {
            background: linear-gradient(135deg, var(--color-mechaber) 0%, var(--color-mechaber-dark) 100%) !important;
        }

        .addinfo-autocomplete-input.has-value.source-scales {
            background: linear-gradient(135deg, #5c6bc0 0%, #3949ab 100%) !important;
        }

        .addinfo-autocomplete-input.has-value.source-rhythms {
            background: linear-gradient(135deg, #ef6c00 0%, #e65100 100%) !important;
        }

        .addinfo-selected-tag button {
            background: rgba(255, 255, 255, 0.25);
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            line-height: 1;
            color: white;
            padding: 2px 6px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: all 0.15s;
        }

        .addinfo-selected-tag button:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.4);
        }

        .detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--primary-pale);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            width: 120px;
            font-weight: 700;
            color: var(--primary);
            flex-shrink: 0;
        }

        .detail-value {
            flex: 1;
            color: var(--text-dark);
        }

        .field-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            padding: 2px 8px;
            background: var(--primary-pale);
            border-radius: 12px;
            transition: var(--transition-smooth);
            display: inline-block;
            margin: 2px;
        }

        .field-link:hover {
            background: var(--primary);
            color: white;
            text-decoration: none;
        }

        /* Hover Tooltip Popup */
        .hover-tooltip {
            position: fixed;
            background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            border: none;
            z-index: 10001;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s, transform 0.2s, box-shadow 0.2s;
            max-width: 280px;
            min-width: 200px;
            direction: rtl;
            overflow: hidden;
            text-decoration: none;
            display: block;
            color: inherit;
        }

        .hover-tooltip-type {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 15px;
            background: var(--primary);
            color: white;
        }

        /* Category-themed tooltips */
        .hover-tooltip.tooltip-chatzer .hover-tooltip-type {
            background: var(--color-chatzer);
        }

        .hover-tooltip.tooltip-chatzer .hover-tooltip-title {
            color: var(--color-chatzer-dark);
        }

        .hover-tooltip.tooltip-mechaber .hover-tooltip-type {
            background: var(--color-mechaber-dark);
        }

        .hover-tooltip.tooltip-mechaber .hover-tooltip-title {
            color: var(--color-mechaber-dark);
        }

        .hover-tooltip.tooltip-verter .hover-tooltip-type {
            background: var(--color-verter);
        }

        .hover-tooltip.tooltip-verter .hover-tooltip-title {
            color: var(--text-dark);
            font-weight: 400;
            font-size: 1em;
            line-height: 1.5;
        }

        .hover-tooltip.tooltip-zman .hover-tooltip-type {
            background: var(--color-zman);
        }

        .hover-tooltip.tooltip-zman .hover-tooltip-title {
            color: var(--color-zman-dark);
        }

        .hover-tooltip.tooltip-piyut .hover-tooltip-type {
            background: var(--color-piyut);
        }

        .hover-tooltip.tooltip-piyut .hover-tooltip-title {
            color: var(--color-piyut-dark);
        }

        .hover-tooltip.tooltip-collection .hover-tooltip-type {
            background: var(--color-collection);
        }

        .hover-tooltip.tooltip-collection .hover-tooltip-title {
            color: var(--color-collection-dark);
        }

        .hover-tooltip.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            cursor: pointer;
        }

        .hover-tooltip:hover {
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.25);
        }

        .hover-tooltip-header {
            display: flex;
            gap: 12px;
            padding: 15px;
            align-items: center;
        }

        .hover-tooltip-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .hover-tooltip-image.round {
            border-radius: 50%;
        }

        .hover-tooltip-image.large {
            width: 60px;
            height: 60px;
        }

        .hover-tooltip-title-area {
            flex: 1;
        }

        .hover-tooltip-title {
            font-size: 1.15em;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1.3;
        }

        .hover-tooltip-subtitle {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .hover-tooltip-stats {
            padding: 10px 15px;
            background: #f8fafc;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .hover-tooltip-hint {
            padding: 8px 15px;
            font-size: 0.75em;
            color: var(--text-muted);
            text-align: center;
            background: rgba(0, 0, 0, 0.03);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Skeleton Loader - RTL shimmer direction */
        @keyframes skeleton-shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg,
                    rgba(200, 200, 200, 0.2) 25%,
                    rgba(200, 200, 200, 0.4) 50%,
                    rgba(200, 200, 200, 0.2) 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        .skeleton-page {
            padding: 20px;
            min-height: calc(100vh - 200px);
        }

        .skeleton-title-bar {
            height: 50px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: linear-gradient(90deg,
                    rgba(180, 150, 180, 0.3) 25%,
                    rgba(180, 150, 180, 0.5) 50%,
                    rgba(180, 150, 180, 0.3) 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
        }

        .skeleton-subtitle {
            height: 24px;
            width: 200px;
            margin: 0 auto 30px;
        }

        .skeleton-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        .skeleton-card {
            height: 120px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            position: relative;
            overflow: hidden;
        }

        .skeleton-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(270deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.3) 50%,
                    transparent 100%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 2.5s ease-in-out infinite;
        }

        /* Theme-specific skeleton colors */
        .page-theme-chatzer .skeleton-card {
            background: color-mix(in srgb, var(--color-chatzer-pale) 70%, white);
        }

        .page-theme-mechaber .skeleton-card {
            background: color-mix(in srgb, var(--color-mechaber-pale) 70%, white);
        }

        .page-theme-verter .skeleton-card {
            background: color-mix(in srgb, var(--color-verter-pale) 70%, white);
        }

        .page-theme-zman .skeleton-card {
            background: color-mix(in srgb, var(--color-zman-pale) 70%, white);
        }

        .page-theme-collection .skeleton-card {
            background: color-mix(in srgb, var(--color-collection-pale) 70%, white);
        }

        .page-theme-nigun .skeleton-card,
        .page-theme-nigun .skeleton-song-row {
            background: color-mix(in srgb, var(--color-nigun-pale) 70%, white);
        }

        .page-theme-resource .skeleton-card {
            background: color-mix(in srgb, var(--color-resource-pale) 70%, white);
        }

        .page-theme-document .skeleton-card {
            background: color-mix(in srgb, var(--color-document-pale) 70%, white);
        }

        .page-theme-album .skeleton-card {
            background: color-mix(in srgb, var(--color-album-pale) 70%, white);
        }

        .skeleton-songs-layout {
            display: flex;
            gap: 20px;
        }

        .skeleton-songs-main {
            flex: 1;
        }

        .skeleton-songs-sidebar {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .skeleton-search-box {
            height: 45px;
            border-radius: 25px;
        }

        .skeleton-filter {
            height: 40px;
            border-radius: 8px;
        }

        .skeleton-song-row {
            height: 60px;
            margin-bottom: 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.6);
            position: relative;
            overflow: hidden;
        }

        .skeleton-song-row::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(270deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.3) 50%,
                    transparent 100%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 2.5s ease-in-out infinite;
        }

        @media (max-width: 768px) {
            .skeleton-songs-layout {
                flex-direction: column;
            }

            .skeleton-songs-sidebar {
                width: 100%;
                order: -1;
            }

            .skeleton-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading-songs-message {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .loading-songs-message .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary-pale);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                gap: 15px;
            }

            .global-search {
                max-width: 100%;
                margin: 0;
                order: 2;
            }

            .main-nav {
                order: 3;
            }

            .category-grid {
                grid-template-columns: 1fr;
            }

            .player-inner {
                flex-wrap: wrap;
                justify-content: center;
                padding-top: 30px;
            }

            .player-info {
                order: 3;
                width: 100%;
                text-align: center;
                margin-bottom: 0;
                display: flex;
                justify-content: center;
            }

            .player-info-box {
                padding: 6px 10px 6px 55px;
                width: auto;
                max-width: 200px;
            }

            .player-info-box.no-mechaber {
                padding-left: 10px;
            }

            .player-mechaber-profile {
                left: 6px;
                padding: 4px 5px 3px 5px;
            }

            .player-mechaber-avatar {
                width: 30px;
                height: 30px;
            }

            .player-mechaber-name {
                font-size: 6px;
                max-width: 38px;
            }

            .player-info-box .player-song-name {
                font-size: 0.8em;
            }

            .player-controls {
                position: relative;
                left: auto;
                top: auto;
                transform: none;
                order: 1;
                margin-bottom: 10px;
            }

            .player-btn.main {
                width: 60px;
                height: 60px;
                margin-top: -35px;
            }

            .player-progress {
                position: static;
                transform: none;
                order: 2;
                width: 100%;
                max-width: none;
                margin-bottom: 8px;
            }

            .player-rating {
                order: 4;
                padding-left: 0;
            }

            .player-tags {
                display: none;
            }

            .player-hide-btn {
                top: 5px;
                left: 10px;
                width: 28px;
                height: 28px;
            }
        }

        /* Filters section for all songs page */
        .filters-container {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Songs page layout (sidebar removed - now uses filter panel button) */
        .songs-page-layout {
            display: block;
        }

        .songs-main-content {
            flex: 1;
            min-width: 0;
        }

        .sidebar-wrapper {
            width: 280px;
            flex-shrink: 0;
        }

        .songs-sidebar {
            width: 280px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 90px;
            min-height: calc(100vh - 100px);
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: rgba(74, 124, 201, 0.3) transparent;
        }

        .songs-sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .songs-sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .songs-sidebar::-webkit-scrollbar-thumb {
            background: rgba(74, 124, 201, 0.3);
            border-radius: 4px;
        }

        .songs-sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 124, 201, 0.5);
        }

        .sidebar-search-box {
            display: flex;
            position: relative;
            margin-bottom: 10px;
        }

        .sidebar-search-input {
            flex: 1;
            padding: 8px 12px;
            padding-left: 35px;
            border: 2px solid var(--color-nigun-pale);
            border-radius: 8px;
            font-size: 0.9em;
            font-family: inherit;
            direction: rtl;
            transition: var(--transition-smooth);
        }

        .sidebar-search-input:focus {
            outline: none;
            border-color: var(--color-nigun);
        }

        .sidebar-search-btn {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            opacity: 0.6;
            transition: var(--transition-smooth);
        }

        .sidebar-search-btn:hover {
            opacity: 1;
        }

        .sidebar-search-clear {
            position: absolute;
            left: 35px;
            top: 50%;
            transform: translateY(-50%);
            background: #999;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-search-clear:hover {
            background: #666;
        }

        .sidebar-audio-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: var(--color-nigun-pale);
            border-radius: 10px;
            margin-bottom: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition-smooth);
        }

        .sidebar-audio-toggle:hover {
            background: var(--color-nigun-light);
        }

        .sidebar-audio-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--color-nigun);
            cursor: pointer;
        }

        /* Sort toggle slider styles */
        .sidebar-sort-section {
            margin-bottom: 10px;
        }

        .sidebar-sort-label {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
            display: block;
        }

        .sort-toggle-container {
            display: flex;
            background: var(--color-nigun-pale);
            border-radius: 10px;
            padding: 4px;
            position: relative;
        }

        .sort-toggle-option {
            flex: 1;
            padding: 6px 6px;
            text-align: center;
            font-size: 0.8em;
            font-weight: 500;
            color: var(--text-dark);
            cursor: pointer;
            border-radius: 6px;
            transition: var(--transition-smooth);
            z-index: 1;
            position: relative;
            white-space: nowrap;
        }

        .sort-toggle-option:hover {
            color: var(--color-nigun-dark);
        }

        .sort-toggle-option.active {
            color: white;
            font-weight: 600;
        }

        .sort-toggle-slider {
            position: absolute;
            top: 4px;
            bottom: 4px;
            background: var(--color-nigun);
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            /* Will be positioned dynamically via JavaScript */
        }

        /* Quality Stars Filter */
        .quality-stars-filter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 4px;
            background: var(--color-nigun-pale);
            border-radius: 10px;
            direction: ltr;
            /* Stars fill left to right */
        }

        .quality-star {
            font-size: 1.3em;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            padding: 4px 3px;
        }

        .quality-star.active {
            color: var(--color-nigun);
        }

        /* Reset all stars on hover, let JavaScript handle the fill */
        .quality-stars-filter:hover .quality-star {
            color: #ccc;
        }

        .quality-stars-filter .quality-star:hover {
            transform: scale(1.15);
        }

        /* Use JavaScript for proper hover fill since CSS sibling selectors don't work backwards */
        .quality-stars-filter.hovering .quality-star.hover-active {
            color: var(--color-nigun);
        }

        .quality-clear {
            font-size: 1.4em;
            color: #999;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .quality-clear:hover {
            color: var(--color-nigun-dark);
            transform: scale(1.1);
        }

        .quality-clear.hidden {
            display: none;
        }

        /* Quality Star Tooltips */
        .quality-star[data-tooltip],
        .quality-clear[data-tooltip] {
            position: relative;
        }

        .quality-star[data-tooltip]::after,
        .quality-clear[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-nigun);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            pointer-events: none;
            font-weight: 400;
        }

        .quality-star[data-tooltip]::before,
        .quality-clear[data-tooltip]::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--color-nigun);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .quality-star[data-tooltip]:hover::after,
        .quality-star[data-tooltip]:hover::before,
        .quality-clear[data-tooltip]:hover::after,
        .quality-clear[data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* Sort toggle slider styles */
        .sidebar-sort-section {
            margin-bottom: 20px;
        }

        .sidebar-sort-label {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            display: block;
        }

        .sort-toggle-container {
            display: flex;
            background: var(--color-nigun-pale);
            border-radius: 10px;
            padding: 4px;
            position: relative;
        }

        .sort-toggle-option {
            flex: 1;
            padding: 10px 8px;
            text-align: center;
            font-size: 0.85em;
            font-weight: 500;
            color: var(--text-dark);
            cursor: pointer;
            border-radius: 8px;
            transition: var(--transition-smooth);
            z-index: 1;
            position: relative;
            white-space: nowrap;
        }

        .sort-toggle-option:hover {
            color: var(--color-nigun-dark);
        }

        .sort-toggle-option.active {
            color: white;
            font-weight: 600;
        }

        .sort-toggle-slider {
            position: absolute;
            top: 4px;
            bottom: 4px;
            background: var(--color-nigun);
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            /* Will be positioned dynamically via JavaScript */
        }

        /* Quality Stars Filter */
        .quality-stars-filter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 4px;
            background: var(--color-nigun-pale);
            border-radius: 10px;
            direction: ltr;
            /* Stars fill left to right */
        }

        .quality-star {
            font-size: 1.6em;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            padding: 6px 4px;
        }

        .quality-star.active {
            color: var(--color-nigun);
        }

        /* Reset all stars on hover, let JavaScript handle the fill */
        .quality-stars-filter:hover .quality-star {
            color: #ccc;
        }

        .quality-stars-filter .quality-star:hover {
            transform: scale(1.15);
        }

        /* Use JavaScript for proper hover fill since CSS sibling selectors don't work backwards */
        .quality-stars-filter.hovering .quality-star.hover-active {
            color: var(--color-nigun);
        }

        .quality-clear {
            font-size: 1.4em;
            color: #999;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .quality-clear:hover {
            color: var(--color-nigun-dark);
            transform: scale(1.1);
        }

        .quality-clear.hidden {
            display: none;
        }

        /* Quality Star Tooltips */
        .quality-star[data-tooltip],
        .quality-clear[data-tooltip] {
            position: relative;
        }

        .quality-star[data-tooltip]::after,
        .quality-clear[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-nigun);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            pointer-events: none;
            font-weight: 400;
        }

        .quality-star[data-tooltip]::before,
        .quality-clear[data-tooltip]::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--color-nigun);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .quality-star[data-tooltip]:hover::after,
        .quality-star[data-tooltip]:hover::before,
        .quality-clear[data-tooltip]:hover::after,
        .quality-clear[data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-section {
            margin-bottom: 6px;
        }

        .sidebar-section-title {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
            display: block;
        }

        .sidebar-collection-btn {
            width: 100%;
            padding: 12px 15px;
            background: white;
            border: 2px solid var(--color-nigun);
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95em;
            cursor: pointer;
            transition: var(--transition-smooth);
            color: var(--color-nigun);
        }

        .sidebar-collection-btn:hover,
        .sidebar-collection-btn.active {
            background: var(--color-nigun);
            color: white;
        }


        .sidebar-filter {
            margin-bottom: 6px;
        }

        .sidebar-filter-dropdown {
            position: relative;
        }

        .sidebar-filter-btn {
            width: 100%;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
            border: 1px solid rgba(74, 124, 201, 0.15);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            padding-right: 14px;
            box-shadow: 0 2px 6px rgba(74, 124, 201, 0.06);
            overflow: hidden;
        }

        .sidebar-filter-btn::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 0 12px 12px 0;
            transition: width 0.3s ease;
        }

        .sidebar-filter-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(74, 124, 201, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .sidebar-filter-btn:hover::after {
            opacity: 1;
        }

        .sidebar-filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(74, 124, 201, 0.15);
            border-color: rgba(74, 124, 201, 0.25);
        }

        .sidebar-filter-btn:hover::before {
            width: 6px;
        }

        /* Filter colors as right border */
        .sidebar-filter[data-filter="collection"] .sidebar-filter-btn::before {
            background: linear-gradient(180deg, var(--color-collection) 0%, var(--color-collection-dark) 100%);
        }

        .sidebar-filter[data-filter="chatzer"] .sidebar-filter-btn::before {
            background: linear-gradient(180deg, var(--color-chatzer) 0%, var(--color-chatzer-dark) 100%);
        }

        .sidebar-filter[data-filter="mechaber"] .sidebar-filter-btn::before {
            background: linear-gradient(180deg, var(--color-mechaber) 0%, var(--color-mechaber-dark) 100%);
        }

        .sidebar-filter[data-filter="verter"] .sidebar-filter-btn::before {
            background: linear-gradient(180deg, var(--color-verter) 0%, var(--color-verter-dark) 100%);
        }

        .sidebar-filter[data-filter="gezungen"] .sidebar-filter-btn::before {
            background: linear-gradient(180deg, #2e8b2e 0%, #1e6b1e 100%);
        }

        /* גרין - פיוטים */
        .sidebar-filter[data-filter="ritem"] .sidebar-filter-btn::before {
            background: linear-gradient(180deg, var(--color-music) 0%, var(--color-music-dark) 100%);
        }

        .sidebar-filter[data-filter="scale"] .sidebar-filter-btn::before {
            background: linear-gradient(180deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%);
        }

        .sidebar-filter-btn .sidebar-filter-label {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--color-nigun-dark);
        }

        .sidebar-filter-btn .sidebar-filter-value {
            flex: 1;
            text-align: left;
            color: var(--text-muted);
            font-size: 0.85em;
        }

        .sidebar-filter-btn .dropdown-arrow {
            color: var(--color-nigun);
            font-size: 0.7em;
            transition: transform 0.3s ease;
        }

        .sidebar-filter-btn.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .sidebar-filter-btn.active {
            border-color: var(--color-nigun);
            background: linear-gradient(135deg, var(--color-nigun-pale) 0%, rgba(227, 242, 253, 0.8) 100%);
            box-shadow: 0 4px 16px rgba(74, 124, 201, 0.2);
        }

        .sidebar-dropdown-content {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            left: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(74, 124, 201, 0.2);
            border-radius: 12px;
            max-height: 280px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 10px 40px rgba(74, 124, 201, 0.2);
            animation: dropdownSlide 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-8px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .sidebar-dropdown-content.show {
            display: block;
        }

        .dropdown-search-box {
            padding: 10px;
            border-bottom: 1px solid rgba(74, 124, 201, 0.1);
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, white 0%, rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(8px);
            z-index: 1;
        }

        .dropdown-search-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid rgba(74, 124, 201, 0.2);
            border-radius: 8px;
            font-size: 0.85em;
            font-family: inherit;
            direction: rtl;
            background: rgba(248, 250, 252, 0.8);
            transition: all 0.2s ease;
        }

        .dropdown-search-input:focus {
            outline: none;
            border-color: var(--color-nigun);
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 124, 201, 0.1);
        }

        .dropdown-options {
            max-height: 220px;
            overflow-y: auto;
            padding: 4px;
        }

        .sidebar-filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.88em;
            border-radius: 8px;
            margin: 2px 0;
        }

        .sidebar-filter-option:hover {
            background: linear-gradient(135deg, var(--color-nigun-pale) 0%, rgba(227, 242, 253, 0.6) 100%);
            transform: translateX(-2px);
        }

        .sidebar-filter-option input {
            accent-color: var(--color-nigun);
            width: 16px;
            height: 16px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .sidebar-filter-option input:checked+* {
            color: var(--color-nigun-dark);
            font-weight: 500;
        }

        /* Mobile responsive */
        @media (max-width: 900px) {
            .songs-page-layout {
                flex-direction: column;
            }

            .songs-sidebar {
                width: 100%;
                position: static;
                max-height: none;
                margin-bottom: 20px;
            }
        }

        .search-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .songs-search-box {
            display: flex;
            flex: 1;
            position: relative;
        }

        .songs-search-input {
            flex: 1;
            padding: 10px 15px;
            padding-left: 40px;
            border: 2px solid #ddd;
            border-left: none;
            border-radius: 0 8px 8px 0;
            font-size: 0.95em;
            font-family: inherit;
            direction: rtl;
            transition: var(--transition-smooth);
        }

        .songs-search-input:focus {
            outline: none;
            border-color: var(--color-nigun);
        }

        .search-clear-btn {
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background: #999;
            color: white;
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-smooth);
        }

        .search-clear-btn:hover {
            background: #666;
        }

        .songs-search-btn {
            padding: 10px 20px;
            background: var(--color-nigun);
            color: white;
            border: 2px solid var(--color-nigun);
            border-radius: 8px 0 0 8px;
            font-family: inherit;
            font-size: 0.95em;
            cursor: pointer;
            transition: var(--transition-smooth);
            white-space: nowrap;
        }

        .songs-search-btn:hover {
            background: var(--color-nigun-dark);
            border-color: var(--color-nigun-dark);
        }

        .clear-filters-btn {
            padding: 10px 15px;
            border: 2px solid #e74c3c;
            background: white;
            color: #e74c3c;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: inherit;
            white-space: nowrap;
        }

        .clear-filters-btn:hover {
            background: #e74c3c;
            color: white;
        }



        .filters-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-dropdown {
            position: relative;
        }

        .filter-btn {
            padding: 10px 15px;
            border: 2px solid var(--color-nigun-light);
            background: white;
            border-radius: 10px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-btn:hover,
        .filter-btn.active {
            border-color: var(--color-nigun);
            background: var(--color-nigun-pale);
        }

        .filter-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid var(--color-nigun);
            border-radius: 10px;
            margin-top: 5px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: var(--card-hover-shadow);
        }

        .filter-dropdown-content.show {
            display: block;
        }

        .filter-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-option:hover {
            background: var(--primary-pale);
        }

        .filter-option input {
            width: 18px;
            height: 18px;
        }

        .active-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--primary-pale);
        }

        .active-filters:empty {
            display: none;
        }

        .filter-tag {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-tag-close {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
        }

        .filter-tag-close:hover {
            opacity: 1;
        }

        /* Stats cards on home */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--card-shadow);
        }

        .stat-number {
            font-size: 2em;
            font-weight: 600;
            color: var(--primary);
            font-family: 'Heebo', sans-serif;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* Home About Us Section - Full Width */
        .home-about-section {
            margin-top: 60px;
        }

        .home-about-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--gradient-main);
            padding: 20px 30px;
            border-radius: 18px 18px 0 0;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-decoration: none;
            color: inherit;
        }

        .home-about-header:hover {
            filter: brightness(1.05);
        }

        .home-about-title {
            font-size: 1.25em;
            font-weight: 600;
            color: white;
        }

        .home-about-arrow {
            color: white;
            font-size: 1.3em;
            transition: var(--transition-smooth);
        }

        .home-about-header:hover .home-about-arrow {
            transform: translateX(-5px);
        }

        .home-about-links {
            background: white;
            border-radius: 0 0 18px 18px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
        }

        .home-about-link {
            padding: 18px 15px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border-left: 1px solid var(--color-chatzer-pale);
            color: var(--text);
            font-size: 0.95em;
            text-align: center;
            text-decoration: none;
        }

        .home-about-link:first-child {
            border-left: none;
        }

        .home-about-link:hover {
            background: var(--gradient-main-pale);
        }

        /* Terms Link */
        .home-terms-link {
            text-align: center;
            margin-top: 35px;
            margin-bottom: 20px;
            color: var(--text-muted);
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-decoration: none;
            display: block;
        }

        .home-terms-link:hover {
            color: var(--color-chatzer);
            text-decoration: underline;
        }

        /* Info Pages Layout */
        .info-page {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .info-page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .info-page-title {
            font-size: 2.2em;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .info-page-subtitle {
            color: var(--text-muted);
            font-size: 1.1em;
        }

        .info-page-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: var(--card-shadow);
            line-height: 1.8;
            margin-bottom: 25px;
        }

        .info-page-content p {
            margin-bottom: 20px;
        }

        .info-page-content ul {
            margin: 20px 0;
            padding-right: 25px;
        }

        .info-page-content li {
            margin-bottom: 10px;
        }

        /* Info Pages Sub-Navigation */
        .info-nav {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            padding: 18px 25px;
            background: var(--gradient-main-pale);
            border-radius: 16px;
            border: 1px solid var(--color-chatzer-pale);
        }

        .info-nav-item {
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95em;
            transition: var(--transition-smooth);
            background: white;
            color: var(--text);
            border: 1px solid var(--color-chatzer-pale);
            text-decoration: none;
        }

        .info-nav-item:hover {
            background: var(--gradient-main);
            color: white;
            border-color: var(--color-chatzer);
            transform: translateY(-2px);
        }

        .info-nav-item.active {
            background: var(--gradient-main);
            color: white;
            border-color: var(--color-chatzer);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .info-nav-item.info-nav-featured {
            background: white;
            border: 2px solid;
            border-image: var(--gradient-main) 1;
            border-radius: 10px;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.15);
            position: relative;
            margin: 0 8px;
        }

        .info-nav-item.info-nav-featured {
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .info-nav-item.info-nav-featured:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.25);
        }

        .info-nav-item.info-nav-featured.active {
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
        }

        .info-nav-divider {
            width: 1px;
            background: var(--color-chatzer-light);
            margin: 0 5px;
        }

        /* Stats Page Grid */
        .stats-page-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stats-page-card {
            background: var(--gradient-main-pale);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 1px solid var(--color-chatzer-pale);
            text-decoration: none;
            color: inherit;
        }

        .stats-page-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: var(--gradient-main-soft);
        }

        .stats-page-number {
            font-size: 2.5em;
            font-weight: 700;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Heebo', sans-serif;
        }

        .stats-page-label {
            font-size: 1.1em;
            color: var(--text);
            margin-top: 8px;
        }

        /* Instructions Page */
        .instructions-page-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .instruction-page-item {
            background: var(--gradient-main-pale);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--color-chatzer-pale);
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .instruction-page-number {
            width: 45px;
            height: 45px;
            background: var(--gradient-main);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            font-weight: 700;
            flex-shrink: 0;
        }

        .instruction-page-text {
            flex: 1;
        }

        .instruction-page-text strong {
            display: block;
            font-size: 1.15em;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        /* Credits Page */
        .credits-page-list {
            display: grid;
            gap: 20px;
            margin-top: 30px;
        }

        .credit-page-item {
            background: var(--gradient-main-pale);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--color-chatzer-pale);
        }

        .credit-page-item strong {
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.1em;
        }

        /* Thanks Page */
        .thanks-page-list {
            list-style: none;
            padding: 0;
            margin: 25px 0;
        }

        .thanks-page-list li {
            padding: 15px 20px;
            background: var(--gradient-main-pale);
            border-radius: 12px;
            margin-bottom: 12px;
            border-right: 4px solid;
            border-image: var(--gradient-main-vertical) 1;
        }

        .blessing-text {
            background: linear-gradient(135deg, var(--gold-light) 0%, var(--gold-pale) 100%);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            font-size: 1.15em;
            color: var(--gold);
            margin-top: 30px;
            border: 1px solid var(--gold-light);
        }

        /* Terms Page */
        .terms-page-content {
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
            direction: ltr;
        }

        .terms-last-updated {
            color: var(--text-muted);
            font-size: 0.95em;
            margin-bottom: 30px;
        }

        .terms-intro {
            font-size: 1.05em;
            line-height: 1.8;
            margin-bottom: 40px;
        }

        .terms-section {
            margin-bottom: 45px;
        }

        .terms-section-header {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--primary-deep);
            margin-bottom: 8px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-light);
        }

        .terms-section p {
            line-height: 1.9;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .terms-section ul {
            list-style: disc;
            padding-right: 0;
            padding-left: 25px;
            margin: 15px 0;
        }

        .terms-section li {
            line-height: 1.8;
            margin-bottom: 10px;
            color: var(--text-dark);
        }

        .terms-section ol {
            padding-right: 0;
            padding-left: 25px;
            margin: 15px 0;
        }

        .terms-section ol li {
            margin-bottom: 8px;
        }

        .terms-divider {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 35px 0;
        }

        .terms-email {
            color: var(--primary);
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .info-nav {
                gap: 6px;
                padding: 12px;
            }

            .info-nav-item {
                padding: 8px 14px;
                font-size: 0.85em;
            }

            .info-nav-divider {
                display: none;
            }

            .info-page-content {
                padding: 25px;
            }

            .info-page-title {
                font-size: 1.8em;
            }
        }

        /* Goals Page - Brick Layout Design */
        .goals-intro {
            text-align: center;
            margin-bottom: 35px;
            font-size: 1.15em;
            color: var(--text);
        }

        .goals-bricks {
            margin-bottom: 40px;
        }

        .goals-brick-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .goal-brick {
            flex: 1;
            position: relative;
            background: var(--gradient-main-pale);
            border-radius: 14px;
            padding: 22px 25px;
            transition: var(--transition-smooth);
            border: 1px solid var(--color-chatzer-pale);
            overflow: hidden;
        }

        .goal-brick::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient-main);
            border-radius: 0 14px 14px 0;
        }

        .goal-brick:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: var(--gradient-main-soft);
        }

        .goal-brick-text {
            font-size: 1em;
            line-height: 1.7;
            text-align: center;
            color: var(--text-dark);
        }

        /* Warning Box */
        .goals-warning {
            background: white;
            border: 2px solid var(--color-chatzer-light);
            border-radius: 16px;
            padding: 25px 30px;
            margin-bottom: 35px;
            text-align: center;
        }

        .goals-warning-title {
            font-size: 1.3em;
            font-weight: 700;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }

        .goals-warning-text {
            font-size: 1.05em;
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Contact Box */
        .goals-contact {
            background: var(--gradient-main-pale);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            border: 1px solid var(--color-chatzer-pale);
        }

        .goals-contact-title {
            font-size: 1.25em;
            font-weight: 600;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }

        .goals-contact-text {
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .goals-contact-email {
            display: inline-block;
            padding: 12px 28px;
            background: var(--gradient-main);
            color: white;
            border-radius: 30px;
            font-size: 1.05em;
            text-decoration: none;
            transition: var(--transition-smooth);
            direction: ltr;
        }

        .goals-contact-email:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        /* Contribute Page Styles */
        .contribute-page {
            background: var(--bg-color);
        }

        .contribute-hero {
            background: var(--gradient-main);
            padding: 60px 40px;
            border-radius: 20px;
            margin-bottom: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .contribute-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }

        .contribute-hero-content {
            position: relative;
            z-index: 1;
        }

        .contribute-hero-title {
            color: white;
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .contribute-hero-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2em;
            max-width: 600px;
            margin: 0 auto;
        }

        .contribute-content {
            padding: 30px 20px 20px 20px;
        }

        .contribute-intro {
            text-align: center;
            font-size: 1.1em;
            color: var(--text-dark);
            margin-bottom: 40px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .contribute-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .contribute-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(74, 124, 201, 0.1);
            border: 1px solid rgba(74, 124, 201, 0.1);
            transition: all 0.3s ease;
        }

        .contribute-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(74, 124, 201, 0.2);
            border-color: var(--color-nigun);
        }

        .contribute-card-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .contribute-card-title {
            color: var(--color-nigun-dark);
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .contribute-card-text {
            color: var(--text-muted);
            font-size: 0.95em;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .contribute-card-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 124, 201, 0.3);
        }

        .contribute-card-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 124, 201, 0.4);
        }

        .contribute-card-btn .btn-arrow {
            transition: transform 0.3s ease;
        }

        .contribute-card-btn:hover .btn-arrow {
            transform: translateX(-5px);
        }

        .contribute-contact {
            text-align: center;
            background: linear-gradient(135deg, rgba(74, 124, 201, 0.05) 0%, rgba(74, 124, 201, 0.1) 100%);
            padding: 40px;
            border-radius: 16px;
            border: 1px solid rgba(74, 124, 201, 0.15);
        }

        .contribute-contact-title {
            color: var(--text-dark);
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .contribute-email {
            display: inline-block;
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1em;
            text-decoration: none;
            direction: ltr;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 124, 201, 0.3);
        }

        .contribute-email:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(74, 124, 201, 0.4);
        }

        /* Main Nigun Button - Largest */
        .contribute-main-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 25px 40px;
            border-radius: 16px;
            text-decoration: none;
            font-size: 1.4em;
            font-weight: 600;
            color: white;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .contribute-main-btn .btn-external {
            transition: transform 0.3s ease;
            font-size: 1.2em;
        }

        .contribute-main-btn:hover .btn-external {
            transform: translate(3px, -3px);
        }

        .contribute-btn-main-gradient {
            background: linear-gradient(135deg, var(--color-nigun) 0%, var(--color-nigun-dark) 100%);
            box-shadow: 0 6px 25px rgba(74, 124, 201, 0.4);
        }

        .contribute-btn-main-gradient:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 35px rgba(74, 124, 201, 0.5);
        }

        /* External arrow for all buttons */
        .btn-external {
            transition: transform 0.3s ease;
            opacity: 0.9;
        }

        .contribute-btn:hover .btn-external {
            transform: translate(3px, -3px);
            opacity: 1;
        }

        /* Gezungen color for piyut */
        .contribute-btn-gezungen {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            box-shadow: 0 4px 15px rgba(245, 124, 0, 0.3);
        }

        .contribute-btn-gezungen:hover {
            box-shadow: 0 6px 25px rgba(245, 124, 0, 0.4);
        }

        /* Category Buttons Grid */
        .contribute-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .contribute-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 500;
            color: white;
            transition: all 0.3s ease;
            text-align: center;
        }

        .contribute-btn-icon {
            font-size: 1.3em;
        }

        .contribute-btn-text {
            text-align: center;
        }

        .contribute-btn .btn-arrow {
            transition: transform 0.3s ease;
            opacity: 0.8;
        }

        .contribute-btn:hover .btn-arrow {
            transform: translateX(-5px);
            opacity: 1;
        }

        .contribute-btn:hover {
            transform: translateY(-3px);
        }

        /* Category-specific colors */
        .contribute-btn-mechaber {
            background: linear-gradient(135deg, var(--color-mechaber) 0%, var(--color-mechaber-dark) 100%);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .contribute-btn-mechaber:hover {
            box-shadow: 0 6px 25px rgba(34, 197, 94, 0.4);
        }

        .contribute-btn-chatzer {
            background: linear-gradient(135deg, var(--color-chatzer) 0%, var(--color-chatzer-dark) 100%);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .contribute-btn-chatzer:hover {
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.4);
        }

        .contribute-btn-verter {
            background: linear-gradient(135deg, var(--color-verter) 0%, var(--color-verter-dark) 100%);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
        }

        .contribute-btn-verter:hover {
            box-shadow: 0 6px 25px rgba(236, 72, 153, 0.4);
        }

        .contribute-btn-zman {
            background: linear-gradient(135deg, var(--color-zman) 0%, var(--color-zman-dark) 100%);
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }

        .contribute-btn-zman:hover {
            box-shadow: 0 6px 25px rgba(249, 115, 22, 0.4);
        }

        .contribute-btn-piyut {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .contribute-btn-piyut:hover {
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
        }

        .contribute-btn-collection {
            background: linear-gradient(135deg, var(--color-collection) 0%, var(--color-collection-dark) 100%);
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3);
        }

        .contribute-btn-collection:hover {
            box-shadow: 0 6px 25px rgba(20, 184, 166, 0.4);
        }

        /* Extra Section */
        .contribute-extra-section {
            margin-bottom: 40px;
        }

        .contribute-section-title {
            color: var(--text-dark);
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .contribute-extra-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .contribute-btn-resource {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        .contribute-btn-resource:hover {
            box-shadow: 0 6px 25px rgba(14, 165, 233, 0.4);
        }

        .contribute-btn-document {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        }

        .contribute-btn-document:hover {
            box-shadow: 0 6px 25px rgba(100, 116, 139, 0.4);
        }

        .contribute-btn-album {
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
        }

        .contribute-btn-album:hover {
            box-shadow: 0 6px 25px rgba(168, 85, 247, 0.4);
        }

        /* Terms Link */
        .contribute-terms {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
        }

        .contribute-terms-link {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9em;
            transition: color 0.3s ease;
        }

        .contribute-terms-link:hover {
            color: var(--color-nigun);
        }

        @media (max-width: 768px) {
            .contribute-hero {
                padding: 40px 20px;
            }

            .contribute-hero-title {
                font-size: 1.8em;
            }

            .contribute-hero-subtitle {
                font-size: 1em;
            }

            .contribute-cards {
                grid-template-columns: 1fr;
            }

            .contribute-card {
                padding: 25px;
            }
        }

        @media (max-width: 768px) {
            .goals-brick-row {
                flex-direction: column;
            }

            .goal-brick {
                padding: 18px 20px;
            }

            .goals-warning,
            .goals-contact {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-main">
            <a class="logo" href="#/home">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                    </svg>
                </div>
                <div class="logo-text">
                    <span class="logo-word-1">אוצר</span>
                    <span class="logo-word-2">הניגונים</span>
                </div>
            </a>

            <!-- Removed nav wrapper, elements are now direct children for better centering -->
            <div class="main-nav">
                <!-- ניגונים - Standalone (no children) -->
                <a class="nav-btn nav-nigunim" href="#/nigunim">ניגונים</a>

                <!-- מחברים - with children: מחברים, חצרות -->
                <div class="nav-dropdown">
                    <a class="nav-dropdown-btn nav-mechaber" href="#/mechabrim">
                        מחברים
                        <span class="nav-arrow">▾</span>
                    </a>
                    <div class="nav-dropdown-content">
                        <div class="dropdown-inner">
                            <a class="nav-dropdown-item" data-dest="mechabrim" href="#/mechabrim">
                                <span>מחברים</span>
                            </a>
                            <a class="nav-dropdown-item" data-dest="chatzeros" href="#/chatzeros">
                                <span>חצרות</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- ווערטער - with children: ווערטער, ריטעם -->
                <div class="nav-dropdown">
                    <a class="nav-dropdown-btn nav-verter" href="#/verter">
                        ווערטער
                        <span class="nav-arrow">▾</span>
                    </a>
                    <div class="nav-dropdown-content">
                        <div class="dropdown-inner">
                            <a class="nav-dropdown-item" data-dest="verter" href="#/verter">
                                <span>ווערטער</span>
                            </a>
                            <a class="nav-dropdown-item" data-dest="music" href="#/music">
                                <span>ריטעם</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- זמנים - with children: מועדים וזמנים, קאלעקשאנס, פיוטים -->
                <div class="nav-dropdown">
                    <a class="nav-dropdown-btn nav-zman" href="#/zmanim">
                        זמנים
                        <span class="nav-arrow">▾</span>
                    </a>
                    <div class="nav-dropdown-content">
                        <div class="dropdown-inner">
                            <a class="nav-dropdown-item" data-dest="zmanim" href="#/zmanim">
                                <span>מועדים וזמנים</span>
                            </a>
                            <a class="nav-dropdown-item" data-dest="collections" href="#/collections">
                                <span>קאלעקשאנס</span>
                            </a>
                            <a class="nav-dropdown-item" data-dest="piyutim" href="#/piyutim">
                                <span>פיוטים</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Divider -->
                <div class="nav-divider"></div>

                <style>
                    .nav-divider {
                        width: 4px;
                        height: 4px;
                        background: var(--gradient-main);
                        margin: 0 6px;
                        opacity: 0.6;
                        border-radius: 50%;
                    }
                </style>

                <!-- דאקומענטאציע - with children: רעסורסן, ארכיוון, אלבומס -->
                <div class="nav-dropdown">
                    <a class="nav-dropdown-btn nav-docs" href="#/resources">
                        דאקומענטאציע
                        <span class="nav-arrow">▾</span>
                    </a>
                    <div class="nav-dropdown-content">
                        <div class="dropdown-inner">
                            <a class="nav-dropdown-item" data-dest="resources" href="#/resources">
                                <span>רעסורסן</span>
                            </a>
                            <a class="nav-dropdown-item" data-dest="documents" href="#/documents">
                                <span>ארכיוון</span>
                            </a>
                            <a class="nav-dropdown-item" data-dest="albums" href="#/albums">
                                <span>אלבומס</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right side buttons wrapper - matches logo width on left -->
            <div class="header-right-buttons">
                <!-- Combined Search + Add Button -->
                <div class="header-combo-btn">
                    <button class="combo-search" onclick="openSearchModal()">
                        <svg class="combo-search-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                        </svg>
                        <span class="combo-search-text">זוך</span>
                    </button>
                    <a href="#/contribute" class="combo-add">
                        <span class="combo-add-icon">+</span>
                        <span class="combo-add-text">לייג צו</span>
                    </a>
                </div>

                <!-- Streaming Button - ball with blinking dot, expands on hover -->
                <a href="https://stream.oitzerhanigunim.org/" target="_blank" class="stream-ball-btn">
                    <span class="stream-dot"></span>
                    <span class="stream-text-new">סטרימינג</span>
                </a>
            </div>
        </div>

        <style>
            /* Sticky header with hide on scroll down, show on scroll up */
            .main-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                transition: transform 0.4s ease, opacity 0.4s ease;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.85) 0%, rgba(248, 250, 252, 0.85) 100%);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
            }

            .main-header.header-hidden {
                transform: translateY(-100%);
                opacity: 0;
            }

            /* Main content - offset for fixed header */
            .main-content {
                padding-top: 80px;
            }

            .header-main {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 30px;
                width: 100%;
                max-width: 1400px;
                margin: 0 auto;
                padding: 12px 30px;
                position: relative;
            }

            .logo {
                position: absolute;
                right: 30px;
                top: 50%;
                transform: translateY(-50%);
            }

            .main-nav {
                margin: 0;
                /* Reset margins */
            }

            .global-search-btn {
                margin-right: 0;
            }

            .header-right-buttons {
                position: absolute;
                left: 20px;
                top: 50%;
                transform: translateY(-50%);
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 10;
            }

            /* Combined Search + Add Button */
            .header-combo-btn {
                display: flex;
                align-items: stretch;
                background: var(--gradient-main);
                border-radius: 25px;
                overflow: hidden;
                box-shadow: 0 2px 12px rgba(139, 92, 246, 0.3);
                height: 40px;
                gap: 3px;
                padding: 3px;
            }

            .combo-search {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                padding: 0 16px;
                background: rgba(255, 255, 255, 0.15);
                border: none;
                border-radius: 22px;
                cursor: pointer;
                font-family: inherit;
                font-size: 0.95em;
                font-weight: 600;
                color: white;
                transition: all 0.4s ease;
                flex: 3;
                min-width: 60px;
            }

            .combo-search-icon {
                width: 16px;
                height: 16px;
                fill: white;
                opacity: 0;
                max-width: 0;
                transition: all 0.4s ease;
            }

            .combo-search-text {
                transition: all 0.4s ease;
            }

            .combo-add {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                padding: 0 12px;
                background: rgba(255, 255, 255, 0.15);
                border: none;
                border-radius: 22px;
                cursor: pointer;
                text-decoration: none;
                font-family: inherit;
                font-size: 0.95em;
                font-weight: 600;
                color: white;
                transition: all 0.4s ease;
                flex: 1;
                min-width: 36px;
            }

            .combo-add-icon {
                font-size: 1.3em;
                font-weight: 700;
                color: white;
                transition: all 0.4s ease;
            }

            .combo-add-text {
                color: white;
                opacity: 0;
                max-width: 0;
                overflow: hidden;
                white-space: nowrap;
                transition: all 0.4s ease;
            }

            /* Hover on Search - expands to show icon */
            .header-combo-btn:hover .combo-search:hover {
                flex: 10;
                background: rgba(255, 255, 255, 0.25);
            }

            .header-combo-btn:hover .combo-search:hover .combo-search-icon {
                opacity: 1;
                max-width: 20px;
            }

            .header-combo-btn:hover .combo-search:hover~.combo-add {
                flex: 0;
                padding: 0;
                min-width: 0;
                opacity: 0;
            }

            /* Hover on Add - expands to show text */
            .header-combo-btn:hover .combo-add:hover {
                flex: 10;
                padding: 0 16px;
                background: rgba(255, 255, 255, 0.25);
            }

            .header-combo-btn:hover .combo-add:hover .combo-add-text {
                opacity: 1;
                max-width: 80px;
            }

            .header-combo-btn:has(.combo-add:hover) .combo-search {
                flex: 0;
                padding: 0;
                min-width: 0;
                opacity: 0;
            }

            /* Logo hover effect with fade both ways */
            .logo {
                transition: all 0.4s ease;
            }

            .logo-icon,
            .logo-text {
                transition: filter 0.4s ease, transform 0.4s ease;
            }

            .logo:hover .logo-icon {
                filter: drop-shadow(0 2px 8px rgba(156, 91, 181, 0.4));
            }

            .logo:hover .logo-text {
                filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.15));
            }

            /* Search button styled like logo */
            .global-search-btn {
                display: flex;
                align-items: center;
                gap: 8px;
                background: transparent;
                border: none;
                cursor: pointer;
                padding: 0;
                transition: all 0.4s ease;
            }

            .search-icon {
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .search-icon svg {
                width: 100%;
                height: 100%;
                fill: url(#search-gradient);
            }

            .search-text {
                font-size: 1.1em;
                font-weight: 700;
                background: var(--gradient-main);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .global-search-btn:hover {
                opacity: 0.8;
            }
        </style>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Content will be rendered by JavaScript -->
    </main>

    <!-- Search Modal -->
    <div class="search-modal-overlay" id="searchModalOverlay" onclick="closeSearchModal()">
        <div class="search-modal" onclick="event.stopPropagation()">
            <div class="search-modal-header">
                <h3>🔍 זוך אין אוצר הניגונים</h3>
                <button class="search-modal-close" onclick="closeSearchModal()">×</button>
            </div>
            <div class="search-modal-body">
                <input type="text" id="searchModalInput" class="search-modal-input"
                    placeholder="זוך א ניגון, מחבר, חצר..."
                    onkeydown="if(event.key==='Enter') executeSearchFromModal()">
                <button class="search-modal-btn" onclick="executeSearchFromModal()">זוך</button>
            </div>
        </div>
    </div>

    <!-- Player -->
    <div class="player-section">
        <!-- SVG Gradient Definition for play button -->
        <svg width="0" height="0" style="position:absolute">
            <defs>
                <linearGradient id="playerBtnGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:var(--color-nigun);stop-opacity:1" />
                    <stop offset="50%" style="stop-color:var(--color-chatzer);stop-opacity:1" />
                    <stop offset="100%" style="stop-color:var(--color-mechaber);stop-opacity:1" />
                </linearGradient>
            </defs>
        </svg>
        <!-- Minimized state play/pause button -->
        <button class="minimized-play-btn" id="minimizedPlayBtn" onclick="event.stopPropagation(); togglePlayPause();"
            title="פלעי/פויז">
            <span class="mini-play-icon"><svg viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z" />
                </svg></span>
            <span class="mini-pause-icon"><svg viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M9 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zM13 7v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z" />
                </svg></span>
        </button>
        <!-- Minimized state song name (for marquee) -->
        <div class="minimized-song-name" id="minimizedSongName"></div>
        <div class="player-inner">
            <!-- Right Side Area -->
            <div class="player-right-area">
                <div class="player-song-info-wrapper">
                    <!-- Row 1: Song Name -->
                    <div class="player-right-song-name" id="playerRightSongName" onclick="openCurrentSongDetails()">
                    </div>
                    <!-- Row 2: Info carousel (right) + Rating (left) -->
                    <div class="player-bottom-row">
                        <!-- Info Carousel - Right Side -->
                        <div class="player-info-carousel" id="playerInfoCarousel">
                            <div class="carousel-item carousel-recording active" id="carouselRecording">
                                <span class="player-recording-name" id="playerRecordingName"></span>
                            </div>
                            <div class="carousel-item carousel-personality" id="carouselPersonality">
                                <span class="player-personality-tag" id="playerPersonalityTag"></span>
                            </div>
                            <div class="carousel-item carousel-album" id="carouselAlbum">
                                <span class="player-album-tag" id="playerAlbumTag"></span>
                            </div>
                        </div>
                        <!-- Rating Stars - Left Side -->
                        <div class="player-rating" id="playerRating" title="אודיאו קוואליטעט">
                            <span class="player-rating-stars" id="playerRatingStars"></span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Player Controls (Center - absolutely positioned) -->
            <div class="player-controls">
                <button class="player-btn" onclick="playPrevious()" title="פריערדיגע"><svg viewBox="0 0 24 24"
                        fill="currentColor" width="18" height="18">
                        <path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z" />
                    </svg></button>
                <button class="player-btn main" id="playPauseBtn" onclick="togglePlayPause()">
                    <div class="player-btn-bg"></div>
                    <span class="player-play-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="42" height="42">
                            <path
                                d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z" />
                        </svg></span>
                    <span class="player-pause-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="42" height="42">
                            <path
                                d="M9 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zM13 7v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z" />
                        </svg></span>
                </button>
                <button class="player-btn" onclick="playNext()" title="קומענדיגע"><svg viewBox="0 0 24 24"
                        fill="currentColor" width="18" height="18">
                        <path d="M16 18h2V6h-2v12zM6 6v12l8.5-6L6 6z" />
                    </svg></button>
            </div>
            <!-- Progress Bar -->
            <div class="player-progress" id="progressBarContainer" onclick="seekTo(event)">
                <div class="progress-bar-container">
                    <div class="progress-bar-visual-bg">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>
            <!-- Song Info (Left) - Mechaber, Tags in organized rows -->
            <div class="player-info">
                <!-- Row 1: Mechaber -->
                <div class="player-mechaber-row">
                    <a class="player-mechaber-profile" id="playerMechaberProfile" style="display: none;">
                        <div class="player-mechaber-avatar" id="playerMechaberAvatar">
                            <div class="placeholder"><span class="mechaber-icon"></span></div>
                        </div>
                        <div class="player-mechaber-name" id="playerMechaberName"></div>
                    </a>
                </div>
                <!-- Row 2: Chatzer + Gezingen -->
                <div class="player-tags-row" id="playerTagsRow1"></div>
                <!-- Row 3: Verter + Pasig -->
                <div class="player-tags-row" id="playerTagsRow2"></div>
                <!-- Row 4: Collections + Rhythm + Scale -->
                <div class="player-tags-row" id="playerTagsRow3"></div>
                <!-- Keep old container for backwards compatibility (hidden) -->
                <div class="player-tags" id="playerTags" style="display: none;"></div>
            </div>
        </div>
        <audio id="audioPlayer"></audio>
    </div>

    <!-- Hover Tooltip -->
    <a class="hover-tooltip" id="hoverTooltip" href="#" data-tooltip-category="" data-tooltip-id="">
        <div class="hover-tooltip-type" id="tooltipType">חצר</div>
        <div class="hover-tooltip-header">
            <img class="hover-tooltip-image" id="tooltipImage" src="" alt="" style="display: none;">
            <div class="hover-tooltip-title-area">
                <div class="hover-tooltip-title" id="tooltipTitle">טייטל</div>
                <div class="hover-tooltip-subtitle" id="tooltipSubtitle"></div>
            </div>
        </div>
        <div class="hover-tooltip-stats" id="tooltipStats"></div>
    </a>

    <!-- Song Details Modal -->
    <div class="modal" id="songModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">דעטאלן</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Nigun Modal Overlay (Lightbox) -->
    <div class="nigun-modal-overlay" id="nigunModalOverlay" onclick="if(event.target === this) closeNigunModal()">
        <div class="nigun-modal-content">
            <!-- Floating music notes background -->
            <div class="nigun-modal-notes" id="nigunModalNotes"></div>

            <button class="nigun-modal-report" onclick="event.stopPropagation(); openReportModal()"
                title="רעפארט א פראבלעם">!</button>
            <button class="nigun-modal-addinfo" onclick="event.stopPropagation(); openAddInfoModal()"
                title="לייג צו אינפארמאציע">+</button>
            <button class="nigun-modal-expand" onclick="event.stopPropagation(); expandToFullPage()"
                title="עקספענד צו פולע בלאט">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <polyline points="9 21 3 21 3 15"></polyline>
                    <line x1="21" y1="3" x2="14" y2="10"></line>
                    <line x1="3" y1="21" x2="10" y2="14"></line>
                </svg>
            </button>
            <button class="nigun-modal-close" onclick="event.stopPropagation(); closeNigunModal()">×</button>
            <div id="nigunModalBody"></div>
        </div>
    </div>

    <!-- Combined Add Info / Report Modal -->
    <div class="addinfo-modal-overlay" id="addinfoModalOverlay" onclick="if(event.target === this) closeAddInfoModal()">
        <div class="addinfo-modal-content" onclick="event.stopPropagation()">
            <div class="addinfo-modal-header">
                <button class="addinfo-modal-close" onclick="closeAddInfoModal()">×</button>
                <div class="addinfo-modal-toggle">
                    <button class="addinfo-modal-toggle-btn" data-panel="addnigun"
                        onclick="switchModalPanel('addnigun')">לייג צו א ניגון</button>
                    <button class="addinfo-modal-toggle-btn active" data-panel="addinfo"
                        onclick="switchModalPanel('addinfo')">לייג צו אינפארמאציע</button>
                    <button class="addinfo-modal-toggle-btn" data-panel="report"
                        onclick="switchModalPanel('report')">רעפארט א פראבלעם</button>
                </div>
                <div class="addinfo-modal-song-name" id="addinfoSongName"></div>
                <!-- Nigun Name Input in header (only for Add Nigun panel) -->
                <div class="addnigun-name-header-wrapper" id="addnigunNameHeader" style="display: none;">
                    <input type="text" id="addnigun-name" class="addnigun-name-input" placeholder="נאמען פונעם ניגון"
                        required autocomplete="off">
                    <div class="addnigun-name-error" id="addnigun-name-error"></div>
                </div>
            </div>
            <div class="addinfo-modal-body">
                <!-- Add Nigun Panel -->
                <div class="addinfo-panel" id="addnigunPanel">

                    <!-- Section 1: מחבר און פערזענליכקייטן -->

                    <!-- Section 2: מחבר און פערזענליכקייטן -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">מחבר און פערזענליכקייטן</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="mechabrim" data-multi="false">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-mechaber"
                                        placeholder="מחבר" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-mechaber-tags"></div>
                                </div>
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <div class="addinfo-autocomplete-wrapper" data-source="mechabrim" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-personalities"
                                        placeholder="פערזענליכקייטן וואס האבן געהאט א שייכות מיט דעם ניגון"
                                        autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-personalities-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: חצר און פיוט -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">חצר און פיוט</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="chatzeros" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-chatzer"
                                        placeholder="ווערט געזינגען אין חצר" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-chatzer-tags"></div>
                                </div>
                            </div>
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="piyutim" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-piyut"
                                        placeholder="אויפן פיוט" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-piyut-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: ווערטער און סימן -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">ווערטער און סימן</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="verter" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-verter"
                                        placeholder="די ווערטער פונעם ניגון" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-verter-tags"></div>
                                </div>
                            </div>
                            <div class="addinfo-field">
                                <input type="text" id="addnigun-siman" placeholder="א סימן צו געדענקען דעם ניגון">
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <div class="addinfo-autocomplete-wrapper" data-source="piyutim" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-also-piyut"
                                        placeholder="און איז אויך פאסיג צו ווערן געזינגען אויפן פיוט"
                                        autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-also-piyut-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: סקעיל, ריטעם, קאלעקשנס -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">מוזיק סטייל</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="scales" data-multi="false">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-scale"
                                        placeholder="סקעיל" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-scale-tags"></div>
                                </div>
                            </div>
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="rhythms" data-multi="false">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-rhythm"
                                        placeholder="ריטעם" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-rhythm-tags"></div>
                                </div>
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <div class="addinfo-autocomplete-wrapper" data-source="collections" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-collections"
                                        placeholder="קאלעקשנס" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-collections-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 6: דאקומענטן און אלבומס -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">דאקומענטן און אלבומס</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="documents" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-documents"
                                        placeholder="דאקומענטן וואו דער ניגון ווערט דערמאנט" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-documents-tags"></div>
                                </div>
                            </div>
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="albums" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-albums"
                                        placeholder="אלבומס וואו דער ניגון ווערט געשפילט" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-albums-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 7: אודיאו רעקארדירונג -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">אודיאו רעקארדירונג</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <div class="addinfo-file-upload"
                                    onclick="document.getElementById('addnigun-audio').click()">
                                    <input type="file" id="addnigun-audio" accept="audio/*">
                                    <div class="addinfo-file-upload-icon">🎵</div>
                                    <div class="addinfo-file-upload-text">אודיאו רעקארדירונג</div>
                                    <div class="addinfo-file-upload-hint">MP3, WAV, M4A</div>
                                </div>
                                <div class="addinfo-file-link-divider">אדער פייסט א לינק</div>
                                <input type="url" class="addinfo-file-link-input" id="addnigun-audio-link"
                                    placeholder="Google Drive / Dropbox לינק">
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-checkbox-wrapper">
                                <input type="checkbox" id="addnigun-rights-confirm">
                                <label for="addnigun-rights-confirm">I confirm that I own the rights to this recording
                                    and I
                                    accept the <a href="https://oitzerhanigunim.org/terms" target="_blank">terms of
                                        use</a>
                                    of oitzerhanigunim.org</label>
                            </div>
                        </div>
                    </div>

                    <!-- Section 8: דעטאלן פונעם רעקארדירונג -->
                    <div class="addinfo-section">
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <input type="text" id="addnigun-recording-details"
                                    placeholder="דעטאלן פונעם רעקארדירונג">
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="mechabrim" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input"
                                        id="addnigun-recording-personality"
                                        placeholder="פערזענליכקייט פונעם רעקארדירונג" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-recording-personality-tags"></div>
                                </div>
                            </div>
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="albums" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addnigun-recording-album"
                                        placeholder="אלבום פונעם רעקארדירונג" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addnigun-recording-album-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 9: ווידיאוס און בילדער -->
                    <div class="addinfo-section">
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <div class="addinfo-file-upload"
                                    onclick="document.getElementById('addnigun-files').click()">
                                    <input type="file" id="addnigun-files" multiple>
                                    <div class="addinfo-file-upload-icon">📁</div>
                                    <div class="addinfo-file-upload-text">ווידיאוס, בילדער, און אנדערע פיילס</div>
                                    <div class="addinfo-file-upload-hint">ווידיאוס, בילדער, דאקומענטן</div>
                                </div>
                                <div class="addinfo-file-link-divider">אדער פייסט א לינק</div>
                                <input type="url" class="addinfo-file-link-input" id="addnigun-files-link"
                                    placeholder="Google Drive / Dropbox לינק">
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <input type="text" id="addnigun-files-details" placeholder="דעטאלן פון דעם פייל">
                            </div>
                        </div>
                    </div>

                    <!-- Section 10: הערות -->
                    <div class="addinfo-section">
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <textarea id="addnigun-notes" placeholder="הערות / מער אינפארמאציע"></textarea>
                            </div>
                        </div>
                    </div>

                    <button class="addinfo-submit-btn" onclick="submitAddNigun()">לייג צו א ניגון</button>
                </div>

                <!-- Report Panel -->
                <div class="addinfo-panel" id="reportPanel">
                    <div class="addinfo-section">
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <select id="reportCategory" class="addinfo-select"
                                    onchange="handleReportCategoryChange()">
                                    <option value="" disabled selected hidden>רעפארט קאטעגאריע...</option>
                                    <option value="duplicate">דאפלטע ניגון</option>
                                    <option value="incorrect-info">אומריכטיגע אינפארמאציע</option>
                                    <option value="hasagat-gvul">השגת גבול</option>
                                    <option value="modern">היינטיג/מאדערן</option>
                                    <option value="other">אנדערע הערות</option>
                                </select>
                            </div>
                        </div>
                        <!-- Duplicate Nigun Selector (shown only when duplicate category is selected) -->
                        <div class="addinfo-row" id="duplicateNigunRow" style="display: none;">
                            <div class="addinfo-field full-width">
                                <div class="addinfo-autocomplete-wrapper" data-source="nigunim" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="report-duplicate-nigun"
                                        placeholder="וועל אויס מיט וועלכע ניגון עס זאל ווערן צאמגעשטעלט"
                                        autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="report-duplicate-nigun-tags"></div>
                                </div>
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <textarea id="reportDetails" placeholder="רעפארט דעטאלן..."></textarea>
                            </div>
                        </div>
                    </div>
                    <button class="addinfo-submit-btn" onclick="submitReport()">רעפארט</button>
                </div>

                <!-- Add Info Panel -->
                <div class="addinfo-panel active" id="addinfoPanel">
                    <!-- Section 1: מחבר און פערזענליכקייטן -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">מחבר און פערזענליכקייטן</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="mechabrim" data-multi="false">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-mechaber"
                                        placeholder="מחבר" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-mechaber-tags"></div>
                                </div>
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <div class="addinfo-autocomplete-wrapper" data-source="mechabrim" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-personalities"
                                        placeholder="פערזענליכקייטן וואס האבן געהאט א שייכות מיט דעם ניגון"
                                        autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-personalities-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: חצר און פיוט -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">חצר און פיוט</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="chatzeros" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-chatzer"
                                        placeholder="ווערט געזינגען אין חצר" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-chatzer-tags"></div>
                                </div>
                            </div>
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="piyutim" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-piyut"
                                        placeholder="אויפן פיוט" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-piyut-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: ווערטער און סימן -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">ווערטער און סימן</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="verter" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-verter"
                                        placeholder="די ווערטער פונעם ניגון" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-verter-tags"></div>
                                </div>
                            </div>
                            <div class="addinfo-field">
                                <input type="text" id="addinfo-siman" placeholder="א סימן צו געדענקען דעם ניגון">
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <div class="addinfo-autocomplete-wrapper" data-source="piyutim" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-also-piyut"
                                        placeholder="און איז אויך פאסיג צו ווערן געזינגען אויפן פיוט"
                                        autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-also-piyut-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: סקעיל, ריטעם, קאלעקשנס -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">מוזיק סטייל</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="scales" data-multi="false">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-scale"
                                        placeholder="סקעיל" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-scale-tags"></div>
                                </div>
                            </div>
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="rhythms" data-multi="false">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-rhythm"
                                        placeholder="ריטעם" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-rhythm-tags"></div>
                                </div>
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <div class="addinfo-autocomplete-wrapper" data-source="collections" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-collections"
                                        placeholder="קאלעקשנס" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-collections-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: דאקומענטן און אלבומס -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">דאקומענטן און אלבומס</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="documents" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-documents"
                                        placeholder="דאקומענטן וואו דער ניגון ווערט דערמאנט" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-documents-tags"></div>
                                </div>
                            </div>
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="albums" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-albums"
                                        placeholder="אלבומס וואו דער ניגון ווערט געשפילט" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-albums-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 6: אודיאו רעקארדירונג -->
                    <div class="addinfo-section">
                        <div class="addinfo-section-title">אודיאו רעקארדירונג</div>
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <div class="addinfo-file-upload"
                                    onclick="document.getElementById('addinfo-audio').click()">
                                    <input type="file" id="addinfo-audio" accept="audio/*">
                                    <div class="addinfo-file-upload-icon">🎵</div>
                                    <div class="addinfo-file-upload-text">אודיאו רעקארדירונג</div>
                                    <div class="addinfo-file-upload-hint">MP3, WAV, M4A</div>
                                </div>
                                <div class="addinfo-file-link-divider">אדער פייסט א לינק</div>
                                <input type="url" class="addinfo-file-link-input" id="addinfo-audio-link"
                                    placeholder="Google Drive / Dropbox לינק">
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-checkbox-wrapper">
                                <input type="checkbox" id="addinfo-rights-confirm">
                                <label for="addinfo-rights-confirm">I confirm that I own the rights to this recording
                                    and I
                                    accept the <a href="https://oitzerhanigunim.org/terms" target="_blank">terms of
                                        use</a>
                                    of oitzerhanigunim.org</label>
                            </div>
                        </div>
                    </div>

                    <!-- Section 7: דעטאלן פונעם רעקארדירונג -->
                    <div class="addinfo-section">
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <input type="text" id="addinfo-recording-details"
                                    placeholder="דעטאלן פונעם רעקארדירונג">
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="mechabrim" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input"
                                        id="addinfo-recording-personality" placeholder="פערזענליכקייט פונעם רעקארדירונג"
                                        autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-recording-personality-tags"></div>
                                </div>
                            </div>
                            <div class="addinfo-field">
                                <div class="addinfo-autocomplete-wrapper" data-source="albums" data-multi="true">
                                    <input type="text" class="addinfo-autocomplete-input" id="addinfo-recording-album"
                                        placeholder="אלבום פונעם רעקארדירונג" autocomplete="off">
                                    <div class="addinfo-autocomplete-dropdown"></div>
                                    <div class="addinfo-selected-tags" id="addinfo-recording-album-tags"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 8: ווידיאוס און בילדער -->
                    <div class="addinfo-section">
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <div class="addinfo-file-upload"
                                    onclick="document.getElementById('addinfo-files').click()">
                                    <input type="file" id="addinfo-files" multiple>
                                    <div class="addinfo-file-upload-icon">📁</div>
                                    <div class="addinfo-file-upload-text">ווידיאוס, בילדער, און אנדערע פיילס</div>
                                    <div class="addinfo-file-upload-hint">ווידיאוס, בילדער, דאקומענטן</div>
                                </div>
                                <div class="addinfo-file-link-divider">אדער פייסט א לינק</div>
                                <input type="url" class="addinfo-file-link-input" id="addinfo-files-link"
                                    placeholder="Google Drive / Dropbox לינק">
                            </div>
                        </div>
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <input type="text" id="addinfo-files-details" placeholder="דעטאלן פון דעם פייל">
                            </div>
                        </div>
                    </div>

                    <!-- Section 9: הערות -->
                    <div class="addinfo-section">
                        <div class="addinfo-row">
                            <div class="addinfo-field full-width">
                                <textarea id="addinfo-notes" placeholder="הערות / מער אינפארמאציע"></textarea>
                            </div>
                        </div>
                    </div>

                    <button class="addinfo-submit-btn" onclick="submitAddInfo()">לייג צו</button>
                </div>
            </div>
            <!-- Success Messages (replace modal body on success) -->
            <div class="addinfo-success-message" id="reportSuccessMessage">
                <span class="success-icon">✓</span>
                <h4>א דאנק פאר אייער רעפארט!</h4>
                <p>עס ווערט אי"ה איבערגעקוקט און פאראכטן בקרוב.</p>
            </div>
            <div class="addinfo-success-message" id="addinfoSuccessMessage">
                <span class="success-icon">✓</span>
                <h4>א דאנק פאר אייער אינפארמאציע!</h4>
                <p>עס וועט אי"ה ווערן איבערגעקוקט און צוגעלייגט בקרוב.</p>
            </div>
            <div class="addinfo-success-message" id="addnigunSuccessMessage">
                <span class="success-icon">✓</span>
                <h4>א דאנק פאר דער ניגון!</h4>
                <p>עס וועט אי"ה ווערן איבערגעקוקט און צוגעלייגט בקרוב.</p>
            </div>
        </div>

        <!-- Generic Detail Modal Overlay (for mechabrim, chatzeros, etc.) -->
        <div class="detail-modal-overlay" id="detailModalOverlay"
            onclick="if(event.target === this) closeDetailModal()">
            <div class="detail-modal-content">
                <button class="detail-modal-expand" onclick="event.stopPropagation(); expandToFullPage()"
                    title="עקספענד צו פולע בלאט">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <polyline points="9 21 3 21 3 15"></polyline>
                        <line x1="21" y1="3" x2="14" y2="10"></line>
                        <line x1="3" y1="21" x2="10" y2="14"></line>
                    </svg>
                </button>
                <button class="detail-modal-close" onclick="event.stopPropagation(); closeDetailModal()">×</button>
                <div id="detailModalBody"></div>
            </div>
        </div>

        <!-- PDF Popup -->
        <div class="pdf-popup-overlay" id="pdfPopup" onclick="closePdfPopup(event)">
            <div class="pdf-popup" onclick="event.stopPropagation()">
                <div class="pdf-popup-header">
                    <div class="pdf-popup-title" id="pdfPopupTitle">דאקומענט</div>
                    <button class="pdf-popup-close" onclick="closePdfPopup()">&times;</button>
                </div>
                <div class="pdf-popup-body">
                    <iframe id="pdfPopupFrame" src=""></iframe>
                </div>
                <div class="pdf-popup-footer">
                    <a id="pdfDownloadLink" href="" target="_blank" class="pdf-download-btn">
                        דאונלאוד PDF
                    </a>
                </div>
            </div>
        </div>

        <!-- Thank You Notification -->
        <div class="thank-you-notification" id="thankYouNotification">
            <div class="thank-you-content">
                <div class="thank-you-icon">✓</div>
                <div class="thank-you-text">א דאנק!</div>
            </div>
        </div>

        <script>
            // API Configuration
            const WORKER_URL = 'https://api.oitzerhanigunim.org/api/';
            const API_BASE = 'https://api.oitzerhanigunim.org';
            const DOC_ID = '6QcJRx7e13';

            // IndexManager localStorage keys (v2 - avoids conflicts with old CacheManager)
            const STORAGE_KEYS = {
                SONG_INDEX: 'oitzer_songIndex_v2',
                SONG_INDEX_TIMESTAMP: 'oitzer_songIndex_timestamp',
                CATEGORY_PREFIX: 'oitzer_category_',
            };
            const TABLE_ID = 'grid-YycmDjJ8pS'; // Songs table

            // Additional table IDs from Coda doc
            const MECHABRIM_TABLE_ID = 'grid-bCbfhDmi82'; // מחברים טעיבל
            const CHATZEROS_TABLE_ID = 'grid-4-KYWDJ5l9'; // חצרות טעיבל
            const VERTER_TABLE_ID = 'grid-tLcBzyh_tz'; // ווערטער טעיבל
            const PIYUTIM_TABLE_ID = 'grid-318i50N4cK'; // פיוטים טעיבל
            const ZMANIM_TABLE_ID = 'grid-K2rOGXJwjk'; // זמנים טעיבל
            const COLLECTIONS_TABLE_ID = 'grid-K7Mo-tilkg'; // קאלעקשאנס טעיבל
            const RESOURCES_TABLE_ID = 'grid-8Gfz8rXNUV'; // רעסורסן טעיבל
            const DOCUMENTS_TABLE_ID = 'grid-3wKzDnkPg-'; // דאקומענטן טעיבל
            const ALBUMS_TABLE_ID = 'grid-bbTaa18Jhx'; // אלבומס טעיבל
            const SCALE_TABLE_ID = 'grid-3zCbdOmk4G'; // סקעיל טעיבל
            const RHYTHM_TABLE_ID = 'grid-26264o7G_r'; // ריטעם טעיבל
            const STATS_TABLE_ID = 'table-CbrETqO5E9'; // סטעטיסטיקס טעיבל
            const RECORDINGS_TABLE_ID = 'grid-jWWLn52ryG'; // רעקארדינגס טעיבל

            // Stats column IDs (exact IDs from Coda)
            const STATS_COLS = {
                niggunim: 'c-3wC2msD8Ll',
                mechabrim: 'c-5u6KHT3ZLF',
                verter: 'c-IadpFStSEK',
                chatzeros: 'c-i--tHnlwAu',
                zmanim: 'c-ZFj4le3Q0t',
                piyutim: 'c-0X_OHjkDDx',
                collections: 'c-Y9SNk0BOGV'
            };

            // Recording slots configuration - DEPRECATED: Now using separate recordings table
            // Rating column for recordings table: c-WqeOGhwKvu

            // Rating descriptions for each star level
            const RATING_DESCRIPTIONS = {
                1: 'א מענטש זינגט פאר זיך',
                2: 'אראפגעזינגען אן מוזיק',
                3: 'אלטע מוזיק',
                4: 'שיין און ניי',
                5: 'שיין, ניי און געשמאק'
            };

            // Track playback time for rating prompt
            let playbackTimer = null;
            let hasShownRatingPrompt = false;

            // Cached statistics from stats table
            let cachedStats = {
                niggunim: 0,
                mechabrim: 0,
                verter: 0,
                chatzeros: 0,
                zmanim: 0,
                piyutim: 0,
                collections: 0
            };

            // Track which category data has been loaded
            let loadedCategories = {
                chatzeros: false,
                mechabrim: false,
                verter: false,
                zmanim: false,
                piyutim: false,
                collections: false,
                resources: false,
                documents: false,
                albums: false,
                songs: false
            };

            // Recordings indexed by nigun ID (fetched from separate table)
            let recordingsByNigunId = {};

            // Nigun modal state (defined early for event handlers)
            let nigunModalOpen = false;
            let savedScrollPosition = 0;
            let currentNigunModalIdx = null;

            // Modal stacking system - tracks open modals for proper z-index management
            let modalStack = []; // Array of { type: 'nigun'|'detail', zIndex: number }
            let modalZIndexCounter = 10000; // Starting z-index for modals

            // Helper to escape quotes for HTML attributes (converts " to &quot;)
            function escapeHtml(str) {
                if (!str) return '';
                return String(str).replace(/"/g, '&quot;');
            }

            // Helper for singular/plural labels
            function pluralize(count, singular, plural) {
                return count === 1 ? `${count} ${singular}` : `${count} ${plural}`;
            }

            // Global event delegation for handling clicks with special characters
            // This replaces the old escapeAttr/decodeAttr approach that had issues with quotes
            document.addEventListener('click', (e) => {
                // Handle navigate to detail
                const detailEl = e.target.closest('[data-action="detail"]');
                if (detailEl) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Close nigun modal if open before navigating
                    if (nigunModalOpen) {
                        nigunModalOpen = false;
                        currentNigunModalIdx = null;
                        document.getElementById('nigunModalOverlay').classList.remove('active');
                        document.body.style.overflow = '';
                    }
                    navigateToDetail(detailEl.dataset.category, detailEl.dataset.name);
                    return;
                }

                // Handle navigate with filter
                const filterEl = e.target.closest('[data-action="filter"]');
                if (filterEl) {
                    e.stopPropagation();
                    e.preventDefault();
                    // Close nigun modal if open before navigating
                    if (nigunModalOpen) {
                        nigunModalOpen = false;
                        currentNigunModalIdx = null;
                        document.getElementById('nigunModalOverlay').classList.remove('active');
                        document.body.style.overflow = '';
                    }
                    navigateToWithFilter(filterEl.dataset.page, filterEl.dataset.filterKey, filterEl.dataset.value);
                    if (filterEl.dataset.closeModal === 'true') {
                        closeModal();
                    }
                    return;
                }

                // Handle navigate to zman detail
                const zmanEl = e.target.closest('[data-action="zman-detail"]');
                if (zmanEl) {
                    e.stopPropagation();
                    navigateToZmanDetail(zmanEl.dataset.name);
                    return;
                }

                // Handle play collection
                const playColEl = e.target.closest('[data-action="play-collection"]');
                if (playColEl) {
                    e.stopPropagation();
                    playCollectionFromStart(playColEl.dataset.name);
                    return;
                }

                // Handle play music category
                const playMusicEl = e.target.closest('[data-action="play-music"]');
                if (playMusicEl) {
                    e.stopPropagation();
                    playMusicCategory(playMusicEl.dataset.categoryType, playMusicEl.dataset.name);
                    return;
                }

                // Handle show all scale songs
                const scaleMoreEl = e.target.closest('[data-action="scale-more"]');
                if (scaleMoreEl) {
                    e.stopPropagation();
                    showAllScaleSongs(scaleMoreEl.dataset.ritem, scaleMoreEl.dataset.scale);
                    return;
                }
            });

            // Global event delegation for tooltips
            document.addEventListener('mouseenter', (e) => {
                if (!(e.target instanceof Element)) return;
                const tooltipEl = e.target.closest('[data-tooltip-value]');
                if (tooltipEl) {
                    showTooltip(e, tooltipEl.dataset.tooltipValue, tooltipEl.dataset.tooltipType);
                }
            }, true);

            document.addEventListener('mouseleave', (e) => {
                if (!(e.target instanceof Element)) return;
                const tooltipEl = e.target.closest('[data-tooltip-value]');
                if (tooltipEl) {
                    hideTooltip();
                }
            }, true);

            // Hide tooltip immediately when clicking on links or navigating
            document.addEventListener('click', (e) => {
                if (!(e.target instanceof Element)) return;
                const clickedElement = e.target.closest('[data-tooltip-value]');
                if (clickedElement) {
                    forceHideTooltip();

                    // Check if it's a piyut tooltip click - navigate to piyut detail page
                    const tooltipType = clickedElement.getAttribute('data-tooltip-type');
                    const tooltipValue = clickedElement.getAttribute('data-tooltip-value');

                    if (tooltipType === 'zman' && tooltipValue && piyutimInfo[tooltipValue]) {
                        // This is a piyut, navigate to piyutim detail page
                        const piyutId = piyutimInfo[tooltipValue].customId || tooltipValue;
                        e.preventDefault();
                        e.stopPropagation();
                        window.location.hash = `#/piyutim/${encodeURIComponent(piyutId)}`;
                    }
                }
            }, true);

            // Hide tooltip when page visibility changes or before unload
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    forceHideTooltip();
                }
            });

            window.addEventListener('beforeunload', () => {
                forceHideTooltip();
            });

            // --- Musical Notes Loader Helpers ---
            function getTinyLoaderHTML() {
                const notes = ['♪', '♫', '♬', '♩', '♭', '♮', '♯'];
                // Pick 3 random distinct notes
                const shuffled = [...notes].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, 3);

                return `
                <div class="loader-tiny">
                    <span class="note n1">${selected[0]}</span>
                    <span class="note n2">${selected[1]}</span>
                    <span class="note n3">${selected[2]}</span>
                </div>
            `;
            }

            function getMediumLoaderHTML() {
                const notes = ['♪', '♫', '♬', '♩', '♭', '♮', '♯'];
                const shuffled = [...notes].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, 3);

                return `
                <div class="loader-medium">
                    <span class="note n1" style="font-size: 28px;">${selected[0]}</span>
                    <span class="note n2" style="font-size: 34px;">${selected[1]}</span>
                    <span class="note n3" style="font-size: 30px;">${selected[2]}</span>
                </div>
            `;
            }

            // Continuous Symbol Randomization
            // Listen for the end of each animation cycle (when note is invisible)
            // and swap the text content to a new random note.
            document.addEventListener('animationiteration', (e) => {
                // Check if it's a note element
                if (e.target.classList && e.target.classList.contains('note')) {
                    // 1. Random Symbol
                    const notes = ['♪', '♫', '♬', '♩', '♭', '♮', '♯'];
                    const randomNote = notes[Math.floor(Math.random() * notes.length)];
                    e.target.innerText = randomNote;

                    // 2. Random Trajectory
                    const isMedium = e.target.closest('.loader-medium');
                    const types = ['Left', 'Right', 'Center'];
                    const randomType = types[Math.floor(Math.random() * types.length)];

                    const prefix = isMedium ? 'floatMedium' : 'floatTiny';
                    const newAnimName = prefix + randomType;

                    // Update animation name to shift path
                    e.target.style.animationName = newAnimName;
                    // Critical: Prevent delay from re-applying on new animation
                    e.target.style.animationDelay = '0s';
                }
            }, true);

            // State
            let allSongs = [];
            let filteredSongs = [];
            let currentPage = 1;
            const songsPerPage = 50; // 50 items per batch for infinite scroll
            let currentSongIndex = -1;

            // Lazy loading state for songs page
            let songsLazyState = {
                currentIndex: 0,
                batchSize: 50,
                isLoading: false,
                isInitialLoad: true  // Track if this is the first batch (for animations)
            };
            let currentPlaylist = []; // Track which songs are in current playlist
            let currentPlaylistPosition = -1; // Position within playlist
            let currentRecordingIndex = 0; // Track which recording of current song is playing
            let currentPlayingRecordingInfo = null; // Track current recording info for rating: { songIdx, recordingIdx, slotIndex, rowId }
            let isInRecordingsMode = false; // Are we navigating between recordings or songs?
            let playerVisible = false; // Track if player banner is visible
            let currentPageView = 'home';
            let searchQuery = ''; // Search query for songs

            let currentSortOrder = 'random'; // Sort order: 'random', 'alphabetical', 'recent'
            let currentDisplayMode = 'minimal'; // Display mode: 'minimal', 'recordings', 'full'
            let minQualityRating = 0; // Minimum quality rating (0-5, 0 = all)
            let recordingsCollapsed = false; // Collapse recordings in full mode (show only first)
            let songsFullyLoaded = false; // Track if ALL songs are loaded from API (not just first batch)
            let seenSongIds = new Set(); // Track song IDs from previous batches for FLIP animation
            let isFlipping = false; // Block loadMoreSongs during FLIP animation

            // Category page state (for mechabrim/chatzeros/verter with display/sort controls)
            // Per-category display modes and sort orders so each page keeps its own settings
            let categoryDisplayModes = {
                mechabrim: 'cards',
                chatzeros: 'cards',
                verter: 'cards'
            };
            let categorySortOrders = {
                mechabrim: 'years',
                chatzeros: 'alphabetical',
                verter: 'alphabetical'
            };
            let categorySearchQuery = ''; // Search query for category pages
            let currentCategoryKey = null; // Track current category for search updates

            // Category data
            let categories = {
                chatzeros: {},
                mechabrim: {},
                verter: {},
                zmanim: {},
                collections: {},
                scale: {},
                ritem: {},
                gezungen: {}
            };

            // Extended info for all categories (from separate tables)
            let chatzerosInfo = {};
            let mechabrimInfo = {};
            let verterInfo = {};
            let zmaninInfo = {};
            let piyutimInfo = {};
            let collectionsInfo = {};
            let resourcesInfo = {};
            let documentsInfo = {};
            let albumsInfo = {};
            let scaleInfo = {};
            let rhythmInfo = {};

            // --- Helper: Generate tiny random loader HTML ---
            function getTinyLoaderHTML() {
                const notes = ['♪', '♫', '♬', '♩', '♭', '♮', '♯'];
                // Pick 3 random distinct notes
                const shuffled = [...notes].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, 3);

                // Assign classes n1, n2, n3 for CSS-driven randomness
                return `
                <div class="loader-tiny">
                    <span class="note n1">${selected[0]}</span>
                    <span class="note n2">${selected[1]}</span>
                    <span class="note n3">${selected[2]}</span>
                </div>
            `;
            }

            function getMediumLoaderHTML() {
                const notes = ['♪', '♫', '♬', '♩', '♭', '♮', '♯'];
                const shuffled = [...notes].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, 3);

                return `
                <div class="loader-medium">
                    <span class="note n1" style="font-size: 28px;">${selected[0]}</span>
                    <span class="note n2" style="font-size: 34px;">${selected[1]}</span>
                    <span class="note n3" style="font-size: 30px;">${selected[2]}</span>
                </div>
            `;
            }

            // Active filters for all-songs view
            let activeFilters = {
                chatzer: [],
                mechaber: [],
                verter: [],
                zman: [],
                collection: [],
                scale: [],
                ritem: [],
                gezungen: [],
                maure: []
            };

            // ========================================
            // INDEX MANAGER - Slim index approach
            // Replaces CacheManager for efficient data loading
            // ========================================

            const IndexManager = {
                songIndex: null,           // Array of songs from index
                songMap: null,             // Map for quick lookup by id
                recordingsIndex: null,     // Object keyed by songId (MEMORY ONLY)
                categoryIndexes: {},       // Cached category data
                lastUpdated: null,
                isLoading: false,
                recordingsLoaded: false,

                // Loading state promises (prevent duplicate fetches)
                _songIndexPromise: null,
                _recordingsPromise: null,

                // Loading states for UI
                songIndexLoading: false,
                recordingsLoading: false,
                modalLoading: false,
                categoryLoading: false,

                // Check if we need to refresh from server
                async checkForUpdates() {
                    try {
                        const response = await fetch(`${API_BASE}/api/last-updated`);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await response.json();
                        const serverTimestamp = data.lastUpdated;

                        const localTimestamp = localStorage.getItem(STORAGE_KEYS.SONG_INDEX_TIMESTAMP);

                        if (!localTimestamp || localTimestamp < serverTimestamp) {
                            console.log('Server has newer data, will refresh');
                            return true;
                        }

                        console.log('Local data is up to date');
                        return false;
                    } catch (error) {
                        console.error('Error checking for updates:', error);
                        return true; // Refresh on error to be safe
                    }
                },

                // Load song index (from localStorage or API)
                async loadSongIndex() {
                    if (this.songIndex) return this.songIndex;
                    if (this._songIndexPromise) return this._songIndexPromise;

                    this.songIndexLoading = true;
                    this._songIndexPromise = this._doLoadSongIndex();

                    try {
                        return await this._songIndexPromise;
                    } finally {
                        this.songIndexLoading = false;
                        this._songIndexPromise = null;
                    }
                },

                async _doLoadSongIndex() {
                    // Stale-while-revalidate: return cached data immediately, refresh in background
                    const cached = localStorage.getItem(STORAGE_KEYS.SONG_INDEX);
                    if (cached) {
                        try {
                            const parsed = JSON.parse(cached);
                            if (parsed && parsed.length > 0) {
                                this.songIndex = parsed;
                                this._buildSongMap();
                                console.log(`Loaded ${this.songIndex.length} songs from localStorage`);

                                // Background: check for updates and refresh if needed
                                this._refreshSongIndexInBackground();

                                return this.songIndex;
                            }
                        } catch (e) {
                            console.error('Error parsing cached song index:', e);
                        }
                    }

                    // No cache available - must fetch from API (blocking)
                    console.log('Fetching song index from API (no cache)...');
                    const response = await fetch(`${API_BASE}/api/song-index`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();

                    this.songIndex = data.songs || [];
                    this.lastUpdated = data.lastUpdated;
                    this._buildSongMap();

                    // Store in localStorage
                    this._saveSongIndexToCache(data);

                    console.log(`Song index loaded: ${this.songIndex.length} songs`);
                    return this.songIndex;
                },

                // Background refresh: check for updates and re-fetch if server has newer data
                async _refreshSongIndexInBackground() {
                    try {
                        const needsRefresh = await this.checkForUpdates();
                        if (!needsRefresh) return;

                        console.log('Refreshing song index from API...');
                        const response = await fetch(`${API_BASE}/api/song-index`);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await response.json();

                        const newSongs = data.songs || [];
                        if (newSongs.length > 0) {
                            this.songIndex = newSongs;
                            this.lastUpdated = data.lastUpdated;
                            this._buildSongMap();
                            this._saveSongIndexToCache(data);

                            console.log(`Song index refreshed in background: ${this.songIndex.length} songs`);

                            // Update allSongs with the fresh data
                            populateAllSongsFromIndex(this.songIndex);
                        }
                    } catch (error) {
                        console.error('Background song index refresh failed (not critical):', error);
                    }
                },

                // Save song index to localStorage
                _saveSongIndexToCache(data) {
                    try {
                        localStorage.setItem(STORAGE_KEYS.SONG_INDEX, JSON.stringify(this.songIndex));
                        localStorage.setItem(STORAGE_KEYS.SONG_INDEX_TIMESTAMP, data.lastUpdated);
                        console.log(`Cached ${this.songIndex.length} songs in localStorage`);
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            this._clearOldStorage();
                            try {
                                localStorage.setItem(STORAGE_KEYS.SONG_INDEX, JSON.stringify(this.songIndex));
                                localStorage.setItem(STORAGE_KEYS.SONG_INDEX_TIMESTAMP, data.lastUpdated);
                            } catch (e2) {
                                console.error('Failed to cache song index even after cleanup');
                            }
                        }
                    }
                },

                // Build map for quick lookups by id and rowId
                _buildSongMap() {
                    this.songMap = new Map();
                    if (this.songIndex) {
                        this.songIndex.forEach((song, idx) => {
                            if (song.id) this.songMap.set(String(song.id), { song, idx });
                            if (song.rowId) this.songMap.set(song.rowId, { song, idx });
                        });
                    }
                },

                // Load recordings index (always from API, store in memory only)
                async loadRecordingsIndex() {
                    if (this.recordingsLoaded) return this.recordingsIndex;
                    if (this._recordingsPromise) return this._recordingsPromise;

                    this.recordingsLoading = true;
                    this._recordingsPromise = this._doLoadRecordingsIndex();

                    try {
                        return await this._recordingsPromise;
                    } finally {
                        this.recordingsLoading = false;
                        this._recordingsPromise = null;
                    }
                },

                async _doLoadRecordingsIndex() {
                    try {
                        console.log('Fetching recordings index from API...');
                        const response = await fetch(`${API_BASE}/api/recordings-index`);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await response.json();

                        this.recordingsIndex = data.recordings || {};
                        this.recordingsLoaded = true;

                        console.log(`Recordings index loaded for ${Object.keys(this.recordingsIndex).length} songs`);
                        return this.recordingsIndex;
                    } catch (error) {
                        console.error('Error loading recordings index:', error);
                        this.recordingsIndex = {};
                        return this.recordingsIndex;
                    }
                },

                // Get song by ID from index (by customId or rowId)
                getSong(id) {
                    if (!this.songMap) return null;
                    const entry = this.songMap.get(String(id));
                    return entry ? entry.song : null;
                },

                // Get full song details from API (for modal)
                async getFullSongDetails(rowId) {
                    try {
                        this.modalLoading = true;
                        const response = await fetch(`${API_BASE}/api/song/${rowId}`);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return await response.json();
                    } catch (error) {
                        console.error('Error fetching full song details:', error);
                        return null;
                    } finally {
                        this.modalLoading = false;
                    }
                },

                // Get recordings for a song from memory index
                getRecordings(songId) {
                    if (!this.recordingsIndex) return null;
                    return this.recordingsIndex[String(songId)] || null;
                },

                // Get single recording by rowId (fallback when index not loaded)
                async getRecordingByRowId(rowId) {
                    try {
                        const response = await fetch(`${API_BASE}/api/recording/${rowId}`);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return await response.json();
                    } catch (error) {
                        console.error('Error fetching recording:', error);
                        return null;
                    }
                },

                // Search songs using index fields
                searchSongs(query) {
                    if (!this.songIndex) return [];
                    const q = query.toLowerCase();
                    return this.songIndex.filter(song => {
                        return (
                            (song.name && song.name.toLowerCase().includes(q)) ||
                            (song.mechaber && song.mechaber.toLowerCase().includes(q)) ||
                            (song.chatzer && song.chatzer.toLowerCase().includes(q)) ||
                            (song.verter && song.verter.toLowerCase().includes(q)) ||
                            (song.collections && song.collections.toLowerCase().includes(q)) ||
                            (song.scale && song.scale.toLowerCase().includes(q)) ||
                            (song.ritem && song.ritem.toLowerCase().includes(q))
                        );
                    });
                },

                // Filter songs using index fields
                filterSongs(filters) {
                    if (!this.songIndex) return [];
                    return this.songIndex.filter(song => {
                        if (filters.mechaber && filters.mechaber.length > 0) {
                            if (!filters.mechaber.some(f => song.mechaber?.includes(f))) return false;
                        }
                        if (filters.chatzer && filters.chatzer.length > 0) {
                            if (!filters.chatzer.some(f => song.chatzer?.includes(f))) return false;
                        }
                        if (filters.scale && filters.scale.length > 0) {
                            if (!filters.scale.some(f => song.scale?.includes(f))) return false;
                        }
                        if (filters.ritem && filters.ritem.length > 0) {
                            if (!filters.ritem.some(f => song.ritem?.includes(f))) return false;
                        }
                        if (filters.collections && filters.collections.length > 0) {
                            if (!filters.collections.some(f => song.collections?.includes(f))) return false;
                        }
                        if (filters.verter && filters.verter.length > 0) {
                            const songVerter = song.verter?.split(',').map(v => v.trim()).filter(Boolean) || [];
                            if (!filters.verter.some(f => songVerter.includes(f))) return false;
                        }
                        return true;
                    });
                },

                // Get category index (from localStorage or API)
                async getCategoryIndex(category) {
                    // Check memory cache
                    if (this.categoryIndexes[category]) {
                        return this.categoryIndexes[category];
                    }

                    // Check localStorage
                    const storageKey = STORAGE_KEYS.CATEGORY_PREFIX + category;
                    const cached = localStorage.getItem(storageKey);
                    if (cached) {
                        try {
                            const parsed = JSON.parse(cached);
                            this.categoryIndexes[category] = parsed;
                            console.log(`Category ${category} loaded from localStorage`);
                            return parsed;
                        } catch (e) {
                            console.error('Error parsing cached category:', e);
                        }
                    }

                    // Fetch from API
                    try {
                        this.categoryLoading = true;
                        console.log(`Fetching category index: ${category}...`);
                        const response = await fetch(`${API_BASE}/api/category-index/${category}`);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await response.json();

                        const index = data.index || data;
                        this.categoryIndexes[category] = index;

                        // Store in localStorage
                        try {
                            localStorage.setItem(storageKey, JSON.stringify(index));
                        } catch (e) {
                            if (e.name === 'QuotaExceededError') {
                                this._clearOldStorage();
                            }
                        }

                        console.log(`Category ${category} loaded: ${Object.keys(index).length} items`);
                        return index;
                    } catch (error) {
                        console.error(`Error loading category index ${category}:`, error);
                        return {};
                    } finally {
                        this.categoryLoading = false;
                    }
                },

                // Clear old CacheManager storage to free space
                _clearOldStorage() {
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith('v11_') || key.startsWith('v10_') || key.startsWith('v9_') ||
                            key.startsWith('v8_') || key.startsWith('v7_') || key.startsWith('v6_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    console.log('Old CacheManager storage cleared');
                },

                // Clear all IndexManager data
                clearAll() {
                    localStorage.removeItem(STORAGE_KEYS.SONG_INDEX);
                    localStorage.removeItem(STORAGE_KEYS.SONG_INDEX_TIMESTAMP);
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith(STORAGE_KEYS.CATEGORY_PREFIX)) {
                            localStorage.removeItem(key);
                        }
                    });
                    this.songIndex = null;
                    this.songMap = null;
                    this.recordingsIndex = null;
                    this.categoryIndexes = {};
                    this.recordingsLoaded = false;
                    console.log('All IndexManager data cleared');
                }
            };

            // Clean up old CacheManager keys on load
            IndexManager._clearOldStorage();

            // Backwards-compatible cache helpers for small data (statistics)
            // Main data (songs, recordings, categories) goes through IndexManager
            function getCachedData(key) {
                try {
                    const cacheKey = `oitzer_${key}`;
                    const cached = localStorage.getItem(cacheKey);
                    if (!cached) return null;
                    const { data, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp > 24 * 60 * 60 * 1000) {
                        localStorage.removeItem(cacheKey);
                        return null;
                    }
                    return data;
                } catch (error) {
                    return null;
                }
            }

            function setCachedData(key, data) {
                try {
                    const cacheKey = `oitzer_${key}`;
                    localStorage.setItem(cacheKey, JSON.stringify({ data, timestamp: Date.now() }));
                } catch (error) {
                    console.error('Cache write error:', error);
                }
            }

            // Legacy alias for code that still references CacheManager
            const CacheManager = {
                get: getCachedData,
                set: setCachedData,
                clearAll() { IndexManager.clearAll(); },
                clearOldCaches() { IndexManager._clearOldStorage(); }
            };

            // ========================================
            // INDEX DATA TRANSFORMATION HELPERS
            // ========================================

            // Transform a song from the songIndex format to the allSongs format
            // Maps slim index fields to the field names used by existing rendering code
            function transformIndexSong(indexSong) {
                return {
                    // Core fields from index
                    customId: indexSong.id,
                    rowId: indexSong.rowId,
                    name: indexSong.name || '',
                    mechaber: indexSong.mechaber || '',
                    author: indexSong.mechaber || '',
                    category: indexSong.chatzer || '',   // backwards compat
                    chatzer: indexSong.chatzer || '',
                    scale: indexSong.scale || null,
                    ritem: indexSong.ritem || null,
                    verter: indexSong.verter || null,
                    collections: indexSong.collections || null,
                    hasRecordings: indexSong.hasRecordings || false,
                    recordingCount: indexSong.recordingCount || 0,
                    bestRecordingRowId: indexSong.bestRecordingRowId || null,
                    bestRecordingRating: indexSong.bestRecordingRating || 0,

                    // Fields now available in song index (after worker fix)
                    pasigOif: indexSong.pasigOif || null,
                    gezungen: indexSong.gezungen || null,

                    // Derived fields (populated from recordings index)
                    recordings: [],
                    audioUrl: null,

                    // Fields loaded on demand via /api/song/:id
                    maure: null,
                    personalities: null,
                    info: null,
                    siman: null,
                    notn: null,
                    documents: null,
                    albums: null,
                    resources: null,
                    zugeleigt: null,
                    images: [],
                    pdfs: [],
                    otherMedia: null,
                    credits: null,

                    // Internal
                    codaRowName: indexSong.name,
                    _fullDetailsLoaded: false
                };
            }

            // Transform full song details (from /api/song/:id) into existing fields
            // The API returns raw Coda row format with values keyed by column IDs
            function mergeFullSongDetails(song, fullDetails) {
                if (!fullDetails) return;

                // Check if this is raw Coda format (has 'values' with column IDs)
                if (fullDetails.values) {
                    const values = fullDetails.values;
                    song.gezungen = extractText(values['c-kiHIam57Z0']) || null;
                    song.maure = extractText(values['c-J3q8mQIXBh']) || null;
                    song.pasigOif = extractText(values['c-mTtYp3FK9U']) || null;
                    song.personalities = extractText(values['c-6E02UJxxZW']) || null;
                    song.info = extractText(values['c-0jFLHVYRL8']) || null;
                    song.siman = extractText(values['c-jSVbHezFAS']) || null;
                    song.notn = extractText(values['c-hodtA6zYsy']) || null;
                    song.documents = extractText(values['c-nF5sRFoMkJ']) || null;
                    song.albums = extractText(values['c-j8dujLHcnT']) || null;
                    song.resources = extractText(values['c-KBb2Bgi6nM']) || null;
                    song.zugeleigt = extractText(values['c-iOlvD8H0n3']) || null;
                    // Update verter with full text if available
                    const fullVerter = extractText(values['c-KAWfVfB4jq']);
                    if (fullVerter) song.verter = fullVerter;

                    // Process other media attachment
                    const isImageFile = (fn) => fn && ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(fn.toLowerCase().split('.').pop());
                    const isPdfFile = (fn) => fn && fn.toLowerCase().split('.').pop() === 'pdf';
                    const isVideoFile = (fn) => fn && ['mp4', 'webm', 'mov', 'avi', 'mkv', 'm4v'].includes(fn.toLowerCase().split('.').pop());

                    const otherMedia = {
                        text: extractText(values['c-l9TdqiWUNg']) || '',
                        audio: [], files: [], images: [], videos: [], pdfs: []
                    };
                    const attachment6 = values['c-_q44nnca44'];
                    if (Array.isArray(attachment6)) {
                        attachment6.forEach((file, idx) => {
                            if (!file.url) return;
                            const fileName = file.name || `קובץ ${idx + 1}`;
                            if (isAudioFile(fileName)) otherMedia.audio.push({ url: file.url, name: fileName });
                            else if (isImageFile(fileName)) otherMedia.images.push({ url: file.url, name: fileName });
                            else if (isVideoFile(fileName)) otherMedia.videos.push({ url: file.url, name: fileName });
                            else if (isPdfFile(fileName)) otherMedia.pdfs.push({ url: file.url, name: fileName });
                            else otherMedia.files.push({ url: file.url, name: fileName });
                        });
                    }
                    if (otherMedia.text || otherMedia.audio.length || otherMedia.images.length ||
                        otherMedia.videos.length || otherMedia.pdfs.length || otherMedia.files.length) {
                        song.otherMedia = otherMedia;
                        song.images = otherMedia.images;
                        song.pdfs = otherMedia.pdfs;
                    }
                } else {
                    // Pre-processed format (future-proofing)
                    song.gezungen = fullDetails.gezungen || null;
                    song.maure = fullDetails.maure || null;
                    song.pasigOif = fullDetails.pasigOif || null;
                    song.personalities = fullDetails.personalities || null;
                    song.info = fullDetails.info || null;
                    song.siman = fullDetails.siman || null;
                    song.notn = fullDetails.notn || null;
                    song.documents = fullDetails.documents || null;
                    song.albums = fullDetails.albums || null;
                    song.resources = fullDetails.resources || null;
                    song.zugeleigt = fullDetails.zugeleigt || null;
                    song.credits = fullDetails.credits || null;
                    if (fullDetails.verter) song.verter = fullDetails.verter;
                    if (fullDetails.otherMedia) song.otherMedia = fullDetails.otherMedia;
                    if (fullDetails.images) song.images = fullDetails.images;
                    if (fullDetails.pdfs) song.pdfs = fullDetails.pdfs;
                }
                song._fullDetailsLoaded = true;
            }

            // Populate allSongs from the song index
            function populateAllSongsFromIndex(indexSongs) {
                // Build map of existing songs that have extra data loaded
                const existingMap = new Map();
                allSongs.forEach(song => {
                    if (song.customId && (song._fullDetailsLoaded || (song.recordings && song.recordings.length > 0))) {
                        existingMap.set(song.customId, song);
                    }
                });

                allSongs = indexSongs.map(indexSong => {
                    const song = transformIndexSong(indexSong);
                    const existing = existingMap.get(song.customId);
                    if (existing) {
                        // Preserve full details and recordings from previously loaded data
                        if (existing._fullDetailsLoaded) {
                            const detailFields = ['gezungen', 'maure', 'pasigOif', 'personalities', 'info', 'siman', 'notn', 'documents', 'albums', 'resources', 'zugeleigt', 'credits', 'otherMedia', 'images', 'pdfs', 'verter'];
                            detailFields.forEach(f => { if (existing[f] != null) song[f] = existing[f]; });
                            song._fullDetailsLoaded = true;
                        }
                        if (existing.recordings && existing.recordings.length > 0) {
                            song.recordings = existing.recordings;
                            song.audioUrl = existing.audioUrl;
                        }
                    }
                    return song;
                });

                loadedCategories.songs = true;
                songsFullyLoaded = true;

                // Merge recordings if already loaded
                if (IndexManager.recordingsLoaded) {
                    updateSongsFromRecordingsIndex();
                }

                applyFiltersQuiet();
                buildCategoryIndices();
                updateFilterMegaMenuContent();
                updateNavCounts();
            }

            // Update allSongs with recordings from the IndexManager recordings index
            function updateSongsFromRecordingsIndex() {
                if (!IndexManager.recordingsLoaded || allSongs.length === 0) return;

                let updated = 0;
                allSongs.forEach(song => {
                    const recordings = IndexManager.getRecordings(song.customId);
                    if (recordings && recordings.length > 0) {
                        song.recordings = recordings;
                        song.hasRecordings = true;
                        song.recordingCount = recordings.length;
                        song.audioUrl = recordings[0].url;
                        updated++;
                    }
                });

                // Also update the global recordingsByNigunId for backwards compat
                if (IndexManager.recordingsIndex) {
                    Object.assign(recordingsByNigunId, IndexManager.recordingsIndex);
                }

                if (updated > 0) {
                    console.log(`Updated ${updated} songs with recordings from index`);
                    applyFiltersQuiet();
                    updatePlayButtonStates();
                }
            }

            // Update play button states in the current view after recordings load
            function updatePlayButtonStates() {
                // 1. Update song list items - inject play buttons for songs that now have recordings
                document.querySelectorAll('.song-item[data-song-idx]').forEach(item => {
                    const idx = parseInt(item.dataset.songIdx, 10);
                    const song = allSongs[idx];
                    if (!song) return;
                    const hasAudio = songHasQualityAudio(song);
                    const hasBtn = item.querySelector('.song-play-btn-new');

                    if (hasAudio && !hasBtn) {
                        // Song now has quality recordings but no play button - inject one
                        item.classList.remove('no-audio');
                        const playAction = `playSong(${idx})`;
                        const btn = document.createElement('button');
                        btn.className = 'song-play-btn-new';
                        btn.setAttribute('data-song-idx', idx);
                        btn.setAttribute('onclick', `event.stopPropagation(); ${playAction};`);
                        btn.innerHTML = '<span class="play-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M8 5v14l11-7L8 5z"/></svg></span><span class="pause-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></span>';
                        item.appendChild(btn);
                    } else if (!hasAudio && song.recordings && song.recordings.length > 0 && !hasBtn) {
                        // Has recordings but low quality - show low-quality indicator
                        item.classList.remove('no-audio');
                        const indicator = document.createElement('div');
                        indicator.className = 'song-play-btn-new song-btn-low-quality';
                        indicator.title = 'רעקארדירונגען מיט נידעריגע קוואליטעט';
                        indicator.innerHTML = '<span class="low-quality-icon">☆</span>';
                        item.appendChild(indicator);
                    }
                });

                // 2. Update .music-song-item elements
                document.querySelectorAll('.music-song-item[data-idx]').forEach(item => {
                    const idx = parseInt(item.dataset.idx, 10);
                    const song = allSongs[idx];
                    if (song && song.recordings && song.recordings.length > 0) {
                        item.classList.add('has-recordings');
                        item.classList.remove('no-audio');
                    }
                });

                // 3. Re-render nigun detail page if currently viewing one
                if (currentDetailView?.type === 'nigunim') {
                    const detailId = currentDetailView.customId || currentDetailView.name;
                    const song = allSongs.find(s => s.customId === detailId || s.name === detailId || s.rowId === detailId);
                    if (song && song.recordings && song.recordings.length > 0) {
                        // Only re-render if recordings section is missing
                        const container = document.getElementById('mainContent');
                        if (container && !container.querySelector('.nigun-recordings-list')) {
                            renderDetailPage();
                        }
                    }
                }
            }

            // Handle direct song link: /song/123 or #/nigunim/123
            // Strategy: Load song index first (fast from cache), find song by customId,
            // render immediately, then background-load full details + recordings
            async function handleDirectSongLink(songId) {
                const content = document.getElementById('mainContent');
                if (content) {
                    content.innerHTML = `
                        <div class="detail-loading-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; gap: 20px;">
                            ${getMediumLoaderHTML()}
                            <p style="color: var(--text-secondary); font-size: 16px; margin: 0;">לאודינג...</p>
                        </div>
                    `;
                }

                try {
                    // Step 1: Load song index (instant from localStorage, or ~700KB API fetch)
                    const indexSongs = await IndexManager.loadSongIndex();
                    if (indexSongs && indexSongs.length > 0) {
                        populateAllSongsFromIndex(indexSongs);
                    }

                    // Step 2: Find song by customId, rowId, or name in the index
                    let songIdx = allSongs.findIndex(s => s.customId === songId);
                    if (songIdx === -1) songIdx = allSongs.findIndex(s => s.rowId === songId);
                    if (songIdx === -1) songIdx = allSongs.findIndex(s => s.name === songId);

                    if (songIdx === -1) {
                        // Not in index - show not found
                        if (content) {
                            content.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-state-icon">❌</div>
                                    <h2>ניגון נישט געפונען</h2>
                                    <button onclick="location.hash='#/home'" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">צוריק צו הויפט זייט</button>
                                </div>
                            `;
                        }
                        return;
                    }

                    const song = allSongs[songIdx];

                    // Step 3: Render detail page immediately with index data
                    const hash = window.location.hash || '';
                    const isPreview = hash.includes('/preview');

                    if (isPreview) {
                        openNigunModal(songIdx, song);
                    } else {
                        currentPageView = 'songs';
                        currentDetailView = { type: 'nigunim', name: song.name, id: song.rowId, customId: song.customId };
                        renderDetailPage();
                    }

                    // Step 4: Background - load full song details (uses rowId for fast direct lookup)
                    if (!song._fullDetailsLoaded && song.rowId) {
                        IndexManager.getFullSongDetails(song.rowId).then(fullDetails => {
                            if (!fullDetails) return;
                            mergeFullSongDetails(song, fullDetails);
                            // Re-render if still on this page
                            if (currentDetailView?.customId === song.customId || currentDetailView?.id === song.rowId) {
                                renderDetailPage();
                            }
                            // Also update modal if open
                            if (nigunModalOpen && currentNigunModalIdx === songIdx) {
                                const modalBody = document.getElementById('nigunModalBody');
                                if (modalBody) {
                                    const tempContainer = document.createElement('div');
                                    renderNigunDetailPage(tempContainer, song.name);
                                    modalBody.innerHTML = tempContainer.innerHTML;
                                }
                            }
                        }).catch(err => console.error('Error loading full song details:', err));
                    }

                    // Step 5: Background - load recordings
                    IndexManager.loadRecordingsIndex().then(() => {
                        updateSongsFromRecordingsIndex();
                    });

                } catch (error) {
                    console.error('Error loading direct song link:', error);
                    if (content) {
                        content.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">❌</div>
                                <h2>גרייז לאָודינג</h2>
                                <p>${error.message}</p>
                                <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">פּרוּוו ווידער</button>
                            </div>
                        `;
                    }
                }
            }

            // Animation Helper: Count Up Number
            function animateCountUp(element, endValue, duration = 1000, suffix = '') {
                if (!element) return;

                // Cancel running animation
                if (element._animationFrame) {
                    cancelAnimationFrame(element._animationFrame);
                }

                // Determine start value from current text
                const currentText = element.textContent.replace(/,/g, '');
                const match = currentText.match(/\d+/);
                let startValue = match ? parseInt(match[0]) : 0;

                // If currently "loading...", startValue is 0
                if (element.classList.contains('loading')) {
                    startValue = 0;
                    element.classList.remove('loading');
                }

                // If start and end are same, just update text (ensure suffix is correct)
                if (startValue === endValue) {
                    element.textContent = endValue + suffix;
                    return;
                }

                const startTime = performance.now();

                function update(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // Ease out cubic
                    const ease = 1 - Math.pow(1 - progress, 3);

                    const current = Math.floor(startValue + (endValue - startValue) * ease);
                    element.textContent = current + suffix;

                    if (progress < 1) {
                        element._animationFrame = requestAnimationFrame(update);
                    } else {
                        element.textContent = endValue + suffix;
                        element._animationFrame = null;
                    }
                }

                element._animationFrame = requestAnimationFrame(update);
            }

            // Helper to set loading state on subtitle
            function setSubtitleLoading(subtitleElement) {
                if (subtitleElement) {
                    subtitleElement.textContent = 'לאודט...'; // Placeholder text for screen readers
                    subtitleElement.classList.add('loading');
                }
            }

            // Audio player
            const audioPlayer = document.getElementById('audioPlayer');

            // Helper function to extract text from Coda value
            function extractText(value) {
                if (!value && value !== 0) return '';
                if (typeof value === 'number') return String(value);
                if (typeof value === 'string') return value.replace(/```/g, '').trim();
                if (Array.isArray(value)) return value.map(v => extractText(v)).filter(Boolean).join(', ');
                if (typeof value === 'object') {
                    const text = value.name || value.display || value.value || '';
                    if (typeof text === 'number') return String(text);
                    return typeof text === 'string' ? text.replace(/```/g, '').trim() : String(text);
                }
                return '';
            }

            // Helper function to extract image URL from Coda value
            function extractImageUrl(value) {
                if (!value) return null;

                // Direct string URL
                if (typeof value === 'string' && value.startsWith('http')) {
                    return value;
                }

                // Array format (Coda's typical image format)
                if (Array.isArray(value) && value.length > 0) {
                    const first = value[0];
                    // ImageObject format: { "@type": "ImageObject", "url": "..." }
                    if (first && first['@type'] === 'ImageObject' && first.url) {
                        return first.url;
                    }
                    // Simple object with url
                    if (first && first.url) {
                        return first.url;
                    }
                    // Direct string in array
                    if (typeof first === 'string' && first.startsWith('http')) {
                        return first;
                    }
                }

                // Direct object with url
                if (value && typeof value === 'object' && value.url) {
                    return value.url;
                }

                return null;
            }

            // Helper function to extract URL from various Coda formats (WebPage, ImageObject, etc.)
            function extractUrl(value) {
                if (!value) return null;

                // Direct string URL
                if (typeof value === 'string') {
                    // Check if it's markdown link format [text](url)
                    const markdownMatch = value.match(/\[.*?\]\((https?:\/\/[^\)]+)\)/);
                    if (markdownMatch) {
                        return markdownMatch[1];
                    }
                    if (value.startsWith('http')) {
                        return value;
                    }
                    return null;
                }

                // WebPage format: { "@type": "WebPage", "url": "..." }
                if (value && typeof value === 'object' && value['@type'] === 'WebPage' && value.url) {
                    return value.url;
                }

                // ImageObject format (for PDFs stored as images)
                if (value && typeof value === 'object' && value['@type'] === 'ImageObject' && value.url) {
                    return value.url;
                }

                // Array of ImageObjects or WebPages
                if (Array.isArray(value) && value.length > 0) {
                    const first = value[0];
                    if (first && (first['@type'] === 'ImageObject' || first['@type'] === 'WebPage') && first.url) {
                        return first.url;
                    }
                    if (first && first.url) {
                        return first.url;
                    }
                }

                // Direct object with url
                if (value && typeof value === 'object' && value.url) {
                    return value.url;
                }

                return null;
            }

            // Generic function to fetch table info with pagination - with caching
            async function fetchTableInfo(tableId, infoObject, tableName) {
                try {
                    // Check cache first
                    const cacheKey = `table_${tableId}`;
                    const cached = CacheManager.get(cacheKey);
                    if (cached) {
                        Object.assign(infoObject, cached);
                        console.log(`✅ ${tableName} loaded from cache (${Object.keys(cached).length} items)`);
                        return;
                    }

                    console.log(`📡 Fetching ${tableName} from API...`);

                    // Get columns first
                    const columnsResponse = await fetch(`${WORKER_URL}docs/${DOC_ID}/tables/${tableId}/columns`);
                    const columnsData = await columnsResponse.json();
                    console.log(`${tableName} columns:`, columnsData.items?.map(c => ({ id: c.id, name: c.name, type: c.format?.type })));

                    // Build column map by name (lowercase) and identify special columns
                    const columnNames = {};
                    let imageColId = null;
                    let nameColId = null;
                    let detailsColId = null; // Specific column for דעטאלן

                    if (columnsData.items) {
                        columnsData.items.forEach((col, idx) => {
                            columnNames[col.id] = col.name || '';
                            const nameLower = (col.name || '').toLowerCase();

                            // Find image column by type or name
                            if (col.format?.type === 'image' || nameLower.includes('בילד') || nameLower.includes('image') || nameLower.includes('תמונה') || nameLower.includes('picture') || nameLower.includes('קאווער') || nameLower.includes('cover')) {
                                imageColId = col.id;
                            }

                            // Find details column specifically
                            if (nameLower.includes('דעטאלן') || nameLower === 'details' || nameLower === 'description') {
                                detailsColId = col.id;
                            }

                            // First column is usually the name
                            if (idx === 0) {
                                nameColId = col.id;
                            }
                        });
                    }

                    console.log(`${tableName} - Image column: ${imageColId}, Name column: ${nameColId}, Details column: ${detailsColId}`);

                    // Fetch all rows with pagination
                    let allRows = [];
                    let pageToken = null;

                    do {
                        const url = `${WORKER_URL}docs/${DOC_ID}/tables/${tableId}/rows?valueFormat=rich${pageToken ? '&pageToken=' + pageToken : ''}`;
                        const response = await fetch(url);
                        if (!response.ok) {
                            console.log(`${tableName} table not accessible:`, response.status);
                            return;
                        }
                        const data = await response.json();
                        allRows = allRows.concat(data.items || []);
                        pageToken = data.nextPageToken;
                    } while (pageToken);

                    console.log(`${tableName} - Fetched ${allRows.length} total rows`);

                    allRows.forEach(item => {
                        const values = item.values;

                        // Get name from first column or name column (this is the tag name / short name)
                        // For mechabrim table, ONLY use specific column c-wRFSCyCCs5 for tagName display
                        // This column has built-in fallback logic in Coda so no additional fallback needed
                        const mechabrimTagColId = 'c-wRFSCyCCs5';
                        const nameValue = (tableId === MECHABRIM_TABLE_ID)
                            ? values[mechabrimTagColId]
                            : (nameColId ? values[nameColId] : values[Object.keys(values)[0]]);
                        const tagName = extractText(nameValue);

                        // Use item.name as the key (computed by Coda) - this is what song.mechaber references
                        const name = item.name || tagName;

                        if (name) {
                            const info = { allData: {}, rowId: item.id };

                            // Always store tag name from first column (will compare with built full name later)
                            if (tagName) {
                                info.tagName = tagName;
                            }

                            // Extract image from identified image column
                            if (imageColId && values[imageColId]) {
                                const imgUrl = extractImageUrl(values[imageColId]);
                                if (imgUrl) {
                                    info.image = imgUrl;
                                    info.cover = imgUrl; // Also set as cover for albums
                                }
                            }

                            // Extract details/description from identified details column FIRST (priority)
                            if (detailsColId && values[detailsColId]) {
                                const detailsText = extractText(values[detailsColId]);
                                if (detailsText) {
                                    info.description = detailsText;
                                    console.log(`Set description from details column for ${name}: ${detailsText.substring(0, 50)}...`);
                                }
                            }

                            // Process all columns for other data
                            Object.keys(values).forEach(colId => {
                                if (colId === nameColId || colId === imageColId) return;

                                const value = values[colId];
                                const colName = columnNames[colId] || '';
                                const colNameLower = colName.toLowerCase();

                                // Extract text value for mechabrim column ID matching (works for any value type)
                                const textVal = extractText(value);

                                // Direct column ID matching for ID columns across all tables
                                // Check this BEFORE the textVal check in case the value format is different
                                const idColumnIds = [
                                    'c-pDoyO3lhGs', // מחברים ID
                                    'c-b0wqs6RvRL', // חצרות ID
                                    'c-BUEMMqGeaq', // ווערטער ID
                                    'c-u_op0cdc6C', // פיוטים ID
                                    'c-Hnj-jcC9Fz', // זמנים ID
                                    'c-qWlY1R6WOz', // קאלעקשאנס ID
                                    'c-ov8ZZ90jjL', // רעסורסן ID
                                    'c-ABZxwZf5gG', // דאקומענטן ID
                                    'c-6sbXQP4zbj'  // אלבומס ID
                                ];
                                if (idColumnIds.includes(colId)) {
                                    // Try multiple ways to extract the ID value
                                    let idValue = textVal;
                                    if (!idValue && typeof value === 'number') {
                                        idValue = String(value);
                                    }
                                    if (!idValue && value && typeof value === 'object') {
                                        // Try getting value from object properties
                                        idValue = value.name || value.value || value.text || '';
                                    }

                                    if (idValue) {
                                        idValue = String(idValue).replace(/^#/, '').trim();
                                        if (idValue) {
                                            info.customId = idValue;
                                        }
                                    }
                                }

                                if (textVal) {
                                    // Direct column ID matching for mechabrim fields
                                    if (colId === 'c-iSyYvX1S79') info.title = textVal;
                                    if (colId === 'c-wgHtV5VfbM') info.firstName = textVal;
                                    if (colId === 'c-a1I4bjzuvt') info.lastName = textVal;
                                    if (colId === 'c-5hlKINjTSq') info.gerufen = textVal;
                                    if (colId === 'c-qF9asVJ_z1') info.platz = textVal;
                                    if (colId === 'c-2MdIjbFK44') info.suffix = textVal;
                                }

                                // Skip lookup/relation columns (they have complex objects)
                                if (Array.isArray(value) && value.length > 0 && value[0]['@type'] === 'StructuredValue') {
                                    // Extract just the name from related records
                                    const relatedNames = value.map(v => v.name).filter(Boolean);
                                    if (relatedNames.length > 0) {
                                        info.allData[colName] = relatedNames.join(', ');
                                        if (colNameLower.includes('חצר')) {
                                            info.chatzer = relatedNames.join(', ');
                                        }
                                        // Store piyutim list for zmanim
                                        if (colNameLower === 'פיוטים' || colNameLower.includes('פיוט')) {
                                            info.piyutim = relatedNames;
                                        }
                                        // Store collections list for zmanim
                                        if (colNameLower === 'קאלעקשאנס' || colNameLower.includes('קאלעקשן') || colNameLower.includes('collection')) {
                                            info.collections = relatedNames;
                                        }
                                        // Store albums list for chatzeros
                                        if (colNameLower === 'אלבומס' || colNameLower.includes('אלבום')) {
                                            info.albums = relatedNames;
                                        }
                                        // Store documents list for chatzeros
                                        if (colNameLower === 'דאקומענטן' || colNameLower.includes('דאקומענט')) {
                                            info.documents = relatedNames;
                                        }
                                        // Store zmanim for piyutim (all of them)
                                        if (colNameLower === 'זמן' || colNameLower === 'zman') {
                                            info.zmanim = relatedNames; // Store all zmanim
                                        }
                                        // Store zmanim list for collections (plural)
                                        if (colNameLower === 'זמנים') {
                                            info.zmanim = relatedNames;
                                        }
                                        // Store nigunim list for piyutim (combine all ניגונים columns)
                                        if (colNameLower.includes('ניגונים') || colNameLower.includes('ניגון')) {
                                            if (!info.nigunim) info.nigunim = [];
                                            info.nigunim = [...new Set([...info.nigunim, ...relatedNames])];
                                        }
                                        // Mechaber birth/death years (lookup fields)
                                        if (colNameLower === 'שנת לידה') {
                                            info.birthYear = relatedNames.join(', ');
                                        }
                                        if (colNameLower === 'שנת פטירה') {
                                            info.deathYear = relatedNames.join(', ');
                                        }
                                    }
                                    return;
                                }

                                // Handle single StructuredValue (non-array lookup)
                                if (value && typeof value === 'object' && value['@type'] === 'StructuredValue') {
                                    const relatedName = value.name;
                                    if (relatedName) {
                                        info.allData[colName] = relatedName;
                                        if (colNameLower === 'שנת לידה') {
                                            info.birthYear = relatedName;
                                        }
                                        if (colNameLower === 'שנת פטירה') {
                                            info.deathYear = relatedName;
                                        }
                                        if (colNameLower.includes('חצר')) {
                                            info.chatzer = relatedName;
                                        }
                                        // Handle zman lookup field for piyutim
                                        if (colNameLower === 'זמן' || colNameLower === 'zman') {
                                            info.zmanim = [relatedName]; // Store as array for consistency
                                        }
                                        // Handle single nigun lookup field for piyutim
                                        if (colNameLower.includes('ניגונים') || colNameLower.includes('ניגון')) {
                                            if (!info.nigunim) info.nigunim = [];
                                            if (!info.nigunim.includes(relatedName)) info.nigunim.push(relatedName);
                                        }
                                        // Handle single collection lookup field for zmanim
                                        if (colNameLower === 'קאלעקשאנס' || colNameLower.includes('קאלעקשן') || colNameLower.includes('collection')) {
                                            info.collections = [relatedName];
                                        }
                                        // Handle single piyut lookup field for zmanim
                                        if (colNameLower === 'פיוטים' || colNameLower.includes('פיוט')) {
                                            info.piyutim = [relatedName];
                                        }
                                        // Handle single album lookup field for chatzeros
                                        if (colNameLower === 'אלבומס' || colNameLower.includes('אלבום')) {
                                            info.albums = [relatedName];
                                        }
                                        // Handle single document lookup field for chatzeros
                                        if (colNameLower === 'דאקומענטן' || colNameLower.includes('דאקומענט')) {
                                            info.documents = [relatedName];
                                        }
                                    }
                                    return;
                                }

                                // Handle WebPage format for links
                                if (value && typeof value === 'object' && value['@type'] === 'WebPage') {
                                    const url = value.url;
                                    if (url) {
                                        info.allData[colName] = url;
                                        if (colNameLower === 'לינק / נאמבער' || colNameLower === 'לינק' || colNameLower === 'link') {
                                            info.link = url;
                                        }
                                        if (colNameLower === 'צו באקומען ביי' || colNameLower.includes('באקומען')) {
                                            info.whereToBuy = url;
                                        }
                                    }
                                    return;
                                }

                                // Handle ImageObject format (for PDFs/files)
                                const imgObjUrl = extractUrl(value);
                                if (imgObjUrl && (colNameLower === 'פייל' || colNameLower === 'file' || colNameLower === 'בוקלעט' || colNameLower === 'booklet')) {
                                    info.allData[colName] = imgObjUrl;
                                    if (colNameLower === 'פייל' || colNameLower === 'file') {
                                        info.file = imgObjUrl;
                                    }
                                    if (colNameLower === 'בוקלעט' || colNameLower === 'booklet') {
                                        info.booklet = imgObjUrl;
                                    }
                                    return;
                                }

                                // Handle select/array fields (like מקור)
                                let textValue = '';
                                if (Array.isArray(value)) {
                                    textValue = value.map(v => {
                                        if (typeof v === 'string') return v.replace(/```/g, '').trim();
                                        if (v && v.name) return v.name;
                                        return '';
                                    }).filter(Boolean).join(', ');
                                } else {
                                    textValue = extractText(value);
                                }
                                if (textValue) {
                                    info.allData[colName] = textValue;

                                    // Identify specific fields by column name
                                    // Only set description if not already set from details column
                                    if (!info.description && (colNameLower.includes('דעטאלן') || colNameLower.includes('אינפארמאציע') || colNameLower.includes('באשרייבונג') || colNameLower.includes('description') || colNameLower.includes('info') || colNameLower.includes('details'))) {
                                        info.description = textValue;
                                        console.log(`Found description for ${name}: ${textValue.substring(0, 50)}...`);
                                    }
                                    if (colNameLower.includes('מקום') || colNameLower.includes('ארט') || colNameLower.includes('location')) {
                                        info.location = textValue;
                                    }
                                    if (colNameLower.includes('מקור') && !colNameLower.includes('מראה')) {
                                        info.makor = textValue;
                                    }
                                    if (colNameLower.includes('מראה מקום')) {
                                        info.marehMakom = textValue;
                                    }
                                    if (colNameLower.includes('פולע טעקסט') || colNameLower.includes('טעקסט')) {
                                        info.fullText = textValue;
                                    }
                                    if (colNameLower === 'זמן' || colNameLower === 'zman') {
                                        info.zman = textValue;
                                    }
                                    if (colNameLower.includes('מייסד') || colNameLower.includes('founder')) {
                                        info.founder = textValue;
                                    }
                                    if (colNameLower.includes('יאר') || colNameLower.includes('year')) {
                                        info.year = textValue;
                                    }
                                    if (colNameLower.includes('געבורט') || colNameLower.includes('birth') || colNameLower.includes('geboren')) {
                                        info.birthYear = textValue;
                                    }
                                    if (colNameLower.includes('פטירה') || colNameLower.includes('נפטר') || colNameLower.includes('death')) {
                                        info.deathYear = textValue;
                                    }
                                    if (colNameLower.includes('רבי') || colNameLower.includes('rebbe')) {
                                        info.currentRebbe = textValue;
                                    }
                                    if (colNameLower.includes('באוואוסט') || colNameLower.includes('famous') || colNameLower.includes('known')) {
                                        info.famous = textValue;
                                    }
                                    // Mechaber specific fields
                                    if (colNameLower === 'טעג נאמען' || colNameLower.includes('טעג')) {
                                        info.tagName = textValue;
                                    }
                                    if (colNameLower === 'טיטל' || colNameLower === 'title') {
                                        info.title = textValue;
                                    }
                                    if (colNameLower === 'ערשטע נאמען' || colNameLower.includes('first name')) {
                                        info.firstName = textValue;
                                    }
                                    if (colNameLower === 'לעצטע נאמען' || colNameLower.includes('last name')) {
                                        info.lastName = textValue;
                                    }
                                    if (colNameLower === 'סופיקס' || colNameLower === 'suffix') {
                                        info.suffix = textValue;
                                    }
                                    if (colNameLower === 'גערופן' || colNameLower === 'called' || colNameLower === 'nickname') {
                                        info.gerufen = textValue;
                                    }
                                    if (colNameLower === 'פלאץ' || colNameLower === 'place') {
                                        info.platz = textValue;
                                    }
                                    if (colNameLower === 'יום לידה') {
                                        info.birthDay = textValue;
                                    }
                                    if (colNameLower === 'חודש לידה') {
                                        info.birthMonth = textValue;
                                    }
                                    if (colNameLower === 'שנת לידה') {
                                        info.birthYear = textValue;
                                    }
                                    if (colNameLower === 'יום פטירה') {
                                        info.deathDay = textValue;
                                    }
                                    if (colNameLower === 'חודש פטירה') {
                                        info.deathMonth = textValue;
                                    }
                                    if (colNameLower === 'שנת פטירה') {
                                        info.deathYear = textValue;
                                    }
                                    // Resources specific fields
                                    if (colNameLower === 'לינק / נאמבער' || colNameLower === 'לינק' || colNameLower === 'link') {
                                        info.link = textValue;
                                    }
                                    if (colNameLower === 'סארט' || colNameLower === 'sort' || colNameLower === 'type') {
                                        info.sort = textValue;
                                    }
                                    if (colNameLower === 'הערות' || colNameLower === 'notes') {
                                        info.notes = textValue;
                                    }
                                    // Documents specific fields  
                                    if (colNameLower === 'פייל' || colNameLower === 'file') {
                                        info.file = textValue;
                                    }
                                    if (colNameLower === 'סעריע' || colNameLower === 'serie' || colNameLower === 'series') {
                                        info.serie = textValue;
                                    }
                                    if (colNameLower === 'נאמען' || colNameLower === 'name') {
                                        info.docName = textValue;
                                    }
                                    // Albums specific fields
                                    if (colNameLower === 'פראדוצירער' || colNameLower === 'producer') {
                                        info.producer = textValue;
                                    }
                                    if (colNameLower === 'בוקלעט' || colNameLower === 'booklet') {
                                        info.booklet = textValue;
                                    }
                                    if (colNameLower === 'צו באקומען ביי' || colNameLower.includes('באקומען')) {
                                        info.whereToBuy = textValue;
                                    }
                                    if (colNameLower === 'קאווער' || colNameLower === 'cover') {
                                        info.cover = textValue;
                                    }
                                    if (colNameLower === 'שנת' || colNameLower === 'year' || colNameLower === 'יאר') {
                                        info.year = textValue;
                                    }
                                    if (colNameLower === 'אלבום' || colNameLower === 'album') {
                                        info.albumName = textValue;
                                    }
                                }
                            });

                            // Don't set a fallback description - only use actual details/description fields

                            // Trim the name to avoid whitespace issues
                            const trimmedName = name.trim();
                            infoObject[trimmedName] = info;
                        }
                    });

                    console.log(`Loaded ${tableName} info:`, Object.keys(infoObject).length, 'items');

                    // Cache the results
                    setCachedData(cacheKey, infoObject);
                    console.log(`💾 ${tableName} cached`);

                } catch (error) {
                    console.log(`Could not fetch ${tableName} info:`, error.message);
                }
            }

            // Helper: load category via IndexManager API, mapping to existing info object format
            async function fetchCategoryViaIndex(categoryName, infoObject, displayName) {
                try {
                    const index = await IndexManager.getCategoryIndex(categoryName);
                    if (index && Object.keys(index).length > 0) {
                        // Map index format to existing info object format
                        Object.entries(index).forEach(([name, data]) => {
                            infoObject[name] = {
                                ...data,
                                customId: data.id || data.customId || name,
                                rowId: data.rowId,
                                image: data.image || null,
                                tagName: data.tagName || name,
                                allData: data
                            };
                        });
                        console.log(`${displayName} loaded via IndexManager (${Object.keys(index).length} items)`);
                        return true;
                    }
                } catch (error) {
                    console.error(`IndexManager category fetch failed for ${categoryName}:`, error);
                }
                return false;
            }

            // Fetch functions for each table - use Coda API (fetchTableInfo) for rich data
            // The IndexManager category-index API is too slim (missing customId, relationships, descriptions)
            // TODO: Switch to fetchCategoryViaIndex once backend adds: customId, piyutim, collections,
            //       nigunim, zmanim, chatzer, description, mechaber detail fields
            async function fetchChatzerosInfo() {
                await fetchTableInfo(CHATZEROS_TABLE_ID, chatzerosInfo, 'Chatzeros');
            }

            async function fetchMechabrimInfo() {
                await fetchTableInfo(MECHABRIM_TABLE_ID, mechabrimInfo, 'Mechabrim');
            }

            async function fetchVerterInfo() {
                await fetchTableInfo(VERTER_TABLE_ID, verterInfo, 'Verter');
            }

            async function fetchZmanimInfo() {
                await fetchTableInfo(ZMANIM_TABLE_ID, zmaninInfo, 'Zmanim');
            }

            async function fetchPiyutimInfo() {
                await fetchTableInfo(PIYUTIM_TABLE_ID, piyutimInfo, 'Piyutim');
            }

            async function fetchCollectionsInfo() {
                await fetchTableInfo(COLLECTIONS_TABLE_ID, collectionsInfo, 'Collections');
            }

            async function fetchResourcesInfo() {
                await fetchTableInfo(RESOURCES_TABLE_ID, resourcesInfo, 'Resources');
            }

            async function fetchDocumentsInfo() {
                await fetchTableInfo(DOCUMENTS_TABLE_ID, documentsInfo, 'Documents');
            }

            async function fetchAlbumsInfo() {
                await fetchTableInfo(ALBUMS_TABLE_ID, albumsInfo, 'Albums');
            }

            async function fetchScaleInfo() {
                await fetchTableInfo(SCALE_TABLE_ID, scaleInfo, 'Scale');
            }

            async function fetchRhythmInfo() {
                await fetchTableInfo(RHYTHM_TABLE_ID, rhythmInfo, 'Rhythm');
            }

            // Fetch recordings index via IndexManager (replaces old Coda table fetch)
            // Now uses /api/recordings-index endpoint, stored in memory only
            async function fetchRecordingsTable() {
                try {
                    await IndexManager.loadRecordingsIndex();
                    // Sync to global recordingsByNigunId for backwards compat
                    if (IndexManager.recordingsIndex) {
                        Object.assign(recordingsByNigunId, IndexManager.recordingsIndex);
                    }
                    console.log(`Recordings loaded via IndexManager (${Object.keys(recordingsByNigunId).length} nigunim)`);
                } catch (error) {
                    console.error('Error loading recordings index:', error);
                }
            }

            // Helper to check if file is audio (global scope for reuse)
            function isAudioFile(filename) {
                if (!filename) return false;
                const ext = filename.toLowerCase().split('.').pop();
                return ['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac', 'wma'].includes(ext);
            }

            // Fetch statistics from STATS table (only row 1) - with caching
            async function fetchStatistics() {
                try {
                    // Check cache first
                    const cacheKey = 'statistics';
                    const cached = getCachedData(cacheKey);
                    if (cached) {
                        Object.assign(cachedStats, cached);
                        console.log('✅ Statistics loaded from cache:', cachedStats);
                        return;
                    }

                    console.log('📡 Fetching statistics from API:', STATS_TABLE_ID);

                    // Fetch stats row directly using known column IDs
                    const url = `${WORKER_URL}docs/${DOC_ID}/tables/${STATS_TABLE_ID}/rows?valueFormat=simple&limit=1`;
                    const response = await fetch(url);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Stats API error:', errorText);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.items && data.items.length > 0) {
                        const row = data.items[0];
                        const values = row.values;

                        console.log('📊 Stats row values:', values);

                        // Helper to get number from value (handles both direct numbers and strings)
                        const getNum = (val) => {
                            if (val === null || val === undefined) return 0;
                            if (typeof val === 'number') return val;
                            if (typeof val === 'string') return parseInt(val) || 0;
                            return parseInt(extractText(val)) || 0;
                        };

                        // Extract statistics using exact column IDs
                        cachedStats.niggunim = getNum(values[STATS_COLS.niggunim]);
                        cachedStats.mechabrim = getNum(values[STATS_COLS.mechabrim]);
                        cachedStats.verter = getNum(values[STATS_COLS.verter]);
                        cachedStats.chatzeros = getNum(values[STATS_COLS.chatzeros]);
                        cachedStats.zmanim = getNum(values[STATS_COLS.zmanim]);
                        cachedStats.piyutim = getNum(values[STATS_COLS.piyutim]);
                        cachedStats.collections = getNum(values[STATS_COLS.collections]);

                        console.log('📊 Parsed stats:', cachedStats);

                        // Save to cache
                        setCachedData(cacheKey, { ...cachedStats });

                        console.log('✅ Statistics loaded from API and cached:', cachedStats);
                    } else {
                        console.error('❌ No stats data in response');
                    }
                } catch (error) {
                    console.error('❌ Statistics fetch error:', error);
                    throw error;
                }
            }

            // Main initialization - uses IndexManager for slim index approach
            async function fetchSongs() {
                try {
                    console.log('Starting initialization with IndexManager...');

                    // 1. Load statistics (uses simple cache)
                    try {
                        await fetchStatistics();
                    } catch (statsError) {
                        console.error('Statistics failed to load, using defaults:', statsError);
                    }

                    // 2. Check if this is a direct song link
                    const hash = window.location.hash || '';
                    const directSongMatch = hash.match(/#\/nigunim\/([^\/]+)/);

                    if (directSongMatch && directSongMatch[1] !== '') {
                        const songId = decodeURIComponent(directSongMatch[1]);
                        // Direct link: loads song index, finds song, renders detail page
                        handleDirectSongLink(songId);
                        return;
                    }

                    // 3. For home page: render immediately (only needs stats, not songs)
                    if (!hash || hash === '#/home' || hash === '#/') {
                        updateURL();
                        renderCurrentPage();
                    }

                    // 4. Load song index (fast: from localStorage or ~700KB API fetch)
                    const songs = await IndexManager.loadSongIndex();
                    if (songs && songs.length > 0) {
                        populateAllSongsFromIndex(songs);
                    }

                    // 5. For non-home pages: render after songs loaded
                    if (hash && hash !== '#/home' && hash !== '#/') {
                        handleURLChange();
                    }

                    // 6. Background: load recordings index (memory only, enables instant play)
                    IndexManager.loadRecordingsIndex().then(() => {
                        updateSongsFromRecordingsIndex();
                    });

                    // 7. Categories loaded on demand via ensureDataForPage

                } catch (error) {
                    console.error('Fatal error:', error);
                    const content = document.getElementById('mainContent');
                    if (content) {
                        content.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">❌</div>
                            <h2>גרייז לאָודינג</h2>
                            <p>${error.message}</p>
                            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">פּרוּוו ווידער</button>
                        </div>
                    `;
                    }
                }
            }

            // Ensure required data is loaded for a specific page
            async function ensureDataForPage(page, waitForAll = false) {
                switch (page) {
                    case 'songs':
                        // Load songs, recordings, and mechabrim in parallel
                        {
                            const promises = [];
                            // Load recordings in background via IndexManager
                            if (!IndexManager.recordingsLoaded) {
                                promises.push(fetchRecordingsTable().then(() => {
                                    loadedCategories.recordings = true;
                                    updateSongsFromRecordingsIndex();
                                }));
                            }
                            if (!loadedCategories.mechabrim) {
                                promises.push(fetchMechabrimInfo().then(() => loadedCategories.mechabrim = true));
                            }
                            if (!loadedCategories.songs) {
                                promises.push(fetchSongsInBackground());
                            }
                            if (promises.length > 0) {
                                await Promise.all(promises);
                            }
                        }
                        break;
                    case 'chatzeros':
                        if (!loadedCategories.chatzeros) {
                            await fetchChatzerosInfo();
                            loadedCategories.chatzeros = true;
                        }
                        // Load songs, mechabrim, albums, and documents in parallel
                        {
                            const chatzerosDataPromises = [];
                            if (!loadedCategories.songs) {
                                chatzerosDataPromises.push(fetchSongsInBackground());
                            }
                            if (!loadedCategories.mechabrim) {
                                chatzerosDataPromises.push(fetchMechabrimInfo().then(() => loadedCategories.mechabrim = true));
                            }
                            if (!loadedCategories.albums) {
                                chatzerosDataPromises.push(fetchAlbumsInfo().then(() => loadedCategories.albums = true));
                            }
                            if (!loadedCategories.documents) {
                                chatzerosDataPromises.push(fetchDocumentsInfo().then(() => loadedCategories.documents = true));
                            }
                            if (chatzerosDataPromises.length > 0) {
                                await Promise.all(chatzerosDataPromises);
                            }
                        }
                        break;
                    case 'mechabrim':
                        if (!loadedCategories.mechabrim) {
                            await fetchMechabrimInfo();
                            loadedCategories.mechabrim = true;
                        }
                        if (!loadedCategories.songs) {
                            await fetchSongsInBackground();
                        }
                        break;
                    case 'verter':
                        if (!loadedCategories.verter) {
                            await fetchVerterInfo();
                            loadedCategories.verter = true;
                        }
                        if (!loadedCategories.songs) {
                            await fetchSongsInBackground();
                        }
                        break;
                    case 'zmanim':
                        if (!loadedCategories.zmanim) {
                            await fetchZmanimInfo();
                            loadedCategories.zmanim = true;
                        }
                        {
                            const zmanimExtraPromises = [];
                            if (!loadedCategories.piyutim) {
                                zmanimExtraPromises.push(fetchPiyutimInfo().then(() => loadedCategories.piyutim = true));
                            }
                            if (!loadedCategories.collections) {
                                zmanimExtraPromises.push(fetchCollectionsInfo().then(() => loadedCategories.collections = true));
                            }
                            if (!loadedCategories.songs) {
                                zmanimExtraPromises.push(fetchSongsInBackground());
                            }
                            if (zmanimExtraPromises.length > 0) {
                                await Promise.all(zmanimExtraPromises);
                            }
                        }
                        // Compute reverse mapping: collections → zmanim
                        // If zmaninInfo doesn't have collections from its own table,
                        // build them from collectionsInfo (which stores zmanim per collection)
                        Object.entries(collectionsInfo).forEach(([colName, colInfo]) => {
                            if (colInfo.zmanim && Array.isArray(colInfo.zmanim)) {
                                colInfo.zmanim.forEach(zmanName => {
                                    if (zmaninInfo[zmanName]) {
                                        if (!zmaninInfo[zmanName].collections) {
                                            zmaninInfo[zmanName].collections = [];
                                        }
                                        if (!zmaninInfo[zmanName].collections.includes(colName)) {
                                            zmaninInfo[zmanName].collections.push(colName);
                                        }
                                    }
                                });
                            }
                        });
                        break;
                    case 'collections':
                        if (!loadedCategories.collections) {
                            await fetchCollectionsInfo();
                            loadedCategories.collections = true;
                        }
                        if (!loadedCategories.songs) {
                            await fetchSongsInBackground();
                        }
                        break;
                    case 'piyutim':
                        if (!loadedCategories.piyutim) {
                            await fetchPiyutimInfo();
                            loadedCategories.piyutim = true;
                        }
                        if (!loadedCategories.songs) {
                            await fetchSongsInBackground();
                        }
                        break;
                    case 'resources':
                        if (!loadedCategories.resources) {
                            await fetchResourcesInfo();
                            loadedCategories.resources = true;
                        }
                        break;
                    case 'documents':
                        if (!loadedCategories.documents) {
                            await fetchDocumentsInfo();
                            loadedCategories.documents = true;
                        }
                        break;
                    case 'albums':
                        if (!loadedCategories.albums) {
                            await fetchAlbumsInfo();
                            loadedCategories.albums = true;
                        }
                        break;
                    case 'search':
                        // For search, we need ALL data loaded
                        const searchPromises = [];
                        if (!loadedCategories.chatzeros) {
                            searchPromises.push(fetchChatzerosInfo().then(() => loadedCategories.chatzeros = true));
                        }
                        if (!loadedCategories.mechabrim) {
                            searchPromises.push(fetchMechabrimInfo().then(() => loadedCategories.mechabrim = true));
                        }
                        if (!loadedCategories.verter) {
                            searchPromises.push(fetchVerterInfo().then(() => loadedCategories.verter = true));
                        }
                        if (!loadedCategories.zmanim) {
                            searchPromises.push(fetchZmanimInfo().then(() => loadedCategories.zmanim = true));
                        }
                        if (!loadedCategories.collections) {
                            searchPromises.push(fetchCollectionsInfo().then(() => loadedCategories.collections = true));
                        }
                        if (!loadedCategories.albums) {
                            searchPromises.push(fetchAlbumsInfo().then(() => loadedCategories.albums = true));
                        }
                        if (!loadedCategories.scale) {
                            searchPromises.push(fetchScaleInfo().then(() => loadedCategories.scale = true));
                        }
                        if (!loadedCategories.rhythm) {
                            searchPromises.push(fetchRhythmInfo().then(() => loadedCategories.rhythm = true));
                        }
                        if (!loadedCategories.songs) {
                            searchPromises.push(fetchSongsInBackground());
                        }
                        await Promise.all(searchPromises);
                        break;
                }
            }

            // Flag to prevent duplicate fetches
            let songsCurrentlyLoading = false;
            let songsLoadingPromise = null;

            // Fetch songs via IndexManager song index (replaces paginated Coda API fetch)
            async function fetchSongsInBackground() {
                // Prevent duplicate fetches - return existing promise if already loading
                if (songsCurrentlyLoading && songsLoadingPromise) {
                    return songsLoadingPromise;
                }
                if (songsFullyLoaded && allSongs.length > 0) return;

                songsCurrentlyLoading = true;

                songsLoadingPromise = (async () => {
                    try {
                        // Show loading wave bar
                        const waveBar = document.getElementById('loadingWaveBar');
                        if (waveBar) waveBar.classList.add('active');

                        // Load song index via IndexManager
                        const songs = await IndexManager.loadSongIndex();

                        if (songs && songs.length > 0) {
                            // Transform index data into allSongs format
                            populateAllSongsFromIndex(songs);

                            console.log(`Song index loaded: ${allSongs.length} songs`);

                            // Render song list if on songs page
                            if (currentPageView === 'songs') {
                                updateSongsCount();
                                const grid = document.getElementById('songsGrid');
                                if (grid && grid.children.length === 0) {
                                    loadMoreSongs(true);
                                }
                            }

                            // Update category pages if viewing one
                            const categoryPagesList = ['chatzeros', 'mechabrim', 'verter', 'zmanim', 'collections'];
                            if (categoryPagesList.includes(currentPageView)) {
                                updateCategoryPageCards();
                            }
                        }

                        // Hide loading wave bar
                        if (waveBar) waveBar.classList.remove('active');
                        if (currentPageView === 'songs') {
                            updateSongsCount();
                        }

                        songsCurrentlyLoading = false;
                        songsLoadingPromise = null;

                    } catch (error) {
                        console.error('Error loading songs:', error);
                        songsCurrentlyLoading = false;
                        songsLoadingPromise = null;
                        throw error;
                    }
                })();

                return songsLoadingPromise;
            }

            // Build category indices
            function buildCategoryIndices() {
                // Reset
                categories = {
                    chatzeros: {},
                    mechabrim: {},
                    verter: {},
                    zmanim: {},
                    collections: {},
                    gezungen: {},
                    scale: {},
                    ritem: {}
                };

                allSongs.forEach((song, idx) => {
                    // חצרות
                    if (song.category) {
                        song.category.split(',').forEach(c => {
                            const key = c.trim();
                            if (key) {
                                if (!categories.chatzeros[key]) categories.chatzeros[key] = [];
                                categories.chatzeros[key].push(idx);
                            }
                        });
                    }

                    // מחברים
                    if (song.mechaber) {
                        song.mechaber.split(',').forEach(m => {
                            const key = m.trim();
                            if (key) {
                                if (!categories.mechabrim[key]) categories.mechabrim[key] = [];
                                categories.mechabrim[key].push(idx);
                            }
                        });
                    }

                    // ווערטער
                    if (song.verter) {
                        song.verter.split(',').forEach(v => {
                            const key = v.trim();
                            if (key) {
                                if (!categories.verter[key]) categories.verter[key] = [];
                                categories.verter[key].push(idx);
                            }
                        });
                    }

                    // זמנים/פיוטים (from פאסיג אויף)
                    if (song.pasigOif) {
                        song.pasigOif.split(',').forEach(z => {
                            const key = z.trim();
                            if (key) {
                                if (!categories.zmanim[key]) categories.zmanim[key] = [];
                                categories.zmanim[key].push(idx);
                            }
                        });
                    }

                    // קאלעקשאנס
                    if (song.collections) {
                        song.collections.split(',').forEach(col => {
                            const key = col.trim();
                            if (key) {
                                if (!categories.collections[key]) categories.collections[key] = [];
                                categories.collections[key].push(idx);
                            }
                        });
                    }

                    // געזונגען אויף
                    if (song.gezungen) {
                        song.gezungen.split(',').forEach(g => {
                            const key = g.trim();
                            if (key) {
                                if (!categories.gezungen[key]) categories.gezungen[key] = [];
                                categories.gezungen[key].push(idx);
                            }
                        });
                    }

                    // סקעיל
                    if (song.scale) {
                        song.scale.split(',').forEach(s => {
                            const key = s.trim();
                            if (key) {
                                if (!categories.scale[key]) categories.scale[key] = [];
                                categories.scale[key].push(idx);
                            }
                        });
                    }

                    // ריטעם
                    if (song.ritem) {
                        song.ritem.split(',').forEach(r => {
                            const key = r.trim();
                            if (key) {
                                if (!categories.ritem[key]) categories.ritem[key] = [];
                                categories.ritem[key].push(idx);
                            }
                        });
                    }
                });
            }

            // Update navigation counts
            function updateNavCounts() {
                // Nav counts removed - function kept for compatibility
            }

            // Navigation - with lazy loading
            // Generate skeleton loader HTML for a page
            function getSkeletonForPage(page) {
                const pageThemes = {
                    'songs': 'page-theme-nigun',
                    'chatzeros': 'page-theme-chatzer',
                    'mechabrim': 'page-theme-mechaber',
                    'verter': 'page-theme-verter',
                    'zmanim': 'page-theme-zman',
                    'piyutim': 'page-theme-piyut',
                    'collections': 'page-theme-collection',
                    'resources': 'page-theme-resource',
                    'documents': 'page-theme-document',
                    'albums': 'page-theme-album',
                    'music': 'page-theme-music'
                };

                // Page titles and subtitles for real headers
                const pageTitles = {
                    'songs': { title: 'ניגונים', subtitle: '', countLabel: 'ניגונים' },
                    'chatzeros': { title: 'חצרות', subtitle: 'חצרות', countLabel: 'חצרות' },
                    'mechabrim': { title: 'מחברים', subtitle: 'מחברים', countLabel: 'מחברים' },
                    'verter': { title: 'ווערטער', subtitle: 'ווערטער', countLabel: 'ווערטער' },
                    'zmanim': { title: 'זמנים', subtitle: 'זמנים', countLabel: 'זמנים' },
                    'piyutim': { title: 'פיוטים', subtitle: 'פיוטים', countLabel: 'פיוטים' },
                    'collections': { title: 'קאלעקשאנס', subtitle: 'קאלעקשאנס', countLabel: 'קאלעקשאנס' },
                    'resources': { title: 'רעסורסן', subtitle: 'רעסורסן', countLabel: 'רעסורסן' },
                    'documents': { title: 'דאקומענטן', subtitle: 'דאקומענטן', countLabel: 'דאקומענטן' },
                    'albums': { title: 'אלבומס', subtitle: 'אלבומס', countLabel: 'אלבומס' },
                    'music': { title: 'מוזיק', subtitle: 'מוזיק', countLabel: 'מוזיק' }
                };

                const themeClass = pageThemes[page] || 'page-theme-nigun';
                const pageInfo = pageTitles[page] || { title: '', subtitle: '', countLabel: '' };

                // Songs page has a different layout with sidebar
                if (page === 'songs') {
                    return `
                    <div class="${themeClass}">
                        <div class="page-title">
                            <div class="page-title-bar">${pageInfo.title}</div>
                            <div class="subtitle"><span class="count-number">0</span></div>
                            <div class="loading-wave-bar active" id="loadingWaveBar"></div>
                        </div>
                        <div class="skeleton-songs-layout">
                            <div class="skeleton-songs-main">
                                <div class="skeleton-song-row"></div>
                                <div class="skeleton-song-row"></div>
                                <div class="skeleton-song-row"></div>
                                <div class="skeleton-song-row"></div>
                                <div class="skeleton-song-row"></div>
                                <div class="skeleton-song-row"></div>
                                <div class="skeleton-song-row"></div>
                                <div class="skeleton-song-row"></div>
                            </div>
                            <div class="skeleton-songs-sidebar">
                                <div class="skeleton skeleton-search-box"></div>
                                <div class="skeleton skeleton-filter"></div>
                                <div class="skeleton skeleton-filter"></div>
                                <div class="skeleton skeleton-filter"></div>
                                <div class="skeleton skeleton-filter"></div>
                            </div>
                        </div>
                    </div>
                `;
                }

                // Category pages (chatzeros, mechabrim, etc.) with grid - REAL header, skeleton cards
                return `
                <div class="${themeClass}">
                    <div class="page-title">
                        <div class="page-title-bar">${pageInfo.title}</div>
                        <div class="subtitle"><span class="subtitle-count">0</span></div>
                        <div class="loading-wave-bar active" id="categoryLoader"></div>
                    </div>
                    <div class="skeleton-grid">
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                    </div>
                </div>
            `;
            }

            // Info pages list for special transitions
            const infoPages = ['about', 'instructions', 'stats', 'credits', 'thanks', 'terms', 'contribute'];

            // Page order for determining navigation direction
            const pageOrder = ['home', 'songs', 'mechabrim', 'chatzeros', 'zmanim', 'collections', 'verter', 'music', 'resources', 'documents', 'albums'];

            // Get navigation direction based on page order
            function getNavigationDirection(fromPage, toPage) {
                const fromIdx = pageOrder.indexOf(fromPage);
                const toIdx = pageOrder.indexOf(toPage);
                // If one of the pages is not in the list (info pages, etc.), default to forward
                if (fromIdx === -1 || toIdx === -1) return 'forward';
                return toIdx > fromIdx ? 'forward' : 'backward';
            }

            async function navigateTo(page) {
                hideAllDropdowns();
                const content = document.getElementById('mainContent');
                const isHomePage = page === 'home';
                const wasHomePage = currentPageView === 'home';
                const isInfoPage = infoPages.includes(page);
                const wasInfoPage = infoPages.includes(currentPageView);

                // Map URL page names to internal page names
                const internalPage = page === 'nigunim' ? 'songs' : page;
                const direction = getNavigationDirection(currentPageView, internalPage);

                // Determine exit animation class
                let exitClass;
                if (wasHomePage) {
                    exitClass = 'page-exit-home'; // Home always exits to right
                } else if (wasInfoPage) {
                    exitClass = 'page-exit-info'; // Info pages just fade out
                } else {
                    // Content pages: direction-aware
                    exitClass = direction === 'forward' ? 'page-exit' : 'page-exit-back';
                }

                // Add exit animation
                if (content && content.children.length > 0) {
                    content.classList.add(exitClass);
                    await new Promise(r => setTimeout(r, wasInfoPage ? 150 : 200));
                    content.classList.remove(exitClass);
                }

                currentPageView = internalPage;
                currentPage = 1;
                currentDetailView = null; // Clear any detail view

                updateURL();

                // Track if we showed skeleton (data wasn't loaded)
                const hadSkeleton = internalPage !== 'home' && !isInfoPage && !isDataLoadedForPage(internalPage);

                // Show skeleton loader for pages that need data
                if (hadSkeleton) {
                    if (content) {
                        content.innerHTML = getSkeletonForPage(internalPage);
                    }
                    // Load required data for this page
                    await ensureDataForPage(internalPage);
                }

                renderCurrentPage();

                // Determine enter animation class
                // Skip animation if we showed skeleton (header is already visible)
                let enterClass;
                if (hadSkeleton) {
                    enterClass = null; // Coming from skeleton - no page animation needed
                } else if (isHomePage) {
                    enterClass = null; // Home page uses its own stagger animation, skip page transition
                } else if (isInfoPage) {
                    enterClass = 'page-enter-info'; // Info pages just fade in
                } else {
                    // Content pages (including songs): direction-aware
                    enterClass = direction === 'forward' ? 'page-enter' : 'page-enter-back';
                }

                // Add enter animation
                if (content && enterClass) {
                    content.classList.add(enterClass);
                    setTimeout(() => content.classList.remove(enterClass), 350);
                }

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // Check if data is already loaded for a page
            function isDataLoadedForPage(page) {
                switch (page) {
                    case 'songs': return loadedCategories.songs && allSongs.length > 0;
                    case 'chatzeros': return loadedCategories.chatzeros && Object.keys(chatzerosInfo).length > 0;
                    case 'mechabrim': return loadedCategories.mechabrim && Object.keys(mechabrimInfo).length > 0;
                    case 'verter': return loadedCategories.verter && Object.keys(verterInfo).length > 0;
                    case 'zmanim': return loadedCategories.zmanim && Object.keys(zmaninInfo).length > 0;
                    case 'collections': return loadedCategories.collections && Object.keys(collectionsInfo).length > 0;
                    case 'piyutim': return loadedCategories.piyutim && Object.keys(piyutimInfo).length > 0;
                    case 'resources': return loadedCategories.resources && Object.keys(resourcesInfo).length > 0;
                    case 'documents': return loadedCategories.documents && Object.keys(documentsInfo).length > 0;
                    case 'albums': return loadedCategories.albums && Object.keys(albumsInfo).length > 0;
                    case 'search':
                        // Search needs all data loaded
                        return loadedCategories.songs && allSongs.length > 0 &&
                            loadedCategories.chatzeros && Object.keys(chatzerosInfo).length > 0 &&
                            loadedCategories.mechabrim && Object.keys(mechabrimInfo).length > 0 &&
                            loadedCategories.verter && Object.keys(verterInfo).length > 0 &&
                            loadedCategories.zmanim && Object.keys(zmaninInfo).length > 0 &&
                            loadedCategories.collections && Object.keys(collectionsInfo).length > 0 &&
                            loadedCategories.albums && Object.keys(albumsInfo).length > 0;
                    default: return true;
                }
            }

            // Scroll to section on home page
            function scrollToSection(sectionId) {
                hideAllDropdowns();
                navigateTo('home');
                setTimeout(() => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 150);
            }

            // Open add modal (placeholder for future)
            function openAddModal() {
                hideAllDropdowns();
                alert('די אפציע צו צולייגן א ניגון קומט באלד!');
            }

            // Hide all dropdowns - not needed anymore since CSS hover handles this naturally
            function hideAllDropdowns() {
                // CSS hover automatically shows/hides dropdowns
                // This function exists for backwards compatibility but does nothing
            }

            // Close dropdowns when clicking on items
            document.addEventListener('click', function (e) {
                if (e.target.closest('.nav-dropdown-item')) {
                    hideAllDropdowns();
                }
            });

            // Render current page
            function renderCurrentPage() {
                // Check if we're in a detail view
                if (currentDetailView) {
                    renderDetailPage();
                    return;
                }

                const content = document.getElementById('mainContent');

                switch (currentPageView) {
                    case 'home':
                        renderHomePage(content);
                        break;
                    case 'search':
                        renderSearchResultsPage(content);
                        break;
                    case 'songs':
                        renderAllSongsPage(content);
                        break;
                    case 'chatzeros':
                        renderCategoryPage(content, 'chatzeros', 'חצרות', '', 'אלע חסידישע חצרות און זייערע ניגונים');
                        break;
                    case 'mechabrim':
                        renderCategoryPage(content, 'mechabrim', 'מחברים', '<div class="mechaber-icon"></div>', 'די מחברים פון די ניגונים');
                        break;
                    case 'verter':
                        renderCategoryPage(content, 'verter', 'ווערטער', '', 'ניגונים לויט די ווערטער');
                        break;
                    case 'zmanim':
                        renderZmanimPage(content);
                        break;
                    case 'music':
                        renderMusicPage(content);
                        break;
                    case 'collections':
                        renderCollectionsPage(content);
                        break;
                    case 'piyutim':
                        renderPiyutimPage(content);
                        break;
                    case 'resources':
                        renderResourcesPage(content);
                        break;
                    case 'documents':
                        renderDocumentsPage(content);
                        break;
                    case 'albums':
                        renderAlbumsPage(content);
                        break;
                    case 'about':
                        renderAboutPage(content);
                        break;
                    case 'instructions':
                        renderInstructionsPage(content);
                        break;
                    case 'stats':
                        renderStatsPage(content);
                        break;
                    case 'credits':
                        renderCreditsPage(content);
                        break;
                    case 'thanks':
                        renderThanksPage(content);
                        break;
                    case 'terms':
                        renderTermsPage(content);
                        break;
                    case 'contribute':
                        renderContributePage(content);
                        break;
                }
            }

            // Render home page
            function renderHomePage(container) {
                // Use cached stats from the stats table (fast, no counting needed)
                const totalSongs = cachedStats.niggunim || 0;
                const totalChatzeros = cachedStats.chatzeros || 0;
                const totalMechabrim = cachedStats.mechabrim || 0;
                const totalVerter = cachedStats.verter || 0;
                const totalZmanim = cachedStats.zmanim || 0;
                const totalCollections = cachedStats.collections || 0;
                const totalPiyutim = cachedStats.piyutim || 0;

                container.innerHTML = `
                <div class="home-page">
                    <!-- Hero Banner -->
                    <div class="home-hero">
                        <div class="hero-musical-bg" id="heroMusicalBg">
                            <!-- Bars will be generated by JS -->
                        </div>
                        <div class="home-hero-content">
                            <div class="home-logo"></div>
                            <h1 class="home-title">אוצר הניגונים</h1>
                            <p class="home-subtitle">א דאטאבעיס פון חסידישע ניגונים</p>
                        </div>
                    </div>

                    <!-- Search Box -->
                    <div class="home-search-section">
                        <div class="home-search-box">
                            <input type="text"
                                   id="homeSearchInput"
                                   class="home-search-input"
                                   placeholder="זוך א ניגון, מחבר, חצר..."
                                   onkeyup="handleHomeSearch(event)">
                            <button class="home-search-btn" onclick="executeHomeSearch()">זוך</button>
                        </div>
                    </div>

                    <!-- Statistics - 2 Stack Layout -->
                    <div class="home-stats-grid">
                        <a class="home-stat-hero" href="#/nigunim">
                            <div class="home-stat-number">${totalSongs}</div>
                            <div class="home-stat-label">ניגונים</div>
                            <div class="home-stat-subtitle">אינעם דאטאבעיס</div>
                        </a>
                        <div class="home-stats-right">
                            <div class="home-stats-row">
                                <a class="home-stat-card stat-mechaber" href="#/mechabrim">
                                    <div class="home-stat-number">${totalMechabrim}</div>
                                    <div class="home-stat-label">מחברים</div>
                                </a>
                                <a class="home-stat-card stat-chatzer" href="#/chatzeros">
                                    <div class="home-stat-number">${totalChatzeros}</div>
                                    <div class="home-stat-label">חצרות</div>
                                </a>
                            </div>
                            <div class="home-stats-row">
                                <a class="home-stat-card stat-verter" href="#/verter">
                                    <div class="home-stat-number">${totalVerter}</div>
                                    <div class="home-stat-label">ווערטער</div>
                                </a>
                                <a class="home-stat-card stat-zman" href="#/zmanim">
                                    <div class="home-stat-number">${totalZmanim}</div>
                                    <div class="home-stat-label">זמנים</div>
                                </a>
                                <a class="home-stat-card stat-collection" href="#/collections">
                                    <div class="home-stat-number">${totalCollections}</div>
                                    <div class="home-stat-label">קאלעקשאנס</div>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Link -->
                    <a class="home-stats-link" href="#/stats">
                        <div class="home-stats-link-line left"></div>
                        <span class="home-stats-link-text">סטאטיסטיקס</span>
                        <div class="home-stats-link-line"></div>
                    </a>

                    <!-- About Us Section -->
                    <div class="home-about-section">
                        <a class="home-about-header" href="#/about">
                            <span class="home-about-title">איבער אונז</span>
                            <span class="home-about-arrow">←</span>
                        </a>
                        <div class="home-about-links">
                            <a class="home-about-link" href="#/about">אונזער ציל</a>
                            <a class="home-about-link" href="#/instructions">אנווייזונגען</a>
                            <a class="home-about-link" href="#/credits">קרעדיטס</a>
                            <a class="home-about-link" href="#/thanks">התודה והברכה</a>
                        </div>
                    </div>

                    <!-- Terms Link -->
                    <a class="home-terms-link" href="#/terms">
                        Terms of Use
                    </a>
                </div>
            `;

                // Apply staggered animations to all home page elements
                requestAnimationFrame(() => {
                    const elements = container.querySelectorAll(
                        '.home-hero, .home-search-section, .home-stat-hero, .home-stat-card, .home-stats-link, .home-section-title, .home-link-card, .home-section, .home-about-section, .home-terms-link'
                    );

                    elements.forEach((el, i) => {
                        // Start with opacity 0 (handled by class, but ensure immediate effect)
                        // el.style.opacity = '0'; // Not strictly needed if class is added immediately, but safer?
                        // actually the class .stagger-fade-up has opacity: 0.

                        // delay
                        el.style.animationDelay = `${i * 0.08}s`;
                        el.classList.add('stagger-fade-up');

                        // Remove animation class after it's done to allow hover transforms to work cleanly
                        el.addEventListener('animationend', () => {
                            el.classList.remove('stagger-fade-up');
                            // Ensure final state is visible and clean for interactions
                            el.style.opacity = '1';
                            el.style.transform = '';
                            el.style.animationDelay = '';
                        }, { once: true });
                    });

                    // Animate count-up for stat numbers
                    const statNumbers = container.querySelectorAll('.home-stat-number');
                    statNumbers.forEach((el, i) => {
                        const finalValue = parseInt(el.textContent) || 0;
                        if (finalValue > 0) {
                            el.textContent = '0';
                            el.classList.add('number-animate');
                            el.style.animationDelay = `${i * 0.08}s`;

                            // Count up animation
                            setTimeout(() => {
                                const duration = 600;
                                const startTime = performance.now();
                                const animate = (currentTime) => {
                                    const elapsed = currentTime - startTime;
                                    const progress = Math.min(elapsed / duration, 1);
                                    // Easing function for smooth count
                                    const eased = 1 - Math.pow(1 - progress, 3);
                                    el.textContent = Math.floor(eased * finalValue);
                                    if (progress < 1) {
                                        requestAnimationFrame(animate);
                                    } else {
                                        el.textContent = finalValue;
                                    }
                                };
                                requestAnimationFrame(animate);
                            }, i * 80 + 200);
                        }
                    });
                });

                // Generate floating musical notes (Starfield / Warp Effect)
                const musicContainer = document.getElementById('heroMusicalBg');
                if (musicContainer) {
                    // User requested: "Slower", "More", "Bigger pieces", "More in middle"
                    const noteCount = 150; // Increased count significantly to fill the middle
                    const symbols = ['♪', '♫', '♩', '♬', '♭', '♮', '♯'];
                    let html = '';

                    // Radius must be large enough to reach corners of a wide screen
                    const maxRadius = 1500;

                    for (let i = 0; i < noteCount; i++) {
                        const symbol = symbols[Math.floor(Math.random() * symbols.length)];

                        // Random angle
                        const angle = Math.random() * Math.PI * 2;

                        // Calculate target X and Y based on angle and radius
                        const tx = Math.cos(angle) * maxRadius;
                        const ty = Math.sin(angle) * maxRadius;

                        // Random rotation for the note itself
                        const rot = (Math.random() * 360 - 180) + 'deg';

                        // Slower duration: 25s to 45s (User requested slower)
                        const duration = 25 + Math.random() * 20;
                        // Spread delay across the entire duration so they are strictly uniform
                        const delay = Math.random() * duration;

                        // Bigger sizes: 50px to 90px
                        const size = 50 + Math.random() * 40;

                        // Decide on a specific wander animation pattern (1, 2, or 3)
                        const wanderClass = 'wander-' + (Math.floor(Math.random() * 3) + 1);

                        // Note: animation-duration applies to the FLIGHT (wrapper).
                        // We can let the inner wander animation inherit it or have its own speed. 
                        // To keep them synced (one full drift per flight), we'll use the same duration variable.

                        html += `
                        <div class="note-wrapper" style="--tx: ${tx}px; --ty: ${ty}px; animation-duration: ${duration}s; animation-delay: -${delay}s;">
                            <span class="musical-note ${wanderClass}" style="--rot: ${rot}; font-size: ${size}px; animation-duration: ${duration}s;">${symbol}</span>
                        </div>
                    `;
                    }
                    musicContainer.innerHTML = html;
                }
            }

            // Helper function to generate info pages sub-navigation
            function getInfoNavHTML(activePage) {
                const pages = [
                    { id: 'about', label: 'אונזער ציל' },
                    { id: 'instructions', label: 'אנווייזונגען' },
                    { id: 'contribute', label: 'לייג צו', featured: true },
                    { id: 'credits', label: 'קרעדיטס' },
                    { id: 'thanks', label: 'התודה והברכה' }
                ];

                return `
                <nav class="info-nav">
                    ${pages.map((page, index) => `
                        <a class="info-nav-item ${activePage === page.id ? 'active' : ''} ${page.featured ? 'info-nav-featured' : ''}"
                             href="#/${page.id}">
                            ${page.label}
                        </a>
                    `).join('')}
                </nav>
            `;
            }

            // Render About Page (אונזער ציל)
            function renderAboutPage(container) {
                container.innerHTML = `
                <div class="info-page">
                    ${getInfoNavHTML('about')}

                    <div class="info-page-header">
                        <h1 class="info-page-title">אונזער ציל</h1>
                        <p class="info-page-subtitle">די מעגליכקייטן און בענעפיטן פונעם דאטאבעיס</p>
                    </div>

                    <div class="info-page-content">
                        <div class="goals-bricks">
                            <div class="goals-brick-row">
                                <div class="goal-brick">
                                    <div class="goal-brick-text"><strong>אלע חסידישע ניגונים</strong> וואס ווערן געזינגען בחצרות הקודש <strong>צאמגענומען אויף איין פלאץ</strong></div>
                                </div>
                            </div>

                            <div class="goals-brick-row">
                                <div class="goal-brick">
                                    <div class="goal-brick-text"><strong>א סעירטש קנעפל</strong><br>צו טרעפן סיי וועלכן ניגון</div>
                                </div>
                                <div class="goal-brick">
                                    <div class="goal-brick-text"><strong>דעטאלירטע דאקומענטאציע</strong><br>פון מקורות פון אלטע ניגונים</div>
                                </div>
                                <div class="goal-brick">
                                    <div class="goal-brick-text"><strong>היסטארישע רעקארדירונגען</strong><br>מיט די ארגינעלע קנייטשן</div>
                                </div>
                            </div>

                            <div class="goals-brick-row">
                                <div class="goal-brick">
                                    <div class="goal-brick-text"><strong>געשריבענע נאטן</strong><br>אויף ניגונים וואס פארמאגן נישט קיין ווערטער</div>
                                </div>
                                <div class="goal-brick">
                                    <div class="goal-brick-text"><strong>א רשימה מיט גוטע סימנים</strong><br>אויף ניגונים וואס פארמאגן נישט קיין ווערטער</div>
                                </div>
                            </div>

                            <div class="goals-brick-row">
                                <div class="goal-brick">
                                    <div class="goal-brick-text"><strong>העכסט פראפעסינאלע רעקארדירונגען</strong><br>פון אלע חסידישע ניגונים</div>
                                </div>
                                <div class="goal-brick">
                                    <div class="goal-brick-text">חסידישע ניגונים ערשטמאליג אויסגעשטעלט<br><strong>לויט די ריטעם און סקעיל</strong></div>
                                </div>
                                <div class="goal-brick">
                                    <div class="goal-brick-text"><strong>קאלעקשאנס פון ניגונים</strong><br>וואס זענען פאסיג צו ווערן געזינגען ביי סיי וועלכן מאורע</div>
                                </div>
                            </div>

                            <div class="goals-brick-row">
                                <div class="goal-brick">
                                    <div class="goal-brick-text">פאסיגע געדאנקען פון ניגונים וואס קענען ווערן געזינגען<br><strong>אויף פיוטים ביים דאווענען</strong></div>
                                </div>
                                <div class="goal-brick">
                                    <div class="goal-brick-text">פאסיגע געדאנקען פון ניגונים וואס קענען ווערן געזינגען<br><strong>אויף זמירות ביי סעודות שבת ויו״ט</strong></div>
                                </div>
                            </div>
                        </div>

                        <div class="goals-warning">
                            <div class="goals-warning-title">אכטונג!</div>
                            <div class="goals-warning-text"><strong>דער דאטאבעיס איז געמאכט אויסדרוקלעך נאר פאר חסידישע ניגונים וואס ווערן געזינגען בחצרות הקודש</strong></div>
                        </div>

                        <div class="goals-contact">
                            <div class="goals-contact-title">הערות והארות</div>
                            <div class="goals-contact-text">פאר סיי וועלכע הערות אדער זיך צו פארבינדן מיט מערכת אידישע ניגונים</div>
                            <a href="mailto:yiddishenigunim@gmail.com" class="goals-contact-email">yiddishenigunim@gmail.com</a>
                        </div>
                    </div>
                </div>
            `;
            }

            // Render Instructions Page (אנווייזונגען)
            function renderInstructionsPage(container) {
                container.innerHTML = `
                <div class="info-page">
                    ${getInfoNavHTML('instructions')}

                    <div class="info-page-header">
                        <h1 class="info-page-title">אנווייזונגען</h1>
                        <p class="info-page-subtitle">ווי אזוי צו נוצן דעם אוצר הניגונים</p>
                    </div>

                    <div class="info-page-content">
                        <div class="instructions-page-grid">
                            <div class="instruction-page-item">
                                <div class="instruction-page-number">1</div>
                                <div class="instruction-page-text">
                                    <strong>...</strong>
                                    ...
                                </div>
                            </div>
                            <div class="instruction-page-item">
                                <div class="instruction-page-number">2</div>
                                <div class="instruction-page-text">
                                    <strong>...</strong>
                                    ...
                                </div>
                            </div>
                            <div class="instruction-page-item">
                                <div class="instruction-page-number">3</div>
                                <div class="instruction-page-text">
                                    <strong>...</strong>
                                    ...
                                </div>
                            </div>
                            <div class="instruction-page-item">
                                <div class="instruction-page-number">4</div>
                                <div class="instruction-page-text">
                                    <strong>...</strong>
                                    ...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }

            // Render Stats Page (סטאטיסטיקס)
            function renderStatsPage(container) {
                const totalSongs = cachedStats.niggunim || 0;
                const totalChatzeros = cachedStats.chatzeros || 0;
                const totalMechabrim = cachedStats.mechabrim || 0;
                const totalVerter = cachedStats.verter || 0;
                const totalZmanim = cachedStats.zmanim || 0;
                const totalCollections = cachedStats.collections || 0;

                container.innerHTML = `
                <div class="info-page">
                    ${getInfoNavHTML('stats')}

                    <div class="info-page-header">
                        <h1 class="info-page-title">סטאטיסטיקס</h1>
                        <p class="info-page-subtitle">די צאלן פון אונזער זאמלונג</p>
                    </div>

                    <div class="info-page-content">
                        <div class="stats-page-grid">
                            <a class="stats-page-card" href="#/nigunim">
                                <div class="stats-page-number">${totalSongs}</div>
                                <div class="stats-page-label">ניגונים</div>
                            </a>
                            <a class="stats-page-card" href="#/chatzeros">
                                <div class="stats-page-number">${totalChatzeros}</div>
                                <div class="stats-page-label">חצרות</div>
                            </a>
                            <a class="stats-page-card" href="#/mechabrim">
                                <div class="stats-page-number">${totalMechabrim}</div>
                                <div class="stats-page-label">מחברים</div>
                            </a>
                            <a class="stats-page-card" href="#/verter">
                                <div class="stats-page-number">${totalVerter}</div>
                                <div class="stats-page-label">ווערטער</div>
                            </a>
                            <a class="stats-page-card" href="#/zmanim">
                                <div class="stats-page-number">${totalZmanim}</div>
                                <div class="stats-page-label">זמנים</div>
                            </a>
                            <a class="stats-page-card" href="#/collections">
                                <div class="stats-page-number">${totalCollections}</div>
                                <div class="stats-page-label">קאלעקשאנס</div>
                            </a>
                        </div>
                    </div>
                </div>
                </div>
            `;

                // Animate numbers
                const statNumbers = container.querySelectorAll('.stats-page-number');
                statNumbers.forEach((el, index) => {
                    const value = parseInt(el.textContent.replace(/,/g, ''));
                    if (!isNaN(value)) {
                        // Reset to 0 so animation starts from scratch
                        el.textContent = '0';
                        // Stagger animation slightly
                        setTimeout(() => {
                            animateCountUp(el, value);
                        }, index * 100);
                    }
                });
            }

            // Render Credits Page (קרעדיטס)
            function renderCreditsPage(container) {
                container.innerHTML = `
                <div class="info-page">
                    ${getInfoNavHTML('credits')}

                    <div class="info-page-header">
                        <h1 class="info-page-title">קרעדיטס</h1>
                        <p class="info-page-subtitle">די מענטשן הינטער דעם פראיעקט</p>
                    </div>

                    <div class="info-page-content">
                        <p>-</p>

                        <div class="credits-page-list">
                            <div class="credit-page-item">
                                <strong>א:</strong> ...
                            </div>
                            <div class="credit-page-item">
                                <strong>ב:</strong> ...
                            </div>
                            <div class="credit-page-item">
                                <strong>ג:</strong> ...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }

            // Render Thanks Page (התודה והברכה)
            function renderThanksPage(container) {
                container.innerHTML = `
                <div class="info-page">
                    ${getInfoNavHTML('thanks')}

                    <div class="info-page-header">
                        <h1 class="info-page-title">התודה והברכה</h1>
                        <p class="info-page-subtitle">א יישר כח צו אלע ביישטייערער</p>
                    </div>

                    <div class="info-page-content">
                        <p>א גרויסן יישר כח צו אלע וואס טוען ביישטייערט צו דעם פראיעקט:</p>

                        <ul class="thanks-page-list">
                            <li>די וואס טוען ארויפלייגן ניגונים און רעקארדירונגען</li>
                            <li>די וואס האבן העלפן מיט אינפארמאציע וועגן די ניגונים</li>
                            <li>די וואס האבן טיילן מיט פידבעק און פארשלאגן</li>
                            <li>אלע וואס נוצן און פארשפרייטן דעם אוצר</li>
                        </ul>

                        <div class="blessing-text">
                            יהי רצון שנזכה להמשיך ולחזק כח הנגינה הטהורה בישראל, ובקרוב נזכה לשמוע שירת הלויים בביאת גואל צדק בב"א!
                        </div>
                    </div>
                </div>
            `;
            }

            // Render Terms Page (Terms of Use)
            function renderTermsPage(container) {
                container.innerHTML = `
                <div class="info-page">
                    ${getInfoNavHTML('terms')}

                    <div class="info-page-header">
                        <h1 class="info-page-title">Terms of Use</h1>
                        <p class="info-page-subtitle">באדינגונגען פאר נוצן די וועבזייטל</p>
                    </div>

                    <div class="info-page-content terms-page-content">
                        <p class="terms-last-updated">Last Updated: 12/1/2025</p>

                        <p class="terms-intro">Welcome to OITZERHANIGUNIM.ORG. By accessing or using this website, you agree to the following Terms of Use. Please read them carefully. If you do not agree with any part of these Terms, you may not use the site.</p>

                        <hr class="terms-divider">

                        <div class="terms-section">
                            <h2 class="terms-section-header">1. Overview</h2>
                            <p>OITZERHANIGUNIM.ORG provides a song database where users may view information and optionally upload audio recordings. All audio content is uploaded directly by users.</p>
                            <p>OITZERHANIGUNIM.ORG does not host, create, or verify the content uploaded by users.</p>
                        </div>

                        <hr class="terms-divider">

                        <div class="terms-section">
                            <h2 class="terms-section-header">2. Eligibility</h2>
                            <p>To upload files or submit content, you must log in through an approved authentication method (such as Google Login).</p>
                            <p>You are responsible for maintaining the security of your login account.</p>
                        </div>

                        <hr class="terms-divider">

                        <div class="terms-section">
                            <h2 class="terms-section-header">3. User Responsibilities</h2>
                            <p>By using this site, you agree that you will:</p>
                            <ul>
                                <li>Provide accurate information</li>
                                <li>Use the site only for lawful purposes</li>
                                <li>Not harm, interfere with, or attempt to bypass any site security</li>
                                <li>Not upload harmful, malicious, or corrupted files</li>
                                <li>Follow all applicable copyright and intellectual-property laws</li>
                            </ul>
                            <p>Any misuse of the site may result in suspension or blocking of access.</p>
                        </div>

                        <hr class="terms-divider">

                        <div class="terms-section">
                            <h2 class="terms-section-header">4. User-Uploaded Content</h2>
                            <p>When you upload audio files or other materials, you agree that:</p>
                            <ol>
                                <li>You are the owner of the recording or have full permission to upload it</li>
                                <li>The content does not violate anyone's copyright or rights</li>
                                <li>You grant OITZERHANIGUNIM.ORG permission to display and store the uploaded file within the platform</li>
                                <li>You accept full responsibility for any issues or claims arising from your upload</li>
                                <li>You will not upload illegal, harmful, infringing, or abusive material</li>
                            </ol>
                            <p>OITZERHANIGUNIM.ORG is not responsible for user-uploaded content and does not guarantee legality, accuracy, or rights of any material provided by users.</p>
                        </div>

                        <hr class="terms-divider">

                        <div class="terms-section">
                            <h2 class="terms-section-header">5. Content Removal</h2>
                            <p>We reserve the right to:</p>
                            <ul>
                                <li>Remove or disable access to any content</li>
                                <li>Block or suspend users who violate these Terms</li>
                                <li>Remove content upon receiving a proper complaint</li>
                            </ul>
                            <p>These actions may be taken with or without notice.</p>
                        </div>

                        <hr class="terms-divider">

                        <div class="terms-section">
                            <h2 class="terms-section-header">6. Copyright Complaints & Takedown Policy</h2>
                            <p>If you believe your copyrighted material has been uploaded without permission, please contact us at:</p>
                            <p><span class="terms-email">yiddishenigunim@gmail.com</span></p>
                            <p>Include:</p>
                            <ul>
                                <li>The URL or link to the infringing content</li>
                                <li>A description of your work</li>
                                <li>Your contact information</li>
                                <li>A statement confirming that you believe the use is unauthorized</li>
                            </ul>
                            <p>We will remove the content promptly.</p>
                        </div>

                        <hr class="terms-divider">

                        <div class="terms-section">
                            <h2 class="terms-section-header">7. Site Availability & Updates</h2>
                            <p>The site is provided on an "as-is" and "as-available" basis.</p>
                            <p>We may update, modify, or discontinue any part of the site at any time.</p>
                        </div>

                        <hr class="terms-divider">

                        <div class="terms-section">
                            <h2 class="terms-section-header">8. No Warranty</h2>
                            <p>We do not guarantee:</p>
                            <ul>
                                <li>The accuracy or completeness of the content</li>
                                <li>That the site will always be available or error-free</li>
                                <li>That user uploads are legally permitted</li>
                            </ul>
                            <p>All use is at your own risk.</p>
                        </div>

                        <hr class="terms-divider">

                        <div class="terms-section">
                            <h2 class="terms-section-header">9. Limitation of Liability</h2>
                            <p>To the fullest extent permitted by law:</p>
                            <p>OITZERHANIGUNIM.ORG is not liable for any damages, losses, claims, or issues arising from:</p>
                            <ul>
                                <li>User-uploaded content</li>
                                <li>Copyright disputes</li>
                                <li>Technical problems or downtime</li>
                                <li>Data loss</li>
                                <li>Misuse of the site by others</li>
                            </ul>
                            <p>You agree to hold OITZERHANIGUNIM.ORG, its administrators, and affiliates harmless from any such claims.</p>
                        </div>

                        <hr class="terms-divider">

                        <div class="terms-section">
                            <h2 class="terms-section-header">10. Changes to These Terms</h2>
                            <p>We may update or revise these Terms from time to time.</p>
                            <p>The updated version will take effect when posted on the site.</p>
                            <p>Your continued use of the site means you accept the revised Terms.</p>
                        </div>

                        <hr class="terms-divider">

                        <div class="terms-section">
                            <h2 class="terms-section-header">11. Contact</h2>
                            <p>For questions or concerns, please contact:</p>
                            <p><span class="terms-email">yiddishenigunim@gmail.com</span></p>
                        </div>
                    </div>
                </div>
            `;
            }

            // Render Contribute Page (צולייגן אינפֿאָרמאַציע)
            function renderContributePage(container) {
                container.innerHTML = `
                <div class="info-page contribute-page">
                    ${getInfoNavHTML('contribute')}

                    <div class="contribute-hero">
                        <div class="contribute-hero-content">
                            <h1 class="contribute-hero-title">ביישטייערט צום אוצר</h1>
                            <p class="contribute-hero-subtitle">העלפט אונז פארגרעסערן און פארבעסערן דעם דאטאבעיס</p>
                        </div>
                    </div>

                    <div class="info-page-content contribute-content">
                        <!-- Main Nigun Button -->
                        <a href="https://coda.io/form/_deegJpdfVC5" class="contribute-main-btn contribute-btn-main-gradient" target="_blank" rel="noopener">
                            <span class="contribute-main-text">לייג צו / אפדעיט א <strong>ניגון</strong></span>
                            <span class="btn-external">↗</span>
                        </a>

                        <!-- Category Buttons Grid -->
                        <div class="contribute-grid">
                            <a href="https://coda.io/form/_dpAUcVRsKjH" class="contribute-btn contribute-btn-mechaber" target="_blank" rel="noopener">
                                <span class="contribute-btn-text">לייג צו / אפדעיט א <strong>מחבר</strong></span>
                                <span class="btn-external">↗</span>
                            </a>
                            
                            <a href="https://coda.io/form/_dctTYOyS0RX" class="contribute-btn contribute-btn-chatzer" target="_blank" rel="noopener">
                                <span class="contribute-btn-text">לייג צו / אפדעיט א <strong>חצר</strong></span>
                                <span class="btn-external">↗</span>
                            </a>
                            
                            <a href="https://coda.io/form/_dgAvntb_zik" class="contribute-btn contribute-btn-verter" target="_blank" rel="noopener">
                                <span class="contribute-btn-text">לייג צו / אפדעיט <strong>ווערטער</strong></span>
                                <span class="btn-external">↗</span>
                            </a>
                            
                            <a href="https://coda.io/form/_d5bHKMFR3lD" class="contribute-btn contribute-btn-zman" target="_blank" rel="noopener">
                                <span class="contribute-btn-text">לייג צו / אפדעיט א <strong>זמן</strong></span>
                                <span class="btn-external">↗</span>
                            </a>
                            
                            <a href="https://coda.io/form/_dZD54k66986" class="contribute-btn contribute-btn-gezungen" target="_blank" rel="noopener">
                                <span class="contribute-btn-text">לייג צו / אפדעיט א <strong>פיוט</strong></span>
                                <span class="btn-external">↗</span>
                            </a>
                            
                            <a href="https://coda.io/form/_d6Apy3XTmnZ" class="contribute-btn contribute-btn-collection" target="_blank" rel="noopener">
                                <span class="contribute-btn-text">לייג צו / אפדעיט א <strong>קאלעקשן</strong></span>
                                <span class="btn-external">↗</span>
                            </a>
                        </div>

                        <!-- Extra Resources Section -->
                        <div class="contribute-extra-section">
                            <h3 class="contribute-section-title">לייג צו נאך רעסורן</h3>
                            <div class="contribute-extra-grid">
                                <a href="https://coda.io/form/_dMIXJIsbjLg" class="contribute-btn contribute-btn-resource" target="_blank" rel="noopener">
                                    <span class="contribute-btn-text">לייג צו א <strong>רעסורס</strong></span>
                                    <span class="btn-external">↗</span>
                                </a>
                                
                                <a href="https://coda.io/form/_d9KgrPJTikk" class="contribute-btn contribute-btn-resource" target="_blank" rel="noopener">
                                    <span class="contribute-btn-text">לייג צו א <strong>דאקומענט</strong></span>
                                    <span class="btn-external">↗</span>
                                </a>
                                
                                <a href="https://coda.io/form/_dVpYtnuj24f" class="contribute-btn contribute-btn-resource" target="_blank" rel="noopener">
                                    <span class="contribute-btn-text">לייג צו אן <strong>אלבום</strong></span>
                                    <span class="btn-external">↗</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Section (outside white container) -->
                    <div class="goals-contact">
                        <div class="goals-contact-title">הערות והארות</div>
                        <div class="goals-contact-text">פאר סיי וועלכע הערות אדער זיך צו פארבינדן מיט מערכת אידישע ניגונים</div>
                        <a href="mailto:yiddishenigunim@gmail.com" class="goals-contact-email">yiddishenigunim@gmail.com</a>
                    </div>

                    <!-- Terms Link -->
                    <div class="contribute-terms">
                        <a href="#/terms" class="contribute-terms-link">Terms of Use</a>
                    </div>
                </div>
            `;
            }

            // Handle home search
            function handleHomeSearch(event) {
                if (event.key === 'Enter') {
                    executeHomeSearch();
                }
            }

            function executeHomeSearch() {
                const query = document.getElementById('homeSearchInput').value.trim();
                if (query) {
                    searchQuery = query;
                    filterSongs();
                    navigateTo('nigunim');
                    // Set the search input in songs page
                    setTimeout(() => {
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput) {
                            searchInput.value = query;
                        }
                    }, 100);
                }
            }

            // SVG Icon helpers for slider controls
            function getDisplayModeIcon(mode) {
                const icons = {
                    // 9 small dots (3x3 grid - compact)
                    minimal: '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="4" height="4" rx="1"/><rect x="10" y="3" width="4" height="4" rx="1"/><rect x="17" y="3" width="4" height="4" rx="1"/><rect x="3" y="10" width="4" height="4" rx="1"/><rect x="10" y="10" width="4" height="4" rx="1"/><rect x="17" y="10" width="4" height="4" rx="1"/><rect x="3" y="17" width="4" height="4" rx="1"/><rect x="10" y="17" width="4" height="4" rx="1"/><rect x="17" y="17" width="4" height="4" rx="1"/></svg>',
                    // 4 dots (2x2 - medium)
                    recordings: '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>',
                    // 2 horizontal bars (full/expanded)
                    full: '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="7" rx="1.5"/><rect x="3" y="14" width="18" height="7" rx="1.5"/></svg>'
                };
                return icons[mode] || icons.minimal;
            }

            function getSortOrderIcon(order) {
                const icons = {
                    // Bulky shuffle arrows
                    random: '<svg viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>',
                    // Hebrew א-ת with sort arrow (fill-based, no stroke)
                    alphabetical: '<svg viewBox="0 0 24 24"><text x="7" y="11" font-size="12" font-family="Arial, sans-serif" font-weight="bold" text-anchor="middle">א</text><text x="7" y="21" font-size="12" font-family="Arial, sans-serif" font-weight="bold" text-anchor="middle">ת</text><rect x="17" y="5" width="2" height="10" rx="1"/><path d="M18 20l-4-4h8z"/></svg>',
                    // Bulky clock with fill
                    recent: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>'
                };
                return icons[order] || icons.random;
            }

            // Get the HTML for songs page filters
            function getSongsFiltersHTML() {
                const totalActiveFilters = Object.values(activeFilters).reduce((sum, arr) => sum + arr.length, 0);
                const hasSearch = searchQuery && searchQuery.length > 0;
                const hasActiveFilters = totalActiveFilters > 0 || hasSearch;

                return `
                <!-- Display Mode Slider -->
                <div class="slider-control" data-type="displayMode">
                    <div class="slider-options-track">
                        <div class="slider-indicator" data-position="${currentDisplayMode === 'minimal' ? '0' : currentDisplayMode === 'recordings' ? '1' : '2'}"></div>
                        <div class="slider-option ${currentDisplayMode === 'minimal' ? 'active' : ''}" data-value="minimal" onclick="selectSliderOption('displayMode', 'minimal', event)">
                            <span class="slider-option-label">ניגונים</span>
                            ${getDisplayModeIcon('minimal')}
                        </div>
                        <div class="slider-option ${currentDisplayMode === 'recordings' ? 'active' : ''}" data-value="recordings" onclick="selectSliderOption('displayMode', 'recordings', event)">
                            <span class="slider-option-label">רעקארדירונגען</span>
                            ${getDisplayModeIcon('recordings')}
                        </div>
                        <div class="slider-option ${currentDisplayMode === 'full' ? 'active' : ''}" data-value="full" onclick="selectSliderOption('displayMode', 'full', event)">
                            <span class="slider-option-label">אינפארמאציע</span>
                            ${getDisplayModeIcon('full')}
                        </div>
                    </div>
                </div>

                <!-- Sort Order Slider -->
                <div class="slider-control" data-type="sortOrder">
                    <div class="slider-options-track">
                        <div class="slider-indicator" data-position="${currentSortOrder === 'random' ? '0' : currentSortOrder === 'alphabetical' ? '1' : '2'}"></div>
                        <div class="slider-option ${currentSortOrder === 'random' ? 'active' : ''}" data-value="random" onclick="selectSliderOption('sortOrder', 'random', event)">
                            <span class="slider-option-label">שאָפל</span>
                            ${getSortOrderIcon('random')}
                        </div>
                        <div class="slider-option ${currentSortOrder === 'alphabetical' ? 'active' : ''}" data-value="alphabetical" onclick="selectSliderOption('sortOrder', 'alphabetical', event)">
                            <span class="slider-option-label">א"ב</span>
                            ${getSortOrderIcon('alphabetical')}
                        </div>
                        <div class="slider-option ${currentSortOrder === 'recent' ? 'active' : ''}" data-value="recent" onclick="selectSliderOption('sortOrder', 'recent', event)">
                            <span class="slider-option-label">לעצט צוגעלייגט</span>
                            ${getSortOrderIcon('recent')}
                        </div>
                    </div>
                </div>

                <!-- Search Button - Expandable -->
                <div class="expandable-search" id="expandableSearch">
                    <button class="search-trigger-btn ${hasSearch ? 'has-active' : ''}" onclick="toggleExpandableSearch(event)">
                        <svg class="search-icon filter-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <span class="search-label">זוך</span>
                        <span class="search-text-display">${searchQuery || ''}</span>
                        <span class="clear-search-x" onclick="clearSearch(event)">×</span>
                    </button>
                    <div class="expandable-search-input-wrapper">
                        <svg class="expandable-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <input type="text"
                               class="expandable-search-input"
                               id="expandableSearchInput"
                               placeholder="זוך א ניגון..."
                               value="${searchQuery || ''}"
                               oninput="handleLiveSearch(this.value)"
                               onkeydown="if(event.key==='Escape')closeExpandableSearch()">
                        <button class="search-close-btn" onclick="clearSearch(event)">×</button>
                    </div>
                </div>

                <!-- Filter Mega-Menu Trigger -->
                <div class="filter-mega-menu" id="filterMegaMenu" onclick="toggleFilterExpanded()">
                    <div class="filter-mega-trigger ${totalActiveFilters > 0 ? 'has-active' : ''}">
                        <svg class="filter-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 21v-7"/>
                            <path d="M4 10V3"/>
                            <path d="M12 21v-9"/>
                            <path d="M12 8V3"/>
                            <path d="M20 21v-5"/>
                            <path d="M20 12V3"/>
                            <circle cx="4" cy="13" r="2"/>
                            <circle cx="12" cy="9" r="2"/>
                            <circle cx="20" cy="15" r="2"/>
                        </svg>
                        <span class="filter-mega-label">פילטערס</span>
                        ${totalActiveFilters > 0 ? `
                        <span class="filter-count">${totalActiveFilters}</span>
                        <span class="filter-clear-btn" onclick="event.stopPropagation(); clearAllFilters();" title="קלער אלע">✕</span>
                        ` : ''}
                    </div>
                </div>
                
                <div class="filter-mega-expanded" id="filterMegaExpanded">
                    <div class="filter-mega-expanded-inner">
                        ${renderMegaFilterCategory('mechaber', 'מחבר', categories.mechabrim)}
                        ${renderMegaFilterCategory('chatzer', 'חצר', categories.chatzeros)}
                        ${renderMegaFilterCategory('gezungen', 'פיוטים', categories.gezungen)}
                        ${renderMegaFilterCategory('collection', 'קאלעקשאנס', categories.collections)}
                        ${renderMegaFilterCategory('verter', 'ווערטער', categories.verter)}
                        ${renderMegaFilterCategory('ritem', 'ריטעם', categories.ritem)}
                        ${renderMegaFilterCategory('scale', 'סקעיל', categories.scale)}
                    </div>
                </div>

                <!-- Quality Mega-Menu -->
                <div class="quality-mega-menu" id="qualityMegaMenu" onclick="toggleQualityExpanded()">
                    <div class="quality-mega-trigger ${minQualityRating > 0 ? 'has-active' : ''}">
                        <svg class="audio-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3Z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" x2="12" y1="19" y2="23"/>
                        </svg>
                        <span class="quality-mega-label">קוואליטעט</span>
                        ${minQualityRating > 0 ? `
                            <span class="quality-stars-badge">${minQualityRating <= 3 ? '★'.repeat(minQualityRating) : (minQualityRating === 4 ? '★★<br>★★' : '★★<br>★★★')}</span>
                            <span class="quality-clear-btn" onclick="event.stopPropagation(); setMinQualityRating(0); updateSongsFiltersUI();" title="קלער">✕</span>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Quality Mega-Expanded Panel -->
                <div class="quality-mega-expanded" id="qualityMegaExpanded">
                    <div class="quality-mega-expanded-inner">
                        <div class="quality-mega-option ${minQualityRating === 1 ? 'active' : ''}" onclick="setMinQualityRating(1);">
                            <span class="quality-option-stars">★</span>
                            <span class="quality-option-label">פשוט געזינגען</span>
                        </div>
                        <div class="quality-mega-option ${minQualityRating === 2 ? 'active' : ''}" onclick="setMinQualityRating(2);">
                            <span class="quality-option-stars">★★</span>
                            <span class="quality-option-label">אראפגעזינגען אן מוזיק</span>
                        </div>
                        <div class="quality-mega-option ${minQualityRating === 3 ? 'active' : ''}" onclick="setMinQualityRating(3);">
                            <span class="quality-option-stars">★★★</span>
                            <span class="quality-option-label">אלטע מוזיק</span>
                        </div>
                        <div class="quality-mega-option ${minQualityRating === 4 ? 'active' : ''}" onclick="setMinQualityRating(4);">
                            <span class="quality-option-stars">★★★★</span>
                            <span class="quality-option-label">שיין און ניי</span>
                        </div>
                        <div class="quality-mega-option ${minQualityRating === 5 ? 'active' : ''}" onclick="setMinQualityRating(5);">
                            <span class="quality-option-stars">★★★★★</span>
                            <span class="quality-option-label">שיין און געשמאק</span>
                        </div>
                    </div>
                </div>
            `;
            }

            // Get the HTML for category page filters (mechaber/chatzer/verter - 2-3 buttons)
            function getCategoryFiltersHTML(categoryKey) {
                const hasSearch = categorySearchQuery && categorySearchQuery.length > 0;
                const placeholderText = categoryKey === 'mechabrim' ? 'זוך א מחבר...' : categoryKey === 'chatzeros' ? 'זוך א חצר...' : 'זוך ווערטער...';

                return `
                <!-- Display Mode Slider - 2 options for mechabrim, chatzeros, and verter -->
                ${(categoryKey === 'mechabrim' || categoryKey === 'chatzeros' || categoryKey === 'verter') ? `
                <div class="slider-control slider-2-options" data-type="categoryDisplayMode">
                    <div class="slider-options-track">
                        <div class="slider-indicator" data-position="${categoryDisplayModes[categoryKey] === 'list' ? '0' : '1'}"></div>
                        <div class="slider-option ${categoryDisplayModes[categoryKey] === 'list' ? 'active' : ''}" data-value="list" onclick="selectCategorySliderOption('categoryDisplayMode', 'list', event)">
                            <span class="slider-option-label">ליסטע</span>
                            <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="3.5" rx="1.5"/><rect x="3" y="10.25" width="18" height="3.5" rx="1.5"/><rect x="3" y="16.5" width="18" height="3.5" rx="1.5"/></svg>
                        </div>
                        <div class="slider-option ${categoryDisplayModes[categoryKey] === 'cards' ? 'active' : ''}" data-value="cards" onclick="selectCategorySliderOption('categoryDisplayMode', 'cards', event)">
                            <span class="slider-option-label">קעסטלעך</span>
                            <svg viewBox="0 0 24 24"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>
                        </div>
                    </div>
                </div>
                ` : `
                <div class="slider-control" data-type="categoryDisplayMode">
                    <div class="slider-options-track">
                        <div class="slider-indicator" data-position="${categoryDisplayModes[categoryKey] === 'minimal' ? '0' : categoryDisplayModes[categoryKey] === 'recordings' ? '1' : '2'}"></div>
                        <div class="slider-option ${categoryDisplayModes[categoryKey] === 'minimal' ? 'active' : ''}" data-value="minimal" onclick="selectCategorySliderOption('categoryDisplayMode', 'minimal', event)">
                            <span class="slider-option-label">קעפל</span>
                            ${getDisplayModeIcon('minimal')}
                        </div>
                        <div class="slider-option ${categoryDisplayModes[categoryKey] === 'recordings' ? 'active' : ''}" data-value="recordings" onclick="selectCategorySliderOption('categoryDisplayMode', 'recordings', event)">
                            <span class="slider-option-label">קארטן</span>
                            ${getDisplayModeIcon('recordings')}
                        </div>
                        <div class="slider-option ${categoryDisplayModes[categoryKey] === 'full' ? 'active' : ''}" data-value="full" onclick="selectCategorySliderOption('categoryDisplayMode', 'full', event)">
                            <span class="slider-option-label">ליסט</span>
                            ${getDisplayModeIcon('full')}
                        </div>
                    </div>
                </div>
                `}

                <!-- Search Button - Expandable (in the middle) -->
                <div class="expandable-search" id="categoryExpandableSearch">
                    <button class="search-trigger-btn ${hasSearch ? 'has-active' : ''}" onclick="toggleCategoryExpandableSearch(event)">
                        <svg class="search-icon filter-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <span class="search-label">זוך</span>
                        <span class="search-text-display">${categorySearchQuery || ''}</span>
                        <span class="clear-search-x" onclick="clearCategorySearch(event)">×</span>
                    </button>
                    <div class="expandable-search-input-wrapper">
                        <svg class="expandable-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <input type="text"
                               class="expandable-search-input"
                               id="categoryExpandableSearchInput"
                               placeholder="${placeholderText}"
                               value="${categorySearchQuery || ''}"
                               oninput="handleCategoryLiveSearch(this.value)"
                               onkeydown="if(event.key==='Escape')closeCategoryExpandableSearch()">
                        <button class="search-close-btn" onclick="clearCategorySearch(event)">×</button>
                    </div>
                </div>

                <!-- Sort Order Slider (only for mechabrim and chatzeros, not verter) -->
                ${categoryKey === 'mechabrim' ? `
                <div class="slider-control" data-type="categorySortOrder">
                    <div class="slider-options-track">
                        <div class="slider-indicator" data-position="${categorySortOrders[categoryKey] === 'years' ? '0' : categorySortOrders[categoryKey] === 'alphabetical' ? '1' : '2'}"></div>
                        <div class="slider-option ${categorySortOrders[categoryKey] === 'years' ? 'active' : ''}" data-value="years" onclick="selectCategorySliderOption('categorySortOrder', 'years', event)">
                            <span class="slider-option-label">יארן</span>
                            <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM7 11h5v5H7z"/></svg>
                        </div>
                        <div class="slider-option ${categorySortOrders[categoryKey] === 'alphabetical' ? 'active' : ''}" data-value="alphabetical" onclick="selectCategorySliderOption('categorySortOrder', 'alphabetical', event)">
                            <span class="slider-option-label">א"ב</span>
                            ${getSortOrderIcon('alphabetical')}
                        </div>
                        <div class="slider-option ${categorySortOrders[categoryKey] === 'songcount' ? 'active' : ''}" data-value="songcount" onclick="selectCategorySliderOption('categorySortOrder', 'songcount', event)">
                            <span class="slider-option-label">ניגונים</span>
                            <svg viewBox="0 0 24 24"><path d="M4 19h4v-5H4v5zm6 0h4V9h-4v10zm6 0h4V4h-4v15z"/></svg>
                        </div>
                    </div>
                </div>
                ` : (categoryKey === 'chatzeros' || categoryKey === 'verter') ? `
                <div class="slider-control" data-type="categorySortOrder">
                    <div class="slider-options-track">
                        <div class="slider-indicator" data-position="${categorySortOrders[categoryKey] === 'random' ? '0' : categorySortOrders[categoryKey] === 'alphabetical' ? '1' : '2'}"></div>
                        <div class="slider-option ${categorySortOrders[categoryKey] === 'random' ? 'active' : ''}" data-value="random" onclick="selectCategorySliderOption('categorySortOrder', 'random', event)">
                            <span class="slider-option-label">שאָפל</span>
                            ${getSortOrderIcon('random')}
                        </div>
                        <div class="slider-option ${categorySortOrders[categoryKey] === 'alphabetical' ? 'active' : ''}" data-value="alphabetical" onclick="selectCategorySliderOption('categorySortOrder', 'alphabetical', event)">
                            <span class="slider-option-label">א"ב</span>
                            ${getSortOrderIcon('alphabetical')}
                        </div>
                        <div class="slider-option ${categorySortOrders[categoryKey] === 'songcount' ? 'active' : ''}" data-value="songcount" onclick="selectCategorySliderOption('categorySortOrder', 'songcount', event)">
                            <span class="slider-option-label">ניגונים</span>
                            <svg viewBox="0 0 24 24"><path d="M4 19h4v-5H4v5zm6 0h4V9h-4v10zm6 0h4V4h-4v15z"/></svg>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            }

            // Get the HTML for simple search-only pages (verter, zmanim, collections, piyutim)
            function getSimpleSearchHTML(categoryKey) {
                const hasSearch = categorySearchQuery && categorySearchQuery.length > 0;
                const placeholderMap = {
                    'verter': 'זוך ווערטער...',
                    'zmanim': 'זוך א זמן...',
                    'collections': 'זוך א קאלעקשאן...',
                    'piyutim': 'זוך א פיוט...'
                };
                const placeholderText = placeholderMap[categoryKey] || 'זוך...';

                return `
                <!-- Search Button - Expandable -->
                <div class="expandable-search" id="categoryExpandableSearch">
                    <button class="search-trigger-btn ${hasSearch ? 'has-active' : ''}" onclick="toggleCategoryExpandableSearch(event)">
                        <svg class="search-icon filter-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <span class="search-label">זוך</span>
                        <span class="search-text-display">${categorySearchQuery || ''}</span>
                        <span class="clear-search-x" onclick="clearCategorySearch(event)">×</span>
                    </button>
                    <div class="expandable-search-input-wrapper">
                        <svg class="expandable-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <input type="text"
                               class="expandable-search-input"
                               id="categoryExpandableSearchInput"
                               placeholder="${placeholderText}"
                               value="${categorySearchQuery || ''}"
                               oninput="handleCategoryLiveSearch(this.value)"
                               onkeydown="if(event.key==='Escape')closeCategoryExpandableSearch()">
                        <button class="search-close-btn" onclick="clearCategorySearch(event)">×</button>
                    </div>
                </div>
            `;
            }

            // Category slider option selection handler
            function selectCategorySliderOption(type, value, event) {
                if (event) event.stopPropagation();

                if (type === 'categoryDisplayMode') {
                    categoryDisplayModes[currentCategoryKey] = value;
                } else if (type === 'categorySortOrder') {
                    categorySortOrders[currentCategoryKey] = value;
                }

                // Update slider UI
                const sliderControl = document.querySelector(`.slider-control[data-type="${type}"]`);
                if (sliderControl) {
                    // Update active class on options
                    sliderControl.querySelectorAll('.slider-option').forEach(opt => {
                        if (opt.dataset.value === value) {
                            opt.classList.add('active');
                        } else {
                            opt.classList.remove('active');
                        }
                    });

                    // Update indicator position
                    const options = Array.from(sliderControl.querySelectorAll('.slider-option'));
                    const activeIndex = options.findIndex(opt => opt.dataset.value === value);
                    const indicator = sliderControl.querySelector('.slider-indicator');
                    if (indicator && activeIndex >= 0) {
                        indicator.dataset.position = activeIndex.toString();
                    }
                }

                // Re-render the category grid with new sort or display mode
                if (currentCategoryKey && (type === 'categorySortOrder' || type === 'categoryDisplayMode')) {
                    filterAndRenderCategoryGrid();
                }
            }

            // Toggle category expandable search
            function toggleCategoryExpandableSearch(event) {
                if (event) event.stopPropagation();
                const searchContainer = document.getElementById('categoryExpandableSearch');
                if (!searchContainer) return;

                const isExpanded = searchContainer.classList.contains('expanded');
                if (isExpanded) {
                    closeCategoryExpandableSearch();
                } else {
                    searchContainer.classList.add('expanded');
                    setTimeout(() => {
                        const input = document.getElementById('categoryExpandableSearchInput');
                        if (input) input.focus();
                    }, 100);
                }
            }

            // Close category expandable search
            function closeCategoryExpandableSearch() {
                const searchContainer = document.getElementById('categoryExpandableSearch');
                if (searchContainer) {
                    searchContainer.classList.remove('expanded');

                    // Update button state after closing
                    updateCategorySearchUI();
                }
            }

            // Document-level click handler to close category search when clicking outside
            document.addEventListener('click', function (event) {
                const categorySearch = document.getElementById('categoryExpandableSearch');
                if (categorySearch && categorySearch.classList.contains('expanded')) {
                    // Check if click is outside the search container
                    if (!categorySearch.contains(event.target)) {
                        closeCategoryExpandableSearch();
                    }
                }

                // Also close songs page expandable search
                const songsSearch = document.getElementById('expandableSearch');
                if (songsSearch && songsSearch.classList.contains('expanded')) {
                    if (!songsSearch.contains(event.target)) {
                        closeExpandableSearch();
                    }
                }
            });

            // Handle live search for category pages
            function handleCategoryLiveSearch(query) {
                categorySearchQuery = query.trim();
                if (currentCategoryKey) {
                    filterAndRenderCategoryGrid();
                }
            }

            // Clear category search
            function clearCategorySearch(event) {
                if (event) event.stopPropagation();
                categorySearchQuery = '';
                closeCategoryExpandableSearch();
                if (currentCategoryKey) {
                    filterAndRenderCategoryGrid();
                }
                // Update the search button UI
                updateCategorySearchUI();
            }

            // Update category search button UI
            function updateCategorySearchUI() {
                const searchContainer = document.getElementById('categoryExpandableSearch');
                if (!searchContainer) return;
                const btn = searchContainer.querySelector('.search-trigger-btn');
                const textDisplay = searchContainer.querySelector('.search-text-display');
                if (btn) {
                    if (categorySearchQuery) {
                        btn.classList.add('has-active');
                    } else {
                        btn.classList.remove('has-active');
                    }
                }
                if (textDisplay) {
                    textDisplay.textContent = categorySearchQuery || '';
                }
            }

            // Filter and re-render category grid based on search
            function filterAndRenderCategoryGrid() {
                const grid = document.getElementById('categoryGrid');
                if (!grid) return;

                let sortedKeys = [];
                let data = {};

                // Handle different category types
                if (currentCategoryKey === 'zmanim') {
                    // Use zmaninInfo for zmanim
                    sortedKeys = Object.keys(zmaninInfo);
                } else if (currentCategoryKey === 'piyutim') {
                    // Use piyutimInfo for piyutim
                    sortedKeys = Object.keys(piyutimInfo);
                } else if (currentCategoryKey === 'collections') {
                    data = categories.collections || {};
                    sortedKeys = Object.keys(data);
                } else {
                    data = categories[currentCategoryKey] || {};
                    sortedKeys = Object.keys(data);
                }

                // Apply search filter
                if (categorySearchQuery) {
                    const query = categorySearchQuery.toLowerCase();
                    sortedKeys = sortedKeys.filter(key => key.toLowerCase().includes(query));
                }

                // Apply sort - use per-category sort order
                const sortOrder = categorySortOrders[currentCategoryKey] || 'alphabetical';
                if (sortOrder === 'random') {
                    sortedKeys = sortedKeys.sort(() => Math.random() - 0.5);
                } else if (sortOrder === 'alphabetical') {
                    sortedKeys = sortedKeys.sort((a, b) => a.localeCompare(b, 'he'));
                } else if (sortOrder === 'years' && currentCategoryKey === 'mechabrim') {
                    // Sort by birth year (earliest first)
                    const parseHebrewYear = (yearStr) => {
                        if (!yearStr) return 9999;
                        const hebrewValues = {
                            'א': 1, 'ב': 2, 'ג': 3, 'ד': 4, 'ה': 5, 'ו': 6, 'ז': 7, 'ח': 8, 'ט': 9,
                            'י': 10, 'כ': 20, 'ך': 20, 'ל': 30, 'מ': 40, 'ם': 40, 'נ': 50, 'ן': 50,
                            'ס': 60, 'ע': 70, 'פ': 80, 'ף': 80, 'צ': 90, 'ץ': 90, 'ק': 100, 'ר': 200,
                            'ש': 300, 'ת': 400
                        };
                        let total = 0;
                        for (const char of yearStr) {
                            if (hebrewValues[char]) total += hebrewValues[char];
                        }
                        return total || 9999;
                    };
                    sortedKeys = sortedKeys.sort((a, b) => {
                        const infoA = mechabrimInfo[a] || {};
                        const infoB = mechabrimInfo[b] || {};
                        const yearA = parseHebrewYear(infoA.birthYear);
                        const yearB = parseHebrewYear(infoB.birthYear);
                        return yearA - yearB;
                    });
                } else if (sortOrder === 'songcount' && currentCategoryKey === 'mechabrim') {
                    // Sort by number of songs (most first)
                    sortedKeys = sortedKeys.sort((a, b) => {
                        const countA = (data[a] || []).length;
                        const countB = (data[b] || []).length;
                        return countB - countA;
                    });
                } else if (sortOrder === 'songcount' && (currentCategoryKey === 'chatzeros' || currentCategoryKey === 'verter')) {
                    // Sort by number of songs (most first)
                    sortedKeys = sortedKeys.sort((a, b) => {
                        const countA = (data[a] || []).length;
                        const countB = (data[b] || []).length;
                        return countB - countA;
                    });
                }
                // 'recent' - keep original order or implement if we have date data

                // Get info object for this category
                let infoObj = {};
                switch (currentCategoryKey) {
                    case 'chatzeros': infoObj = chatzerosInfo; break;
                    case 'mechabrim': infoObj = mechabrimInfo; break;
                    case 'verter': infoObj = verterInfo; break;
                    case 'zmanim': infoObj = zmaninInfo; break;
                    case 'collections': infoObj = collectionsInfo; break;
                    case 'piyutim': infoObj = piyutimInfo; break;
                }

                // Re-render grid based on category type
                let html = '';
                if (currentCategoryKey === 'zmanim') {
                    html = sortedKeys.map(zmanName => {
                        const zmanData = zmaninInfo[zmanName];
                        if (!zmanData) return '';
                        const piyutimCount = zmanData.piyutim?.length || 0;
                        const collectionsCount = zmanData.collections?.length || 0;
                        const zmanId = zmanData.rowId || zmanName;
                        return `
                        <a class="category-card" href="#/zman/${encodeURIComponent(zmanId)}" data-action="zman-detail" data-name="${escapeHtml(zmanName)}">
                            <div class="card-header">
                                <div class="card-header-text">
                                    <div class="card-title">${zmanName}</div>
                                </div>
                            </div>
                            <div class="card-stats">
                                ${piyutimCount > 0 ? `<span class="card-stat">${pluralize(piyutimCount, 'פיוט', 'פיוטים')}</span>` : ''}
                                ${collectionsCount > 0 ? `<span class="card-stat">${pluralize(collectionsCount, 'קאלעקשאן', 'קאלעקשאנס')}</span>` : ''}
                            </div>
                        </a>
                    `;
                    }).join('');
                } else if (currentCategoryKey === 'collections') {
                    html = sortedKeys.map(key => {
                        const info = collectionsInfo[key] || {};
                        const colData = categories.collections[key] || [];
                        const songCount = colData.length;
                        const zmanim = info.zmanim || [];
                        return `
                        <div class="collection-card">
                            <div class="collection-card-header" data-action="detail" data-category="collections" data-name="${escapeHtml(key)}">
                                <div class="collection-icon">♫</div>
                                <div class="collection-info">
                                    <div class="collection-title">${key}</div>
                                    <div class="collection-meta">${pluralize(songCount, 'ניגון', 'ניגונים')}</div>
                                    ${zmanim.length > 0 ? `
                                        <div class="collection-zmanim" onclick="event.stopPropagation();">
                                            ${zmanim.slice(0, 3).map(zman => `<span class="collection-zman-tag"
                                                data-action="zman-detail"
                                                data-name="${escapeHtml(zman)}"
                                                data-tooltip-value="${escapeHtml(zman)}"
                                                data-tooltip-type="zman">${zman}</span>`).join('')}
                                            ${zmanim.length > 3 ? `<span class="collection-zman-more">+${zmanim.length - 3}</span>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                                <button class="collection-play-btn" data-action="play-collection" data-name="${escapeHtml(key)}">
                                    ▶
                                </button>
                            </div>
                        </div>
                    `;
                    }).join('');
                } else if (currentCategoryKey === 'piyutim') {
                    html = sortedKeys.map(piyutName => {
                        const info = piyutimInfo[piyutName] || {};
                        const linkedNigunim = new Set(info.nigunim || []);
                        const songCount = allSongs.filter(song => linkedNigunim.has(song.codaRowName)).length;
                        const piyutId = info.customId || piyutName;
                        const zmanim = info.zmanim || [];
                        return `
                        <a class="category-card" href="#/piyutim/${encodeURIComponent(piyutId)}" data-action="detail" data-category="piyutim" data-name="${escapeHtml(piyutName)}">
                            <div class="card-header">
                                <div class="card-header-text">
                                    <div class="card-title">${piyutName}</div>
                                    ${zmanim.length > 0 ? `
                                        <div class="card-tags" onclick="event.stopPropagation();">
                                            ${zmanim.map(zman => `
                                                <span class="card-zman-tag"
                                                      data-action="zman-detail"
                                                      data-name="${escapeHtml(zman)}"
                                                      onclick="event.stopPropagation(); event.preventDefault(); navigateToDetail('zmanim', '${escapeHtml(zman).replace(/'/g, "\\'")}');"
                                                      data-tooltip-value="${escapeHtml(zman)}"
                                                      data-tooltip-type="zman">${zman}</span>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="card-stats">
                                <span class="card-stat">${pluralize(songCount, 'ניגון', 'ניגונים')}</span>
                            </div>
                        </a>
                    `;
                    }).join('');
                } else if (currentCategoryKey === 'mechabrim' && categoryDisplayModes[currentCategoryKey] === 'list') {
                    // Compact list mode for mechabrim - horizontal pills
                    html = `<div class="mechaber-list-compact">` + sortedKeys.map(key => {
                        const info = infoObj[key] || {};
                        const imageKey = key.trim();
                        const imageUrl = info.image || `https://storage.googleapis.com/zemirot-israel.appspot.com/mechabrimPics/${encodeURIComponent(imageKey)}.png`;
                        return `
                        <a class="mechaber-pill" href="#/mechabrim/${encodeURIComponent(key)}" data-action="detail" data-category="mechabrim" data-name="${escapeHtml(key)}">
                            <span class="mechaber-pill-image">
                                <img src="${imageUrl}" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <span class="mechaber-pill-placeholder" style="display:none;"><span class="mechaber-icon"></span></span>
                            </span>
                            <span class="mechaber-pill-name">${info.tagName || key}</span>
                        </a>
                    `;
                    }).join('') + `</div>`;
                } else if (currentCategoryKey === 'chatzeros' && categoryDisplayModes[currentCategoryKey] === 'list') {
                    // Compact list mode for chatzeros - horizontal pills (no images)
                    html = `<div class="chatzer-list-compact">` + sortedKeys.map(key => {
                        return `
                        <a class="chatzer-pill" href="#/chatzeros/${encodeURIComponent(key)}" data-action="detail" data-category="chatzeros" data-name="${escapeHtml(key)}">
                            <span class="chatzer-pill-name">${key}</span>
                        </a>
                    `;
                    }).join('') + `</div>`;
                } else if (currentCategoryKey === 'verter' && categoryDisplayModes[currentCategoryKey] === 'list') {
                    // Compact list mode for verter - horizontal pills
                    html = `<div class="verter-list-compact">` + sortedKeys.map(key => {
                        return `
                        <a class="verter-pill" href="#/verter/${encodeURIComponent(key)}" data-action="detail" data-category="verter" data-name="${escapeHtml(key)}">
                            <span class="verter-pill-name">${key}</span>
                        </a>
                    `;
                    }).join('') + `</div>`;
                } else {
                    // Default category cards (mechabrim, chatzeros, verter)
                    html = sortedKeys.map(key => renderCategoryCard(key, currentCategoryKey, '', infoObj, data)).join('');
                }

                // Fade out existing cards, then replace and fade in new ones
                grid.style.opacity = '0';
                grid.style.transition = 'opacity 0.2s ease-out';

                setTimeout(() => {
                    grid.innerHTML = html;

                    // Reset opacity and fade in
                    grid.style.opacity = '1';
                    grid.style.transition = 'opacity 0.3s ease-in';

                    // Apply staggered pop-in animation to new cards
                    const cards = grid.querySelectorAll('.category-card');
                    cards.forEach((card, i) => {
                        card.style.opacity = '0';
                        card.style.animationDelay = `${i * 0.03}s`;
                        card.classList.add('card-pop-in');
                        // Set opacity to allow animation to take over
                        requestAnimationFrame(() => {
                            card.style.opacity = '';
                        });
                    });

                    // Update count
                    const countEl = document.querySelector('.subtitle-count');
                    if (countEl) {
                        countEl.textContent = sortedKeys.length;
                    }

                    // Update search UI
                    updateCategorySearchUI();
                }, 200); // Match fade-out duration
            }

            // Refresh category page (re-render with current settings)
            function refreshCategoryPage() {
                const content = document.getElementById('content');
                if (!content) return;

                // Reset search when changing display/sort modes
                categorySearchQuery = '';

                // Get category info
                const categoryInfo = {
                    'chatzeros': { title: 'חצרות', icon: '', subtitle: '' },
                    'mechabrim': { title: 'מחברים', icon: '<div class="mechaber-icon"></div>', subtitle: '' },
                    'verter': { title: 'ווערטער', icon: '', subtitle: '' }
                };

                if (categoryInfo[currentCategoryKey]) {
                    const info = categoryInfo[currentCategoryKey];
                    renderCategoryPage(content, currentCategoryKey, info.title, info.icon, info.subtitle);
                }
            }

            // Render filter panel item
            function renderFilterPanelItem(key, label, data) {
                if (!data) data = {};
                const options = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));
                const selectedCount = activeFilters[key]?.length || 0;
                const selectedValue = selectedCount > 0 ? `(${selectedCount})` : '';

                return `
                <div class="filter-panel-item" data-filter="${key}">
                    <button class="filter-panel-item-btn ${selectedCount > 0 ? 'active' : ''}" onclick="toggleFilterPanelItem('${key}')">
                        <span class="filter-panel-item-label">${label}</span>
                        <span class="filter-panel-item-value ${selectedCount > 0 ? 'has-selection' : ''}">${selectedValue || '(אלע)'}</span>
                    </button>
                    <div class="filter-panel-item-options" id="filter-panel-options-${key}">
                        ${options.slice(0, 50).map(opt => {
                    const escapedOpt = opt.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    return `
                                <label class="filter-panel-option" onclick="event.stopPropagation()">
                                    <input type="checkbox" 
                                        value="${opt.replace(/"/g, '&quot;')}" 
                                        ${activeFilters[key]?.includes(opt) ? 'checked' : ''}
                                        onchange="handleFilterChange('${key}', '${escapedOpt}', this.checked)">
                                    ${opt}
                                </label>
                            `;
                }).join('')}
                        ${options.length > 50 ? `<div style="padding: 8px; text-align: center; color: var(--text-muted); font-size: 0.8em;">... און נאך ${options.length - 50}</div>` : ''}
                    </div>
                </div>
            `;
            }

            // Get active filter tags HTML
            function getActiveFilterTagsHTML() {
                let html = '';

                if (searchQuery) {
                    html += `<span class="filter-panel-tag">🔍 ${searchQuery}<button class="filter-panel-tag-remove" onclick="clearSearch()">×</button></span>`;
                }

                Object.keys(activeFilters).forEach(key => {
                    activeFilters[key].forEach(value => {
                        html += `<span class="filter-panel-tag">${value}<button class="filter-panel-tag-remove" onclick="removeFilter('${key}', '${value.replace(/'/g, "\\'")}')">×</button></span>`;
                    });
                });

                return html;
            }

            // Render mega filter category for the mega-menu
            function renderMegaFilterCategory(key, label, data) {
                if (!data) data = {};
                const options = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));
                // Hide empty filter categories (e.g. gezungen when songIndex doesn't have that field)
                if (options.length === 0 && (!activeFilters[key] || activeFilters[key].length === 0)) return '';
                const selectedCount = activeFilters[key]?.length || 0;
                const hasActive = selectedCount > 0;
                const selectedItems = activeFilters[key] || [];

                return `
                <div class="filter-mega-column" data-category="${key}">
                    <div class="filter-mega-header ${hasActive ? 'has-active' : ''}" onclick="toggleFilterCategorySearch(this, '${key}')">
                        ${hasActive ? `
                        <span class="filter-mega-header-tags">
                            ${selectedItems.map(item => {
                    const escapedItem = item.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    return `<span class="filter-header-tag" onclick="event.stopPropagation(); handleFilterChange('${key}', '${escapedItem}', false)">${item}<span class="tag-x">×</span></span>`;
                }).join('')}
                        </span>
                        ` : `
                        <span class="filter-mega-header-text"><span class="filter-mega-search-icon"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg></span>${label}</span>
                        `}
                        <input type="text" class="filter-mega-search" placeholder="זוך..." 
                               onclick="event.stopPropagation()" 
                               oninput="filterCategoryOptions(this, '${key}')"
                               onblur="setTimeout(() => closeFilterCategorySearch(this), 200)">
                    </div>
                    <div class="filter-mega-options">
                        ${options.map(opt => {
                    const escapedOpt = opt.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    const isSelected = activeFilters[key]?.includes(opt);
                    return `
                            <label class="filter-mega-option ${isSelected ? 'selected' : ''}" data-option="${opt.toLowerCase()}" onclick="event.stopPropagation()">
                                <input type="checkbox" 
                                    value="${opt.replace(/"/g, '&quot;')}" 
                                    ${isSelected ? 'checked' : ''}
                                    onchange="handleFilterChange('${key}', '${escapedOpt}', this.checked)">
                                <span>${opt}</span>
                            </label>
                        `;
                }).join('')}
                    </div>
                </div>
            `;
            }

            // Toggle search mode in category header
            function toggleFilterCategorySearch(header, key) {
                const isSearching = header.classList.contains('searching');
                // Close any other open searches
                document.querySelectorAll('.filter-mega-header.searching').forEach(h => {
                    if (h !== header) {
                        h.classList.remove('searching');
                    }
                });

                if (!isSearching) {
                    header.classList.add('searching');
                    const input = header.querySelector('.filter-mega-search');
                    if (input) {
                        input.value = '';
                        setTimeout(() => input.focus(), 50);
                    }
                    // Show all options again
                    const column = header.closest('.filter-mega-column');
                    column.querySelectorAll('.filter-mega-option').forEach(opt => opt.style.display = '');
                } else {
                    header.classList.remove('searching');
                }
            }

            // Filter options as user types
            function filterCategoryOptions(input, key) {
                const query = input.value.toLowerCase().trim();
                const column = input.closest('.filter-mega-column');
                const options = column.querySelectorAll('.filter-mega-option');

                options.forEach(opt => {
                    const text = opt.getAttribute('data-option') || '';
                    if (!query || text.includes(query)) {
                        opt.style.display = '';
                    } else {
                        opt.style.display = 'none';
                    }
                });
            }

            // Close search mode
            function closeFilterCategorySearch(input) {
                const header = input.closest('.filter-mega-header');
                if (header) {
                    header.classList.remove('searching');
                    // Show all options again
                    const column = header.closest('.filter-mega-column');
                    if (column) {
                        column.querySelectorAll('.filter-mega-option').forEach(opt => opt.style.display = '');
                    }
                }
            }

            // Filter Mega-Menu Expand/Collapse - 2-phase animation
            let filterExpandTimer = null;
            let filterPhase2Timer = null;

            function showFilterExpanded() {
                if (filterExpandTimer) {
                    clearTimeout(filterExpandTimer);
                    filterExpandTimer = null;
                }
                const panel = document.getElementById('filterMegaExpanded');
                const trigger = document.getElementById('filterMegaMenu');

                // Phase 1: Show headers (width/opacity) + expand sub-header immediately
                if (panel) {
                    panel.classList.add('expanded');
                }
                if (trigger) {
                    trigger.classList.add('expanded');
                }
                // Expand sub-header immediately
                const subHeader = document.querySelector('.page-settings-bar');
                if (subHeader) subHeader.classList.add('filter-expanded');

                // Add show-options immediately - no separate phase
                if (panel) panel.classList.add('show-options');
            }

            function hideFilterExpanded() {
                // Clear phase 2 timer if still pending
                if (filterPhase2Timer) {
                    clearTimeout(filterPhase2Timer);
                    filterPhase2Timer = null;
                }

                filterExpandTimer = setTimeout(() => {
                    const panel = document.getElementById('filterMegaExpanded');
                    const trigger = document.getElementById('filterMegaMenu');
                    const subHeader = document.querySelector('.page-settings-bar');
                    if (panel) {
                        panel.classList.remove('expanded', 'show-options');
                    }
                    if (trigger) {
                        trigger.classList.remove('expanded');
                    }
                    if (subHeader) {
                        subHeader.classList.remove('filter-expanded');
                    }
                }, 0); // No delay for click-based
            }

            // Quality Mega-Menu Expand/Collapse - single phase animation (no dropdown, just horizontal expand)
            let qualityExpandTimer = null;

            function showQualityExpanded() {
                if (qualityExpandTimer) {
                    clearTimeout(qualityExpandTimer);
                    qualityExpandTimer = null;
                }
                const panel = document.getElementById('qualityMegaExpanded');
                const trigger = document.getElementById('qualityMegaMenu');

                if (panel) {
                    panel.classList.add('expanded');
                }
                if (trigger) {
                    trigger.classList.add('expanded');
                }
                // Expand sub-header to make room for quality options
                const subHeader = document.querySelector('.page-settings-bar');
                if (subHeader) subHeader.classList.add('quality-expanded');
            }

            function hideQualityExpanded() {
                qualityExpandTimer = setTimeout(() => {
                    const panel = document.getElementById('qualityMegaExpanded');
                    const trigger = document.getElementById('qualityMegaMenu');
                    if (panel) {
                        panel.classList.remove('expanded');
                    }
                    if (trigger) {
                        trigger.classList.remove('expanded');
                    }
                    // Collapse sub-header
                    const subHeader = document.querySelector('.page-settings-bar');
                    if (subHeader) subHeader.classList.remove('quality-expanded');
                }, 0); // No delay for click-based
            }

            // Toggle functions for click-based operation
            function toggleFilterExpanded() {
                const panel = document.getElementById('filterMegaExpanded');
                if (panel && panel.classList.contains('expanded')) {
                    hideFilterExpanded();
                } else {
                    // Close quality if open
                    hideQualityExpandedImmediate();
                    showFilterExpanded();
                }
            }

            function toggleQualityExpanded() {
                const panel = document.getElementById('qualityMegaExpanded');
                if (panel && panel.classList.contains('expanded')) {
                    hideQualityExpanded();
                } else {
                    // Close filter if open
                    hideFilterExpandedImmediate();
                    showQualityExpanded();
                }
            }

            // Immediate hide functions (no delay)
            function hideFilterExpandedImmediate() {
                if (filterPhase2Timer) {
                    clearTimeout(filterPhase2Timer);
                    filterPhase2Timer = null;
                }
                if (filterExpandTimer) {
                    clearTimeout(filterExpandTimer);
                    filterExpandTimer = null;
                }
                const panel = document.getElementById('filterMegaExpanded');
                const trigger = document.getElementById('filterMegaMenu');
                const subHeader = document.querySelector('.page-settings-bar');
                if (panel) panel.classList.remove('expanded', 'show-options');
                if (trigger) trigger.classList.remove('expanded');
                if (subHeader) subHeader.classList.remove('filter-expanded');
            }

            function hideQualityExpandedImmediate() {
                if (qualityExpandTimer) {
                    clearTimeout(qualityExpandTimer);
                    qualityExpandTimer = null;
                }
                const panel = document.getElementById('qualityMegaExpanded');
                const trigger = document.getElementById('qualityMegaMenu');
                const subHeader = document.querySelector('.page-settings-bar');
                if (panel) panel.classList.remove('expanded');
                if (trigger) trigger.classList.remove('expanded');
                if (subHeader) subHeader.classList.remove('quality-expanded');
            }

            // Close panels when clicking outside
            document.addEventListener('click', function (e) {
                const filterMenu = document.getElementById('filterMegaMenu');
                const filterPanel = document.getElementById('filterMegaExpanded');
                const qualityMenu = document.getElementById('qualityMegaMenu');
                const qualityPanel = document.getElementById('qualityMegaExpanded');

                // Check if click is outside filter menu and panel
                if (filterPanel && filterPanel.classList.contains('expanded')) {
                    if (!filterMenu?.contains(e.target) && !filterPanel?.contains(e.target)) {
                        hideFilterExpandedImmediate();
                    }
                }

                // Check if click is outside quality menu and panel
                if (qualityPanel && qualityPanel.classList.contains('expanded')) {
                    if (!qualityMenu?.contains(e.target) && !qualityPanel?.contains(e.target)) {
                        hideQualityExpandedImmediate();
                    }
                }
            });

            // Update filter mega-menu content (called when categories data is loaded)
            function updateFilterMegaMenuContent() {
                const inner = document.querySelector('.filter-mega-expanded-inner');
                if (inner) {
                    inner.innerHTML = `
                    ${renderMegaFilterCategory('collection', 'קאלעקשאנס', categories.collections)}
                    ${renderMegaFilterCategory('chatzer', 'חצר', categories.chatzeros)}
                    ${renderMegaFilterCategory('mechaber', 'מחבר', categories.mechabrim)}
                    ${renderMegaFilterCategory('verter', 'ווערטער', categories.verter)}
                    ${renderMegaFilterCategory('gezungen', 'געזונגען', categories.gezungen)}
                    ${renderMegaFilterCategory('ritem', 'ריטעם', categories.ritem)}
                    ${renderMegaFilterCategory('scale', 'סקעיל', categories.scale)}
                `;
                }
            }

            // Toggle search panel
            function toggleSearchPanel(event) {
                event.stopPropagation();
                const panel = document.getElementById('searchPanelContent');
                const filterPanel = document.getElementById('filterPanelContent');
                if (filterPanel) filterPanel.classList.remove('show');
                if (panel) {
                    panel.classList.toggle('show');
                    if (panel.classList.contains('show')) {
                        // Focus the search input
                        setTimeout(() => {
                            const input = document.getElementById('filterPanelSearchInput');
                            if (input) input.focus();
                        }, 100);
                    }
                }
            }

            // Toggle filter panel (old dropdown - now replaced by expansion row)
            function toggleFilterPanel(event) {
                event.stopPropagation();
                const panel = document.getElementById('filterPanelContent');
                const searchPanel = document.getElementById('searchPanelContent');
                if (searchPanel) searchPanel.classList.remove('show');
                if (panel) {
                    panel.classList.toggle('show');
                }
            }

            // Toggle filters expansion row (new inline expansion)
            function toggleFiltersExpansion(event) {
                event.stopPropagation();
                const settingsBar = document.querySelector('.page-settings-bar');
                if (settingsBar) {
                    settingsBar.classList.toggle('filters-expanded');
                }
            }

            // Render filter category button for expansion row
            function renderFilterCategoryButton(key, label, data) {
                if (!data) data = {};
                const selectedCount = activeFilters[key]?.length || 0;
                const hasActive = selectedCount > 0;

                return `
                <button class="filter-category-btn ${hasActive ? 'has-active' : ''}" 
                        onclick="openFilterCategoryModal('${key}', '${label}')">
                    <span>${label}</span>
                    ${hasActive ? `<span class="filter-category-count">${selectedCount}</span>` : ''}
                </button>
            `;
            }

            // Open filter category modal/dropdown
            function openFilterCategoryModal(key, label) {
                // For now, we'll use a simple approach - show the filter panel item dropdown
                // This can be enhanced later with a proper modal
                const data = {
                    'collection': categories.collections,
                    'chatzer': categories.chatzeros,
                    'mechaber': categories.mechabrim,
                    'verter': categories.verter,
                    'gezungen': categories.gezungen,
                    'ritem': categories.ritem,
                    'scale': categories.scale
                }[key];

                if (!data) return;

                const options = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));
                const selectedValues = activeFilters[key] || [];

                // Create a simple dropdown overlay
                let overlay = document.getElementById('filterCategoryOverlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'filterCategoryOverlay';
                    overlay.className = 'filter-category-overlay';
                    document.body.appendChild(overlay);
                }

                overlay.innerHTML = `
                <div class="filter-category-modal">
                    <div class="filter-category-modal-header">
                        <h3>${label}</h3>
                        <button class="filter-category-modal-close" onclick="closeFilterCategoryModal()">×</button>
                    </div>
                    <div class="filter-category-modal-body">
                        ${options.map(opt => `
                            <label class="filter-category-option ${selectedValues.includes(opt) ? 'selected' : ''}">
                                <input type="checkbox" 
                                       ${selectedValues.includes(opt) ? 'checked' : ''} 
                                       onchange="toggleFilterValue('${key}', '${opt.replace(/'/g, "\\'")}')">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
                overlay.classList.add('active');
            }

            // Close filter category modal
            function closeFilterCategoryModal() {
                const overlay = document.getElementById('filterCategoryOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                }
            }

            // Toggle filter value
            function toggleFilterValue(key, value) {
                if (!activeFilters[key]) activeFilters[key] = [];

                const index = activeFilters[key].indexOf(value);
                if (index > -1) {
                    activeFilters[key].splice(index, 1);
                } else {
                    activeFilters[key].push(value);
                }

                applyFilters();
                updateSongsFiltersUI();
            }

            // Toggle filter panel item
            function toggleFilterPanelItem(key) {
                const item = document.querySelector(`.filter-panel-item[data-filter="${key}"]`);
                if (item) {
                    // Close other items
                    document.querySelectorAll('.filter-panel-item.open').forEach(el => {
                        if (el !== item) el.classList.remove('open');
                    });
                    item.classList.toggle('open');
                }
            }

            // Handle filter panel search
            function handleFilterPanelSearch(query) {
                searchQuery = query.trim();
                applyFilters();
                updateSongsFiltersUI();
            }

            // Remove single filter
            function removeFilter(key, value) {
                activeFilters[key] = activeFilters[key].filter(v => v !== value);
                applyFilters();
                updateSongsFiltersUI();
            }

            // Close search and filter panels on outside click
            document.addEventListener('click', (e) => {
                const searchDropdown = document.getElementById('searchPanelDropdown');
                if (searchDropdown && !searchDropdown.contains(e.target)) {
                    const searchPanel = document.getElementById('searchPanelContent');
                    if (searchPanel) searchPanel.classList.remove('show');
                }

                const filterDropdown = document.getElementById('filterPanelDropdown');
                if (filterDropdown && !filterDropdown.contains(e.target)) {
                    const filterPanel = document.getElementById('filterPanelContent');
                    if (filterPanel) filterPanel.classList.remove('show');
                }
            });

            // Update songs filters UI only (without re-rendering the whole page)
            function updateSongsFiltersUI() {
                const filtersContainer = document.querySelector('.page-settings-bar .detail-filters-group');
                if (filtersContainer) {
                    filtersContainer.innerHTML = getSongsFiltersHTML();
                }

                // Update filter button active state
                const totalActiveFilters = Object.values(activeFilters).reduce((sum, arr) => sum + arr.length, 0);
                const filterBtn = document.querySelector('#filterPanelDropdown .filter-panel-btn');
                if (filterBtn) {
                    if (totalActiveFilters > 0) {
                        filterBtn.classList.add('has-active');
                        // Update count badge
                        let countBadge = filterBtn.querySelector('.filter-count');
                        if (!countBadge) {
                            countBadge = document.createElement('span');
                            countBadge.className = 'filter-count';
                            filterBtn.appendChild(countBadge);
                        }
                        countBadge.textContent = totalActiveFilters;
                    } else {
                        filterBtn.classList.remove('has-active');
                        const countBadge = filterBtn.querySelector('.filter-count');
                        if (countBadge) countBadge.remove();
                    }
                }

                // Update search button active state
                // Update search button active state
                const searchBtn = document.querySelector('.page-settings-bar .search-trigger-btn');
                if (searchBtn) {
                    if (searchQuery) {
                        searchBtn.classList.add('has-active');
                    } else {
                        searchBtn.classList.remove('has-active');
                    }
                }
            }

            // Render all songs page
            function renderAllSongsPage(container) {
                // NOTE: Always build full page structure so songsGrid exists
                // If no songs yet, grid will show skeleton rows inside it

                // Reset lazy loading state
                songsLazyState = {
                    currentIndex: 0,
                    batchSize: 50,
                    isLoading: false,
                    isInitialLoad: true
                };

                container.innerHTML = `
                <div class="page-theme-nigun view-mode-${currentDisplayMode}">
                    <div class="songs-floating-notes" id="songsFloatingNotes"></div>
                    <div class="page-title">
                        <div class="page-title-bar">ניגונים</div>
                        <div class="subtitle ${!songsFullyLoaded ? 'loading-state' : ''}">${!songsFullyLoaded ? getTinyLoaderHTML() + ' ' : ''}<span class="count-number">${filteredSongs.length}</span></div>
                        <div class="loading-wave-bar" id="loadingWaveBar"></div>
                    </div>

                    <div class="page-settings-bar">
                        <div class="detail-filters-group">
                            ${getSongsFiltersHTML()}
                        </div>
                    </div>

                    <div class="songs-page-layout">
                        <div class="songs-main-content">
                            <div class="songs-card">
                                <div class="all-songs-grid" id="songsGrid">
                                    ${filteredSongs.length === 0 && !songsFullyLoaded ? `
                                        <div class="skeleton-song-row"></div>
                                        <div class="skeleton-song-row"></div>
                                        <div class="skeleton-song-row"></div>
                                        <div class="skeleton-song-row"></div>
                                        <div class="skeleton-song-row"></div>
                                        <div class="skeleton-song-row"></div>
                                        <div class="skeleton-song-row"></div>
                                        <div class="skeleton-song-row"></div>
                                    ` : ''}
                                </div>
                                <div id="songsLoadMoreIndicator" style="height: 1px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                // Show loading wave bar (will be hidden when all songs are loaded)
                const waveBar = document.getElementById('loadingWaveBar');
                if (waveBar) {
                    // Show wave bar if songs are still loading from API
                    if (!songsFullyLoaded) {
                        waveBar.classList.add('active');
                    }
                }

                // Load first batch of songs
                loadMoreSongs();

                // Setup infinite scroll observer
                const observer = new IntersectionObserver((entries) => {
                    console.log(`IntersectionObserver: isIntersecting=${entries[0].isIntersecting}, songsFullyLoaded=${songsFullyLoaded}`);
                    // Only load more if songs are fully loaded from API and user is scrolling
                    if (entries[0].isIntersecting && songsFullyLoaded) {
                        loadMoreSongs(true); // true = animate new items
                    }
                }, { rootMargin: '200px' });

                const indicator = document.getElementById('songsLoadMoreIndicator');
                if (indicator) observer.observe(indicator);

                renderActiveFilterTags();

                // Initialize sort toggle slider position
                initSortToggleSlider();

                // Generate floating musical notes
                generateSongsFloatingNotes();
            }

            // Generate floating musical notes for the nigunim page background
            function generateSongsFloatingNotes() {
                const notesContainer = document.getElementById('songsFloatingNotes');
                if (!notesContainer) return;

                const symbols = ['♪', '♫', '♬', '♩', '♭', '♮', '♯'];
                const noteCount = 35; // More notes
                let html = '';

                for (let i = 0; i < noteCount; i++) {
                    const symbol = symbols[Math.floor(Math.random() * symbols.length)];
                    const size = 50 + Math.random() * 70; // 50-120px
                    const duration = 90 + Math.random() * 60; // Ultra slow: 90-150s
                    const delay = Math.random() * duration;
                    const rot = (Math.random() * 40 - 20) + 'deg';

                    // Random angle for radial movement from center - all directions
                    const angle = Math.random() * 360;
                    const distance = 60 + Math.random() * 40; // 60-100 distance
                    const endXVal = Math.cos(angle * Math.PI / 180) * distance;
                    const endYVal = Math.sin(angle * Math.PI / 180) * distance;

                    // Use calc() to handle negative values properly
                    const endX = `calc(${endXVal}vw - 50%)`;
                    const endY = `calc(${endYVal}vh - 50%)`;

                    // Random wander class for subtle movement
                    const wanderClass = `wander-${Math.floor(Math.random() * 3) + 1}`;
                    const wanderDuration = 40 + Math.random() * 20; // 40-60s wander cycle - ultra slow and calm

                    html += `
                    <div class="note-wrapper" style="--end-x: ${endX}; --end-y: ${endY}; animation-duration: ${duration}s; animation-delay: -${delay}s;">
                        <span class="musical-note ${wanderClass}" style="--rot: ${rot}; font-size: ${size}px; animation-duration: ${wanderDuration}s;">${symbol}</span>
                    </div>
                `;
                }
                notesContainer.innerHTML = html;
            }

            // Load more songs (for infinite scroll)
            // animate parameter controls if new items should pop in (only for user scroll)
            function loadMoreSongs(animate = false) {
                console.log(`loadMoreSongs called: isFlipping=${isFlipping}, isLoading=${songsLazyState.isLoading}, currentIndex=${songsLazyState.currentIndex}, filteredLength=${filteredSongs.length}`);
                if (isFlipping) return; // Don't interfere with FLIP animation
                if (songsLazyState.isLoading) return;
                if (songsLazyState.currentIndex >= filteredSongs.length) return;

                songsLazyState.isLoading = true;
                const grid = document.getElementById('songsGrid');
                if (!grid) {
                    songsLazyState.isLoading = false;
                    return;
                }

                // Clear skeleton rows if this is the first real data
                if (songsLazyState.isInitialLoad) {
                    const skeletonRows = grid.querySelectorAll('.skeleton-song-row');
                    skeletonRows.forEach(row => row.remove());
                }

                // Count AFTER skeleton removal
                const existingCount = grid.children.length;

                const endIndex = Math.min(
                    songsLazyState.currentIndex + songsLazyState.batchSize,
                    filteredSongs.length
                );

                const batch = filteredSongs.slice(songsLazyState.currentIndex, endIndex);
                const playlistIndices = filteredSongs.map(song => allSongs.indexOf(song));

                const html = batch.map((song, idx) => {
                    const globalIdx = allSongs.indexOf(song);
                    const displayNum = songsLazyState.currentIndex + idx + 1;
                    return renderSongItem(song, globalIdx, displayNum, playlistIndices);
                }).join('');

                grid.insertAdjacentHTML('beforeend', html);
                songsLazyState.currentIndex = endIndex;
                songsLazyState.isLoading = false;

                // Update active song highlight after rendering
                if (songsLazyState.isInitialLoad) {
                    // Use setTimeout to ensure DOM is ready
                    setTimeout(() => {
                        updateActiveSongInList();
                    }, 0);
                }

                // Animation for scroll-loaded items (slide up one after another)
                if (animate && existingCount > 0) {
                    const newItems = Array.from(grid.children).slice(existingCount);
                    newItems.forEach((item, i) => {
                        // Start below and invisible
                        item.style.opacity = '0';
                        item.style.transform = 'translateY(25px)';
                        // Slide up one after another
                        setTimeout(() => {
                            item.style.transition = 'opacity 0.25s ease-out, transform 0.3s ease-out';
                            item.style.opacity = '1';
                            item.style.transform = 'translateY(0)';
                        }, i * 35);
                    });
                }

                // Animation for first batch - same pop-in style as FLIP new elements
                if (songsLazyState.isInitialLoad && existingCount === 0) {
                    const newItems = Array.from(grid.children);
                    newItems.forEach((item, i) => {
                        // Start hidden with scale - same as FLIP
                        item.style.opacity = '0';
                        item.style.transform = 'scale(0.9)';
                        // Pop in with elastic effect - same as FLIP
                        setTimeout(() => {
                            item.style.transition = 'opacity 0.3s ease-out, transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1)';
                            item.style.opacity = '1';
                            item.style.transform = 'scale(1)';
                        }, 50 + i * 25); // Faster stagger for first batch
                    });
                }

                // Mark initial load as complete after first batch
                if (songsLazyState.isInitialLoad) {
                    songsLazyState.isInitialLoad = false;
                }

                console.log(`Loaded ${batch.length} songs (${songsLazyState.currentIndex}/${filteredSongs.length})`);

                // Check separators after DOM update and animations complete
                requestAnimationFrame(() => {
                    updateMetaSeparators();
                    // Also check multiple times as animations complete
                    setTimeout(updateMetaSeparators, 100);
                    setTimeout(updateMetaSeparators, 400);
                    setTimeout(updateMetaSeparators, 800);
                });
            }

            // Check if mechaber and chatzer tags are on same row and show/hide separator
            function updateMetaSeparators() {
                const songMetas = document.querySelectorAll('.song-meta');
                songMetas.forEach(meta => {
                    const separator = meta.querySelector('.song-meta-separator');
                    if (!separator) return;

                    // Get the mechaber tag (before separator) and first chatzer tag (after separator)
                    const mechaberTag = meta.querySelector('.mechaber-tag');
                    const chatzerTag = meta.querySelector('.chatzer-tag');

                    if (!mechaberTag || !chatzerTag) {
                        separator.classList.remove('same-row');
                        return;
                    }

                    // Check if mechaber and first chatzer tag are on same row (same offsetTop)
                    const sameRow = Math.abs(mechaberTag.offsetTop - chatzerTag.offsetTop) < 5;

                    separator.classList.toggle('same-row', sameRow);
                });
            }

            // Update separators on resize
            window.addEventListener('resize', () => {
                clearTimeout(window._separatorResizeTimer);
                window._separatorResizeTimer = setTimeout(updateMetaSeparators, 100);
            });

            // Render sidebar filter dropdown
            function renderSidebarFilter(key, label, data) {
                if (!data) data = {};
                const options = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));
                const selectedCount = activeFilters[key]?.length || 0;
                const selectedValue = selectedCount > 0 ? `(${selectedCount})` : '(אלע)';

                return `
                <div class="sidebar-filter" data-filter="${key}">
                    <div class="sidebar-filter-dropdown">
                        <button class="sidebar-filter-btn ${selectedCount > 0 ? 'active' : ''}" onclick="toggleSidebarDropdown('${key}')">
                            <span class="sidebar-filter-label">${label}</span>
                            <span class="sidebar-filter-value">${selectedValue}</span>
                            <span class="dropdown-arrow">▼</span>
                        </button>
                        <div class="sidebar-dropdown-content" id="sidebar-dropdown-${key}">
                            <div class="dropdown-search-box">
                                <input type="text" 
                                       class="dropdown-search-input" 
                                       placeholder="זוך..."
                                       onclick="event.stopPropagation()"
                                       oninput="filterDropdownOptions('${key}', this.value)">
                            </div>
                            <div class="dropdown-options" id="dropdown-options-${key}">
                                ${options.map(opt => {
                    const escapedOpt = opt.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    return `
                                    <label class="sidebar-filter-option" data-value="${opt.toLowerCase()}" onclick="event.stopPropagation()">
                                        <input type="checkbox" 
                                            value="${opt.replace(/"/g, '&quot;')}" 
                                            ${activeFilters[key]?.includes(opt) ? 'checked' : ''}
                                            onchange="handleFilterChange('${key}', '${escapedOpt}', this.checked)">
                                        ${opt}
                                    </label>
                                `}).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }

            // Filter dropdown options based on search
            function filterDropdownOptions(key, searchTerm) {
                const container = document.getElementById('dropdown-options-' + key);
                const options = container.querySelectorAll('.sidebar-filter-option[data-value]');
                const term = searchTerm.toLowerCase();

                options.forEach(option => {
                    const value = option.getAttribute('data-value');
                    if (value.includes(term)) {
                        option.style.display = 'flex';
                    } else {
                        option.style.display = 'none';
                    }
                });
            }

            // Toggle sidebar dropdown
            function toggleSidebarDropdown(key) {
                const dropdown = document.getElementById('sidebar-dropdown-' + key);
                const allDropdowns = document.querySelectorAll('.sidebar-dropdown-content');
                const wasOpen = dropdown.classList.contains('show');

                allDropdowns.forEach(d => {
                    d.classList.remove('show');
                });

                if (!wasOpen) {
                    dropdown.classList.add('show');
                }
            }

            // Clear specific filter type
            function clearFilterType(key) {
                activeFilters[key] = [];

                // Uncheck all checkboxes in this dropdown
                const dropdown = document.getElementById('dropdown-options-' + key);
                if (dropdown) {
                    dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                }

                applyFilters();
                renderActiveFilterTags();
            }

            // Render filter dropdown
            function renderFilterDropdown(key, label, data) {
                const options = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));
                const selectedCount = activeFilters[key]?.length || 0;

                return `
                <div class="filter-dropdown">
                    <button class="filter-btn ${selectedCount > 0 ? 'active' : ''}" onclick="toggleFilterDropdown('${key}')">
                        ${label}
                        <span>${selectedCount > 0 ? `(${selectedCount})` : '▼'}</span>
                    </button>
                    <div class="filter-dropdown-content" id="dropdown-${key}">
                        ${options.map(opt => `
                            <label class="filter-option">
                                <input type="checkbox" 
                                    value="${opt}" 
                                    ${activeFilters[key]?.includes(opt) ? 'checked' : ''}
                                    onchange="handleFilterChange('${key}', '${opt}', this.checked)">
                                ${opt} (${data[opt].length})
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
            }

            // Toggle filter dropdown
            function toggleFilterDropdown(key) {
                const dropdown = document.getElementById(`dropdown-${key}`);
                const allDropdowns = document.querySelectorAll('.filter-dropdown-content');

                allDropdowns.forEach(d => {
                    if (d.id !== `dropdown-${key}`) d.classList.remove('show');
                });

                dropdown.classList.toggle('show');
            }

            // Handle filter change (user clicks filter option)
            function handleFilterChange(key, value, checked) {
                if (checked) {
                    if (!activeFilters[key].includes(value)) {
                        activeFilters[key].push(value);
                    }
                } else {
                    activeFilters[key] = activeFilters[key].filter(v => v !== value);
                }

                // Update the mega menu header for this category
                updateMegaMenuHeader(key);

                applyFilters();
            }

            // Get available filter values based on currently filtered songs (for cascading filters)
            function getAvailableFilterValues() {
                const sourceData = hasAnyFilters() ? filteredSongs : allSongs;
                const available = {
                    collection: new Set(),
                    chatzer: new Set(),
                    mechaber: new Set(),
                    verter: new Set(),
                    gezungen: new Set(),
                    ritem: new Set(),
                    scale: new Set()
                };

                sourceData.forEach(song => {
                    // Collection
                    if (song.collections) {
                        song.collections.split(',').forEach(c => {
                            const trimmed = c.trim();
                            if (trimmed) available.collection.add(trimmed);
                        });
                    }
                    // Chatzer (category)
                    if (song.category) {
                        song.category.split(',').forEach(c => {
                            const trimmed = c.trim();
                            if (trimmed) available.chatzer.add(trimmed);
                        });
                    }
                    // Mechaber
                    if (song.mechaber) {
                        song.mechaber.split(',').forEach(m => {
                            const trimmed = m.trim();
                            if (trimmed) available.mechaber.add(trimmed);
                        });
                    }
                    // Verter
                    if (song.verter) {
                        song.verter.split(',').forEach(v => {
                            const trimmed = v.trim();
                            if (trimmed) available.verter.add(trimmed);
                        });
                    }
                    // Gezungen
                    if (song.gezungen) {
                        song.gezungen.split(',').forEach(g => {
                            const trimmed = g.trim();
                            if (trimmed) available.gezungen.add(trimmed);
                        });
                    }
                    // Ritem
                    if (song.ritem) {
                        song.ritem.split(',').forEach(r => {
                            const trimmed = r.trim();
                            if (trimmed) available.ritem.add(trimmed);
                        });
                    }
                    // Scale
                    if (song.scale) {
                        song.scale.split(',').forEach(s => {
                            const trimmed = s.trim();
                            if (trimmed) available.scale.add(trimmed);
                        });
                    }
                });

                return available;
            }

            // Update filter options to show available/unavailable state
            function updateAvailableFilterOptions() {
                const available = getAvailableFilterValues();

                // For each filter category column in the mega menu
                document.querySelectorAll('.filter-mega-column').forEach(column => {
                    const categoryKey = column.dataset.category;
                    if (!categoryKey || !available[categoryKey]) return;

                    const availableSet = available[categoryKey];

                    // Update each option
                    column.querySelectorAll('.filter-mega-option').forEach(option => {
                        const checkbox = option.querySelector('input[type="checkbox"]');
                        if (!checkbox) return;

                        const value = checkbox.value;
                        const isAvailable = availableSet.has(value);
                        const isSelected = checkbox.checked;

                        // Don't mark selected items as unavailable
                        if (isSelected) {
                            option.classList.remove('unavailable');
                        } else if (!isAvailable) {
                            option.classList.add('unavailable');
                        } else {
                            option.classList.remove('unavailable');
                        }
                    });
                });
            }

            // Update a single mega menu category header to show selected tags
            function updateMegaMenuHeader(key) {
                const column = document.querySelector(`.filter-mega-column[data-category="${key}"]`);
                if (!column) return;

                const header = column.querySelector('.filter-mega-header');
                if (!header) return;

                const selectedItems = activeFilters[key] || [];
                const hasActive = selectedItems.length > 0;

                // Get the label for this category
                const labels = {
                    'collection': 'קאלעקשאנס',
                    'chatzer': 'חצר',
                    'mechaber': 'מחבר',
                    'verter': 'ווערטער',
                    'gezungen': 'פיוטים',
                    'ritem': 'ריטעם',
                    'scale': 'סקעיל'
                };
                const label = labels[key] || key;

                // Update header class
                if (hasActive) {
                    header.classList.add('has-active');
                } else {
                    header.classList.remove('has-active');
                }

                // Find or create the content container (not the search input)
                let headerText = header.querySelector('.filter-mega-header-text');
                let headerTags = header.querySelector('.filter-mega-header-tags');

                if (hasActive) {
                    // Show tags, hide label
                    if (headerText) headerText.style.display = 'none';

                    if (!headerTags) {
                        headerTags = document.createElement('span');
                        headerTags.className = 'filter-mega-header-tags';
                        header.insertBefore(headerTags, header.querySelector('.filter-mega-search'));
                    }
                    headerTags.style.display = '';
                    headerTags.innerHTML = selectedItems.map(item => {
                        const escapedItem = item.replace(/'/g, "\\'").replace(/"/g, '\\"');
                        return `<span class="filter-header-tag" onclick="event.stopPropagation(); handleFilterChange('${key}', '${escapedItem}', false)">${item}<span class="tag-x">×</span></span>`;
                    }).join('');
                } else {
                    // Show label, hide/remove tags
                    if (headerTags) headerTags.style.display = 'none';

                    if (!headerText) {
                        headerText = document.createElement('span');
                        headerText.className = 'filter-mega-header-text';
                        headerText.innerHTML = `<span class="filter-mega-search-icon"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg></span>${label}`;
                        header.insertBefore(headerText, header.querySelector('.filter-mega-search'));
                    }
                    headerText.style.display = '';
                }

                // Also update the checkbox state in options
                const options = column.querySelectorAll('.filter-mega-option');
                options.forEach(opt => {
                    const checkbox = opt.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        const value = checkbox.value;
                        const isSelected = selectedItems.includes(value);
                        checkbox.checked = isSelected;
                        if (isSelected) {
                            opt.classList.add('selected');
                        } else {
                            opt.classList.remove('selected');
                        }
                    }
                });

                // Also update the main filter button tags
                updateMainFilterButton();
            }

            // Update the main filter button to show active filter count
            function updateMainFilterButton() {
                const trigger = document.querySelector('.filter-mega-trigger');
                if (!trigger) return;

                // Remove old tags container if exists
                const oldTagsContainer = trigger.querySelector('.filter-button-tags');
                if (oldTagsContainer) oldTagsContainer.remove();

                // Count all active filters
                let totalCount = 0;
                Object.values(activeFilters).forEach(items => {
                    if (items && items.length > 0) {
                        totalCount += items.length;
                    }
                });

                // Find or create count badge
                let countBadge = trigger.querySelector('.filter-count');

                if (totalCount > 0) {
                    trigger.classList.add('has-active');
                    if (!countBadge) {
                        countBadge = document.createElement('span');
                        countBadge.className = 'filter-count';
                        trigger.appendChild(countBadge);
                    }
                    countBadge.textContent = totalCount;

                    // Also ensure clear button exists
                    let clearBtn = trigger.querySelector('.filter-clear-btn');
                    if (!clearBtn) {
                        clearBtn = document.createElement('span');
                        clearBtn.className = 'filter-clear-btn';
                        clearBtn.textContent = '✕';
                        clearBtn.title = 'קלער אלע';
                        clearBtn.onclick = function (e) {
                            e.stopPropagation();
                            clearAllFilters();
                        };
                        trigger.appendChild(clearBtn);
                    }
                } else {
                    trigger.classList.remove('has-active');
                    if (countBadge) {
                        countBadge.remove();
                    }
                    // Also remove clear button
                    const clearBtn = trigger.querySelector('.filter-clear-btn');
                    if (clearBtn) clearBtn.remove();
                }
            }

            // Sort filteredSongs based on current sort order
            function sortFilteredSongs() {
                switch (currentSortOrder) {
                    case 'alphabetical':
                        filteredSongs.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'he'));
                        break;
                    case 'recent':
                        // Sort by zugeleigt (added date) - most recent first
                        // If zugeleigt is empty, put at the end
                        filteredSongs.sort((a, b) => {
                            const dateA = a.zugeleigt || '';
                            const dateB = b.zugeleigt || '';
                            // Empty dates go to the end
                            if (!dateA && !dateB) return (a.name || '').localeCompare(b.name || '', 'he');
                            if (!dateA) return 1;
                            if (!dateB) return -1;
                            // Compare dates (assuming format is consistent and comparable as strings)
                            // Reverse order for most recent first
                            return dateB.localeCompare(dateA);
                        });
                        break;
                    case 'random':
                        // Fisher-Yates shuffle
                        for (let i = filteredSongs.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [filteredSongs[i], filteredSongs[j]] = [filteredSongs[j], filteredSongs[i]];
                        }
                        break;
                }
            }

            // Change sort order and re-apply
            function changeSortOrder(order) {
                currentSortOrder = order;
                sortFilteredSongs();
                currentPage = 1;

                // Update toggle UI
                updateSortToggleSlider(order);

                // Update display with animation (sliders updated by selectSliderOption, not here)
                if (currentPageView === 'songs') {
                    updateSongsListWithAnimation();
                } else {
                    renderCurrentPage();
                }
            }

            // Update detail view when sort changes (called from detail-songs-section)
            function updateDetailView() {
                if (currentDetailView) {
                    renderDetailPage();
                }
            }

            // Sort a song array based on currentSortOrder (helper for detail views)
            function sortSongsByOrder(songs) {
                const sorted = [...songs]; // Create a copy to avoid mutating original
                switch (currentSortOrder) {
                    case 'alphabetical':
                        sorted.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'he'));
                        break;
                    case 'recent':
                        sorted.sort((a, b) => {
                            const dateA = a.zugeleigt || '';
                            const dateB = b.zugeleigt || '';
                            if (!dateA && !dateB) return (a.name || '').localeCompare(b.name || '', 'he');
                            if (!dateA) return 1;
                            if (!dateB) return -1;
                            return dateB.localeCompare(dateA);
                        });
                        break;
                    case 'random':
                        // Fisher-Yates shuffle
                        for (let i = sorted.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [sorted[i], sorted[j]] = [sorted[j], sorted[i]];
                        }
                        break;
                }
                return sorted;
            }

            // Update sort toggle slider position dynamically
            function updateSortToggleSlider(order) {
                const toggle = document.getElementById('sortToggle');
                if (!toggle) return;

                const slider = toggle.querySelector('.sort-toggle-slider');
                const activeOption = toggle.querySelector(`.sort-toggle-option[data-sort="${order}"]`);

                if (slider && activeOption) {
                    // Get the container's bounding rect
                    const containerRect = toggle.getBoundingClientRect();
                    const optionRect = activeOption.getBoundingClientRect();

                    // Calculate position relative to container (RTL: use right position)
                    const rightOffset = containerRect.right - optionRect.right;
                    const width = optionRect.width;

                    slider.style.right = rightOffset + 'px';
                    slider.style.width = width + 'px';
                }

                // Update active class on options
                toggle.querySelectorAll('.sort-toggle-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.sort === order);
                });
            }

            // Initialize sort toggle slider position on page load
            function initSortToggleSlider() {
                setTimeout(() => {
                    updateSortToggleSlider(currentSortOrder);
                    updateDisplayToggleSlider(currentDisplayMode);
                    setupQualityStarsHover();
                    initStickySidebar();
                }, 50);
            }

            // Initialize sticky sidebar - CSS sticky handles this now
            function initStickySidebar() {
                const sidebar = document.querySelector('.songs-sidebar');
                const wrapper = document.querySelector('.sidebar-wrapper');
                if (!sidebar || !wrapper) return;

                const header = document.querySelector('.main-header');
                const headerHeight = header ? header.offsetHeight : 80;
                const topOffset = 0;

                // Get initial position
                const wrapperRect = wrapper.getBoundingClientRect();
                const initialTop = wrapperRect.top + window.scrollY;
                const sidebarWidth = sidebar.offsetWidth;

                let isFixed = false;

                function handleScroll() {
                    const currentSidebar = document.querySelector('.songs-sidebar');
                    if (!currentSidebar) {
                        window.removeEventListener('scroll', handleScroll);
                        return;
                    }

                    const scrollY = window.scrollY;
                    const mainContent = document.querySelector('.songs-main-content');
                    if (!mainContent) return;

                    const mainRect = mainContent.getBoundingClientRect();
                    const shouldBeFixed = scrollY > initialTop - topOffset;
                    const maxBottom = mainRect.bottom + scrollY - currentSidebar.offsetHeight - 20;

                    if (shouldBeFixed && scrollY < maxBottom) {
                        if (!isFixed) {
                            currentSidebar.style.position = 'fixed';
                            currentSidebar.style.top = topOffset + 'px';
                            currentSidebar.style.width = sidebarWidth + 'px';
                            isFixed = true;
                        }
                    } else if (!shouldBeFixed) {
                        if (isFixed) {
                            currentSidebar.style.position = '';
                            currentSidebar.style.top = '';
                            currentSidebar.style.width = '';
                            isFixed = false;
                        }
                    }
                }

                window.addEventListener('scroll', handleScroll, { passive: true });
            }

            // Select slider option - animate without re-render
            function selectSliderOption(type, value, event) {
                event.stopPropagation();

                const sliderControl = event.target.closest('.slider-control');
                if (!sliderControl) return;

                const options = sliderControl.querySelectorAll('.slider-option');
                const indicator = sliderControl.querySelector('.slider-indicator');

                // Find the position of the clicked option
                let newPosition = 0;
                options.forEach((opt, index) => {
                    if (opt.dataset.value === value) {
                        newPosition = index;
                    }
                });

                // Update indicator position attribute (triggers CSS transition)
                if (indicator) {
                    indicator.dataset.position = newPosition.toString();
                }

                // Update active classes
                options.forEach(opt => {
                    opt.classList.remove('active');
                    if (opt.dataset.value === value) {
                        opt.classList.add('active');
                    }
                });

                // Call the actual change function (without re-rendering the slider)
                if (type === 'displayMode') {
                    changeDisplayMode(value);
                } else if (type === 'sortOrder') {
                    changeSortOrder(value);
                }
            }

            // Change display mode and re-render
            function changeDisplayMode(mode) {
                currentDisplayMode = mode;

                // Update toggle UI
                updateDisplayToggleSlider(mode);

                // Toggle full-mode-active class on songs-card
                const songsCard = document.querySelector('.songs-card');
                if (songsCard) {
                    if (mode === 'full') {
                        songsCard.classList.add('full-mode-active');
                    } else {
                        songsCard.classList.remove('full-mode-active');
                    }
                }

                // Toggle view-mode-xxx class on page container for grid layout
                const pageContainer = document.querySelector('.page-theme-nigun');
                if (pageContainer) {
                    pageContainer.classList.remove('view-mode-minimal', 'view-mode-recordings', 'view-mode-full');
                    pageContainer.classList.add('view-mode-' + mode);
                }

                // Update display with animation (don't re-render sliders - they're updated by selectSliderOption)
                if (currentPageView === 'songs') {
                    updateSongsListWithAnimation();
                    // Note: updateSongsFiltersUI skipped to preserve slider animation
                } else {
                    renderCurrentPage();
                }
            }

            // Set minimum quality rating filter
            function setMinQualityRating(rating) {
                // Toggle off if clicking the same rating
                if (minQualityRating === rating) {
                    minQualityRating = 0;
                } else {
                    minQualityRating = rating;
                }

                // Close quality panel immediately
                const panel = document.getElementById('qualityMegaExpanded');
                const trigger = document.getElementById('qualityMegaMenu');
                const subHeader = document.querySelector('.page-settings-bar');
                if (panel) panel.classList.remove('expanded');
                if (trigger) trigger.classList.remove('expanded');
                if (subHeader) subHeader.classList.remove('quality-expanded');

                // Update the stars UI
                updateQualityStarsUI();

                // Re-apply filters (will re-shuffle in random mode)
                applyFilters();
                updateSongsFiltersUI();
            }

            // Toggle recordings collapse in full mode
            function toggleRecordingsCollapse() {
                recordingsCollapsed = !recordingsCollapsed;
                // Re-render songs list
                if (currentPageView === 'songs') {
                    updateSongsListWithAnimation();
                }
            }

            // Update quality stars UI
            function updateQualityStarsUI() {
                const container = document.getElementById('qualityStarsFilter');
                if (!container) return;

                const stars = container.querySelectorAll('.quality-star');
                stars.forEach((star, idx) => {
                    const starRating = idx + 1;
                    if (minQualityRating >= starRating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });

                const clearBtn = container.querySelector('.quality-clear');
                if (clearBtn) {
                    if (minQualityRating === 0) {
                        clearBtn.classList.add('hidden');
                    } else {
                        clearBtn.classList.remove('hidden');
                    }
                }
            }

            // Setup hover handlers for quality stars (call after rendering)
            function setupQualityStarsHover() {
                const container = document.getElementById('qualityStarsFilter');
                if (!container) return;

                const stars = container.querySelectorAll('.quality-star');

                stars.forEach((star, idx) => {
                    star.addEventListener('mouseenter', () => {
                        container.classList.add('hovering');
                        // Highlight all stars up to and including this one
                        stars.forEach((s, i) => {
                            if (i <= idx) {
                                s.classList.add('hover-active');
                            } else {
                                s.classList.remove('hover-active');
                            }
                        });
                    });
                });

                container.addEventListener('mouseleave', () => {
                    container.classList.remove('hovering');
                    stars.forEach(s => s.classList.remove('hover-active'));
                });
            }

            // Check if a recording meets the minimum quality threshold
            // Unrated recordings (rating=0 or undefined) always pass so they can be discovered
            function recordingMeetsQuality(recording) {
                if (minQualityRating === 0) return true; // No filter
                const rating = recording.audioRating || recording.rating || 0;
                // Unrated recordings (0) always pass - otherwise no one will ever hear them
                if (rating === 0) return true;
                return rating >= minQualityRating;
            }

            // Check if a song has any recording that meets the quality threshold
            function songHasQualityAudio(song) {
                if (minQualityRating === 0) {
                    // No quality filter - check audioUrl, recordings array, or index flags
                    if (song.audioUrl && song.audioUrl.startsWith('http')) return true;
                    if (song.hasRecordings) return true; // From songIndex
                    if (song.bestRecordingRowId) return true; // Has a known recording
                    return false;
                }
                if (!song.recordings || song.recordings.length === 0) {
                    // No recordings loaded yet - check bestRecordingRating from index
                    if (song.bestRecordingRating && song.bestRecordingRating >= minQualityRating) return true;
                    return false;
                }
                return song.recordings.some(rec => recordingMeetsQuality(rec));
            }

            // Get the best quality recording for minimal mode playback
            // Picks the highest-rated recording, randomizes among ties
            function getBestQualityRecording(song) {
                if (!song.recordings || song.recordings.length === 0) return null;

                // Filter to quality recordings first
                let qualityRecs = song.recordings.filter(rec => recordingMeetsQuality(rec));
                if (qualityRecs.length === 0) return null;
                if (qualityRecs.length === 1) return qualityRecs[0];

                // Find the highest rating among quality recordings
                let maxRating = 0;
                qualityRecs.forEach(rec => {
                    const rating = rec.audioRating || rec.rating || 0;
                    if (rating > maxRating) maxRating = rating;
                });

                // Get all recordings with the max rating (including unrated if maxRating is 0)
                let topRecs = qualityRecs.filter(rec => {
                    const rating = rec.audioRating || rec.rating || 0;
                    return rating === maxRating;
                });

                // Randomly pick one from the top-rated recordings
                if (topRecs.length === 1) return topRecs[0];
                const randomIdx = Math.floor(Math.random() * topRecs.length);
                return topRecs[randomIdx];
            }

            // Alias for backwards compatibility
            function getFirstQualityRecording(song) {
                return getBestQualityRecording(song);
            }

            // Update display toggle slider position dynamically
            function updateDisplayToggleSlider(mode) {
                const toggle = document.getElementById('displayToggle');
                if (!toggle) return;

                const slider = toggle.querySelector('.sort-toggle-slider');
                const activeOption = toggle.querySelector(`.sort-toggle-option[data-mode="${mode}"]`);

                if (slider && activeOption) {
                    // Get the container's bounding rect
                    const containerRect = toggle.getBoundingClientRect();
                    const optionRect = activeOption.getBoundingClientRect();

                    // Calculate position relative to container (RTL: use right position)
                    const rightOffset = containerRect.right - optionRect.right;
                    const width = optionRect.width;

                    slider.style.right = rightOffset + 'px';
                    slider.style.width = width + 'px';
                }

                // Update active class on options
                toggle.querySelectorAll('.sort-toggle-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.mode === mode);
                });

                // Toggle full-mode-active class on songs-card
                const songsCard = document.querySelector('.songs-card');
                if (songsCard) {
                    if (mode === 'full') {
                        songsCard.classList.add('full-mode-active');
                    } else {
                        songsCard.classList.remove('full-mode-active');
                    }
                }
            }

            // Apply filters without updating display (for use before animated update)
            // skipSort: if true, don't re-sort - used during API loading to preserve order
            function applyFiltersQuiet(skipSort = false) {
                filteredSongs = allSongs.filter(song => {


                    // Check search query
                    if (searchQuery) {
                        const query = searchQuery.toLowerCase();
                        const matchName = song.name?.toLowerCase().includes(query);
                        const matchMechaber = song.mechaber?.some(m => m.toLowerCase().includes(query));
                        const matchCollection = song.collections?.some(c => c.toLowerCase().includes(query));
                        if (!matchName && !matchMechaber && !matchCollection) return false;
                    }

                    // Check all active filters
                    if (activeFilters.mechaber.length > 0) {
                        if (!activeFilters.mechaber.some(f => song.mechaber?.includes(f))) return false;
                    }
                    if (activeFilters.collection.length > 0) {
                        if (!activeFilters.collection.some(f => song.collections?.includes(f))) return false;
                    }
                    if (activeFilters.zman.length > 0) {
                        if (!activeFilters.zman.some(f => song.pasigOif?.includes(f))) return false;
                    }
                    if (activeFilters.scale.length > 0) {
                        if (!activeFilters.scale.some(f => song.scale?.includes(f))) return false;
                    }
                    if (activeFilters.ritem.length > 0) {
                        if (!activeFilters.ritem.some(f => song.ritem?.includes(f))) return false;
                    }
                    if (activeFilters.gezungen.length > 0) {
                        if (!activeFilters.gezungen.some(f => song.gezungen?.includes(f))) return false;
                    }
                    if (activeFilters.maure.length > 0) {
                        if (!activeFilters.maure.some(f => song.maure?.includes(f))) return false;
                    }
                    if (activeFilters.verter.length > 0) {
                        const songVerter = song.verter?.split(',').map(v => v.trim()).filter(Boolean) || [];
                        if (!activeFilters.verter.some(f => songVerter.includes(f))) return false;
                    }
                    if (activeFilters.chatzer.length > 0) {
                        if (!activeFilters.chatzer.some(f => song.chatzer?.includes(f))) return false;
                    }
                    return true;
                });
                if (!skipSort) {
                    sortFilteredSongs();
                }
                currentPage = 1;
            }

            // Apply filters
            function applyFilters() {
                filteredSongs = allSongs.filter(song => {


                    // Check search query
                    if (searchQuery) {
                        const query = searchQuery.toLowerCase();
                        const searchableText = [
                            song.name,
                            song.mechaber,
                            song.category,
                            song.verter,
                            song.collections,
                            song.pasigOif,
                            song.info,
                            song.siman
                        ].filter(Boolean).join(' ').toLowerCase();
                        if (!searchableText.includes(query)) return false;
                    }
                    // Check chatzer
                    if (activeFilters.chatzer.length > 0) {
                        if (!activeFilters.chatzer.some(f => song.category?.includes(f))) return false;
                    }
                    // Check mechaber
                    if (activeFilters.mechaber.length > 0) {
                        if (!activeFilters.mechaber.some(f => song.mechaber?.includes(f))) return false;
                    }
                    // Check collection
                    if (activeFilters.collection.length > 0) {
                        if (!activeFilters.collection.some(f => song.collections?.includes(f))) return false;
                    }
                    // Check zman
                    if (activeFilters.zman.length > 0) {
                        if (!activeFilters.zman.some(f => song.pasigOif?.includes(f))) return false;
                    }
                    // Check scale
                    if (activeFilters.scale.length > 0) {
                        if (!activeFilters.scale.some(f => song.scale?.includes(f))) return false;
                    }
                    // Check ritem
                    if (activeFilters.ritem.length > 0) {
                        if (!activeFilters.ritem.some(f => song.ritem?.includes(f))) return false;
                    }
                    // Check gezungen
                    if (activeFilters.gezungen.length > 0) {
                        if (!activeFilters.gezungen.some(f => song.gezungen?.includes(f))) return false;
                    }
                    // Check maure
                    if (activeFilters.maure.length > 0) {
                        if (!activeFilters.maure.some(f => song.maure?.includes(f))) return false;
                    }
                    // Check verter
                    if (activeFilters.verter.length > 0) {
                        const songVerter = song.verter?.split(',').map(v => v.trim()).filter(Boolean) || [];
                        if (!activeFilters.verter.some(f => songVerter.includes(f))) return false;
                    }
                    return true;
                });

                sortFilteredSongs();
                currentPage = 1;

                // If we're on songs page, update the list with fade animation
                if (currentPageView === 'songs') {
                    updateSongsListWithAnimation(); // Fade out/in for filters
                    updateSongsCount();
                    renderActiveFilterTags();
                    updateSidebarFilterValues();
                    updateAvailableFilterOptions(); // Update cascading filter options
                } else {
                    renderCurrentPage();
                }
            }

            // Update songs list with animation specifically for filter changes
            function updateSongsListWithAnimation() {
                const grid = document.getElementById('songsGrid');
                if (!grid) return;

                const existingItems = Array.from(grid.children);

                // If no existing items, just load without animation
                if (existingItems.length === 0) {
                    songsLazyState = {
                        currentIndex: 0,
                        batchSize: 50,
                        isLoading: false,
                        isInitialLoad: true
                    };
                    loadMoreSongs();
                    return;
                }

                // Fade out existing items
                existingItems.forEach((item, i) => {
                    item.style.transition = 'opacity 0.18s ease-out, transform 0.18s ease-out';
                    item.style.transitionDelay = `${Math.min(i * 5, 100)}ms`;
                    item.style.opacity = '0';
                    item.style.transform = 'scale(0.97)';
                });

                // After fade out, reload with slide-up animation
                setTimeout(() => {
                    grid.innerHTML = '';

                    // For sorted modes: seed with song at position 0 to allow smooth FLIP
                    // For shuffle: just load first song normally
                    if (currentSortOrder !== 'random' && filteredSongs.length > 0) {
                        const seedPosition = 0; // Seed with first song, loadMoreSongs starts at 1
                        const seedSong = filteredSongs[seedPosition];
                        const seedIdx = allSongs.indexOf(seedSong);
                        const playlistIndices = filteredSongs.map(song => allSongs.indexOf(song));

                        // Create the seed element
                        const seedHtml = renderSongItem(seedSong, seedIdx, seedPosition + 1, playlistIndices);
                        grid.insertAdjacentHTML('beforeend', seedHtml);
                        songsLazyState = {
                            currentIndex: 1, // Start AFTER the seed
                            batchSize: 50,
                            isLoading: false,
                            isInitialLoad: false
                        };

                        // Mark only this song as seen - ALL others will FLIP in
                        seenSongIds = new Set([seedSong.rowId || seedSong.name]);
                        console.log(`Sort change: seeded with song at position ${seedPosition} for FLIP`);

                        // Animate the seed song, then trigger FLIP
                        requestAnimationFrame(() => {
                            const item = grid.children[0];
                            if (item) {
                                item.style.opacity = '0';
                                item.style.transform = 'translateY(20px)';
                                setTimeout(() => {
                                    item.style.transition = 'opacity 0.25s ease-out, transform 0.3s ease-out';
                                    item.style.opacity = '1';
                                    item.style.transform = 'translateY(0)';
                                }, 50);
                            }

                            // Manually trigger FLIP with all other songs
                            // This ensures songs are inserted at correct positions
                            setTimeout(() => {
                                const allOtherSongs = allSongs.filter(s => {
                                    const id = s.rowId || s.name;
                                    return !seenSongIds.has(id);
                                });
                                if (allOtherSongs.length > 0 && grid.children.length > 0) {
                                    console.log(`Sort change: triggering FLIP for ${allOtherSongs.length} songs`);
                                    updateSongsListWithNewSongs(allOtherSongs);
                                }
                            }, 100);
                        });
                    } else {
                        // Shuffle mode or small list - load normally
                        songsLazyState = {
                            currentIndex: 0,
                            batchSize: 1,
                            isLoading: false,
                            isInitialLoad: true
                        };
                        loadMoreSongs();
                        songsLazyState.batchSize = 50;

                        // Mark only the displayed song as seen
                        const displayedSongs = filteredSongs.slice(0, 1);
                        seenSongIds = new Set(displayedSongs.map(s => s.rowId || s.name));
                        console.log(`Sort change: marked ${seenSongIds.size} displayed song as seen (shuffle mode)`);

                        // Animate new items sliding up from below
                        requestAnimationFrame(() => {
                            const newItems = Array.from(grid.children);
                            newItems.forEach((item, i) => {
                                item.style.opacity = '0';
                                item.style.transform = 'translateY(20px)';
                                setTimeout(() => {
                                    item.style.transition = 'opacity 0.25s ease-out, transform 0.3s ease-out';
                                    item.style.opacity = '1';
                                    item.style.transform = 'translateY(0)';
                                }, i * 20);
                            });

                            // Load remaining songs after first one appears
                            setTimeout(() => {
                                const remainingSongs = filteredSongs.filter(s => {
                                    const id = s.rowId || s.name;
                                    return !seenSongIds.has(id);
                                });
                                if (remainingSongs.length > 0 && grid.children.length > 0) {
                                    console.log(`Shuffle mode: loading ${remainingSongs.length} remaining songs`);
                                    updateSongsListWithNewSongs(remainingSongs);
                                }
                            }, 100);
                        });
                    }
                }, 250);
            }

            // Update songs list with FLIP animation for incremental data updates
            // Songs that need to make room slide down, new songs pop in at their sorted position
            function updateSongsList() {
                const grid = document.getElementById('songsGrid');
                if (!grid) return;

                const existingItems = Array.from(grid.children);

                // If no existing items or empty grid, just load normally
                if (existingItems.length === 0) {
                    songsLazyState = {
                        currentIndex: 0,
                        batchSize: 50,
                        isLoading: false,
                        isInitialLoad: true
                    };
                    loadMoreSongs();
                    updateSongsCount();
                    return;
                }

                // Get currently displayed song indices
                const displayedSongIdxs = new Set();
                existingItems.forEach(item => {
                    const idx = item.getAttribute('data-song-idx');
                    if (idx) displayedSongIdxs.add(parseInt(idx));
                });

                // Get the first batch of filtered songs worth displaying
                const maxToShow = Math.max(existingItems.length, 50);
                const newFilteredBatch = filteredSongs.slice(0, maxToShow);
                const newSongIdxs = new Set(newFilteredBatch.map(song => allSongs.indexOf(song)));

                // Find songs to add (in newFilteredBatch but not displayed)
                const songsToAdd = newFilteredBatch.filter(song => {
                    const idx = allSongs.indexOf(song);
                    return !displayedSongIdxs.has(idx);
                });

                console.log(`FLIP: ${songsToAdd.length} songs to add out of ${newFilteredBatch.length}`);

                // If no songs to add, nothing to do - just return
                if (songsToAdd.length === 0) {
                    console.log('FLIP: No new songs in visible range, skipping');
                    return;
                }

                // If too many changes, just reload quietly (no animation)
                if (songsToAdd.length > 300) {
                    console.log('FLIP: Too many songs to animate, reloading quietly');
                    songsLazyState = {
                        currentIndex: 0,
                        batchSize: 50,
                        isLoading: false,
                        isInitialLoad: false  // Not initial - no animation
                    };
                    grid.innerHTML = '';
                    loadMoreSongs(false);  // false = no animation
                    updateSongsCount();
                    return;
                }

                // FLIP Animation
                // Step 1 (First): Record positions of existing items
                const firstPositions = new Map();
                existingItems.forEach(item => {
                    const idx = item.getAttribute('data-song-idx');
                    firstPositions.set(idx, item.getBoundingClientRect());
                });

                // Step 2: Insert new songs at correct sorted positions
                const playlistIndices = filteredSongs.map(song => allSongs.indexOf(song));
                const newElements = [];

                songsToAdd.forEach(song => {
                    const globalIdx = allSongs.indexOf(song);

                    // Skip if song already exists in grid (prevent duplicates)
                    if (grid.querySelector(`[data-song-idx="${globalIdx}"]`)) {
                        return;
                    }

                    const displayNum = playlistIndices.indexOf(globalIdx) + 1;
                    const html = renderSongItem(song, globalIdx, displayNum, playlistIndices);

                    const template = document.createElement('template');
                    template.innerHTML = html.trim();
                    const newElement = template.content.firstChild;

                    // Find insertion point based on song name (Hebrew alphabetical)
                    const songName = song.name || '';
                    let insertBefore = null;

                    for (const existingItem of grid.children) {
                        const existingSongName = existingItem.querySelector('.song-name')?.textContent || '';
                        if (songName.localeCompare(existingSongName, 'he') < 0) {
                            insertBefore = existingItem;
                            break;
                        }
                    }

                    if (insertBefore) {
                        grid.insertBefore(newElement, insertBefore);
                    } else {
                        grid.appendChild(newElement);
                    }

                    newElements.push(newElement);
                });

                // Step 3 (Last + Invert + Play): Animate
                requestAnimationFrame(() => {
                    // Animate existing items that moved down
                    existingItems.forEach(item => {
                        if (!item.isConnected) return;

                        const idx = item.getAttribute('data-song-idx');
                        const first = firstPositions.get(idx);
                        if (!first) return;

                        const last = item.getBoundingClientRect();
                        const deltaY = first.top - last.top;

                        if (Math.abs(deltaY) > 1) {
                            // Item moved - animate from old position to new
                            item.style.transition = 'none';
                            item.style.transform = `translateY(${deltaY}px)`;

                            requestAnimationFrame(() => {
                                item.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                                item.style.transform = 'translateY(0)';
                            });
                        }
                    });

                    // Animate new items with pop-in effect
                    newElements.forEach((item, i) => {
                        item.style.opacity = '0';
                        item.style.transform = 'scale(0.9)';

                        setTimeout(() => {
                            item.style.transition = 'opacity 0.3s ease-out, transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1)';
                            item.style.opacity = '1';
                            item.style.transform = 'scale(1)';
                        }, 100 + i * 50);
                    });
                });

                // Update lazy state
                songsLazyState.currentIndex = grid.children.length;
                updateSongsCount();
            }

            // FLIP animation for specific new songs from API batch
            // Ensures grid is ALWAYS in correct order, with new songs animating in
            function updateSongsListWithNewSongs(newSongs) {
                isFlipping = true;


                const grid = document.getElementById('songsGrid');
                if (!grid) {

                    isFlipping = false;
                    return;
                }

                const existingItems = Array.from(grid.children);


                if (existingItems.length === 0) {

                    isFlipping = false;
                    return;
                }

                // Build SET of existing song indices (allSongs index) in grid
                const existingIdxSet = new Set();
                existingItems.forEach(item => {
                    const idx = parseInt(item.getAttribute('data-song-idx'));
                    if (!isNaN(idx)) existingIdxSet.add(idx);
                });


                // Determine how many items to show
                const targetCount = Math.min(existingItems.length + 20, 100);


                // Get the correct order from filteredSongs
                const correctOrder = filteredSongs.slice(0, targetCount);




                // In shuffle mode: use newSongs from API, not correctOrder
                const isShuffleModeForInsert = currentSortOrder === 'random';

                // Find which songs to insert
                const newToInsert = [];

                if (isShuffleModeForInsert && newSongs && newSongs.length > 0) {
                    // SHUFFLE MODE: Pick random songs from the NEW API batch to insert
                    // Scale insertions based on grid size - less insertions as grid grows
                    const gridSize = existingItems.length;
                    let maxInsert;
                    if (gridSize < 50) {
                        maxInsert = 15;  // Early batches: more visible action
                    } else if (gridSize < 100) {
                        maxInsert = 8;   // Medium: moderate
                    } else {
                        maxInsert = 5;   // Large grid: subtle additions
                    }
                    maxInsert = Math.min(maxInsert, newSongs.length);

                    // Shuffle newSongs and take first maxInsert that aren't in grid
                    const shuffledNew = [...newSongs];
                    for (let i = shuffledNew.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffledNew[i], shuffledNew[j]] = [shuffledNew[j], shuffledNew[i]];
                    }

                    let insertCount = 0;
                    for (const song of shuffledNew) {
                        if (insertCount >= maxInsert) break;
                        const idx = allSongs.indexOf(song);
                        if (idx >= 0 && !existingIdxSet.has(idx)) {
                            newToInsert.push({ song, idx, targetPos: insertCount });
                            insertCount++;
                        }
                    }

                } else {
                    // SORTED MODE: Use correctOrder to find missing songs
                    correctOrder.forEach((song, pos) => {
                        const idx = allSongs.indexOf(song);
                        if (idx >= 0 && !existingIdxSet.has(idx)) {
                            newToInsert.push({ song, idx, targetPos: pos });
                        }
                    });
                }



                if (newToInsert.length === 0) {
                    isFlipping = false;
                    return;
                }

                // Step 1 (First): Record positions of all existing items
                const firstPositions = new Map();
                existingItems.forEach(item => {
                    firstPositions.set(item, item.getBoundingClientRect());
                });

                // Step 2: Insert new songs at correct positions (no clearing!)
                const playlistIndices = filteredSongs.map(song => allSongs.indexOf(song));
                const newElements = [];

                // In shuffle mode: shuffle the new songs first, then insert at random positions
                const isShuffleMode = currentSortOrder === 'random';
                if (isShuffleMode) {
                    // Shuffle the newToInsert array
                    for (let i = newToInsert.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [newToInsert[i], newToInsert[j]] = [newToInsert[j], newToInsert[i]];
                    }

                }

                newToInsert.forEach(({ song, idx, targetPos }) => {
                    // Double-check not already in grid
                    if (grid.querySelector(`[data-song-idx="${idx}"]`)) {

                        return;
                    }

                    const posInFiltered = filteredSongs.indexOf(song);
                    const displayNum = posInFiltered + 1;
                    const html = renderSongItem(song, idx, displayNum, playlistIndices);

                    const template = document.createElement('template');
                    template.innerHTML = html.trim();
                    const newElement = template.content.firstChild;

                    let insertBefore = null;
                    let insertBeforePos = -1;

                    if (isShuffleMode) {
                        // SHUFFLE MODE: Insert at uniformly random position
                        const gridItems = Array.from(grid.children);
                        const randomPos = Math.floor(Math.random() * gridItems.length);
                        if (randomPos < gridItems.length) {
                            insertBefore = gridItems[randomPos];
                            insertBeforePos = randomPos;
                        }
                    } else {
                        // SORTED MODE: Find correct insertion point by position
                        for (const existingItem of grid.children) {
                            const existingIdx = parseInt(existingItem.getAttribute('data-song-idx'));
                            const existingSong = allSongs[existingIdx];
                            if (existingSong) {
                                const existingPos = filteredSongs.indexOf(existingSong);
                                if (posInFiltered < existingPos) {
                                    insertBefore = existingItem;
                                    insertBeforePos = existingPos;
                                    break;
                                }
                            }
                        }
                    }

                    if (insertBefore) {

                        grid.insertBefore(newElement, insertBefore);
                    } else {

                        grid.appendChild(newElement);
                    }

                    newElements.push(newElement);
                    existingIdxSet.add(idx); // Mark as now in grid
                });



                // Step 3a: In SORTED mode, reorder ALL grid items to match correctOrder
                if (!isShuffleMode) {
                    // Recalculate correctOrder to cover ALL items now in grid
                    const actualGridSize = grid.children.length;
                    const fullCorrectOrder = filteredSongs.slice(0, actualGridSize);


                    // FIRST: Remove any duplicate idx elements (keep first occurrence)
                    const seenIdxForDedup = new Set();
                    const duplicatesToRemove = [];
                    Array.from(grid.children).forEach(item => {
                        const idx = parseInt(item.getAttribute('data-song-idx'));
                        if (!isNaN(idx)) {
                            if (seenIdxForDedup.has(idx)) {
                                duplicatesToRemove.push(item);

                            } else {
                                seenIdxForDedup.add(idx);
                            }
                        }
                    });
                    duplicatesToRemove.forEach(item => item.remove());

                    // Build a map of song idx to element (now no duplicates)
                    const elemByIdx = new Map();
                    Array.from(grid.children).forEach(item => {
                        const idx = parseInt(item.getAttribute('data-song-idx'));
                        if (!isNaN(idx)) elemByIdx.set(idx, item);
                    });



                    // Reorder: for each song in fullCorrectOrder, append to grid (moves to end in order)
                    fullCorrectOrder.forEach(song => {
                        const idx = allSongs.indexOf(song);
                        const elem = elemByIdx.get(idx);
                        if (elem) {
                            grid.appendChild(elem); // Moves to end
                        }
                    });
                }

                // Step 3b: Update display numbers for ALL items in grid
                Array.from(grid.children).forEach((item, gridPos) => {
                    const numEl = item.querySelector('.song-number');
                    if (numEl) {
                        if (isShuffleMode) {
                            // SHUFFLE MODE: Use grid position as display number
                            numEl.textContent = gridPos + 1;
                        } else {
                            // SORTED MODE: Use filteredSongs position
                            const idx = parseInt(item.getAttribute('data-song-idx'));
                            const song = allSongs[idx];
                            if (song) {
                                const correctPos = filteredSongs.indexOf(song) + 1;
                                numEl.textContent = correctPos;
                            }
                        }
                    }
                });



                // Step 4 (Last + Invert + Play): Animate
                requestAnimationFrame(() => {
                    // Animate existing items that moved
                    existingItems.forEach(item => {
                        if (!item.isConnected) return;

                        const first = firstPositions.get(item);
                        if (!first) return;

                        const last = item.getBoundingClientRect();
                        const deltaX = first.left - last.left;
                        const deltaY = first.top - last.top;

                        if (Math.abs(deltaY) > 1 || Math.abs(deltaX) > 1) {
                            item.style.transition = 'none';
                            item.style.transform = `translate(${deltaX}px, ${deltaY}px)`;

                            requestAnimationFrame(() => {
                                item.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                                item.style.transform = 'translate(0, 0)';
                            });
                        }
                    });

                    // Animate new items with pop-in effect
                    newElements.forEach((item, i) => {
                        item.style.opacity = '0';
                        item.style.transform = 'scale(0.8)';

                        setTimeout(() => {
                            item.style.transition = 'opacity 0.3s ease-out, transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1)';
                            item.style.opacity = '1';
                            item.style.transform = 'scale(1)';
                        }, 50 + i * 30);
                    });
                });

                // Update lazy state
                songsLazyState.currentIndex = grid.children.length;

                isFlipping = false;
            }

            // Update songs count display
            function updateSongsCount() {
                const subtitle = document.querySelector('.page-title .subtitle');
                if (!subtitle) return;

                const count = filteredSongs.length;

                // Get or create count span
                let countSpan = subtitle.querySelector('.count-number');
                if (!countSpan) {
                    countSpan = document.createElement('span');
                    countSpan.className = 'count-number';
                }

                // If still loading from API
                if (!songsFullyLoaded) {
                    // Show loading state with musical notes + count up
                    let loader = subtitle.querySelector('.loader-tiny');
                    if (!loader) {
                        subtitle.innerHTML = `${getTinyLoaderHTML()} <span class="count-number">0</span>`;
                        countSpan = subtitle.querySelector('.count-number');
                    }
                    subtitle.classList.add('loading-state');
                    // Animate count up
                    animateCountUp(countSpan, count, 800, '');
                } else {
                    // Loading complete - fade out loader, keep counting
                    if (subtitle.classList.contains('loading-state')) {
                        const loader = subtitle.querySelector('.loader-tiny');
                        if (loader) {
                            loader.style.transition = 'opacity 0.3s ease-out';
                            loader.style.opacity = '0';
                            setTimeout(() => loader.remove(), 300);
                        }
                        subtitle.classList.remove('loading-state');
                    }
                    // Continue count animation
                    if (!subtitle.querySelector('.count-number')) {
                        subtitle.innerHTML = `<span class="count-number">0</span>`;
                        countSpan = subtitle.querySelector('.count-number');
                    }
                    animateCountUp(subtitle.querySelector('.count-number'), count, 800, '');
                }
            }

            // Update sidebar filter button values without re-rendering
            function updateSidebarFilterValues() {
                const filterKeys = ['collection', 'chatzer', 'mechaber', 'verter', 'gezungen', 'ritem', 'scale'];
                filterKeys.forEach(key => {
                    const btn = document.querySelector(`#sidebar-dropdown-${key}`)?.previousElementSibling;
                    if (btn) {
                        const selectedCount = activeFilters[key]?.length || 0;
                        const selectedValue = selectedCount > 0 ? `(${selectedCount})` : '(אלע)';
                        const valueSpan = btn.querySelector('.sidebar-filter-value');
                        if (valueSpan) {
                            valueSpan.textContent = selectedValue;
                        }
                        if (selectedCount > 0) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    }
                });
            }

            // Render active filter tags
            function renderActiveFilterTags() {
                const container = document.getElementById('activeFilterTags');
                if (!container) return;

                let html = '';
                let hasFilters = false;
                const labels = { chatzer: 'חצר', mechaber: 'מחבר', collection: 'קאלעקשן', verter: 'ווערטער', zman: 'זמן', scale: 'סקעיל', ritem: 'ריטעם', gezungen: 'געזונגען אויף', maure: 'מאורע' };

                for (let [key, values] of Object.entries(activeFilters)) {
                    if (!Array.isArray(values)) {
                        // Handle single value (from navigateToWithFilter)
                        if (values) {
                            hasFilters = true;
                            const escapedValues = values.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            html += `
                            <div class="filter-tag">
                                ${labels[key]}: ${values}
                                <span class="filter-tag-close" onclick="removeFilter('${key}', '${escapedValues}')">&times;</span>
                            </div>
                        `;
                        }
                    } else {
                        values.forEach(value => {
                            hasFilters = true;
                            const escapedValue = value.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            html += `
                            <div class="filter-tag">
                                ${labels[key]}: ${value}
                                <span class="filter-tag-close" onclick="removeFilter('${key}', '${escapedValue}')">&times;</span>
                            </div>
                        `;
                        });
                    }
                }

                // Add clear all button if there are filters
                if (hasFilters) {
                    html += `<button class="clear-filters-btn" onclick="clearAllFilters()">🗑️ נעם אראפ אלעס</button>`;
                }

                container.innerHTML = html;
            }

            // Remove filter
            function removeFilter(key, value) {
                activeFilters[key] = activeFilters[key].filter(v => v !== value);
                applyFilters();
                renderActiveFilterTags();
            }

            // Clear all filters
            function clearAllFilters() {
                activeFilters = {
                    chatzer: [],
                    mechaber: [],
                    verter: [],
                    zman: [],
                    collection: [],
                    scale: [],
                    ritem: [],
                    gezungen: [],
                    maure: []
                };
                searchQuery = '';

                // Uncheck all filter checkboxes (sidebar)
                document.querySelectorAll('.sidebar-dropdown-content input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });

                // Uncheck all mega-menu checkboxes
                document.querySelectorAll('.filter-mega-expanded input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });

                // Check all "אלע" radio buttons
                document.querySelectorAll('.sidebar-dropdown-content input[type="radio"]').forEach(rb => {
                    rb.checked = true;
                });

                applyFilters();
                renderActiveFilterTags();
                updateMainFilterButton();
                updateMegaMenuHeaders();
            }

            // Check if any filters are active
            function hasAnyFilters() {
                if (searchQuery) return true;
                return Object.values(activeFilters).some(arr => arr.length > 0);
            }

            // Handle songs page search
            function handleSongsSearch(value) {
                searchQuery = value.trim();
                currentPage = 1;
                applyFilters();
            }

            // Expandable search functions
            function toggleExpandableSearch(event) {
                event.stopPropagation();
                const container = document.getElementById('expandableSearch');
                if (!container) return;

                if (container.classList.contains('expanded')) {
                    closeExpandableSearch();
                } else {
                    // Expanding - fade out the button first
                    const btn = container.querySelector('.search-trigger-btn');
                    if (btn) {
                        btn.style.opacity = '0';
                    }
                    container.classList.add('expanded');
                    const input = document.getElementById('expandableSearchInput');
                    if (input) {
                        setTimeout(() => input.focus(), 300);
                    }
                }
            }

            function closeExpandableSearch() {
                const container = document.getElementById('expandableSearch');
                if (container) {
                    container.classList.remove('expanded');

                    // Temporarily disable pointer-events on the settings bar to prevent
                    // immediate hover effects on underlying buttons after close
                    const settingsBar = document.querySelector('.page-settings-bar');
                    if (settingsBar) {
                        settingsBar.style.pointerEvents = 'none';
                        setTimeout(() => {
                            settingsBar.style.pointerEvents = '';
                        }, 400); // Match the collapse animation duration
                    }

                    // Update trigger button state with fade animation
                    const btn = container.querySelector('.search-trigger-btn');
                    if (btn) {
                        if (searchQuery && searchQuery.length > 0) {
                            // Update the display text and set up classes
                            const dp = btn.querySelector('.search-text-display');
                            if (dp) dp.textContent = searchQuery;
                            btn.classList.add('has-active');
                        } else {
                            btn.classList.remove('has-active');
                        }

                        // Fade in the button after a delay
                        setTimeout(() => {
                            btn.style.opacity = '1';
                        }, 250);
                    }
                }
            }

            // Clear search and collapse
            function clearSearch(event) {
                event.stopPropagation();
                searchQuery = '';
                const input = document.getElementById('expandableSearchInput');
                if (input) input.value = '';
                closeExpandableSearch();
                currentPage = 1;
                applyFilters();
                updateSongsFiltersUI();
            }

            function handleExpandableSearch(value) {
                searchQuery = value.trim();
                currentPage = 1;
                closeExpandableSearch();
                applyFilters();
            }

            // Live search with debounce
            let liveSearchTimeout = null;
            function handleLiveSearch(value) {
                if (liveSearchTimeout) {
                    clearTimeout(liveSearchTimeout);
                }
                liveSearchTimeout = setTimeout(() => {
                    searchQuery = value.trim();
                    currentPage = 1;
                    applyFilters();
                }, 200);
            }

            // Close expandable search when clicking outside
            document.addEventListener('click', function (event) {
                const container = document.getElementById('expandableSearch');
                if (container && container.classList.contains('expanded')) {
                    if (!container.contains(event.target)) {
                        closeExpandableSearch();
                    }
                }
            });


            // Current detail view
            let currentDetailView = null; // { type: 'mechaber', name: 'xxx' }

            // URL Routing
            function updateURL() {
                let hash = '';

                if (currentDetailView) {
                    // Detail page URL: #/mechabrim/123
                    // Prefer customId (simple number), then name (no rowId in URLs)
                    const id = currentDetailView.customId || currentDetailView.name;
                    hash = `#/${currentDetailView.type}/${encodeURIComponent(id)}`;
                } else if (currentPageView === 'search' && searchQuery) {
                    // Search page URL: #/search/קדיש
                    hash = `#/search/${encodeURIComponent(searchQuery)}`;
                } else {
                    // Category page URL: #/mechabrim or #/home
                    // Map internal 'songs' to external 'nigunim' URL
                    const urlPage = currentPageView === 'songs' ? 'nigunim' : currentPageView;
                    hash = `#/${urlPage}`;
                }

                // Update URL without triggering hashchange
                if (window.location.hash !== hash) {
                    history.pushState(null, '', hash);
                }
            }

            // Helper function to find item by ID or name
            function findItemByIdOrName(type, idOrName) {
                // Get the appropriate info object
                let infoObj = {};
                switch (type) {
                    case 'chatzeros': infoObj = chatzerosInfo; break;
                    case 'mechabrim': infoObj = mechabrimInfo; break;
                    case 'verter': infoObj = verterInfo; break;
                    case 'zmanim':
                    case 'zman': infoObj = zmaninInfo; break;
                    case 'piyutim': infoObj = piyutimInfo; break;
                    case 'collections': infoObj = collectionsInfo; break;
                    case 'albums': infoObj = albumsInfo; break;
                    case 'documents': infoObj = documentsInfo; break;
                    case 'resources': infoObj = resourcesInfo; break;
                    case 'nigunim':
                        // For nigunim, search in allSongs
                        const song = allSongs.find(s => s.customId === idOrName || s.rowId === idOrName || s.name === idOrName);
                        return song ? { name: song.name, id: song.rowId, customId: song.customId } : null;
                }

                // First try to find by customId (simple number)
                for (const [name, info] of Object.entries(infoObj)) {
                    if (info.customId === idOrName) {
                        return { name, id: info.rowId, customId: info.customId };
                    }
                }

                // Then try to find by rowId
                for (const [name, info] of Object.entries(infoObj)) {
                    if (info.rowId === idOrName) {
                        return { name, id: info.rowId, customId: info.customId };
                    }
                }

                // Fallback to finding by name (for backwards compatibility)
                if (infoObj[idOrName]) {
                    return { name: idOrName, id: infoObj[idOrName].rowId, customId: infoObj[idOrName].customId };
                }

                return null;
            }

            // Track last handled hash to prevent duplicate processing
            let lastHandledHash = '';
            let lastHandledTime = 0;

            // Parse URL and navigate - with lazy loading
            async function handleURLChange() {
                const hash = window.location.hash || '#/home';
                const now = Date.now();

                // Debounce: skip if same hash was handled within 500ms
                if (hash === lastHandledHash && (now - lastHandledTime) < 500) {
                    console.log('⏭️ Skipping duplicate handleURLChange for:', hash);
                    return;
                }
                lastHandledHash = hash;
                lastHandledTime = now;

                console.log('handleURLChange called with hash:', hash);

                // Check for /preview suffix (modal mode)
                const isPreviewMode = hash.includes('/preview');
                const cleanHash = hash.replace('/preview', '');

                const parts = cleanHash.substring(2).split('/'); // Remove #/ and split

                const page = parts[0] || 'home';
                let idOrName = parts[1] ? decodeURIComponent(parts[1]) : null;
                console.log('Parsed URL - page:', page, 'idOrName:', idOrName, 'isPreviewMode:', isPreviewMode);

                // Valid pages (including info pages)
                const validPages = ['home', 'nigunim', 'chatzeros', 'mechabrim', 'verter', 'zmanim', 'piyutim', 'collections', 'albums', 'documents', 'resources', 'zman', 'search', 'music', 'about', 'instructions', 'credits', 'thanks', 'terms', 'stats', 'contribute'];

                // Info pages that don't need data loading
                const infoPagesList = ['about', 'instructions', 'credits', 'thanks', 'terms', 'stats', 'contribute'];

                if (validPages.includes(page)) {
                    const content = document.getElementById('mainContent');
                    const previousPage = currentPageView;
                    const wasHomePage = previousPage === 'home';
                    const wasInfoPage = infoPagesList.includes(previousPage);
                    const isHomePage = page === 'home';
                    const isInfoPage = infoPagesList.includes(page);

                    // Map to internal page name for direction calculation
                    const targetPage = page === 'nigunim' ? 'songs' : (page === 'zman' ? 'zmanim' : page);
                    const direction = getNavigationDirection(previousPage, targetPage);

                    // Determine exit animation class
                    let exitClass;
                    if (wasHomePage) {
                        exitClass = 'page-exit-home';
                    } else if (wasInfoPage) {
                        exitClass = 'page-exit-info';
                    } else {
                        exitClass = direction === 'forward' ? 'page-exit' : 'page-exit-back';
                    }

                    // Apply exit animation (only if there's existing content)
                    if (content && content.children.length > 0 && previousPage !== targetPage) {
                        content.classList.add(exitClass);
                        await new Promise(r => setTimeout(r, wasInfoPage ? 150 : 200));
                        content.classList.remove(exitClass);
                    }

                    // Handle info pages - they don't need data loading
                    if (isInfoPage) {
                        currentPageView = page;
                        currentDetailView = null;
                        renderCurrentPage();

                        // Enter animation for info pages
                        if (content) {
                            content.classList.add('page-enter-info');
                            setTimeout(() => content.classList.remove('page-enter-info'), 300);
                        }

                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        return;
                    }

                    // Track if we're showing skeleton (data isn't loaded yet)
                    const hadSkeleton = targetPage !== 'home' && !isDataLoadedForPage(targetPage);

                    // Show skeleton loader if data not loaded
                    // For songs: don't await, let background fetch populate the grid
                    if (hadSkeleton) {
                        if (targetPage === 'songs') {
                            // Songs: start loading in background, don't await
                            // The page will show skeleton, and fetchSongsInBackground will update the grid
                            ensureDataForPage(targetPage); // No await!
                        } else {
                            // Other pages: show skeleton and await
                            if (content) {
                                content.innerHTML = getSkeletonForPage(targetPage);
                            }
                            await ensureDataForPage(targetPage);
                        }
                    }

                    if (page === 'search' && idOrName) {
                        // Search results page
                        searchQuery = idOrName;
                        currentPageView = 'search';
                        currentDetailView = null;

                        // Update search input
                        const searchInput = document.getElementById('globalSearch');
                        if (searchInput) searchInput.value = idOrName;

                        // Show loading indicator and ensure data is loaded for search
                        if (!isDataLoadedForPage('search')) {
                            const content = document.getElementById('mainContent');
                            if (content) {
                                content.innerHTML = `
                                <div class="detail-loading-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; gap: 20px;">
                                    <div class="loading-wave-bar"></div>
                                    <p style="color: var(--text-secondary); font-size: 14px;">לאָדן...</p>
                                </div>
                            `;
                            }
                            await ensureDataForPage('search');
                        }

                        renderCurrentPage();
                    } else if (idOrName) {
                        // Detail pages that need data loaded
                        const detailPages = ['mechabrim', 'chatzeros', 'verter', 'zmanim', 'piyutim', 'zman', 'collections', 'albums', 'documents', 'resources', 'nigunim'];
                        const dataPage = page === 'zman' ? 'zmanim' : (page === 'piyutim' ? 'piyutim' : (page === 'nigunim' ? 'songs' : page));

                        // Show loading indicator and ensure data is loaded for detail pages
                        // For nigunim: use direct API fetch if song not in index yet
                        const needsLoading = page === 'nigunim'
                            ? (!loadedCategories.songs || !allSongs.some(s => s.customId === idOrName || s.rowId === idOrName || s.name === idOrName))
                            : !isDataLoadedForPage(dataPage);
                        if (detailPages.includes(page) && needsLoading) {
                            if (page === 'nigunim') {
                                // For nigunim: try direct API fetch first (fast)
                                // Don't wait for full index if we can fetch this specific song
                                await handleDirectSongLink(idOrName);
                                return;
                            }
                            if (content) {
                                content.innerHTML = `
                                <div class="detail-loading-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; gap: 20px;">
                                    <div class="loading-wave-bar"></div>
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                                        ${getMediumLoaderHTML()}
                                        <p style="color: var(--text-secondary); font-size: 16px; margin: 0;">לאודינג...</p>
                                    </div>
                                </div>
                            `;
                            }
                            await ensureDataForPage(dataPage);
                        }

                        // Find item by ID or name
                        const item = findItemByIdOrName(page, idOrName);
                        console.log('Found item:', item);

                        // Redirect to proper numeric ID URL if we found the item
                        const isNumericId = /^\d+$/.test(idOrName);
                        if (!isNumericId && item?.customId) {
                            const newHash = `#/${page}/${item.customId}`;
                            history.replaceState(null, '', newHash);
                        }

                        const itemName = item?.name || idOrName;
                        const itemId = item?.id || idOrName;
                        const itemCustomId = item?.customId;

                        // Navigate to detail page
                        if (page === 'zman') {
                            // Zman detail page (shows piyutim and collections for a zman)
                            currentPageView = 'zmanim';
                            currentDetailView = { type: 'zman', name: itemName, id: itemId, customId: itemCustomId };
                        } else if (page === 'nigunim') {
                            // Nigun detail page (nigunim/1 format)
                            if (isPreviewMode) {
                                // Preview mode: open as modal
                                const songIdx = allSongs.findIndex(s =>
                                    s.customId === idOrName || s.rowId === idOrName || s.name === itemName
                                );
                                if (songIdx !== -1) {
                                    // Don't push to history since we're already at this URL
                                    nigunModalOpen = true;
                                    currentNigunModalIdx = songIdx;
                                    const modalBody = document.getElementById('nigunModalBody');
                                    renderNigunDetailInModal(modalBody, allSongs[songIdx].name, songIdx);
                                    const overlay = document.getElementById('nigunModalOverlay');
                                    modalZIndexCounter++;
                                    overlay.style.zIndex = modalZIndexCounter;
                                    modalStack.push({ type: 'nigun', zIndex: modalZIndexCounter, idx: songIdx });
                                    overlay.classList.add('active');
                                    document.body.style.overflow = 'hidden';
                                }
                                return; // Don't render full page
                            }
                            currentPageView = 'songs';
                            currentDetailView = { type: 'nigunim', name: itemName, id: itemId, customId: itemCustomId };
                        } else {
                            // Other detail pages (mechabrim, chatzeros, etc.)
                            if (isPreviewMode) {
                                // Preview mode: open as modal (skip history since we're already at this URL)
                                openDetailModal(page, itemName, true);
                                return; // Don't render full page - modal handles it
                            }
                            currentPageView = page;
                            currentDetailView = { type: page, name: itemName, id: itemId, customId: itemCustomId };
                        }

                        // Update nav buttons
                        document.querySelectorAll('.nav-btn').forEach(btn => {
                            const btnPage = btn.dataset.page;
                            const activePage = page === 'zman' ? 'zmanim' : (page === 'nigunim' ? 'songs' : page);
                            btn.classList.toggle('active', btnPage === activePage);
                        });

                        renderDetailPage();
                    } else {
                        // Navigate to category page
                        currentDetailView = null;
                        // Map URL 'nigunim' to internal 'songs' page
                        currentPageView = page === 'nigunim' ? 'songs' : page;
                        currentPage = 1;

                        // Update nav buttons
                        document.querySelectorAll('.nav-btn').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.page === page);
                        });

                        renderCurrentPage();
                    }

                    // Determine enter animation class
                    // Skip animation for certain pages
                    const categoryPages = ['chatzeros', 'mechabrim', 'verter', 'zmanim', 'collections', 'resources', 'documents', 'albums'];
                    const isCategoryPage = categoryPages.includes(targetPage);

                    let enterClass;
                    if (hadSkeleton) {
                        enterClass = null; // Coming from skeleton - no page animation needed
                    } else if (isHomePage) {
                        enterClass = null; // Home page uses its own stagger animation
                    } else if (isCategoryPage) {
                        enterClass = null; // Category pages use card animations, no page fade
                    } else {
                        // Content pages (including songs): direction-aware
                        enterClass = direction === 'forward' ? 'page-enter' : 'page-enter-back';
                    }

                    // Apply enter animation
                    if (content && enterClass) {
                        content.classList.add(enterClass);
                        setTimeout(() => content.classList.remove(enterClass), 350);
                    }

                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }

            // NOTE: popstate listener is now in the nigun modal section to handle modal closing

            // Listen to hash changes (from anchor link clicks)
            // Note: We use a separate flag for hashchange since popstate and hashchange
            // can both fire when history.back() is called
            let skipNextHashChange = false;

            window.addEventListener('hashchange', function () {
                if (skipNextHashChange) {
                    skipNextHashChange = false;
                    return;
                }
                hideAllDropdowns();
                handleURLChange();
            });

            // Navigate to detail page - opens in modal popup
            async function navigateToDetail(categoryKey, name, id = null) {
                const dataPage = categoryKey === 'zman' ? 'zmanim' : categoryKey;

                // Ensure data is loaded first
                if (!isDataLoadedForPage(dataPage)) {
                    await ensureDataForPage(dataPage);
                }

                // Get info object for this category
                let infoObj = {};
                switch (categoryKey) {
                    case 'chatzeros': infoObj = chatzerosInfo; break;
                    case 'mechabrim': infoObj = mechabrimInfo; break;
                    case 'verter': infoObj = verterInfo; break;
                    case 'zmanim': infoObj = zmaninInfo; break;
                    case 'piyutim': infoObj = piyutimInfo; break;
                    case 'collections': infoObj = collectionsInfo; break;
                    case 'albums': infoObj = albumsInfo; break;
                    case 'documents': infoObj = documentsInfo; break;
                    case 'resources': infoObj = resourcesInfo; break;
                }

                // Open in modal popup
                openDetailModal(categoryKey, name);
            }

            // Toggle description expand/collapse
            function toggleDescriptionExpand(btn) {
                const wrapper = btn.parentElement.querySelector('.detail-description-wrapper');
                const isExpanded = wrapper.classList.contains('expanded');

                if (isExpanded) {
                    wrapper.classList.remove('expanded');
                    wrapper.classList.add('collapsed');
                    btn.classList.remove('expanded');
                } else {
                    wrapper.classList.remove('collapsed');
                    wrapper.classList.add('expanded');
                    btn.classList.add('expanded');
                }
            }

            // Toggle verter expand/collapse
            function toggleVerterExpand(btn) {
                const wrapper = btn.parentElement.querySelector('.verter-wrapper');
                const isExpanded = wrapper.classList.contains('expanded');

                if (isExpanded) {
                    wrapper.classList.remove('expanded');
                    wrapper.classList.add('collapsed');
                    btn.classList.remove('expanded');
                } else {
                    wrapper.classList.remove('collapsed');
                    wrapper.classList.add('expanded');
                    btn.classList.add('expanded');
                }
            }

            // Toggle songs list expand/collapse
            function toggleSongsExpand(btn) {
                const container = btn.closest('.songs-section-container');
                const wrapper = container.querySelector('.songs-list-wrapper');
                const isExpanded = wrapper.classList.contains('expanded');

                if (isExpanded) {
                    wrapper.classList.remove('expanded');
                    wrapper.classList.add('collapsed');
                    btn.classList.remove('expanded');
                } else {
                    wrapper.classList.remove('collapsed');
                    wrapper.classList.add('expanded');
                    btn.classList.add('expanded');
                }
            }

            // Initialize collapsible sections - hide expand button if content is short
            function initCollapsibleSections() {
                // Check description sections
                document.querySelectorAll('.detail-description-wrapper.collapsed').forEach(wrapper => {
                    const content = wrapper.querySelector('.detail-description-content');
                    const btn = wrapper.parentElement.querySelector('.description-expand-btn');
                    const overlay = wrapper.querySelector('.description-fade-overlay');

                    if (content && btn) {
                        // Check if content height is less than max-height (120px)
                        const contentHeight = content.scrollHeight;
                        if (contentHeight <= 120) {
                            btn.style.display = 'none';
                            if (overlay) overlay.style.display = 'none';
                            wrapper.classList.remove('collapsed');
                            wrapper.classList.add('expanded');
                        }
                    }
                });
            }

            // Go back from detail page
            function goBackFromDetail() {
                const page = currentDetailView?.type || 'home';
                currentDetailView = null;

                // Map category key to page name
                const pageMap = {
                    'chatzeros': 'chatzeros',
                    'mechabrim': 'mechabrim',
                    'verter': 'verter',
                    'zmanim': 'zmanim',
                    'piyutim': 'piyutim',
                    'collections': 'collections',
                    'albums': 'albums',
                    'documents': 'documents',
                    'resources': 'resources'
                };

                navigateTo(pageMap[page] || 'home');
            }

            // Render detail page for a specific item
            async function renderDetailPage() {
                console.log('renderDetailPage called, currentDetailView:', currentDetailView);

                const { type, name } = currentDetailView;
                const container = document.getElementById('mainContent');

                // Handle zman detail page separately
                if (type === 'zman') {
                    renderZmanDetailPage(container, name);
                    return;
                }

                // Handle nigun detail page separately
                if (type === 'nigunim') {
                    // Wait for related data to load so links have proper IDs
                    const dataPromises = [];
                    if (!loadedCategories.chatzeros) {
                        dataPromises.push(fetchChatzerosInfo().then(() => loadedCategories.chatzeros = true));
                    }
                    if (!loadedCategories.mechabrim) {
                        dataPromises.push(fetchMechabrimInfo().then(() => loadedCategories.mechabrim = true));
                    }
                    if (!loadedCategories.verter) {
                        dataPromises.push(fetchVerterInfo().then(() => loadedCategories.verter = true));
                    }
                    if (!loadedCategories.albums) {
                        dataPromises.push(fetchAlbumsInfo().then(() => loadedCategories.albums = true));
                    }
                    if (dataPromises.length > 0) {
                        await Promise.all(dataPromises);
                    }
                    await renderNigunDetailPage(container, name);
                    return;
                }

                // Handle album detail page separately
                if (type === 'albums') {
                    renderAlbumDetailPage(container, name);
                    return;
                }

                // Handle document detail page separately
                if (type === 'documents') {
                    renderDocumentDetailPage(container, name);
                    return;
                }

                // Handle resource detail page separately
                if (type === 'resources') {
                    renderResourceDetailPage(container, name);
                    return;
                }

                // Get info and songs for this item
                let infoObj = {};
                let icon = '';
                let typeName = '';

                switch (type) {
                    case 'chatzeros':
                        infoObj = chatzerosInfo;
                        icon = '';
                        typeName = 'חצר';
                        break;
                    case 'mechabrim':
                        infoObj = mechabrimInfo;
                        icon = '';
                        typeName = 'מחבר';
                        break;
                    case 'verter':
                        infoObj = verterInfo;
                        icon = '';
                        typeName = 'ווערטער';
                        break;
                    case 'zmanim':
                        infoObj = zmaninInfo;
                        icon = '';
                        typeName = 'זמן';
                        break;
                    case 'piyutim':
                        infoObj = piyutimInfo;
                        icon = '';
                        typeName = 'פיוט';
                        break;
                    case 'collections':
                        infoObj = collectionsInfo;
                        icon = '';
                        typeName = 'קאלעקשן';
                        break;
                    case 'albums':
                        infoObj = albumsInfo;
                        icon = '';
                        typeName = 'אלבום';
                        break;
                    case 'documents':
                        infoObj = documentsInfo;
                        icon = '';
                        typeName = 'דאקומענט';
                        break;
                    case 'resources':
                        infoObj = resourcesInfo;
                        icon = '';
                        typeName = 'רעסורס';
                        break;
                }

                // Use findEntityByNameOrId to resolve the actual entity key (handles customId lookup)
                const { key: entityKey, info } = findEntityByNameOrId(infoObj, name);

                // For piyutim, use linked nigunim from the piyutim table
                let songs;
                let songIndices = []; // Declare at top level for use in mechabrim filtering
                if (type === 'piyutim') {
                    const linkedNigunim = new Set(info?.nigunim || []);
                    songs = allSongs.filter(song => linkedNigunim.has(song.codaRowName));
                } else {
                    const categoryKey = type;
                    songIndices = categories[categoryKey]?.[entityKey] || [];
                    songs = songIndices.map(idx => allSongs[idx]).filter(Boolean);
                }
                // Always sort alphabetically for detail pages
                songs = songs.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'he'));

                // For mechabrim: find songs where name appears in personalities field
                let personalitySongs = [];
                let personalityRecordings = [];
                if (type === 'mechabrim') {
                    // Songs where mechaber is in personalities field (but not already in mechaber field)
                    const songIndicesSet = new Set(songIndices);
                    personalitySongs = allSongs.filter((song, idx) => {
                        if (songIndicesSet.has(idx)) return false; // Exclude already-shown mechaber songs
                        if (!song.personalities) return false;
                        return song.personalities.split(',').map(p => p.trim()).includes(entityKey);
                    });
                    personalitySongs = personalitySongs.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'he'));

                    // Recordings where mechaber is in personalities field
                    allSongs.forEach((song, songIdx) => {
                        if (song.recordings && Array.isArray(song.recordings)) {
                            song.recordings.forEach((rec, recIdx) => {
                                if (rec.personalities) {
                                    const recPersonalities = rec.personalities.split(',').map(p => p.trim());
                                    if (recPersonalities.includes(entityKey)) {
                                        personalityRecordings.push({ song, songIdx, recording: rec, recIdx });
                                    }
                                }
                            });
                        }
                    });
                }

                // Only show chatzer tags for mechabrim
                const chatzeros = (type === 'mechabrim' && info.chatzer)
                    ? info.chatzer.split(',').map(c => c.trim()).filter(Boolean)
                    : [];

                // For mechabrim, build tag name badge, full name, and life dates
                let mechaberTagName = '';
                let mechaberFullName = name; // default to the item name
                let mechaberLifeDates = '';

                if (type === 'mechabrim') {
                    // Build name for profile page:
                    // If גערופן exists: formal name (small) + known name (big)
                    // If גערופן is empty: just show formal name with suffix
                    const formalParts = [info.title, info.firstName, info.lastName].filter(Boolean);
                    const formalName = formalParts.length > 0 ? formalParts.join(' ') : '';

                    if (info.gerufen) {
                        // Has גערופן - show two lines: formal (small) + known (big)
                        const knownParts = [info.gerufen, info.platz, info.suffix].filter(Boolean);
                        const knownName = knownParts.join(' ');
                        mechaberFullName = `<span class="mechaber-formal">${formalName}</span><span class="mechaber-known">${knownName}</span>`;
                    } else {
                        // No גערופן - show formal name with suffix in one line
                        const fullNameParts = [info.title, info.firstName, info.lastName, info.platz, info.suffix].filter(Boolean);
                        mechaberFullName = fullNameParts.length > 0 ? fullNameParts.join(' ') : name;
                    }

                    // Tag name is from טעג נאמען column - show only if different
                    if (info.tagName && info.tagName !== mechaberFullName && info.tagName !== formalName) {
                        mechaberTagName = info.tagName;
                    }

                    // Build life dates string (like: י' אייר ה'תרל"ד - ד' אב ה'תש"ד)
                    const birthParts = [info.birthDay, info.birthMonth, info.birthYear].filter(Boolean);
                    const deathParts = [info.deathDay, info.deathMonth, info.deathYear].filter(Boolean);
                    const birthStr = birthParts.length > 0 ? birthParts.join(' ') : '';
                    const deathStr = deathParts.length > 0 ? deathParts.join(' ') : '';

                    if (birthStr || deathStr) {
                        if (birthStr && deathStr) {
                            mechaberLifeDates = `${birthStr} - ${deathStr}`;
                        } else if (birthStr) {
                            mechaberLifeDates = `נולד: ${birthStr}`;
                        } else if (deathStr) {
                            mechaberLifeDates = `נפטר: ${deathStr}`;
                        }
                    }
                }

                // For chatzeros, find all mechabrim that belong to this chatzer
                let mechabrimFromChatzer = [];
                if (type === 'chatzeros') {
                    mechabrimFromChatzer = Object.entries(mechabrimInfo)
                        .filter(([mechName, mechInfo]) => {
                            if (!mechInfo.chatzer) return false;
                            const mechChatzeros = mechInfo.chatzer.split(',').map(c => c.trim());
                            return mechChatzeros.includes(name);
                        })
                        .map(([mechName, mechInfo]) => ({
                            name: mechName,
                            tagName: mechInfo.tagName || mechName, // Use tagName for display
                            image: mechInfo.image,
                            id: mechInfo.customId || mechName,
                            description: mechInfo.description,
                            birthYear: mechInfo.birthYear ? parseInt(mechInfo.birthYear) : null,
                            deathYear: mechInfo.deathYear ? parseInt(mechInfo.deathYear) : null
                        }))
                        .sort((a, b) => {
                            // Sort by birth year first, then death year
                            // Use birth year if available, otherwise death year
                            const yearA = a.birthYear || a.deathYear || 9999;
                            const yearB = b.birthYear || b.deathYear || 9999;
                            return yearA - yearB;
                        });
                }

                // For chatzeros, get albums and documents
                let chatzerAlbums = [];
                let chatzerDocuments = [];
                if (type === 'chatzeros') {
                    chatzerAlbums = info.albums || [];
                    chatzerDocuments = info.documents || [];
                }

                // For verter, get the lyrics text
                let verterText = '';
                if (type === 'verter') {
                    // Use fullText field first, then description
                    if (info.fullText) {
                        verterText = info.fullText;
                    } else if (info.description) {
                        verterText = info.description;
                    }
                }

                // For verter, get makor and mareh makom
                const verterMakor = (type === 'verter' && info.makor) ? info.makor : '';
                const verterMarehMakom = (type === 'verter' && info.marehMakom) ? info.marehMakom : '';

                // For piyutim, get zmanim (array)
                const piyutZmanim = (type === 'piyutim' && piyutimInfo[name]?.zmanim) ? piyutimInfo[name].zmanim : [];

                // Map type to theme class
                const themeMap = {
                    'chatzeros': 'theme-chatzer',
                    'mechabrim': 'theme-mechaber',
                    'verter': 'theme-verter',
                    'zmanim': 'theme-zman',
                    'piyutim': 'theme-piyut',
                    'collections': 'theme-collection'
                };
                const themeClass = themeMap[type] || '';

                // Plural names for back button
                const pluralNameMap = {
                    'chatzeros': 'חצרות',
                    'mechabrim': 'מחברים',
                    'verter': 'ווערטער',
                    'zmanim': 'זמנים',
                    'piyutim': 'פיוטים',
                    'collections': 'קאלעקשאנס',
                    'albums': 'אלבומס',
                    'documents': 'דאקומענטן',
                    'resources': 'רעסורסן'
                };
                const pluralName = pluralNameMap[type] || typeName;

                container.innerHTML = `
                <div class="detail-page ${themeClass}" data-type="${type}">
                    <button class="back-button" onclick="goBackFromDetail()">
                        → ${pluralName}
                    </button>
                    
                    <div class="detail-header">
                        <div class="detail-category-bar">${typeName}</div>
                        <div class="detail-header-content ${(info.image || type === 'mechabrim') ? '' : 'no-image'}">
                            <button class="play-all-btn" title="שפיל אלע" onclick="event.stopPropagation(); playAllFromDetailPage('${type}', '${escapeHtml(name).replace(/'/g, "\\'")}')" data-detail-type="${type}" data-detail-name="${escapeHtml(name)}">
                                <svg class="play-icon" viewBox="0 0 24 24"><path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/></svg>
                                <svg class="pause-icon" style="display:none" viewBox="0 0 24 24"><path d="M9 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zM13 7v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"/></svg>
                            </button>
                            <div class="detail-header-left">
                                ${info.image ? `
                                    <img class="detail-image" src="${info.image}" alt="${name}">
                                ` : (type === 'mechabrim' ? `
                                    <div class="detail-image-placeholder"><div class="mechaber-icon"></div></div>
                                ` : '')}
                                ${mechaberLifeDates ? `
                                    <div class="detail-life-dates">
                                        ${mechaberLifeDates}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="detail-header-text">
                                <h1 class="detail-title">${type === 'mechabrim' ? mechaberFullName : name}</h1>
                                ${chatzeros.length > 0 ? `
                                    <div class="detail-badges">
                                        ${chatzeros.map(chatzer => `
                                            <span class="detail-chatzer-badge"
                                                  data-action="detail"
                                                  data-category="chatzeros"
                                                  data-name="${escapeHtml(chatzer)}"
                                                  data-tooltip-value="${escapeHtml(chatzer)}"
                                                  data-tooltip-type="chatzer"
                                                  style="cursor:pointer;">${chatzer}</span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                ${(verterMakor || verterMarehMakom) ? `
                                    <div class="detail-subtitle">
                                        ${verterMakor ? `<span class="detail-makor-text">${formatDescription(verterMakor)}</span>` : ''}
                                        ${(verterMakor && verterMarehMakom) ? '<span class="detail-separator">•</span>' : ''}
                                        ${verterMarehMakom ? `<span class="detail-mareh-text">${formatDescription(verterMarehMakom)}</span>` : ''}
                                    </div>
                                ` : ''}
                                ${piyutZmanim.length > 0 ? `
                                    <div class="detail-badges">
                                        ${piyutZmanim.map(zman => `
                                            <span class="detail-zman-badge"
                                                  data-action="zman-detail"
                                                  data-name="${escapeHtml(zman)}"
                                                  data-tooltip-value="${escapeHtml(zman)}"
                                                  data-tooltip-type="zman"
                                                  style="cursor:pointer;">${zman}</span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                ${(type === 'collections' && info.zmanim && info.zmanim.length > 0) ? `
                                    <div class="detail-zmanim-badges">
                                        ${info.zmanim.map(zman => `
                                            <span class="detail-zman-badge"
                                                  data-action="zman-detail"
                                                  data-name="${escapeHtml(zman)}"
                                                  style="cursor:pointer;">${zman}</span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${info.description ? `
                        <div class="detail-description-section collapsible-section">
                            <h3>דעטאלן</h3>
                            <div class="detail-description-wrapper collapsed">
                                <div class="detail-description-content">${formatDescription(info.description)}</div>
                                <div class="description-fade-overlay"></div>
                            </div>
                            <button class="description-expand-btn" onclick="toggleDescriptionExpand(this)">
                                <span class="expand-arrow"></span>
                            </button>
                        </div>
                    ` : ''}
                    
                    ${mechabrimFromChatzer.length > 0 ? `
                        <div class="detail-mechabrim-section">
                            <div class="detail-mechabrim-box">
                                <div class="detail-mechabrim-header">${mechabrimFromChatzer.length} מחברים</div>
                                <div class="nigun-mechaber-grid">
                                    ${mechabrimFromChatzer.map(mech => `
                                        <a class="nigun-mechaber-card" href="#/mechabrim/${encodeURIComponent(mech.id)}" data-action="detail" data-category="mechabrim" data-name="${escapeHtml(mech.name)}">
                                            ${mech.image
                        ? `<img class="nigun-mechaber-image" src="${mech.image}" alt="${mech.name}">`
                        : `<div class="nigun-mechaber-placeholder"><div class="mechaber-icon"></div></div>`
                    }
                                            <div class="nigun-mechaber-name">${mech.tagName}</div>
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${(type === 'chatzeros' && (chatzerAlbums.length > 0 || chatzerDocuments.length > 0)) ? `
                        ${chatzerAlbums.length > 0 ? `
                            <div class="detail-albums-section">
                                <div class="detail-section-header">
                                    <h3>${chatzerAlbums.length} אלבומס</h3>
                                </div>
                                <div class="nigun-mechaber-grid">
                                    ${chatzerAlbums.sort((a, b) => a.localeCompare(b, 'he')).map(albumName => {
                                        const albInfo = albumsInfo[albumName] || {};
                                        const albId = albInfo.customId || albumName;
                                        const coverUrl = albInfo.cover || albInfo.image;
                                        return `
                                            <a class="nigun-mechaber-card" href="#/albums/${encodeURIComponent(albId)}" data-action="detail" data-category="albums" data-name="${escapeHtml(albumName)}">
                                                ${coverUrl
                                                    ? `<img class="nigun-mechaber-image" src="${coverUrl}" alt="${albumName}">`
                                                    : `<div class="nigun-mechaber-placeholder"><div class="album-icon"></div></div>`
                                                }
                                                <div class="nigun-mechaber-name">${albumName}</div>
                                            </a>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${chatzerDocuments.length > 0 ? `
                            <div class="detail-documents-section">
                                <div class="detail-section-header">
                                    <h3>${chatzerDocuments.length} דאקומענטן</h3>
                                </div>
                                <div class="nigun-mechaber-grid">
                                    ${chatzerDocuments.sort((a, b) => a.localeCompare(b, 'he')).map(docName => {
                                        const docInfo = documentsInfo[docName] || {};
                                        const docId = docInfo.customId || docName;
                                        return `
                                            <a class="nigun-mechaber-card" href="#/documents/${encodeURIComponent(docId)}" data-action="detail" data-category="documents" data-name="${escapeHtml(docName)}">
                                                <div class="nigun-mechaber-placeholder"><div class="document-icon"></div></div>
                                                <div class="nigun-mechaber-name">${docName}</div>
                                            </a>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    ` : ''}

                    ${(type === 'verter' && verterText) ? `
                        <div class="detail-verter-section">
                            <span class="verter-box-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h6v6h6v10H6zm2-6h8v2H8v-2zm0-4h8v2H8v-2z"/>
                                </svg>
                            </span>
                            <div class="verter-wrapper collapsed">
                                <div class="verter-content">${formatVerter(verterText)}</div>
                                <div class="verter-fade-overlay"></div>
                            </div>
                            <button class="verter-expand-btn" onclick="toggleVerterExpand(this)">
                                <span class="expand-arrow"></span>
                            </button>
                        </div>
                    ` : ''}
                    
                    ${(() => {
                        // Check if there are additional sections below this one
                        const hasMoreSections = (type === 'mechabrim' && (personalitySongs.length > 0 || personalityRecordings.length > 0));
                        // Only show collapse/expand if there are more sections AND more than 5 songs
                        const shouldCollapse = hasMoreSections && songs.length > 5;

                        return `
                    <div class="detail-songs-section">
                        <div class="detail-section-header">
                            <h3>${type === 'mechabrim' ? 'מחבר געווען ' : ''}${songs.length} ניגונים</h3>
                        </div>
                        ${shouldCollapse ? `
                            <div class="songs-section-container">
                                <div class="songs-list-wrapper collapsed">
                                    <div class="detail-songs-list">
                                        ${(() => {
                                    const playlistIndices = songs.map(song => allSongs.indexOf(song));
                                    return songs.map((song, i) => {
                                        const globalIdx = allSongs.indexOf(song);
                                        return renderSongItem(song, globalIdx, i + 1, playlistIndices, { hideMechaber: type === 'mechabrim', forceMinimal: true });
                                    }).join('');
                                })()}
                                    </div>
                                    <div class="songs-fade-overlay"></div>
                                </div>
                                <button class="songs-expand-btn" onclick="toggleSongsExpand(this)">
                                    <span class="expand-arrow"></span>
                                </button>
                            </div>
                        ` : `
                            <div class="detail-songs-list">
                                ${(() => {
                                const playlistIndices = songs.map(song => allSongs.indexOf(song));
                                return songs.map((song, i) => {
                                    const globalIdx = allSongs.indexOf(song);
                                    return renderSongItem(song, globalIdx, i + 1, playlistIndices, { hideMechaber: type === 'mechabrim', forceMinimal: true });
                                }).join('');
                            })()}
                            </div>
                        `}
                    </div>`;
                    })()}
                    
                    ${(() => {
                        // For mechabrim, show songs where they have a שייכות (personality)
                        if (type === 'mechabrim' && personalitySongs.length > 0) {
                            const playlistIndices = personalitySongs.map(song => allSongs.indexOf(song));
                            // Only collapse if there are more sections after this AND more than 5 items
                            const hasMoreSections = personalityRecordings.length > 0;
                            const isCollapsible = hasMoreSections && personalitySongs.length > 5;
                            return `
                                <div class="detail-songs-section detail-related-songs ${isCollapsible ? 'collapsible-songs' : ''}">
                                    <div class="detail-section-header">
                                        <h3>געהאט שייכות מיט ${personalitySongs.length} ניגונים</h3>
                                    </div>
                                    ${isCollapsible ? `
                                        <div class="songs-section-container">
                                            <div class="songs-list-wrapper collapsed">
                                                <div class="detail-songs-list">
                                                    ${personalitySongs.map((song, i) => {
                                const globalIdx = allSongs.indexOf(song);
                                return renderSongItem(song, globalIdx, i + 1, playlistIndices, { forceMinimal: true });
                            }).join('')}
                                                </div>
                                                <div class="songs-fade-overlay"></div>
                                            </div>
                                            <button class="songs-expand-btn" onclick="toggleSongsExpand(this)">
                                                <span class="expand-arrow"></span>
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="detail-songs-list">
                                            ${personalitySongs.map((song, i) => {
                                const globalIdx = allSongs.indexOf(song);
                                return renderSongItem(song, globalIdx, i + 1, playlistIndices, { forceMinimal: true });
                            }).join('')}
                                        </div>
                                    `}
                                </div>
                            `;
                        }
                        return '';
                    })()}
                    
                    ${(() => {
                        // For mechabrim, show recordings where they appear in personalities
                        // This is always the last section, so never collapse it
                        if (type === 'mechabrim' && personalityRecordings.length > 0) {
                            return `
                                <div class="detail-songs-section detail-related-recordings">
                                    <div class="detail-section-header">
                                        <h3>רעקארדירט ${personalityRecordings.length} ניגונים</h3>
                                    </div>
                                    <div class="detail-songs-list">
                                        ${personalityRecordings.map((item, i) => {
                                const { song, songIdx } = item;
                                return renderSongItem(song, songIdx, i + 1, personalityRecordings.map(r => r.songIdx), { forceRecordingsMode: true });
                            }).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    })()}
                </div>
            `;
            }

            // Helper function to convert Coda internal links to site links
            function convertCodaLinkToSiteLink(linkText, url) {
                // Check if it's a Coda link
                if (!url.includes('coda.io')) {
                    return null; // Not a Coda link
                }

                // Extract rowId from Coda URL
                // Coda URLs can have formats like:
                // https://coda.io/d/{docId}/...#_{tablePrefix}-{rowId}
                // https://coda.io/d/{docId}#...{rowId}
                // The rowId typically starts with 'i-' followed by alphanumeric characters
                let rowId = null;

                // Try to extract from hash fragment
                const hashMatch = url.match(/#.*?(i-[a-zA-Z0-9_-]+)/);
                if (hashMatch) {
                    rowId = hashMatch[1];
                }

                // If we found a rowId, search for it across all entities
                if (rowId) {
                    // Search in nigunim
                    const song = allSongs.find(s => s.rowId === rowId);
                    if (song) {
                        const displayId = song.customId || song.name;
                        return `#/nigunim/${encodeURIComponent(displayId)}`;
                    }

                    // Search in mechabrim
                    for (const [name, info] of Object.entries(mechabrimInfo)) {
                        if (info.rowId === rowId) {
                            const displayId = info.customId || name;
                            return `#/mechabrim/${encodeURIComponent(displayId)}`;
                        }
                    }

                    // Search in verter
                    for (const [name, info] of Object.entries(verterInfo)) {
                        if (info.rowId === rowId) {
                            const displayId = info.customId || name;
                            return `#/verter/${encodeURIComponent(displayId)}`;
                        }
                    }

                    // Search in chatzeros
                    for (const [name, info] of Object.entries(chatzerosInfo)) {
                        if (info.rowId === rowId) {
                            const displayId = info.customId || name;
                            return `#/chatzeros/${encodeURIComponent(displayId)}`;
                        }
                    }

                    // Search in zmanim/piyutim
                    for (const [name, info] of Object.entries(zmaninInfo)) {
                        if (info.rowId === rowId) {
                            const displayId = info.customId || name;
                            return `#/zman/${encodeURIComponent(displayId)}`;
                        }
                    }
                    for (const [name, info] of Object.entries(piyutimInfo)) {
                        if (info.rowId === rowId) {
                            const displayId = info.customId || name;
                            return `#/zman/${encodeURIComponent(displayId)}`;
                        }
                    }

                    // Search in collections
                    for (const [name, info] of Object.entries(collectionsInfo)) {
                        if (info.rowId === rowId) {
                            const displayId = info.customId || name;
                            return `#/collections/${encodeURIComponent(displayId)}`;
                        }
                    }

                    // Search in albums
                    for (const [name, info] of Object.entries(albumsInfo)) {
                        if (info.rowId === rowId) {
                            const displayId = info.customId || name;
                            return `#/albums/${encodeURIComponent(displayId)}`;
                        }
                    }

                    // Search in documents
                    for (const [name, info] of Object.entries(documentsInfo)) {
                        if (info.rowId === rowId) {
                            const displayId = info.customId || name;
                            return `#/documents/${encodeURIComponent(displayId)}`;
                        }
                    }

                    // Search in resources
                    for (const [name, info] of Object.entries(resourcesInfo)) {
                        if (info.rowId === rowId) {
                            const displayId = info.customId || name;
                            return `#/resources/${encodeURIComponent(displayId)}`;
                        }
                    }
                }

                // If no rowId found or no match, try searching by name as fallback
                const searchText = linkText.trim();

                // Try to find in nigunim by name
                let found = findItemByIdOrName('nigunim', searchText);
                if (found) {
                    const displayId = found.customId || found.name;
                    return `#/nigunim/${encodeURIComponent(displayId)}`;
                }

                // Try to find in mechabrim by name
                found = findItemByIdOrName('mechabrim', searchText);
                if (found) {
                    const displayId = found.customId || found.name;
                    return `#/mechabrim/${encodeURIComponent(displayId)}`;
                }

                // Try to find in verter by name
                found = findItemByIdOrName('verter', searchText);
                if (found) {
                    const displayId = found.customId || found.name;
                    return `#/verter/${encodeURIComponent(displayId)}`;
                }

                // Try to find in chatzeros by name
                found = findItemByIdOrName('chatzeros', searchText);
                if (found) {
                    const displayId = found.customId || found.name;
                    return `#/chatzeros/${encodeURIComponent(displayId)}`;
                }

                // If we can't find a match, return null to use the original link
                return null;
            }

            // Format description text (handle markdown-like formatting)
            function formatDescription(text) {
                if (!text) return '';

                // Convert markdown links [text](url) to HTML, with special handling for Coda links
                text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, linkText, url) => {
                    // Try to convert Coda links to site links
                    const siteLink = convertCodaLinkToSiteLink(linkText, url);
                    if (siteLink) {
                        return `<a href="${siteLink}">${linkText}</a>`;
                    }
                    // For non-Coda links or unmatched Coda links, use target="_blank"
                    return `<a href="${url}" target="_blank">${linkText}</a>`;
                });

                // Convert **bold** to <strong>
                text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

                // Convert ## headers to <h4>
                text = text.replace(/^## (.+)$/gm, '<h4>$1</h4>');

                // Convert newlines to <br> for proper display
                text = text.replace(/\n/g, '<br>');

                return text;
            }

            // Format verter (lyrics) text with proper line breaks and styling
            function formatVerter(text) {
                if (!text) return '';

                // Clean up the text
                text = text.replace(/```/g, '').trim();

                // Split into lines and wrap each in a span for styling
                const lines = text.split('\n');

                return lines.map(line => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) return '<div class="verter-line verter-empty"></div>';
                    return `<div class="verter-line">${trimmedLine}</div>`;
                }).join('');
            }

            // Render zmanim page with zmanim as main items
            function renderZmanimPage(container) {
                const data = categories.zmanim;

                // Set current category key for search operations
                currentCategoryKey = 'zmanim';
                categorySearchQuery = ''; // Reset search when navigating to page

                // Build zmanim order
                const zmanOrder = ['שבת', 'מוצאי שבת', 'ראש חודש', 'ימים נוראים', 'סוכות', 'שמחת תורה',
                    'שמחת בית השואבה', 'חנוכה', 'פורים', 'פסח', 'שבועות', 'בין המצרים',
                    'ל"ג בעומר', 'שלש רגלים', 'חתונה', 'שבע ברכות', 'ברית מילה',
                    'בר מצוה', 'קבלת פנים - חופה', 'הכנסת ספר תורה', 'סיום',
                    'שבת שירה', 'שבת שקלים', 'יארצייט'];

                // Add any zmanim not in the predefined order
                Object.keys(zmaninInfo).forEach(z => {
                    if (!zmanOrder.includes(z)) {
                        zmanOrder.push(z);
                    }
                });

                // Filter to only zmanim that exist
                const activeZmanim = zmanOrder.filter(z => zmaninInfo[z]);

                // Count totals
                const totalZmanim = activeZmanim.length;

                // Build HTML
                let html = `
                <div class="page-theme-zman">
                    <div class="page-title">
                        <div class="page-title-bar">זמנים</div>
                        <div class="subtitle"><span class="subtitle-count">0</span></div>
                        <div class="loading-wave-bar active" id="zmanLoader"></div>
                    </div>
                    
                    <div class="page-settings-bar">
                        <div class="detail-filters-group cols-1">
                            ${getSimpleSearchHTML('zmanim')}
                        </div>
                    </div>

                    <div class="category-grid" id="categoryGrid">
            `;

                // Show each zman as a card
                activeZmanim.forEach(zmanName => {
                    const zmanData = zmaninInfo[zmanName];
                    if (!zmanData) return;

                    const piyutimCount = zmanData.piyutim?.length || 0;
                    const collectionsCount = zmanData.collections?.length || 0;

                    const zmanId = zmanData.rowId || zmanName;
                    html += `
                    <a class="category-card" href="#/zman/${encodeURIComponent(zmanId)}" data-action="zman-detail" data-name="${escapeHtml(zmanName)}">
                        <div class="card-header">
                            <div class="card-header-text">
                                <div class="card-title">${zmanName}</div>
                            </div>
                        </div>
                        <div class="card-stats">
                            ${piyutimCount > 0 ? `<span class="card-stat">${pluralize(piyutimCount, 'פיוט', 'פיוטים')}</span>` : ''}
                            ${collectionsCount > 0 ? `<span class="card-stat">${pluralize(collectionsCount, 'קאלעקשאן', 'קאלעקשאנס')}</span>` : ''}
                        </div>
                    </a>
                `;
                });

                html += `</div></div>`;

                container.innerHTML = html;

                const countEl = container.querySelector('.subtitle-count');
                if (countEl) animateCountUp(countEl, totalZmanim);

                // Hide loading wave bar
                const loader = document.getElementById('zmanLoader');
                if (loader) setTimeout(() => loader.classList.remove('active'), 500);
            }

            // Navigate to zman detail page
            function navigateToZmanDetail(name) {
                // Check if this is a piyut or a zman
                if (piyutimInfo[name]) {
                    // This is a piyut, open in modal
                    navigateToDetail('piyutim', name);
                } else if (zmaninInfo[name]) {
                    // This is a zman, open in modal
                    navigateToDetail('zmanim', name);
                }
            }

            // Generate floating music notes for nigun detail page
            function generateNigunDetailNotes() {
                const notesContainer = document.getElementById('nigunDetailNotes');
                if (!notesContainer) return;

                const symbols = ['♪', '♫', '♬', '♩', '♭', '♮', '♯'];
                const noteCount = 30; // More notes for full page coverage
                let html = '';

                for (let i = 0; i < noteCount; i++) {
                    const symbol = symbols[Math.floor(Math.random() * symbols.length)];
                    const size = 40 + Math.random() * 50; // 40-90px
                    const duration = 80 + Math.random() * 50; // 80-130s
                    const delay = Math.random() * duration;
                    const rot = (Math.random() * 40 - 20) + 'deg';

                    // Random position across full viewport
                    const startX = Math.random() * 100; // 0-100%
                    const startY = Math.random() * 100; // 0-100%

                    // Random end position with some movement
                    const endXVal = (Math.random() * 40 - 20); // move -20 to +20vw
                    const endYVal = (Math.random() * 40 - 20); // move -20 to +20vh

                    const endX = `${endXVal}vw`;
                    const endY = `${endYVal}vh`;

                    const wanderClass = `wander-${Math.floor(Math.random() * 3) + 1}`;
                    const wanderDuration = 35 + Math.random() * 20;

                    html += `
                    <div class="note-wrapper" style="left: ${startX}%; top: ${startY}%; --end-x: ${endX}; --end-y: ${endY}; animation-duration: ${duration}s; animation-delay: -${delay}s;">
                        <span class="musical-note ${wanderClass}" style="--rot: ${rot}; font-size: ${size}px; animation-duration: ${wanderDuration}s;">${symbol}</span>
                    </div>
                `;
                }
                notesContainer.innerHTML = html;
            }

            // Generate floating music notes for nigun modal
            function generateNigunModalNotes() {
                const notesContainer = document.getElementById('nigunModalNotes');
                if (!notesContainer) return;

                const symbols = ['♪', '♫', '♬', '♩', '♭', '♮', '♯'];
                const noteCount = 20; // Fewer notes for modal
                let html = '';

                for (let i = 0; i < noteCount; i++) {
                    const symbol = symbols[Math.floor(Math.random() * symbols.length)];
                    const size = 35 + Math.random() * 40; // 35-75px - smaller for modal
                    const duration = 70 + Math.random() * 40; // 70-110s
                    const delay = Math.random() * duration;
                    const rot = (Math.random() * 40 - 20) + 'deg';

                    const angle = Math.random() * 360;
                    const distance = 40 + Math.random() * 25;
                    const endXVal = Math.cos(angle * Math.PI / 180) * distance;
                    const endYVal = Math.sin(angle * Math.PI / 180) * distance;

                    const endX = `calc(${endXVal}vw - 50%)`;
                    const endY = `calc(${endYVal}vh - 50%)`;

                    const wanderClass = `wander-${Math.floor(Math.random() * 3) + 1}`;
                    const wanderDuration = 30 + Math.random() * 15;

                    html += `
                    <div class="note-wrapper" style="--end-x: ${endX}; --end-y: ${endY}; animation-duration: ${duration}s; animation-delay: -${delay}s;">
                        <span class="musical-note ${wanderClass}" style="--rot: ${rot}; font-size: ${size}px; animation-duration: ${wanderDuration}s;">${symbol}</span>
                    </div>
                `;
                }
                notesContainer.innerHTML = html;
            }

            // Render nigun detail page
            function renderNigunDetailPage(container, nigunName) {
                // Find the song by name, rowId, or customId
                let songIdx = allSongs.findIndex(s => s.name === nigunName);
                if (songIdx === -1) {
                    // Try finding by rowId
                    songIdx = allSongs.findIndex(s => s.rowId === nigunName);
                }
                if (songIdx === -1) {
                    // Try finding by customId
                    songIdx = allSongs.findIndex(s => s.customId === nigunName);
                }
                const song = allSongs[songIdx];

                // Store current detail page song index globally for report modal
                window.currentDetailPageSongIdx = songIdx;

                if (!song) {
                    container.innerHTML = '<p>ניגון נישט געפונען</p>';
                    return;
                }

                // Parse chatzeros
                const chatzeros = song.category ? song.category.split(',').map(c => c.trim()).filter(Boolean) : [];

                // Get mechaber info for image
                const mechaberName = song.mechaber ? song.mechaber.split(',')[0].trim() : null;
                const mechaberInfo = mechaberName ? mechabrimInfo[mechaberName] : null;

                // Build music details tags (scale, ritem, pasigOif, maure, collections)
                const musicTags = [];
                if (song.scale) musicTags.push({ value: song.scale, type: 'scale', icon: '' });
                if (song.ritem) musicTags.push({ value: song.ritem, type: 'ritem', icon: '' });
                if (song.pasigOif) musicTags.push({ value: song.pasigOif, type: 'zman', icon: '' });
                if (song.maure) musicTags.push({ value: song.maure, type: 'maure', icon: '' });
                if (song.collections) musicTags.push({ value: song.collections, type: 'collection', icon: '' });

                // Get first mechaber for the hero profile
                const firstMechaber = song.mechaber ? song.mechaber.split(',')[0].trim() : null;
                const firstMechaberInfo = firstMechaber ? mechabrimInfo[firstMechaber] : null;
                const firstMechaberId = firstMechaberInfo?.customId || firstMechaber;

                // Build mechaber name HTML - just use tagName
                let mechaberNameHtml = firstMechaberInfo?.tagName || '';

                container.innerHTML = `
                <div class="detail-page nigun-detail-page">
                    <!-- Floating music notes background -->
                    <div class="nigun-detail-notes" id="nigunDetailNotes"></div>
                    
                    <button class="back-button" onclick="navigateTo('nigunim')">→ ניגונים
                    </button>
                    
                    <!-- Report button for full page -->
                    <button class="nigun-modal-report nigun-fullpage-report" onclick="openReportModal()" title="רעפארט א פראבלעם">!</button>
                    <!-- Add info button for full page -->
                    <button class="nigun-modal-addinfo nigun-fullpage-addinfo" onclick="openAddInfoModal()" title="לייג צו אינפארמאציע">+</button>
                    
                    <!-- New Hero Header for Modal -->
                    <div class="nigun-modal-hero${firstMechaber ? '' : ' no-mechaber'}">
                        <h1 class="nigun-modal-hero-title">${formatDescription(song.name)}</h1>
                        
                        ${firstMechaber ? `
                            <a class="nigun-modal-mechaber-profile" href="#/mechabrim/${encodeURIComponent(firstMechaberId)}" data-action="detail" data-category="mechabrim" data-name="${escapeHtml(firstMechaber)}">
                                <div class="nigun-modal-mechaber-avatar">
                                    ${firstMechaberInfo?.image
                            ? `<img src="${firstMechaberInfo.image}" alt="${firstMechaber}">`
                            : `<div class="placeholder"><div class="mechaber-icon"></div></div>`
                        }
                                </div>
                                <span class="nigun-modal-mechaber-name">${mechaberNameHtml}</span>
                            </a>
                        ` : ''}
                    </div>

                    <!-- Tags bar below hero - personalities, chatzer, maure -->
                    ${(() => {
                        // Use personalities field (other people related to nigun), not mechaber
                        const personalities = song.personalities ? song.personalities.split(',').map(m => m.trim()).filter(Boolean) : [];
                        const hasContent = personalities.length > 0 || chatzeros.length > 0 || song.maure;
                        if (!hasContent) return '';
                        return `
                        <div class="nigun-modal-hero-bottom">
                            ${personalities.length > 0 ? `
                                <div class="nigun-modal-hero-personalities">
                                    ${personalities.map(p => {
                            const pInfo = mechabrimInfo[p] || {};
                            const pId = pInfo.customId || p;
                            return `<a class="personality-tag" href="#/mechabrim/${encodeURIComponent(pId)}" data-action="detail" data-category="mechabrim" data-name="${escapeHtml(p)}" data-tooltip-value="${escapeHtml(p)}" data-tooltip-type="mechaber">${p}</a>`;
                        }).join('')}
                                </div>
                            ` : ''}
                            ${(personalities.length > 0 && chatzeros.length > 0) ? `<div class="nigun-modal-divider"></div>` : ''}
                            ${chatzeros.length > 0 ? `
                                <div class="nigun-modal-hero-chatzeros">
                                    ${chatzeros.map(chatzer => {
                            const cInfo = chatzerosInfo[chatzer] || {};
                            const cId = cInfo.customId || chatzer;
                            return `<a class="chatzer-tag" href="#/chatzeros/${encodeURIComponent(cId)}" data-action="detail" data-category="chatzeros" data-name="${escapeHtml(chatzer)}" data-tooltip-value="${escapeHtml(chatzer)}" data-tooltip-type="chatzer">${chatzer}</a>`;
                        }).join('')}
                                </div>
                            ` : ''}
                            ${(chatzeros.length > 0 && song.maure) ? `<div class="nigun-modal-divider"></div>` : ''}
                            ${song.maure ? `
                                <div class="nigun-modal-hero-maure">
                                    ${song.maure.split(',').map(m => m.trim()).filter(Boolean).map(m => `
                                        <span class="maure-tag" data-action="detail" data-category="piyutim" data-name="${escapeHtml(m)}" data-tooltip-value="${escapeHtml(m)}" data-tooltip-type="piyut" onclick="event.stopPropagation(); navigateToDetail('piyutim', '${escapeHtml(m).replace(/'/g, "\\'")}');">${m}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    })()}

                    ${song.siman ? `
                        <div class="nigun-detail-siman-bar">
                            <span class="nigun-detail-siman-label">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                    <path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/>
                                </svg>
                            </span>
                            <span class="nigun-detail-siman-text">${formatDescription(song.siman)}</span>
                        </div>
                    ` : ''}

                    ${song.recordings && song.recordings.length > 0 ? `
                        <div class="nigun-recordings-list">
                            <div class="song-item-recordings" style="border-top: none; padding: 0; background: transparent;">
                                ${song.recordings.map((rec, i) => {
                        // Build tags like main page
                        let recTags = [];
                        if (rec.album) {
                            rec.album.split(',').forEach(a => {
                                const albumName = a.trim();
                                if (albumName) {
                                    recTags.push('<span class="nigun-tag-inline tag-album" data-action="detail" data-category="albums" data-name="' + escapeHtml(albumName) + '" data-tooltip-value="' + escapeHtml(albumName) + '" data-tooltip-type="collection" style="cursor:pointer;" onclick="event.stopPropagation(); navigateToDetail(\'albums\', \'' + escapeHtml(albumName).replace(/'/g, "\\'") + '\');">' + albumName + '</span>');
                                }
                            });
                        }
                        if (rec.personalities) {
                            rec.personalities.split(',').forEach(p => {
                                const name = p.trim();
                                if (name) {
                                    recTags.push('<span class="nigun-tag-inline tag-mechaber" data-action="detail" data-category="mechabrim" data-name="' + escapeHtml(name) + '" data-tooltip-value="' + escapeHtml(name) + '" data-tooltip-type="mechaber" style="cursor:pointer;" onclick="event.stopPropagation(); navigateToDetail(\'mechabrim\', \'' + escapeHtml(name).replace(/'/g, "\\'") + '\');">' + name + '</span>');
                                }
                            });
                        }

                        // Determine display name
                        const displayName = rec.details || ('רעקארדינג ' + (i + 1));
                        const recRating = rec.rating ? '<span class="rec-rating-display">' + '★'.repeat(rec.rating) + '</span>' : '';
                        const isActive = i === 0;

                        // SVG play/pause button like main page
                        const playBtn = '<button class="song-play-btn-new rec-play-btn" onclick="event.stopPropagation(); playNigunRecording(' + songIdx + ', ' + i + ', this)" data-song-idx="' + songIdx + '" data-rec-idx="' + i + '">' +
                            '<span class="play-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/></svg></span>' +
                            '<span class="pause-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M9 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zM13 7v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"/></svg></span>' +
                            '</button>';

                        return '<div class="song-item-recording" onclick="event.stopPropagation(); playNigunRecording(' + songIdx + ', ' + i + ', this)" data-song-idx="' + songIdx + '" data-rec-idx="' + i + '" data-rating="' + (rec.rating || 0) + '">' +
                            '<div class="song-item-rec-num">' + (i + 1) + '</div>' +
                            '<div class="song-item-rec-info">' +
                            '<div class="song-item-rec-name">' + formatDescription(displayName) + '</div>' +
                            (recTags.length > 0 ? '<div class="song-item-rec-tags">' + recTags.join('') + '</div>' : '') +
                            '</div>' +
                            recRating +
                            playBtn +
                            '</div>';
                    }).join('')}
                            </div>
                        </div>
                    ` : ''}



                    <!-- Compact Details Grid -->
                    ${(() => {
                        // Check if we have any items to display
                        const hasAnyItems = song.verter || song.ritem || song.scale || song.pasigOif || song.collections || song.resources;
                        if (!hasAnyItems) return '';

                        return `<div class="nigun-details-grid">
                                <div class="nigun-details-row">
                                    ${song.verter ? song.verter.split(',').map(v => v.trim()).filter(Boolean).map(v => `
                                        <div class="nigun-detail-box box-verter" data-action="detail" data-category="verter" data-name="${escapeHtml(v)}" data-tooltip-value="${escapeHtml(v)}" data-tooltip-type="verter">
                                            <div class="nigun-detail-box-header">ווערטער</div>
                                            <div class="nigun-detail-box-content">${v}</div>
                                        </div>
                                    `).join('') : ''}
                                    ${song.ritem ? `
                                        <div class="nigun-detail-box box-ritem" data-action="filter" data-page="music" data-filter-key="ritem" data-value="${escapeHtml(song.ritem)}">
                                            <div class="nigun-detail-box-header">ריטעם</div>
                                            <div class="nigun-detail-box-content">${song.ritem}</div>
                                        </div>
                                    ` : ''}
                                    ${song.scale ? `
                                        <div class="nigun-detail-box box-scale" data-action="filter" data-page="music" data-filter-key="scale" data-value="${escapeHtml(song.scale)}">
                                            <div class="nigun-detail-box-header">סקעיל</div>
                                            <div class="nigun-detail-box-content">${song.scale}</div>
                                        </div>
                                    ` : ''}
                                    ${song.pasigOif ? song.pasigOif.split(',').map(p => p.trim()).filter(Boolean).map(p => `
                                        <div class="nigun-detail-box box-pasig" data-action="detail" data-category="piyutim" data-name="${escapeHtml(p)}" data-tooltip-value="${escapeHtml(p)}" data-tooltip-type="piyut">
                                            <div class="nigun-detail-box-header">פאסיג אויף</div>
                                            <div class="nigun-detail-box-content">${p}</div>
                                        </div>
                                    `).join('') : ''}
                                    ${song.collections ? song.collections.split(',').map(col => col.trim()).filter(Boolean).map(col => `
                                        <div class="nigun-detail-box box-collections" data-action="detail" data-category="collections" data-name="${escapeHtml(col)}" data-tooltip-value="${escapeHtml(col)}" data-tooltip-type="collection">
                                            <div class="nigun-detail-box-header">קאלעקשאנס</div>
                                            <div class="nigun-detail-box-content">${col}</div>
                                        </div>
                                    `).join('') : ''}

                                </div>
                            </div>`;
                    })()}
                    
                    ${song.info ? `
                        <div class="nigun-info-box">
                            <span class="nigun-info-icon">ℹ</span>
                            <div class="nigun-info-text">${formatDescription(song.info)}</div>
                        </div>
                    ` : ''}
                    
                    ${song.notn ? `
                        <div class="nigun-section">
                            <h3>נאטן</h3>
                            <div class="nigun-section-content">
                                <a href="${song.notn}" target="_blank" class="nigun-notn-link">📄 קוק נאטן</a>
                            </div>
                        </div>
                    ` : ''}

                    ${(song.otherMedia && (song.otherMedia.text || song.otherMedia.audio.length > 0 || song.otherMedia.images.length > 0 || song.otherMedia.videos.length > 0 || song.otherMedia.pdfs.length > 0 || song.otherMedia.files.length > 0)) ? `
                        <div class="nigun-additions-box">
                            <span class="nigun-additions-icon">+</span>
                            <div class="nigun-additions-content">
                                ${song.otherMedia.text ? `
                                    <div class="nigun-additions-text">${formatDescription(song.otherMedia.text)}</div>
                                ` : ''}

                                ${song.otherMedia.audio.length > 0 ? `
                                    <div class="nigun-recordings-list">
                                        ${song.otherMedia.audio.map((aud, i) => `
                                            <div class="nigun-recording-item" onclick="playOtherMediaAudio('${aud.url}', this)">
                                                <div class="nigun-recording-number">♫</div>
                                                <div class="nigun-recording-info">
                                                    <div class="nigun-recording-name">${formatDescription(aud.name)}</div>
                                                </div>
                                                <button class="nigun-recording-play-btn">▶</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}

                                ${song.otherMedia.files.length > 0 ? `
                                    <div class="nigun-files-list">
                                        ${song.otherMedia.files.map((file, i) => `
                                            <a href="${file.url}" target="_blank" class="nigun-file-item">
                                                <div class="nigun-file-icon">📎</div>
                                                <div class="nigun-file-name">${file.name}</div>
                                                <div class="nigun-file-download">הורדה</div>
                                            </a>
                                        `).join('')}
                                    </div>
                                ` : ''}

                                ${(song.otherMedia.images.length > 0 || song.otherMedia.videos.length > 0 || song.otherMedia.pdfs.length > 0) ? `
                                    <div class="nigun-other-media-grid">
                                        ${song.otherMedia.images.map((img, i) => `
                                            <div class="nigun-image-item" onclick="openImageModal('${img.url}')">
                                                <img src="${img.url}" alt="${img.name}" loading="lazy">
                                                <div class="nigun-image-name">${img.name}</div>
                                            </div>
                                        `).join('')}

                                        ${song.otherMedia.videos.map((vid, i) => `
                                            <div class="nigun-video-item" onclick="openVideoModal('${vid.url}')">
                                                <video src="${vid.url}" preload="metadata"></video>
                                                <div class="nigun-video-play-overlay">
                                                    <div class="nigun-video-play-icon">▶</div>
                                                </div>
                                                <div class="nigun-video-name">${vid.name}</div>
                                            </div>
                                        `).join('')}

                                        ${song.otherMedia.pdfs.map((pdf, i) => `
                                            <div class="nigun-pdf-preview" onclick="window.open('${pdf.url}', '_blank')">
                                                <div class="nigun-pdf-preview-box">
                                                    <div class="nigun-pdf-preview-icon">📄</div>
                                                    <div class="nigun-pdf-preview-label">PDF</div>
                                                </div>
                                                <div class="nigun-pdf-preview-name">${pdf.name}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    ${(song.resources || song.albums || song.documents) ? `
                        <div class="nigun-modal-hero-bottom" style="margin-top: 15px;">
                            ${song.resources ? `
                                <div class="nigun-modal-hero-resources">
                                    ${song.resources.split(',').map(r => r.trim()).filter(Boolean).map(r => `
                                        <span class="resource-tag" data-action="detail" data-category="resources" data-name="${escapeHtml(r)}" data-tooltip-value="${escapeHtml(r)}" data-tooltip-type="resource" style="cursor:pointer;">${r}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${(song.resources && song.albums) ? `<div class="nigun-modal-divider"></div>` : ''}
                            ${song.albums ? `
                                <div class="nigun-modal-hero-albums">
                                    ${song.albums.split(',').map(a => a.trim()).filter(Boolean).map(a => `
                                        <span class="album-tag" data-action="detail" data-category="albums" data-name="${escapeHtml(a)}" data-tooltip-value="${escapeHtml(a)}" data-tooltip-type="collection">${a}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${((song.resources || song.albums) && song.documents) ? `<div class="nigun-modal-divider"></div>` : ''}
                            ${song.documents ? `
                                <div class="nigun-modal-hero-documents">
                                    ${song.documents.split(',').map(d => d.trim()).filter(Boolean).map(d => `
                                        <span class="document-tag" data-action="detail" data-category="documents" data-name="${escapeHtml(d)}" data-tooltip-value="${escapeHtml(d)}" data-tooltip-type="collection">${d}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    ${song.credits ? `
                        <div class="nigun-credits">
                            ${song.credits}
                        </div>
                    ` : ''}

                    ${!song._fullDetailsLoaded ? `
                        <div class="nigun-detail-loading-more" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px 0 8px; opacity: 0.5;">
                            <div style="width: 16px; height: 16px; border: 2px solid var(--text-tertiary, #999); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                            <span style="font-size: 13px; color: var(--text-tertiary, #999);">לאודט מער אינפארמאציע...</span>
                        </div>
                    ` : ''}
                </div>
            `;

                // Title centering is now handled by CSS padding: 0 160px on .nigun-modal-hero-title

                // Generate floating music notes for this page
                generateNigunDetailNotes();
            }

            // Play recording from nigun detail page
            function playNigunRecording(songIdx, recordingIdx, element, playlist = null, expandPlayer = true) {
                const song = allSongs[songIdx];
                if (!song || !song.recordings || !song.recordings[recordingIdx]) {
                    return;
                }

                const recording = song.recordings[recordingIdx];

                // If clicking the same recording that's currently playing, toggle play/pause
                if (songIdx === currentSongIndex && recordingIdx === currentRecordingIndex && audioPlayer.src) {
                    togglePlayPause();
                    return;
                }

                // Update current song and recording index
                currentSongIndex = songIdx;
                currentRecordingIndex = recordingIdx;

                // Update playlist if provided, or if song not in current playlist
                if (playlist && Array.isArray(playlist)) {
                    currentPlaylist = playlist;
                    currentPlaylistPosition = currentPlaylist.indexOf(songIdx);
                } else if (currentPlaylist.length === 0 || !currentPlaylist.includes(songIdx)) {
                    // If no playlist set or song not in current playlist, use filteredSongs
                    currentPlaylist = filteredSongs.map(s => allSongs.indexOf(s));
                    currentPlaylistPosition = currentPlaylist.indexOf(songIdx);
                } else {
                    // Song is in current playlist, just update position
                    currentPlaylistPosition = currentPlaylist.indexOf(songIdx);
                }

                // Set recording info for rating updates
                currentPlayingRecordingInfo = {
                    songIdx: songIdx,
                    recordingIdx: recordingIdx,
                    slotIndex: recording.slotIndex,
                    rowId: song.rowId,
                    tableRowId: recording.rowId // Recording's own row ID in recordings table
                };

                // Enable recordings mode when playing any recording
                isInRecordingsMode = true;

                // Play the specific recording URL
                // Reset progress bar instantly (no animation)
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.transition = 'none';
                    progressBar.style.width = '0%';
                    setTimeout(() => { progressBar.style.transition = 'width 0.15s ease-out'; }, 50);
                }
                document.getElementById('currentTime').textContent = '0:00';

                audioPlayer.src = recording.url;
                audioPlayer.play();

                showPlayer();
                // Expand player when user manually selects a recording from list
                if (expandPlayer) {
                    showPlayerBanner();
                }
                // Update player UI with song info
                updatePlayerUI(song);
                updateActiveSongInList();

                // Trigger visual effects immediately (wave animation, active state)
                updatePlayState(true);

                // Update rating display in player
                updatePlayerRating(recording.rating);

                // Update active recording state in song list and modal (now both use same classes)
                document.querySelectorAll('.song-item-recording').forEach(rec => {
                    rec.classList.remove('active-recording');
                });
                document.querySelectorAll('.rec-play-btn').forEach(btn => {
                    btn.classList.remove('playing');
                });
                const activeRecRow = document.querySelector(`.song-item-recording[data-song-idx="${songIdx}"][data-rec-idx="${recordingIdx}"]`);
                if (activeRecRow) {
                    activeRecRow.classList.add('active-recording');
                }
                const activeRecBtn = document.querySelector(`.rec-play-btn[data-song-idx="${songIdx}"][data-rec-idx="${recordingIdx}"]`);
                if (activeRecBtn) {
                    activeRecBtn.classList.add('playing');
                }

                // Update play-all button state
                updatePlayAllBtnState();
            }

            // Toggle play all from modal - plays first recording or toggles pause
            function togglePlayAllFromModal(songIdx) {
                const song = allSongs[songIdx];
                if (!song || !song.recordings || song.recordings.length === 0) return;

                // If this song is already playing, toggle play/pause
                if (songIdx === currentSongIndex && audioPlayer.src) {
                    togglePlayPause();
                    return;
                }

                // Otherwise, play the first recording
                playNigunRecording(songIdx, 0, null);
            }

            // Update play-all button state based on player state
            function updatePlayAllBtnState() {
                const playAllBtns = document.querySelectorAll('.play-all-btn');
                const isCurrentlyPlaying = audioPlayer.src && !audioPlayer.paused;

                playAllBtns.forEach(btn => {
                    const playIcon = btn.querySelector('.play-icon');
                    const pauseIcon = btn.querySelector('.pause-icon');

                    // For nigun modal buttons (single song)
                    const songIdx = parseInt(btn.dataset.songIdx);
                    if (!isNaN(songIdx)) {
                        if (songIdx === currentSongIndex && isCurrentlyPlaying) {
                            btn.classList.add('playing');
                            if (playIcon) playIcon.style.display = 'none';
                            if (pauseIcon) pauseIcon.style.display = 'block';
                        } else {
                            btn.classList.remove('playing');
                            if (playIcon) playIcon.style.display = 'block';
                            if (pauseIcon) pauseIcon.style.display = 'none';
                        }
                        return;
                    }

                    // For detail page buttons - check if currently playing song is from this page
                    const detailType = btn.dataset.detailType;
                    const detailName = btn.dataset.detailName;
                    if (detailType && detailName && currentSongIndex >= 0) {
                        const currentSong = allSongs[currentSongIndex];
                        let isFromThisPage = false;

                        if (currentSong) {
                            if (detailType === 'mechabrim' && currentSong.mechaber) {
                                isFromThisPage = currentSong.mechaber.split(',').map(m => m.trim()).includes(detailName);
                            } else if (detailType === 'chatzeros' && currentSong.category) {
                                isFromThisPage = currentSong.category.split(',').map(c => c.trim()).includes(detailName);
                            } else if (detailType === 'verter' && currentSong.name) {
                                isFromThisPage = currentSong.name === detailName;
                            } else if (detailType === 'piyutim' && currentSong.maure) {
                                isFromThisPage = currentSong.maure.split(',').map(m => m.trim()).includes(detailName);
                            } else if (detailType === 'collections' && currentSong.collection) {
                                isFromThisPage = currentSong.collection.split(',').map(c => c.trim()).includes(detailName);
                            }
                        }

                        if (isFromThisPage && isCurrentlyPlaying) {
                            btn.classList.add('playing');
                            if (playIcon) playIcon.style.display = 'none';
                            if (pauseIcon) pauseIcon.style.display = 'block';
                        } else {
                            btn.classList.remove('playing');
                            if (playIcon) playIcon.style.display = 'block';
                            if (pauseIcon) pauseIcon.style.display = 'none';
                        }
                    }
                });
            }

            // Play all from detail page - plays first song in the category
            function playAllFromDetailPage(type, name) {
                // Find songs for this detail page
                let songs = [];

                allSongs.forEach((song, idx) => {
                    let matches = false;

                    if (type === 'mechabrim' && song.mechaber) {
                        matches = song.mechaber.split(',').map(m => m.trim()).includes(name);
                    } else if (type === 'chatzeros' && song.category) {
                        matches = song.category.split(',').map(c => c.trim()).includes(name);
                    } else if (type === 'verter' && song.verter) {
                        matches = song.verter.split(',').map(v => v.trim()).includes(name);
                    } else if (type === 'piyutim' && song.maure) {
                        matches = song.maure.split(',').map(m => m.trim()).includes(name);
                    } else if (type === 'collections' && song.collection) {
                        matches = song.collection.split(',').map(c => c.trim()).includes(name);
                    }

                    if (matches && song.recordings && song.recordings.length > 0) {
                        songs.push({ song, idx });
                    }
                });

                if (songs.length === 0) return;

                // Sort alphabetically to match displayed order
                songs.sort((a, b) => (a.song.name || '').localeCompare(b.song.name || '', 'he'));

                // Check if currently playing is from this page - if so, toggle pause
                if (currentSongIndex >= 0 && audioPlayer.src) {
                    const currentSong = allSongs[currentSongIndex];
                    let isFromThisPage = false;

                    if (currentSong) {
                        if (type === 'mechabrim' && currentSong.mechaber) {
                            isFromThisPage = currentSong.mechaber.split(',').map(m => m.trim()).includes(name);
                        } else if (type === 'chatzeros' && currentSong.category) {
                            isFromThisPage = currentSong.category.split(',').map(c => c.trim()).includes(name);
                        } else if (type === 'verter' && currentSong.verter) {
                            isFromThisPage = currentSong.verter.split(',').map(v => v.trim()).includes(name);
                        } else if (type === 'piyutim' && currentSong.maure) {
                            isFromThisPage = currentSong.maure.split(',').map(m => m.trim()).includes(name);
                        } else if (type === 'collections' && currentSong.collection) {
                            isFromThisPage = currentSong.collection.split(',').map(c => c.trim()).includes(name);
                        }
                    }

                    if (isFromThisPage) {
                        togglePlayPause();
                        return;
                    }
                }

                // Play first song
                const first = songs[0];
                const playlistIndices = songs.map(s => s.idx);
                playNigunRecording(first.idx, 0, null, playlistIndices);
            }

            // Render zman detail page
            function renderZmanDetailPage(container, zmanNameOrId) {
                // Find the zman by name, rowId, or customId
                let zmanName = zmanNameOrId;
                let zmanData = zmaninInfo[zmanNameOrId];

                // If not found by direct name, try finding by rowId or customId
                if (!zmanData) {
                    for (const [key, info] of Object.entries(zmaninInfo)) {
                        if (info.rowId === zmanNameOrId || info.customId === zmanNameOrId) {
                            zmanName = key;
                            zmanData = info;
                            break;
                        }
                    }
                }

                if (!zmanData) {
                    container.innerHTML = '<p>זמן נישט געפונען</p>';
                    return;
                }

                const piyutim = zmanData.piyutim || [];
                const collections = zmanData.collections || [];

                let html = `
                <div class="detail-page theme-zman">
                    <button class="back-button" onclick="navigateTo('zmanim')">
                        → זמנים
                    </button>
                    
                    <div class="detail-header">
                        <div class="detail-category-bar">זמן</div>
                        <div class="detail-header-content">
                            <div class="detail-header-text">
                                <div class="detail-title">${zmanName}</div>
                                <div class="detail-subtitle">
                                    ${collections.length > 0 ? `<span>${collections.length} קאלעקשאנס</span>` : ''}
                                    ${piyutim.length > 0 && collections.length > 0 ? '<span class="detail-separator">•</span>' : ''}
                                    ${piyutim.length > 0 ? `<span>${piyutim.length} פיוטים</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
            `;

                // Collections section first
                if (collections.length > 0) {
                    html += `
                    <div class="zman-section section-collections">
                        <h3>קאלעקשאנס</h3>
                        <div class="zman-items-grid">
                            ${collections.sort((a, b) => a.localeCompare(b, 'he')).map(colName => {
                        const songCount = categories.collections[colName]?.length || 0;
                        const colInfo = collectionsInfo[colName] || {};
                        const colId = colInfo.customId || colName;
                        return `
                                    <a class="zman-item-card" href="#/collections/${encodeURIComponent(colId)}" data-action="detail" data-category="collections" data-name="${escapeHtml(colName)}">
                                        <div class="zman-item-header">
                                            <div class="zman-item-name">${colName}</div>
                                        </div>
                                        <div class="zman-item-stats">
                                            <div class="zman-item-count">${pluralize(songCount, 'ניגון', 'ניגונים')}</div>
                                        </div>
                                    </a>
                                `;
                    }).join('')}
                        </div>
                    </div>
                `;
                }

                // Piyutim section
                if (piyutim.length > 0) {
                    html += `
                    <div class="zman-section section-piyutim">
                        <h3>פיוטים</h3>
                        <div class="zman-items-grid">
                            ${piyutim.sort((a, b) => a.localeCompare(b, 'he')).map(piyutName => {
                        // Count songs using linked nigunim from piyutim table
                        const piyutLinkedNigunim = new Set((piyutimInfo[piyutName]?.nigunim) || []);
                        const songCount = allSongs.filter(song => piyutLinkedNigunim.has(song.codaRowName)).length;
                        const piyutInfo = piyutimInfo[piyutName] || {};
                        const piyutId = piyutInfo.customId || piyutName;
                        return `
                                    <a class="zman-item-card" href="#/piyutim/${encodeURIComponent(piyutId)}" data-action="detail" data-category="piyutim" data-name="${escapeHtml(piyutName)}">
                                        <div class="zman-item-header">
                                            <div class="zman-item-name">${piyutName}</div>
                                        </div>
                                        <div class="zman-item-stats">
                                            <div class="zman-item-count">${pluralize(songCount, 'ניגון', 'ניגונים')}</div>
                                        </div>
                                    </a>
                                `;
                    }).join('')}
                        </div>
                    </div>
                `;
                }

                html += `</div>`;

                container.innerHTML = html;
            }

            // Render collections page with zmanim tags
            function renderCollectionsPage(container) {
                const data = categories.collections;
                const sortedKeys = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));

                // Set current category key for search operations
                currentCategoryKey = 'collections';
                categorySearchQuery = ''; // Reset search when navigating to page

                container.innerHTML = `
                <div class="page-theme-collection">
                    <div class="page-title">
                        <div class="page-title-bar">קאלעקשאנס</div>
                        <div class="subtitle"><span class="subtitle-count">0</span></div>
                        <div class="loading-wave-bar active" id="collectionLoader"></div>
                    </div>

                    <div class="page-settings-bar">
                        <div class="detail-filters-group cols-1">
                            ${getSimpleSearchHTML('collections')}
                        </div>
                    </div>

                    <div class="collections-grid" id="categoryGrid">
                        ${sortedKeys.map(key => {
                    const info = collectionsInfo[key] || {};
                    const songCount = data[key].length;
                    const zmanim = info.zmanim || [];
                    const songIndices = data[key] || [];
                    const playlistIndices = songIndices.map(idx => idx);

                    return `
                            <div class="collection-card">
                                <div class="collection-card-header" data-action="detail" data-category="collections" data-name="${escapeHtml(key)}">
                                    <div class="collection-icon">♫</div>
                                    <div class="collection-info">
                                        <div class="collection-title">${key}</div>
                                        <div class="collection-meta">${pluralize(songCount, 'ניגון', 'ניגונים')}</div>
                                        ${zmanim.length > 0 ? `
                                            <div class="collection-zmanim" onclick="event.stopPropagation();">
                                                ${zmanim.slice(0, 3).map(zman => `<span class="collection-zman-tag"
                                                    data-action="zman-detail"
                                                    data-name="${escapeHtml(zman)}"
                                                    data-tooltip-value="${escapeHtml(zman)}"
                                                    data-tooltip-type="zman">${zman}</span>`).join('')}
                                                ${zmanim.length > 3 ? `<span class="collection-zman-more">+${zmanim.length - 3}</span>` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <button class="collection-play-btn" data-action="play-collection" data-name="${escapeHtml(key)}">
                                        ▶
                                    </button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;

                const countEl = container.querySelector('.subtitle-count');
                if (countEl) animateCountUp(countEl, sortedKeys.length);

                // Hide loading wave bar
                const loader = document.getElementById('collectionLoader');
                if (loader) setTimeout(() => loader.classList.remove('active'), 500);
            }

            // Render piyutim page
            function renderPiyutimPage(container) {
                // Get all piyutim from piyutimInfo
                const sortedPiyutim = Object.keys(piyutimInfo).sort((a, b) => a.localeCompare(b, 'he'));

                // Set current category key for search operations
                currentCategoryKey = 'piyutim';
                categorySearchQuery = ''; // Reset search when navigating to page

                // Check if we're coming from skeleton (skeleton-grid exists)
                const existingSkeletonGrid = container.querySelector('.skeleton-grid');
                const existingCountEl = container.querySelector('.subtitle-count');

                if (existingSkeletonGrid && existingCountEl) {
                    // Coming from skeleton - just update count and replace grid, keep header
                    animateCountUp(existingCountEl, sortedPiyutim.length);

                    // Add settings bar after page-title (before skeleton-grid)
                    const settingsBarDiv = document.createElement('div');
                    settingsBarDiv.className = 'page-settings-bar';
                    settingsBarDiv.innerHTML = `<div class="detail-filters-group cols-1">${getSimpleSearchHTML('piyutim')}</div>`;
                    existingSkeletonGrid.before(settingsBarDiv);

                    // Replace skeleton-grid with category-grid
                    const categoryGrid = document.createElement('div');
                    categoryGrid.className = 'category-grid';
                    categoryGrid.id = 'piyutimGrid';
                    existingSkeletonGrid.replaceWith(categoryGrid);

                    // Generate cards HTML
                    const cardsHTML = sortedPiyutim.map(piyutName => {
                        const info = piyutimInfo[piyutName] || {};
                        // Count songs using linked nigunim from piyutim table
                        const piyutLinkedNigunim = new Set(info.nigunim || []);
                        const songCount = allSongs.filter(song => piyutLinkedNigunim.has(song.codaRowName)).length;
                        const piyutId = info.customId || piyutName;
                        const zmanim = info.zmanim || [];

                        return `
                        <a class="category-card" href="#/piyutim/${encodeURIComponent(piyutId)}" data-action="detail" data-category="piyutim" data-name="${escapeHtml(piyutName)}">
                            <div class="card-header">
                                <div class="card-header-text">
                                    <div class="card-title">${piyutName}</div>
                                    ${zmanim.length > 0 ? `
                                        <div class="card-tags" onclick="event.stopPropagation();">
                                            ${zmanim.map(zman => `
                                                <span class="card-zman-tag"
                                                      data-action="zman-detail"
                                                      data-name="${escapeHtml(zman)}"
                                                      onclick="event.stopPropagation(); event.preventDefault(); navigateToDetail('zmanim', '${escapeHtml(zman).replace(/'/g, "\\'")}');"
                                                      data-tooltip-value="${escapeHtml(zman)}"
                                                      data-tooltip-type="zman">${zman}</span>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="card-stats">
                                <span class="card-stat">${pluralize(songCount, 'ניגון', 'ניגונים')}</span>
                            </div>
                        </a>
                    `;
                    }).join('');

                    categoryGrid.innerHTML = cardsHTML;

                    // Hide loading wave bar
                    const loader = document.getElementById('piyutimLoader');
                    if (loader) setTimeout(() => loader.classList.remove('active'), 500);

                    return;
                }

                // First load - render full page
                container.innerHTML = `
                <div class="page-theme-piyut">
                    <div class="page-title">
                        <div class="page-title-bar">פיוטים</div>
                        <div class="subtitle"><span class="subtitle-count">0</span></div>
                        <div class="loading-wave-bar active" id="piyutimLoader"></div>
                    </div>

                    <div class="page-settings-bar">
                        <div class="detail-filters-group cols-1">
                            ${getSimpleSearchHTML('piyutim')}
                        </div>
                    </div>

                    <div class="category-grid" id="piyutimGrid">
                        ${sortedPiyutim.map(piyutName => {
                    const info = piyutimInfo[piyutName] || {};
                    // Count songs using linked nigunim from piyutim table
                    const piyutLinkedNigunim = new Set(info.nigunim || []);
                    const songCount = allSongs.filter(song => piyutLinkedNigunim.has(song.codaRowName)).length;
                    const piyutId = info.customId || piyutName;
                    const zmanim = info.zmanim || [];

                    return `
                                <a class="category-card" href="#/piyutim/${encodeURIComponent(piyutId)}" data-action="detail" data-category="piyutim" data-name="${escapeHtml(piyutName)}">
                                    <div class="card-header">
                                        <div class="card-header-text">
                                            <div class="card-title">${piyutName}</div>
                                            ${zmanim.length > 0 ? `
                                                <div class="card-tags" onclick="event.stopPropagation();">
                                                    ${zmanim.map(zman => `
                                                        <span class="card-zman-tag"
                                                              data-action="zman-detail"
                                                              data-name="${escapeHtml(zman)}"
                                                              onclick="event.stopPropagation(); event.preventDefault(); navigateToDetail('zmanim', '${escapeHtml(zman).replace(/'/g, "\\'")}');"
                                                              data-tooltip-value="${escapeHtml(zman)}"
                                                              data-tooltip-type="zman">${zman}</span>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="card-stats">
                                        <span class="card-stat">${pluralize(songCount, 'ניגון', 'ניגונים')}</span>
                                    </div>
                                </a>
                            `;
                }).join('')}
                    </div>
                </div>
            `;

                const countEl = container.querySelector('.subtitle-count');
                if (countEl) animateCountUp(countEl, sortedPiyutim.length);

                // Hide loading wave bar
                const loader = document.getElementById('piyutimLoader');
                if (loader) setTimeout(() => loader.classList.remove('active'), 500);
            }

            // Render music page (scale & rhythm)
            function renderMusicPage(container) {
                const scaleData = categories.scale;
                const ritemData = categories.ritem;
                const sortedScales = Object.keys(scaleData).sort((a, b) => scaleData[b].length - scaleData[a].length);
                const sortedRitems = Object.keys(ritemData).sort((a, b) => ritemData[b].length - ritemData[a].length);

                // Build structure: for each ritem, group songs by scale
                const ritemGroups = {};
                sortedRitems.forEach(ritem => {
                    ritemGroups[ritem] = {};
                    const songIndices = ritemData[ritem] || [];
                    songIndices.forEach(idx => {
                        const song = allSongs[idx];
                        if (song) {
                            const scale = song.scale || 'אנדערע';
                            if (!ritemGroups[ritem][scale]) {
                                ritemGroups[ritem][scale] = [];
                            }
                            ritemGroups[ritem][scale].push(idx);
                        }
                    });
                });

                container.innerHTML = `
                <div class="page-theme-music">
                    <div class="page-title">
                        <div class="page-title-bar">מוזיק</div>
                        <div class="subtitle">ניגונים לויט ריטעם און סקעיל</div>
                        <div class="loading-wave-bar active" id="musicLoader"></div>
                    </div>

                    <!-- Rhythm Groups -->
                    <div class="music-ritem-groups" id="musicRitemGroups">
                        ${sortedRitems.map(ritem => {
                    const scalesInRitem = Object.keys(ritemGroups[ritem]).sort((a, b) =>
                        (ritemGroups[ritem][b]?.length || 0) - (ritemGroups[ritem][a]?.length || 0)
                    );
                    const totalInRitem = ritemData[ritem].length;

                    return `
                                <div class="ritem-group" data-ritem="${ritem}">
                                    <div class="ritem-group-header">
                                        <h3>${ritem}</h3>
                                        <span class="ritem-count">${totalInRitem} ניגונים</span>
                                        <button class="ritem-play-btn" data-action="play-music" data-category-type="ritem" data-name="${escapeHtml(ritem)}">▶ שפיל אלע</button>
                                    </div>
                                    <div class="ritem-scales">
                                        ${scalesInRitem.map(scale => {
                        const songsInScale = ritemGroups[ritem][scale] || [];
                        return `
                                                <div class="scale-group" data-scale="${scale}">
                                                    <div class="scale-group-header">
                                                        <span class="scale-name">${scale}</span>
                                                        <span class="scale-song-count">${songsInScale.length}</span>
                                                    </div>
                                                    <div class="scale-songs">
                                                        ${songsInScale.slice(0, 10).map((songIdx, i) => {
                            const song = allSongs[songIdx];
                            const hasAudio = song.audioUrl && song.audioUrl.startsWith('http');
                            return `
                                                                <div class="music-song-item ${!hasAudio ? 'no-audio' : ''}" 
                                                                     onclick="${hasAudio ? `playSong(${songIdx})` : `showSongDetails(${songIdx})`}">
                                                                    <span class="music-song-name">${formatDescription(song.name)}</span>
                                                                    ${song.mechaber ? `<span class="music-song-meta">${song.mechaber}</span>` : ''}
                                                                    <button class="music-song-details" onclick="event.stopPropagation(); showSongDetails(${songIdx});">◉</button>
                                                                </div>
                                                            `;
                        }).join('')}
                                                        ${songsInScale.length > 10 ? `
                                                            <div class="scale-more" data-action="scale-more" data-ritem="${escapeHtml(ritem)}" data-scale="${escapeHtml(scale)}">
                                                                + נאך ${songsInScale.length - 10} ניגונים...
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            `;
                    }).join('')}
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                </div>
            `;

                // Hide loading wave bar
                setTimeout(() => {
                    const loader = document.getElementById('musicLoader');
                    if (loader) loader.classList.remove('active');
                }, 500);
            }

            // Show all songs for a scale in a ritem
            function showAllScaleSongs(ritem, scale) {
                // Navigate to songs page with both filters
                activeFilters.ritem = [ritem];
                activeFilters.scale = [scale];
                applyFilters();
                navigateTo('nigunim');
            }

            // Lazy loading state for categories
            let categoryLazyState = {
                currentIndex: 0,
                batchSize: 50,
                allKeys: [],
                isLoading: false,
                isInitialLoad: true  // Track if this is the first batch (for animations)
            };

            // Render a single category card
            function renderCategoryCard(key, categoryKey, icon, infoObj, data) {
                const info = infoObj[key] || {};
                const hasImage = !!info.image;
                const songCount = data[key].length;
                const itemId = info.customId || key;

                // Only show chatzer tags for mechabrim
                const chatzeros = (categoryKey === 'mechabrim' && info.chatzer)
                    ? info.chatzer.split(',').map(c => c.trim()).filter(Boolean)
                    : [];

                // Count mechabrim for chatzeros
                let mechabrimCount = 0;
                if (categoryKey === 'chatzeros') {
                    mechabrimCount = Object.entries(mechabrimInfo)
                        .filter(([mechName, mechInfo]) => {
                            if (!mechInfo.chatzer) return false;
                            const mechChatzeros = mechInfo.chatzer.split(',').map(c => c.trim());
                            return mechChatzeros.includes(key);
                        }).length;
                }

                // Special layout for mechabrim cards
                if (categoryKey === 'mechabrim') {
                    const formalParts = [info.title, info.firstName, info.lastName].filter(Boolean);
                    const formalName = formalParts.length > 0 ? formalParts.join(' ') : '';

                    const birthParts = [info.birthDay, info.birthMonth, info.birthYear].filter(Boolean);
                    const deathParts = [info.deathDay, info.deathMonth, info.deathYear].filter(Boolean);
                    const birthDate = birthParts.join(' ');
                    const deathDate = deathParts.join(' ');
                    const dateStr = (birthDate || deathDate) ? `${birthDate || '?'} - ${deathDate || ''}` : '';

                    // Count recordings where mechaber appears in personalities field
                    const songs = data[key] || [];
                    let recordingsCount = 0;
                    allSongs.forEach(song => {
                        if (song.recordings && Array.isArray(song.recordings)) {
                            song.recordings.forEach(rec => {
                                if (rec.personalities) {
                                    const recPersonalities = rec.personalities.split(',').map(p => p.trim());
                                    if (recPersonalities.includes(key)) {
                                        recordingsCount++;
                                    }
                                }
                            });
                        }
                    });

                    // Count shaychus (songs where mechaber is in personalities but not main mechaber)
                    const songIndicesSet = new Set(songs);
                    const shaychusCount = allSongs.filter((song, idx) => {
                        if (songIndicesSet.has(idx)) return false;
                        if (!song.personalities) return false;
                        return song.personalities.split(',').map(p => p.trim()).includes(key);
                    }).length;

                    let titleHtml;
                    if (info.gerufen) {
                        const knownParts = [info.gerufen, info.platz, info.suffix].filter(Boolean);
                        const knownName = knownParts.join(' ');
                        titleHtml = `<span class="card-mechaber-formal">${formalName}</span><span class="card-mechaber-known">${knownName}</span>`;
                    } else {
                        const fullNameParts = [info.title, info.firstName, info.lastName, info.platz, info.suffix].filter(Boolean);
                        const fullName = fullNameParts.length > 0 ? fullNameParts.join(' ') : key;
                        titleHtml = `<span class="card-mechaber-known">${fullName}</span>`;
                    }

                    return `
                <a class="category-card ${hasImage ? 'has-image' : ''}" href="#/${categoryKey}/${encodeURIComponent(itemId)}" data-action="detail" data-category="${categoryKey}" data-name="${escapeHtml(key)}">
                    <div class="card-header">
                        ${hasImage ? `
                            <img class="card-image" src="${info.image}" alt="${key}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="card-icon" style="display:none;">${icon}</div>
                        ` : `
                            <div class="card-icon">${icon}</div>
                        `}
                        <div class="card-header-text">
                            <div class="card-title">${titleHtml}</div>
                            ${dateStr ? `<div class="card-years">${dateStr}</div>` : ''}
                            ${chatzeros.length > 0 ? `
                                <div class="card-tags">
                                    ${chatzeros.map(chatzer => {
                        return `<span class="card-chatzer-tag"
                                              data-action="detail"
                                              data-category="chatzeros"
                                              data-name="${escapeHtml(chatzer)}"
                                              onclick="event.stopPropagation(); event.preventDefault(); navigateToDetail('chatzeros', '${escapeHtml(chatzer).replace(/'/g, "\\'")}');"
                                              data-tooltip-value="${escapeHtml(chatzer)}"
                                              data-tooltip-type="chatzer">${chatzer}</span>`;
                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="card-stats">
                        <span class="card-stat"><span class="card-stat-icon">🎵</span>${pluralize(songCount, 'ניגון', 'ניגונים')}</span>
                        ${recordingsCount > 0 ? `<span class="card-stat"><span class="card-stat-icon">🎧</span>${recordingsCount} רעקארדינג</span>` : ''}
                        ${shaychusCount > 0 ? `<span class="card-stat"><span class="card-stat-icon">🔗</span>${shaychusCount} שייכות</span>` : ''}
                    </div>
                </a>
            `;
                }

                // Count albums and documents for chatzeros
                let albumsCount = 0;
                let documentsCount = 0;
                if (categoryKey === 'chatzeros') {
                    albumsCount = info.albums?.length || 0;
                    documentsCount = info.documents?.length || 0;
                }

                // Default layout for other categories (chatzer, verter, zman - mechaber-like style)
                return `
                <a class="category-card ${hasImage ? 'has-image' : ''}" href="#/${categoryKey}/${encodeURIComponent(itemId)}" data-action="detail" data-category="${categoryKey}" data-name="${escapeHtml(key)}">
                    <div class="card-header">
                        <div class="card-header-text">
                            <div class="card-title">${key}</div>
                        </div>
                    </div>
                    <div class="card-stats">
                        ${categoryKey === 'chatzeros' && mechabrimCount > 0 ? `<span class="card-stat">${pluralize(mechabrimCount, 'מחבר', 'מחברים')}</span>` : ''}
                        <span class="card-stat">${pluralize(songCount, 'ניגון', 'ניגונים')}</span>
                        ${categoryKey === 'chatzeros' && albumsCount > 0 ? `<span class="card-stat">${pluralize(albumsCount, 'אלבום', 'אלבומס')}</span>` : ''}
                        ${categoryKey === 'chatzeros' && documentsCount > 0 ? `<span class="card-stat">${pluralize(documentsCount, 'דאקומענט', 'דאקומענטן')}</span>` : ''}
                    </div>
                </a>
                `;
            }

            // Update category page cards incrementally (when categories grow as songs load)
            function updateCategoryPageCards() {
                const grid = document.getElementById('categoryGrid');
                if (!grid) return;

                const categoryKey = currentPageView;
                const data = categories[categoryKey];
                if (!data) return;

                // For mechabrim/chatzeros/verter in list mode, use the filter/render function which handles the list layout
                if ((categoryKey === 'mechabrim' || categoryKey === 'chatzeros' || categoryKey === 'verter') && categoryDisplayModes[categoryKey] === 'list') {
                    filterAndRenderCategoryGrid();
                    return;
                }

                const sortedKeys = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));

                // Get existing card keys
                const existingKeys = new Set();
                grid.querySelectorAll('.category-card').forEach(card => {
                    const key = card.dataset.name;
                    if (key) existingKeys.add(key);
                });

                // Find new keys that don't have cards yet
                const newKeys = sortedKeys.filter(key => !existingKeys.has(key));
                if (newKeys.length === 0) return;

                // Get info object and icon for this category
                let infoObj = {};
                let icon = '';
                switch (categoryKey) {
                    case 'chatzeros': infoObj = chatzerosInfo; icon = '🏛️'; break;
                    case 'mechabrim': infoObj = mechabrimInfo; icon = '✍️'; break;
                    case 'verter': infoObj = verterInfo; icon = '📝'; break;
                    case 'zmanim': infoObj = Object.assign({}, zmaninInfo, piyutimInfo); icon = '📅'; break;
                    case 'collections': infoObj = collectionsInfo; icon = '📚'; break;
                }

                // Add new cards
                const html = newKeys.map(key => renderCategoryCard(key, categoryKey, icon, infoObj, data)).join('');
                grid.insertAdjacentHTML('beforeend', html);

                // Animate new cards
                const newCards = Array.from(grid.children).slice(-newKeys.length);
                newCards.forEach((card, i) => {
                    card.style.animationDelay = `${i * 0.03}s`;
                    card.classList.add('card-pop-in');
                });

                // Update count in header
                const countEl = document.querySelector('.subtitle-count');
                if (countEl) {
                    const currentCount = parseInt(countEl.textContent) || 0;
                    if (sortedKeys.length > currentCount) {
                        animateCountUp(countEl, sortedKeys.length);
                    }
                }

                // Update lazy state
                categoryLazyState.allKeys = sortedKeys;

                // Show/hide wave bar based on whether all songs are loaded
                const loader = document.getElementById('categoryLoader');
                if (loader) {
                    if (songsFullyLoaded) {
                        loader.classList.remove('active');
                    } else {
                        loader.classList.add('active');
                    }
                }
            }

            // Load more category cards (lazy loading)
            function loadMoreCategoryCards(categoryKey, icon, infoObj, data) {
                // Skip if in list mode for mechabrim/chatzeros/verter (list mode renders all at once)
                if ((categoryKey === 'mechabrim' || categoryKey === 'chatzeros' || categoryKey === 'verter') && categoryDisplayModes[categoryKey] === 'list') {
                    return;
                }
                if (categoryLazyState.isLoading) return;
                if (categoryLazyState.currentIndex >= categoryLazyState.allKeys.length) return;

                categoryLazyState.isLoading = true;
                const grid = document.getElementById('categoryGrid');
                const existingCount = grid.children.length;
                const endIndex = Math.min(
                    categoryLazyState.currentIndex + categoryLazyState.batchSize,
                    categoryLazyState.allKeys.length
                );

                const batch = categoryLazyState.allKeys.slice(categoryLazyState.currentIndex, endIndex);
                const html = batch.map(key => renderCategoryCard(key, categoryKey, icon, infoObj, data)).join('');

                grid.insertAdjacentHTML('beforeend', html);
                categoryLazyState.currentIndex = endIndex;
                categoryLazyState.isLoading = false;

                // Apply animations to newly added cards
                requestAnimationFrame(() => {
                    const newCards = Array.from(grid.children).slice(existingCount);
                    newCards.forEach((card, i) => {
                        card.style.animationDelay = `${i * 0.04}s`;
                        // Use card-stagger for initial load, card-pop-in for subsequent loads
                        if (categoryLazyState.isInitialLoad) {
                            card.classList.add('card-stagger');
                        } else {
                            card.classList.add('card-pop-in');
                        }
                    });
                    // Mark initial load as complete after first batch
                    if (categoryLazyState.isInitialLoad) {
                        categoryLazyState.isInitialLoad = false;
                    }
                });

                console.log(`Loaded ${batch.length} cards (${categoryLazyState.currentIndex}/${categoryLazyState.allKeys.length})`);

                // Hide loading wave bar when all cards are loaded OR songs are fully loaded
                const allCardsLoaded = categoryLazyState.currentIndex >= categoryLazyState.allKeys.length;
                const loader = document.getElementById('categoryLoader');
                if (loader && (allCardsLoaded || songsFullyLoaded)) {
                    loader.classList.remove('active');
                }
            }

            // Render category page with lazy loading
            function renderCategoryPage(container, categoryKey, title, icon, subtitle) {
                const data = categories[categoryKey];

                // Set current category key for search/filter operations
                currentCategoryKey = categoryKey;
                categorySearchQuery = ''; // Reset search when navigating to page

                // Sort keys based on categorySortOrder for mechabrim, or alphabetically for others
                let sortedKeys;

                // Helper to parse Hebrew year to numeric value
                const parseHebrewYear = (yearStr) => {
                    if (!yearStr) return 9999;
                    const hebrewValues = {
                        'א': 1, 'ב': 2, 'ג': 3, 'ד': 4, 'ה': 5, 'ו': 6, 'ז': 7, 'ח': 8, 'ט': 9,
                        'י': 10, 'כ': 20, 'ך': 20, 'ל': 30, 'מ': 40, 'ם': 40, 'נ': 50, 'ן': 50,
                        'ס': 60, 'ע': 70, 'פ': 80, 'ף': 80, 'צ': 90, 'ץ': 90,
                        'ק': 100, 'ר': 200, 'ש': 300, 'ת': 400
                    };
                    let total = 0;
                    for (const char of yearStr) {
                        if (hebrewValues[char]) {
                            total += hebrewValues[char];
                        }
                    }
                    // Only consider it a valid year if >= 500
                    return total >= 500 ? total : 9999;
                };

                if (categoryKey === 'mechabrim') {
                    sortedKeys = Object.keys(data);
                    const sortOrder = categorySortOrders[categoryKey] || 'years';

                    if (sortOrder === 'years') {
                        // Sort by birthYear, fallback to deathYear-70, empty dates at end
                        sortedKeys = sortedKeys.sort((a, b) => {
                            const infoA = mechabrimInfo[a] || {};
                            const infoB = mechabrimInfo[b] || {};
                            let yearA = parseHebrewYear(infoA.birthYear);
                            if (yearA === 9999 && infoA.deathYear) {
                                const deathA = parseHebrewYear(infoA.deathYear);
                                if (deathA !== 9999) yearA = deathA - 70;
                            }
                            let yearB = parseHebrewYear(infoB.birthYear);
                            if (yearB === 9999 && infoB.deathYear) {
                                const deathB = parseHebrewYear(infoB.deathYear);
                                if (deathB !== 9999) yearB = deathB - 70;
                            }
                            return yearA - yearB;
                        });
                    } else if (sortOrder === 'alphabetical') {
                        sortedKeys = sortedKeys.sort((a, b) => a.localeCompare(b, 'he'));
                    } else if (sortOrder === 'songcount') {
                        sortedKeys = sortedKeys.sort((a, b) => {
                            const countA = (data[a] || []).length;
                            const countB = (data[b] || []).length;
                            return countB - countA;
                        });
                    }
                } else {
                    sortedKeys = Object.keys(data).sort((a, b) => a.localeCompare(b, 'he'));
                }

                // Reset lazy loading state
                categoryLazyState = {
                    currentIndex: 0,
                    batchSize: 50,
                    allKeys: sortedKeys,
                    isLoading: false,
                    isInitialLoad: true
                };

                // Get the right info object and theme class for this category
                let infoObj = {};
                let themeClass = '';
                switch (categoryKey) {
                    case 'chatzeros': infoObj = chatzerosInfo; themeClass = 'page-theme-chatzer'; break;
                    case 'mechabrim': infoObj = mechabrimInfo; themeClass = 'page-theme-mechaber'; break;
                    case 'verter': infoObj = verterInfo; themeClass = 'page-theme-verter'; break;
                    case 'zmanim': infoObj = Object.assign({}, zmaninInfo, piyutimInfo); themeClass = 'page-theme-zman'; break;
                    case 'collections': infoObj = collectionsInfo; themeClass = 'page-theme-collection'; break;
                }

                // Determine which controls to show based on category
                // mechaber/chatzer: 3 buttons (display, sort, search)
                // verter: 1 button (search only)
                let settingsBarHTML = '';
                let colsClass = '';
                if (categoryKey === 'mechabrim' || categoryKey === 'chatzeros') {
                    settingsBarHTML = getCategoryFiltersHTML(categoryKey);
                    colsClass = 'cols-3';
                } else if (categoryKey === 'verter') {
                    settingsBarHTML = getCategoryFiltersHTML(categoryKey);
                    colsClass = 'cols-3'; // Display mode + search + sort
                }

                // Check if we're coming from skeleton (skeleton-grid exists)
                const existingSkeletonGrid = container.querySelector('.skeleton-grid');
                const existingCountEl = container.querySelector('.subtitle-count');

                if (existingSkeletonGrid && existingCountEl) {
                    // Coming from skeleton - just update count and replace grid, keep header
                    animateCountUp(existingCountEl, sortedKeys.length);

                    // Add settings bar after page-title (before skeleton-grid)
                    if (settingsBarHTML) {
                        const settingsBarDiv = document.createElement('div');
                        settingsBarDiv.className = 'page-settings-bar';
                        settingsBarDiv.innerHTML = `<div class="detail-filters-group ${colsClass}">${settingsBarHTML}</div>`;
                        existingSkeletonGrid.before(settingsBarDiv);
                    }

                    // Replace skeleton-grid with category-grid
                    const categoryGrid = document.createElement('div');
                    categoryGrid.className = 'category-grid';
                    categoryGrid.id = 'categoryGrid';
                    existingSkeletonGrid.replaceWith(categoryGrid);

                    // Add load more indicator
                    const indicator = document.createElement('div');
                    indicator.id = 'loadMoreIndicator';
                    indicator.style.cssText = 'text-align: center; padding: 20px; color: var(--text-muted);';
                    categoryGrid.after(indicator);

                    // Show wave bar if large dataset
                    if (sortedKeys.length > 50) {
                        const loader = document.getElementById('categoryLoader');
                        if (loader) loader.classList.add('active');
                    }

                    // Load first batch of cards (or list if in list mode)
                    if ((categoryKey === 'mechabrim' || categoryKey === 'chatzeros' || categoryKey === 'verter') && categoryDisplayModes[categoryKey] === 'list') {
                        filterAndRenderCategoryGrid();
                    } else {
                        loadMoreCategoryCards(categoryKey, icon, infoObj, data);

                        // Setup infinite scroll for skeleton path too
                        const observer = new IntersectionObserver((entries) => {
                            if (entries[0].isIntersecting) {
                                loadMoreCategoryCards(categoryKey, icon, infoObj, data);
                            }
                        }, { rootMargin: '200px' });
                        if (indicator) observer.observe(indicator);
                    }
                } else {
                    // Fresh render - create everything
                    container.innerHTML = `
                    <div class="${themeClass}">
                        <div class="page-title">
                            <div class="page-title-bar">${title}</div>
                            <div class="subtitle"><span class="subtitle-count">0</span></div>
                            <div class="loading-wave-bar category-loader" id="categoryLoader"></div>
                        </div>

                        ${settingsBarHTML ? `
                        <div class="page-settings-bar">
                            <div class="detail-filters-group ${colsClass}">
                                ${settingsBarHTML}
                            </div>
                        </div>
                        ` : ''}

                        <div class="category-grid" id="categoryGrid">
                        </div>
                        <div id="loadMoreIndicator" style="text-align: center; padding: 20px; color: var(--text-muted);"></div>
                    </div>
                `;

                    // Animate subtitle count
                    const countEl = container.querySelector('.subtitle-count');
                    if (countEl) animateCountUp(countEl, sortedKeys.length);
                }

                // Show loading wave bar
                const loader = document.getElementById('categoryLoader');
                if (loader && sortedKeys.length > 50) {
                    loader.classList.add('active');
                }

                // Load first batch (or list if in list mode)
                if ((categoryKey === 'mechabrim' || categoryKey === 'chatzeros' || categoryKey === 'verter') && categoryDisplayModes[categoryKey] === 'list') {
                    filterAndRenderCategoryGrid();
                } else {
                    loadMoreCategoryCards(categoryKey, icon, infoObj, data);

                    // Setup infinite scroll
                    const observer = new IntersectionObserver((entries) => {
                        if (entries[0].isIntersecting) {
                            loadMoreCategoryCards(categoryKey, icon, infoObj, data);
                        }
                    }, { rootMargin: '200px' });

                    const indicator = document.getElementById('loadMoreIndicator');
                    if (indicator) observer.observe(indicator);
                }
            }

            // Render resources page
            function renderResourcesPage(container) {
                const allKeys = Object.keys(resourcesInfo);

                // Group by sort type
                const groups = {};
                allKeys.forEach(key => {
                    const info = resourcesInfo[key] || {};
                    const sortType = (info.sort || info.allData?.['סארט'] || 'אנדערע').replace(/\`\`\`/g, '').trim();
                    if (!groups[sortType]) groups[sortType] = [];
                    groups[sortType].push({ key, info });
                });

                // Sort groups and items within groups
                const sortedGroupNames = Object.keys(groups).sort((a, b) => {
                    if (a === 'אנדערע') return 1;
                    if (b === 'אנדערע') return -1;
                    return a.localeCompare(b, 'he');
                });

                let html = `
                <div class="page-theme-resource">
                    <div class="page-title">
                        <div class="page-title-bar">רעסורסן</div>
                        <div class="subtitle"><span class="subtitle-count">0</span></div>
                        <div class="loading-wave-bar active" id="resourceLoader"></div>
                    </div>
            `;

                sortedGroupNames.forEach(groupName => {
                    const items = groups[groupName].sort((a, b) => a.key.localeCompare(b.key, 'he'));

                    html += `
                    <div class="category-group">
                        <div class="category-group-header resource-group-header">
                            <span class="category-group-title">${groupName}</span>
                            <span class="category-group-count">${items.length}</span>
                        </div>
                        <div class="resources-grid">
                `;

                    items.forEach(({ key, info }) => {
                        // Extract link from various formats
                        let linkUrl = info.link;
                        if (!linkUrl && info.allData) {
                            const linkData = info.allData['לינק / נאמבער'] || info.allData['לינק'];
                            if (linkData) {
                                const urlMatch = linkData.match(/https?:\/\/[^\s\)]+/);
                                if (urlMatch) linkUrl = urlMatch[0];
                            }
                        }
                        const hasLink = linkUrl && linkUrl.startsWith('http');
                        const linkText = info.allData?.['לינק / נאמבער'] || '';
                        const isPhone = linkText && !linkText.includes('http') && linkText.match(/\d{3}/);
                        const phoneNumber = isPhone ? linkText.replace(/\`\`\`/g, '').trim() : '';

                        html += `
                        <div class="resource-card">
                            <div class="resource-card-header clickable-header" data-action="detail" data-category="resources" data-name="${escapeHtml(key)}">
                                <div class="resource-sort-label">${groupName}</div>
                            </div>
                            <div class="resource-card-body">
                                <div class="resource-title clickable-title" data-action="detail" data-category="resources" data-name="${escapeHtml(key)}">${key}</div>
                                ${info.chatzer ? `<div class="resource-chatzer"><span class="chatzer-tag" data-action="detail" data-category="chatzeros" data-name="${escapeHtml(info.chatzer)}" data-tooltip-value="${escapeHtml(info.chatzer)}" data-tooltip-type="chatzer">${info.chatzer}</span></div>` : ''}
                                ${info.description ? `<div class="resource-details">${formatDescription(info.description)}</div>` : ''}
                                ${info.notes ? `<div class="resource-notes">${formatDescription(info.notes)}</div>` : ''}
                            </div>
                            <div class="resource-card-footer">
                                ${hasLink ? `
                                    <a href="${linkUrl}" target="_blank" class="resource-link-btn">
                                        עפן לינק
                                    </a>
                                ` : isPhone ? `
                                    <div class="resource-phone-number">${phoneNumber}</div>
                                ` : '<div class="resource-btn-placeholder"></div>'}
                            </div>
                        </div>
                    `;
                    });

                    html += `
                        </div>
                    </div>
                `;
                });

                html += `</div>`;
                container.innerHTML = html;

                const countEl = container.querySelector('.subtitle-count');
                if (countEl) animateCountUp(countEl, allKeys.length);

                // Hide loading wave bar
                const loader = document.getElementById('resourceLoader');
                if (loader) setTimeout(() => loader.classList.remove('active'), 500);
            }

            // Render documents page
            function renderDocumentsPage(container) {
                const allKeys = Object.keys(documentsInfo);

                // Group by sort type
                const groups = {};
                allKeys.forEach(key => {
                    const info = documentsInfo[key] || {};
                    const sortType = (info.allData?.['סארט'] || info.sort || 'אנדערע').replace(/\`\`\`/g, '').trim();
                    if (!groups[sortType]) groups[sortType] = [];
                    groups[sortType].push({ key, info });
                });

                // Sort groups
                const sortedGroupNames = Object.keys(groups).sort((a, b) => {
                    if (a === 'אנדערע') return 1;
                    if (b === 'אנדערע') return -1;
                    return a.localeCompare(b, 'he');
                });

                let html = `
                <div class="page-theme-document">
                    <div class="page-title">
                        <div class="page-title-bar">דאקומענטן</div>
                        <div class="subtitle"><span class="subtitle-count">0</span></div>
                        <div class="loading-wave-bar active" id="documentLoader"></div>
                    </div>
            `;

                sortedGroupNames.forEach(groupName => {
                    const items = groups[groupName].sort((a, b) => a.key.localeCompare(b.key, 'he'));

                    html += `
                    <div class="category-group">
                        <div class="category-group-header document-group-header">
                            <span class="category-group-title">${groupName}</span>
                            <span class="category-group-count">${items.length}</span>
                        </div>
                        <div class="documents-grid">
                `;

                    items.forEach(({ key, info }) => {
                        const hasFile = info.file && info.file.startsWith('http');
                        const hasLink = info.link && info.link.startsWith('http');
                        const previewUrl = hasFile ? `https://docs.google.com/viewer?url=${encodeURIComponent(info.file)}&embedded=true` : '';

                        html += `
                        <div class="document-card">
                            <div class="document-card-header clickable-header" data-action="detail" data-category="documents" data-name="${escapeHtml(key)}">
                                <div class="document-sort-label">${groupName}</div>
                            </div>
                            ${hasFile ? `
                                <div class="document-preview">
                                    <iframe class="document-preview-frame" data-src="${previewUrl}" loading="lazy"></iframe>
                                    <div class="document-preview-overlay" onclick="openPdfPopup('${encodeURIComponent(info.file)}', '${encodeURIComponent(key)}')">
                                        <span class="preview-expand-icon">🔍</span>
                                    </div>
                                </div>
                            ` : ''}
                            <div class="document-card-body">
                                <div class="document-title clickable-title" data-action="detail" data-category="documents" data-name="${escapeHtml(key)}">${key}</div>
                                ${info.serie ? `<div class="document-serie">${info.serie.replace(/\`\`\`/g, '')}</div>` : ''}
                                ${info.chatzer ? `<div class="document-chatzer"><span class="chatzer-tag" data-action="detail" data-category="chatzeros" data-name="${escapeHtml(info.chatzer)}" data-tooltip-value="${escapeHtml(info.chatzer)}" data-tooltip-type="chatzer">${info.chatzer}</span></div>` : ''}
                                ${info.description ? `<div class="document-details">${formatDescription(info.description)}</div>` : ''}
                                ${info.notes ? `<div class="document-notes">${formatDescription(info.notes)}</div>` : ''}
                            </div>
                            <div class="document-card-footer">
                                ${hasLink ? `
                                    <a href="${info.link}" target="_blank" class="document-link-btn">
                                        לינק
                                    </a>
                                ` : '<div class="document-btn-placeholder"></div>'}
                            </div>
                        </div>
                    `;
                    });

                    html += `
                        </div>
                    </div>
                `;
                });

                html += `</div>`;
                container.innerHTML = html;

                const countEl = container.querySelector('.subtitle-count');
                if (countEl) animateCountUp(countEl, allKeys.length);

                // Hide loading wave bar
                const loader = document.getElementById('documentLoader');
                if (loader) setTimeout(() => loader.classList.remove('active'), 500);

                // Lazy load PDF previews when they become visible
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const iframe = entry.target;
                            if (iframe.dataset.src && !iframe.src) {
                                iframe.src = iframe.dataset.src;
                            }
                            observer.unobserve(iframe);
                        }
                    });
                }, { rootMargin: '100px' });

                document.querySelectorAll('.document-preview-frame').forEach(iframe => {
                    observer.observe(iframe);
                });
            }

            // Render albums page
            function renderAlbumsPage(container) {
                const allKeys = Object.keys(albumsInfo);

                // Group by producer
                const groups = {};
                allKeys.forEach(key => {
                    const info = albumsInfo[key] || {};
                    const producer = (info.producer || 'אנדערע').replace(/\`\`\`/g, '').trim();
                    if (!groups[producer]) groups[producer] = [];
                    groups[producer].push({ key, info });
                });

                // Sort groups
                const sortedGroupNames = Object.keys(groups).sort((a, b) => {
                    if (a === 'אנדערע') return 1;
                    if (b === 'אנדערע') return -1;
                    return a.localeCompare(b, 'he');
                });

                let html = `
                <div class="page-theme-album">
                    <div class="page-title">
                        <div class="page-title-bar">אלבומס</div>
                        <div class="subtitle"><span class="subtitle-count">0</span></div>
                        <div class="loading-wave-bar active" id="albumLoader"></div>
                    </div>
            `;

                sortedGroupNames.forEach(groupName => {
                    const items = groups[groupName].sort((a, b) => a.key.localeCompare(b.key, 'he'));

                    html += `
                    <div class="category-group">
                        <div class="category-group-header album-group-header">
                            <span class="category-group-title">${groupName}</span>
                            <span class="category-group-count">${items.length}</span>
                        </div>
                        <div class="albums-grid">
                `;

                    items.forEach(({ key, info }) => {
                        const hasImage = info.cover || info.image;
                        const coverUrl = info.cover || info.image;
                        const hasBooklet = info.booklet && info.booklet.startsWith('http');
                        const hasBuyLink = info.whereToBuy && info.whereToBuy.startsWith('http');
                        const serie = info.serie?.replace(/\`\`\`/g, '') || '';
                        const notes = info.notes?.replace(/\`\`\`/g, '') || '';

                        html += `
                        <div class="album-card ${hasImage ? 'has-cover' : ''}">
                            <div class="album-card-header clickable-header" data-action="detail" data-category="albums" data-name="${escapeHtml(key)}">
                                <div class="album-producer-label">${groupName}</div>
                            </div>
                            ${hasImage ? `
                                <img class="album-cover clickable-cover" src="${coverUrl}" alt="${key}" data-action="detail" data-category="albums" data-name="${escapeHtml(key)}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="album-cover-placeholder clickable-cover" style="display:none;" data-action="detail" data-category="albums" data-name="${escapeHtml(key)}">♪</div>
                            ` : `
                                <div class="album-cover-placeholder clickable-cover" data-action="detail" data-category="albums" data-name="${escapeHtml(key)}">♪</div>
                            `}
                            <div class="album-info">
                                <div class="album-title clickable-title" data-action="detail" data-category="albums" data-name="${escapeHtml(key)}">${key}</div>
                                ${info.chatzer ? `<div class="album-chatzer"><span class="chatzer-tag" data-action="detail" data-category="chatzeros" data-name="${escapeHtml(info.chatzer)}" data-tooltip-value="${escapeHtml(info.chatzer)}" data-tooltip-type="chatzer">${info.chatzer}</span></div>` : ''}
                                ${serie ? `<div class="album-serie">${formatDescription(serie)}</div>` : ''}
                                ${info.year ? `<div class="album-year">שנת ${info.year}</div>` : ''}
                                ${notes ? `<div class="album-notes">${formatDescription(notes)}</div>` : ''}
                            </div>
                            <div class="album-actions">
                                ${hasBooklet ? `
                                    <button class="album-booklet-btn" onclick="openPdfPopup('${encodeURIComponent(info.booklet)}', '${encodeURIComponent(key + ' - בוקלעט')}')">
                                        בוקלעט
                                    </button>
                                ` : '<div class="album-btn-placeholder"></div>'}
                                ${hasBuyLink ? `
                                    <a href="${info.whereToBuy}" target="_blank" class="album-buy-btn">
                                        צו באקומען
                                    </a>
                                ` : '<div class="album-btn-placeholder"></div>'}
                            </div>
                        </div>
                    `;
                    });

                    html += `
                        </div>
                    </div>
                `;
                });

                html += `</div>`;
                container.innerHTML = html;

                const countEl = container.querySelector('.subtitle-count');
                if (countEl) animateCountUp(countEl, allKeys.length);

                // Hide loading wave bar
                const loader = document.getElementById('albumLoader');
                if (loader) setTimeout(() => loader.classList.remove('active'), 500);
            }

            // Render album detail page
            function renderAlbumDetailPage(container, albumName) {
                const trimmedName = albumName.trim();
                const info = albumsInfo[trimmedName] || albumsInfo[albumName] || {};
                const hasImage = info.cover || info.image;
                const coverUrl = info.cover || info.image;
                const hasBooklet = info.booklet && info.booklet.startsWith('http');
                const hasBuyLink = info.whereToBuy && info.whereToBuy.startsWith('http');
                const producer = info.producer?.replace(/\`\`\`/g, '') || '';

                // Find nigunim that reference this album
                const relatedNigunim = allSongs.filter(song =>
                    song.albums && song.albums.split(',').map(a => a.trim()).includes(albumName)
                );

                container.innerHTML = `
                <div class="detail-page page-theme-album">
                    <button class="back-button" onclick="navigateTo('albums')">
                        → אלבומס
                    </button>
                    
                    <div class="detail-header">
                        <div class="detail-category-bar" style="background: var(--color-album);">אלבום</div>
                        <div class="detail-header-content ${hasImage ? '' : 'no-image'}">
                            ${hasImage ? `<img class="detail-image" src="${coverUrl}" alt="${albumName}">` : ''}
                            <div class="detail-header-text">
                                <h1 class="detail-title" style="color: var(--color-album-dark);">${albumName}</h1>
                                ${producer ? `<div class="detail-subtitle">${formatDescription(producer)}</div>` : ''}
                                ${info.chatzer ? `<div class="detail-chatzer"><span class="chatzer-tag" data-action="detail" data-category="chatzeros" data-name="${escapeHtml(info.chatzer)}">${info.chatzer}</span></div>` : ''}
                                ${info.year ? `<div class="detail-year">שנת ${info.year}</div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${info.description || info.notes ? `
                        <div class="detail-section">
                            <h3>אינפארמאציע</h3>
                            <p>${formatDescription(info.description || info.notes || '')}</p>
                        </div>
                    ` : ''}
                    
                    ${(hasBooklet || hasBuyLink) ? `
                        <div class="detail-actions">
                            ${hasBooklet ? `
                                <button class="detail-action-btn album-booklet-btn" onclick="openPdfPopup('${encodeURIComponent(info.booklet)}', '${encodeURIComponent(albumName + ' - בוקלעט')}')">
                                    📄 בוקלעט
                                </button>
                            ` : ''}
                            ${hasBuyLink ? `
                                <a href="${info.whereToBuy}" target="_blank" class="detail-action-btn album-buy-btn">
                                    🛒 צו באקומען
                                </a>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
            }

            // Render document detail page
            function renderDocumentDetailPage(container, docName) {
                // Trim the name to handle leading/trailing spaces
                const trimmedName = docName.trim();
                const info = documentsInfo[trimmedName] || documentsInfo[docName] || {};


                // Try to get file URL from multiple sources
                let fileUrl = info.file;
                if (!fileUrl && info.allData) {
                    fileUrl = extractUrl(info.allData['פייל']) || extractUrl(info.allData['file']);
                }

                // Try to get link URL from multiple sources
                let linkUrl = info.link;
                if (!linkUrl && info.allData) {
                    linkUrl = extractUrl(info.allData['לינק']) || extractUrl(info.allData['link']);
                }

                const hasFile = fileUrl && fileUrl.startsWith('http');
                const hasLink = linkUrl && linkUrl.startsWith('http');
                const sortType = (info.allData?.['סארט'] || info.sort || '').replace(/\`\`\`/g, '');

                // Find nigunim that reference this document
                const relatedNigunim = allSongs.filter(song =>
                    song.documents && song.documents.split(',').map(d => d.trim()).includes(docName)
                );

                container.innerHTML = `
                <div class="detail-page page-theme-document">
                    <button class="back-button" onclick="navigateTo('documents')">
                        → דאקומענטן
                    </button>
                    
                    <div class="detail-header">
                        <div class="detail-category-bar" style="background: var(--color-document);">דאקומענט</div>
                        <div class="detail-header-content no-image">
                            <div class="detail-header-text">
                                <h1 class="detail-title" style="color: var(--color-document-dark);">${docName}</h1>
                                ${sortType ? `<div class="detail-type-badge" style="background: var(--color-document-pale); color: var(--color-document-dark);">${sortType}</div>` : ''}
                                ${info.serie ? `<div class="detail-subtitle">${formatDescription(info.serie.replace(/\`\`\`/g, ''))}</div>` : ''}
                                ${info.chatzer ? `<div class="detail-chatzer"><span class="chatzer-tag" data-action="detail" data-category="chatzeros" data-name="${escapeHtml(info.chatzer)}">${info.chatzer}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${hasFile ? `
                        <div class="detail-pdf-preview">
                            <iframe src="https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true" style="width:100%; height:500px; border:none; border-radius:10px;"></iframe>
                        </div>
                    ` : ''}
                    
                    ${info.description ? `
                        <div class="detail-section">
                            <h3>אינפארמאציע</h3>
                            <p>${formatDescription(info.description)}</p>
                        </div>
                    ` : ''}
                    
                    ${(hasFile || hasLink) ? `
                        <div class="detail-actions">
                            ${hasFile ? `
                                <button class="detail-action-btn document-pdf-btn" onclick="openPdfPopup('${encodeURIComponent(fileUrl)}', '${encodeURIComponent(docName)}')">
                                    📄 עפן PDF
                                </button>
                            ` : ''}
                            ${hasLink ? `
                                <a href="${linkUrl}" target="_blank" class="detail-action-btn document-link-btn">
                                    🔗 לינק
                                </a>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${relatedNigunim.length > 0 ? `
                        <div class="detail-section">
                            <h3>פארבונדענע ניגונים (${relatedNigunim.length})</h3>
                            <div class="songs-card">
                                <div class="all-songs-grid">
                                    ${(() => {
                            const playlistIndices = relatedNigunim.map(song => allSongs.indexOf(song));
                            return relatedNigunim.map((song, idx) => {
                                const globalIdx = allSongs.indexOf(song);
                                return renderSongItem(song, globalIdx, idx + 1, playlistIndices, { forceMinimal: true });
                            }).join('');
                        })()}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            }

            // Render resource detail page
            function renderResourceDetailPage(container, resourceName) {
                const trimmedName = resourceName.trim();
                const info = resourcesInfo[trimmedName] || resourcesInfo[resourceName] || {};
                let linkUrl = info.link;
                if (!linkUrl && info.allData) {
                    const linkData = info.allData['לינק / נאמבער'] || info.allData['לינק'];
                    if (linkData) {
                        const urlMatch = linkData.match(/https?:\/\/[^\s\)]+/);
                        if (urlMatch) linkUrl = urlMatch[0];
                    }
                }
                const hasLink = linkUrl && linkUrl.startsWith('http');
                const linkText = info.allData?.['לינק / נאמבער'] || '';
                const isPhone = linkText && !linkText.includes('http') && linkText.match(/\d{3}/);
                const sortType = (info.sort || info.allData?.['סארט'] || '').replace(/\`\`\`/g, '');

                // Find nigunim that reference this resource
                const relatedNigunim = allSongs.filter(song =>
                    song.resources && song.resources.split(',').map(r => r.trim()).includes(resourceName)
                );

                container.innerHTML = `
                <div class="detail-page page-theme-resource">
                    <button class="back-button" onclick="navigateTo('resources')">
                        → רעסורסן
                    </button>
                    
                    <div class="detail-header">
                        <div class="detail-category-bar" style="background: var(--color-resource);">רעסורס</div>
                        <div class="detail-header-content no-image">
                            <div class="detail-header-text">
                                <h1 class="detail-title" style="color: var(--color-resource-dark);">${resourceName}</h1>
                                ${sortType ? `<div class="detail-type-badge" style="background: var(--color-resource-pale); color: var(--color-resource-dark);">${sortType}</div>` : ''}
                                ${info.chatzer ? `<div class="detail-chatzer"><span class="chatzer-tag" data-action="detail" data-category="chatzeros" data-name="${escapeHtml(info.chatzer)}">${info.chatzer}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${info.description ? `
                        <div class="detail-section">
                            <h3>אינפארמאציע</h3>
                            <p>${formatDescription(info.description)}</p>
                        </div>
                    ` : ''}
                    
                    ${isPhone ? `
                        <div class="detail-section">
                            <h3>טעלעפאן נומער</h3>
                            <div class="resource-phone-display">${linkText.replace(/\`\`\`/g, '')}</div>
                        </div>
                    ` : ''}
                    
                    ${hasLink ? `
                        <div class="detail-actions">
                            <a href="${linkUrl}" target="_blank" class="detail-action-btn resource-link-btn">
                                🔗 עפן לינק
                            </a>
                        </div>
                    ` : ''}
                    
                    ${relatedNigunim.length > 0 ? `
                        <div class="detail-section">
                            <h3>פארבונדענע ניגונים (${relatedNigunim.length})</h3>
                            <div class="songs-card">
                                <div class="all-songs-grid">
                                    ${(() => {
                            const playlistIndices = relatedNigunim.map(song => allSongs.indexOf(song));
                            return relatedNigunim.map((song, idx) => {
                                const globalIdx = allSongs.indexOf(song);
                                return renderSongItem(song, globalIdx, idx + 1, playlistIndices, { forceMinimal: true });
                            }).join('');
                        })()}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            }

            // Toggle category card - no longer needed but keep for compatibility
            function toggleCategoryCard(encodedKey, categoryKey) {
                navigateToDetail(categoryKey, encodedKey);
            }

            // Hover tooltip functionality
            const hoverTooltip = document.getElementById('hoverTooltip');
            let tooltipTimeout = null;
            let showTooltipTimeout = null;

            function showTooltip(event, value, fieldType) {
                // Tooltips disabled - preview modals now serve this purpose
                return;
            }

            function performShowTooltip(event, value, fieldType) {

                const tooltip = hoverTooltip;
                const typeEl = document.getElementById('tooltipType');
                const titleEl = document.getElementById('tooltipTitle');
                const imageEl = document.getElementById('tooltipImage');
                const subtitleEl = document.getElementById('tooltipSubtitle');
                const statsEl = document.getElementById('tooltipStats');

                // Remove all theme classes first
                tooltip.classList.remove('tooltip-chatzer', 'tooltip-mechaber', 'tooltip-verter', 'tooltip-zman', 'tooltip-piyut', 'tooltip-collection');

                // Get info based on field type
                let categoryKey = '';
                let typeName = '';
                let extraInfo = null;
                let themeClass = '';

                switch (fieldType) {
                    case 'mechaber':
                        categoryKey = 'mechabrim';
                        typeName = 'מחבר';
                        extraInfo = mechabrimInfo[value];
                        themeClass = 'tooltip-mechaber';
                        break;
                    case 'chatzer':
                        categoryKey = 'chatzeros';
                        typeName = 'חצר';
                        extraInfo = chatzerosInfo[value];
                        themeClass = 'tooltip-chatzer';
                        break;
                    case 'verter':
                        categoryKey = 'verter';
                        typeName = 'ווערטער';
                        extraInfo = verterInfo[value];
                        themeClass = 'tooltip-verter';
                        break;
                    case 'zman':
                        // Check if it's a piyut or zman
                        if (piyutimInfo[value]) {
                            categoryKey = 'piyutim';
                            typeName = 'פיוט';
                            extraInfo = piyutimInfo[value];
                            themeClass = 'tooltip-piyut';
                        } else {
                            categoryKey = 'zmanim';
                            typeName = 'זמן';
                            extraInfo = zmaninInfo[value];
                            themeClass = 'tooltip-zman';
                        }
                        break;
                    case 'piyut':
                        categoryKey = 'piyutim';
                        typeName = 'פיוט';
                        extraInfo = piyutimInfo[value];
                        themeClass = 'tooltip-piyut';
                        break;
                    case 'collection':
                        categoryKey = 'collections';
                        typeName = 'קאלעקשן';
                        extraInfo = collectionsInfo[value];
                        themeClass = 'tooltip-collection';
                        break;
                }

                // Add theme class
                if (themeClass) {
                    tooltip.classList.add(themeClass);
                }

                // Set type label
                typeEl.textContent = typeName;

                // For mechaber, build full name
                let displayName = value;
                if (fieldType === 'mechaber' && extraInfo) {
                    const nameParts = [extraInfo.title, extraInfo.firstName, extraInfo.lastName, extraInfo.suffix].filter(Boolean);
                    if (nameParts.length > 0) {
                        displayName = nameParts.join(' ');
                    }
                }
                // For verter, show the full text if available
                if (fieldType === 'verter' && extraInfo && extraInfo.fullText) {
                    displayName = extraInfo.fullText;
                }
                titleEl.textContent = displayName;

                // Handle image
                if (extraInfo && extraInfo.image) {
                    imageEl.src = extraInfo.image;
                    imageEl.style.display = 'block';
                    // Make mechaber images round
                    if (fieldType === 'mechaber') {
                        imageEl.classList.add('round');
                    } else {
                        imageEl.classList.remove('round');
                    }
                } else {
                    imageEl.style.display = 'none';
                    imageEl.classList.remove('round');
                }

                // Handle subtitle (dates for mechabrim)
                let subtitle = '';
                if (extraInfo && fieldType === 'mechaber') {
                    const birthParts = [extraInfo.birthDay, extraInfo.birthMonth, extraInfo.birthYear].filter(Boolean);
                    const deathParts = [extraInfo.deathDay, extraInfo.deathMonth, extraInfo.deathYear].filter(Boolean);
                    const birthStr = birthParts.join(' ');
                    const deathStr = deathParts.join(' ');

                    if (birthStr && deathStr) {
                        subtitle = `${birthStr} - ${deathStr}`;
                    } else if (birthStr) {
                        subtitle = `נולד: ${birthStr}`;
                    } else if (deathStr) {
                        subtitle = `נפטר: ${deathStr}`;
                    }
                }
                subtitleEl.textContent = subtitle;
                subtitleEl.style.display = subtitle ? 'block' : 'none';

                // Build stats
                const songIndices = categories[categoryKey]?.[value] || [];
                const songCount = songIndices.length;

                let statsHtml = pluralize(songCount, 'ניגון', 'ניגונים');

                // For chatzeros, count mechabrim
                if (fieldType === 'chatzer') {
                    const mechabrimCount = Object.entries(mechabrimInfo)
                        .filter(([mechName, mechInfo]) => {
                            if (!mechInfo.chatzer) return false;
                            const mechChatzeros = mechInfo.chatzer.split(',').map(c => c.trim());
                            return mechChatzeros.includes(value);
                        }).length;
                    if (mechabrimCount > 0) {
                        statsHtml = `${pluralize(mechabrimCount, 'מחבר', 'מחברים')} · ${statsHtml}`;
                    }
                }

                statsEl.textContent = statsHtml;

                // Position tooltip near mouse
                const x = event.clientX;
                const y = event.clientY;

                tooltip.style.left = `${Math.min(x + 15, window.innerWidth - 300)}px`;
                tooltip.style.top = `${Math.min(y + 15, window.innerHeight - 200)}px`;

                // Set the tooltip link based on category and value
                let tooltipHref = '#';
                let tooltipCategory = categoryKey;
                let tooltipId = value;

                // Get customId if available
                if (extraInfo && extraInfo.customId) {
                    tooltipId = extraInfo.customId;
                }

                switch (fieldType) {
                    case 'mechaber':
                        tooltipHref = `#/mechabrim/${encodeURIComponent(tooltipId)}`;
                        break;
                    case 'chatzer':
                        tooltipHref = `#/chatzeros/${encodeURIComponent(tooltipId)}`;
                        break;
                    case 'verter':
                        tooltipHref = `#/verter/${encodeURIComponent(tooltipId)}`;
                        break;
                    case 'zman':
                        if (piyutimInfo[value]) {
                            tooltipHref = `#/piyutim/${encodeURIComponent(tooltipId)}`;
                        } else {
                            tooltipHref = `#/zman/${encodeURIComponent(tooltipId)}`;
                        }
                        break;
                    case 'piyut':
                        tooltipHref = `#/piyutim/${encodeURIComponent(tooltipId)}`;
                        break;
                    case 'collection':
                        tooltipHref = `#/collections/${encodeURIComponent(tooltipId)}`;
                        break;
                }

                tooltip.href = tooltipHref;
                tooltip.dataset.tooltipCategory = tooltipCategory;
                tooltip.dataset.tooltipId = tooltipId;

                tooltip.classList.add('show');
            }

            function hideTooltip() {
                clearTimeout(showTooltipTimeout);
                tooltipTimeout = setTimeout(() => {
                    hoverTooltip.classList.remove('show');
                }, 100);
            }

            function forceHideTooltip() {
                clearTimeout(tooltipTimeout);
                clearTimeout(showTooltipTimeout);
                hoverTooltip.classList.remove('show');
            }

            // Keep tooltip visible when hovering over the tooltip itself
            hoverTooltip.addEventListener('mouseenter', () => {
                clearTimeout(tooltipTimeout);
                clearTimeout(showTooltipTimeout);
            });

            hoverTooltip.addEventListener('mouseleave', () => {
                hideTooltip();
            });

            // Handle tooltip click - navigate to detail page
            hoverTooltip.addEventListener('click', (e) => {
                e.preventDefault();
                const href = hoverTooltip.href;
                if (href && href !== '#' && href !== window.location.href) {
                    forceHideTooltip();
                    window.location.hash = href.split('#')[1] || '';
                }
            });

            // Create meta links for song items (handles multiple comma-separated values)
            // Opens preview modals using data-action="detail"
            function createMetaLinks(value, page, filterKey, entityType = null) {
                if (!value) return '';
                const values = value.split(',').map(v => v.trim()).filter(Boolean);
                const tagClass = filterKey === 'mechaber' ? 'mechaber-tag' :
                    filterKey === 'chatzer' ? 'chatzer-tag' :
                        filterKey === 'verter' ? 'verter-tag' :
                            filterKey === 'zman' ? 'zman-tag' :
                                filterKey === 'collection' ? 'collection-tag' : 'song-meta-link';
                // Map filterKey to category for detail navigation
                const categoryMap = {
                    'mechaber': 'mechabrim',
                    'chatzer': 'chatzeros',
                    'verter': 'verter',
                    'zman': 'zmanim',
                    'collection': 'collections',
                    'piyut': 'piyutim'
                };
                const category = categoryMap[filterKey] || page;
                return values.map(v => {
                    // For mechabrim, use tagName for display but keep full name for navigation
                    let displayName = v;
                    if (filterKey === 'mechaber') {
                        const { info } = findEntityByNameOrId(mechabrimInfo, v);
                        if (info && info.tagName) {
                            displayName = info.tagName;
                        }
                    }
                    return `<span class="${tagClass} song-meta-tag"
                    data-action="detail"
                    data-category="${category}"
                    data-name="${escapeHtml(v)}"
                    data-tooltip-value="${escapeHtml(v)}"
                    data-tooltip-type="${filterKey}"
                    onclick="event.stopPropagation(); navigateToDetail('${category}', '${escapeHtml(v).replace(/'/g, "\\'")}');">${displayName}</span>`;
                }).join(' ');
            }

            // Render song item - supports display modes: 'minimal', 'recordings', 'full'
            function renderSongItem(song, globalIdx, displayNum, playlistIndices = null, options = {}) {
                const isActive = globalIdx === currentSongIndex;
                const hasAudio = songHasQualityAudio(song); // Uses quality filter
                const displayMode = options.forceMinimal ? 'minimal' : (options.forceRecordingsMode ? 'recordings' : (currentDisplayMode || 'minimal'));

                // Create meta with links - using entity-specific colors
                let metaParts = [];
                if (song.mechaber && !options.hideMechaber) {
                    metaParts.push(createMetaLinks(song.mechaber, 'mechabrim', 'mechaber', 'mechaber'));
                }
                if (song.category) {
                    metaParts.push(createMetaLinks(song.category, 'chatzeros', 'chatzer', 'chatzer'));
                }

                // Clicking on song always opens details
                const clickAction = `showSongDetails(${globalIdx})`;

                // Play button action
                const playAction = playlistIndices
                    ? `playSongFromList(${globalIdx}, [${playlistIndices.join(',')}])`
                    : `playSong(${globalIdx})`;

                // Wave animation - ALWAYS in HTML, visibility controlled by CSS
                const waveHtml = '<div class="song-wave-animation"><span class="wave-bar"></span><span class="wave-bar"></span><span class="wave-bar"></span><span class="wave-bar"></span></div>';

                // === MINIMAL MODE (default) ===
                if (displayMode === 'minimal') {
                    // Determine play button state
                    let playBtnHtml = '';
                    const hasAnyRecordings = song.recordings && song.recordings.length > 0;
                    const hasQualityRecordings = hasAudio; // already checked with songHasQualityAudio

                    if (hasQualityRecordings) {
                        // Quality recordings - show play button
                        playBtnHtml = `<button class="song-play-btn-new" onclick="event.stopPropagation(); ${playAction};" data-song-idx="${globalIdx}">
                        <span class="play-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/></svg></span>
                        <span class="pause-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M9 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zM13 7v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"/></svg></span>
                    </button>`;
                    } else if (hasAnyRecordings) {
                        // Has recordings but none meet quality - show faded half-star
                        playBtnHtml = `<div class="song-play-btn-new song-btn-low-quality" title="רעקארדירונגען מיט נידעריגע קוואליטעט">
                        <span class="low-quality-icon">☆</span>
                    </div>`;
                    }
                    // No recordings = no button (playBtnHtml stays empty)

                    return `<div class="song-item ${isActive ? 'active' : ''} ${!hasAudio ? 'no-audio' : ''}" data-song-idx="${globalIdx}" onclick="${clickAction}"><div class="song-number">${displayNum}</div><div class="song-info"><div class="song-name">${formatDescription(song.name)}</div><div class="song-meta">${metaParts.join('<span class="song-meta-separator"> • </span>')}</div></div>${waveHtml}${playBtnHtml}</div>`;
                }

                if (displayMode === 'recordings') {
                    let recordingsHtml = '';
                    if (song.recordings && song.recordings.length > 0) {
                        recordingsHtml = `
                        <div class="song-item-recordings">
                            ${song.recordings.map((rec, i) => {
                            const playlistParam = playlistIndices ? `, [${playlistIndices.join(',')}]` : '';
                            const recPlayAction = `playNigunRecording(${globalIdx}, ${i}, this${playlistParam})`;
                            const recMeetsQuality = recordingMeetsQuality(rec);
                            const isRecActive = isActive && currentRecordingIndex === i;
                            const recPlayBtn = recMeetsQuality
                                ? `<button class="song-play-btn-new rec-play-btn ${isRecActive && !audioPlayer.paused ? 'playing' : ''}" onclick="event.stopPropagation(); ${recPlayAction}" data-song-idx="${globalIdx}" data-rec-idx="${i}">
                                <span class="play-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/></svg></span>
                                <span class="pause-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M9 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zM13 7v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"/></svg></span>
                            </button>`
                                : `<span class="song-play-btn-new song-btn-low-quality rec-play-btn" title="קוואליטעט נידעריג"><span class="low-quality-icon">☆</span></span>`;
                            const recRating = rec.rating ? `<span class="rec-rating-display">${'★'.repeat(rec.rating)}</span>` : '';

                            // Build tags for this recording
                            let recTags = [];
                            if (rec.album) {
                                recTags.push(`<span class="nigun-tag-inline tag-album" 
                                data-action="detail" 
                                data-category="albums" 
                                data-name="${escapeHtml(rec.album)}"
                                style="cursor:pointer;"
                                onclick="event.stopPropagation(); navigateToDetail('albums', '${escapeHtml(rec.album).replace(/'/g, "\\'")}');">${rec.album}</span>`);
                            }
                            if (rec.personalities) {
                                rec.personalities.split(',').forEach(p => {
                                    const name = p.trim();
                                    if (name) {
                                        recTags.push(`<span class="nigun-tag-inline tag-mechaber" 
                                        data-action="detail"
                                        data-category="mechabrim"
                                        data-name="${escapeHtml(name)}"
                                        style="cursor:pointer;"
                                        onclick="event.stopPropagation(); navigateToDetail('mechabrim', '${escapeHtml(name).replace(/'/g, "\\'")}');">${name}</span>`);
                                    }
                                });
                            }
                            const displayName = rec.details || ('רעקארדינג ' + (i + 1));

                            return `
                                    <div class="song-item-recording ${isRecActive ? 'active-recording' : ''} ${!recMeetsQuality ? 'low-quality-rec' : ''}" onclick="event.stopPropagation(); ${recPlayAction}" data-song-idx="${globalIdx}" data-rec-idx="${i}">
                                        <div class="song-item-rec-num">${i + 1}</div>
                                        <div class="song-item-rec-info">
                                            <div class="song-item-rec-name">${formatDescription(displayName)}</div>
                                            ${recTags.length > 0 ? `<div class="song-item-rec-tags">${recTags.join('')}</div>` : ''}
                                        </div>
                                        ${recRating}
                                        ${recPlayBtn}
                                    </div>
                                `;
                        }).join('')}
                        </div>
                    `;
                    }

                    return `
                    <div class="song-item song-item-expanded ${isActive ? 'active' : ''} ${!hasAudio ? 'no-audio' : ''}" data-song-idx="${globalIdx}" onclick="${clickAction}">
                        <div class="song-item-header">
                            <div class="song-number">${displayNum}</div>
                            <div class="song-info">
                                <div class="song-name">${formatDescription(song.name)}</div>
                                <div class="song-meta">${metaParts.join('<span style="color: var(--color-nigun-dark)"> • </span>')}</div>
                            </div>
                            ${waveHtml}
                        </div>
                        ${recordingsHtml}
                    </div>
                `;
                }

                // === FULL MODE - show all available info ===
                if (displayMode === 'full') {
                    // Build details grid with card boxes like nigun modal preview
                    let detailBoxes = [];

                    // Verter (lyrics) - card boxes
                    if (song.verter) {
                        song.verter.split(',').map(v => v.trim()).filter(Boolean).forEach(v => {
                            detailBoxes.push(`
                            <div class="nigun-detail-box box-verter" data-action="detail" data-category="verter" data-name="${escapeHtml(v)}" data-tooltip-value="${escapeHtml(v)}" data-tooltip-type="verter" onclick="event.stopPropagation(); navigateToDetail('verter', '${escapeHtml(v).replace(/'/g, "\\'")}');">
                                <div class="nigun-detail-box-header">ווערטער</div>
                                <div class="nigun-detail-box-content">${v}</div>
                            </div>
                        `);
                        });
                    }

                    // Scale - card box
                    if (song.scale) {
                        detailBoxes.push(`
                        <div class="nigun-detail-box box-scale" data-action="filter" data-page="music" data-filter-key="scale" data-value="${escapeHtml(song.scale)}" onclick="event.stopPropagation(); navigateToWithFilter('music', 'scale', '${escapeHtml(song.scale).replace(/'/g, "\\'")}');">
                            <div class="nigun-detail-box-header">סקעיל</div>
                            <div class="nigun-detail-box-content">${song.scale}</div>
                        </div>
                    `);
                    }

                    // Ritem - card box
                    if (song.ritem) {
                        detailBoxes.push(`
                        <div class="nigun-detail-box box-ritem" data-action="filter" data-page="music" data-filter-key="ritem" data-value="${escapeHtml(song.ritem)}" onclick="event.stopPropagation(); navigateToWithFilter('music', 'ritem', '${escapeHtml(song.ritem).replace(/'/g, "\\'")}');">
                            <div class="nigun-detail-box-header">ריטעם</div>
                            <div class="nigun-detail-box-content">${song.ritem}</div>
                        </div>
                    `);
                    }

                    // Pasig Oif - card boxes
                    if (song.pasigOif) {
                        song.pasigOif.split(',').map(p => p.trim()).filter(Boolean).forEach(p => {
                            detailBoxes.push(`
                            <div class="nigun-detail-box box-pasig" data-action="detail" data-category="piyutim" data-name="${escapeHtml(p)}" data-tooltip-value="${escapeHtml(p)}" data-tooltip-type="piyut" onclick="event.stopPropagation(); navigateToDetail('piyutim', '${escapeHtml(p).replace(/'/g, "\\'")}');">
                                <div class="nigun-detail-box-header">פאסיג אויף</div>
                                <div class="nigun-detail-box-content">${p}</div>
                            </div>
                        `);
                        });
                    }

                    // Collections - card boxes
                    if (song.collections) {
                        song.collections.split(',').map(c => c.trim()).filter(Boolean).forEach(c => {
                            detailBoxes.push(`
                            <div class="nigun-detail-box box-collections" data-action="detail" data-category="collections" data-name="${escapeHtml(c)}" data-tooltip-value="${escapeHtml(c)}" data-tooltip-type="collection" onclick="event.stopPropagation(); navigateToDetail('collections', '${escapeHtml(c).replace(/'/g, "\\'")}');">
                                <div class="nigun-detail-box-header">קאלעקשאנס</div>
                                <div class="nigun-detail-box-content">${c}</div>
                            </div>
                        `);
                        });
                    }

                    // Build the details grid HTML
                    const detailsGridHtml = detailBoxes.length > 0 ? `
                    <div class="nigun-details-grid song-full-grid">
                        <div class="nigun-details-row">
                            ${detailBoxes.join('')}
                        </div>
                    </div>
                ` : '';

                    // Siman bar - styled like modal
                    const simanHtml = song.siman ? `
                    <div class="nigun-detail-siman-bar">
                        <span class="nigun-detail-siman-label">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/>
                            </svg>
                        </span>
                        <span class="nigun-detail-siman-text">${formatDescription(song.siman)}</span>
                    </div>
                ` : '';

                    // Recordings section with more info
                    let recordingsHtml = '';
                    if (song.recordings && song.recordings.length > 0) {
                        const hasMultipleRecordings = song.recordings.length > 1;
                        const toggleArrow = hasMultipleRecordings ?
                            `<span class="rec-collapse-toggle" onclick="event.stopPropagation(); toggleRecordingsCollapse();" title="${recordingsCollapsed ? 'הויף אויף אלע רעקארדירונגען' : 'קלאפ צו רעקארדירונגען'}">${recordingsCollapsed ? '◀' : '▼'}</span>` : '';

                        // If collapsed and multiple recordings, show only first
                        const displayRecordings = (recordingsCollapsed && hasMultipleRecordings) ? [song.recordings[0]] : song.recordings;

                        recordingsHtml = `
                        <div class="song-full-recordings ${recordingsCollapsed ? 'collapsed' : ''}">
                            <div class="song-full-rec-title">${toggleArrow}רעקארדירונגען (${song.recordings.length})</div>
                            ${displayRecordings.map((rec, i) => {
                            const actualIndex = recordingsCollapsed && hasMultipleRecordings ? 0 : i;
                            const playlistParam = playlistIndices ? `, [${playlistIndices.join(',')}]` : '';
                            const recPlayAction = `playNigunRecording(${globalIdx}, ${actualIndex}, this${playlistParam})`;
                            // Build info tags for this recording
                            let recTags = [];
                            if (rec.album) {
                                recTags.push(`<span class="nigun-tag-inline tag-album" 
                                data-action="detail" 
                                data-category="albums" 
                                data-name="${escapeHtml(rec.album)}"
                                style="cursor:pointer;"
                                onclick="event.stopPropagation(); navigateToDetail('albums', '${escapeHtml(rec.album).replace(/'/g, "\\'")}');">${rec.album}</span>`);
                            }
                            if (rec.personalities) {
                                rec.personalities.split(',').forEach(p => {
                                    const name = p.trim();
                                    if (name) {
                                        recTags.push(`<span class="nigun-tag-inline tag-mechaber" 
                                        data-action="detail"
                                        data-category="mechabrim"
                                        data-name="${escapeHtml(name)}"
                                        style="cursor:pointer;"
                                        onclick="event.stopPropagation(); navigateToDetail('mechabrim', '${escapeHtml(name).replace(/'/g, "\\'")}');">${name}</span>`);
                                    }
                                });
                            }
                            const displayName = rec.details || ('רעקארדינג ' + (actualIndex + 1));
                            const recMeetsQuality = recordingMeetsQuality(rec);
                            const isRecActive = isActive && currentRecordingIndex === actualIndex;
                            const recPlayBtn = recMeetsQuality
                                ? `<button class="song-play-btn-new rec-play-btn ${isRecActive && !audioPlayer.paused ? 'playing' : ''}" onclick="event.stopPropagation(); ${recPlayAction}" data-song-idx="${globalIdx}" data-rec-idx="${actualIndex}">
                                <span class="play-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/></svg></span>
                                <span class="pause-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M9 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zM13 7v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"/></svg></span>
                            </button>`
                                : `<span class="song-play-btn-new song-btn-low-quality rec-play-btn" title="קוואליטעט נידעריג"><span class="low-quality-icon">☆</span></span>`;
                            const recRating = rec.rating ? `<span class="rec-rating-display">${'★'.repeat(rec.rating)}</span>` : '';
                            return `
                                    <div class="song-item-recording ${isRecActive ? 'active-recording' : ''} ${!recMeetsQuality ? 'low-quality-rec' : ''}" onclick="event.stopPropagation(); ${recPlayAction}" data-song-idx="${globalIdx}" data-rec-idx="${actualIndex}">
                                        <div class="song-item-rec-num">${actualIndex + 1}</div>
                                        <div class="song-item-rec-info">
                                            <div class="song-item-rec-name">${formatDescription(displayName)}</div>
                                            ${recTags.length > 0 ? `<div class="song-item-rec-tags">${recTags.join('')}</div>` : ''}
                                        </div>
                                        ${recRating}
                                        ${recPlayBtn}
                                    </div>
                                `;
                        }).join('')}
                        </div>
                    `;
                    }
                    // Get first mechaber for the hero profile (like modal)
                    const firstMechaber = song.mechaber ? song.mechaber.split(',')[0].trim() : null;
                    const firstMechaberInfo = firstMechaber ? mechabrimInfo[firstMechaber] : null;
                    const firstMechaberId = firstMechaberInfo?.customId || firstMechaber;

                    // Build mechaber name HTML - just use tagName
                    let mechaberNameHtml = firstMechaberInfo?.tagName || '';

                    // Build mechaber profile HTML - same as modal
                    const mechaberProfileHtml = firstMechaber ? `
                    <a class="nigun-modal-mechaber-profile" href="#/mechabrim/${encodeURIComponent(firstMechaberId)}" data-action="detail" data-category="mechabrim" data-name="${escapeHtml(firstMechaber)}" onclick="event.stopPropagation();">
                        <div class="nigun-modal-mechaber-avatar">
                            ${firstMechaberInfo?.image
                            ? `<img src="${firstMechaberInfo.image}" alt="${firstMechaber}">`
                            : `<div class="placeholder"><div class="mechaber-icon"></div></div>`
                        }
                        </div>
                        <span class="nigun-modal-mechaber-name">${mechaberNameHtml}</span>
                    </a>
                ` : '';

                    // Parse chatzeros, personalities and maure for tags row
                    const chatzeros = song.category ? song.category.split(',').map(c => c.trim()).filter(Boolean) : [];
                    const personalities = song.personalities ? song.personalities.split(',').map(p => p.trim()).filter(Boolean) : [];
                    const maureList = song.maure ? song.maure.split(',').map(m => m.trim()).filter(Boolean) : [];

                    // Build tags groups with dividers between them
                    const chatzerosHtml = chatzeros.map(chatzer => {
                        return `<a class="chatzer-tag" href="#" onclick="event.stopPropagation(); event.preventDefault(); navigateToDetail('chatzeros', '${escapeHtml(chatzer).replace(/'/g, "\\'")}');">${chatzer}</a>`;
                    }).join('');

                    const personalitiesHtml = personalities.map(p => {
                        return `<a class="personality-tag" href="#" onclick="event.stopPropagation(); event.preventDefault(); navigateToDetail('mechabrim', '${escapeHtml(p).replace(/'/g, "\\'")}');">${p}</a>`;
                    }).join('');

                    const maureHtml = maureList.map(m => `<span class="maure-tag" onclick="event.stopPropagation(); navigateToDetail('piyutim', '${escapeHtml(m).replace(/'/g, "\\'")}');">${m}</span>`).join('');

                    // Build inline tags - each group wrapped in its own container
                    const tagGroups = [];
                    if (personalitiesHtml) tagGroups.push(`<span class="song-full-tag-group">${personalitiesHtml}</span>`);
                    if (chatzerosHtml) tagGroups.push(`<span class="song-full-tag-group">${chatzerosHtml}</span>`);
                    if (maureHtml) tagGroups.push(`<span class="song-full-tag-group">${maureHtml}</span>`);
                    const centeredTagsHtml = tagGroups.length > 0 ?
                        `<div class="song-full-tags-center">${tagGroups.join('<span class="song-full-tag-divider">•</span>')}</div>` :
                        '<div class="song-full-tags-center"></div>';

                    // Build inline mechaber (not absolute positioned stripe)
                    const inlineMechaberHtml = firstMechaber ? `
                    <a class="song-full-mechaber-inline" href="#" onclick="event.stopPropagation(); event.preventDefault(); navigateToDetail('mechabrim', '${escapeHtml(firstMechaberId).replace(/'/g, "\\'")}');">
                        <div class="mechaber-avatar-small">
                            ${firstMechaberInfo?.image ? `<img src="${firstMechaberInfo.image}" alt="${escapeHtml(firstMechaber)}">` : `<div class="placeholder"><div class="mechaber-icon"></div></div>`}
                        </div>
                        <span class="mechaber-name-small">${firstMechaberInfo?.tagName || ''}</span>
                    </a>
                ` : '';

                    return `
                    <div class="song-item song-item-full ${isActive ? 'active' : ''} ${!hasAudio ? 'no-audio' : ''}" data-song-idx="${globalIdx}" onclick="${clickAction}">
                        <div class="song-item-header song-full-header">
                            <div class="song-full-title-right">
                                <div class="song-number">${displayNum}</div>
                                <div class="song-name">${formatDescription(song.name)}</div>
                            </div>
                            ${centeredTagsHtml}
                            <div class="song-full-left-section">
                                ${inlineMechaberHtml}
                                ${waveHtml}
                            </div>
                        </div>
                        <div class="song-full-body">
                            ${detailsGridHtml}
                        </div>
                        ${recordingsHtml}
                    </div>
                `;
                }

                // Fallback to minimal
                return `
                <div class="song-item ${isActive ? 'active' : ''} ${!hasAudio ? 'no-audio' : ''}" data-song-idx="${globalIdx}" onclick="${clickAction}">
                    <div class="song-number">${displayNum}</div>
                    <div class="song-info">
                        <div class="song-name">${formatDescription(song.name)}</div>
                        <div class="song-meta">${metaParts.join('<span style="color: var(--color-nigun-dark)"> • </span>')}</div>
                    </div>
                    ${waveHtml}
                    ${hasAudio ? `<button class="song-play-btn-new" onclick="event.stopPropagation(); ${playAction};" data-song-idx="${globalIdx}">
                        <span class="play-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/></svg></span>
                        <span class="pause-icon"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M9 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zM13 7v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"/></svg></span>
                    </button>` : ''}
                </div>
            `;
            }

            // Go to page
            function goToPage(page) {
                const totalPages = Math.ceil(filteredSongs.length / songsPerPage);
                if (page < 1 || page > totalPages) return;
                currentPage = page;
                renderCurrentPage();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // Show the player banner with animation (when song first plays)
            function showPlayer() {
                if (!playerVisible) {
                    playerVisible = true;
                    const playerSection = document.querySelector('.player-section');
                    playerSection.classList.add('player-visible');
                    playerSection.classList.remove('player-minimized');
                    const showBtn = document.getElementById('playerShowBtn');
                    if (showBtn) showBtn.classList.remove('visible');
                } else {
                    // Player is already visible - if minimized, expand it
                    const playerSection = document.querySelector('.player-section');
                    if (playerSection && playerSection.classList.contains('player-minimized')) {
                        showPlayerBanner();
                    }
                }
            }

            // Hide the player banner (user clicked hide button)
            function hidePlayerBanner() {
                const playerSection = document.querySelector('.player-section');

                // Keep player-visible class, just add player-minimized (CSS handles the transition)
                playerSection.classList.add('player-minimized');

                // Trigger marquee for minimized song name after transition
                setTimeout(() => {
                    triggerMinimizedMarquee();
                }, 400); // Wait for CSS transition to complete


            }

            // Trigger marquee for minimized player song name
            function triggerMinimizedMarquee() {
                const minimizedSongName = document.getElementById('minimizedSongName');
                const playerSection = document.querySelector('.player-section');
                if (!minimizedSongName || !playerSection) return;

                // Get song name from attribute
                const songName = playerSection.getAttribute('data-song-name');
                if (!songName) return;

                // Reset first
                minimizedSongName.classList.remove('marquee');
                minimizedSongName.classList.remove('running');
                minimizedSongName.textContent = songName;
                minimizedSongName.style.removeProperty('--marquee-start');
                minimizedSongName.style.removeProperty('--marquee-width');
                minimizedSongName.style.removeProperty('--marquee-duration');

                // Wait for DOM to be visible (minimized state)
                requestAnimationFrame(() => {
                    const containerWidth = minimizedSongName.clientWidth;
                    const textWidth = minimizedSongName.scrollWidth;
                    const overflow = textWidth - containerWidth;

                    if (overflow > 10) {
                        const separator = ' \u00A0\u00A0\u00A0 • \u00A0\u00A0\u00A0 ';
                        const oneUnit = songName + separator;

                        // Measure one unit
                        const tempSpan = document.createElement('span');
                        tempSpan.style.cssText = 'visibility:hidden;position:absolute;white-space:nowrap;';
                        tempSpan.style.font = getComputedStyle(minimizedSongName).font;
                        tempSpan.textContent = oneUnit;
                        document.body.appendChild(tempSpan);
                        const oneUnitWidth = tempSpan.offsetWidth;
                        tempSpan.remove();

                        // Set up marquee
                        minimizedSongName.innerHTML = '<span>' + oneUnit + oneUnit + '</span>';
                        minimizedSongName.style.setProperty('--marquee-width', oneUnitWidth + 'px');
                        const duration = Math.max(8, oneUnitWidth / 50);
                        minimizedSongName.style.setProperty('--marquee-duration', duration + 's');
                        minimizedSongName.classList.add('marquee');

                        // Calculate offset and start animation
                        requestAnimationFrame(() => {
                            const innerSpan = minimizedSongName.querySelector('span');
                            if (innerSpan) {
                                const spanRect = innerSpan.getBoundingClientRect();
                                const containerRect = minimizedSongName.getBoundingClientRect();
                                const startOffset = containerRect.right - spanRect.right;
                                minimizedSongName.style.setProperty('--marquee-start', startOffset + 'px');
                                minimizedSongName.classList.add('running');
                            }
                        });
                    }
                });
            }

            // Show the player banner (user clicked minimized player or show button)
            function showPlayerBanner() {
                const playerSection = document.querySelector('.player-section');
                playerSection.classList.remove('player-minimized');
                const showBtn = document.getElementById('playerShowBtn');
                if (showBtn) showBtn.classList.remove('visible');

                // Set grace period to prevent immediate re-collapse during animation
                playerJustExpanded = true;
                setTimeout(() => {
                    playerJustExpanded = false;
                }, 500);

                // Re-check marquee after player expands (after transition completes)
                setTimeout(() => {
                    const rightSongName = document.getElementById('playerRightSongName');
                    if (rightSongName) {
                        // Get the song name from data attribute or extract from current text
                        const playerSection = document.querySelector('.player-section');
                        const songName = playerSection?.getAttribute('data-song-name') ||
                            rightSongName.textContent.split(' \u00A0\u00A0•\u00A0\u00A0 ')[0];

                        if (songName && songName.trim()) {
                            // Reset and re-measure
                            rightSongName.classList.remove('marquee');
                            rightSongName.classList.remove('running');
                            rightSongName.textContent = songName;
                            rightSongName.style.removeProperty('--marquee-start');
                            rightSongName.style.removeProperty('--marquee-width');
                            rightSongName.style.removeProperty('--marquee-duration');

                            requestAnimationFrame(() => {
                                const containerWidth = rightSongName.clientWidth;
                                const textWidth = rightSongName.scrollWidth;
                                const overflow = textWidth - containerWidth;

                                if (overflow > 10) {
                                    const separator = ' \u00A0\u00A0\u00A0 • \u00A0\u00A0\u00A0 ';
                                    const oneUnit = songName + separator;

                                    // Measure with temp span
                                    const tempSpan = document.createElement('span');
                                    tempSpan.style.cssText = 'visibility:hidden;position:absolute;white-space:nowrap;';
                                    tempSpan.style.font = getComputedStyle(rightSongName).font;
                                    tempSpan.textContent = oneUnit;
                                    document.body.appendChild(tempSpan);
                                    const oneUnitWidth = tempSpan.offsetWidth;
                                    tempSpan.remove();

                                    // Wrap in span for animation
                                    rightSongName.innerHTML = '<span>' + oneUnit + oneUnit + '</span>';

                                    rightSongName.style.setProperty('--marquee-width', oneUnitWidth + 'px');
                                    const duration = Math.max(8, oneUnitWidth / 50);
                                    rightSongName.style.setProperty('--marquee-duration', duration + 's');
                                    rightSongName.classList.add('marquee');

                                    requestAnimationFrame(() => {
                                        const innerSpan = rightSongName.querySelector('span');
                                        if (innerSpan) {
                                            const spanRect = innerSpan.getBoundingClientRect();
                                            const containerRect = rightSongName.getBoundingClientRect();
                                            const startOffset = containerRect.right - spanRect.right;
                                            rightSongName.style.setProperty('--marquee-start', startOffset + 'px');
                                            rightSongName.classList.add('running');
                                        }
                                    });
                                }
                            });
                        }
                    }
                }, 400);
            }

            // ====== AUTO-COLLAPSE PLAYER BANNER LOGIC ======
            // Tracks when user last interacted with player
            let playerLastClickTime = 0;
            let playerLastHoverTime = 0;
            let playerAutoCollapseTimer = null;
            let playerIsHovering = false;
            let playerJustExpanded = false; // Prevents immediate re-collapse after expansion


            // Auto-collapse timer removed - player only minimizes on scroll or navigation

            // Handle click on player section (for minimized state)
            document.addEventListener('DOMContentLoaded', function () {
                const playerSection = document.querySelector('.player-section');
                if (playerSection) {
                    // Track clicks on player
                    playerSection.addEventListener('click', function (e) {
                        playerLastClickTime = Date.now();


                        // Only expand if minimized - block ALL other click actions
                        if (this.classList.contains('player-minimized')) {
                            e.preventDefault();
                            e.stopPropagation();
                            showPlayerBanner();
                        }
                    });

                    // Track hover on player - also expand if minimized (but not if hovering on play button)
                    let hoverExpandTimeout = null;
                    playerSection.addEventListener('mouseenter', function (e) {
                        playerIsHovering = true;
                        playerLastHoverTime = Date.now();
                        // Expand on hover if minimized, but NOT if hovering on the play button
                        // Use small delay so user can reach play button first
                        const minimizedPlayBtn = document.getElementById('minimizedPlayBtn');
                        if (this.classList.contains('player-minimized') && !minimizedPlayBtn?.contains(e.target)) {
                            hoverExpandTimeout = setTimeout(() => {
                                // Check again that we're not hovering on play button
                                if (!minimizedPlayBtn?.matches(':hover')) {
                                    showPlayerBanner();
                                }
                            }, 150);
                        }
                    });

                    playerSection.addEventListener('mouseleave', function () {
                        playerIsHovering = false;
                        playerLastHoverTime = Date.now();
                        // Clear hover expand timeout if user leaves before it fires
                        if (hoverExpandTimeout) {
                            clearTimeout(hoverExpandTimeout);
                            hoverExpandTimeout = null;
                        }
                    });

                    // Track any interaction inside player (buttons, sliders, etc.)
                    playerSection.addEventListener('mousedown', function () {
                        playerLastClickTime = Date.now();

                    });

                    // Prevent minimized play button hover from expanding banner
                    const minimizedPlayBtn = document.getElementById('minimizedPlayBtn');
                    if (minimizedPlayBtn) {
                        minimizedPlayBtn.addEventListener('mouseenter', function (e) {
                            e.stopPropagation();
                            // Also clear any pending expand timeout
                            if (hoverExpandTimeout) {
                                clearTimeout(hoverExpandTimeout);
                                hoverExpandTimeout = null;
                            }
                        });
                    }
                }

                // Auto-collapse on scroll (after brief delay to avoid accidental triggers)
                let scrollCollapseTimeout = null;
                window.addEventListener('scroll', function () {
                    const playerSection = document.querySelector('.player-section');
                    if (playerSection && !playerSection.classList.contains('player-minimized') && playerSection.classList.contains('player-visible')) {
                        // Clear previous timeout
                        if (scrollCollapseTimeout) clearTimeout(scrollCollapseTimeout);
                        // Collapse after 300ms of scrolling (not immediate to allow small adjustments)
                        scrollCollapseTimeout = setTimeout(function () {
                            hidePlayerBanner();
                        }, 300);
                    }
                });

                // Auto-collapse on navigation (hash change for SPA-style navigation)
                window.addEventListener('hashchange', function () {
                    const playerSection = document.querySelector('.player-section');
                    if (playerSection && !playerSection.classList.contains('player-minimized') && playerSection.classList.contains('player-visible')) {
                        hidePlayerBanner();
                    }
                });


            });

            // Play song (sets playlist if not already set)
            // Now supports fallback: if recordings not loaded, use bestRecordingRowId from index
            async function playSong(idx, playlist = null) {
                if (idx < 0 || idx >= allSongs.length) return;

                // If clicking the same song, toggle play/pause
                if (idx === currentSongIndex && audioPlayer.src) {

                    togglePlayPause();
                    return;
                }

                // Reset recordings mode when playing from song list
                isInRecordingsMode = false;
                currentRecordingIndex = 0;

                // If a playlist is provided, use it
                if (playlist && Array.isArray(playlist)) {
                    currentPlaylist = playlist;
                    currentPlaylistPosition = currentPlaylist.indexOf(idx);
                } else if (currentPlaylist.length === 0 || !currentPlaylist.includes(idx)) {
                    // If no playlist set or song not in current playlist, use filteredSongs
                    currentPlaylist = filteredSongs.map(s => allSongs.indexOf(s));
                    currentPlaylistPosition = currentPlaylist.indexOf(idx);
                } else {
                    // Song is in current playlist, just update position
                    currentPlaylistPosition = currentPlaylist.indexOf(idx);
                }

                currentSongIndex = idx;
                const song = allSongs[idx];


                // FIRST: Update song list to show wave with 'loading' state
                updateActiveSongInList();
                showPlayer();
                updatePlayerUI(song);

                // Try to play from recordings (instant if loaded)
                if (song.recordings && song.recordings.length > 0) {
                    currentPlayingRecordingInfo = {
                        songIdx: idx,
                        recordingIdx: 0,
                        slotIndex: song.recordings[0].slotIndex,
                        rowId: song.rowId,
                        tableRowId: song.recordings[0].rowId
                    };
                    audioPlayer.src = song.audioUrl || song.recordings[0].url;
                    audioPlayer.play();
                    return;
                }

                // Fallback: use bestRecordingRowId from songIndex
                if (song.bestRecordingRowId) {
                    try {
                        const recording = await IndexManager.getRecordingByRowId(song.bestRecordingRowId);
                        if (recording && recording.url) {
                            song.audioUrl = recording.url;
                            // Add to recordings array for future use
                            if (!song.recordings) song.recordings = [];
                            song.recordings.push(recording);
                            currentPlayingRecordingInfo = {
                                songIdx: idx,
                                recordingIdx: 0,
                                rowId: song.rowId,
                                tableRowId: recording.rowId
                            };
                            audioPlayer.src = recording.url;
                            audioPlayer.play();
                            return;
                        }
                    } catch (error) {
                        console.error('Error fetching recording for playback:', error);
                    }
                }

                // If we have an audioUrl (from any source), play it
                if (song.audioUrl) {
                    currentPlayingRecordingInfo = null;
                    // Reset progress bar instantly (no animation)
                    const progressBar = document.getElementById('progressBar');
                    if (progressBar) {
                        progressBar.style.transition = 'none';
                        progressBar.style.width = '0%';
                        // Restore transition after a brief moment
                        setTimeout(() => {
                            progressBar.style.transition = 'width 0.15s ease-out';
                        }, 50);
                    }
                    document.getElementById('currentTime').textContent = '0:00';
                    audioPlayer.src = song.audioUrl;
                    audioPlayer.play();
                    showPlayer();
                    updatePlayerUI(song);
                } else {

                }
            }

            // Play song from a specific playlist (detail pages)
            function playSongFromList(idx, playlistIndices) {
                // If clicking the same song, toggle play/pause
                if (idx === currentSongIndex && audioPlayer.src) {
                    togglePlayPause();
                    return;
                }
                currentPlaylist = playlistIndices;
                currentPlaylistPosition = playlistIndices.indexOf(idx);
                playSong(idx, playlistIndices);
                // Expand player when user manually selects a song from list
                showPlayerBanner();
            }

            // Play a collection from the start
            function playCollectionFromStart(collectionName) {
                const trimmedName = collectionName.trim();


                const songIndices = categories.collections[trimmedName] || categories.collections[collectionName] || [];


                if (songIndices.length === 0) {

                    return;
                }

                // Filter to only songs with audio
                const playableSongs = songIndices.filter(idx => {
                    const song = allSongs[idx];
                    return song && song.audioUrl && song.audioUrl.startsWith('http');
                });



                if (playableSongs.length === 0) {

                    return;
                }

                // Set playlist and play first song
                currentPlaylist = playableSongs;
                currentPlaylistPosition = 0;
                playSong(playableSongs[0], playableSongs);
            }

            // Play a music category (scale or ritem)
            function playMusicCategory(categoryType, categoryName) {
                const trimmedName = categoryName.trim();

                const categoryData = categoryType === 'scale' ? categories.scale : categories.ritem;
                const songIndices = categoryData[trimmedName] || categoryData[categoryName] || [];

                if (songIndices.length === 0) return;

                // Filter to only songs with audio
                const playableSongs = songIndices.filter(idx => {
                    const song = allSongs[idx];
                    return song && song.audioUrl && song.audioUrl.startsWith('http');
                });

                if (playableSongs.length === 0) return;

                // Set playlist and play first song
                currentPlaylist = playableSongs;
                currentPlaylistPosition = 0;
                playSong(playableSongs[0], playableSongs);
            }

            // Play a specific recording from a song
            function playRecording(songIdx, recordingIdx) {
                const song = allSongs[songIdx];
                if (!song || !song.recordings || !song.recordings[recordingIdx]) return;

                const recording = song.recordings[recordingIdx];

                // Update current song index and recording index
                currentSongIndex = songIdx;
                currentRecordingIndex = recordingIdx;

                // Set recording info for rating updates
                currentPlayingRecordingInfo = {
                    songIdx: songIdx,
                    recordingIdx: recordingIdx,
                    slotIndex: recording.slotIndex,
                    rowId: song.rowId,
                    tableRowId: recording.rowId // Recording's own row ID in recordings table
                };

                // Play the specific recording URL
                // Reset progress bar instantly (no animation)
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.transition = 'none';
                    progressBar.style.width = '0%';
                    setTimeout(() => { progressBar.style.transition = 'width 0.15s ease-out'; }, 50);
                }
                document.getElementById('currentTime').textContent = '0:00';

                audioPlayer.src = recording.url;
                audioPlayer.play();

                showPlayer();
                // Update player UI with song info
                updatePlayerUI(song);
                updateActiveSongInList();

                // Update rating display in player
                updatePlayerRating(recording.rating);

                // Update active state in modal
                document.querySelectorAll('.modal-recording-item').forEach((item, i) => {
                    item.classList.toggle('active', i === recordingIdx);
                });
            }

            // Create player meta links (handles multiple comma-separated values)
            // Opens preview modals using data-action="detail"
            function createPlayerMetaLinks(value, page, filterKey, entityType = null) {
                if (!value) return '';
                const values = value.split(',').map(v => v.trim()).filter(Boolean);
                // Use entity-specific class if provided, otherwise generic
                const linkClass = entityType ? `player-meta-link-${entityType}` : 'player-meta-link';
                // Map filterKey to category for detail navigation
                const categoryMap = {
                    'mechaber': 'mechabrim',
                    'chatzer': 'chatzeros',
                    'verter': 'verter',
                    'zman': 'zmanim',
                    'collection': 'collections',
                    'piyut': 'piyutim'
                };
                const category = categoryMap[filterKey] || page;
                return values.map(v =>
                    `<a href="#" class="${linkClass}"
                    data-action="detail"
                    data-category="${category}"
                    data-name="${escapeHtml(v)}"
                    data-tooltip-value="${escapeHtml(v)}"
                    data-tooltip-type="${filterKey}">${v}</a>`
                ).join(', ');
            }

            // Update player UI
            function updatePlayerUI(song) {
                const rightSongName = document.getElementById('playerRightSongName');
                rightSongName.innerHTML = formatDescription(song.name);
                // Set data attribute for minimized pill display
                document.querySelector('.player-section')?.setAttribute('data-song-name', song.name.replace(/\*\*([^*]+)\*\*/g, '$1'));

                // Update minimized player song name with marquee
                const minimizedSongName = document.getElementById('minimizedSongName');
                if (minimizedSongName) {
                    minimizedSongName.innerHTML = formatDescription(song.name);
                    // Trigger marquee with delay
                    setTimeout(() => triggerMinimizedMarquee(), 200);
                }

                // Check if text overflows and needs marquee
                setTimeout(() => {
                    // Reset first to measure properly
                    rightSongName.classList.remove('marquee');
                    rightSongName.classList.remove('running');
                    rightSongName.innerHTML = formatDescription(song.name);
                    rightSongName.style.removeProperty('--marquee-start');
                    rightSongName.style.removeProperty('--marquee-width');
                    rightSongName.style.removeProperty('--marquee-duration');

                    // Wait for DOM to update
                    requestAnimationFrame(() => {
                        const containerWidth = rightSongName.clientWidth;
                        const textWidth = rightSongName.scrollWidth;
                        const overflow = textWidth - containerWidth;

                        // Only scroll if overflow is more than 10px
                        if (overflow > 10) {
                            const separator = ' \u00A0\u00A0\u00A0 • \u00A0\u00A0\u00A0 ';
                            const cleanName = song.name.replace(/\*\*([^*]+)\*\*/g, '$1');
                            const oneUnit = cleanName + separator;

                            // Create temp element to measure one unit
                            const tempSpan = document.createElement('span');
                            tempSpan.style.cssText = 'visibility:hidden;position:absolute;white-space:nowrap;';
                            tempSpan.style.font = getComputedStyle(rightSongName).font;
                            tempSpan.textContent = oneUnit;
                            document.body.appendChild(tempSpan);
                            const oneUnitWidth = tempSpan.offsetWidth;
                            tempSpan.remove();

                            // Wrap duplicated content in span for animation
                            const formattedUnit = formatDescription(song.name) + separator;
                            rightSongName.innerHTML = '<span>' + formattedUnit + formattedUnit + '</span>';

                            // Set CSS variables
                            rightSongName.style.setProperty('--marquee-width', oneUnitWidth + 'px');
                            const duration = Math.max(8, oneUnitWidth / 50);
                            rightSongName.style.setProperty('--marquee-duration', duration + 's');

                            rightSongName.classList.add('marquee');

                            // Calculate initial offset using bounding rectangles
                            requestAnimationFrame(() => {
                                const innerSpan = rightSongName.querySelector('span');
                                if (innerSpan) {
                                    const spanRect = innerSpan.getBoundingClientRect();
                                    const containerRect = rightSongName.getBoundingClientRect();
                                    // How far is span's right edge from container's right edge?
                                    const startOffset = containerRect.right - spanRect.right;
                                    rightSongName.style.setProperty('--marquee-start', startOffset + 'px');

                                    // NOW start the animation (was paused until offset was set)
                                    rightSongName.classList.add('running');


                                }
                            });
                        }
                    });
                }, 50);

                // Update the floating button song name if player is minimized
                const playerSection = document.querySelector('.player-section');
                if (playerSection.classList.contains('player-minimized')) {
                    document.getElementById('showBtnSongName').innerHTML = formatDescription(song.name) || 'ווייז פלעיער';
                }

                // Update mechaber profile in new player info box
                const mechaberProfile = document.getElementById('playerMechaberProfile');
                const mechaberAvatar = document.getElementById('playerMechaberAvatar');
                const mechaberNameEl = document.getElementById('playerMechaberName');

                if (song.mechaber) {
                    const firstMechaber = song.mechaber.split(',')[0].trim();
                    const mechaberInfo = mechabrimInfo[firstMechaber];
                    const mechaberId = mechaberInfo?.customId || firstMechaber;

                    // Set link
                    mechaberProfile.href = `#/mechabrim/${encodeURIComponent(mechaberId)}`;
                    mechaberProfile.setAttribute('data-action', 'detail');
                    mechaberProfile.setAttribute('data-category', 'mechabrim');
                    mechaberProfile.setAttribute('data-name', firstMechaber);

                    // Set avatar
                    if (mechaberInfo?.image) {
                        mechaberAvatar.innerHTML = `<img src="${mechaberInfo.image}" alt="${firstMechaber}">`;
                    } else {
                        mechaberAvatar.innerHTML = `<div class="placeholder"><span class="mechaber-icon"></span></div>`;
                    }

                    // Set name - use tagName, fallback to raw name if mechabrimInfo not loaded yet
                    mechaberNameEl.textContent = mechaberInfo?.tagName || firstMechaber;

                    mechaberProfile.style.display = 'flex';
                    const infoBox = document.querySelector('.player-info-box');
                    if (infoBox) infoBox.classList.remove('no-mechaber');
                } else {
                    mechaberProfile.style.display = 'none';
                    const infoBox = document.querySelector('.player-info-box');
                    if (infoBox) infoBox.classList.add('no-mechaber');
                }

                // Build tags for player tags section - organized in rows
                const row1 = document.getElementById('playerTagsRow1'); // Chatzer + Gezungen
                const row2 = document.getElementById('playerTagsRow2'); // Verter + Pasig
                const row3 = document.getElementById('playerTagsRow3'); // Collections + Scale

                let row1Tags = [];
                let row2Tags = [];
                let row3Tags = [];

                // Row 1: Personalities tags (first, before chatzer)
                if (song.personalities) {
                    song.personalities.split(',').forEach(pers => {
                        const persTrim = pers.trim();
                        if (persTrim) {
                            // Find mechaber info for link
                            const mechaberInfo = mechabrimInfo[persTrim] || {};
                            const mechaberId = mechaberInfo.customId || persTrim;
                            row1Tags.push(`<a class="player-tag player-tag-personality" href="#/mechabrim/${encodeURIComponent(mechaberId)}" data-action="detail" data-category="mechabrim" data-name="${escapeHtml(persTrim)}">${persTrim}</a>`);
                        }
                    });
                }

                // Row 1: Chatzer tags (with divider if personalities exist)
                if (song.category) {
                    if (row1Tags.length > 0) {
                        row1Tags.push('<span class="player-tag-divider">•</span>');
                    }
                    song.category.split(',').forEach(chatzer => {
                        const c = chatzer.trim();
                        if (c) {
                            const chatzerInfo = chatzerosInfo[c] || {};
                            const chatzerId = chatzerInfo.customId || c;
                            row1Tags.push(`<a class="player-tag player-tag-chatzer" href="#/chatzeros/${encodeURIComponent(chatzerId)}" data-action="detail" data-category="chatzeros" data-name="${escapeHtml(c)}">${c}</a>`);
                        }
                    });
                }

                // Row 1: Gezungen tags (with divider if chatzer exists)
                if (song.gezungen) {
                    if (row1Tags.length > 0) {
                        row1Tags.push('<span class="player-tag-divider">•</span>');
                    }
                    song.gezungen.split(',').forEach(g => {
                        const gTrim = g.trim();
                        if (gTrim) {
                            row1Tags.push(`<a class="player-tag player-tag-gezungen" href="#/piyutim/${encodeURIComponent(gTrim)}" data-action="detail" data-category="piyutim" data-name="${escapeHtml(gTrim)}">${gTrim}</a>`);
                        }
                    });
                }

                // Row 2: Verter tags
                if (song.verter) {
                    song.verter.split(',').forEach(v => {
                        const vTrim = v.trim();
                        if (vTrim) {
                            row2Tags.push(`<span class="player-tag player-tag-verter">${vTrim}</span>`);
                        }
                    });
                }

                // Row 2: Pasig tags (with divider if verter exists)
                if (song.pasigOif) {
                    if (row2Tags.length > 0) {
                        row2Tags.push('<span class="player-tag-divider">•</span>');
                    }
                    song.pasigOif.split(',').forEach(p => {
                        const pTrim = p.trim();
                        if (pTrim) {
                            row2Tags.push(`<span class="player-tag player-tag-pasig">${pTrim}</span>`);
                        }
                    });
                }

                // Row 3: Collections tags
                if (song.collections) {
                    song.collections.split(',').forEach(col => {
                        const colTrim = col.trim();
                        if (colTrim) {
                            row3Tags.push(`<a class="player-tag player-tag-collection" href="#/collections/${encodeURIComponent(colTrim)}" data-action="detail" data-category="collections" data-name="${escapeHtml(colTrim)}">${colTrim}</a>`);
                        }
                    });
                }

                // Row 3: Scale tags (with divider if collections exists)
                if (song.scale) {
                    if (row3Tags.length > 0) {
                        row3Tags.push('<span class="player-tag-divider">•</span>');
                    }
                    song.scale.split(',').forEach(s => {
                        const sTrim = s.trim();
                        if (sTrim) {
                            row3Tags.push(`<span class="player-tag player-tag-scale">${sTrim}</span>`);
                        }
                    });
                }

                // Count how many rows have content
                const hasRow1 = row1Tags.length > 0;
                const hasRow2 = row2Tags.length > 0;
                const hasRow3 = row3Tags.length > 0;
                const activeRowCount = [hasRow1, hasRow2, hasRow3].filter(Boolean).length;

                // If more than 2 rows, hide verter row (row2)
                if (activeRowCount > 2 && hasRow2) {
                    row2.innerHTML = '';
                } else {
                    row2.innerHTML = row2Tags.join('');
                }

                row1.innerHTML = row1Tags.join('');
                row3.innerHTML = row3Tags.join('');

                // After rendering, calculate overflow for each row
                setTimeout(() => {
                    [row1, row2, row3].forEach(row => {
                        if (!row.innerHTML) return;

                        const maxWidth = row.offsetWidth;
                        const children = Array.from(row.children);

                        // First pass: check if all items fit
                        let totalWidth = 0;
                        children.forEach(child => {
                            totalWidth += child.offsetWidth + 6; // include gap
                        });

                        // If all fit, no need to do anything
                        if (totalWidth <= maxWidth) return;

                        // Second pass: calculate which tags fit (with space for +N)
                        totalWidth = 0;
                        let hiddenCount = 0;

                        children.forEach(child => {
                            const childWidth = child.offsetWidth + 6;
                            if (totalWidth + childWidth <= maxWidth - 35) { // reserve space for +N
                                totalWidth += childWidth;
                            } else {
                                hiddenCount++;
                                child.style.display = 'none';
                            }
                        });

                        // Add +N indicator for hidden tags
                        if (hiddenCount > 0) {
                            const overflow = document.createElement('span');
                            overflow.className = 'player-tag-overflow';
                            overflow.textContent = `+${hiddenCount}`;
                            row.appendChild(overflow);
                        }
                    });
                }, 50);

                // Keep old meta for backwards compatibility (hidden)
                let metaParts = [];
                if (song.mechaber) {
                    metaParts.push(createPlayerMetaLinks(song.mechaber, 'mechabrim', 'mechaber', 'mechaber'));
                }
                if (song.category) {
                    metaParts.push(createPlayerMetaLinks(song.category, 'chatzeros', 'chatzer', 'chatzer'));
                }
                const playerSongMeta = document.getElementById('playerSongMeta');
                if (playerSongMeta) {
                    playerSongMeta.innerHTML = metaParts.join('<span style="color: var(--color-nigun-dark)"> • </span>');
                }

                // Update rating from current recording (if in recordings mode) or first recording
                const recIdx = typeof currentRecordingIndex !== 'undefined' ? currentRecordingIndex : 0;
                const currentRec = song.recordings && song.recordings[recIdx];

                if (currentRec && currentRec.rating) {
                    updatePlayerRating(currentRec.rating);
                } else {
                    updatePlayerRating(0);
                }

                // Update carousel items with recording info
                const carouselContainer = document.getElementById('playerInfoCarousel');

                // Clear previous carousel interval
                if (window.playerCarouselInterval) {
                    clearInterval(window.playerCarouselInterval);
                    window.playerCarouselInterval = null;
                }

                if (carouselContainer) {
                    // Recording name - use details field, fallback to "רעקארדינג X"
                    let displayName = 'רעקארדינג 1';
                    let personalityText = '';
                    let albumText = '';

                    if (currentRec) {
                        displayName = currentRec.details || ('רעקארדינג ' + (recIdx + 1));

                        // Personality tag
                        if (currentRec.personalities) {
                            const firstPersonality = currentRec.personalities.split(',')[0].trim();
                            if (firstPersonality) personalityText = firstPersonality;
                        }

                        // Album tag
                        if (currentRec.album) {
                            albumText = currentRec.album.trim();
                        }
                    }

                    // Build carousel items array - split long text into chunks
                    const maxChars = 25; // carousel rotates through chunks
                    let carouselData = [];

                    // Strip markdown bold before splitting to avoid breaking **..** across chunks
                    const cleanDisplayName = displayName.replace(/\*\*([^*]+)\*\*/g, '$1');

                    // Split recording name if too long
                    if (cleanDisplayName.length > maxChars) {
                        // Split by words to avoid cutting mid-word
                        const words = cleanDisplayName.split(' ');
                        let currentChunk = '';
                        for (const word of words) {
                            if ((currentChunk + ' ' + word).trim().length <= maxChars) {
                                currentChunk = (currentChunk + ' ' + word).trim();
                            } else {
                                if (currentChunk) carouselData.push({ type: 'recording', text: currentChunk });
                                currentChunk = word;
                            }
                        }
                        if (currentChunk) carouselData.push({ type: 'recording', text: currentChunk });
                    } else {
                        carouselData.push({ type: 'recording', text: displayName });
                    }

                    // Add personality and album
                    if (personalityText) carouselData.push({ type: 'personality', text: personalityText });
                    if (albumText) carouselData.push({ type: 'album', text: albumText });

                    // Clear and rebuild carousel container
                    carouselContainer.innerHTML = '';
                    carouselData.forEach((item, idx) => {
                        const div = document.createElement('div');
                        div.className = `carousel-item carousel-${item.type}` + (idx === 0 ? ' active' : '');
                        div.id = `carouselItem${idx}`;

                        const span = document.createElement('span');
                        // Use correct class name for recording
                        span.className = item.type === 'recording' ? 'player-recording-name' : `player-${item.type}-tag`;
                        span.innerHTML = formatDescription(item.text);
                        div.appendChild(span);
                        carouselContainer.appendChild(div);
                    });

                    // Start carousel cycling if more than one item
                    if (carouselData.length > 1) {
                        let currentCarouselIdx = 0;
                        const items = carouselContainer.querySelectorAll('.carousel-item');

                        // Calculate interval: consistent 3 seconds per item
                        const intervalTime = 3000;

                        window.playerCarouselInterval = setInterval(() => {
                            // Add exiting class to current item
                            items[currentCarouselIdx]?.classList.add('exiting');
                            items[currentCarouselIdx]?.classList.remove('active');

                            // Calculate next index
                            const nextIdx = (currentCarouselIdx + 1) % items.length;

                            // After a small delay, show next and clean up exiting
                            setTimeout(() => {
                                items[currentCarouselIdx]?.classList.remove('exiting');
                                currentCarouselIdx = nextIdx;
                                items[currentCarouselIdx]?.classList.add('active');
                            }, 150);
                        }, intervalTime);
                    }
                }

                // Update player play button
                document.getElementById('playPauseBtn').classList.add('playing');
                // Also add playing class to player-section for minimized pulse effect
                document.querySelector('.player-section')?.classList.add('playing');
                // Only remove paused state from player show button wave if audio is actually playing
                const playerShowWave = document.querySelector('#playerShowBtn .song-wave-animation');
                if (playerShowWave && !audioPlayer.paused) {
                    playerShowWave.classList.remove('paused');
                }
            }

            // Open the current song details popup when clicking on player song name
            function openCurrentSongDetails() {
                if (currentSongIndex >= 0 && allSongs[currentSongIndex]) {
                    openNigunModal(currentSongIndex, allSongs[currentSongIndex]);
                }
            }

            // Update active song highlight
            function updateActiveSongInList() {
                // Remove active state from all song items
                document.querySelectorAll('.song-item').forEach(item => {
                    item.classList.remove('active');
                    item.classList.remove('paused');
                });

                // Reset all play buttons
                document.querySelectorAll('.song-play-btn-new').forEach(btn => {
                    btn.classList.remove('playing');
                });

                // Find and mark the currently playing song
                if (currentSongIndex >= 0) {
                    const activeItem = document.querySelector(`.song-item[data-song-idx="${currentSongIndex}"]`);
                    if (activeItem) {
                        activeItem.classList.add('active');

                        // Set paused class based on actual audio state
                        // During loading, audioPlayer.paused is true, so bars will be static
                        if (audioPlayer.paused) {
                            activeItem.classList.add('paused');
                        }

                        // Update play button state
                        const activeBtn = activeItem.querySelector('.song-play-btn-new');
                        if (activeBtn && !audioPlayer.paused) {
                            activeBtn.classList.add('playing');
                        }
                    }
                }
            }

            // Toggle play/pause
            function togglePlayPause() {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
                // UI updates handled by play/pause event listeners
            }

            // Play previous
            function playPrevious() {
                // Only cycle through recordings if display mode is 'recordings' or 'full'
                const allowRecordingsMode = currentDisplayMode === 'recordings' || currentDisplayMode === 'full';

                // If in recordings mode AND display allows it, go to previous quality recording
                if (allowRecordingsMode && isInRecordingsMode && currentSongIndex >= 0) {
                    const song = allSongs[currentSongIndex];
                    if (song && song.recordings) {
                        // Find previous recording that meets quality
                        for (let i = currentRecordingIndex - 1; i >= 0; i--) {
                            if (recordingMeetsQuality(song.recordings[i])) {
                                playNigunRecording(currentSongIndex, i, null, null, false);
                                return;
                            }
                        }
                    }
                }

                // Otherwise, go to previous song in playlist (skip songs without quality audio)
                if (currentPlaylist.length > 0) {
                    let newPosition = currentPlaylistPosition - 1;
                    while (newPosition >= 0) {
                        const songIdx = currentPlaylist[newPosition];
                        const song = allSongs[songIdx];
                        if (song && songHasQualityAudio(song)) {
                            currentPlaylistPosition = newPosition;
                            isInRecordingsMode = false;
                            currentRecordingIndex = 0;

                            // If in recordings/full mode, start at the last quality recording of the previous song
                            if (allowRecordingsMode && song.recordings && song.recordings.length > 1) {
                                // Find last quality recording
                                for (let i = song.recordings.length - 1; i >= 0; i--) {
                                    if (recordingMeetsQuality(song.recordings[i])) {
                                        isInRecordingsMode = true;
                                        currentRecordingIndex = i;
                                        playNigunRecording(songIdx, i, null, null, false);
                                        return;
                                    }
                                }
                            }
                            // Play first quality recording
                            const firstQualityRec = getFirstQualityRecording(song);
                            if (firstQualityRec) {
                                const recIdx = song.recordings.indexOf(firstQualityRec);
                                playNigunRecording(songIdx, recIdx, null, null, false);
                            } else {
                                playSong(songIdx, currentPlaylist);
                            }
                            return;
                        }
                        newPosition--;
                    }
                }
            }

            // Play next
            function playNext() {
                // Only cycle through recordings if display mode is 'recordings' or 'full'
                const allowRecordingsMode = currentDisplayMode === 'recordings' || currentDisplayMode === 'full';

                // If in recordings mode AND display allows it, go to next quality recording
                if (allowRecordingsMode && isInRecordingsMode && currentSongIndex >= 0) {
                    const song = allSongs[currentSongIndex];
                    if (song && song.recordings) {
                        // Find next recording that meets quality
                        for (let i = currentRecordingIndex + 1; i < song.recordings.length; i++) {
                            if (recordingMeetsQuality(song.recordings[i])) {
                                playNigunRecording(currentSongIndex, i, null, null, false);
                                return;
                            }
                        }
                    }
                }

                // Otherwise, go to next song in playlist (skip songs without quality audio)
                if (currentPlaylist.length > 0) {
                    let newPosition = currentPlaylistPosition + 1;
                    while (newPosition < currentPlaylist.length) {
                        const songIdx = currentPlaylist[newPosition];
                        const song = allSongs[songIdx];
                        if (song && songHasQualityAudio(song)) {
                            currentPlaylistPosition = newPosition;
                            isInRecordingsMode = false;
                            currentRecordingIndex = 0;

                            // If in recordings/full mode and song has multiple quality recordings, enter recordings mode
                            if (allowRecordingsMode && song.recordings && song.recordings.length > 1) {
                                // Find first quality recording
                                const firstQualityRec = getFirstQualityRecording(song);
                                if (firstQualityRec) {
                                    const recIdx = song.recordings.indexOf(firstQualityRec);
                                    isInRecordingsMode = true;
                                    playNigunRecording(songIdx, recIdx, null, null, false);
                                } else {
                                    playSong(songIdx, currentPlaylist);
                                }
                            } else {
                                // Play first quality recording
                                const firstQualityRec = getFirstQualityRecording(song);
                                if (firstQualityRec) {
                                    const recIdx = song.recordings.indexOf(firstQualityRec);
                                    playNigunRecording(songIdx, recIdx, null, null, false);
                                } else {
                                    playSong(songIdx, currentPlaylist);
                                }
                            }
                            return;
                        }
                        newPosition++;
                    }
                }
            }

            // Seek to position
            let isDraggingProgress = false;

            function seekTo(event) {
                const container = event.currentTarget || document.getElementById('progressBarContainer');
                if (!container) return; // Guard clause

                const rect = container.getBoundingClientRect();
                // Ensure percentage is between 0 and 1
                const percent = Math.min(Math.max((event.clientX - rect.left) / rect.width, 0), 1);

                if (isFinite(audioPlayer.duration)) {
                    // Fast visual slide to new position
                    const bar = document.getElementById('progressBar');
                    bar.style.transition = 'width 0.3s ease-out';
                    bar.style.width = `${percent * 100}%`;

                    // Restore smooth linear flow after the fast slide
                    if (window.progressAllTransitionTimeout) clearTimeout(window.progressAllTransitionTimeout);
                    window.progressAllTransitionTimeout = setTimeout(() => {
                        bar.style.transition = 'width 1s linear';
                    }, 300);

                    audioPlayer.currentTime = percent * audioPlayer.duration;
                    if (audioPlayer.paused) {
                        togglePlayPause(true); // Ensure it plays
                    }
                }
            }

            // Enhanced scrubbing/dragging support
            function setupProgressBarDragging() {
                const container = document.getElementById('progressBarContainer');
                if (!container) return; // Wait for DOM if needed, but here it should be ready

                container.addEventListener('mousedown', (e) => {
                    isDraggingProgress = true;
                    // Disable transition for direct 1:1 control while dragging
                    document.getElementById('progressBar').style.transition = 'none';
                    // Optional: pause while dragging if desired, or just let it play
                    seekTo(e); // Seek on initial click
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDraggingProgress) {
                        e.preventDefault(); // Prevent text selection
                        // Pass a mock event object or handle logic directly
                        const container = document.getElementById('progressBarContainer');
                        const rect = container.getBoundingClientRect();
                        const percent = Math.min(Math.max((e.clientX - rect.left) / rect.width, 0), 1);

                        // Update visual bar immediately while dragging
                        document.getElementById('progressBar').style.width = `${percent * 100}%`;

                        // Optional: update time display while dragging
                        if (isFinite(audioPlayer.duration)) {
                            document.getElementById('currentTime').textContent = formatTime(percent * audioPlayer.duration);
                        }
                    }
                });

                document.addEventListener('mouseup', (e) => {
                    if (isDraggingProgress) {
                        isDraggingProgress = false;
                        const rect = container.getBoundingClientRect();
                        const percent = Math.min(Math.max((e.clientX - rect.left) / rect.width, 0), 1);

                        // Fast visual slide to new position
                        const bar = document.getElementById('progressBar');
                        bar.style.transition = 'width 0.3s ease-out';
                        bar.style.width = `${percent * 100}%`;

                        // Restore smooth linear flow after the fast slide
                        if (window.progressAllTransitionTimeout) clearTimeout(window.progressAllTransitionTimeout);
                        window.progressAllTransitionTimeout = setTimeout(() => {
                            bar.style.transition = 'width 1s linear';
                        }, 300);

                        if (isFinite(audioPlayer.duration)) {
                            audioPlayer.currentTime = percent * audioPlayer.duration;
                            if (audioPlayer.paused) {
                                togglePlayPause(true); // Ensure it plays
                            }
                        }
                    }
                });
            }

            // Initialize dragging setup after DOM load or when player shows
            // Since this script is at end of body, run it:
            setupProgressBarDragging();

            // Format time
            function formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // Audio event listeners
            audioPlayer.addEventListener('timeupdate', () => {
                // Only update UI if NOT dragging, to prevent fighting/jitter
                if (!isDraggingProgress) {
                    const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    document.getElementById('progressBar').style.width = `${progress}%`;
                    document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
                    // Update minimized player progress bar CSS variable
                    const playerSection = document.querySelector('.player-section');
                    if (playerSection) {
                        playerSection.style.setProperty('--minimized-progress', `${progress}%`);
                    }
                }
            });

            audioPlayer.addEventListener('loadedmetadata', () => {
                document.getElementById('duration').textContent = formatTime(audioPlayer.duration);
            });

            audioPlayer.addEventListener('ended', () => {
                stopPlaybackTimer();
                hideRatingPrompt();
                playNext();
            });

            audioPlayer.addEventListener('pause', () => {
                stopPlaybackTimer();
                hideRatingPrompt();
                updatePlayState(false);
            });

            // 'playing' event fires when audio actually starts (after buffering/loading)
            audioPlayer.addEventListener('playing', () => {
                updatePlayState(true);
            });

            // Helper: Smoothly fade wave bars to minimum height
            function fadeWaveBarsToMin() {
                // Get all wave bars from song list and player
                const allWaveBars = document.querySelectorAll('.song-item.active .wave-bar, #playerShowBtn .wave-bar, .player-wave-animation .wave-bar');
                allWaveBars.forEach(bar => {
                    // Capture current animated transform
                    const currentTransform = getComputedStyle(bar).transform;
                    // Apply current transform as inline style
                    bar.style.transform = currentTransform;
                    // Remove CSS animation
                    bar.style.animation = 'none';
                    // Force reflow
                    bar.offsetHeight;
                    // Add transition and animate to minimum
                    bar.style.transition = 'transform 0.3s ease-out';
                    bar.style.transform = 'scaleY(0.4)';
                });
            }

            // Helper: Reset wave bars to let CSS animation take over
            function resetWaveBars() {
                const allWaveBars = document.querySelectorAll('.song-item.active .wave-bar, #playerShowBtn .wave-bar, .player-wave-animation .wave-bar');
                allWaveBars.forEach(bar => {
                    bar.style.transform = '';
                    bar.style.transition = '';
                    bar.style.animation = '';
                });
            }

            // Update play/pause state for both player and song list
            function updatePlayState(isPlaying) {
                const playPauseBtn = document.getElementById('playPauseBtn');
                const playerShowWave = document.querySelector('#playerShowBtn .song-wave-animation');

                // Update body classes for player wave animation
                document.body.classList.add('has-audio');
                if (isPlaying) {
                    document.body.classList.add('playing');
                    // Reset inline styles when playing
                    resetWaveBars();
                } else {
                    // Smoothly fade wave bars to minimum before removing playing class
                    fadeWaveBarsToMin();
                    document.body.classList.remove('playing');
                }

                // Update player button
                const playerSection = document.querySelector('.player-section');
                if (isPlaying) {
                    playPauseBtn.classList.add('playing');
                    playerSection?.classList.add('playing');
                } else {
                    playPauseBtn.classList.remove('playing');
                    playerSection?.classList.remove('playing');
                }

                // Update wave animation in player-show-btn (pause when audio paused)
                if (playerShowWave) {
                    if (isPlaying) {
                        playerShowWave.classList.remove('loading');
                        playerShowWave.classList.remove('paused');
                    } else {
                        playerShowWave.classList.add('paused');
                    }
                }

                // Update song list play buttons
                document.querySelectorAll('.song-play-btn-new').forEach(btn => {
                    btn.classList.remove('playing');
                });

                // Update song items paused state
                document.querySelectorAll('.song-item').forEach(item => {
                    item.classList.remove('paused');
                });

                // Remove active-recording class from all recordings
                document.querySelectorAll('.song-item-recording').forEach(rec => {
                    rec.classList.remove('active-recording');
                });

                // Find the active song's button and update it
                if (currentSongIndex >= 0) {
                    const activeBtn = document.querySelector(`.song-play-btn-new[data-song-idx="${currentSongIndex}"]:not([data-rec-idx])`);
                    const activeItem = document.querySelector(`.song-item[data-song-idx="${currentSongIndex}"]`);

                    if (activeBtn && isPlaying) {
                        activeBtn.classList.add('playing');
                    }
                    if (activeItem && !isPlaying) {
                        activeItem.classList.add('paused');
                    }

                    // Update wave animation in song list (pause/unpause based on play state)
                    const songWave = activeItem?.querySelector('.song-wave-animation');
                    if (songWave) {
                        if (isPlaying) {
                            // Remove both loading and paused when audio starts
                            songWave.classList.remove('loading');
                            songWave.classList.remove('paused');
                        } else {
                            // Add paused class to freeze animation in place
                            songWave.classList.add('paused');
                        }
                    }

                    // Update active recording button
                    const activeRecBtn = document.querySelector(`.rec-play-btn[data-song-idx="${currentSongIndex}"][data-rec-idx="${currentRecordingIndex}"]`);
                    if (activeRecBtn && isPlaying) {
                        activeRecBtn.classList.add('playing');
                    }

                    // Highlight active recording row
                    const activeRecRow = document.querySelector(`.song-item-recording[data-song-idx="${currentSongIndex}"][data-rec-idx="${currentRecordingIndex}"]`);
                    if (activeRecRow) {
                        activeRecRow.classList.add('active-recording');

                        // Update wave animation in recording row
                        const recWave = activeRecRow.querySelector('.song-wave-animation');
                        if (recWave) {
                            if (isPlaying) {
                                recWave.classList.remove('loading');
                                recWave.classList.remove('paused');
                            } else {
                                recWave.classList.add('paused');
                            }
                        }
                    }
                }

                // Update play-all button states
                updatePlayAllBtnState();
            }

            // Create clickable link for a field value
            function createFieldLink(value, fieldType) {
                if (!value) return '';

                // Split by comma for multiple values
                const values = value.split(',').map(v => v.trim()).filter(Boolean);

                return values.map(v => {
                    // Entity types that open preview modals
                    const detailTypes = {
                        'mechaber': 'mechabrim',
                        'chatzer': 'chatzeros',
                        'verter': 'verter',
                        'zman': 'zmanim',
                        'collection': 'collections',
                        'piyut': 'piyutim'
                    };

                    // Check if this field type opens a preview
                    if (detailTypes[fieldType]) {
                        return `<a href="#" class="field-link"
                        data-action="detail"
                        data-category="${detailTypes[fieldType]}"
                        data-name="${escapeHtml(v)}"
                        data-close-modal="true"
                        data-tooltip-value="${escapeHtml(v)}"
                        data-tooltip-type="${fieldType}">${v}</a>`;
                    }

                    // Filter types (scale, ritem, gezungen, maure) - no preview page
                    let page = '';
                    let filterKey = '';
                    switch (fieldType) {
                        case 'scale':
                            page = 'songs';
                            filterKey = 'scale';
                            break;
                        case 'ritem':
                            page = 'songs';
                            filterKey = 'ritem';
                            break;
                        case 'gezungen':
                            page = 'songs';
                            filterKey = 'gezungen';
                            break;
                        case 'maure':
                            page = 'songs';
                            filterKey = 'maure';
                            break;
                        default:
                            return v; // No link for other fields
                    }

                    return `<a href="#" class="field-link"
                    data-action="filter"
                    data-page="${page}"
                    data-filter-key="${filterKey}"
                    data-value="${escapeHtml(v)}"
                    data-close-modal="true"
                    data-tooltip-value="${escapeHtml(v)}"
                    data-tooltip-type="${filterKey}">${v}</a>`;
                }).join(' ');
            }

            // Navigate to page with filter applied (opens detail page)
            function navigateToWithFilter(page, filterKey, value) {
                // Handle scale, ritem - just navigate to music page (no filter)
                if (filterKey === 'scale' || filterKey === 'ritem') {
                    // Close any open modals
                    closeAllModals();

                    // Navigate to music page
                    currentDetailView = null;
                    currentPageView = 'music';

                    // Update nav buttons
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.page === 'music');
                    });

                    updateURL();
                    renderCurrentPage();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }

                // Handle gezungen, maure - filter nigunim page
                if (filterKey === 'gezungen' || filterKey === 'maure') {
                    // Reset all filters first
                    activeFilters = {
                        chatzer: [],
                        mechaber: [],
                        verter: [],
                        zman: [],
                        collection: [],
                        scale: [],
                        ritem: [],
                        gezungen: [],
                        maure: []
                    };

                    // Set the specific filter
                    activeFilters[filterKey] = [value];

                    // Filter songs
                    applyFilters();

                    currentDetailView = null;
                    currentPageView = 'songs';

                    // Close any open modals
                    closeAllModals();

                    // Update nav buttons
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.page === 'songs');
                    });

                    updateURL();
                    renderCurrentPage();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }

                // Map page to category key
                const categoryMap = {
                    'chatzeros': 'chatzeros',
                    'mechabrim': 'mechabrim',
                    'verter': 'verter',
                    'zmanim': 'zmanim',
                    'collections': 'collections'
                };

                const categoryKey = categoryMap[page];
                if (categoryKey) {
                    // Navigate to detail page for this item
                    navigateToDetail(categoryKey, value);
                }
            }

            // Show song details - opens in modal overlay
            function showSongDetails(idx) {
                const song = allSongs[idx];
                if (!song) return;

                // Open modal instead of navigating to full page
                openNigunModal(idx, song);
            }

            // Open nigun modal overlay
            function openNigunModal(idx, song) {
                // Save current scroll position
                savedScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                currentNigunModalIdx = idx;
                nigunModalOpen = true;

                // Update URL to nigun detail URL using pushState (with /preview for modal mode)
                const nigunId = song.customId || song.rowId || song.name;
                const hash = `#/nigunim/${encodeURIComponent(nigunId)}/preview`;
                history.pushState({ nigunModal: true, scrollPos: savedScrollPosition, idx: idx }, '', hash);

                // Render content in modal
                const modalBody = document.getElementById('nigunModalBody');
                renderNigunDetailInModal(modalBody, song.name, idx);

                // Generate floating music notes for modal
                generateNigunModalNotes();

                // Show overlay with stacking z-index
                const overlay = document.getElementById('nigunModalOverlay');
                modalZIndexCounter++;
                overlay.style.zIndex = modalZIndexCounter;
                modalStack.push({ type: 'nigun', zIndex: modalZIndexCounter, idx: idx, song: song });
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }

            // Render nigun detail content inside modal
            // Now supports async loading: shows basic info immediately from songIndex,
            // then fetches full details (gezungen, maure, pasigOif) and recordings async
            function renderNigunDetailInModal(container, nigunName, idx) {
                // Find the song
                let songIdx = idx !== undefined ? idx : allSongs.findIndex(s => s.name === nigunName);
                if (songIdx === -1) {
                    songIdx = allSongs.findIndex(s => s.rowId === nigunName);
                }
                if (songIdx === -1) {
                    songIdx = allSongs.findIndex(s => s.customId === nigunName);
                }
                const song = allSongs[songIdx];

                if (!song) {
                    container.innerHTML = '<p>ניגון נישט געפונען</p>';
                    return;
                }

                // Render immediately with available data from songIndex
                const tempContainer = document.createElement('div');
                renderNigunDetailPage(tempContainer, song.name);
                container.innerHTML = tempContainer.innerHTML;

                // If full details aren't loaded yet, fetch them asynchronously
                if (!song._fullDetailsLoaded && song.rowId) {
                    loadFullSongDetailsForModal(song, songIdx, container);
                }

                // If recordings not loaded yet, try to load them
                if ((!song.recordings || song.recordings.length === 0) && song.hasRecordings) {
                    loadRecordingsForModal(song, songIdx, container);
                }
            }

            // Async: fetch full song details and update the modal
            async function loadFullSongDetailsForModal(song, songIdx, container) {
                try {
                    const fullDetails = await IndexManager.getFullSongDetails(song.rowId);
                    if (!fullDetails) return;

                    // Merge full details into the song object
                    mergeFullSongDetails(song, fullDetails);

                    // Re-render the modal content with full details
                    // Only if the modal is still showing this song
                    if (nigunModalOpen && currentNigunModalIdx === songIdx) {
                        const tempContainer = document.createElement('div');
                        renderNigunDetailPage(tempContainer, song.name);
                        container.innerHTML = tempContainer.innerHTML;
                    }
                } catch (error) {
                    console.error('Error loading full song details for modal:', error);
                }
            }

            // Async: load recordings for a song and update the modal
            async function loadRecordingsForModal(song, songIdx, container) {
                try {
                    // Try recordings index first
                    if (IndexManager.recordingsLoaded) {
                        const recordings = IndexManager.getRecordings(song.customId);
                        if (recordings && recordings.length > 0) {
                            song.recordings = recordings;
                            song.audioUrl = recordings[0].url;
                            song.hasRecordings = true;
                            song.recordingCount = recordings.length;
                        }
                    } else {
                        // Wait for recordings index to load
                        await IndexManager.loadRecordingsIndex();
                        const recordings = IndexManager.getRecordings(song.customId);
                        if (recordings && recordings.length > 0) {
                            song.recordings = recordings;
                            song.audioUrl = recordings[0].url;
                            song.hasRecordings = true;
                            song.recordingCount = recordings.length;
                        }
                    }

                    // Re-render modal if still open for this song
                    if (nigunModalOpen && currentNigunModalIdx === songIdx) {
                        const tempContainer = document.createElement('div');
                        renderNigunDetailPage(tempContainer, song.name);
                        container.innerHTML = tempContainer.innerHTML;
                    }
                } catch (error) {
                    console.error('Error loading recordings for modal:', error);
                }
            }

            // Close all open modals (nigun and detail)
            function closeAllModals() {
                // Close nigun modal if open
                if (nigunModalOpen) {
                    nigunModalOpen = false;
                    currentNigunModalIdx = null;
                    const nigunOverlay = document.getElementById('nigunModalOverlay');
                    if (nigunOverlay) nigunOverlay.classList.remove('active');
                }
                // Close detail modal if open
                if (detailModalOpen) {
                    detailModalOpen = false;
                    currentDetailModalType = null;
                    currentDetailModalName = null;
                    const detailOverlay = document.getElementById('detailModalOverlay');
                    if (detailOverlay) detailOverlay.classList.remove('active');
                }
                // Restore scrolling
                document.body.style.overflow = '';
                // Clear modal stack
                modalStack = [];
            }

            // Close nigun modal overlay
            function closeNigunModal() {
                if (!nigunModalOpen) return;

                nigunModalOpen = false;
                currentNigunModalIdx = null;

                // Remove from modal stack
                modalStack = modalStack.filter(m => m.type !== 'nigun' || m.zIndex !== parseInt(document.getElementById('nigunModalOverlay').style.zIndex));

                // Hide overlay
                const overlay = document.getElementById('nigunModalOverlay');
                overlay.classList.remove('active');

                // Only restore scrolling if no other modals are open
                if (modalStack.length === 0) {
                    document.body.style.overflow = '';
                }

                // Go back in history to restore previous URL
                skipNextPopstateHandler = true;
                skipNextHashChange = true;
                history.back();
            }

            // Report modal state
            let currentReportSongName = '';
            let currentReportSongId = '';
            const REPORTS_TABLE_ID = 'grid-zxaGYhXG8S';

            // Add Info Modal Variables
            let currentAddInfoSongName = '';
            let currentAddInfoSongId = '';

            // Autocomplete data sources (will be populated dynamically)
            const addinfoAutocompleteData = {
                mechabrim: [],
                chatzeros: [],
                piyutim: [],
                verter: [],
                scales: [],
                rhythms: [],
                collections: [],
                documents: [],
                albums: [],
                nigunim: []
            };

            // Selected values for multi-select fields
            const addinfoSelectedValues = {};

            // Initialize autocomplete data from existing app data
            function initAddinfoAutocompleteData() {
                // Hebrew-aware sort function
                const hebrewSort = (a, b) => a.localeCompare(b, 'he');

                // Get mechabrim data
                if (typeof mechabrimInfo !== 'undefined' && Object.keys(mechabrimInfo).length > 0) {
                    addinfoAutocompleteData.mechabrim = Object.keys(mechabrimInfo).sort(hebrewSort);
                }
                // Get chatzeros data
                if (typeof chatzerosInfo !== 'undefined' && Object.keys(chatzerosInfo).length > 0) {
                    addinfoAutocompleteData.chatzeros = Object.keys(chatzerosInfo).sort(hebrewSort);
                }
                // Get verter data
                if (typeof verterInfo !== 'undefined' && Object.keys(verterInfo).length > 0) {
                    addinfoAutocompleteData.verter = Object.keys(verterInfo).sort(hebrewSort);
                }
                // Get piyutim data
                if (typeof piyutimInfo !== 'undefined' && Object.keys(piyutimInfo).length > 0) {
                    addinfoAutocompleteData.piyutim = Object.keys(piyutimInfo).sort(hebrewSort);
                }
                // Get collections data
                if (typeof collectionsInfo !== 'undefined' && Object.keys(collectionsInfo).length > 0) {
                    addinfoAutocompleteData.collections = Object.keys(collectionsInfo).sort(hebrewSort);
                }
                // Get documents data
                if (typeof documentsInfo !== 'undefined' && Object.keys(documentsInfo).length > 0) {
                    addinfoAutocompleteData.documents = Object.keys(documentsInfo).sort(hebrewSort);
                }
                // Get albums data
                if (typeof albumsInfo !== 'undefined' && Object.keys(albumsInfo).length > 0) {
                    addinfoAutocompleteData.albums = Object.keys(albumsInfo).sort(hebrewSort);
                }

                // Get scales data dynamically
                if (typeof scaleInfo !== 'undefined' && Object.keys(scaleInfo).length > 0) {
                    addinfoAutocompleteData.scales = Object.keys(scaleInfo).sort(hebrewSort);
                } else {
                    // Fallback to static data if not loaded
                    addinfoAutocompleteData.scales = ['אהבה רבה', 'מאזשאר', 'מי שברך', 'מינאר', 'מישעבערעך', 'פריגיש'];
                }
                // Get rhythms data dynamically
                if (typeof rhythmInfo !== 'undefined' && Object.keys(rhythmInfo).length > 0) {
                    addinfoAutocompleteData.rhythms = Object.keys(rhythmInfo).sort(hebrewSort);
                } else {
                    // Fallback to static data if not loaded
                    addinfoAutocompleteData.rhythms = ['דבקות', 'הארא', 'וואלץ', 'טיש', 'מארש', 'ניגון', 'פרייליכס'];
                }

                // Get nigunim data from allSongs - store both name and rowId
                if (typeof allSongs !== 'undefined' && allSongs.length > 0) {
                    // Store as objects with name and rowId for lookup
                    addinfoAutocompleteData.nigunim = allSongs
                        .filter(song => song.name && song.rowId)
                        .map(song => ({ name: song.name, rowId: song.rowId }))
                        .sort((a, b) => a.name.localeCompare(b.name, 'he'));
                }


            }

            // Setup autocomplete for all wrapper elements
            function setupAddinfoAutocomplete() {
                const wrappers = document.querySelectorAll('.addinfo-autocomplete-wrapper');

                wrappers.forEach(wrapper => {
                    const input = wrapper.querySelector('.addinfo-autocomplete-input');
                    const dropdown = wrapper.querySelector('.addinfo-autocomplete-dropdown');
                    const tagsContainer = wrapper.querySelector('.addinfo-selected-tags');
                    const source = wrapper.dataset.source;
                    const isMulti = wrapper.dataset.multi === 'true';
                    const fieldId = input.id;

                    // Initialize selected values array for multi-select
                    if (isMulti && !addinfoSelectedValues[fieldId]) {
                        addinfoSelectedValues[fieldId] = [];
                    }

                    // Input event for filtering
                    input.addEventListener('input', () => {
                        const query = input.value.trim().toLowerCase();
                        showAddinfoDropdown(wrapper, source, query, isMulti, fieldId);
                    });

                    // Focus event to show dropdown
                    input.addEventListener('focus', () => {
                        const query = input.value.trim().toLowerCase();
                        showAddinfoDropdown(wrapper, source, query, isMulti, fieldId);
                    });

                    // Blur event to hide dropdown (with delay for click handling)
                    input.addEventListener('blur', () => {
                        setTimeout(() => {
                            dropdown.classList.remove('active');
                        }, 200);
                    });

                    // For single-select: clicking on tags container allows re-selection
                    // For all: clicking on wrapper (empty space) focuses input
                    wrapper.addEventListener('click', (e) => {
                        // Don't trigger if clicking the X button or input itself
                        if (e.target.tagName === 'BUTTON' || e.target === input) return;

                        // Focus the input and show dropdown
                        input.focus();
                        showAddinfoDropdown(wrapper, source, '', isMulti, fieldId);
                    });

                    // Keyboard navigation
                    input.addEventListener('keydown', (e) => {
                        const items = dropdown.querySelectorAll('.addinfo-autocomplete-item');
                        const highlighted = dropdown.querySelector('.addinfo-autocomplete-item.highlighted');

                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            if (!highlighted && items.length > 0) {
                                items[0].classList.add('highlighted');
                            } else if (highlighted && highlighted.nextElementSibling) {
                                highlighted.classList.remove('highlighted');
                                highlighted.nextElementSibling.classList.add('highlighted');
                            }
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            if (highlighted && highlighted.previousElementSibling) {
                                highlighted.classList.remove('highlighted');
                                highlighted.previousElementSibling.classList.add('highlighted');
                            }
                        } else if (e.key === 'Enter') {
                            e.preventDefault();
                            if (highlighted) {
                                // For nigunim source, pass rowId from data attribute
                                const rowId = highlighted.dataset.rowid;
                                selectAddinfoItem(wrapper, highlighted.textContent, isMulti, fieldId, source, rowId);
                            } else if (input.value.trim()) {
                                // Allow adding custom value
                                selectAddinfoItem(wrapper, input.value.trim(), isMulti, fieldId, source);
                            }
                        } else if (e.key === 'Escape') {
                            dropdown.classList.remove('active');
                            input.blur();
                        }
                    });
                });
            }

            // Show dropdown with filtered items
            function showAddinfoDropdown(wrapper, source, query, isMulti, fieldId) {
                const dropdown = wrapper.querySelector('.addinfo-autocomplete-dropdown');
                const data = addinfoAutocompleteData[source] || [];

                // Check if this is nigunim source (objects with name/rowId)
                const isNigunim = source === 'nigunim';

                // Filter data based on query
                let filtered = data;
                if (query) {
                    if (isNigunim) {
                        filtered = data.filter(item =>
                            item.name.toLowerCase().includes(query)
                        );
                    } else {
                        filtered = data.filter(item =>
                            item.toLowerCase().includes(query)
                        );
                    }
                }

                // Exclude already selected items
                if (addinfoSelectedValues[fieldId] && addinfoSelectedValues[fieldId].length > 0) {
                    if (isNigunim) {
                        // For nigunim, compare by rowId since that's what we store
                        filtered = filtered.filter(item =>
                            !addinfoSelectedValues[fieldId].includes(item.rowId)
                        );
                    } else {
                        filtered = filtered.filter(item =>
                            !addinfoSelectedValues[fieldId].includes(item)
                        );
                    }
                }

                // Limit results
                filtered = filtered.slice(0, 10);

                // Build dropdown HTML with source class for theming
                if (filtered.length === 0) {
                    if (query) {
                        dropdown.innerHTML = `<div class="addinfo-autocomplete-empty">נישט געפונען. דרוק Enter צוצולייגן "${query}"</div>`;
                    } else {
                        dropdown.innerHTML = '<div class="addinfo-autocomplete-empty">טייפ צו זוכן...</div>';
                    }
                } else {
                    if (isNigunim) {
                        // For nigunim, show name but store rowId in data attribute
                        dropdown.innerHTML = filtered.map(item =>
                            `<div class="addinfo-autocomplete-item source-${source}" data-rowid="${item.rowId}">${item.name}</div>`
                        ).join('');
                    } else {
                        dropdown.innerHTML = filtered.map(item =>
                            `<div class="addinfo-autocomplete-item source-${source}">${item}</div>`
                        ).join('');
                    }

                    // Add click handlers
                    dropdown.querySelectorAll('.addinfo-autocomplete-item').forEach(item => {
                        item.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            if (isNigunim) {
                                // For nigunim, pass both name (for display) and rowId (for storage)
                                selectAddinfoItem(wrapper, item.textContent, isMulti, fieldId, source, item.dataset.rowid);
                            } else {
                                selectAddinfoItem(wrapper, item.textContent, isMulti, fieldId, source);
                            }
                        });
                    });
                }

                dropdown.classList.add('active');
            }

            // Select an item from dropdown
            // Map to store nigun name by rowId for display purposes
            const nigunNameByRowId = {};

            function selectAddinfoItem(wrapper, value, isMulti, fieldId, source, rowId) {
                const input = wrapper.querySelector('.addinfo-autocomplete-input');
                const dropdown = wrapper.querySelector('.addinfo-autocomplete-dropdown');
                let tagsContainer = wrapper.querySelector('.addinfo-selected-tags');

                // Create tags container if it doesn't exist (for single-select fields)
                if (!tagsContainer) {
                    tagsContainer = document.createElement('div');
                    tagsContainer.className = 'addinfo-selected-tags';
                    tagsContainer.id = fieldId + '-tags';
                    wrapper.appendChild(tagsContainer);
                }

                // Get source from wrapper if not passed
                if (!source) {
                    source = wrapper.dataset.source;
                }

                // For nigunim, store rowId and keep track of name for display
                const valueToStore = (source === 'nigunim' && rowId) ? rowId : value;
                if (source === 'nigunim' && rowId) {
                    nigunNameByRowId[rowId] = value; // Store name for display
                }

                // Add to selected values (treat all as arrays for consistency)
                if (!addinfoSelectedValues[fieldId]) {
                    addinfoSelectedValues[fieldId] = [];
                }

                if (isMulti) {
                    // Multi-select - add to array
                    if (!addinfoSelectedValues[fieldId].includes(valueToStore)) {
                        addinfoSelectedValues[fieldId].push(valueToStore);
                    }
                } else {
                    // Single select - replace with single value, show as removable tag
                    addinfoSelectedValues[fieldId] = [valueToStore];
                }

                renderAddinfoTags(tagsContainer, fieldId, source);
                input.value = '';

                // Only close dropdown for single-select, keep open for multi-select
                if (!isMulti) {
                    dropdown.classList.remove('active');
                } else {
                    // Re-show dropdown with updated filter (to exclude selected items)
                    const wrapper = input.closest('.addinfo-autocomplete-wrapper');
                    showAddinfoDropdown(wrapper, source, '', isMulti, fieldId);
                    input.focus();
                }
            }

            // Render selected tags
            function renderAddinfoTags(container, fieldId, source) {
                if (!container) return;

                const values = addinfoSelectedValues[fieldId] || [];

                // Toggle has-selection class on wrapper for single-select styling
                const wrapper = container.closest('.addinfo-autocomplete-wrapper');
                if (wrapper && wrapper.dataset.multi === 'false') {
                    if (values.length > 0) {
                        wrapper.classList.add('has-selection');
                    } else {
                        wrapper.classList.remove('has-selection');
                    }
                }

                container.innerHTML = values.map(value => {
                    // For nigunim, display the name from our lookup map instead of the rowId
                    const displayValue = (source === 'nigunim' && nigunNameByRowId[value])
                        ? nigunNameByRowId[value]
                        : value;
                    return `<span class="addinfo-selected-tag source-${source}">
                    ${displayValue}
                    <button type="button" onclick="removeAddinfoTag('${fieldId}', '${value.replace(/'/g, "\\'")}', '${source}')">×</button>
                </span>`;
                }).join('');
            }

            // Remove a tag
            function removeAddinfoTag(fieldId, value, source) {
                if (addinfoSelectedValues[fieldId]) {
                    addinfoSelectedValues[fieldId] = addinfoSelectedValues[fieldId].filter(v => v !== value);
                    const tagsContainer = document.getElementById(fieldId + '-tags');
                    renderAddinfoTags(tagsContainer, fieldId, source);
                }
            }

            // Open add info modal for current nigun
            async function openAddInfoModal() {
                // Get the current song name and ID from the modal, full page, or player
                let songName = '';
                let songRowId = '';
                let songCustomId = '';

                if (currentNigunModalIdx !== null && allSongs[currentNigunModalIdx]) {
                    songName = allSongs[currentNigunModalIdx].name;
                    songRowId = allSongs[currentNigunModalIdx].rowId || '';
                    songCustomId = allSongs[currentNigunModalIdx].customId || '';
                } else if (window.currentDetailPageSongIdx !== undefined && allSongs[window.currentDetailPageSongIdx]) {
                    songName = allSongs[window.currentDetailPageSongIdx].name;
                    songRowId = allSongs[window.currentDetailPageSongIdx].rowId || '';
                    songCustomId = allSongs[window.currentDetailPageSongIdx].customId || '';
                } else if (currentSongIndex !== null && allSongs[currentSongIndex]) {
                    songName = allSongs[currentSongIndex].name;
                    songRowId = allSongs[currentSongIndex].rowId || '';
                    songCustomId = allSongs[currentSongIndex].customId || '';
                }

                currentAddInfoSongName = songName;
                currentAddInfoSongId = songRowId;

                // Also set report values so switching to report tab works correctly
                currentReportSongName = songName;
                currentReportSongId = songCustomId;

                // Update modal with song name
                document.getElementById('addinfoSongName').textContent = songName || 'ניגון';

                // Reset form
                resetAddInfoForm();

                // Switch to add info panel and show modal
                switchModalPanel('addinfo');
                document.getElementById('addinfoModalOverlay').classList.add('active');
                document.body.style.overflow = 'hidden';

                // Load all required data if not already loaded
                const dataPromises = [];
                if (!loadedCategories.mechabrim) {
                    dataPromises.push(fetchMechabrimInfo().then(() => loadedCategories.mechabrim = true));
                }
                if (!loadedCategories.chatzeros) {
                    dataPromises.push(fetchChatzerosInfo().then(() => loadedCategories.chatzeros = true));
                }
                if (!loadedCategories.verter) {
                    dataPromises.push(fetchVerterInfo().then(() => loadedCategories.verter = true));
                }
                if (!loadedCategories.piyutim) {
                    dataPromises.push(fetchPiyutimInfo().then(() => loadedCategories.piyutim = true));
                }
                if (!loadedCategories.collections) {
                    dataPromises.push(fetchCollectionsInfo().then(() => loadedCategories.collections = true));
                }
                if (!loadedCategories.documents) {
                    dataPromises.push(fetchDocumentsInfo().then(() => loadedCategories.documents = true));
                }
                if (!loadedCategories.albums) {
                    dataPromises.push(fetchAlbumsInfo().then(() => loadedCategories.albums = true));
                }
                if (!loadedCategories.scale) {
                    dataPromises.push(fetchScaleInfo().then(() => loadedCategories.scale = true));
                }
                if (!loadedCategories.rhythm) {
                    dataPromises.push(fetchRhythmInfo().then(() => loadedCategories.rhythm = true));
                }

                // Wait for all data to load
                if (dataPromises.length > 0) {

                    await Promise.all(dataPromises);

                }

                // Initialize autocomplete data
                initAddinfoAutocompleteData();

                // Setup autocomplete handlers
                setupAddinfoAutocomplete();
            }

            // Close add info modal
            function closeAddInfoModal() {
                const overlay = document.getElementById('addinfoModalOverlay');
                const content = document.querySelector('.addinfo-modal-content');

                overlay.classList.add('fade-out');

                setTimeout(() => {
                    overlay.classList.remove('active', 'fade-out');
                    content.classList.remove('success');
                    document.body.style.overflow = '';
                    resetAddInfoForm();
                }, 300);
            }

            // Reset add info form
            function resetAddInfoForm() {
                // Reset all text inputs and remove tag styling classes
                const textInputs = document.querySelectorAll('.addinfo-modal-body input[type="text"]');
                textInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('has-value', 'source-mechabrim', 'source-scales', 'source-rhythms');
                });

                // Reset textareas
                const textareas = document.querySelectorAll('.addinfo-modal-body textarea');
                textareas.forEach(textarea => textarea.value = '');

                // Reset file inputs and their visual state
                const fileInputs = document.querySelectorAll('.addinfo-modal-body input[type="file"]');
                fileInputs.forEach(input => {
                    input.value = '';
                    const uploadBox = input.closest('.addinfo-file-upload');
                    if (uploadBox) {
                        uploadBox.classList.remove('file-selected');
                        uploadBox.style.opacity = '';
                        uploadBox.style.pointerEvents = '';
                        // Restore original text
                        const textEl = uploadBox.querySelector('.addinfo-file-upload-text');
                        const hintEl = uploadBox.querySelector('.addinfo-file-upload-hint');
                        if (textEl) textEl.textContent = textEl.dataset.originalText || textEl.textContent;
                        if (hintEl) hintEl.textContent = hintEl.dataset.originalHint || hintEl.textContent;
                    }
                });

                // Reset link inputs
                const linkInputs = document.querySelectorAll('.addinfo-modal-body .addinfo-file-link-input');
                linkInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('link-valid', 'link-invalid');
                    input.disabled = false;
                });

                // Reset checkboxes
                const checkboxes = document.querySelectorAll('.addinfo-modal-body input[type="checkbox"]');
                checkboxes.forEach(checkbox => checkbox.checked = false);

                // Reset all selected tags
                Object.keys(addinfoSelectedValues).forEach(key => {
                    addinfoSelectedValues[key] = [];
                });
                document.querySelectorAll('.addinfo-selected-tags').forEach(container => {
                    container.innerHTML = '';
                });

                // Remove has-selection class from single-select wrappers
                document.querySelectorAll('.addinfo-autocomplete-wrapper.has-selection').forEach(wrapper => {
                    wrapper.classList.remove('has-selection');
                });
            }

            // Setup file input change handlers for visual feedback
            function setupFileInputHandlers() {
                const fileInputs = document.querySelectorAll('.addinfo-file-upload input[type="file"]');
                fileInputs.forEach(input => {
                    // Store original text
                    const uploadBox = input.closest('.addinfo-file-upload');
                    if (uploadBox) {
                        const textEl = uploadBox.querySelector('.addinfo-file-upload-text');
                        const hintEl = uploadBox.querySelector('.addinfo-file-upload-hint');
                        if (textEl && !textEl.dataset.originalText) textEl.dataset.originalText = textEl.textContent;
                        if (hintEl && !hintEl.dataset.originalHint) hintEl.dataset.originalHint = hintEl.textContent;
                    }

                    input.addEventListener('change', function () {
                        const uploadBox = this.closest('.addinfo-file-upload');
                        if (!uploadBox) return;

                        const textEl = uploadBox.querySelector('.addinfo-file-upload-text');
                        const hintEl = uploadBox.querySelector('.addinfo-file-upload-hint');
                        // Find sibling link input
                        const field = uploadBox.closest('.addinfo-field');
                        const linkInput = field?.querySelector('.addinfo-file-link-input');

                        if (this.files && this.files.length > 0) {
                            uploadBox.classList.add('file-selected');
                            if (this.files.length === 1) {
                                if (textEl) textEl.textContent = this.files[0].name;
                                const sizeKB = Math.round(this.files[0].size / 1024);
                                if (hintEl) hintEl.textContent = sizeKB > 1024 ? `${(sizeKB / 1024).toFixed(1)} MB` : `${sizeKB} KB`;
                            } else {
                                if (textEl) textEl.textContent = `${this.files.length} פיילס אויסגעוועלט`;
                                const totalSize = Array.from(this.files).reduce((sum, f) => sum + f.size, 0);
                                const totalKB = Math.round(totalSize / 1024);
                                if (hintEl) hintEl.textContent = totalKB > 1024 ? `${(totalKB / 1024).toFixed(1)} MB` : `${totalKB} KB`;
                            }
                            // Disable link input when file is selected
                            if (linkInput) {
                                linkInput.value = '';
                                linkInput.disabled = true;
                                linkInput.classList.remove('link-valid', 'link-invalid');
                            }
                        } else {
                            uploadBox.classList.remove('file-selected');
                            if (textEl) textEl.textContent = textEl.dataset.originalText || '';
                            if (hintEl) hintEl.textContent = hintEl.dataset.originalHint || '';
                            // Re-enable link input
                            if (linkInput) linkInput.disabled = false;
                        }
                    });
                });

                // Setup link input validation and mutual exclusion
                const linkInputs = document.querySelectorAll('.addinfo-file-link-input');
                linkInputs.forEach(linkInput => {
                    linkInput.addEventListener('input', function () {
                        const val = this.value.trim();
                        const field = this.closest('.addinfo-field');
                        const uploadBox = field?.querySelector('.addinfo-file-upload');
                        const fileInput = field?.querySelector('input[type="file"]');

                        if (val) {
                            // Validate: must be Google Drive or Dropbox link
                            const isValid = /^https:\/\/(drive\.google\.com|docs\.google\.com|www\.dropbox\.com|dl\.dropboxusercontent\.com)\//i.test(val);
                            this.classList.toggle('link-valid', isValid);
                            this.classList.toggle('link-invalid', !isValid);
                            // Dim the file upload box
                            if (uploadBox) {
                                uploadBox.style.opacity = '0.4';
                                uploadBox.style.pointerEvents = 'none';
                            }
                        } else {
                            this.classList.remove('link-valid', 'link-invalid');
                            // Restore file upload box
                            if (uploadBox) {
                                uploadBox.style.opacity = '';
                                uploadBox.style.pointerEvents = '';
                            }
                        }
                    });
                });
            }

            // Initialize file input handlers when modal opens
            document.addEventListener('DOMContentLoaded', setupFileInputHandlers);

            // Upload file to R2 storage via worker endpoint
            async function uploadFileToR2(file, retryCount = 0) {
                if (!file) return null;

                // Check file size (max 100MB)
                const MAX_FILE_SIZE = 100 * 1024 * 1024;
                if (file.size > MAX_FILE_SIZE) {
                    const sizeMB = (file.size / 1024 / 1024).toFixed(1);
                    alert(`די פייל איז צו גרויס (${sizeMB}MB). מאקסימום ערלויבט איז 100MB.`);
                    return null;
                }

                const formData = new FormData();
                formData.append('file', file, file.name);

                try {
                    // Upload to worker's /api/upload which stores in R2 and returns a public URL
                    const uploadUrl = WORKER_URL.replace(/api\/$/, 'api/upload');
                    console.log('Uploading file to:', uploadUrl);

                    const response = await fetch(uploadUrl, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('File upload failed:', response.status, errorText);

                        // Retry on 502/503/timeout errors (up to 3 attempts)
                        if ((response.status === 502 || response.status === 503) && retryCount < 2) {
                            const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s
                            console.log(`Retrying upload in ${delay}ms (attempt ${retryCount + 2}/3)...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return uploadFileToR2(file, retryCount + 1);
                        }

                        return null;
                    }

                    const result = await response.json();
                    console.log('File uploaded successfully:', result);
                    // Worker returns { success, url, blobId (=url), fileName, size, type }
                    return result;
                } catch (error) {
                    console.error('File upload error:', error);

                    // Retry on network errors (up to 3 attempts)
                    if (retryCount < 2) {
                        const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s
                        console.log(`Retrying upload in ${delay}ms (attempt ${retryCount + 2}/3)...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return uploadFileToR2(file, retryCount + 1);
                    }

                    return null;
                }
            }

            // Upload multiple files to R2 bucket
            async function uploadFilesToR2(files) {
                if (!files || files.length === 0) return [];

                const uploadPromises = Array.from(files).map(file => uploadFileToR2(file));
                const results = await Promise.all(uploadPromises);
                return results.filter(result => result !== null);
            }

            // Submit add info to Coda table
            const ADDINFO_TABLE_ID = 'grid-LutCbIuQvQ';

            async function submitAddInfo() {
                // Validate links if pasted
                const invalidLink = document.querySelector('#addinfo-panel .addinfo-file-link-input.link-invalid');
                if (invalidLink && invalidLink.value.trim()) {
                    alert('ביטע נוצן א דירעקטע לינק פון Google Drive אדער Dropbox.');
                    invalidLink.focus();
                    return;
                }

                // Validate: if audio file is attached, checkbox must be checked
                const audioFile = document.getElementById('addinfo-audio').files[0];
                const audioLink = document.getElementById('addinfo-audio-link')?.value?.trim() || '';
                const rightsCheckbox = document.getElementById('addinfo-rights-confirm');
                if ((audioFile || audioLink) && !rightsCheckbox.checked) {
                    alert('Please confirm that you own the rights to this recording before submitting.');
                    rightsCheckbox.focus();
                    return;
                }

                // Helper to convert a name to row ID using info objects
                // For lookups, Coda expects row IDs (i-xxx format) to create proper links
                const getRowId = (name, infoObject) => {
                    if (!name || !infoObject) return name;
                    const info = infoObject[name];
                    return info && info.rowId ? info.rowId : name;
                };

                // Convert array of names to array of row IDs
                const getRowIds = (names, infoObject) => {
                    if (!names || !Array.isArray(names) || names.length === 0) return [];
                    return names.map(name => getRowId(name, infoObject));
                };

                // Get single-select values (from addinfoSelectedValues or fallback to input value)
                const getMechaberValue = () => {
                    const selected = addinfoSelectedValues['addinfo-mechaber'];
                    if (selected && selected.length > 0) return selected[0];
                    return document.getElementById('addinfo-mechaber').value || '';
                };

                const getScaleValue = () => {
                    const selected = addinfoSelectedValues['addinfo-scale'];
                    if (selected && selected.length > 0) return selected[0];
                    return document.getElementById('addinfo-scale').value || '';
                };

                const getRhythmValue = () => {
                    const selected = addinfoSelectedValues['addinfo-rhythm'];
                    if (selected && selected.length > 0) return selected[0];
                    return document.getElementById('addinfo-rhythm').value || '';
                };

                // Collect form data
                const formData = {
                    nigunId: currentAddInfoSongId,
                    nigunName: currentAddInfoSongName,
                    mechaber: getMechaberValue(),
                    personalities: addinfoSelectedValues['addinfo-personalities'] || [],
                    chatzer: addinfoSelectedValues['addinfo-chatzer'] || [],
                    piyut: addinfoSelectedValues['addinfo-piyut'] || [],
                    verter: addinfoSelectedValues['addinfo-verter'] || [],
                    siman: document.getElementById('addinfo-siman').value,
                    alsoPiyut: addinfoSelectedValues['addinfo-also-piyut'] || [],
                    scale: getScaleValue(),
                    rhythm: getRhythmValue(),
                    collections: addinfoSelectedValues['addinfo-collections'] || [],
                    documents: addinfoSelectedValues['addinfo-documents'] || [],
                    albums: addinfoSelectedValues['addinfo-albums'] || [],
                    audioFile: document.getElementById('addinfo-audio').files[0],
                    audioLink: document.getElementById('addinfo-audio-link')?.value.trim() || '',
                    rightsConfirmed: document.getElementById('addinfo-rights-confirm').checked,
                    recordingDetails: document.getElementById('addinfo-recording-details').value,
                    recordingPersonality: addinfoSelectedValues['addinfo-recording-personality'] || [],
                    recordingAlbum: addinfoSelectedValues['addinfo-recording-album'] || [],
                    otherFiles: document.getElementById('addinfo-files').files,
                    otherFilesLink: document.getElementById('addinfo-files-link')?.value.trim() || '',
                    filesDetails: document.getElementById('addinfo-files-details').value,
                    notes: document.getElementById('addinfo-notes').value
                };



                // Get the submit button and save original text
                const submitBtn = document.querySelector('#addinfo-panel .addinfo-submit-btn');
                const originalBtnText = submitBtn ? submitBtn.innerHTML : '';

                // Upload files to R2 if present, or use pasted links
                let uploadedAudioUrl = '';
                let uploadedOtherFilesUrls = [];

                // Show uploading state if there are files to upload
                const hasFilesToUpload = formData.audioFile || (formData.otherFiles && formData.otherFiles.length > 0);
                if (hasFilesToUpload && submitBtn) {
                    submitBtn.innerHTML = 'אפלאודינג<span class="btn-spinner"></span>';
                    submitBtn.classList.add('loading');
                    submitBtn.disabled = true;
                }

                if (formData.audioFile) {
                    const audioResult = await uploadFileToR2(formData.audioFile);
                    if (audioResult && audioResult.success) {
                        uploadedAudioUrl = audioResult.blobId;
                        console.log('Audio file uploaded, blobId:', uploadedAudioUrl);
                    }
                } else if (formData.audioLink) {
                    uploadedAudioUrl = formData.audioLink;
                    console.log('Using audio link:', uploadedAudioUrl);
                }

                if (formData.otherFiles && formData.otherFiles.length > 0) {
                    const otherResults = await uploadFilesToR2(formData.otherFiles);
                    uploadedOtherFilesUrls = otherResults.map(r => r.blobId);
                    console.log('Other files uploaded, blobIds:', uploadedOtherFilesUrls);
                } else if (formData.otherFilesLink) {
                    uploadedOtherFilesUrls = [formData.otherFilesLink];
                    console.log('Using other files link:', formData.otherFilesLink);
                }


                // Build row data for Coda API
                // Column mappings based on user specification
                // Use row IDs for lookup columns to create proper relations
                const cells = [
                    // c-1eHE4HQup7: ניגון (lookup) - Use nigun row ID if available
                    { column: 'c-1eHE4HQup7', value: formData.nigunId || formData.nigunName },

                    // c-957MCX4fP3: מחבר (lookup) - Convert to row ID
                    { column: 'c-957MCX4fP3', value: getRowId(formData.mechaber, mechabrimInfo) },

                    // c-ZSb8Zvuye2: פערזענליכטן (lookup array) - Convert to row IDs
                    { column: 'c-ZSb8Zvuye2', value: getRowIds(formData.personalities, mechabrimInfo) },

                    // c-RNILpWB0xd: ווערט געזינגען אין חצר (lookup array) - Convert to row IDs
                    { column: 'c-RNILpWB0xd', value: getRowIds(formData.chatzer, chatzerosInfo) },

                    // c-mqtoH1-w8e: אויפן פיוט (lookup array) - Convert to row IDs
                    { column: 'c-mqtoH1-w8e', value: getRowIds(formData.piyut, piyutimInfo) },

                    // c-XCHK7TgqU4: די ווערטער פונעם ניגון (lookup array) - Convert to row IDs
                    { column: 'c-XCHK7TgqU4', value: getRowIds(formData.verter, verterInfo) },

                    // c-gtrCPSKT8T: א סימן (text)
                    { column: 'c-gtrCPSKT8T', value: formData.siman || '' },

                    // c-AAqH_a6yvg: און איז אויך פאסיג (lookup array) - Convert to row IDs
                    { column: 'c-AAqH_a6yvg', value: getRowIds(formData.alsoPiyut, piyutimInfo) },

                    // c-L78zihwwxk: סקעיל (lookup) - Convert to row ID
                    { column: 'c-L78zihwwxk', value: getRowId(formData.scale, scaleInfo) },

                    // c-5TTjXuxCIm: ריטעם (lookup) - Convert to row ID
                    { column: 'c-5TTjXuxCIm', value: getRowId(formData.rhythm, rhythmInfo) },

                    // c-_JlFihcdEc: קאלעקשנס (lookup array) - Convert to row IDs
                    { column: 'c-_JlFihcdEc', value: getRowIds(formData.collections, collectionsInfo) },

                    // c-GPbs5itGVl: דאקומענטן (lookup array) - Convert to row IDs
                    { column: 'c-GPbs5itGVl', value: getRowIds(formData.documents, documentsInfo) },

                    // c-lG1-Yh6PQO: אלבומס (lookup array) - Convert to row IDs
                    { column: 'c-lG1-Yh6PQO', value: getRowIds(formData.albums, albumsInfo) },

                    // c-_cLY9rI_C1: rights confirmation (checkbox)
                    { column: 'c-_cLY9rI_C1', value: formData.rightsConfirmed },

                    // c-d0S0MqwE_D: דעטאלן פונעם רעקארדירונג (text)
                    { column: 'c-d0S0MqwE_D', value: formData.recordingDetails || '' },

                    // c-EdZrAwA4oP: פערזענליכקייט פונעם רעקארדירונג (lookup array) - Convert to row IDs
                    { column: 'c-EdZrAwA4oP', value: getRowIds(formData.recordingPersonality, mechabrimInfo) },

                    // c-dCDDsxX9LB: אלבום פונעם רעקארדירונג (lookup array) - Convert to row IDs
                    { column: 'c-dCDDsxX9LB', value: getRowIds(formData.recordingAlbum, albumsInfo) },

                    // c-rzbIDQBUAB: דעטאלן פון דעם פייל (text)
                    { column: 'c-rzbIDQBUAB', value: formData.filesDetails || '' },

                    // c-c-aKWszo9F: הערות / מער אינפארמאציע (text)
                    { column: 'c-c-aKWszo9F', value: formData.notes || '' },

                    // c-6N7DQIohAK: אודיאו פייל URL
                    { column: 'c-6N7DQIohAK', value: uploadedAudioUrl },

                    // c-EEhnRJ4fQT: אנדערע פיילס URLs
                    { column: 'c-EEhnRJ4fQT', value: uploadedOtherFilesUrls.join(', ') }
                ];

                // Filter out empty values to avoid sending unnecessary data
                const filteredCells = cells.filter(cell => {
                    if (Array.isArray(cell.value)) return cell.value.length > 0;
                    if (typeof cell.value === 'boolean') return true;
                    return cell.value !== '';
                });

                const rowData = { cells: filteredCells };

                try {
                    const response = await fetch(`${WORKER_URL}docs/${DOC_ID}/tables/${ADDINFO_TABLE_ID}/rows`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ rows: [rowData] })
                    });

                    if (response.ok) {

                        // Hide modal body and show success message
                        const modalBody = document.querySelector('.addinfo-modal-body');
                        const successMsg = document.getElementById('addinfoSuccessMessage');

                        if (modalBody) modalBody.style.display = 'none';
                        if (successMsg) successMsg.style.display = 'block';

                        // Reset button
                        if (submitBtn) {
                            submitBtn.innerHTML = originalBtnText;
                            submitBtn.classList.remove('loading');
                            submitBtn.disabled = false;
                        }

                        // Auto close after 4 seconds
                        setTimeout(() => {
                            if (successMsg) successMsg.style.display = 'none';
                            if (modalBody) modalBody.style.display = '';
                            closeAddInfoModal();
                        }, 4000);
                    } else {
                        const errorText = await response.text();
                        console.error('Add Info submission failed:', errorText);
                        // Reset button on error
                        if (submitBtn) {
                            submitBtn.innerHTML = originalBtnText;
                            submitBtn.classList.remove('loading');
                            submitBtn.disabled = false;
                        }
                        alert('עס איז געווען א פראבלעם. ביטע פרובירט שפעטער נאכאמאל.');
                    }
                } catch (error) {
                    console.error('Add Info submission error:', error);
                    // Reset button on error
                    if (submitBtn) {
                        submitBtn.innerHTML = originalBtnText;
                        submitBtn.classList.remove('loading');
                        submitBtn.disabled = false;
                    }
                    alert('עס איז געווען א פראבלעם. ביטע פרובירט שפעטער נאכאמאל.');
                }
            }

            // Submit add nigun (placeholder - similar to add info)
            async function submitAddNigun() {
                const nigunNameInput = document.getElementById('addnigun-name');
                const nigunNameError = document.getElementById('addnigun-name-error');
                const nigunName = nigunNameInput.value.trim();

                // Clear previous error
                nigunNameError.classList.remove('visible');
                nigunNameError.textContent = '';

                // Validate nigun name is not empty
                if (!nigunName) {
                    nigunNameError.textContent = 'ביטע אריינשרייבן א נאמען פארן ניגון';
                    nigunNameError.classList.add('visible');
                    nigunNameInput.focus();
                    return;
                }

                // Validate nigun name is unique (check against allSongs)
                const existingNigun = allSongs.find(song =>
                    song.name && song.name.trim().toLowerCase() === nigunName.toLowerCase()
                );
                if (existingNigun) {
                    nigunNameError.textContent = 'עס איז שוין דא א ניגון מיט דעם נאמען. ביטע לייגט אריין אינעם נאמען נאך אינפארמאציע, ווי צום ביישפיל דער מחבר אדער חצר, כדי עס צו מאכן אייגנארטיג';
                    nigunNameError.classList.add('visible');
                    nigunNameInput.focus();
                    return;
                }

                // Validate: if audio file is attached, checkbox must be checked
                const audioFile = document.getElementById('addnigun-audio').files[0];
                const rightsCheckbox = document.getElementById('addnigun-rights-confirm');
                // Validate links if pasted
                const invalidLink = document.querySelector('#addnigun-panel .addinfo-file-link-input.link-invalid');
                if (invalidLink && invalidLink.value.trim()) {
                    alert('ביטע נוצן א דירעקטע לינק פון Google Drive אדער Dropbox.');
                    invalidLink.focus();
                    return;
                }

                const audioLink = document.getElementById('addnigun-audio-link')?.value?.trim() || '';
                if ((audioFile || audioLink) && !rightsCheckbox.checked) {
                    alert('Please confirm that you own the rights to this recording before submitting.');
                    return;
                }

                // Get single-select values for addnigun fields
                const getAddnigunMechaberValue = () => {
                    const selected = addinfoSelectedValues['addnigun-mechaber'];
                    if (selected && selected.length > 0) return selected[0];
                    return document.getElementById('addnigun-mechaber')?.value || '';
                };

                const getAddnigunScaleValue = () => {
                    const selected = addinfoSelectedValues['addnigun-scale'];
                    if (selected && selected.length > 0) return selected[0];
                    return document.getElementById('addnigun-scale')?.value || '';
                };

                const getAddnigunRhythmValue = () => {
                    const selected = addinfoSelectedValues['addnigun-rhythm'];
                    if (selected && selected.length > 0) return selected[0];
                    return document.getElementById('addnigun-rhythm')?.value || '';
                };

                // Collect all form data for submission
                const formData = {
                    nigunName: nigunName,
                    mechaber: getAddnigunMechaberValue(),
                    personalities: addinfoSelectedValues['addnigun-personalities'] || [],
                    chatzer: addinfoSelectedValues['addnigun-chatzer'] || [],
                    piyut: addinfoSelectedValues['addnigun-piyut'] || [],
                    verter: addinfoSelectedValues['addnigun-verter'] || [],
                    siman: document.getElementById('addnigun-siman')?.value?.trim() || '',
                    alsoPiyut: addinfoSelectedValues['addnigun-also-piyut'] || [],
                    scale: getAddnigunScaleValue(),
                    rhythm: getAddnigunRhythmValue(),
                    collections: addinfoSelectedValues['addnigun-collections'] || [],
                    documents: addinfoSelectedValues['addnigun-documents'] || [],
                    albums: addinfoSelectedValues['addnigun-albums'] || [],
                    audioFile: audioFile,
                    audioLink: document.getElementById('addnigun-audio-link')?.value?.trim() || '',
                    recordingDetails: document.getElementById('addnigun-recording-details')?.value?.trim() || '',
                    recordingPersonality: addinfoSelectedValues['addnigun-recording-personality'] || [],
                    recordingAlbum: addinfoSelectedValues['addnigun-recording-album'] || [],
                    otherFiles: document.getElementById('addnigun-files')?.files,
                    otherFilesLink: document.getElementById('addnigun-files-link')?.value?.trim() || '',
                    filesDetails: document.getElementById('addnigun-files-details')?.value?.trim() || '',
                    notes: document.getElementById('addnigun-notes')?.value?.trim() || ''
                };

                // Get the submit button and save original text
                const submitBtn = document.querySelector('#addnigun-panel .addinfo-submit-btn');
                const originalBtnText = submitBtn ? submitBtn.innerHTML : '';

                // Upload files to R2 if present, or use pasted links
                let uploadedAudioUrl = '';
                let uploadedOtherFilesUrls = [];

                // Show uploading state if there are files to upload
                const hasFilesToUpload = formData.audioFile || (formData.otherFiles && formData.otherFiles.length > 0);
                if (hasFilesToUpload && submitBtn) {
                    submitBtn.innerHTML = 'אפלאודינג<span class="btn-spinner"></span>';
                    submitBtn.classList.add('loading');
                    submitBtn.disabled = true;
                }

                if (formData.audioFile) {
                    const audioResult = await uploadFileToR2(formData.audioFile);
                    if (audioResult && audioResult.success) {
                        uploadedAudioUrl = audioResult.blobId;
                        console.log('Audio file uploaded, blobId:', uploadedAudioUrl);
                    }
                } else if (formData.audioLink) {
                    uploadedAudioUrl = formData.audioLink;
                    console.log('Using audio link:', uploadedAudioUrl);
                }

                if (formData.otherFiles && formData.otherFiles.length > 0) {
                    const otherResults = await uploadFilesToR2(formData.otherFiles);
                    uploadedOtherFilesUrls = otherResults.map(r => r.blobId);
                    console.log('Other files uploaded, blobIds:', uploadedOtherFilesUrls);
                } else if (formData.otherFilesLink) {
                    uploadedOtherFilesUrls = [formData.otherFilesLink];
                    console.log('Using other files link:', formData.otherFilesLink);
                }

                // Helper to convert a name to row ID using info objects
                // For lookups, Coda expects row IDs (i-xxx format) to create proper links
                const getRowId = (name, infoObject) => {
                    if (!name || !infoObject) return name;
                    const info = infoObject[name];
                    return info && info.rowId ? info.rowId : name;
                };

                // Convert array of names to array of row IDs
                const getRowIds = (names, infoObject) => {
                    if (!names || !Array.isArray(names) || names.length === 0) return [];
                    return names.map(name => getRowId(name, infoObject));
                };

                // Build cells array for Coda API - using same columns as submitAddInfo
                const cells = [
                    // c-rUBafw88EY: ניגון נאמען (text) - NEW column for nigun name
                    { column: 'c-rUBafw88EY', value: formData.nigunName },

                    // c-957MCX4fP3: מחבר (lookup) - Convert to row ID
                    { column: 'c-957MCX4fP3', value: getRowId(formData.mechaber, mechabrimInfo) },

                    // c-ZSb8Zvuye2: פערזענליכטן (lookup array) - Convert to row IDs
                    { column: 'c-ZSb8Zvuye2', value: getRowIds(formData.personalities, mechabrimInfo) },

                    // c-RNILpWB0xd: ווערט געזינגען אין חצר (lookup array) - Convert to row IDs
                    { column: 'c-RNILpWB0xd', value: getRowIds(formData.chatzer, chatzerosInfo) },

                    // c-mqtoH1-w8e: אויפן פיוט (lookup array) - Convert to row IDs
                    { column: 'c-mqtoH1-w8e', value: getRowIds(formData.piyut, piyutimInfo) },

                    // c-XCHK7TgqU4: די ווערטער פונעם ניגון (lookup array) - Convert to row IDs
                    { column: 'c-XCHK7TgqU4', value: getRowIds(formData.verter, verterInfo) },

                    // c-gtrCPSKT8T: א סימן (text)
                    { column: 'c-gtrCPSKT8T', value: formData.siman || '' },

                    // c-AAqH_a6yvg: און איז אויך פאסיג (lookup array) - Convert to row IDs
                    { column: 'c-AAqH_a6yvg', value: getRowIds(formData.alsoPiyut, piyutimInfo) },

                    // c-L78zihwwxk: סקעיל (lookup) - Convert to row ID
                    { column: 'c-L78zihwwxk', value: getRowId(formData.scale, scaleInfo) },

                    // c-5TTjXuxCIm: ריטעם (lookup) - Convert to row ID
                    { column: 'c-5TTjXuxCIm', value: getRowId(formData.rhythm, rhythmInfo) },

                    // c-_JlFihcdEc: קאלעקשנס (lookup array) - Convert to row IDs
                    { column: 'c-_JlFihcdEc', value: getRowIds(formData.collections, collectionsInfo) },

                    // c-GPbs5itGVl: דאקומענטן (lookup array) - Convert to row IDs
                    { column: 'c-GPbs5itGVl', value: getRowIds(formData.documents, documentsInfo) },

                    // c-lG1-Yh6PQO: אלבומס (lookup array) - Convert to row IDs
                    { column: 'c-lG1-Yh6PQO', value: getRowIds(formData.albums, albumsInfo) },

                    // c-d0S0MqwE_D: דעטאלן פונעם רעקארדירונג (text)
                    { column: 'c-d0S0MqwE_D', value: formData.recordingDetails || '' },

                    // c-EdZrAwA4oP: פערזענליכקייט פונעם רעקארדירונג (lookup array) - Convert to row IDs
                    { column: 'c-EdZrAwA4oP', value: getRowIds(formData.recordingPersonality, mechabrimInfo) },

                    // c-dCDDsxX9LB: אלבום פונעם רעקארדירונג (lookup array) - Convert to row IDs
                    { column: 'c-dCDDsxX9LB', value: getRowIds(formData.recordingAlbum, albumsInfo) },

                    // c-rzbIDQBUAB: דעטאלן פון דעם פייל (text)
                    { column: 'c-rzbIDQBUAB', value: formData.filesDetails || '' },

                    // c-c-aKWszo9F: הערות / מער אינפארמאציע (text)
                    { column: 'c-c-aKWszo9F', value: formData.notes || '' },

                    // c-6N7DQIohAK: אודיאו פייל URL
                    { column: 'c-6N7DQIohAK', value: uploadedAudioUrl },

                    // c-EEhnRJ4fQT: אנדערע פיילס URLs
                    { column: 'c-EEhnRJ4fQT', value: uploadedOtherFilesUrls.join(', ') }
                ];

                // Filter out empty values
                const filteredCells = cells.filter(cell => {
                    if (Array.isArray(cell.value)) return cell.value.length > 0;
                    return cell.value !== '';
                });

                const rowData = { cells: filteredCells };

                try {
                    const response = await fetch(`${WORKER_URL}docs/${DOC_ID}/tables/${ADDINFO_TABLE_ID}/rows`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ rows: [rowData] })
                    });

                    if (response.ok) {

                        // Hide modal body and show success message
                        const modalBody = document.querySelector('.addinfo-modal-body');
                        const successMsg = document.getElementById('addnigunSuccessMessage');

                        if (modalBody) modalBody.style.display = 'none';
                        if (successMsg) successMsg.style.display = 'block';

                        // Reset button
                        if (submitBtn) {
                            submitBtn.innerHTML = originalBtnText;
                            submitBtn.classList.remove('loading');
                            submitBtn.disabled = false;
                        }

                        // Clear the form
                        nigunNameInput.value = '';
                        nigunNameError.classList.remove('visible');

                        // Auto close after 4 seconds
                        setTimeout(() => {
                            if (successMsg) successMsg.style.display = 'none';
                            if (modalBody) modalBody.style.display = '';
                            closeAddInfoModal();
                        }, 4000);
                    } else {
                        const errorText = await response.text();
                        console.error('Add Nigun submission failed:', errorText);
                        // Reset button on error
                        if (submitBtn) {
                            submitBtn.innerHTML = originalBtnText;
                            submitBtn.classList.remove('loading');
                            submitBtn.disabled = false;
                        }
                        alert('עס איז געווען א פראבלעם. ביטע פרובירט שפעטער נאכאמאל.');
                    }
                } catch (error) {
                    console.error('Add Nigun submission error:', error);
                    // Reset button on error
                    if (submitBtn) {
                        submitBtn.innerHTML = originalBtnText;
                        submitBtn.classList.remove('loading');
                        submitBtn.disabled = false;
                    }
                    alert('עס איז געווען א פראבלעם. ביטע פרובירט שפעטער נאכאמאל.');
                }
            }

            // Open report modal for current nigun (uses combined modal)
            function openReportModal() {
                // Get the current song name and ID from the modal, full page, or player
                let songName = '';
                let songId = '';
                if (currentNigunModalIdx !== null && allSongs[currentNigunModalIdx]) {
                    songName = allSongs[currentNigunModalIdx].name;
                    songId = allSongs[currentNigunModalIdx].customId || '';
                } else if (window.currentDetailPageSongIdx !== undefined && allSongs[window.currentDetailPageSongIdx]) {
                    songName = allSongs[window.currentDetailPageSongIdx].name;
                    songId = allSongs[window.currentDetailPageSongIdx].customId || '';
                } else if (currentSongIndex !== null && allSongs[currentSongIndex]) {
                    songName = allSongs[currentSongIndex].name;
                    songId = allSongs[currentSongIndex].customId || '';
                }

                currentReportSongName = songName;
                currentReportSongId = songId;

                // Use the combined modal - update song name
                const songNameEl = document.getElementById('addinfoSongName');
                songNameEl.textContent = songName || 'אומבאקאנט';

                // Reset report form
                document.getElementById('reportCategory').value = '';
                document.getElementById('reportDetails').value = '';

                // Hide and reset duplicate nigun selector
                document.getElementById('duplicateNigunRow').style.display = 'none';
                addinfoSelectedValues['report-duplicate-nigun'] = [];
                const dupNigunTags = document.getElementById('report-duplicate-nigun-tags');
                if (dupNigunTags) dupNigunTags.innerHTML = '';
                const dupNigunInput = document.getElementById('report-duplicate-nigun');
                if (dupNigunInput) dupNigunInput.value = '';

                // Switch to report panel and show modal
                switchModalPanel('report');
                document.getElementById('addinfoModalOverlay').classList.add('active');
            }

            // Close report modal (uses combined modal)
            function closeReportModal() {
                closeAddInfoModal();
            }

            // Handle report category change - show/hide duplicate nigun selector
            function handleReportCategoryChange() {
                const category = document.getElementById('reportCategory').value;
                const duplicateRow = document.getElementById('duplicateNigunRow');

                if (category === 'duplicate') {
                    duplicateRow.style.display = '';
                    // Re-initialize autocomplete for the duplicate nigun field
                    setupDuplicateNigunAutocomplete();
                } else {
                    duplicateRow.style.display = 'none';
                    // Clear any selected values
                    addinfoSelectedValues['report-duplicate-nigun'] = [];
                    const tags = document.getElementById('report-duplicate-nigun-tags');
                    if (tags) tags.innerHTML = '';
                }
            }

            // Setup autocomplete for duplicate nigun field specifically
            function setupDuplicateNigunAutocomplete() {
                const wrapper = document.querySelector('#duplicateNigunRow .addinfo-autocomplete-wrapper');
                if (!wrapper) return;

                const input = wrapper.querySelector('.addinfo-autocomplete-input');
                const dropdown = wrapper.querySelector('.addinfo-autocomplete-dropdown');
                const tagsContainer = wrapper.querySelector('.addinfo-selected-tags');
                const source = 'nigunim';
                const isMulti = true;
                const fieldId = 'report-duplicate-nigun';

                // Initialize selected values array
                if (!addinfoSelectedValues[fieldId]) {
                    addinfoSelectedValues[fieldId] = [];
                }

                // Remove existing listeners by cloning
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);

                // Input event for filtering
                newInput.addEventListener('input', () => {
                    const query = newInput.value.trim().toLowerCase();
                    showAddinfoDropdown(wrapper, source, query, isMulti, fieldId);
                });

                // Focus event to show dropdown
                newInput.addEventListener('focus', () => {
                    const query = newInput.value.trim().toLowerCase();
                    showAddinfoDropdown(wrapper, source, query, isMulti, fieldId);
                });

                // Blur event to hide dropdown
                newInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        dropdown.classList.remove('active');
                    }, 200);
                });

                // Keyboard navigation
                newInput.addEventListener('keydown', (e) => {
                    const items = dropdown.querySelectorAll('.addinfo-autocomplete-item');
                    const highlighted = dropdown.querySelector('.addinfo-autocomplete-item.highlighted');

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (!highlighted && items.length > 0) {
                            items[0].classList.add('highlighted');
                        } else if (highlighted && highlighted.nextElementSibling) {
                            highlighted.classList.remove('highlighted');
                            highlighted.nextElementSibling.classList.add('highlighted');
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (highlighted && highlighted.previousElementSibling) {
                            highlighted.classList.remove('highlighted');
                            highlighted.previousElementSibling.classList.add('highlighted');
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (highlighted) {
                            // For nigunim, pass rowId from data attribute
                            const rowId = highlighted.dataset.rowid;
                            selectAddinfoItem(wrapper, highlighted.textContent, isMulti, fieldId, source, rowId);
                        }
                    } else if (e.key === 'Escape') {
                        dropdown.classList.remove('active');
                        newInput.blur();
                    }
                });
            }

            // Switch between panels in combined modal with slide animation
            function switchModalPanel(panelName) {
                const toggle = document.querySelector('.addinfo-modal-toggle');
                const reportPanel = document.getElementById('reportPanel');
                const addinfoPanel = document.getElementById('addinfoPanel');
                const addnigunPanel = document.getElementById('addnigunPanel');
                const currentActive = document.querySelector('.addinfo-panel.active');
                const songNameEl = document.getElementById('addinfoSongName');
                const nigunNameHeader = document.getElementById('addnigunNameHeader');

                // Panel order: addnigun (0), addinfo (1), report (2)
                const panelOrder = { 'addnigun': 0, 'addinfo': 1, 'report': 2 };
                const panels = { 'addnigun': addnigunPanel, 'addinfo': addinfoPanel, 'report': reportPanel };

                const targetPanel = panels[panelName];
                const targetIndex = panelOrder[panelName];

                // Get current panel index
                let currentIndex = 1; // default to addinfo
                if (currentActive === addnigunPanel) currentIndex = 0;
                else if (currentActive === reportPanel) currentIndex = 2;

                // Update toggle indicator - remove all state classes and add the correct one
                toggle.classList.remove('addnigun-active', 'addinfo-active', 'report-active');
                toggle.classList.add(panelName + '-active');

                // Update toggle buttons
                document.querySelectorAll('.addinfo-modal-toggle-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.panel === panelName);
                });

                // Show/hide song name vs nigun input in header
                if (panelName === 'addnigun') {
                    songNameEl.style.display = 'none';
                    nigunNameHeader.style.display = 'block';
                } else {
                    songNameEl.style.display = '';
                    nigunNameHeader.style.display = 'none';
                }

                // If same panel, do nothing
                if (currentActive === targetPanel) {
                    return;
                }

                // Determine slide direction based on panel order
                const goingLeft = targetIndex > currentIndex;

                // Animate out current panel
                if (currentActive) {
                    currentActive.classList.add(goingLeft ? 'slide-out-right' : 'slide-out-left');
                    setTimeout(() => {
                        currentActive.classList.remove('active', 'slide-out-left', 'slide-out-right');
                    }, 300);
                }

                // Animate in new panel from opposite direction
                setTimeout(() => {
                    targetPanel.classList.add('active', goingLeft ? 'slide-in-left' : 'slide-in-right');
                    setTimeout(() => targetPanel.classList.remove('slide-in-left', 'slide-in-right'), 300);
                }, 150);
            }

            // Submit report to Coda
            async function submitReport() {
                const category = document.getElementById('reportCategory').value;
                const details = document.getElementById('reportDetails').value.trim();

                if (!category) {
                    alert('ביטע אויסוועלן א קאטעגאריע');
                    return;
                }

                // Category labels for Coda
                const categoryLabels = {
                    'duplicate': 'דאפלטע ניגון',
                    'hasagat-gvul': 'השגת גבול',
                    'modern': 'היינטיג/מאדערן',
                    'incorrect-info': 'אומריכטיגע אינפארמאציע',
                    'other': 'אנדערע הערות'
                };

                // Prepare the row data for Coda API - send rowId for unique identification
                const cells = [
                    { column: 'c-y3_VeoDRKA', value: '#' + currentReportSongId },           // ניגון ID (for formula lookup)
                    { column: 'c-0C7oWrHcmO', value: '#' + currentReportSongId },           // ניגון ID (backup)
                    { column: 'c-uXqZMLIGez', value: categoryLabels[category] },      // קאטאגאריע
                    { column: 'c-kpn8KWBYiA', value: details }                        // אינפארמאציע
                ];

                // If duplicate category, add the selected duplicate niguns
                if (category === 'duplicate') {
                    const duplicateNigunRowIds = addinfoSelectedValues['report-duplicate-nigun'] || [];
                    if (duplicateNigunRowIds.length > 0) {
                        // Convert rowIds to customIds with # prefix
                        const duplicateNigunIds = duplicateNigunRowIds.map(rowId => {
                            const song = allSongs.find(s => s.rowId === rowId);
                            return song && song.customId ? '#' + song.customId : rowId;
                        });
                        cells.push({ column: 'c-HoQV_ar9bZ', value: duplicateNigunIds }); // דאפלטע ניגונים
                    }
                }

                const rowData = { cells };

                try {
                    const response = await fetch(`${WORKER_URL}docs/${DOC_ID}/tables/${REPORTS_TABLE_ID}/rows`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ rows: [rowData] })
                    });

                    if (response.ok) {
                        // Show success state in report panel
                        const reportPanel = document.getElementById('reportPanel');
                        const successMsg = document.getElementById('reportSuccessMessage');
                        const modalBody = document.querySelector('.addinfo-modal-body');

                        // Hide modal body and show success message
                        if (modalBody) modalBody.style.display = 'none';
                        if (successMsg) successMsg.style.display = 'block';

                        // Auto-close after 4 seconds
                        setTimeout(() => {
                            if (successMsg) successMsg.style.display = 'none';
                            if (modalBody) modalBody.style.display = '';
                            closeReportModal();
                        }, 4000);
                    } else {
                        console.error('Report submission failed:', await response.text());
                        alert('עס איז געווען א פראבלעם. ביטע פרובירט שפעטער נאכאמאל.');
                    }
                } catch (error) {
                    console.error('Report submission error:', error);
                    alert('עס איז געווען א פראבלעם. ביטע פרובירט שפעטער נאכאמאל.');
                }
            }

            // Generic detail modal state
            let detailModalOpen = false;
            let currentDetailModalType = null;
            let currentDetailModalName = null;

            // Flag to skip next popstate handler call (when we're closing a modal ourselves)
            let skipNextPopstateHandler = false;

            // Open generic detail modal
            async function openDetailModal(type, name, skipHistory = false) {
                // Save current scroll position
                savedScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                detailModalOpen = true;
                currentDetailModalType = type;
                currentDetailModalName = name;

                // Get theme class and title for this type
                const themeMap = {
                    'mechabrim': 'theme-mechaber',
                    'chatzeros': 'theme-chatzer',
                    'verter': 'theme-verter',
                    'zmanim': 'theme-zman',
                    'piyutim': 'theme-piyut',
                    'collections': 'theme-collection',
                    'albums': 'theme-album',
                    'documents': 'theme-document',
                    'resources': 'theme-resource'
                };
                const titleMap = {
                    'mechabrim': 'מחבר',
                    'chatzeros': 'חצר',
                    'verter': 'ווערטער',
                    'zmanim': 'זמן',
                    'piyutim': 'פיוט',
                    'collections': 'קאלעקשן',
                    'albums': 'אלבום',
                    'documents': 'דאקומענט',
                    'resources': 'רעסורס'
                };
                const themeClass = themeMap[type] || '';
                const categoryTitle = titleMap[type] || 'דעטאלן';

                // Update URL (with /preview for modal mode) - skip if already at correct URL
                if (!skipHistory) {
                    const itemId = getDetailItemId(type, name);
                    const hash = `#/${type}/${encodeURIComponent(itemId)}/preview`;
                    history.pushState({ detailModal: true, scrollPos: savedScrollPosition, type: type, name: name }, '', hash);
                }

                // Check if there are already modals open (for stacking)
                const hasExistingModals = modalStack.length > 0;

                // Create a new dynamic modal overlay for stacking
                modalZIndexCounter++;
                const modalId = 'dynamicDetailModal_' + modalZIndexCounter;

                // Create overlay element
                const overlay = document.createElement('div');
                overlay.className = 'detail-modal-overlay';
                overlay.id = modalId;
                overlay.style.zIndex = modalZIndexCounter;
                overlay.onclick = function (e) { if (e.target === this) closeTopDetailModal(); };

                // If stacking on top of existing modal, make background transparent
                if (hasExistingModals) {
                    overlay.style.background = 'transparent';
                    overlay.style.backdropFilter = 'none';
                }

                // Create modal content structure
                overlay.innerHTML = `
                <div class="detail-modal-content ${themeClass}">
                    <button class="detail-modal-expand" onclick="event.stopPropagation(); expandToFullPage()"
                        title="עקספענד צו פולע בלאט">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <polyline points="9 21 3 21 3 15"></polyline>
                            <line x1="21" y1="3" x2="14" y2="10"></line>
                            <line x1="3" y1="21" x2="10" y2="14"></line>
                        </svg>
                    </button>
                    <button class="detail-modal-close" onclick="event.stopPropagation(); closeTopDetailModal()">×</button>
                    <div class="detail-modal-body"><div class="loading"><div class="spinner"></div><p>לאודינג...</p></div></div>
                </div>
            `;

                // Add to DOM
                document.body.appendChild(overlay);

                // Track in modal stack
                modalStack.push({ type: 'detail', zIndex: modalZIndexCounter, modalType: type, name: name, overlayId: modalId });

                // Render content
                const modalBody = overlay.querySelector('.detail-modal-body');
                const modalContent = overlay.querySelector('.detail-modal-content');

                await renderDetailInModal(modalBody, type, name);

                // Show with animation - double RAF ensures browser paints initial state first
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        overlay.classList.add('active');
                    });
                });

                document.body.style.overflow = 'hidden';

                // Scroll modal content to top
                if (modalContent) {
                    modalContent.scrollTop = 0;
                }

                // Initialize collapsible sections after rendering
                setTimeout(initCollapsibleSections, 50);
            }

            function closeTopDetailModal() {
                // Find the topmost detail modal in the stack
                const detailModals = modalStack.filter(m => m.type === 'detail');
                if (detailModals.length === 0) return;

                const topModal = detailModals[detailModals.length - 1];
                const overlay = document.getElementById(topModal.overlayId);

                if (overlay) {
                    overlay.classList.remove('active');
                    // Remove after animation
                    setTimeout(() => {
                        overlay.remove();
                    }, 300);
                }

                // Remove from stack
                modalStack = modalStack.filter(m => m.overlayId !== topModal.overlayId);

                // Update state
                if (modalStack.filter(m => m.type === 'detail').length === 0) {
                    detailModalOpen = false;
                    currentDetailModalType = null;
                    currentDetailModalName = null;
                } else {
                    // Update to previous modal's info
                    const prevModal = modalStack.filter(m => m.type === 'detail').pop();
                    if (prevModal) {
                        currentDetailModalType = prevModal.modalType;
                        currentDetailModalName = prevModal.name;
                    }
                }

                // Only restore scrolling if no other modals are open
                if (modalStack.length === 0) {
                    document.body.style.overflow = '';
                }

                skipNextPopstateHandler = true;
                skipNextHashChange = true;
                history.back();
            }

            // Get item ID for URL
            function getDetailItemId(type, name) {
                const infoMap = {
                    'mechabrim': mechabrimInfo,
                    'chatzeros': chatzerosInfo,
                    'verter': verterInfo,
                    'zmanim': Object.assign({}, zmaninInfo, piyutimInfo),
                    'piyutim': piyutimInfo,
                    'collections': collectionsInfo,
                    'albums': albumsInfo,
                    'documents': documentsInfo,
                    'resources': resourcesInfo
                };
                const info = infoMap[type]?.[name] || {};
                return info.customId || name;
            }

            // Find entity by name OR by customId - returns { key, info }
            function findEntityByNameOrId(infoObj, nameOrId) {
                // First try direct lookup by name
                if (infoObj[nameOrId]) {
                    return { key: nameOrId, info: infoObj[nameOrId] };
                }
                // Try finding by customId
                for (const [key, info] of Object.entries(infoObj)) {
                    if (info.customId === nameOrId) {
                        return { key, info };
                    }
                }
                // Not found
                return { key: nameOrId, info: {} };
            }

            // Render detail content in modal
            async function renderDetailInModal(container, type, name) {
                // Show loading state
                container.innerHTML = '<div class="loading"><div class="spinner"></div><p>לאודינג...</p></div>';

                // Get theme class for hero
                const themeMap = {
                    'mechabrim': 'theme-mechaber',
                    'chatzeros': 'theme-chatzer',
                    'verter': 'theme-verter',
                    'zmanim': 'theme-zman',
                    'piyutim': 'theme-piyut',
                    'collections': 'theme-collection',
                    'albums': 'theme-album',
                    'documents': 'theme-document',
                    'resources': 'theme-resource'
                };
                const themeClass = themeMap[type] || '';

                // Get info for profile image and enhanced display (for mechabrim type)
                let profileImageHTML = '';
                let mechaberFullName = name;
                let mechaberLifeDates = '';
                let chatzerBadgesHTML = '';
                let heroBadgesHTML = '';
                let heroSubtitleHTML = '';

                if (type === 'mechabrim') {
                    const { key: mechaberKey, info } = findEntityByNameOrId(mechabrimInfo, name);
                    mechaberFullName = mechaberKey; // Update display name to actual name

                    // Profile image
                    if (info.image) {
                        profileImageHTML = `
                        <div class="modal-hero-avatar">
                            <img src="${info.image}" alt="${name}">
                        </div>`;
                    } else {
                        profileImageHTML = `
                        <div class="modal-hero-avatar">
                            <div class="placeholder"><div class="mechaber-icon"></div></div>
                        </div>`;
                    }

                    // Build full name (formal + known name)
                    const formalParts = [info.title, info.firstName, info.lastName].filter(Boolean);
                    const formalName = formalParts.length > 0 ? formalParts.join(' ') : '';

                    if (info.gerufen) {
                        const knownParts = [info.gerufen, info.platz, info.suffix].filter(Boolean);
                        const knownName = knownParts.join(' ');
                        mechaberFullName = `<span class="mechaber-formal">${formalName}</span><span class="mechaber-known">${knownName}</span>`;
                    } else {
                        const fullNameParts = [info.title, info.firstName, info.lastName, info.platz, info.suffix].filter(Boolean);
                        mechaberFullName = fullNameParts.length > 0 ? fullNameParts.join(' ') : name;
                    }

                    // Build life dates
                    const birthParts = [info.birthDay, info.birthMonth, info.birthYear].filter(Boolean);
                    const deathParts = [info.deathDay, info.deathMonth, info.deathYear].filter(Boolean);
                    const birthStr = birthParts.length > 0 ? birthParts.join(' ') : '';
                    const deathStr = deathParts.length > 0 ? deathParts.join(' ') : '';

                    if (birthStr || deathStr) {
                        if (birthStr && deathStr) {
                            mechaberLifeDates = `${birthStr} - ${deathStr}`;
                        } else if (birthStr) {
                            mechaberLifeDates = `נולד: ${birthStr}`;
                        } else if (deathStr) {
                            mechaberLifeDates = `נפטר: ${deathStr}`;
                        }
                    }

                    // Build chatzer badges
                    if (info.chatzer) {
                        const chatzeros = info.chatzer.split(',').map(c => c.trim()).filter(Boolean);
                        if (chatzeros.length > 0) {
                            chatzerBadgesHTML = `
                            <div class="modal-hero-badges">
                                ${chatzeros.map(chatzer => `
                                    <span class="detail-chatzer-badge"
                                          data-action="detail"
                                          data-category="chatzeros"
                                          data-name="${escapeHtml(chatzer)}"
                                          style="cursor:pointer;">${chatzer}</span>
                                `).join('')}
                            </div>`;
                        }
                    }
                }

                // Albums hero: cover image, producer, chatzer, year
                if (type === 'albums') {
                    const { key: albumKey, info } = findEntityByNameOrId(albumsInfo, name);
                    const coverUrl = info.cover || info.image;
                    if (coverUrl) {
                        profileImageHTML = `
                        <div class="modal-hero-avatar">
                            <img src="${coverUrl}" alt="${name}">
                        </div>`;
                    }
                    const metaParts = [];
                    const producer = info.producer?.replace(/\`\`\`/g, '') || '';
                    if (producer) metaParts.push(producer);
                    if (info.year) metaParts.push(`שנת ${info.year}`);
                    if (metaParts.length > 0) {
                        heroSubtitleHTML = `<div class="modal-hero-subtitle">${metaParts.join(' • ')}</div>`;
                    }
                    if (info.chatzer) {
                        chatzerBadgesHTML = `
                        <div class="modal-hero-badges">
                            <span class="detail-chatzer-badge"
                                  data-action="detail"
                                  data-category="chatzeros"
                                  data-name="${escapeHtml(info.chatzer)}"
                                  style="cursor:pointer;">${info.chatzer}</span>
                        </div>`;
                    }
                }

                // Documents hero: sort type, chatzer
                if (type === 'documents') {
                    const { key: docKey, info } = findEntityByNameOrId(documentsInfo, name);
                    const sortType = (info.allData?.['סארט'] || info.sort || '').replace(/\`\`\`/g, '');
                    const metaParts = [];
                    if (sortType) metaParts.push(sortType);
                    if (info.serie) metaParts.push(info.serie.replace(/\`\`\`/g, ''));
                    if (metaParts.length > 0) {
                        heroSubtitleHTML = `<div class="modal-hero-subtitle">${metaParts.join(' • ')}</div>`;
                    }
                    if (info.chatzer) {
                        chatzerBadgesHTML = `
                        <div class="modal-hero-badges">
                            <span class="detail-chatzer-badge"
                                  data-action="detail"
                                  data-category="chatzeros"
                                  data-name="${escapeHtml(info.chatzer)}"
                                  style="cursor:pointer;">${info.chatzer}</span>
                        </div>`;
                    }
                }

                // Collections hero: zmanim badges
                if (type === 'collections') {
                    const { key: colKey, info } = findEntityByNameOrId(collectionsInfo, name);
                    if (info.zmanim && info.zmanim.length > 0) {
                        heroBadgesHTML = `
                        <div class="modal-hero-badges">
                            ${info.zmanim.map(zman => `
                                <span class="detail-zman-badge"
                                      data-action="zman-detail"
                                      data-name="${escapeHtml(zman)}"
                                      style="cursor:pointer;">${zman}</span>
                            `).join('')}
                        </div>`;
                    }
                }

                // Generate hero header with play-all button
                const playAllBtnHTML = ['mechabrim', 'chatzeros', 'verter', 'piyutim', 'collections'].includes(type) ? `
                <button class="play-all-btn" title="שפיל אלע" onclick="event.stopPropagation(); playAllFromDetailPage('${type}', '${escapeHtml(name).replace(/'/g, "\\'")}')" data-detail-type="${type}" data-detail-name="${escapeHtml(name)}">
                    <svg class="play-icon" viewBox="0 0 24 24"><path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/></svg>
                    <svg class="pause-icon" style="display:none" viewBox="0 0 24 24"><path d="M9 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zM13 7v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"/></svg>
                </button>
            ` : '';

                const heroHTML = `
                <div class="modal-hero-wrapper">
                    <div class="modal-hero ${themeClass}">
                        ${playAllBtnHTML}
                        ${profileImageHTML || mechaberLifeDates ? `
                        <div class="modal-hero-left">
                            ${profileImageHTML}
                            ${mechaberLifeDates ? `<div class="modal-hero-dates">${mechaberLifeDates}</div>` : ''}
                        </div>
                        ` : ''}
                        <div class="modal-hero-text">
                            <h1 class="modal-hero-title">${type === 'mechabrim' ? mechaberFullName : name}</h1>
                            ${heroSubtitleHTML}
                        </div>
                    </div>
                    ${(chatzerBadgesHTML || heroBadgesHTML) ? `<div class="modal-hero-border-badges">${chatzerBadgesHTML}${heroBadgesHTML}</div>` : ''}
                </div>
            `;

                // Create a temporary container for the body content
                const tempContainer = document.createElement('div');
                const mainContent = document.getElementById('mainContent');

                // Create a completely hidden/detached render target to prevent ANY flash
                // This element is never added to the DOM, so nothing is visible
                const hiddenRenderTarget = document.createElement('div');
                hiddenRenderTarget.id = 'mainContent'; // Temporarily give it the same ID
                hiddenRenderTarget.style.cssText = 'position:absolute;left:-9999px;visibility:hidden;';
                document.body.appendChild(hiddenRenderTarget);

                // Temporarily rename mainContent so render functions find our hidden target
                const originalId = mainContent.id;
                mainContent.id = 'mainContent_hidden_temp';

                // Call the appropriate render function (it will render to hiddenRenderTarget)
                switch (type) {
                    case 'mechabrim':
                    case 'chatzeros':
                    case 'verter':
                    case 'collections':
                    case 'piyutim':
                        // Set currentDetailView for the render function
                        currentDetailView = { type, name };
                        await renderDetailPage();
                        // Get the rendered content from hidden target
                        tempContainer.innerHTML = hiddenRenderTarget.innerHTML;
                        break;
                    case 'zmanim':
                        currentDetailView = { type: 'zman', name };
                        await renderDetailPage();
                        tempContainer.innerHTML = hiddenRenderTarget.innerHTML;
                        break;
                    case 'albums':
                        renderAlbumDetailPage(tempContainer, name);
                        break;
                    case 'documents':
                        renderDocumentDetailPage(tempContainer, name);
                        break;
                    case 'resources':
                        renderResourceDetailPage(tempContainer, name);
                        break;
                    default:
                        tempContainer.innerHTML = '<p>סארט נישט געפונען</p>';
                }

                // Remove the detail-header from the copied content (we're using modal-hero instead)
                const detailHeader = tempContainer.querySelector('.detail-header');
                if (detailHeader) {
                    detailHeader.remove();
                }

                // Also remove back button if present
                const backBtn = tempContainer.querySelector('.back-button');
                if (backBtn) {
                    backBtn.remove();
                }

                // Combine hero + body content
                container.innerHTML = heroHTML + `<div class="modal-body-content">${tempContainer.innerHTML}</div>`;

                // Clear the currentDetailView since we don't actually want to navigate
                currentDetailView = null;

                // Restore mainContent ID and remove hidden render target
                mainContent.id = originalId;
                hiddenRenderTarget.remove();
            }

            // Expand modal to full page view
            function expandToFullPage() {
                // Build URL from modal state, not from current URL
                let targetType = null;
                let targetName = null;

                if (detailModalOpen && currentDetailModalType && currentDetailModalName) {
                    targetType = currentDetailModalType;
                    targetName = currentDetailModalName;
                } else if (nigunModalOpen && currentNigunModalIdx !== null) {
                    // For nigun modal, get song info
                    const song = allSongs[currentNigunModalIdx];
                    if (song) {
                        targetType = 'nigunim';
                        targetName = song.customId || song.rowId || song.name;
                    }
                }

                if (!targetType || !targetName) {
                    console.error('expandToFullPage: No target type or name available');
                    return;
                }

                // Get item ID for URL
                const itemId = getDetailItemId(targetType, targetName);
                const newHash = `#/${targetType}/${encodeURIComponent(itemId)}`;

                // Find active modal - check dynamic modals in stack first
                let activeOverlay = null;
                let activeContent = null;

                // Check for dynamic detail modals in stack
                const detailModals = modalStack.filter(m => m.type === 'detail');
                if (detailModals.length > 0) {
                    const topModal = detailModals[detailModals.length - 1];
                    activeOverlay = document.getElementById(topModal.overlayId);
                    if (activeOverlay) {
                        activeContent = activeOverlay.querySelector('.detail-modal-content');
                    }
                }

                // Fallback to static modals
                if (!activeOverlay) {
                    const staticDetailOverlay = document.getElementById('detailModalOverlay');
                    const nigunOverlay = document.getElementById('nigunModalOverlay');

                    if (detailModalOpen && staticDetailOverlay) {
                        activeOverlay = staticDetailOverlay;
                        activeContent = activeOverlay.querySelector('.detail-modal-content');
                    } else if (nigunModalOpen && nigunOverlay) {
                        activeOverlay = nigunOverlay;
                        activeContent = activeOverlay.querySelector('.nigun-modal-content');
                    }
                }

                if (activeOverlay) {
                    // Add fade-out animation
                    activeOverlay.classList.remove('active');
                    if (activeContent) {
                        activeContent.classList.add('expanding');
                    }

                    // Wait for fade animation to complete, then clean up and show full page
                    setTimeout(() => {
                        // Remove all dynamic modals from DOM
                        modalStack.forEach(m => {
                            const overlay = document.getElementById(m.overlayId);
                            if (overlay) overlay.remove();
                        });

                        // Reset modal states
                        nigunModalOpen = false;
                        detailModalOpen = false;
                        currentNigunModalIdx = null;
                        currentDetailModalType = null;
                        currentDetailModalName = null;
                        modalStack = [];
                        document.body.style.overflow = '';

                        // Navigate to full page URL (replace current history entry)
                        history.replaceState(null, '', newHash);

                        // Parse and render the full page
                        handleURLChange();

                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 300); // Match fade animation duration
                } else {
                    // Fallback: no animation
                    modalStack.forEach(m => {
                        const overlay = document.getElementById(m.overlayId);
                        if (overlay) overlay.remove();
                    });

                    nigunModalOpen = false;
                    detailModalOpen = false;
                    currentNigunModalIdx = null;
                    currentDetailModalType = null;
                    currentDetailModalName = null;
                    modalStack = [];
                    document.body.style.overflow = '';

                    history.replaceState(null, '', newHash);
                    handleURLChange();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }

            // Close generic detail modal (wrapper for closeTopDetailModal)
            function closeDetailModal() {
                closeTopDetailModal();
            }

            // Handle browser back/forward for nigun modal
            window.addEventListener('popstate', (e) => {
                // Check if we should skip this handler (modal was closed programmatically)
                if (skipNextPopstateHandler) {
                    skipNextPopstateHandler = false;
                    // Still restore scroll position
                    if (e.state && e.state.scrollPos !== undefined) {
                        window.scrollTo(0, e.state.scrollPos);
                    } else if (savedScrollPosition) {
                        window.scrollTo(0, savedScrollPosition);
                    }
                    return;
                }
                // Check if we're closing the nigun modal
                if (nigunModalOpen) {
                    // Close modal without triggering another history change
                    nigunModalOpen = false;
                    currentNigunModalIdx = null;

                    const overlay = document.getElementById('nigunModalOverlay');
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';

                    // Restore scroll position
                    if (e.state && e.state.scrollPos !== undefined) {
                        window.scrollTo(0, e.state.scrollPos);
                    } else {
                        window.scrollTo(0, savedScrollPosition);
                    }
                    return;
                }

                // Check if we're closing the detail modal
                if (detailModalOpen) {
                    // Find and close the topmost detail modal from stack
                    const detailModals = modalStack.filter(m => m.type === 'detail');
                    if (detailModals.length > 0) {
                        const topModal = detailModals[detailModals.length - 1];
                        const overlay = document.getElementById(topModal.overlayId);

                        if (overlay) {
                            overlay.classList.remove('active');
                            setTimeout(() => {
                                overlay.remove();
                            }, 300);
                        }

                        // Remove from stack
                        modalStack = modalStack.filter(m => m.overlayId !== topModal.overlayId);

                        // Update state based on remaining modals
                        const remainingDetailModals = modalStack.filter(m => m.type === 'detail');
                        if (remainingDetailModals.length === 0) {
                            detailModalOpen = false;
                            currentDetailModalType = null;
                            currentDetailModalName = null;
                        } else {
                            const prevModal = remainingDetailModals[remainingDetailModals.length - 1];
                            currentDetailModalType = prevModal.modalType;
                            currentDetailModalName = prevModal.name;
                        }
                    }

                    // Only restore scrolling and overflow if no modals remain
                    if (modalStack.length === 0) {
                        document.body.style.overflow = '';
                        // Restore scroll position
                        if (e.state && e.state.scrollPos !== undefined) {
                            window.scrollTo(0, e.state.scrollPos);
                        } else {
                            window.scrollTo(0, savedScrollPosition);
                        }
                    }
                    return;
                }

                // Otherwise handle normal URL changes
                handleURLChange();
            });

            // Wrapper to show details without playing
            function showDetailsOnly(event, idx) {
                event.stopPropagation();
                event.preventDefault();
                showSongDetails(idx);
            }

            // Close modal (old song modal)
            function closeModal() {
                document.getElementById('songModal').classList.remove('show');
            }

            // Close modal on outside click
            document.getElementById('songModal').addEventListener('click', (e) => {
                if (e.target.id === 'songModal') closeModal();
            });

            // Close modals with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (nigunModalOpen) {
                        closeNigunModal();
                    } else if (detailModalOpen) {
                        closeDetailModal();
                    }
                }
            });

            // PDF Popup functions
            function openPdfPopup(encodedUrl, encodedTitle) {
                const url = decodeURIComponent(encodedUrl);
                const title = decodeURIComponent(encodedTitle);

                // Use Google Docs viewer to display PDF inline
                const viewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;

                document.getElementById('pdfPopupTitle').textContent = title;
                document.getElementById('pdfPopupFrame').src = viewerUrl;
                document.getElementById('pdfDownloadLink').href = url;
                document.getElementById('pdfPopup').classList.add('show');
                document.body.style.overflow = 'hidden';
            }

            function closePdfPopup(event) {
                if (event && event.target !== document.getElementById('pdfPopup')) return;
                document.getElementById('pdfPopup').classList.remove('show');
                document.getElementById('pdfPopupFrame').src = '';
                document.body.style.overflow = '';
            }

            // Close PDF popup on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closePdfPopup();
                }
            });

            // Global search
            function handleGlobalSearch(term) {
                // Don't search on every keystroke - wait for Enter
            }

            // Open search modal
            function openSearchModal() {
                const overlay = document.getElementById('searchModalOverlay');
                overlay.classList.add('active');
                // Focus on input
                setTimeout(() => {
                    document.getElementById('searchModalInput').focus();
                    // Initialize typing animation if enabled (and if function exists)
                    if (typeof initTypingForInput === 'function') {
                        initTypingForInput('searchModalInput');
                    }
                }, 100);
            }

            // Close search modal
            function closeSearchModal() {
                const overlay = document.getElementById('searchModalOverlay');
                overlay.classList.remove('active');
            }

            // Execute search from modal
            async function executeSearchFromModal() {
                const input = document.getElementById('searchModalInput');
                const term = input?.value?.trim();

                if (!term) return;

                closeSearchModal();

                // Show loading state
                const content = document.getElementById('mainContent');
                content.innerHTML = `
                <div class="page-theme-nigun">
                    <div class="page-title">
                        <div class="page-title-bar">זוך "${term}"...</div>
                        <div class="subtitle">לאודינג רעזולטאטן...</div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; gap: 16px;">
                        <div class="loader-medium"><span class="note">♪</span><span class="note">♫</span><span class="note">♪</span></div>
                        <p style="color: var(--text-secondary); font-size: 16px; margin: 0;">לאדינג רעזולטאטן...</p>
                    </div>
                </div>
            `;

                // Load all data needed for search
                await ensureDataForPage('search');

                searchQuery = term;
                currentPage = 1;
                currentPageView = 'search';
                currentDetailView = null;
                updateURL();
                renderCurrentPage();
            }

            // Execute search from results page
            async function executeSearchFromResults() {
                const input = document.getElementById('searchResultsInput');
                const term = input?.value?.trim();

                if (!term) return;

                // Show loading state
                const content = document.getElementById('mainContent');
                content.innerHTML = `
                <div class="page-theme-nigun">
                    <div class="page-title">
                        <div class="page-title-bar">זוך "${term}"...</div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; gap: 16px;">
                        <div class="loader-medium"><span class="note">♪</span><span class="note">♫</span><span class="note">♪</span></div>
                        <p style="color: var(--text-secondary); font-size: 16px; margin: 0;">לאדינג רעזולטאטן...</p>
                    </div>
                </div>
            `;

                // Load all data needed for search
                await ensureDataForPage('search');

                searchQuery = term;
                currentPage = 1;
                currentPageView = 'search';
                currentDetailView = null;
                updateURL();
                renderCurrentPage();
            }

            // Search within songs only (from "see all" button)
            function searchInSongs(term) {
                // Set search query in songs page
                searchQuery = term;
                currentPage = 1;
                currentPageView = 'songs';
                currentDetailView = null;

                // Apply the search filter
                applyFilters();

                updateURL();
                renderCurrentPage();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function executeGlobalSearch() {
                const input = document.getElementById('globalSearch');
                const term = input?.value?.trim();

                if (!term) return;

                searchQuery = term;
                currentPage = 1;
                currentPageView = 'search';
                currentDetailView = null;
                updateURL();
                renderCurrentPage();
            }

            // Render search results page
            function renderSearchResultsPage(container) {
                const term = searchQuery.toLowerCase();

                // Helper function to search in an info object
                function searchInInfo(info, term) {
                    if (!info) return false;
                    // Search in all properties
                    for (const key of Object.keys(info)) {
                        const val = info[key];
                        if (typeof val === 'string' && val.toLowerCase().includes(term)) return true;
                        if (Array.isArray(val) && val.some(v => typeof v === 'string' && v.toLowerCase().includes(term))) return true;
                    }
                    // Search in allData
                    if (info.allData) {
                        for (const key of Object.keys(info.allData)) {
                            const val = info.allData[key];
                            if (typeof val === 'string' && val.toLowerCase().includes(term)) return true;
                        }
                    }
                    return false;
                }

                // Search in songs
                const matchingSongs = allSongs.filter(song => {

                    const searchableText = [
                        song.name,
                        song.mechaber,
                        song.category,
                        song.verter,
                        song.collections,
                        song.pasigOif,
                        song.info,
                        song.siman
                    ].filter(Boolean).join(' ').toLowerCase();
                    return searchableText.includes(term);
                });

                // Search in chatzeros (use chatzerosInfo directly)
                const matchingChatzeros = Object.keys(chatzerosInfo || {}).filter(name => {
                    if (name.toLowerCase().includes(term)) return true;
                    return searchInInfo(chatzerosInfo?.[name], term);
                });

                // Search in mechabrim (use mechabrimInfo directly)
                const matchingMechabrim = Object.keys(mechabrimInfo || {}).filter(name => {
                    if (name.toLowerCase().includes(term)) return true;
                    return searchInInfo(mechabrimInfo?.[name], term);
                });

                // Search in collections (use collectionsInfo directly)
                const matchingCollections = Object.keys(collectionsInfo || {}).filter(name => {
                    if (name.toLowerCase().includes(term)) return true;
                    return searchInInfo(collectionsInfo?.[name], term);
                });

                // Search in verter (use verterInfo directly)
                const matchingVerter = Object.keys(verterInfo || {}).filter(name => {
                    if (name.toLowerCase().includes(term)) return true;
                    return searchInInfo(verterInfo?.[name], term);
                });

                // Search in zmanim (name and all info)
                const matchingZmanim = Object.keys(zmaninInfo || {}).filter(name => {
                    if (name.toLowerCase().includes(term)) return true;
                    return searchInInfo(zmaninInfo?.[name], term);
                });

                // Search in albums (name and all info)
                const matchingAlbums = Object.keys(albumsInfo || {}).filter(name => {
                    if (name.toLowerCase().includes(term)) return true;
                    return searchInInfo(albumsInfo?.[name], term);
                });

                // Search in scale
                const matchingScale = Object.keys(categories.scale || {}).filter(name =>
                    name.toLowerCase().includes(term)
                );

                // Search in ritem
                const matchingRitem = Object.keys(categories.ritem || {}).filter(name =>
                    name.toLowerCase().includes(term)
                );

                // Search in gezungen
                const matchingGezungen = Object.keys(categories.gezungen || {}).filter(name =>
                    name.toLowerCase().includes(term)
                );

                const totalResults = matchingSongs.length + matchingChatzeros.length +
                    matchingMechabrim.length + matchingCollections.length +
                    matchingVerter.length + matchingZmanim.length + matchingAlbums.length +
                    matchingScale.length + matchingRitem.length + matchingGezungen.length;

                let html = `
                <div class="page-theme-nigun">
                    <div class="page-title">
                        <div class="page-title-bar">רעזולטאטן פאר "${searchQuery}"</div>
                        <div class="subtitle">${totalResults} רעזולטאטן געפונען</div>
                    </div>
                    
                    <div class="search-results-searchbar">
                        <input type="text" 
                               id="searchResultsInput" 
                               class="search-results-input" 
                               placeholder="זוך עפעס אנדערש..."
                               value="${searchQuery}"
                               onkeydown="if(event.key==='Enter') executeSearchFromResults()">
                        <button class="search-results-btn" onclick="executeSearchFromResults()">🔍 זוכן</button>
                    </div>
            `;

                // Nigunim section - use song-item style
                if (matchingSongs.length > 0) {
                    // Apply quality filter
                    const qualityFilteredSongs = minQualityRating === 0
                        ? matchingSongs
                        : matchingSongs.filter(song => songHasQualityAudio(song));

                    // Apply sort order
                    const sortedSongs = sortSongsByOrder(qualityFilteredSongs);
                    const displaySongs = sortedSongs.slice(0, 10);

                    html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <h3 style="color: var(--color-nigun); margin: 0;">🎵 ניגונים (${qualityFilteredSongs.length})</h3>
                                ${qualityFilteredSongs.length > 10 ? `<button class="see-all-btn" onclick="searchInSongs('${searchQuery.replace(/'/g, "\\'")}')">זע אלע ${qualityFilteredSongs.length} →</button>` : ''}
                            </div>
                            <div class="detail-filters-group">
                                <!-- Sort Filter -->
                                <div class="detail-filter-dropdown">
                                    <div class="detail-filter-current">
                                        <span class="filter-icon">⇅</span>
                                        <span class="filter-label">${currentSortOrder === 'random' ? 'שאָפל' :
                            currentSortOrder === 'alphabetical' ? 'א"ב' :
                                'לעצט צוגעלייגט'
                        }</span>
                                    </div>
                                    <div class="detail-filter-options">
                                        <div class="detail-filter-option ${currentSortOrder === 'random' ? 'active' : ''}"
                                             onclick="changeSortOrder('random'); updateSearchResultsView();">
                                            שאָפל
                                        </div>
                                        <div class="detail-filter-option ${currentSortOrder === 'alphabetical' ? 'active' : ''}"
                                             onclick="changeSortOrder('alphabetical'); updateSearchResultsView();">
                                            א"ב
                                        </div>
                                        <div class="detail-filter-option ${currentSortOrder === 'recent' ? 'active' : ''}"
                                             onclick="changeSortOrder('recent'); updateSearchResultsView();">
                                            לעצט צוגעלייגט
                                        </div>
                                    </div>
                                </div>

                                <!-- Display Mode Filter -->
                                <div class="detail-filter-dropdown">
                                    <div class="detail-filter-current">
                                        <span class="filter-icon">👁</span>
                                        <span class="filter-label">${currentDisplayMode === 'minimal' ? 'קעפל' :
                            currentDisplayMode === 'recordings' ? 'רעקארדירונגען' :
                                'אלעס'
                        }</span>
                                    </div>
                                    <div class="detail-filter-options">
                                        <div class="detail-filter-option ${currentDisplayMode === 'minimal' ? 'active' : ''}"
                                             onclick="changeDisplayMode('minimal'); updateSearchResultsView();">
                                            קעפל
                                        </div>
                                        <div class="detail-filter-option ${currentDisplayMode === 'recordings' ? 'active' : ''}"
                                             onclick="changeDisplayMode('recordings'); updateSearchResultsView();">
                                            רעקארדירונגען
                                        </div>
                                        <div class="detail-filter-option ${currentDisplayMode === 'full' ? 'active' : ''}"
                                             onclick="changeDisplayMode('full'); updateSearchResultsView();">
                                            אלעס
                                        </div>
                                    </div>
                                </div>

                                <!-- Quality Filter -->
                                <div class="detail-filter-dropdown detail-filter-quality">
                                    <div class="detail-filter-current quality-filter-spread">
                                        <span class="filter-label-left">${minQualityRating === 0 ? 'אלע' : 'קוואליטעט'
                        }</span>
                                        <span class="filter-stars-right">${minQualityRating === 0 ? '' :
                            minQualityRating === 1 ? '★' :
                                minQualityRating === 2 ? '★★' :
                                    minQualityRating === 3 ? '★★★' :
                                        minQualityRating === 4 ? '★★★★' :
                                            '★★★★★'
                        }</span>
                                    </div>
                                    <div class="detail-filter-options">
                                        <div class="detail-filter-option ${minQualityRating === 0 ? 'active' : ''}"
                                             onclick="setMinQualityRating(0); updateSearchResultsView();">
                                            אלע
                                        </div>
                                        <div class="detail-filter-option ${minQualityRating === 1 ? 'active' : ''}"
                                             onclick="setMinQualityRating(1); updateSearchResultsView();">
                                            ★ א מענטש זינגט פאר זיך
                                        </div>
                                        <div class="detail-filter-option ${minQualityRating === 2 ? 'active' : ''}"
                                             onclick="setMinQualityRating(2); updateSearchResultsView();">
                                            ★★ אראפגעזינגען אן מוזיק
                                        </div>
                                        <div class="detail-filter-option ${minQualityRating === 3 ? 'active' : ''}"
                                             onclick="setMinQualityRating(3); updateSearchResultsView();">
                                            ★★★ אלטע מוזיק
                                        </div>
                                        <div class="detail-filter-option ${minQualityRating === 4 ? 'active' : ''}"
                                             onclick="setMinQualityRating(4); updateSearchResultsView();">
                                            ★★★★ שיין און ניי
                                        </div>
                                        <div class="detail-filter-option ${minQualityRating === 5 ? 'active' : ''}"
                                             onclick="setMinQualityRating(5); updateSearchResultsView();">
                                            ★★★★★ שיין, ניי און געשמאק
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="search-songs-list">
                            ${(() => {
                            const playlistIndices = displaySongs.map(song => allSongs.indexOf(song));
                            return displaySongs.map((song, i) => {
                                const globalIdx = allSongs.indexOf(song);
                                return renderSongItem(song, globalIdx, i + 1, playlistIndices, { forceMinimal: true });
                            }).join('');
                        })()}
                        </div>
                    </div>
                `;
                }

                // Albums section
                if (matchingAlbums.length > 0) {
                    html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-album);">💿 אלבומס (${matchingAlbums.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingAlbums.map(name => {
                        const albumData = albumsInfo[name];
                        return `
                                <div class="search-result-card result-album" data-action="detail" data-category="albums" data-name="${escapeHtml(name)}" style="border-right-color: var(--color-album);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${albumData?.songs?.length || 0} ניגונים</div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
                }

                // Chatzeros section
                if (matchingChatzeros.length > 0) {
                    html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-chatzer);">🏛️ חצרות (${matchingChatzeros.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingChatzeros.map(name => `
                                <div class="search-result-card result-chatzer" data-action="detail" data-category="chatzeros" data-name="${escapeHtml(name)}" style="border-right-color: var(--color-chatzer);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.chatzeros[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                }

                // Mechabrim section
                if (matchingMechabrim.length > 0) {
                    html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-mechaber);">👤 מחברים (${matchingMechabrim.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingMechabrim.map(name => `
                                <div class="search-result-card result-mechaber" data-action="detail" data-category="mechabrim" data-name="${escapeHtml(name)}" style="border-right-color: var(--color-mechaber);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.mechabrim[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                }

                // Collections section
                if (matchingCollections.length > 0) {
                    html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-collection);">📁 קאלעקשאנס (${matchingCollections.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingCollections.map(name => `
                                <div class="search-result-card result-collection" data-action="detail" data-category="collections" data-name="${escapeHtml(name)}" style="border-right-color: var(--color-collection);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.collections[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                }

                // Verter section
                if (matchingVerter.length > 0) {
                    html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-verter);">📝 ווערטער (${matchingVerter.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingVerter.map(name => `
                                <div class="search-result-card result-verter" data-action="detail" data-category="verter" data-name="${escapeHtml(name)}" style="border-right-color: var(--color-verter);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.verter[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                }

                // Zmanim section
                if (matchingZmanim.length > 0) {
                    html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-zman);">📅 זמנים (${matchingZmanim.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingZmanim.map(name => `
                                <div class="search-result-card result-zman" data-action="zman-detail" data-name="${escapeHtml(name)}" style="border-right-color: var(--color-zman);">
                                    <div class="result-name">${name}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                }

                // Gezungen section
                if (matchingGezungen.length > 0) {
                    html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: #2e8b2e;">🎤 געזונגען אויף (${matchingGezungen.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingGezungen.map(name => `
                                <div class="search-result-card" data-action="filter" data-page="nigunim" data-filter-key="gezungen" data-value="${escapeHtml(name)}" style="border-right-color: #2e8b2e;">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.gezungen[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                }

                // Ritem section
                if (matchingRitem.length > 0) {
                    html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-music);">🥁 ריטעם (${matchingRitem.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingRitem.map(name => `
                                <div class="search-result-card result-music" data-action="filter" data-page="nigunim" data-filter-key="ritem" data-value="${escapeHtml(name)}" style="border-right-color: var(--color-music);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.ritem[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                }

                // Scale section
                if (matchingScale.length > 0) {
                    html += `
                    <div class="search-section">
                        <div class="search-section-header">
                            <h3 style="color: var(--color-nigun);">🎼 סקעיל (${matchingScale.length})</h3>
                        </div>
                        <div class="search-results-grid">
                            ${matchingScale.map(name => `
                                <div class="search-result-card result-nigun" data-action="filter" data-page="nigunim" data-filter-key="scale" data-value="${escapeHtml(name)}" style="border-right-color: var(--color-nigun);">
                                    <div class="result-name">${name}</div>
                                    <div class="result-count">${categories.scale[name]?.length || 0} ניגונים</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                }

                if (totalResults === 0) {
                    html += `
                    <div class="no-results">
                        <div class="no-results-icon">🔍</div>
                        <p>קיין רעזולטאטן נישט געפונען פאר "${searchQuery}"</p>
                        <p class="no-results-hint">פרובירט א אנדער זוך</p>
                    </div>
                `;
                }

                html += `</div>`;
                container.innerHTML = html;
            }

            // Update search results view when filters change
            function updateSearchResultsView() {
                if (currentPage === 'search') {
                    const container = document.getElementById('content');
                    if (container) {
                        renderSearchResultsPage(container);
                    }
                }
            }

            // Close dropdowns on outside click
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.filter-dropdown')) {
                    document.querySelectorAll('.filter-dropdown-content').forEach(d => d.classList.remove('show'));
                }

                // Close sidebar dropdowns only when clicking outside
                if (!e.target.closest('.sidebar-filter-dropdown')) {
                    document.querySelectorAll('.sidebar-dropdown-content').forEach(d => d.classList.remove('show'));
                }


            });

            // Keyboard shortcuts
            // Keyboard shortcuts with Hold-to-Seek functionality
            let arrowKeyTimer = null;
            let arrowSeekInterval = null;
            let isArrowSeeking = false;
            const LONG_PRESS_DELAY = 400; // ms to trigger seek mode
            const SEEK_INTERVAL_MS = 100; // ms between seek steps
            const SEEK_STEP_SEC = 2.5; // seconds to seek per step

            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                if (e.code === 'Space') {
                    e.preventDefault();
                    togglePlayPause();
                } else if (e.code === 'ArrowRight' || e.code === 'ArrowLeft') {
                    e.preventDefault(); // Prevent page scrolling

                    // If already seeking (or holding), ignore repeats (we use our own interval)
                    if (e.repeat || isArrowSeeking || arrowKeyTimer) return;

                    // Start timer to detect hold
                    arrowKeyTimer = setTimeout(() => {
                        isArrowSeeking = true;
                        // Start seeking loop
                        const isNext = e.code === 'ArrowRight'; // Right is Next/Forward in this RTL setup

                        // Auto-play if paused when seek starts
                        if (audioPlayer.paused) {
                            togglePlayPause(true);
                        }

                        arrowSeekInterval = setInterval(() => {
                            if (isFinite(audioPlayer.duration)) {
                                const delta = isNext ? SEEK_STEP_SEC : -SEEK_STEP_SEC;
                                audioPlayer.currentTime = Math.min(Math.max(audioPlayer.currentTime + delta, 0), audioPlayer.duration);
                            }
                        }, SEEK_INTERVAL_MS);
                    }, LONG_PRESS_DELAY);
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.code === 'ArrowRight' || e.code === 'ArrowLeft') {
                    // Clear hold detection
                    if (arrowKeyTimer) {
                        clearTimeout(arrowKeyTimer);
                        arrowKeyTimer = null;
                    }
                    // Stop seeking if active
                    if (arrowSeekInterval) {
                        clearInterval(arrowSeekInterval);
                        arrowSeekInterval = null;
                    }

                    // If we weren't seeking, it was a tap -> Switch Song
                    if (!isArrowSeeking) {
                        if (e.code === 'ArrowRight') {
                            playNext();
                        } else {
                            playPrevious();
                        }
                    }

                    // Reset state
                    isArrowSeeking = false;
                }
            });

            // Image modal functions
            function openImageModal(imageUrl) {
                let modal = document.getElementById('imageModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'imageModal';
                    modal.className = 'image-modal';
                    modal.innerHTML = `
                    <button class="image-modal-close" onclick="closeImageModal()">×</button>
                    <img src="" id="imageModalImg">
                `;
                    modal.onclick = function (e) {
                        if (e.target === modal) closeImageModal();
                    };
                    document.body.appendChild(modal);
                }
                document.getElementById('imageModalImg').src = imageUrl;
                modal.classList.add('active');
            }

            function closeImageModal() {
                const modal = document.getElementById('imageModal');
                if (modal) modal.classList.remove('active');
            }

            // Video modal functions
            function openVideoModal(videoUrl) {
                let modal = document.getElementById('videoModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'videoModal';
                    modal.className = 'video-modal';
                    modal.innerHTML = `
                    <button class="video-modal-close" onclick="closeVideoModal()">×</button>
                    <video src="" id="videoModalVideo" controls autoplay></video>
                `;
                    modal.onclick = function (e) {
                        if (e.target === modal) closeVideoModal();
                    };
                    document.body.appendChild(modal);
                }
                document.getElementById('videoModalVideo').src = videoUrl;
                modal.classList.add('active');
            }

            function closeVideoModal() {
                const modal = document.getElementById('videoModal');
                if (modal) {
                    const video = document.getElementById('videoModalVideo');
                    if (video) {
                        video.pause();
                        video.src = '';
                    }
                    modal.classList.remove('active');
                }
            }

            // Play audio from other media section (6th attachment)
            function playOtherMediaAudio(audioUrl, element) {
                audioPlayer.src = audioUrl;
                audioPlayer.play();
                showPlayer();

                // Update player UI with generic info
                document.getElementById('playerRightSongName').textContent = 'אודיאו';
                document.getElementById('playerSongMeta').innerHTML = '';
                document.getElementById('playerTags').innerHTML = '';

                // Hide rating for other media audio
                const playerRating = document.getElementById('playerRating');
                if (playerRating) playerRating.style.display = 'none';

                // Update active state
                document.querySelectorAll('.nigun-recording-item').forEach(item => {
                    item.classList.remove('active');
                });
                if (element) {
                    element.classList.add('active');
                }
            }

            // Create flying stars burst effect
            function createFlyingStars(container, count = 8, originEl = null) {
                const starChars = ['✦', '✧', '✶'];

                // Calculate spread across the full stars row
                const containerRect = container.getBoundingClientRect();
                const starsRow = container.querySelector('.player-rating-stars');
                let spreadLeft, spreadWidth, originY;

                if (starsRow) {
                    const starsRect = starsRow.getBoundingClientRect();
                    spreadLeft = starsRect.left - containerRect.left;
                    spreadWidth = starsRect.width;
                    originY = starsRect.top + starsRect.height / 2 - containerRect.top;
                } else {
                    spreadLeft = 0;
                    spreadWidth = containerRect.width;
                    originY = containerRect.height / 2;
                }

                for (let i = 0; i < count; i++) {
                    const star = document.createElement('span');
                    star.className = 'flying-star';
                    star.textContent = starChars[Math.floor(Math.random() * starChars.length)];

                    // Each star starts at a random X position along the stars row
                    const originX = spreadLeft + Math.random() * spreadWidth;

                    // Random direction - distribute around circle with slight randomness
                    const angle = (i / count) * 360 + (Math.random() * 25 - 12);
                    const distance = 40 + Math.random() * 30;
                    const radians = angle * (Math.PI / 180);

                    const flyX = Math.cos(radians) * distance;
                    const flyY = Math.sin(radians) * distance;

                    // Random size and duration
                    const size = 10 + Math.random() * 8;
                    const duration = 0.8 + Math.random() * 0.4;
                    const delay = Math.random() * 0.12;

                    star.style.left = `${originX}px`;
                    star.style.top = `${originY}px`;
                    star.style.setProperty('--fly-x', `${flyX}px`);
                    star.style.setProperty('--fly-y', `${flyY}px`);
                    star.style.setProperty('--fly-duration', `${duration}s`);
                    star.style.fontSize = `${size}px`;
                    star.style.animationDelay = `${delay}s`;

                    container.appendChild(star);

                    // Remove star after animation
                    setTimeout(() => {
                        star.remove();
                    }, (duration + delay) * 1000 + 100);
                }
            }

            // Update player rating display - INTERACTIVE version
            function updatePlayerRating(rating) {
                const playerRating = document.getElementById('playerRating');
                const starsContainer = document.getElementById('playerRatingStars');
                if (!playerRating || !starsContainer) return;

                // Store current rating as data attribute
                playerRating.dataset.rating = rating || 0;

                // Always show rating container
                playerRating.style.display = 'flex';
                playerRating.classList.remove('saving', 'rated-success');

                // Generate all 5 clickable stars
                renderPlayerStars(starsContainer, rating || 0);

                // Add hover and click handlers
                setupPlayerRatingHandlers(starsContainer, playerRating);

                // Start tracking playback time for rating prompt if no rating
                if (!rating || rating === 0) {
                    startPlaybackTimer();
                } else {
                    stopPlaybackTimer();
                    hideRatingPrompt();
                }
            }

            // Render stars with given rating
            function renderPlayerStars(container, rating) {
                let starsHtml = '';
                for (let i = 0; i < 5; i++) {
                    const starNum = i + 1;
                    const isEmpty = i >= rating;
                    starsHtml += `<span class="player-rating-star${isEmpty ? ' empty' : ''}" data-rating="${starNum}">★</span>`;
                }
                container.innerHTML = starsHtml;
            }

            // Setup hover and click handlers for player rating
            function setupPlayerRatingHandlers(starsContainer, playerRating) {
                const stars = starsContainer.querySelectorAll('.player-rating-star');
                const originalRating = parseInt(playerRating.dataset.rating) || 0;

                stars.forEach((star) => {
                    const starRating = parseInt(star.dataset.rating);

                    // Click: submit this rating (only when NOT in invite mode)
                    star.addEventListener('click', async (e) => {
                        e.stopPropagation();

                        // If in invite mode, open the popup instead of direct submit
                        if (playerRating.classList.contains('rating-invite')) {
                            openRatingPopup();
                            return;
                        }

                        // Immediately show the selected rating
                        stars.forEach((s, idx) => {
                            if (idx < starRating) {
                                s.classList.remove('empty');
                            } else {
                                s.classList.add('empty');
                            }
                        });

                        // Add saving animation
                        playerRating.classList.add('saving');

                        // Submit the rating
                        await submitRating(starRating);

                        // Show success animation - flying stars burst
                        playerRating.classList.remove('saving');
                        createFlyingStars(playerRating, 8);

                        // Remove success class after animation
                        setTimeout(() => {
                            playerRating.classList.remove('rated-success');
                        }, 1500);
                    });
                });

                // Hover on individual stars: show white preview up to hovered star
                stars.forEach((star) => {
                    const starRating = parseInt(star.dataset.rating);

                    star.addEventListener('mouseenter', () => {
                        // If in invite mode, don't do hover preview
                        if (playerRating.classList.contains('rating-invite')) return;
                        stars.forEach((s) => {
                            const sRating = parseInt(s.dataset.rating);
                            if (sRating <= starRating) {
                                s.classList.add('hover-preview');
                                s.classList.remove('empty');
                            } else {
                                s.classList.remove('hover-preview');
                                s.classList.add('empty');
                            }
                        });
                    });
                });

                // Hover on stars container: open popup in invite mode
                starsContainer.addEventListener('mouseenter', () => {
                    if (playerRating.classList.contains('rating-invite')) {
                        clearTimeout(ratingPopupCloseTimer);
                        openRatingPopup();
                    }
                });

                // Mouse leaves stars container
                starsContainer.addEventListener('mouseleave', () => {
                    // In invite mode: start delayed popup close
                    if (playerRating.classList.contains('rating-invite')) {
                        ratingPopupCloseTimer = setTimeout(() => {
                            closeRatingPopup();
                        }, 150);
                    }
                    // Always restore original rating display
                    const currentRating = parseInt(playerRating.dataset.rating) || 0;
                    stars.forEach((s) => {
                        s.classList.remove('hover-preview');
                        const sRating = parseInt(s.dataset.rating);
                        if (sRating <= currentRating) {
                            s.classList.remove('empty');
                        } else {
                            s.classList.add('empty');
                        }
                    });
                });

                // Prevent container click from doing anything else
                playerRating.onclick = (e) => {
                    e.stopPropagation();
                    // Only open popup in invite mode
                    if (playerRating.classList.contains('rating-invite')) {
                        openRatingPopup();
                    }
                };
            }

            // Submit rating to Coda API
            async function submitRating(newRating) {
                if (!currentPlayingRecordingInfo) {

                    return;
                }

                const { songIdx, recordingIdx, tableRowId } = currentPlayingRecordingInfo;

                // Use recording's own rowId from recordings table
                if (!tableRowId) {

                    return;
                }

                // Fixed rating column for new recordings table
                const RECORDING_RATING_COLUMN = 'c-WqeOGhwKvu';

                const playerRating = document.getElementById('playerRating');
                if (playerRating) {
                    playerRating.classList.add('saving');
                }



                try {
                    // Coda API requires PUT to update a specific cell - use RECORDINGS_TABLE_ID
                    const url = `${WORKER_URL}docs/${DOC_ID}/tables/${RECORDINGS_TABLE_ID}/rows/${tableRowId}`;

                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            row: {
                                cells: [
                                    {
                                        column: RECORDING_RATING_COLUMN,
                                        value: newRating
                                    }
                                ]
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }



                    // Update local data
                    if (allSongs[songIdx] && allSongs[songIdx].recordings && allSongs[songIdx].recordings[recordingIdx]) {
                        allSongs[songIdx].recordings[recordingIdx].rating = newRating;
                    }

                    // Clear local cache so next load gets fresh data
                    localStorage.removeItem(STORAGE_KEYS.SONG_INDEX);
                    localStorage.removeItem(STORAGE_KEYS.SONG_INDEX_TIMESTAMP);

                    // Update the display
                    updatePlayerRating(newRating);



                } catch (error) {
                    console.error('Error submitting rating:', error);
                    alert('פאלגענדער באריכטונג געשלאגן. ביטע פריווט נאכאמאל.');
                } finally {
                    if (playerRating) {
                        playerRating.classList.remove('saving');
                    }
                }
            }

            // Start playback timer to show rating invite after 10 seconds
            let ratingInviteInterval = null;
            function startPlaybackTimer() {
                // Clear any existing timer/interval
                stopPlaybackTimer();
                hasShownRatingPrompt = false;

                // After 10 seconds, start the first glow cycle
                playbackTimer = setTimeout(() => {
                    startGlowPulse();
                }, 10000);
            }

            // Glow pulse: 10s on, 30s off, repeat
            function startGlowPulse() {
                const playerRating = document.getElementById('playerRating');
                const playerSection = document.querySelector('.player-section');
                if (!playerRating) return;
                if (playerSection && playerSection.classList.contains('player-minimized')) return;

                // Turn glow ON
                playerRating.classList.add('rating-invite');
                hasShownRatingPrompt = true;
                suppressRatingHover();

                // After 10s, turn glow OFF
                ratingInviteInterval = setTimeout(() => {
                    playerRating.classList.remove('rating-invite');
                    restoreRatingHover();

                    // After 30s off, turn glow ON again
                    ratingInviteInterval = setTimeout(() => {
                        startGlowPulse();
                    }, 30000);
                }, 10000);
            }

            // Stop playback timer
            function stopPlaybackTimer() {
                if (playbackTimer) {
                    clearTimeout(playbackTimer);
                    playbackTimer = null;
                }
                if (ratingInviteInterval) {
                    clearTimeout(ratingInviteInterval);
                    ratingInviteInterval = null;
                }
            }

            // Show rating invite - make stars glow/dance (only when player banner is open)
            function showRatingPrompt() {
                const playerSection = document.querySelector('.player-section');
                if (playerSection && playerSection.classList.contains('player-minimized')) return;
                const playerRating = document.getElementById('playerRating');
                if (playerRating) {
                    playerRating.classList.add('rating-invite');
                    hasShownRatingPrompt = true;
                    suppressRatingHover();
                }
            }

            // Suppress hover effects and tooltip during invite
            function suppressRatingHover() {
                const playerRating = document.getElementById('playerRating');
                if (playerRating) {
                    playerRating.removeAttribute('title');
                    playerRating.style.cursor = 'pointer';
                }
            }

            // Restore hover effects and tooltip
            function restoreRatingHover() {
                const playerRating = document.getElementById('playerRating');
                if (playerRating) {
                    playerRating.setAttribute('title', 'אודיאו קוואליטעט');
                }
            }

            // Hide rating invite
            function hideRatingPrompt() {
                const playerRating = document.getElementById('playerRating');
                if (playerRating) {
                    playerRating.classList.remove('rating-invite');
                }
                hasShownRatingPrompt = false;
                restoreRatingHover();
                closeRatingPopup();
                stopPlaybackTimer();
            }

            // Open rating popup near the stars
            function openRatingPopup() {
                // Remove any existing popup
                closeRatingPopup();

                const playerRating = document.getElementById('playerRating');
                if (!playerRating) return;

                // No backdrop needed — popup closes on mouseleave

                // Create popup card
                const popup = document.createElement('div');
                popup.className = 'rating-popup';
                popup.id = 'ratingPopup';

                // Header
                let headerHtml = '<div class="rating-popup-header">';
                if (currentPlayingRecordingInfo) {
                    const { songIdx } = currentPlayingRecordingInfo;
                    const song = allSongs[songIdx];
                    if (song) {
                        headerHtml += `<div style="color: var(--color-nigun); font-weight: 800; margin-bottom: 4px;">${formatDescription(song.name) || 'ניגון'}</div>`;
                    }
                }
                headerHtml += 'רעיט די אודיאו קוואליטעט</div>';

                // Options
                let optionsHtml = '<div class="rating-popup-options">';
                for (let rating = 5; rating >= 1; rating--) {
                    const desc = RATING_DESCRIPTIONS[rating] || '';
                    let stars = '';
                    for (let i = 1; i <= 5; i++) {
                        stars += `<span class="star${i > rating ? ' empty' : ''}">★</span>`;
                    }
                    optionsHtml += `<div class="rating-popup-option" data-rating="${rating}"><div class="rating-popup-option-stars">${stars}</div><div class="rating-popup-option-text">${desc}</div></div>`;
                }
                optionsHtml += '</div>';

                popup.innerHTML = headerHtml + optionsHtml;

                // Add click handlers
                popup.querySelectorAll('.rating-popup-option').forEach(option => {
                    option.addEventListener('click', async () => {
                        const rating = parseInt(option.dataset.rating, 10);
                        closeRatingPopup();
                        // Remove invite glow
                        playerRating.classList.remove('rating-invite');
                        // Submit rating
                        await submitRating(rating);
                        // Show flying stars explosion
                        createFlyingStars(playerRating, 10);
                    });
                });

                // Position popup above the stars
                document.body.appendChild(popup);

                // Hover on popup: keep it open
                popup.addEventListener('mouseenter', () => {
                    clearTimeout(ratingPopupCloseTimer);
                });
                // Mouse leaves popup: start delayed close
                popup.addEventListener('mouseleave', () => {
                    ratingPopupCloseTimer = setTimeout(() => {
                        closeRatingPopup();
                    }, 150);
                });

                const rect = playerRating.getBoundingClientRect();
                const popupRect = popup.getBoundingClientRect();

                // Position above the stars, centered horizontally on the stars
                let left = rect.left + rect.width / 2 - popupRect.width / 2;
                let top = rect.top - popupRect.height - 12;

                // Keep within viewport
                if (left < 10) left = 10;
                if (left + popupRect.width > window.innerWidth - 10) left = window.innerWidth - popupRect.width - 10;
                if (top < 10) top = rect.bottom + 12; // If no room above, show below

                popup.style.left = left + 'px';
                popup.style.top = top + 'px';

                // Escape key to close
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeRatingPopup();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            }

            // Timer for delayed popup close
            let ratingPopupCloseTimer = null;

            // Close rating popup with fade-out animation
            function closeRatingPopup() {
                clearTimeout(ratingPopupCloseTimer);
                const popup = document.getElementById('ratingPopup');
                if (!popup || popup.dataset.closing) return;
                popup.dataset.closing = 'true';
                popup.style.animation = 'popupSlideOut 0.2s ease-in forwards';
                setTimeout(() => {
                    popup.remove();
                }, 200);
                document.querySelectorAll('.rating-popup-backdrop').forEach(b => b.remove());
            }

            // Show thank you notification
            function showThankYouNotification() {
                const notification = document.getElementById('thankYouNotification');
                if (!notification) return;

                // Show notification
                notification.classList.add('show');

                // Auto-hide after 2.5 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2500);
            }

            // Note: animateCards disabled for songs page to prevent unwanted animations

            // Register Service Worker for caching
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            }

            // Initialize
            fetchSongs();

            // Search Placeholder Typing Animation
            const searchPhrases = [
                "זוך א ניגון...",
                "זוך א מחבר...",
                "זוך א חצר...",
                "זוך אן אלבום...",
                "זוך א זמן...",
                "זוך א קאלעקשן...",
                "זוך ווערטער...",
                "זוך א ריטעם..."
            ];

            function initTypingForInput(inputId) {
                const input = document.getElementById(inputId);
                if (!input) return;

                // Clear any existing interval/timeout if re-initializing (simple check)
                if (input.dataset.typingInitialized) return;
                input.dataset.typingInitialized = "true";

                let phraseIndex = 0;
                let charIndex = 0;
                let isDeleting = false;
                let typeSpeed = 150;

                function type() {
                    // If input is no longer in DOM or not visible (optional check), maybe stop? 
                    // but for now we keep it simple.

                    const currentPhrase = searchPhrases[phraseIndex];

                    if (isDeleting) {
                        input.placeholder = currentPhrase.substring(0, charIndex - 1);
                        charIndex--;
                        typeSpeed = 50; // Faster deletion
                    } else {
                        input.placeholder = currentPhrase.substring(0, charIndex + 1);
                        charIndex++;
                        typeSpeed = 100; // Normal typing speed
                    }

                    if (!isDeleting && charIndex === currentPhrase.length) {
                        // Finished typing phrase
                        isDeleting = true;
                        typeSpeed = 2000; // Pause at end
                    } else if (isDeleting && charIndex === 0) {
                        // Finished deleting phrase
                        isDeleting = false;
                        phraseIndex = (phraseIndex + 1) % searchPhrases.length;
                        typeSpeed = 500; // Pause before new phrase
                    }

                    // If element still exists
                    if (document.getElementById(inputId)) {
                        setTimeout(type, typeSpeed);
                    }
                }

                // Start typing immediately
                type();
            }

            // Start animation after a short delay to ensure load
            setTimeout(() => {
                initTypingForInput('homeSearchInput');
            }, 500);

            // Header hide on scroll down, show on scroll up
            // Also manages page-title fixed positioning and sub-header behavior
            (function () {
                const header = document.querySelector('.main-header');
                if (!header) return;

                let lastScrollY = window.scrollY;
                let ticking = false;
                let isHeaderHidden = false;
                let pageTitleOriginalTop = null;
                const SCROLL_THRESHOLD = 5;
                const HEADER_HEIGHT = 74;

                function updateHeader() {
                    const currentScrollY = window.scrollY;
                    const scrollDelta = currentScrollY - lastScrollY;

                    // Query dynamically since these elements are generated when navigating to pages
                    const pageTitle = document.querySelector('.page-title');
                    const settingsBar = document.querySelector('.page-settings-bar');

                    // Cache the original position of page-title (when it's not fixed)
                    if (pageTitle && !pageTitle.classList.contains('is-fixed') && pageTitleOriginalTop === null) {
                        pageTitleOriginalTop = pageTitle.getBoundingClientRect().top + currentScrollY;

                    }

                    // Reset cache if page-title doesn't exist (page changed)
                    if (!pageTitle) {
                        pageTitleOriginalTop = null;
                    }

                    // Manage page-title fixed positioning based on scroll
                    // Only become fixed when the page-title would scroll above the main header
                    if (pageTitle && pageTitleOriginalTop !== null) {
                        const isCurrentlyFixed = pageTitle.classList.contains('is-fixed');

                        // Hysteresis: different thresholds for becoming fixed vs unfixed
                        // This prevents rapid toggling when scrolling near the threshold
                        const fixThreshold = 50;  // Must scroll past 50px to become fixed
                        const unfixThreshold = 10; // Must scroll above 10px to become unfixed

                        const shouldBecomeFixed = !isCurrentlyFixed && currentScrollY > fixThreshold;
                        const shouldBecomeUnfixed = isCurrentlyFixed && currentScrollY < unfixThreshold;

                        if (shouldBecomeFixed) {


                            // Create placeholder to maintain layout when page-title becomes fixed
                            let placeholder = document.getElementById('page-title-placeholder');
                            if (!placeholder) {
                                placeholder = document.createElement('div');
                                placeholder.id = 'page-title-placeholder';
                                placeholder.style.height = pageTitle.offsetHeight + 'px';
                                placeholder.style.width = '100%';
                                pageTitle.parentNode.insertBefore(placeholder, pageTitle);
                            }
                            placeholder.style.display = 'block';

                            pageTitle.classList.add('is-fixed');
                        } else if (shouldBecomeUnfixed) {

                            pageTitle.classList.remove('is-fixed');
                            pageTitleOriginalTop = null; // Recache on next scroll

                            // Hide placeholder
                            const placeholder = document.getElementById('page-title-placeholder');
                            if (placeholder) {
                                placeholder.style.display = 'none';
                            }
                        }
                    }

                    // Note: settings-bar stays in normal flow, does not become fixed

                    // At top - always show everything
                    if (currentScrollY <= 100) {
                        if (isHeaderHidden) {

                            isHeaderHidden = false;
                            header.classList.remove('header-hidden');
                            if (pageTitle) {
                                pageTitle.classList.remove('main-hidden');
                                pageTitle.classList.remove('sub-merged');
                            }
                            if (settingsBar) settingsBar.classList.remove('merged');
                        }
                    }
                    // Only change state if scroll delta exceeds threshold
                    else if (Math.abs(scrollDelta) > SCROLL_THRESHOLD) {
                        if (scrollDelta > 0 && !isHeaderHidden) {
                            // Scrolling down significantly - hide main header

                            isHeaderHidden = true;
                            header.classList.add('header-hidden');
                            if (pageTitle) {
                                pageTitle.classList.add('main-hidden');
                                if (settingsBar) pageTitle.classList.add('sub-merged');
                            }
                            if (settingsBar) settingsBar.classList.add('merged');
                        } else if (scrollDelta < 0 && isHeaderHidden) {
                            // Scrolling up significantly - show main header

                            isHeaderHidden = false;
                            header.classList.remove('header-hidden');
                            if (pageTitle) {
                                pageTitle.classList.remove('main-hidden');
                                pageTitle.classList.remove('sub-merged');
                            }
                            if (settingsBar) settingsBar.classList.remove('merged');
                        }
                    }

                    lastScrollY = currentScrollY;
                    ticking = false;
                }

                window.addEventListener('scroll', function () {
                    if (!ticking) {
                        window.requestAnimationFrame(updateHeader);
                        ticking = true;
                    }
                }, { passive: true });
            })();

            // Close dropdown immediately on click (even if mouse is still on it)
            (function () {
                document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
                    const content = dropdown.querySelector('.nav-dropdown-content');

                    // On click of any link in the dropdown, hide it immediately
                    dropdown.querySelectorAll('a').forEach(link => {
                        link.addEventListener('click', () => {
                            content.classList.add('hiding');
                        });
                    });

                    // Remove hiding class when mouse leaves, so hover works again next time
                    dropdown.addEventListener('mouseleave', () => {
                        content.classList.remove('hiding');
                    });
                });
            })();
        </script>
</body>

</html>
